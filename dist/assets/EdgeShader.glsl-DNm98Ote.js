function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/TileLayerView3D-Dg79Cp-y.js","assets/index-8ERthB3p.js","assets/index-CzRN3C0i.css","assets/LayerView3D-y7LfmsJ-.js","assets/heightModelInfoUtils-CdtST1Ra.js","assets/TiledLayerView3D-qSeeTFA1.js","assets/WaterSurface.glsl-JBHYhfkH.js","assets/RenderGeometry-rcUvJmRA.js","assets/vec2f64-Diu2Kaa8.js","assets/vec3f32-Cw9Q6TO_.js","assets/DoubleArray-068mylUp.js","assets/Texture-C7A05GrI.js","assets/interfaces-B8ge7Jg9.js","assets/BindType-BmZEZMMh.js","assets/Util-B8vYs4k8.js","assets/enums-DSseSvdG.js","assets/Texture-O7Pyotwx.js","assets/VertexAttribute-BnAa5VW0.js","assets/basicInterfaces-DngWxyLO.js","assets/mat3-CqxUQBLP.js","assets/mat3f64-BBpwCtoL.js","assets/mat4f64-Dk4dwAN8.js","assets/ShaderTechniqueConfiguration-D3UbJ2mX.js","assets/doublePrecisionUtils-B0owpBza.js","assets/Material-DwPnlQDw.js","assets/ContentObject-BTgEhnct.js","assets/ViewingMode-Dodu7ZZk.js","assets/vec2-Dt9Foiri.js","assets/requestImageUtils-DP1V3HlH.js","assets/Indices-DP3oX5Sg.js","assets/plane-Du3EYICn.js","assets/quatf64-BrpT0VRp.js","assets/mathUtils-iSLnUy_4.js","assets/sphere-Bf4ezJdT.js","assets/ObjectStack-BPo9QGhV.js","assets/Attribute-B-NAci_J.js","assets/Geometry-CqGtfd4N.js","assets/triangle-CTblFuF6.js","assets/lineSegment-DVvvMBnG.js","assets/computeTranslationToOriginAndRotation-BbJd4iYX.js","assets/ElevationProvider-Bd4qfXCi.js","assets/boundedPlane-CLJ-Xnn_.js","assets/verticalOffsetUtils-BYv4Nk2v.js","assets/orientedBoundingBox-BQvYwCTM.js","assets/quat-DUnoL8dP.js","assets/spatialReferenceEllipsoidUtils-CmEPjh7T.js","assets/hydratedFeatures-DqrDm0_F.js","assets/projectVectorToVector-C3SBBDgz.js","assets/projectPointToVector-qKp-AJ2b.js","assets/axisAngleDegrees-CaSFQR2z.js","assets/weather-D00pIeau.js","assets/RenderState-DaVlEYWY.js","assets/NestedMap-DgiGbX8E.js","assets/frustum-BrAPXuhm.js","assets/Octree-E7a40xr7.js","assets/InterleavedLayout-s3MgOYN8.js","assets/BufferView-CHYzaV9A.js","assets/types-D0PSWh4d.js","assets/OrderIndependentTransparency-Cua2R8AE.js","assets/floatRGBA-CCqnXShd.js","assets/Intersector-8rpRuT_8.js","assets/glUtil-DS73TAjp.js","assets/VertexElementDescriptor-BOD-G50G.js","assets/VertexArrayObject-Cv4RwmVi.js","assets/BufferObject-CaEbWulZ.js","assets/Scheduler-DaHJO6l7.js","assets/signal-DoM1gSF0.js","assets/debugFlags-BbJIqrPU.js","assets/ColorMaterial.glsl-uPKQoFFi.js","assets/VertexColor.glsl-CScvx9pF.js","assets/vec2f32-BbH2jxlN.js","assets/dehydratedFeatures-Cp-_lWz0.js","assets/featureConversionUtils-BzfH5fda.js","assets/OptimizedFeature-CXeSoBCN.js","assets/OptimizedFeatureSet-Blu9Ckm7.js","assets/OptimizedGeometry-DLPswkPy.js","assets/edgeUtils-D8J_3GIe.js","assets/earcut-BqgeR2O3.js","assets/_commonjsHelpers-DCkdB7M8.js","assets/vec3-DPXcG_yS.js","assets/SnappingCandidate-O5eRSE6e.js","assets/triangulationUtils-C0V38kt7.js","assets/deduplicate-j8p9VETP.js","assets/Normals-BAXqRpCA.js","assets/objectResourceUtils-D-wPKn4W.js","assets/devEnvironmentUtils-Blrp8lZ5.js","assets/DefaultMaterial_COLOR_GAMMA-D4SZcGoz.js","assets/resourceUtils-ayGD6aG4.js","assets/symbolColorUtils-B_k_VgHH.js","assets/CIMSymbolHelper-C-U_lWVp.js","assets/BidiEngine-DL33fnW5.js","assets/fontUtils-Dz0hN_7q.js","assets/GeometryUtils-_MjrRDxY.js","assets/enums-BRqP_wXA.js","assets/definitions-B54owTRu.js","assets/mat2d-D9yIh3Tx.js","assets/mat2df32-orApM5a3.js","assets/Rect-CUzevAry.js","assets/BoundingBox-BhuXqU4L.js","assets/cimSymbolUtils-DwzauUMk.js","assets/utils-j-RBNfeR.js","assets/lineStippleUtils-B9K4R8oO.js","assets/projectVectorToPoint-CPW7kXva.js","assets/MeshComponent-BCGFLGQh.js","assets/imageUtils-D1MsbWS6.js","assets/meshVertexSpaceUtils-KRc33Yrq.js","assets/MeshLocalVertexSpace-C8ABjEju.js","assets/georeference-CwPKO8dc.js","assets/interfaces-DkjgzG8v.js","assets/DefaultLayouts-BrmJbx_o.js","assets/webStyleSymbolUtils-BzDS5WjL.js","assets/Intersector-CTjLkyei.js","assets/terrainUtils-hfv3Mblf.js","assets/TileInfo-BsGWbS2H.js","assets/TileKey-DZd6gJy7.js","assets/LayerView-DO6TerBv.js","assets/UpdatingHandles-ugzlsvZF.js","assets/RefreshableLayerView-B0936Ssp.js","assets/MapServiceLayerViewHelper-C2LKJQB0.js","assets/scaleUtils-0K_Ry6I1.js","assets/floorFilterUtils-DZ5C6FQv.js","assets/drapedUtils-BdDXXXz6.js","assets/normalizeUtils-Cm7zySIZ.js","assets/normalizeUtilsCommon-DRIluWnF.js","assets/utils-1zmckiYC.js","assets/utils-D-bI9C7C.js","assets/sublayerUtils-Bh-ioSNZ.js","assets/popupUtils-BHYiW8I-.js","assets/Viewpoint-CB1GAuK3.js","assets/Cyclical-BY9qISY1.js","assets/jsxFactory-BxQYPm-b.js","assets/GraphicsCollection-CKieR40M.js","assets/RenderCoordsHelper-zH8WjGkC.js","assets/DefaultUI-DIlogOoy.js","assets/screenUtils-BuM_Fswi.js","assets/ReactiveMap-C-O0lKvJ.js","assets/IViewEvents-Bci6PjlS.js","assets/interfaces-D6pIddIh.js","assets/mat2df64-CBKYtunK.js","assets/capabilities-C84AMSCg.js","assets/themeUtils-C3zvZbsE.js","assets/globalCss-DfZw-NIf.js","assets/accessibleHandler-DsewpcQ5.js","assets/Compass-C-feYp_a.js","assets/utils-DsJqvptN.js","assets/GoTo-BzS22eXk.js","assets/NavigationToggle-QjJqvxo5.js","assets/Zoom-Ct1er6X1.js","assets/viewpointUtils-BxfIO3H-.js","assets/earthUtils-ir2LnhMw.js","assets/spatialReferenceSupport-DPLkW2jK.js","assets/ElevationSamplerData-CC_B5wrl.js","assets/Environment-B2HYg6Z1.js","assets/projectPointToWGS84ComparableLonLat-D5kdMIn_.js","assets/projectVectorToWGS84ComparableLonLat-DuPw0-Mv.js","assets/Program-BB52p2Mx.js","assets/ShadowCastVisualizeTechniqueConfiguration-DqJ__9Ii.js","assets/ray-CCzLdiTI.js","assets/ZoomMomentumEstimator-PITOvV-p.js","assets/labelFormatUtils-BN4HkzS9.js","assets/FeatureTileDescriptor3D-BLJXkD6Q.js","assets/elevationInfoUtils-sHEwmo9N.js","assets/ElevationQueryTileCache-CV2Fph_A.js","assets/LayerConstants-B33OP6sh.js","assets/ElevationRange-BrgM1moX.js","assets/geometryServiceUtils-B-h5lvUN.js","assets/project-7u3NBcq6.js","assets/hitTestSelectUtils-UXJPjatw.js","assets/ByteSizeUnit-BsxeN7wM.js","assets/LercDecoder-FUH0zkya.js","assets/WorkerHandle-DKpIZ9kk.js","assets/RenderableTile-CQN7Nxvi.js","assets/enums-BRzLM11V.js","assets/TileStrategy-BMTAwxMt.js","assets/TileKey-Drwp1tmy.js","assets/QueueProcessor-DFkcFyJt.js","assets/config-MDUrh2eL.js","assets/DefaultVertexAttributeLayouts-Co_GH1pH.js","assets/DisplayObject-B9oc5ibO.js","assets/rasterUtils-DImlUReg.js","assets/StyleDefinition-pu9RBNlY.js","assets/resources-DJFXXcdR.js","assets/edgeProcessing-Crq4tMpw.js","assets/EdgeWorkerHandle-CAkTfCpv.js","assets/workerHelper-CE2O_zfa.js","assets/testSVGPremultipliedAlpha-Dsq4J0WV.js","assets/RenderingContext-CzjLpUzJ.js","assets/ProgramCache-DX9Ty2iR.js","assets/layerViewUtils-Bi2wmOiN.js","assets/ElevationLayerView3D-DK9zGzF5.js","assets/BaseDynamicLayerView3D-Dsjx_R6g.js","assets/DynamicLayerView3D-BApUxaBW.js","assets/projectExtentUtils-9sG7uFGp.js","assets/ImageMaterial.glsl-BKacu54w.js","assets/BuildingSceneLayerView3D-CZsisH1H.js","assets/BuildingGroupSublayer-3UTLAh17.js","assets/BuildingComponentSublayer-eBz-Vwap.js","assets/capabilities-B6PqF1Vy.js","assets/I3SIndexInfo-CWyEOqXW.js","assets/I3SLayerDefinitions-CcCZfvYy.js","assets/I3SUtil-DvcgZFwB.js","assets/I3SBinaryReader-Y2aVLbE7.js","assets/WhereClause-CDY1MzWK.js","assets/TimeOnly-CdukLkzZ.js","assets/I3SMeshView3D-DiJ211pF.js","assets/LayerElevationProvider-B7gdPc1Z.js","assets/RenderTexture-D39vYIOj.js","assets/I3SOverrides-DN8WSBS7.js","assets/I3SNode-CDG95tIx.js","assets/ReactiveSet-B8Rb7Vms.js","assets/meshFeatureSet-Bt56ZleR.js","assets/Mesh-CJEK7lO8.js","assets/External-tJCk07ZV.js","assets/infoFor3D-CxOdoily.js","assets/FeatureLayerView3D-BH2hEfk0.js","assets/FeatureLayerViewBase3D-BjnNcvU0.js","assets/HeatmapDensity.glsl-BN4vWD93.js","assets/dehydratedFeatureComparison-DdCJ1gSj.js","assets/queryForSymbologySnapping-8JLrvhsd.js","assets/hash-CcEbRgUF.js","assets/Graphics3DObjectStates-CZBjX6i5.js","assets/rendererConversion-eHDRAZSQ.js","assets/optimizedFeatureQueryEngineAdapter-DY8fepQr.js","assets/centroid-DdLmOD72.js","assets/PooledRBush-CjYPNqwP.js","assets/quickselect-D0_cvEX6.js","assets/QueryEngine-BnxbU8wo.js","assets/timeSupport-BFvqZpey.js","assets/json-Wa8cmqdu.js","assets/QueryEngineCapabilities-CTDe3LlQ.js","assets/utils-RSnx-Q9D.js","assets/utils-B6UP7_Wm.js","assets/utils-8IYHD2E1.js","assets/ClassBreaksDefinition-CNLSnW5r.js","assets/FeatureStore-BZ4BTL-O.js","assets/BoundsStore-CvIYB3Tm.js","assets/heatmapTextureUtils-Ccf4XLi5.js","assets/query-BtFvR4zF.js","assets/pbfQueryUtils-D79yLlDs.js","assets/pbf-C8CvrhFv.js","assets/EventedSet-DUmR4FeL.js","assets/FeatureLayerView-Dov96BNZ.js","assets/SceneModification-D9K6gWLA.js","assets/persistable-DTlPUvTn.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/resourceExtension-5aSW4bDb.js","assets/SceneLayerWorker-9TFrk9Zl.js","assets/makeScheduleFunction-CggzEh3c.js","assets/I3SQueryFeatureStore-CCNZhMiH.js","assets/TemporalSceneLayerView-DbfVwYek.js","assets/CSVLayerView3D-aMwhA2Nw.js","assets/DimensionLayerView3D-DvTJ8lRs.js","assets/GeoJSONLayerView3D-DHQtY0RR.js","assets/GraphicsLayerView3D-De-WQb2o.js","assets/GraphicsProcessor-B0rTvHPS.js","assets/GroupLayerView-M_UGd6AY.js","assets/ImageryLayerView3D-CxzoBZmy.js","assets/ImageryLayerView-Cf1qWB8Z.js","assets/IntegratedMeshLayerView3D-DPQH3a33.js","assets/IntegratedMesh3DTilesLayerView3D-LuHedwfy.js","assets/ILyr3DWasmPerSceneView-vPx4somd.js","assets/LineOfSightLayerView3D-Clo63x8x.js","assets/MapImageLayerView3D-DINZMIGA.js","assets/MapImageLayerView-BsY2zu-r.js","assets/ExportImageParameters-cP65v3sA.js","assets/MediaLayerView3D-B8BxNhgg.js","assets/MediaElementView-u-zsPETL.js","assets/normalizeUtilsSync-CrK-RMPr.js","assets/OGCFeatureLayerView3D-C6FgkZcy.js","assets/OGCFeatureLayerView-CtILY5Gq.js","assets/PointCloudLayerView3D-ByhzeHV-.js","assets/PointCloudWorkerUtil-DbllgjYC.js","assets/PointCloudUniqueValueRenderer-q3IvNVc1.js","assets/PopupSceneLayerView-DPpelsIn.js","assets/VoxelLayerView3D-B7hlYjqB.js","assets/RouteLayerView3D-BYNrvXBs.js","assets/RouteInfo-Cu7cXOCu.js","assets/Stop-CReeEpiF.js","assets/SceneLayerView3D-BuoUMj2p.js","assets/SceneLayerView-Okr6zrc1.js","assets/SceneLayerGraphicsView3D-ByyQXWVq.js","assets/StreamLayerView3D-D58Tb4ng.js","assets/StreamFeatureManager-BeWeOtNg.js","assets/CircularArray-DfLrgW_-.js","assets/createConnection-Bx-WZj1C.js","assets/StreamLayerView-D8lANDSI.js","assets/ImageryTileLayerView3D-Cot94oIS.js","assets/rasterProjectionHelper-pnpartOn.js","assets/ImageryTileLayerView-Xv04_hRh.js","assets/VectorTileLayerView3D-DuanJ7Ao.js","assets/TileInfoViewPOT-BTa6Vr8F.js","assets/rasterizingUtils-Nlpgzyj1.js","assets/constants-D5zmR9t2.js","assets/WGLBrushVTLSymbol-DSNnpuOI.js","assets/vec4f32-CjrfB-0a.js","assets/VTLMaterialManager-B10yUbF1.js","assets/ShaderCompiler-G2XYGDs6.js","assets/programUtils-CwiKxPbA.js","assets/StyleRepository-C4YcfQde.js","assets/unitBezier-BX6NeAEr.js","assets/WFSLayerView3D-BTZ5Fcqj.js","assets/WMSLayerView3D-BqewjqSp.js","assets/WMSLayerView-Bcg33PdZ.js","assets/ExportWMSImageParameters-CqkZXSd_.js","assets/WMTSLayerView3D-B9y8V8e7.js","assets/AreaMeasurementAnalysisView3D-D60Hb1GW.js","assets/defaultUnit-gjMTMp_C.js","assets/getDefaultUnitForView-BEilgbp7.js","assets/AnalysisView3D-BwgdxIXS.js","assets/interfaces-js1RL7O8.js","assets/quantityUtils-9zDVxeky.js","assets/measurementUtils-BB1pb2Gz.js","assets/geometryEngine-MBwx6Ib1.js","assets/geometryEngineBase-Cz__5BKm.js","assets/hydrated-7yclY7Co.js","assets/geodesicUtils-D1kRRrco.js","assets/euclideanAreaMeasurementUtils-CIzlnp3G.js","assets/measurementUtils-CUrVHWre.js","assets/UnitNormalizer-DMsoj8NV.js","assets/LineVisualElement-DVtpCq1A.js","assets/Object3DVisualElement-D2TYUCro.js","assets/VisualElement-CI1nOGdz.js","assets/EditGeometryOperations-3XHFCAp6.js","assets/geometry2dUtils-DoOkpuKA.js","assets/quantityFormatUtils-DfDZUKJh.js","assets/unitFormatUtils-3MMEFLJJ.js","assets/Segment-BxtK7jJN.js","assets/viewUtils-DC86MEAQ.js","assets/TextOverlayItem-BPy-0Tbh.js","assets/DimensionAnalysisView3D-2QuCyY9m.js","assets/LengthDimension-B2wo8h4M.js","assets/automaticLengthMeasurementUtils-Bo1iBsUk.js","assets/SnappingManager-DUlqpdAB.js","assets/angularMeasurementUtils-CATp35qy.js","assets/geodesicMeasurementUtils-BcTpN3Xi.js","assets/RenderObject-BqR7Zmh-.js","assets/dragEventPipeline3D-B83b_Wx5.js","assets/InteractiveToolBase-yKkEJSmV.js","assets/drawUtils-C6Di23Hl.js","assets/memoize-DsJmrG76.js","assets/Factory-C69g7C8p.js","assets/SnappingVisualizer3D-CgXvcLRx.js","assets/ExtendedLineVisualElement-CQkDkcGr.js","assets/EngineVisualElement-DUG0X7vS.js","assets/LaserlineVisualElement-CzVKEaBL.js","assets/Laserlines.glsl-CH220B6j.js","assets/RightAngleQuadVisualElement-TrRXC01x.js","assets/SnappingVisualizer-DfDIQ0EV.js","assets/PointSnappingHint-DFYGb6IS.js","assets/VerticesVisualElement-CMCXxnaQ.js","assets/SceneSnappingManagerPool-BaW4AOlb.js","assets/SnappingContext-Cpn1WUY8.js","assets/SnappingDragPipelineStep-selKU1rW.js","assets/SnappingOperation-B1FLBSOP.js","assets/ShadedColorMaterial.glsl-CbYoK34J.js","assets/ToolIntersector-CvpYdI04.js","assets/analysisViewUtils-BqEqPSZg.js","assets/DirectLineMeasurementAnalysisView3D-B5ZcfHah.js","assets/interfaces-CjSZqm0S.js","assets/LineOfSightAnalysisView3D-DTZBy3HU.js","assets/LineOfSightAnalysisTarget-CsA1UFD4.js","assets/manipulatorUtils-uzcmbeQs.js","assets/SliceAnalysisView3D-DzRqeG9n.js","assets/SlicePlane-DAv08y7K.js","assets/SlicePlaneMaterial.glsl-OGerbmE5.js","assets/VoxelWasmPerSceneView-C_CYk5nP.js","assets/TerrainTileTree3DDebugger-BvhlzHU-.js","assets/TileTreeDebugger-4lTkqSUZ.js","assets/FeatureTileTree3DDebugger-CErcsNtb.js","assets/GraphicsView3D-Bodv-Ylg.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{eh as Pf,ed as Sf,bO as Pe,bE as es,f3 as Pv,T as zi,qM as tC,P as de,o as h,y as p,X as F,ak as go,cs as Dl,cr as A,cu as st,_ as he,s as Ir,c_ as Ts,b0 as pa,cB as Hu,cv as iC,cX as Bn,gJ as te,fY as So,g0 as Ja,ag as Sv,bU as ie,cp as Wt,d0 as js,i8 as Gu,fb as $l,cl as Lm,j7 as da,h4 as rC,qN as sC,ac as Rf,gh as ba,ci as It,qA as ku,bR as _i,bW as v,ju,ej as vt,jr as th,lh as B_,dg as Ie,dk as we,dB as xs,c5 as xa,g_ as He,qO as ih,aT as tt,fG as Ae,w as li,fx as bt,gl as oi,qP as nC,bX as oe,cf as pe,dj as re,dl as As,fu as Bl,di as fe,q7 as aC,fm as cr,cg as dt,qQ as oC,ff as zt,qK as Rv,fv as Yr,jT as Of,qR as lC,a_ as fo,cj as le,kA as H_,mG as Im,kz as G_,mB as hu,K as Ef,dm as ve,fn as Wu,dh as on,fr as yo,fc as Xt,fy as rh,dA as Hn,bV as Qs,co as cC,cn as hC,cm as dC,gG as Ye,j0 as gs,i$ as Ov,av as uC,kw as pC,g2 as qt,dC as ma,lI as $n,ds as Ev,M as Zs,cY as Av,f$ as Nm,Z as Ms,ct as Nn,jd as Qu,ku as Mv,g8 as Dv,o$ as tc,qS as mC,g4 as rn,kL as sh,hH as du,fC as An,ko as Oh,bG as ci,g5 as Fn,bH as ln,bQ as Fm,c7 as $v,q9 as Lv,je as eo,jf as nh,f1 as _a,hW as Zu,bI as xt,kk as uu,bD as Xu,lK as _C,lO as gC,a0 as Tr,io as fC,qu as yC,hx as vC,hN as Vm,qT as bC,jk as xC,ay as wa,ft as tl,de as wC,lC as Tl,ch as Hr,au as Iv,qU as CC,hV as Nv,cT as TC,mz as PC,hm as SC,fD as Af,fB as Um,f4 as RC,a1 as Mf,O as OC,d1 as ho,kG as zm,ls as EC,lt as AC,hi as MC,pr as Fv,hk as DC,gV as $C,qV as LC,gZ as IC,a7 as NC,fo as k_,n9 as ah,qL as Vv,qW as FC,hw as VC,qx as Df,f2 as uo,ma as zc,a4 as UC,hK as zC,kx as qC,c6 as BC,jg as qm,hy as $f,dE as Jr,cK as pu,qX as HC,qY as Ll,bZ as GC,qZ as oh,a as j_,hz as kC,hM as Uv,q_ as jC,c4 as W_,q$ as $d,eM as Lf,lv as WC,ji as QC,eb as ZC,nL as If,d as XC,r0 as YC,r1 as KC,qG as JC,df as eT,r2 as tT,r3 as iT,r4 as zv,r5 as Nf,bS as rT,c9 as sT,g9 as qv,c$ as Q_,fp as mu,jm as Bv,cd as nT,hT as aT,jx as zh,kB as oT,lF as lT,dO as Ff,o_ as cT,r6 as hT,ml as Vf,fH as dT,aW as uT,r7 as Uf,r8 as zf,fZ as qf,h2 as Bf,hl as pT,dt as mT,dr as Hv,bh as _T}from"./index-8ERthB3p.js";import{l as Il,d as vo}from"./Viewpoint-CB1GAuK3.js";import{m as gT}from"./jsxFactory-BxQYPm-b.js";import{l as fT}from"./GraphicsCollection-CKieR40M.js";import{p as yT,A as Qr,L as ws,k as vT,m as bT,q as xT,s as wT,x as CT,y as Hf,b as TT,z as PT,B as ST,C as Gf,D as RT,w as OT,E as ET,F as AT,G as MT,N as DT,u as Gv,H as $T,I as LT,a as kv,J as IT,e as NT}from"./WaterSurface.glsl-JBHYhfkH.js";import{c as _u}from"./projectPointToVector-qKp-AJ2b.js";import{u as FT,W as Yu,Z as Z_,l as VT,p as UT,G as zT}from"./boundedPlane-CLJ-Xnn_.js";import{w as Bm,q as kf,z as qT,v as BT}from"./RenderCoordsHelper-zH8WjGkC.js";import{o as HT}from"./scaleUtils-0K_Ry6I1.js";import{d as Nl,n as GT,W as X_,s as jf,u as vp,X as Wf,v as kT,o as jT,B as WT,C as QT,D as ZT,E as XT,F as YT,I as KT,U as JT,e as e3,V as t3,N as jv,O as i3,P as r3,Q as s3,_ as Wv,K as bp,L as xp,a0 as n3,a1 as a3,S as o3,T as l3}from"./DefaultUI-DIlogOoy.js";import{v as Qv,f as Y_,u as Zv,d as c3,Y as ia,Z as Qf,Q as Xv,h as h3,b as d3,g as u3,y as wp,F as qh,a as p3,B as m3,U as _3,l as g3,K as f3,c as y3,n as v3}from"./viewpointUtils-BxfIO3H-.js";import{p as b3,t as x3}from"./ElevationSamplerData-CC_B5wrl.js";import{b as lh,D as w3,c as C3,m as T3,d as Ku,H as Yv,p as I,s as fc,e as Hm,l as Kv,x as Gm,w as Pl,T as lr,f as Jt,A as P3,U as ch,S as _t,g as gu,h as Bi,X as Ps,B as K_,Y as fu,Q as Zf,K as Xf,z as Yf,J as Kf,i as km,P as S3,q as R3,G as Wr,y as ei,F as gn,V as Jf,_ as qc,j as O3,n as E3,L as A3,o as M3,O as D3,r as $3,a as Fo,t as Bh,u as L3,E as I3,I as N3,N as jm,R as ic,W as e0,Z as t0,$ as i0,a0 as F3,a1 as V3,a2 as U3,a3 as z3,C as q3}from"./terrainUtils-hfv3Mblf.js";import{l as Re,a as Cp,o as r0}from"./ViewingMode-Dodu7ZZk.js";import{v as Ld,k as Wm,j as B3,q as Hh,m as Qm}from"./mathUtils-iSLnUy_4.js";import{p as Jv,a as eb,b as tb,c as H3}from"./Environment-B2HYg6Z1.js";import{t as G3}from"./projectPointToWGS84ComparableLonLat-D5kdMIn_.js";import{o as sn,r as Ca,T as k3,m as hh,e as j3}from"./vec2-Dt9Foiri.js";import{n as Di,r as Ju,a as yu}from"./vec2f64-Diu2Kaa8.js";import{o as g,n as di}from"./interfaces-B8ge7Jg9.js";import{a as Mt,L as ep,d as Ta,z as Ki,j as Ai,y as $i,h as Vn,o as Ne,v as Be,a5 as J_,w as bo,l as Nt,r as Ft,m as Dt,B as Fr,aC as Zm,a0 as si,e as ib,aq as Ro,I as Et,a4 as W3,a7 as Q3,X as eg,n as tg,t as rb,c as Eh,A as L,D as sb,$ as nb,aY as Z3,aF as X3,aZ as Y3,N as K3,a8 as dh,J as ab,ap as Mn,K as Hl,aa as J3,O as ob,g as eP,b as E,p as s0,S as Xm,as as n0,U as a0,ac as lb,P as cb,f as tP,aJ as iP,a6 as hb,a_ as rP,R as Dr,C as sP,W as xo,a$ as Id,Q as db,V as nP,b0 as aP,b1 as oP,ad as lP,k as cP,i as Ym,af as hP,b2 as dP,ah as uP,F as pP,aE as or,b3 as mP,b4 as Km,b5 as o0,b6 as ub,b7 as pb,x as ig,b8 as _P,b9 as gP,ba as l0,bb as fP,aK as c0}from"./Texture-C7A05GrI.js";import{O as Pt,e as yP,t as dr,f as vP,n as mb,i as bP,j as _b,V as gb,v as xP,h as xi,g as fb,T as wP,I as CP}from"./Material-DwPnlQDw.js";import{R as Z,O as Hi,C as Xi,F as Nr,L as Pr,E as Ti,T as yb,M as Jm,D as Ji,G as hi,I as Tp,B as vb,_ as Mi,t as e_,X as h0,P as Gl,U as ga}from"./enums-DSseSvdG.js";import{S as nt,s as cn,_ as lt,g as pr,r as bb,a as xb,o as ti,c as wb,A as TP,h as PP,l as SP,b as RP}from"./OrderIndependentTransparency-Cua2R8AE.js";import{r as $,t as Ls}from"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import{e as ae}from"./VertexAttribute-BnAa5VW0.js";import{t as Os}from"./VertexElementDescriptor-BOD-G50G.js";import{ak as rg,r as jn,al as OP,am as sg,an as ng,ao as yc,ap as t_,aq as EP,ar as AP,$ as Ct,as as wr,a as MP,at as DP,G as $P,f as Vr,au as LP,av as ni,aw as vu,ax as rc,ay as vs,az as Ws,aA as tp,aB as d0,aC as u0,aD as Pp,E as Qt,I as fn,_ as Cb,aE as bu,m as IP,aF as Tb,aG as NP,aH as p0,aI as il,aJ as FP,aK as VP,aL as UP,aM as xu,aN as On,aO as Pb,O as zP,aP as qP,aQ as BP,aR as HP,K as yn,aS as GP,aT as kP,aU as jP,aV as WP,aW as QP,aX as ZP,aY as XP,aZ as YP,a_ as m0,C as Sp}from"./RenderGeometry-rcUvJmRA.js";import{h as ur}from"./BufferObject-CaEbWulZ.js";import{e as ui,m as Ci,i as Un,E as KP,_ as JP,n as _0}from"./Texture-O7Pyotwx.js";import{n as ag,u as kl,s as Ah,p as eS,f as tS}from"./mat3-CqxUQBLP.js";import{e as ct,t as Sb,o as Bc}from"./mat4f64-Dk4dwAN8.js";import{r as Xs,o as iS,n as rS}from"./vec3f32-Cw9Q6TO_.js";import{x as Mh,b as og,i as Rb,s as sS}from"./Program-BB52p2Mx.js";import{I as fi,o as Yi,C as Ys,F as wu,g as nS}from"./Scheduler-DaHJO6l7.js";import{p as i_}from"./weather-D00pIeau.js";import{r as Aa}from"./glUtil-DS73TAjp.js";import{H as Ma}from"./InterleavedLayout-s3MgOYN8.js";import{a as g0,s as Js}from"./Util-B8vYs4k8.js";import{h as ip}from"./UpdatingHandles-ugzlsvZF.js";import{c as f0}from"./earthUtils-ir2LnhMw.js";import{j as aS,O as oS,z as lS,I as Ob,t as y0,r as cS}from"./ShadowCastVisualizeTechniqueConfiguration-DqJ__9Ii.js";import{p as wo,Y as rp,T as hS,K as sp,N as lg,c as cg,d as jl,Z as At,w as Ds,$ as dS,O as uS,V as pS}from"./sphere-Bf4ezJdT.js";import{e as $s,r as mS}from"./mat3f64-BBpwCtoL.js";import{T as Gn,E as Cu,t as po,a as _S,i as bn,g as v0,G as gS,c as fS}from"./ElevationProvider-Bd4qfXCi.js";import{r as Pa,i as b0}from"./Cyclical-BY9qISY1.js";import{O as yS}from"./quat-DUnoL8dP.js";import{e as vS}from"./quatf64-BrpT0VRp.js";import{r as bS,d as hg,E as Co,f as xS,S as dg,c as Rt,_ as Eb,j as Ab,F as ks,O as x0,q as wS,Q as w0,b as C0,V as Fl,u as CS}from"./plane-Du3EYICn.js";import{p as Wl,g as Mb,f as Db}from"./ray-CCzLdiTI.js";import{w as uh,I as TS,L as T0}from"./verticalOffsetUtils-BYv4Nk2v.js";import{i as Is,o as Sa,d as PS,_ as P0,a as S0,r as R0}from"./screenUtils-BuM_Fswi.js";import{b as mt,H as Tu,I as SS,L as RS,P as OS,s as np,u as ES,c as AS,l as MS,v as DS,j as Dn,d as $S,N as r_}from"./frustum-BrAPXuhm.js";import{f as LS,o as Ln,A as IS,m as ug,p as Pu,b as NS,x as FS,c as VS,h as $b,q as US,i as ua,v as zS,w as Sl,y as qS,T as BS,z as pg,r as HS,a as GS,B as Rp,C as kS}from"./objectResourceUtils-D-wPKn4W.js";import{I as Wi}from"./RenderState-DaVlEYWY.js";import{t as Op,b as jS,s as Lb,a as Ib,c as Nb}from"./ZoomMomentumEstimator-PITOvV-p.js";import{Q as Fb,a as WS}from"./ColorMaterial.glsl-uPKQoFFi.js";import{c as QS}from"./hydratedFeatures-DqrDm0_F.js";import{w as ZS}from"./labelFormatUtils-BN4HkzS9.js";import{t as vc,s as Gr}from"./FeatureTileDescriptor3D-BLJXkD6Q.js";import{S as XS}from"./triangle-CTblFuF6.js";import{P as YS}from"./elevationInfoUtils-sHEwmo9N.js";import{x as O0,t as KS,j as JS,b as eR}from"./ElevationQueryTileCache-CV2Fph_A.js";import{e as Su}from"./ElevationRange-BrgM1moX.js";import{getGeometryServiceURL as tR}from"./geometryServiceUtils-B-h5lvUN.js";import{p as iR,n as rR}from"./project-7u3NBcq6.js";import{t as sR}from"./hitTestSelectUtils-UXJPjatw.js";import{r as Hc}from"./signal-DoM1gSF0.js";import{E as nR}from"./ByteSizeUnit-BsxeN7wM.js";import{l as aR,n as oR,m as Vb}from"./DefaultMaterial_COLOR_GAMMA-D4SZcGoz.js";import{n as ph}from"./projectVectorToVector-C3SBBDgz.js";import{s as lR,a as cR}from"./LercDecoder-FUH0zkya.js";import{d as Ep,t as hR,u as dR}from"./RenderableTile-CQN7Nxvi.js";import{O as jt,N as Gc,e as mg,s as Rl,i as Cs,a as E0}from"./basicInterfaces-DngWxyLO.js";import{f as uR,s as mh}from"./Normals-BAXqRpCA.js";import{c as pR,l as mR,_ as _R,p as gR,A as fR,f as yR,m as A0}from"./rasterUtils-DImlUReg.js";import{t as vR}from"./DoubleArray-068mylUp.js";import{i as bR,x as Ru}from"./BufferView-CHYzaV9A.js";import"./TileStrategy-BMTAwxMt.js";import{e as xR}from"./TileKey-Drwp1tmy.js";import{a as wR}from"./StyleDefinition-pu9RBNlY.js";import{s as CR,a as TR}from"./resources-DJFXXcdR.js";import{s as Ub,t as PR}from"./Attribute-B-NAci_J.js";import{e as zb}from"./ContentObject-BTgEhnct.js";import{t as qb,l as SR}from"./Indices-DP3oX5Sg.js";import{f as RR}from"./vec3-DPXcG_yS.js";import{n as Ou,r as OR}from"./symbolColorUtils-B_k_VgHH.js";import{L as ER}from"./orientedBoundingBox-BQvYwCTM.js";import{m as AR,I as s_,R as Bb,S as MR,p as M0,T as DR,y as $R,w as LR}from"./edgeProcessing-Crq4tMpw.js";import{o as IR}from"./VertexArrayObject-Cv4RwmVi.js";import{o as n_,r as NR}from"./floatRGBA-CCqnXShd.js";import{W as lo}from"./Octree-E7a40xr7.js";import{t as _h}from"./requestImageUtils-DP1V3HlH.js";import{t as D0}from"./NestedMap-DgiGbX8E.js";import{o as FR}from"./Geometry-CqGtfd4N.js";import{A as Le}from"./edgeUtils-D8J_3GIe.js";import{a as VR}from"./EdgeWorkerHandle-CAkTfCpv.js";import{E as UR}from"./testSVGPremultipliedAlpha-Dsq4J0WV.js";import{w as zR,n as qR}from"./RenderingContext-CzjLpUzJ.js";import{s as Ap}from"./imageUtils-D1MsbWS6.js";import{t as BR}from"./capabilities-C84AMSCg.js";import{e as HR}from"./layerViewUtils-Bi2wmOiN.js";import{r as $0}from"./spatialReferenceSupport-DPLkW2jK.js";import{a as Hb}from"./BindType-BmZEZMMh.js";import{o as Gb,a as kb,e as jb,i as GR}from"./VertexColor.glsl-CScvx9pF.js";function Wb(i,e){const t=Pf(i),r=Pf(e),s=t.store,n=r.store,a=r.metadata;for(const o in a){const l=a[o],c=s.originOf(o),d=n.originOf(o);if(!l.readOnly&&d!==Sf.DEFAULTS)if(c===Sf.DEFAULTS)i.set(o,n.get(o));else{const u=s.get(o),m=n.get(o);u&&m&&m instanceof Pe&&u instanceof Pe&&u instanceof m.constructor&&Wb(u,m)}}}let ra=class extends es.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=lh}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if((e==null?void 0:e.extent)==null||e.spatialReference==null)return null;const t=Pv(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){var e;return((e=this.view.basemapTerrain)==null?void 0:e.spatialReference)??zi.WGS84}elevationAt(e,t){var r;if(this.extent==null||!tC(this.extent,e,t)){const s=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return de.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${s})`),this.noDataValue}return((r=this.view.elevationProvider)==null?void 0:r.getElevation(e,t,0,this.spatialReference,"ground"))??this.noDataValue}queryElevation(e){return b3(e.clone(),this)}};h([p({readOnly:!0})],ra.prototype,"demResolution",void 0),h([p({readOnly:!0})],ra.prototype,"extent",null),h([p({readOnly:!0})],ra.prototype,"noDataValue",void 0),h([p()],ra.prototype,"spatialReference",null),h([p({constructOnly:!0})],ra.prototype,"view",void 0),ra=h([F("esri.views.support.GroundViewElevationSampler")],ra);const kR=ra;let xn=class extends Pe{constructor(e){super(e),this.view=null,this.layerViews=new go}initialize(){this.addHandles(Dl(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground},e=>e.load())),this.addHandles(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new kR({view:this.view}):null:null}get extent(){const e=this.view;return e&&e.type!=="2d"&&e.ready?Qv(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map(e=>A(()=>e.updating,()=>this._updateUpdating(),st)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};h([p({readOnly:!0})],xn.prototype,"elevationSampler",null),h([p({readOnly:!0})],xn.prototype,"extent",null),h([p({type:Boolean,readOnly:!0})],xn.prototype,"updating",null),h([p({constructOnly:!0})],xn.prototype,"view",void 0),h([p({type:go,readOnly:!0})],xn.prototype,"layerViews",void 0),h([p({readOnly:!0})],xn.prototype,"suspended",null),xn=h([F("esri.views.GroundView")],xn);const jR=xn,sc=()=>he(()=>import("./TileLayerView3D-Dg79Cp-y.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188])),L0=()=>he(()=>import("./ElevationLayerView3D-DK9zGzF5.js"),__vite__mapDeps([189,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,128,129,130,131,132,119,133,134,135,136,137,138,122,123,124,125,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188])),I0={"base-dynamic":()=>he(()=>import("./BaseDynamicLayerView3D-Dsjx_R6g.js"),__vite__mapDeps([190,1,2,191,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,3,4,192,165,166,124,125,193,69,109,68,115,116,117,188])),"base-elevation":L0,"base-tile":sc,"bing-maps":sc,"building-scene":()=>he(()=>import("./BuildingSceneLayerView3D-CZsisH1H.js"),__vite__mapDeps([194,1,2,195,196,197,198,199,200,21,45,47,48,33,34,30,20,31,8,32,201,17,39,76,88,43,19,44,26,35,127,202,203,204,168,116,205,206,164,6,7,9,10,11,12,13,14,15,16,18,22,23,24,25,27,28,29,36,37,38,40,41,42,46,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,77,78,79,80,81,82,83,84,85,86,87,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,163,207,208,188,209,210,211,212,213,214,215,216,165,166,124,125,135,217,112,113,114,218,161,219,220,221,222,223,224,225,134,120,226,122,123,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,167,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,242,243,244,245,246,247,248,249])),csv:()=>he(()=>import("./CSVLayerView3D-aMwhA2Nw.js"),__vite__mapDeps([250,1,2,215,71,46,47,48,216,116,165,166,124,125,135,26,217,66,65,67,51,112,14,8,113,114,24,12,18,25,17,100,99,218,161,7,9,10,11,13,15,16,19,20,21,22,23,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,219,6,68,69,70,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,163,164,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),dimension:()=>he(()=>import("./DimensionLayerView3D-DvTJ8lRs.js"),__vite__mapDeps([251,1,2,3,4,115,116])),elevation:L0,feature:()=>he(()=>import("./FeatureLayerView3D-BH2hEfk0.js"),__vite__mapDeps([214,1,2,215,71,46,47,48,216,116,165,166,124,125,135,26,217,66,65,67,51,112,14,8,113,114,24,12,18,25,17,100,99,218,161,7,9,10,11,13,15,16,19,20,21,22,23,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,219,6,68,69,70,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,163,164,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),geojson:()=>he(()=>import("./GeoJSONLayerView3D-DHQtY0RR.js"),__vite__mapDeps([252,1,2,215,71,46,47,48,216,116,165,166,124,125,135,26,217,66,65,67,51,112,14,8,113,114,24,12,18,25,17,100,99,218,161,7,9,10,11,13,15,16,19,20,21,22,23,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,219,6,68,69,70,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,163,164,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),graphics:()=>he(()=>import("./GraphicsLayerView3D-De-WQb2o.js"),__vite__mapDeps([253,1,2,3,4,218,48,47,161,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,254,116,6,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,192,165,166,124,125,115])),group:()=>he(()=>import("./GroupLayerView-M_UGd6AY.js"),__vite__mapDeps([255,1,2,115,116])),imagery:()=>he(()=>import("./ImageryLayerView3D-CxzoBZmy.js"),__vite__mapDeps([256,1,2,191,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,3,4,192,165,166,124,125,193,69,109,68,115,116,117,188,257,127])),"integrated-mesh":()=>he(()=>import("./IntegratedMeshLayerView3D-DPQH3a33.js"),__vite__mapDeps([258,1,2,204,168,19,20,21,31,116,205,206,33,34,30,8,32,164,6,7,9,10,11,12,13,14,15,16,17,18,22,23,24,25,26,27,28,29,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,163,207,208,200,201,188,209,210,211,212,213,214,215,216,165,166,124,125,135,217,112,113,114,218,161,219,220,221,222,223,224,225,134,127,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,167,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,242,243,244,245,246,247])),"integrated-mesh-3dtiles":()=>he(()=>import("./IntegratedMesh3DTilesLayerView3D-LuHedwfy.js"),__vite__mapDeps([259,1,2,19,20,21,39,205,206,33,34,30,31,8,32,164,6,7,9,10,11,12,13,14,15,16,17,18,22,23,24,25,26,27,28,29,35,36,37,38,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,260,3,4,133,130,116,134,131,135,136,137,128,129,138,122,123,124,125,139,140,141,142,143,144,145,146,147,162,163,115,132,119,148,149,150,151,112,113,114,152,153,154,155,156,157,158,159,160,161,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188])),"line-of-sight":()=>he(()=>import("./LineOfSightLayerView3D-Clo63x8x.js"),__vite__mapDeps([261,1,2,3,4,115,116])),"map-image":()=>he(()=>import("./MapImageLayerView3D-DINZMIGA.js"),__vite__mapDeps([262,1,2,191,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,3,4,192,165,166,124,125,193,69,109,68,115,116,117,188,263,264,119,120,126,118,121,122,123,127])),media:()=>he(()=>import("./MediaLayerView3D-B8BxNhgg.js"),__vite__mapDeps([265,1,2,266,19,20,27,267,123,7,8,9,10,11,12,13,14,15,16,17,18,21,22,23,24,25,26,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,3,4,193,69,109,68,115,116])),"ogc-feature":()=>he(()=>import("./OGCFeatureLayerView3D-C6FgkZcy.js"),__vite__mapDeps([268,1,2,215,71,46,47,48,216,116,165,166,124,125,135,26,217,66,65,67,51,112,14,8,113,114,24,12,18,25,17,100,99,218,161,7,9,10,11,13,15,16,19,20,21,22,23,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,219,6,68,69,70,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,269,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,163,164,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),"open-street-map":sc,"oriented-imagery":()=>he(()=>import("./FeatureLayerView3D-BH2hEfk0.js"),__vite__mapDeps([214,1,2,215,71,46,47,48,216,116,165,166,124,125,135,26,217,66,65,67,51,112,14,8,113,114,24,12,18,25,17,100,99,218,161,7,9,10,11,13,15,16,19,20,21,22,23,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,219,6,68,69,70,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,163,164,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),"point-cloud":()=>he(()=>import("./PointCloudLayerView3D-ByhzeHV-.js"),__vite__mapDeps([270,1,2,9,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,3,4,170,200,201,271,272,162,163,273,127,115,116,188,128,129,130,131,132,119,133,134,135,136,137,138,122,123,124,125,139,140,141,142,143,144,145,146,147,148,149,150,151,112,113,114,152,153,154,155,156,157,158,159,160,161,164,165,166,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),voxel:()=>he(()=>import("./VoxelLayerView3D-B7hlYjqB.js"),__vite__mapDeps([274,1,2,47,48,3,4,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,273,127,115,116,188,128,129,130,131,132,119,133,134,135,136,137,138,122,123,124,125,139,140,141,142,143,144,145,146,147,148,149,150,151,112,113,114,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),route:()=>he(()=>import("./RouteLayerView3D-BYNrvXBs.js"),__vite__mapDeps([275,1,2,276,277,3,4,254,116,46,47,48,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,192,165,166,124,125,240,115])),scene:i=>i.profile==null||i.profile==="mesh-pyramids"?he(()=>import("./SceneLayerView3D-BuoUMj2p.js"),__vite__mapDeps([278,1,2,209,202,203,120,204,168,19,20,21,31,116,205,206,33,34,30,8,32,164,6,7,9,10,11,12,13,14,15,16,17,18,22,23,24,25,26,27,28,29,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,163,207,208,200,201,188,210,211,212,213,214,215,216,165,166,124,125,135,217,112,113,114,218,161,219,220,221,222,223,224,225,134,127,226,122,123,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,167,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,242,243,244,245,246,247,279,249,248,273])):he(()=>import("./SceneLayerGraphicsView3D-ByyQXWVq.js"),__vite__mapDeps([280,1,2,47,48,10,163,71,46,207,6,7,8,9,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,206,208,200,201,164,188,209,210,211,212,213,214,215,216,116,165,166,124,125,135,217,112,113,114,218,161,219,220,221,222,223,224,225,134,127,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,279,249,273])),stream:()=>he(()=>import("./StreamLayerView3D-D58Tb4ng.js"),__vite__mapDeps([281,1,2,282,283,284,237,122,123,124,125,238,239,75,73,74,240,66,216,46,47,48,116,165,166,135,71,26,217,65,67,51,112,14,8,113,114,24,12,18,25,17,100,99,218,161,7,9,10,11,13,15,16,19,20,21,22,23,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,219,6,68,69,70,72,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,120,226,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,115,285,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,163,164,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),tile:sc,"imagery-tile":()=>he(()=>import("./ImageryTileLayerView3D-Cot94oIS.js"),__vite__mapDeps([286,1,2,287,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,288,127,115,116,117,121,139,128,129,130,131,132,119,133,134,135,136,137,138,122,123,124,125,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188])),"vector-tile":()=>he(()=>import("./VectorTileLayerView3D-DuanJ7Ao.js"),__vite__mapDeps([289,1,2,133,130,116,134,66,131,135,136,137,4,26,128,129,95,96,138,19,27,70,8,122,123,124,125,139,140,141,142,143,144,145,146,147,290,97,15,16,239,291,59,292,174,176,171,172,173,175,92,64,63,177,178,62,180,93,113,114,293,294,94,295,296,297,298,299,3,5,6,7,9,10,11,12,13,14,17,18,20,21,22,23,24,25,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,60,61,65,67,68,69,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,115,132,119,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,179,181,182,183,184,185,186,187,188])),wcs:()=>he(()=>import("./ImageryTileLayerView3D-Cot94oIS.js"),__vite__mapDeps([286,1,2,287,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,288,127,115,116,117,121,139,128,129,130,131,132,119,133,134,135,136,137,138,122,123,124,125,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188])),"web-tile":sc,wfs:()=>he(()=>import("./WFSLayerView3D-BTZ5Fcqj.js"),__vite__mapDeps([300,1,2,215,71,46,47,48,216,116,165,166,124,125,135,26,217,66,65,67,51,112,14,8,113,114,24,12,18,25,17,100,99,218,161,7,9,10,11,13,15,16,19,20,21,22,23,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,52,53,54,55,56,57,58,59,60,61,62,63,64,219,6,68,69,70,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188,120,226,122,123,202,203,227,228,229,230,231,232,233,119,234,235,155,236,192,3,4,237,238,239,170,240,241,115,117,128,129,130,131,132,133,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,156,157,158,159,160,162,163,164,167,168,169,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187])),wms:()=>he(()=>import("./WMSLayerView3D-BqewjqSp.js"),__vite__mapDeps([301,1,2,191,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,3,4,192,165,166,124,125,193,69,109,68,115,116,117,188,302,303])),wmts:()=>he(()=>import("./WMTSLayerView3D-B9y8V8e7.js"),__vite__mapDeps([304,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,128,129,130,131,132,119,133,134,135,136,137,138,122,123,124,125,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188])),catalog:null,"catalog-dynamic-group":null,"catalog-footprint":null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};function WR(i){const e=i.declaredClass?i.declaredClass.slice(i.declaredClass.lastIndexOf(".")+1):"Unknown",t=e.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Ir(`${t}:view-not-supported`,`${e} is not supported in 3D`)}const N0={hasLayerViewModule:i=>I0[i.type]!=null,importLayerView:i=>{const e=I0[i.type];if(e==null)throw WR(i);return e(i)}},F0="analyses-owner-handles";var pl,to;(function(i){i[i.PENDING=0]="PENDING",i[i.CREATED=1]="CREATED"})(pl||(pl={})),function(i){i[i.ADDED=0]="ADDED",i[i.REMOVED=1]="REMOVED"}(to||(to={}));let Ga=class extends Pe{constructor(e){super(e),this._allAnalysisViews=new go,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=V0(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(Ts("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(Ts()),this._attachedToViewResolver=V0()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(t==null||t.state.list===to.REMOVED)throw new Ir("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),F0)}_disconnectOwners(){this.removeHandles(F0),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const s of e)this._addAnalysis(s);const t=e.on("after-add",s=>this._addAnalysis(s.item)),r=e.on("after-remove",s=>this._removeAnalysis(s.item));return pa(()=>{t.remove(),r.remove();for(const s of e)this._removeAnalysis(s)})}_addAnalysis(e){const t=this._items.get(e);if(t==null){const r={state:{view:pl.PENDING,list:to.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,r),r.createAnalysisViewTask=Hu(s=>this._createAnalysisViewPromise(r,s))}else t.state.list=to.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=to.REMOVED,this._scheduleUpdate()):de.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=iC(()=>this._update()))}_update(){this._scheduledUpdateHandle=Bn(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===to.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case pl.PENDING:e.createAnalysisViewTask=So(e.createAnalysisViewTask);break;case pl.CREATED:e.view!=null&&(this._allAnalysisViews.remove(e.view),e.view=te(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const r=e.analysis,s=r.type,n=this._analysisModules[s];if(this._creatingViewCount+=1,n.module==null)try{n.module=await this._loadAnalysisModule(s)}catch(o){throw this._creatingViewCount-=1,o}if(Ja(t))throw this._creatingViewCount-=1,Ts("AnalysisView creation aborted");const a=new n.module.default({analysis:r,view:this.view});try{await a.when()}catch(o){throw this._creatingViewCount-=1,o}if(Ja(t))throw this._creatingViewCount-=1,a.destroy(),Ts("AnalysisView creation aborted");return e.view=a,e.state.view=pl.CREATED,this._allAnalysisViews.add(a),this._creatingViewCount-=1,a}_loadAnalysisModule(e){switch(e){case"area-measurement":return he(()=>import("./AreaMeasurementAnalysisView3D-D60Hb1GW.js"),__vite__mapDeps([305,1,2,306,307,308,309,45,310,27,8,47,48,153,154,29,33,34,30,20,21,31,32,37,38,311,312,313,78,314,315,40,26,41,42,19,43,44,39,35,316,77,317,318,319,320,321,7,9,10,11,12,13,14,15,16,17,18,22,23,24,25,28,36,46,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,101,81,82,322,323,324,325,168,129,326,327,161,130,328,69,109,68]));case"dimension":return he(()=>import("./DimensionAnalysisView3D-2QuCyY9m.js"),__vite__mapDeps([329,1,2,308,330,129,307,310,21,30,20,31,8,32,47,48,46,326,27,321,327,161,130,328,45,331,317,332,333,315,33,34,323,134,66,116,120,188,312,313,78,314,154,334,335,19,39,38,40,26,41,42,43,44,35,157,7,9,10,11,12,13,14,15,16,17,18,22,23,24,25,28,29,36,37,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,67,137,68,69,336,337,105,106,79,108,338,193,109,339,340,341,342,294,343,344,345,320,346,347,348,319,101,81,77,82,349,322,350,351,352,217,353,354,355,324,325,168,6,70,71,72,73,74,75,76,80,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,102,103,104,107,110,111,356]));case"direct-line-measurement":return he(()=>import("./DirectLineMeasurementAnalysisView3D-B5ZcfHah.js"),__vite__mapDeps([357,1,2,306,307,308,309,310,312,313,78,314,45,48,153,154,315,319,40,21,33,34,30,20,31,8,32,26,41,38,42,19,43,44,39,35,320,321,7,9,10,11,12,13,14,15,16,17,18,22,23,24,25,27,28,29,36,37,46,47,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,101,81,77,82,318,334,324,325,168,129,358,326,327,161,130,328,346,343,68,69]));case"line-of-sight":return he(()=>import("./LineOfSightAnalysisView3D-DTZBy3HU.js"),__vite__mapDeps([359,1,2,308,360,243,244,245,116,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,161,162,163,157,319,320,321,335,137,361,344,133,130,134,131,135,136,4,128,129,138,122,123,124,125,139,140,141,142,143,144,145,146,147,354,337,338,345,356]));case"slice":return he(()=>import("./SliceAnalysisView3D-DzRqeG9n.js"),__vite__mapDeps([362,1,2,308,363,129,243,244,245,41,34,21,38,30,20,31,8,32,33,196,197,198,199,200,45,47,48,201,17,39,76,88,43,19,44,26,35,127,364,335,27,46,161,40,42,157,7,9,10,11,12,13,14,15,16,18,22,23,24,25,28,29,36,37,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,137,68,69,193,109,319,320,321,101,81,77,78,82,132,102,340,336,337,105,106,79,108,338,354,355,134,356]))}}};function V0(){const i=Sv();return i.promise.catch(()=>{}),i}h([p()],Ga.prototype,"updating",null),h([p({constructOnly:!0})],Ga.prototype,"view",void 0),h([p()],Ga.prototype,"_allAnalysisViews",void 0),h([p()],Ga.prototype,"_creatingViewCount",void 0),Ga=h([F("esri.views.3d.analysis.AnalysisViewManager3D")],Ga);const QR=Ga;let wn=class extends Pe{constructor(e){super(e),this.collision=new bc,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Re.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Re.Local?this._set("altitude",e):de.getLogger(this).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?ie(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const r=this.tilt(e);return ie(t,r.min,r.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Re.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,r=Mp)=>(r.min=Ei.min,r.max=e,r)}_createDefaultTiltLocal(){const e=this.collision.enabled?Ld([[4e3,Ei.max],[1e4,Wt(88)],[6e6,Wt(88)]]):()=>Ei.max;return(t,r=Mp)=>(r.min=Ei.min,r.max=e(t),r)}_createDefaultTiltGlobal(){const e=this.collision.enabled?Ld([[4e3,Ei.max],[5e4,Wt(88)],[6e6,Wt(88)],[2e7,Ei.min]]):Ld([[3e5,Ei.max],[3e6,Wt(88)],[6e6,Wt(88)],[2e7,Ei.min]]);return(t,r=Mp)=>(r.min=Ei.min,r.max=e(t),r)}};function ZR(i){return{min:-2e5,max:4*i.radius}}h([p()],wn.prototype,"altitude",null),h([p({readOnly:!0})],wn.prototype,"collision",void 0),h([p()],wn.prototype,"distance",void 0),h([p({readOnly:!0})],wn.prototype,"minimumPoiDistance",void 0),h([p()],wn.prototype,"tilt",void 0),h([p({constructOnly:!0})],wn.prototype,"mode",void 0),wn=h([F("esri.views.3d.state.Constraints")],wn);const U0=ZR(js),Ei={min:Wt(.5),max:Wt(179.5)},Mp={min:0,max:0};let bc=class extends Pe{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};h([p({type:Boolean})],bc.prototype,"enabled",void 0),h([p({type:Number})],bc.prototype,"elevationMargin",void 0),bc=h([F("esri.views.3d.state.Constraints.CollisionConstraint")],bc);let ml=class extends Gu{constructor(){super(...arguments),this.min=U0.min,this.max=U0.max}};h([p({type:Number})],ml.prototype,"min",void 0),h([p({type:Number})],ml.prototype,"max",void 0),ml=h([F("esri.views.3d.constraints.AltitudeConstraint")],ml);let Sn=class extends Gu{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};h([p({type:Number,value:1e-8})],Sn.prototype,"near",null),h([$l("near")],Sn.prototype,"castNear",null),h([p({type:Number,value:1e-8})],Sn.prototype,"far",null),h([$l("far")],Sn.prototype,"castFar",null),h([p({type:["auto","manual"]})],Sn.prototype,"mode",void 0),Sn=h([F("esri.views.3d.constraints.ClipDistanceConstraint")],Sn);const a_={min:Lm(Ei.min),max:Lm(Ei.max)};let io=class extends Gu{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return ie(e,a_.min,a_.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};h([p({type:["auto","manual"]})],io.prototype,"mode",void 0),h([p({type:Number,value:a_.max})],io.prototype,"max",null),h([$l("max")],io.prototype,"castMax",null),io=h([F("esri.views.3d.constraints.TiltConstraint")],io);let ro=class extends Gu{constructor(){super(...arguments),this.tilt=new io,this.altitude=new ml,this.clipDistance=new Sn}};h([p({type:io})],ro.prototype,"tilt",void 0),h([p({type:ml})],ro.prototype,"altitude",void 0),h([p({type:Sn})],ro.prototype,"clipDistance",void 0),ro=h([F("esri.views.3d.constraints.Constraints")],ro);var rl;let qs=rl=class extends es.EventedMixin(Jv){constructor(i){super(i),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),t=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",t),this._set("date",t)}get ambientOcclusionEnabled(){return da(de.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._get("ambientOcclusionEnabled")??!1}set ambientOcclusionEnabled(i){da(de.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._set("ambientOcclusionEnabled",i)}get waterReflectionEnabled(){return da(de.getLogger(this),"waterReflectionEnabled",{replacement:"reflections are automatically shown and this property has no effect",version:"4.27"}),this._get("waterReflectionEnabled")??!1}set waterReflectionEnabled(i){da(de.getLogger(this),"waterReflectionEnabled",{replacement:"reflections are automatically shown and this property has no effect",version:"4.27"}),this._set("waterReflectionEnabled",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(i){return new rl(i.cloneConstructProperties())}set defaultDate(i){const e=this._get("date")===this._get("defaultDate");i=new Date(i.getTime()),this._set("defaultDate",i),e&&this._set("date",i)}set date(i){i!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(i.getTime())))}autoUpdate(i,e){const t=rl.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let r=null;i!=null&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(i.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(i.getTime()))));const s=rl.calculateTimezoneOffset(this.positionTimezoneInfo);if(t!==s&&(Gh.target=this,Gh.timezoneOffset=s,this.emit("timezone-will-change",Gh),Gh.target=null),i!=null)return isNaN(i.getTime())||r!==i.getTime()}clone(){const i=this._get("date")===this._get("defaultDate"),e=new rl({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return i&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(i){const e=this.clone();return i.date!=null&&(e.date=i.date),e.directShadowsEnabled=i.directShadowsEnabled,e.displayUTCOffset=i.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};h([p({type:Boolean})],qs.prototype,"cameraTrackingEnabled",void 0),h([p({type:Boolean})],qs.prototype,"ambientOcclusionEnabled",null),h([p({type:Boolean})],qs.prototype,"waterReflectionEnabled",null),h([p({type:Date})],qs.prototype,"defaultDate",null),h([p({type:Date})],qs.prototype,"date",null),qs=rl=h([F("esri.views.3d.environment.SunLighting")],qs),function(i){function e({hours:t,minutes:r,seconds:s}){return Math.round(t+r/60+s/3600)}i.calculateTimezoneOffset=e}(qs||(qs={}));const Gh={target:null,timezoneOffset:0},ka=qs;var Nd;let sl=Nd=class extends es.EventedMixin(eb){constructor(i){super(i),this.cameraTrackingEnabled=!0}get ambientOcclusionEnabled(){return da(de.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._get("ambientOcclusionEnabled")??!1}set ambientOcclusionEnabled(i){da(de.getLogger(this),"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._set("ambientOcclusionEnabled",i)}get waterReflectionEnabled(){return da(de.getLogger(this),"waterReflectionEnabled",{replacement:"water reflections are automatically shown and this property has no effect",version:"4.27"}),this._get("waterReflectionEnabled")??!1}set waterReflectionEnabled(i){da(de.getLogger(this),"waterReflectionEnabled",{replacement:"water reflections are automatically shown and this property has no effect",version:"4.27"}),this._set("waterReflectionEnabled",i)}clone(){return new Nd({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(i){return new Nd(i.cloneConstructProperties())}cloneWithWebsceneLighting(i){const e=this.clone();return e.directShadowsEnabled=i.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};h([p({type:Boolean})],sl.prototype,"ambientOcclusionEnabled",null),h([p({type:Boolean})],sl.prototype,"waterReflectionEnabled",null),h([p({type:Boolean})],sl.prototype,"cameraTrackingEnabled",void 0),sl=Nd=h([F("esri.views.3d.environment.VirtualLighting")],sl);const xc=sl,XR={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:ka,virtual:xc}};var o_;let kc=o_=class extends Pe{set quality(i){["low","high"].includes(i)&&this._set("quality",i)}clone(){return new o_({quality:this.quality})}};h([p({type:["low","high"],value:"low"})],kc.prototype,"quality",null),kc=o_=h([F("esri.views.3d.environment.SceneViewAtmosphere")],kc);var wc;let nl=wc=class extends tb{constructor(i){super(i),this.atmosphere=new kc,this.lighting=this.castLighting(),this.cachedCameraTrackingEnabled=null}destroy(){this.atmosphere.destroy()}static fromWebsceneEnvironment(i){const e=i.cloneConstructProperties();return new wc({...e,lighting:e.lighting?e.lighting.type==="virtual"?xc.fromWebsceneLighting(e.lighting):ka.fromWebsceneLighting(e.lighting):void 0})}castLighting(i){return this._convertLightingWithDestroy(i)}applyLighting(i){this.lighting=this._convertLightingWithDestroy(i)}_convertLightingWithDestroy(i){const e=this._convertLighting(i);return e!==i&&this.addHandles(rC(e)),e}_convertLighting(i){var e,t;return i?i instanceof ka||i instanceof xc?i:i instanceof Jv?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(i):new ka({...i.cloneConstructProperties(),...(e=this.lighting)==null?void 0:e.cloneNonPersistentConstructProperties()}):i instanceof eb?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i):new xc({...i.cloneConstructProperties(),...(t=this.lighting)==null?void 0:t.cloneNonPersistentConstructProperties()}):sC(XR,i):new ka}clone(){return new wc({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Rf(this.background)})}cloneWithWebsceneEnvironment(i){return new wc({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Rf(this.background),...i.cloneConstructProperties(),lighting:this._getLighting(i)})}_getLighting(i){switch(i.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(i.lighting):ka.fromWebsceneLighting(i.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i.lighting):xc.fromWebsceneLighting(i.lighting);default:return ba(i.lighting),ka.fromWebsceneLighting(i.lighting)}}};h([p({type:kc,json:{read:!1},nonNullable:!0})],nl.prototype,"atmosphere",void 0),h([p({nonNullable:!0})],nl.prototype,"lighting",void 0),h([$l("lighting")],nl.prototype,"castLighting",null),nl=wc=h([F("esri.views.3d.environment.SceneViewEnvironment")],nl);const al=nl;var Vi;(function(i){i[i.Realistic=0]="Realistic",i[i.Local=1]="Local",i[i.Mars=2]="Mars",i[i.None=3]="None"})(Vi||(Vi={}));function _g(i){return ie((i-1e5)/9e5,0,1)}const l_=1e4,YR=.085,aa=1e5,Ol=It(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),Dp=3,$p=It(Dp*parseFloat(65e-8.toFixed(6)),Dp*parseFloat(1881e-9.toFixed(6)),Dp*parseFloat(85e-9.toFixed(6))),KR=3996e-9,JR=It(parseFloat(Number(Ol[0]+$p[0]).toFixed(6)),parseFloat(Number(Ol[1]+$p[1]).toFixed(6)),parseFloat(Number(Ol[2]+$p[2]).toFixed(6)));function Qb(i){const e=new Mt;e.attributes.add(ae.POSITION,"vec2"),e.include(ep,{textureCoordinateType:Ta.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:t,fragment:r}=e;return t.uniforms.add(new Ki("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new Ki("inverseViewMatrix",(s,n)=>ku(e5,n.camera.viewMatrix))),t.code.add(g`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add(new Ai("backgroundColor",s=>s.backgroundColor),new $i("radii",s=>s.radii),new Ai("cameraPosition",(s,n)=>n.camera.eye),new Vn("heightParameters",s=>s.heightParameters),new Ne("innerFadeDistance",s=>s.innerFadeDistance),new Ne("altitudeFade",s=>s.altitudeFade),new Be("depthTexture",s=>s.depthTexture),new Ne("hazeStrength",s=>s.hazeStrength)),r.constants.add("betaRayleigh","vec3",Ol),r.constants.add("betaCombined","vec3",JR),r.constants.add("betaMie","float",KR),r.constants.add("scaleHeight","float",YR*aa),J_(r),e.include(rg),i.haze&&(r.include(bo),r.uniforms.add(new $i("nearFar",(s,n)=>n.camera.nearFar))),r.code.add(g`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(g`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),r.code.add(g`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),r.code.add(g`
    const int STEPS = 6;

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${i.haze?g`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${i.haze?"":g`mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * `} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${i.haze?"":g`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${i.haze?g`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:g`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    ${i.haze?"":g`
            vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
              vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
              if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
                return fragColor;
              }

              float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
              vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
              float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
              if (relDist > 1.0) {
                return surfaceColor;
              }

              return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
            }

            float getGlow(float dist, float radius, float intensity) {
              return pow(radius / max(dist, 1e-6), intensity);
            }

            vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){

              // Get the amount of atmosphere between camera and the Sun along the view ray
              float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
              float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));

              // Find the amount of light that remains after travelling through the atmosphere from the Sun along the view ray
              // This will make the colour of the Sun reddish on the horizon and white from space
              vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));

              // Alignment of light direction and view ray
              float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
              // Draw the Sun as a bright disc
              float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));

              return normalize(sunTransmittance) * sunDisc;
            }`}

    ${i.haze&&i.reduced?g`
        float getDepth(vec2 uv){
          return linearDepthFromTexture(depthTexture, uv, nearFar);
        }

        float textureBilinear(vec2 uv) {
          // Information about the high-resolution depth texture
          vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
          vec2 texelSize = 1.0 / depthTextureSize;

          // The uv inside the upper right pixel - of the tile of 4 pixels -
          // that the atmosphere uv maps to in the depth texture
          vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);

          // Relative distance of the uv coordinates inside the depth texture pixel
          vec2 f = fract(depthUV);

          // Snap to the centre of the depth texture pixel
          vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;

          // Read the depth texture pixel and its three neighbours
          float d0 = getDepth(snapUV);
          float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
          float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
          float d3 = getDepth(snapUV + texelSize);

          // Return the bilinearly interpolated value of the neighbouring pixels based
          // on the sample position in the depth texture pixel
          return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
        }
        `:""}

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${i.haze?g`
          vec4 depthSample = texture(depthTexture, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;

              ${i.reduced?g`cameraSpaceRay *= -textureBilinear(vuv0);`:g`cameraSpaceRay *= -linearDepthFromTexture(depthTexture, vuv0, nearFar);`}

            terrainDepth = max(0.0, length(cameraSpaceRay));
          }else{
            discard;
          }
          `:g`${i.reduced?"":g`
                float depthSample = texture(depthTexture, vuv0).r;
                if (depthSample != 1.0) {
                  fragColor = vec4(0);
                  return;
                }`}`}

      ${i.haze?g`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            // Alpha is ignored for haze blending
            float alpha = 1.0;
            `:g`
            vec3 col = linearizeGamma(backgroundColor);
            col += getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            col += getSun(cameraPosition, rayDir, mainLightDirection);
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      ${i.haze?"":g`fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);`}
    }
  `),e}const e5=ct(),t5=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:Ol,build:Qb},Symbol.toStringTag,{value:"Module"}));let i5=class extends di{constructor(){super(...arguments),this.heightParameters=_i(),this.radii=Di(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1,this.renderScale=Di(),this.backgroundColor=v()}},Cc=class Zb extends Ft{initializeProgram(e){return new Dt(e.rctx,Zb.shader.get().build(this.configuration),Pt)}initializePipeline(){return this.configuration.reduced?nt({blending:cn(Z.ONE,Z.ZERO),depthTest:{func:Hi.ALWAYS},colorWrite:lt}):this.configuration.haze?nt({blending:pr(Z.ONE,Z.ZERO,Z.ONE_MINUS_SRC_COLOR,Z.ONE),colorWrite:lt}):nt({blending:cn(Z.SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),depthTest:{func:Hi.LEQUAL},colorWrite:lt})}};Cc.shader=new Nt(t5,()=>he(()=>Promise.resolve().then(()=>N$),void 0));let Eu=class extends Ls{constructor(){super(...arguments),this.haze=!1,this.reduced=!1}};h([$()],Eu.prototype,"haze",void 0),h([$()],Eu.prototype,"reduced",void 0);new Os(ae.POSITION,3,Xi.FLOAT,0,12);new Os(ae.POSITION,3,Xi.FLOAT,0,20),new Os(ae.UV0,2,Xi.FLOAT,12,20);new Os(ae.POSITION,3,Xi.FLOAT,0,32),new Os(ae.NORMAL,3,Xi.FLOAT,12,32),new Os(ae.UV0,2,Xi.FLOAT,24,32);new Os(ae.POSITION,3,Xi.FLOAT,0,16),new Os(ae.COLOR,4,Xi.UNSIGNED_BYTE,12,16);const gg=[new Os(ae.POSITION,2,Xi.FLOAT,0,8)],Dh=[new Os(ae.POSITION,2,Xi.FLOAT,0,16),new Os(ae.UV0,2,Xi.FLOAT,8,16)];function un(i,e=gg,t=Pt,r=-1,s=1){let n=null;return e===Dh?n=new Float32Array([r,r,0,0,s,r,1,0,r,s,0,1,s,s,1,1]):n=new Float32Array([r,r,s,r,r,s,s,s]),new jn(i,t,{geometry:e},{geometry:ur.createVertex(i,Nr.STATIC_DRAW,n)})}const r5=4;function Xb(i){const e=new ui(r5);return e.samplingMode=Pr.NEAREST,new Ci(i,e)}let fg=class extends di{};function Yb(i){const e=new Mt;e.include(Fr),e.fragment.uniforms.add(new Be("colorTexture",r=>r.color),new Be("depthTexture",r=>r.depth));const t=i.haze;return e.fragment.code.add(g`
    void main() {
      ${t?g`vec4`:g`float`} depthSample = texture(depthTexture, uv) ${t?"":g`.r`};
      if (depthSample ${t?g`== vec4(0)`:g`!= 1.0`} ) {
          fragColor = vec4(0);
          return;
      }
      fragColor = texture(colorTexture, uv);
    }
    `),e}const s5=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:fg,build:Yb},Symbol.toStringTag,{value:"Module"}));let Kb=class Jb extends Ft{initializeProgram(e){return new Dt(e.rctx,Jb.shader.get().build(this.configuration),Pt)}initializePipeline(){return this.configuration.haze?nt({blending:pr(Z.ONE,Z.ZERO,Z.ONE_MINUS_SRC_COLOR,Z.ONE),depthTest:{func:Hi.ALWAYS},colorWrite:lt}):nt({blending:cn(Z.SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),depthTest:{func:Hi.ALWAYS},colorWrite:lt})}};Kb.shader=new Nt(s5,()=>he(()=>Promise.resolve().then(()=>F$),void 0));let z0=class{constructor(e,t){this._view=e,this._context=t,this.type=Vi.Realistic,this._handles=new ju,this._compositingPassParameters=new fg,this._atmosphereConfiguration=new Eu,this._passParameters=new i5,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=js.radius,this._fadeHaze=0,this._updateRadius(js.radius);const r=this._context.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([A(()=>{var n,a;return(a=(n=this._view)==null?void 0:n.basemapTerrain)==null?void 0:a.rootTileElevationBounds},()=>{var n;return(n=this._view)!=null&&n.basemapTerrain?this._updateRootTileElevationBounds():null}),A(()=>{var n,a;return(a=(n=this._view)==null?void 0:n.basemapTerrain)==null?void 0:a.visibleElevationBounds},()=>{var n;return(n=this._view)!=null&&n.basemapTerrain?this._updateVisibleElevationBounds():null}),A(()=>{var n;return(n=this._view)==null?void 0:n.environment.background},n=>{const a=n instanceof H3?th(n.color):B_;Ie(this._passParameters.backgroundColor,a[0]*a[3],a[1]*a[3],a[2]*a[3])},vt)]);const s=new Eu;s.haze=!1,this._atmosphereTechnique=this._context.techniqueRepository.acquire(Cc,s),s.haze=!0,this._atmosphereHazeTechnique=this._context.techniqueRepository.acquire(Cc,s),s.reduced=!0,s.haze=!1,this._atmosphereReducedTechnique=this._context.techniqueRepository.acquire(Cc,s),s.haze=!0,this._atmosphereHazeReducedTechnique=this._context.techniqueRepository.acquire(Cc,s),this._vao=un(r,Dh)}destroy(){this._handles.destroy(),this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._atmosphereReducedTechnique.release(),this._atmosphereHazeReducedTechnique.release(),this._vao.dispose()}render(e,t){this._render(e,t?this._atmosphereTechnique:this._atmosphereReducedTechnique,e.offscreenRenderingHelper.depthTexture,t,!1)}renderHaze(e,t,r){var s;this._fadeHaze=t,this._render(e,r?this._atmosphereHazeTechnique:this._atmosphereHazeReducedTechnique,(s=e.bindParameters.linearDepth)==null?void 0:s.getTexture(),r,!0)}_render(e,t,r,s,n){if(r==null)return;const a=e.offscreenRenderingHelper;this._update(e.bindParameters.camera),this._passParameters.depthTexture=r;const o=e.rctx.bindTechnique(t,e.bindParameters,this._passParameters);if(s)a.renderDepthDetached(()=>this._renderCommon(o,e));else{const l=e.rctx.getViewport(),c=we(e.bindParameters.camera.eye)-js.radius;let d;if(c<aa){const y=Math.min(1,Math.max(0,c/aa));d=n?He(.4,.5,y):He(.2,.3,y)}else{const y=Math.min(1,Math.max(0,(c-aa)/(15*aa)));d=n?He(.5,1,y):He(.3,.6,y)}const u=Zm(Math.round(d*e.bindParameters.camera.fullViewport[2])),m=Zm(Math.round(d*e.bindParameters.camera.fullViewport[3]));e.rctx.setViewport(0,0,u,m);const _=a.renderToCachedFBO(null,"chapman",()=>this._renderCommon(o,e),[0,0,0,1],si.RGBA,null,u,m);e.rctx.setViewport(l.x,l.y,l.width,l.height),this._compositingPassParameters.color=_.getTexture(),this._compositingPassParameters.depth=r,this._atmosphereConfiguration.haze=n;const f=this._context.techniqueRepository.acquire(Kb,this._atmosphereConfiguration);e.rctx.bindTechnique(f,e.bindParameters,this._compositingPassParameters),a.renderDepthDetached(()=>e.rctx.screen.draw()),f.release(),_.release()}}_renderCommon(e,t){this._vao!=null&&(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(Ti.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=js.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(js.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,sn(this._passParameters.radii,e,e+aa),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-l_)*l_)}_update(e){if(!e)return;const t=xs(e.eye),r=Math.sqrt(t),s=t-this._passParameters.radii[1]*this._passParameters.radii[1],n=ie((r-this._passParameters.radii[0])/aa,0,1);xa(this._passParameters.heightParameters,r,t,s,n),this._passParameters.altitudeFade=_g(r-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=He(He(.6,1,ih(9500,10500,r-js.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}};function ex(){const i=new Mt,{attributes:e,varyings:t,vertex:r,fragment:s}=i;return e.add(ae.POSITION,"vec2"),t.add("worldRay","vec3"),r.uniforms.add(new Ki("inverseProjectionMatrix",(n,a)=>a.camera.inverseProjectionMatrix),new Ki("inverseViewMatrix",(n,a)=>ku(n5,a.camera.viewMatrix))),r.code.add(g`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),s.include(ib),s.include(Ro),i.include(LS,{pbrMode:Et.Disabled,lightingSphericalHarmonicsOrder:2}),i.include(W3),i.include(rg),i.include(Q3),i.include(OP),s.uniforms.add(new Ai("cameraPosition",(n,a)=>a.camera.eye)),s.code.add(g`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),i}const n5=ct(),a5=Object.freeze(Object.defineProperty({__proto__:null,build:ex},Symbol.toStringTag,{value:"Module"}));let tx=class ix extends Ft{constructor(e){super(e,new Ls,()=>this.destroy())}initializeProgram(e){return new Dt(e.rctx,ix.shader.get().build(),Pt)}initializePipeline(){return nt({blending:pr(Z.ONE,Z.ZERO,Z.SRC_ALPHA,Z.ONE),depthTest:{func:Hi.LEQUAL},colorWrite:lt})}};tx.shader=new Nt(a5,()=>he(()=>Promise.resolve().then(()=>V$),void 0));let ja=class extends Pe{constructor(e){super(e),this._technique=new tx(e),this._vao=un(e.rctx)}destroy(){this._technique=tt(this._technique),this._vao=Ae(this._vao)}render(e){if(!this._technique.compiled)return void this.requestRender();const t=e.bindParameters.cloudsFade;if(this._vao==null||t.data==null)return;const r=e.rctx.bindTechnique(this._technique,e.bindParameters,o5);e.rctx.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(Ti.TRIANGLE_STRIP,0,4)}};h([p({constructOnly:!0})],ja.prototype,"rctx",void 0),h([p({constructOnly:!0})],ja.prototype,"viewingMode",void 0),h([p({constructOnly:!0})],ja.prototype,"planetRadius",void 0),h([p({constructOnly:!0})],ja.prototype,"requestRender",void 0),ja=h([F("esri.views.3d.environment.CloudsComposition")],ja);const o5=new di;var hr;(function(i){i[i.SIXTEEN=0]="SIXTEEN",i[i.HUNDRED=1]="HUNDRED",i[i.TWOHUNDRED=2]="TWOHUNDRED",i[i.COUNT=3]="COUNT"})(hr||(hr={}));let Fd=class extends Ls{constructor(){super(...arguments),this.steps=hr.SIXTEEN,this.writeTextureChannels=sg.RG}};h([$({count:hr.COUNT})],Fd.prototype,"steps",void 0),h([$({constValue:li("esri-mobile")?1024:2048})],Fd.prototype,"cubeMapSize",void 0),h([$()],Fd.prototype,"writeTextureChannels",void 0);let Tc=class{constructor(e,t,r,s,n,a,o,l,c=.5){this.coverage=e,this.density=t,this.absorption=r,this.cloudSize=s,this.detailSize=n,this.smoothness=a,this.cloudHeight=o,this.raymarchingSteps=l,this.median=c}};const q0=new Tc([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],hr.SIXTEEN),Fi={sunny:q0,cloudy:new Tc([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],hr.TWOHUNDRED,.6),rainy:new Tc([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],hr.TWOHUNDRED,.4),snowy:new Tc([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],hr.HUNDRED,.65),foggy:new Tc([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],hr.SIXTEEN),default:q0},jr=li("esri-mobile")?64:128,l5=jr/128,_s=Math.ceil(Math.sqrt(jr)),fa=(jr+2)*_s,c5=1e5,Lp=128,h5=fa/1560;let yg=class extends di{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=Fi.default.raymarchingSteps,this.weatherTile=Di(),this.viewMatrix=$s()}};function rx(i){const e=new Mt;e.include(Fr,!1);const t=e.fragment;return t.uniforms.add(new Ne("cloudRadius",r=>r.cloudRadius),new Ne("power",r=>He(35,120,r.absorption)),new Ne("sigmaE",r=>1+r.absorption),new Ne("density",r=>He(0,.3,r.density)),new Ne("cloudSize",r=>He(0,.02,Math.max(.01,1-r.cloudSize))),new Ne("detailSize",r=>He(0,.2,Math.max(.01,1-r.detailSize))),new Ne("smoothness",r=>He(0,.5,1-r.smoothness)),new Ne("cloudHeight",r=>He(0,1500,r.cloudHeight)),new Ne("coverage",r=>r.coverage),new eg("view",r=>r.viewMatrix),new Be("cloudShapeTexture",r=>r.noiseTexture!=null?r.noiseTexture.textureAtlas:null),new $i("cloudVariables",r=>sn(d5,r.coverage,r.absorption))),t.constants.add("halfCubeMapSize","float",.5*i.cubeMapSize),t.code.add(g`
    const int STEPS = ${i.steps===hr.SIXTEEN?g`16`:i.steps===hr.HUNDRED?g`100`:g`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.code.add(g`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${g.float(fa)};
      const float dataWidth = ${g.float(fa)};
      const float tileRows = ${g.float(_s)};
      const vec3 atlasDimensions = vec3(${g.float(jr)}, ${g.float(jr)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${g.float(l5)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${g.float(h5)} * p) / ${g.float(fa)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),t.code.add(g`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.code.add(g`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),t.code.add(`
    float multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      float luminance = 0.0;

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),t.code.add(g`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.code.add(g`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),t.code.add(g`void main() {
if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),e}const d5=Di(),u5=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:yg,build:rx},Symbol.toStringTag,{value:"Module"}));let sx=class nx extends Ft{constructor(e,t){super(e,t,()=>this.destroy())}initializeProgram(e){return new Dt(e.rctx,nx.shader.get().build(this.configuration),Pt)}initializePipeline(){return nt({blending:cn(Z.CONSTANT_COLOR,Z.ONE_MINUS_CONSTANT_COLOR,yb.ADD,this.configuration.writeTextureChannels===sg.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Hi.LEQUAL},colorWrite:lt})}};sx.shader=new Nt(u5,()=>he(()=>Promise.resolve().then(()=>U$),void 0));var $r;(function(i){i[i.Full=0]="Full",i[i.WeatherMap=1]="WeatherMap",i[i.COUNT=2]="COUNT"})($r||($r={}));let c_=class extends Ls{constructor(){super(...arguments),this.mode=$r.Full}};h([$({count:$r.COUNT})],c_.prototype,"mode",void 0);let vg=class extends di{constructor(){super(...arguments),this.weatherTile=Ju(0,0)}};function ax(i){const e=new Mt;return e.include(Fr,!1),e.fragment.code.add(g`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),i.mode===$r.Full&&e.fragment.code.add(g`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${g.float(_s)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${g.float(8)});

      float worley0 = worley(p, ${g.float(2)} * 2.0);
      float worley1 = worley(p, ${g.float(2)} * 8.0);
      float worley2 = worley(p, ${g.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${g.float(2)});
      float worley1 = worley(p, ${g.float(2)} * 2.0);
      float worley2 = worley(p, ${g.float(2)} * 4.0);
      float worley3 = worley(p, ${g.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.uniforms.add(new $i("weatherTile",t=>t.weatherTile)),e.fragment.code.add(g`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${g.float(Lp)});

      // Get global coordinates of p
      p += weatherTile * ${g.float(Lp)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${g.float(c5)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.fragment.code.add(g`void main() {`),i.mode===$r.Full&&e.fragment.code.add(g`
        float padWidth = 1.0;
        float paddedSize = ${g.float(jr)} + 2.0 * padWidth;
        float tileCount = ${g.float(_s)} * ${g.float(_s)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${g.float(jr)};
          }

          if (startPadY) {
            pixel.y += ${g.float(jr)};
          }

          if (endPadX) {
            pixel.x -= ${g.float(jr)};
          }

          if (endPadY) {
            pixel.y -= ${g.float(jr)};
          }

          uv = vec2(pixel.xy / ${g.float(jr)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${g.float(jr)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${g.float(_s)} * ${g.float(_s)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${g.float(_s)} * ${g.float(_s)});
        p = p_;
        p.z /= (${g.float(_s)} * ${g.float(_s)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),e.fragment.code.add(g`
      vec2 mapUV = ${g.float(Lp)} * (gl_FragCoord.xy / ${g.float(fa)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${i.mode===$r.Full?g`fragColor.ba = vec2(0.0, map);`:g`fragColor = vec4(map);`};
    }
  `),e}const p5=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:vg,build:ax},Symbol.toStringTag,{value:"Module"}));let h_=class ox extends Ft{initializeProgram(e){return new Dt(e.rctx,ox.shader.get().build(this.configuration),Pt)}initializePipeline(){return nt({blending:this.configuration.mode===$r.Full?cn(Z.ONE,Z.ZERO):pr(Z.ZERO,Z.ONE,Z.ONE,Z.ZERO),depthTest:{func:Hi.ALWAYS},colorWrite:lt})}};h_.shader=new Nt(p5,()=>he(()=>Promise.resolve().then(()=>z$),void 0));let Pc=class extends Pe{constructor(e){super(e),this._needsRender=!0,this._passParameters=new vg,this._fbo=new Mh(e.context.renderContext.rctx,new ui(fa)),this._vao=un(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return this._texture!=null?this._weatherMapTechnique!=null&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render($r.WeatherMap)):this._fullTechnique!=null&&this._fullTechnique.compiled&&(this._texture=this._render($r.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(Ca(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=tt(this._fullTechniqueCached),this._weatherMapTechniqueCached=tt(this._weatherMapTechniqueCached),this._fbo=Ae(this._fbo),this._vao=Ae(this._vao)}get _fullTechnique(){if(this._fullTechniqueCached==null){const e=new c_;e.mode=$r.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(h_,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(this._weatherMapTechniqueCached==null){const e=new c_;e.mode=$r.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(h_,e)}return this._weatherMapTechniqueCached}_render(e){if(this._vao==null||this._fbo==null)return null;const t=e===$r.Full?this._fullTechnique:this._weatherMapTechnique,r=this.context.renderContext.rctx,s=r.getViewport();r.setViewport(0,0,fa,fa),r.bindFramebuffer(this._fbo);const n=r.bindTechnique(t,null,this._passParameters);return r.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._fbo.colorTexture}};h([p({constructOnly:!0})],Pc.prototype,"context",void 0),h([p({readOnly:!0})],Pc.prototype,"_techniqueRepository",null),Pc=h([F("esri.views.3d.environment.NoiseTextureAtlas")],Pc);let tr=class extends Pe{constructor(e){super(e),this._techniques=new Array,this._techniqueConfiguration=new Fd,this._bindParameters=new ng(null,null),this._passParameters=new yg,this._weatherTile=Di(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=He(Fi.default.coverage[0],Fi.default.coverage[1],.5),this.density=He(Fi.default.density[0],Fi.default.density[1],.5),this.absorption=He(Fi.default.absorption[0],Fi.default.absorption[1],.5),this.cloudSize=He(Fi.default.cloudSize[0],Fi.default.cloudSize[1],.5),this.detailSize=He(Fi.default.detailSize[0],Fi.default.detailSize[1],.5),this.smoothness=He(Fi.default.smoothness[0],Fi.default.smoothness[1],.5),this.cloudHeight=He(Fi.default.cloudHeight[0],Fi.default.cloudHeight[1],.5),this.raymarchingSteps=Fi.default.raymarchingSteps,this._viewMatrix=ct(),this._dirty=!1,this.running=!1,this._vao=un(e.context.renderContext.rctx)}_getTechnique(e){const t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,r=t===sg.RG?2*e:2*e+1;return this._techniques[r]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[r]=new sx({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[r])}updateWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(e==null||t==null)return;sn(this._weatherTile,(e+90)/180,(t+180)/360);const r=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-r)*this._weatherTile[1]);let s=0,n=0;if(this.view.environment!=null&&this.view.environment.lighting.type!=="virtual"&&this.view.environment.lighting.date!=null){const a=new Date(this.view.environment.lighting.date);a.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),s=31*a.getUTCMonth()+a.getUTCDate(),n=a.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+s)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+n%100)%(4*this._weatherTileCount),k3(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){const e=bt(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this.addHandles([this.view.resourceController.scheduler.registerTask(fi.CLOUDS_GENERATOR,this),A(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),oi)])}destroy(){this._techniques.forEach(e=>tt(e)),this._frameBufferCube=Ae(this._frameBufferCube),this._techniques.length=0,this._vao.dispose(),this._passParameters.noiseTexture=te(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case hr.SIXTEEN:return 1;case hr.HUNDRED:return 4;case hr.COUNT:case hr.TWOHUNDRED:return 8}}get usedMemory(){var e,t,r;return(((e=this._frameBufferCube)==null?void 0:e.usedMemory)??0)+(((r=(t=this._passParameters.noiseTexture)==null?void 0:t.textureAtlas)==null?void 0:r.usedMemory)??0)}_ensureNoiseTexture(){if(this._passParameters.noiseTexture!=null)this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new Pc({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return this._passParameters.noiseTexture.textureAtlas!=null}_ensureFrameBufferCube(e){if(this._frameBufferCube==null){const t=new ui(e);t.target=Jm.TEXTURE_CUBE_MAP,t.wrapMode=Ji.CLAMP_TO_EDGE,this._frameBufferCube=new Mh(this.context.renderContext.rctx,t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=Ae(this._frameBufferCube)}applyPreset(e,t){const r=e.median,s=n=>{const a=He(n[0],n[1],r);return t<.5?He(n[0],a,2*t):He(a,n[1],2*(t-.5))};this.coverage=s(e.coverage),this.density=s(e.density),this.absorption=s(e.absorption),this.cloudSize=s(e.cloudSize),this.detailSize=s(e.detailSize),this.smoothness=s(e.smoothness),this.cloudHeight=s(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){this._faceIndex===0&&this._tileIndex===0&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),Ca(this._passParameters.weatherTile,this._weatherTile));const t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return Yi;if(this.context.renderContext.bindParameters.cloudsFade.fadeMode===yc.CROSS_FADE||!this._ensureNoiseTexture())return Yi;this._faceIndex===0&&this._tileIndex===0&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=t_.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const r=m5[this._faceIndex],s=_5[this._faceIndex];nC(this._viewMatrix,g5,r,s),ag(this._passParameters.viewMatrix,this._viewMatrix);const n=this.context.renderContext.rctx,a=n.bindTechnique(t,this._bindParameters,this._passParameters);n.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao);const o=n.getViewport(),l=t.configuration.cubeMapSize,c=l/this._tilesPerFace,d=this._tileIndex*c;n.setViewport(0,d,l,c);const u=this._ensureFrameBufferCube(l);n.bindFramebuffer(u);const m=Jm.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return u.setColorTextureTarget(m),n.gl.drawArrays(n.gl.TRIANGLE_STRIP,0,4),n.gl.flush(),n.setViewport(o.x,o.y,o.width,o.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.running||(this.context.renderContext.bindParameters.cloudsFade.renderingStage=t_.FADING)):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Yi}};h([p({constructOnly:!0})],tr.prototype,"context",void 0),h([p({constructOnly:!0})],tr.prototype,"view",void 0),h([p({constructOnly:!0})],tr.prototype,"requestRender",void 0),h([p()],tr.prototype,"coverage",void 0),h([p()],tr.prototype,"density",void 0),h([p()],tr.prototype,"absorption",void 0),h([p()],tr.prototype,"cloudSize",void 0),h([p()],tr.prototype,"detailSize",void 0),h([p()],tr.prototype,"smoothness",void 0),h([p()],tr.prototype,"cloudHeight",void 0),h([p()],tr.prototype,"raymarchingSteps",void 0),h([p()],tr.prototype,"running",void 0),tr=h([F("esri.views.3d.environment.CloudsGenerator")],tr);const m5=[Xs(1,0,0),Xs(-1,0,0),Xs(0,1,0),Xs(0,-1,0),Xs(0,0,1)],_5=[Xs(0,1,0),Xs(0,1,0),Xs(0,0,-1),Xs(0,0,1),Xs(0,1,0)],g5=iS();let bg=class extends di{constructor(){super(...arguments),this.fogColor=v(),this.fogStrength=4e-6,this.atmosphereC=1,this.fogAmount=0}};function lx(){const i=new Mt;i.attributes.add(ae.POSITION,"vec2"),i.include(ep,{textureCoordinateType:Ta.Default}),i.varyings.add("worldRay","vec3"),i.varyings.add("eyeDir","vec3");const{vertex:e,fragment:t}=i;return e.uniforms.add(new Ki("inverseProjectionMatrix",(r,s)=>s.camera.inverseProjectionMatrix),new Ki("inverseViewMatrix",(r,s)=>ku(f5,s.camera.viewMatrix))),e.code.add(g`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),t.uniforms.add(new Ne("atmosphereC",r=>r.atmosphereC),new Ai("cameraPosition",(r,s)=>s.camera.eye),new $i("nearFar",(r,s)=>s.camera.nearFar),new Be("depthTexture",r=>r.depthTexture),new Ne("fogStrength",r=>r.fogStrength),new Ne("fogAmount",r=>r.fogAmount),new Ai("fogColor",r=>r.fogColor)),i.include(rg),t.include(bo),t.code.add(g`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),t.code.add(g`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),t.code.add(g`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}
void main() {
vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = texture(depthTexture, vuv0).r;
float zNorm = 2.0 * depthSample - 1.0;
float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linDepth;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
vec4 fog = applyFog(terrainDepth, rayDir);
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
}`),i}const f5=ct(),y5=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:bg,build:lx},Symbol.toStringTag,{value:"Module"}));let cx=class hx extends Ft{constructor(e){super(e,new Ls,()=>this.destroy())}initializeProgram(e){return new Dt(e.rctx,hx.shader.get().build(),Pt)}initializePipeline(){return nt({blending:pr(Z.SRC_ALPHA,Z.ZERO,Z.ONE_MINUS_SRC_ALPHA,Z.ONE),colorWrite:lt})}};cx.shader=new Nt(y5,()=>he(()=>Promise.resolve().then(()=>q$),void 0));const v5=.95,b5=1;let Wa=class extends Pe{constructor(e){super(e),this._passParameters=new bg;const t=e.context.renderContext.rctx;this._vao=un(t,Dh),this._technique=new cx(e);const r=bt(e.view.spatialReference);this._planetRadius=r.radius,this._atmosphereRadius=r.radius+aa}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const r=this._technique;if(!r.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const n=e.rctx.bindTechnique(r,e.bindParameters,this._passParameters);this._renderFog(n,e)})}_renderFog(e,t){const r=t.rctx;r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ti.TRIANGLE_STRIP,0,4)}_update(e,t){const r=e.bindParameters.camera;oe(B0,r.eye);const s=Math.max(0,pe(B0,e.bindParameters.lighting.mainLight.direction)),n=t.color;re(H0,n,.1),As(this._passParameters.fogColor,H0,n,s);const a=we(r.eye),o=a*a;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-ih(v5*i_,b5*i_,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}static isSupported(e){return e.capabilities.depthTexture}};h([p({constructOnly:!0})],Wa.prototype,"context",void 0),h([p({constructOnly:!0})],Wa.prototype,"view",void 0),h([p({constructOnly:!0})],Wa.prototype,"rctx",void 0),h([p({constructOnly:!0})],Wa.prototype,"viewingMode",void 0),Wa=h([F("esri.views.3d.environment.Fog")],Wa);let x5=class{constructor(){this.color=v(),this.strength=0,this.amount=0}};const B0=v(),H0=v();var hn;(function(i){i[i.Cone=0]="Cone",i[i.Cylinder=1]="Cylinder",i[i.Underground=2]="Underground",i[i.COUNT=3]="COUNT"})(hn||(hn={}));let xg=class extends tg{constructor(){super(...arguments),this.geometry=hn.Cone}};h([$({count:hn.COUNT})],xg.prototype,"geometry",void 0);let ap=class extends di{constructor(){super(...arguments),this.texV=Di(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new wg}},wg=class{constructor(){this.center=v(),this.v1=v(),this.v2=v()}};function dx(i){const e=new Mt,{vertex:t,fragment:r}=e;if(J_(t),i.geometry===hn.Underground)e.attributes.add(ae.POSITION,"vec2"),e.varyings.add("color","vec4"),t.uniforms.add(new Ai("cameraPosition",(s,n)=>n.camera.eye),new Ne("undergroundFadeAlpha",s=>s.undergroundFadeAlpha)),t.code.add(g`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.code.add(g`void main() {
fragColor = color;
}`);else{e.include(Gb,i),e.attributes.add(ae.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const s=i.geometry===hn.Cylinder;t.uniforms.add(new Ki("proj",(o,l)=>l.camera.projectionMatrix),new Ki("view",(o,l)=>l.camera.viewMatrix)),s||(e.varyings.add("innerFactor","float"),t.uniforms.add(new Ai("silCircleCenter",o=>o.silhouette.center)),t.uniforms.add(new Ai("silCircleV1",o=>o.silhouette.v1)),t.uniforms.add(new Ai("silCircleV2",o=>o.silhouette.v2)),t.uniforms.add(new $i("texV",o=>o.texV)),t.uniforms.add(new Ne("innerScale",o=>o.innerScale)));const n=6.2831853,a=1/128;t.code.add(g`
		void main(void) {
      ${s?g`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:g`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${g.float(n*a)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${g.float(a)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.uniforms.add(new Be("tex",o=>o.texture)),s||r.uniforms.add(new Ne("altitudeFade",o=>o.altitudeFade)),r.code.add(g`
		void main() {
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?g`fragColor = atmosphereColor;`:g`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const w5=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:wg,SimpleAtmospherePassParameters:ap,build:dx},Symbol.toStringTag,{value:"Module"}));let Au=class ux extends Ft{initializeProgram(e){return new Dt(e.rctx,ux.shader.get().build(this.configuration),Pt)}initializePipeline(){return this.configuration.geometry===hn.Cylinder?nt({blending:pr(Z.SRC_ALPHA,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),culling:bb,depthTest:{func:Hi.LEQUAL},colorWrite:lt}):nt({blending:pr(Z.SRC_ALPHA,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),depthTest:{func:Hi.LEQUAL},colorWrite:lt})}};Au.shader=new Nt(w5,()=>he(()=>Promise.resolve().then(()=>B$),void 0));const C5=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);let T5=class{constructor(e,t){this.type=Vi.Local,this._configuration=new xg,this._passParameters=new ap,this._configuration.geometry=hn.Cylinder,this._technique=t.techniqueRepository.acquire(Au,this._configuration);const r=t.renderContext.rctx;this._vao=this._createVertexArrayObject(r),this._vaoCount=Un(this._vao,"geometry");const s=new ui;s.wrapMode=Ji.CLAMP_TO_EDGE,s.flipped=!0,s.width=1,s.height=512,this._passParameters.texture=new Ci(r,s,C5)}destroy(){this._passParameters.texture=Ae(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const t=e.rctx,r=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);P5(G0,e.bindParameters.camera.viewMatrix),r.setUniformMatrix4fv("view",G0),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Ti.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const t=EP(1,2,!1),{data:r,indices:s}=t[0][1],n=k0.createBuffer(s.length),a=n.position;for(let o=0;o<s.length;++o){const l=3*s[o%3==0?o+2:o%3==2?o-2:o];a.set(o,0,r[l]),a.set(o,1,r[l+1]),a.set(o,2,r[l+2])}return new jn(e,Pt,{geometry:Aa(k0)},{geometry:ur.createVertex(e,Nr.STATIC_DRAW,n.buffer)})}};function P5(i,e){Bl(i,e),i[12]=0,i[13]=0,i[14]=0,i[15]=1}const G0=ct(),k0=Ma().vec3f(ae.POSITION),S5=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),kh=128,j0=-l_,W0=0,Ip=50,R5=()=>1-511/512,O5=Ld([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let E5=class{constructor(e,t){this.view=e,this.type=Vi.Mars,this._passParameters=new ap,this._vaoCount=0,this._texV1=1;const r=bt(e.spatialReference);this._planetRadius=r.radius,this._outerRimWidth=r.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+j0)/this._planetRadius,this._middleRimFactor=(this._planetRadius+W0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=W0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=t.techniqueRepository;const s=t.renderContext.rctx;this._cameraChangeHandle=A(()=>{var o;return(o=this.view.state)==null?void 0:o.camera},()=>t.requestRender(),vt),this._vao=this._createRibbon(s),this._vaoCount=Un(this._vao,"geometry"),this._fadeVao=un(s),this._fadeVaoCount=Un(this._fadeVao,"geometry");const n=new ui;n.wrapMode=Ji.CLAMP_TO_EDGE,n.flipped=!0,n.width=1,n.height=512,this._passParameters.texture=new Ci(s,n,S5);const a=new xg;a.geometry=hn.Cone,this._coneTechnique=this._techniqueRepository.acquire(Au,a),a.geometry=hn.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(Au,a)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=Ae(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const t=e.bindParameters.camera;this._update(t);const r=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(r.bindTechnique(this._coneTechnique,e.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(Ti.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(r.bindTechnique(this._undergroundTechnique,e.bindParameters,this._passParameters),r.bindVAO(this._fadeVao),r.drawArrays(Ti.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const t=v(),r=this._planetRadius,s=we(e.eye),n=s-r;if(n<0){const _=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=_}else this._passParameters.undergroundFadeAlpha=0;const a=Math.max(Ip,n),o=r+j0;this._passParameters.innerScale=A5(r+a,r,o)-1,this._passParameters.altitudeFade=_g(n),re(t,e.eye,(r+Ip)/s),Q0(t,e.center,e.up,r,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),c=R5(),d=O5(n);let u=this._texV0+c*this._texVScale,m=this._texV0+l*d*this._texVScale;if(n>Ip){Q0(e.eye,e.center,e.up,r,this._passParameters.silhouette);const _=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),f=ie((_-1.5)/(l-1.5),0,1);u=this._texV0+f*c*this._texVScale,m=this._texV0+He(this._texV1,l*d,f)*this._texVScale}sn(this._passParameters.texV,u,m)}_createRibbon(e){const t=rb(3+3*kh*3),r=new Uint32Array(3*kh*5);t[0]=0,t[1]=0,t[2]=-1;for(let a=0;a<kh;a++){const o=9*a+3;t[o]=a,t[o+1]=this._innerRimFactor,t[o+2]=-1,t[o+3]=a,t[o+4]=this._middleRimFactor,t[o+5]=0,t[o+6]=a,t[o+7]=this._outerRimFactor,t[o+8]=1;const l=3*a+1,c=a===kh-1?1:l+3,d=15*a;r[d]=l,r[d+1]=l+1,r[d+2]=c+1,r[d+3]=c+1,r[d+4]=c,r[d+5]=l,r[d+6]=l+1,r[d+7]=l+2,r[d+8]=c+2,r[d+9]=c+2,r[d+10]=c+1,r[d+11]=l+1,r[d+12]=l,r[d+13]=c,r[d+14]=0}const s=Z0.createBuffer(r.length),n=s.position;for(let a=0;a<r.length;++a){const o=3*r[a];n.set(a,0,t[o]),n.set(a,1,t[o+1]),n.set(a,2,t[o+2])}return new jn(e,Pt,{geometry:Aa(Z0)},{geometry:ur.createVertex(e,Nr.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(e,t,r,s){return fe(Vo,s.center,s.v2),re(jh,Vo,this._outerRimFactor),aC(Np,t,Vo,r),g0(Vo,Np,e.projectionMatrix,e.viewport,Vo),g0(jh,Np,e.projectionMatrix,e.viewport,jh),cr(Vo,jh)/e.height}};function Q0(i,e,t,r,s){const n=we(i),a=r*Math.sqrt(n*n-r*r)/n,o=Math.sqrt(r*r-a*a),l=s.v1,c=s.v2;return re(s.center,i,o/n),dt(l,i,e),xs(l)<1&&dt(l,i,t),re(l,l,a/we(l)),dt(c,l,i),re(c,c,a/we(c)),a}const Np=ct(),Vo=v(),jh=v();function A5(i,e,t){return i*i/(Math.sqrt(i*i-e*e)*Math.sqrt(i*i-t*t)+e*t)}const Z0=Ma().vec3f(ae.POSITION);var kn;(function(i){i[i.Rain=0]="Rain",i[i.Snow=1]="Snow",i[i.COUNT=2]="COUNT"})(kn||(kn={}));let d_=class extends Ls{constructor(){super(...arguments),this.type=kn.Rain}};h([$({count:kn.COUNT})],d_.prototype,"type",void 0);function px(i){const e=new Mt;return e.attributes.add(ae.POSITION,"vec3"),e.attributes.add(ae.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new Ai("cameraPosition",(t,r)=>r.camera.eye)),e.vertex.uniforms.add(new Ai("offset",(t,r)=>M5(t,r))),e.vertex.uniforms.add(new Ne("width",t=>t.width)),e.vertex.uniforms.add(new Ki("proj",(t,r)=>r.camera.projectionMatrix)),e.vertex.uniforms.add(new Ki("view",(t,r)=>r.camera.viewMatrix)),e.vertex.uniforms.add(new Ne("time",t=>t.time)),e.varyings.add("vUv","vec2"),e.vertex.code.add(g`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${i.type===kn.Rain?g`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:g`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),e.fragment.uniforms.add(new Ne("opacity",t=>t.opacity),new Ai("particleColor",(t,r)=>D5(r,i))),e.fragment.code.add(g`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${i.type===kn.Rain?g`d = 0.35 * smoothstep(0.5, 0.0, d);`:g`d = smoothstep(0.5, 0.1, d);`}
      fragColor = opacity * vec4(particleColor * d, d);
    }
  `),e}function M5(i,e){const t=e.camera.eye,r=.5*i.width,s=1/i.width,n=oC(u_,Ie(u_,(t[0]+r)*s,(t[1]+r)*s,(t[2]+r)*s));return zt(n,t,re(n,n,i.width))}function D5(i,e){const t=e.type===kn.Rain?L5:$5,r=re(u_,t,I5),s=i.camera.eye;oe(X0,s);const n=Math.max(0,pe(X0,i.lighting.mainLight.direction));return As(r,r,t,n)}const u_=v(),X0=v(),$5=It(1,1,1),L5=It(.85,.85,.85),I5=.7,N5=Object.freeze(Object.defineProperty({__proto__:null,build:px},Symbol.toStringTag,{value:"Module"}));let F5=class extends di{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}},p_=class mx extends Ft{initializeProgram(e){return new Dt(e.rctx,mx.shader.get().build(this.configuration),Vd)}initializePipeline(){return nt({blending:pr(Z.ONE,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),depthTest:{func:Hi.LEQUAL},colorWrite:lt})}};p_.shader=new Nt(N5,()=>he(()=>Promise.resolve().then(()=>H$),void 0));const Vd=new Map([[ae.POSITION,0],[ae.INSTANCEFEATUREATTRIBUTE,1]]);let Qa=class extends Pe{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new F5,this._animation=new yP,this._updatingTracking=new ip,this._passParameters.time=0,this._passParameters.radius=bt(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=tt(this._snowTechniqueCached),this._rainTechniqueCached=tt(this._rainTechniqueCached),this._vao=Ae(this._vao),this._instanceIdBuffer=Ae(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(this._rainTechniqueCached==null){const e=new d_;e.type=kn.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(p_,e)}return this._rainTechniqueCached}get _snowTechnique(){if(this._snowTechniqueCached==null){const e=new d_;e.type=kn.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(p_,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,r){const s=r==="rainy"?this._rainTechnique:this._snowTechnique;if(!s.compiled)return void this.context.requestRender();const n=e.rctx;if(this._ensureResources(n),s==null||this._vao==null||this._instanceIdBuffer==null||(e.bindParameters.cloudsFade.data!=null&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),this._passParameters.opacity<=0))return;const a=.35;t=t<.5?He(0,a,2*t):He(a,1,2*(t-.5)),this._passParameters.time=(r==="rainy"?this._rainSpeed:this._snowSpeed)*Rv(this._animation.time)%1e5;const o=n.bindTechnique(s,e.bindParameters,this._passParameters);n.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),KP(n,Vd,this._instanceIdBuffer,Y0,0),n.drawArraysInstanced(Ti.TRIANGLES,0,3,this._numParticles*t),JP(n,Vd,this._instanceIdBuffer,Y0)}_ensureResources(e){this._vao==null&&(this._vao=this._createVertexArrayObject(e)),this._instanceIdBuffer==null&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let r=0;r<this._numParticles;r++)t.push(r);return ur.createVertex(e,Nr.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new jn(e,Vd,{geometry:Aa(V5)},{geometry:ur.createVertex(e,Nr.STATIC_DRAW,t)})}};h([p({constructOnly:!0})],Qa.prototype,"context",void 0),h([p({constructOnly:!0})],Qa.prototype,"view",void 0),h([p({readOnly:!0})],Qa.prototype,"updating",null),h([p()],Qa.prototype,"_updatingTracking",void 0),Qa=h([F("esri.views.3d.environment.Precipitation")],Qa);const V5=Ma().vec3f(ae.POSITION),Y0=Aa(Ma().f32(ae.INSTANCEFEATUREATTRIBUTE),1);function _x(){const i=new Mt;return i.attributes.add(ae.POSITION,"vec3"),i.attributes.add(ae.COLOR,"vec4"),i.attributes.add(ae.SIZE,"float"),i.varyings.add("vcolor","vec4"),i.varyings.add("vsize","float"),i.vertex.uniforms.add(new Ki("transform",(e,t)=>U5(e,t)),new Vn("viewport",(e,t)=>t.camera.fullViewport),new Ne("pixelRatio",(e,t)=>t.camera.pixelRatio)),i.vertex.code.add(g`void main(void) {
gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),i.fragment.code.add(g`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);
}`),i}function U5(i,e){return Bl(Zn,e.camera.projectionMatrix),Zn[10]=24e-8-1,Zn[11]=-1,Zn[14]=(24e-8-2)*e.camera.near,Yr(Zn,Zn,e.camera.viewMatrix),Yr(Zn,Zn,i.modelMatrix)}const Zn=ct(),z5=Object.freeze(Object.defineProperty({__proto__:null,build:_x},Symbol.toStringTag,{value:"Module"}));let q5=class extends di{constructor(){super(...arguments),this.modelMatrix=ct()}},gx=class fx extends Ft{constructor(e){super(e,new Ls,()=>this.destroy())}initializeProgram(e){return new Dt(e.rctx,fx.shader.get().build(),Pt)}initializePipeline(){return nt({blending:pr(Z.SRC_ALPHA,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),depthTest:{func:Hi.LEQUAL},colorWrite:lt})}};gx.shader=new Nt(z5,()=>he(()=>Promise.resolve().then(()=>G$),void 0));let sa=class extends Pe{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return this._loadDataTask!=null&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._passParameters=new q5,this._updatingTracking=new ip}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=So(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=tt(this._technique),this._vao=Ae(this._vao),La=null}render(e){const{rctx:t}=e;if(this._ensureResources(t),this._technique==null||this._vao==null)return;if(!this._technique.compiled)return void this.requestRender();const r=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Ti.POINTS,0,this._numPoints)}_ensureResources(e){if(this._technique!=null||La==null)return;this._technique=new gx({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=La.byteLength/K0;const t=new Float32Array(La,0,2*this._numPoints),r=new Uint8Array(La,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,r,this._numPoints),this._updatingTracking.add(()=>this.view.environment.lighting.type!=="virtual"?this.view.environment.lighting.date:null,s=>this._update(s),oi)}_computeDayDuration(e){const t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(e),s=Bl(this._passParameters.modelMatrix,G5);Of(s,s,-r*Math.PI),Yr(s,H5,s),Of(s,s,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,r,s){const n=J0.createBuffer(s),a=n.position,o=n.color,l=n.size;for(let c=0;c<s;c++){const d=t[2*c],u=t[2*c+1];a.set(c,0,-Math.cos(d)*Math.sin(u)),a.set(c,1,-Math.sin(d)*Math.sin(u)),a.set(c,2,-Math.cos(u));const m=this._unpackUint8Attributes(r[c]),_=this._hexToRGB(B5[m[1]]);o.set(c,0,255*_[0]),o.set(c,1,255*_[1]),o.set(c,2,255*_[2]),o.set(c,3,255),l.set(c,m[0])}return new jn(e,Pt,{geometry:Aa(J0)},{geometry:ur.createVertex(e,Nr.STATIC_DRAW,n.buffer)})}_createLoadDataTask(){if(La!=null)return null;const e=Hu(async t=>{const{data:r}=await lC("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(r),La=r});return e.promise.catch(t=>{fo(t)||de.getLogger(this).error(t)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new Ir("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/K0;if(t%1!=0||t>5e4||t<5e3)throw new Ir("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};h([p({constructOnly:!0})],sa.prototype,"view",void 0),h([p({constructOnly:!0})],sa.prototype,"requestRender",void 0),h([p({readOnly:!0})],sa.prototype,"updating",null),h([p()],sa.prototype,"_loadDataTask",void 0),h([p()],sa.prototype,"_updatingTracking",void 0),sa=h([F("esri.views.3d.environment.Stars")],sa);const B5=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],H5=Sb(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),G5=Sb(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),K0=9,J0=Ma().vec3f(ae.POSITION).vec4u8(ae.COLOR).f32(ae.SIZE);let La=null;var El;(function(i){i[i.Immediate=0]="Immediate",i[i.Faded=1]="Faded"})(El||(El={}));var Sc;let Ri=Sc=class extends Eh{constructor(i){super(i),this.produces=new Map([[L.ENVIRONMENT_OPAQUE,()=>!(this._atmosphere===null&&this._stars===null)],[L.ENVIRONMENT_TRANSPARENT,()=>this._atmosphere!==null]]),this._context=null,this._atmosphere=null,this._oldWeatherParameters=new Fp,this._newWeatherParameters=new Fp,this._fadedWeatherParameters=new Fp,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){var i;this.removeHandles(),this.uninitializeRenderContext(),((i=this.view)==null?void 0:i._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return this._atmosphere}get _atmosphereType(){return this.atmosphere!=null?this.atmosphere.type:Vi.None}consumes(){return this._atmosphereType===Vi.Realistic?sb:nb}updateAnimation(i){return this._precipitation!=null&&this._precipitation.update(i)}get updating(){return this._stars!=null&&this._stars.updating||this._clouds!=null&&this._clouds.running}get weatherVisible(){return we(this.view.state.camera.eye)-bt(this.view.spatialReference).radius<=i_}get usedMemory(){var i;return((i=this._clouds)==null?void 0:i.usedMemory)??0}get _stars(){var r;const i=this.view,e=((r=i.environment)==null?void 0:r.starsEnabled)??!1,t=this._get("_stars");return e&&this._context!=null?t??new sa({view:i,requestRender:()=>this._setNeedsRender()}):(te(t),null)}get _precipitation(){const i=this._get("_precipitation");if(!this._precipitationEnabled||this._context==null)return te(i),null;const e=this.view,t=this._context;return i!=null&&i.context===t?i:(te(i),new Qa({context:t,view:e}))}get _clouds(){const i=this._get("_clouds");if(!this.weatherEnabled||this._context==null)return te(i),null;if(i!=null)return i;const e=this.view,t=this._context;return te(i),new tr({context:t,view:e,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const i=this._get("_cloudsComposition");if(!this.weatherEnabled||this._context==null)return te(i),null;const e=this.view.state.viewingMode,t=this._context.renderContext.rctx,r=bt(this.view.spatialReference).radius;return i!=null&&i.viewingMode===e&&i.planetRadius===r?i:(te(i),new ja({rctx:t,viewingMode:e,planetRadius:r,requestRender:()=>this._setNeedsRender()}))}get _fog(){const i=this._get("_fog");if(!this.weatherEnabled||this._context==null)return te(i),null;if(i!=null)return i;const e=this.view,t=this._context,r=this._context.renderContext.rctx,s=this.view.state.viewingMode;return new Wa({context:t,view:e,rctx:r,viewingMode:s})}get weatherEnabled(){var i,e;return!!((e=(i=this.view)==null?void 0:i.environmentManager)!=null&&e.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&(this.view.environment.weather.type==="rainy"||this.view.environment.weather.type==="snowy")}initializeRenderContext(i=null){this._context=i;const e=()=>this._setNeedsRender();this.addHandles([A(()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),t=>this._updateAtmosphere(t),vt),A(()=>this._stars,e),A(()=>this._precipitation,e),A(()=>this._clouds,()=>this._updateWeather(),oi),A(()=>this._fog,()=>this._updateFogHaze(),oi),A(()=>this.view.state.mode,()=>{this._setNeedsRender()},st),A(()=>this._weatherUpdateParameters,()=>{this._updateWeather(),this._updateFogHaze()},vt)])}uninitializeRenderContext(){this._context=null,this._atmosphere=te(this._atmosphere),this._set("_stars",te(this._stars)),this._set("_precipitation",te(this._precipitation)),this._set("_clouds",te(this._clouds)),this._set("_cloudsComposition",te(this._cloudsComposition)),this._set("_fog",te(this._fog))}prepareRender(i){var e;i.bindParameters.cloudsFade.data=AP(this._clouds)?this._clouds:null,this.view.viewingMode!=="local"&&((e=i.bindParameters.cloudsFade.data)==null?void 0:e.cubeMap)!=null&&(this._updateWeatherFading(i.bindParameters,i.time),i.bindParameters.cloudsFade.renderingStage===t_.FINISHED&&this._clouds!=null&&this._clouds.coverage===0&&this._clouds.running===!1&&(this._clouds.destroyFrameBufferCube(),i.bindParameters.cloudsFade.data=null))}renderNode(i){var e,t,r,s,n,a,o;switch(i.bindParameters.slot){case L.ENVIRONMENT_OPAQUE:this._stars!=null&&this._stars.render(i),this.atmosphere!=null&&(this.atmosphere.render(i,(r=(t=(e=this.view)==null?void 0:e._stage)==null?void 0:t.renderer)==null?void 0:r.fullResolutionAtmosphere),this._cloudsComposition!=null&&i.bindParameters.cloudsFade.data!=null&&(this.weatherVisible&&this._clouds!=null&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(i)),i.bindParameters.cloudsFade.isFading&&this._context!=null&&((s=i.bindParameters.cloudsFade.data)==null?void 0:s.cubeMap)!=null&&this._context.requestRender());break;case L.ENVIRONMENT_TRANSPARENT:if(this.atmosphere!=null&&(this.atmosphere.renderHaze(i,this._weatherParameters.hazeAmount,(o=(a=(n=this.view)==null?void 0:n._stage)==null?void 0:a.renderer)==null?void 0:o.fullResolutionAtmosphere),this._weatherParameters.fog.amount>0&&this._fog!=null&&this._fog.render(i,this._weatherParameters.fog),this._precipitation)){const l=this.view.environment.weather;l.type!=="rainy"&&l.type!=="snowy"||this._precipitation.render(i,l.precipitation,l.type)}}}updateLightSources(i,e,t,r){if(this._context!=null){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=e,s.bindParameters.newLighting.globalFactor=t,s.bindParameters.newLighting.set(i),r===El.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const i=this.weatherEnabled?this.view.environment.weather:null;return i==null?null:i.type==="rainy"||i.type==="snowy"?{type:i.type,weatherAdjustment:i.cloudCover,effect:i.precipitation}:{type:i.type,weatherAdjustment:i.type==="foggy"?i.fogStrength:i.cloudCover}}_updateWeatherFading(i,e){i.cloudsFade.updateFading(i.camera,this.view.state.mode,e,this.view.qualitySettings.fadeDuration),i.cloudsFade.updateParallax(i.camera),i.weatherFading&&(this._updateLighting(i),this._updateFogAtmoshpere(i))}_updateLighting(i){i.cloudsFade.fadeMode!==yc.CROSS_FADE&&i.cloudsFade.fadeMode!==yc.FADE_IN?i.fadeLighting(0):i.fadeLighting(i.cloudsFade.fadeFactor)}_updateFogAtmoshpere(i){i.cloudsFade.fadeMode!==yc.CROSS_FADE&&i.cloudsFade.fadeMode!==yc.FADE_IN?this._fadeWeather(0):this._fadeWeather(i.cloudsFade.fadeFactor)}_fadeWeather(i){const{_newWeatherParameters:e,_oldWeatherParameters:t}=this;i>=1?this._weatherParameters=e:(this._fadedWeatherParameters.lerp(t,e,i),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const i=this._weatherUpdateParameters;i!=null&&this._clouds!=null&&(this._clouds.applyPreset(Fi[i.type],i.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){this._context!=null&&this._context.requestRender()}_updateFogHaze(){const i=this._weatherUpdateParameters;if(this._fog==null||i==null||this._context==null)return;const e=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),i.type){case"foggy":this._newWeatherParameters.fog.strength=He(3e-5,.005,i.weatherAdjustment**3),le(this._newWeatherParameters.fog.color,e1),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=He(4e-6,2e-4,(i.effect??0)**3),le(this._newWeatherParameters.fog.color,k5),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=He(4e-6,2e-4,(i.effect??0)**3),le(this._newWeatherParameters.fog.color,e1),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}e.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(i){const e=this._selectAtmosphereType(i);if(e!==Vi.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==e){this._atmosphere=te(this._atmosphere);const t=this._getAtmosphereClass(e);t&&(this._atmosphere=new t(this.view,this._context))}}else this._atmosphere=te(this._atmosphere);this._setNeedsRender()}_getAtmosphereClass(i){switch(i){case Vi.Realistic:return z0;case Vi.Local:return T5;case Vi.Mars:return E5;default:case Vi.None:return null}}_selectAtmosphereType(i){const{enabled:e,viewingMode:t}=i;return!e||H_(this.view.spatialReference)?Vi.None:t===Re.Local?Vi.Local:this._context!=null&&z0.isSupported(this._context)&&Im(this.view.spatialReference)?Vi.Realistic:G_(this.view.spatialReference)?Vi.Mars:Vi.None}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),stubGetAtmosphereClass:i=>{t1=Sc.prototype._getAtmosphereClass,Sc.prototype._getAtmosphereClass=i},restoreGetAtmosphereClass:()=>{Sc.prototype._getAtmosphereClass=t1}}}};h([p({constructOnly:!0})],Ri.prototype,"view",void 0),h([p({readOnly:!0})],Ri.prototype,"atmosphere",null),h([p({readOnly:!0})],Ri.prototype,"_atmosphereType",null),h([p({type:Boolean,readOnly:!0})],Ri.prototype,"updating",null),h([p({readOnly:!0})],Ri.prototype,"weatherVisible",null),h([p()],Ri.prototype,"_context",void 0),h([p()],Ri.prototype,"_atmosphere",void 0),h([p({readOnly:!0})],Ri.prototype,"_stars",null),h([p({readOnly:!0})],Ri.prototype,"_precipitation",null),h([p({readOnly:!0})],Ri.prototype,"_clouds",null),h([p({readOnly:!0})],Ri.prototype,"_cloudsComposition",null),h([p({readOnly:!0})],Ri.prototype,"_fog",null),h([p({readOnly:!0})],Ri.prototype,"weatherEnabled",null),h([p({readOnly:!0})],Ri.prototype,"_precipitationEnabled",null),h([p({readOnly:!0})],Ri.prototype,"_weatherUpdateParameters",null),Ri=Sc=h([F("esri.views.3d.environment.EnvironmentRenderer")],Ri);let Fp=class{constructor(){this.fog=new x5,this.hazeAmount=1}copyFrom(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,le(this.fog.color,e.fog.color)}lerp(e,t,r){this.fog.amount=He(e.fog.amount,t.fog.amount,r),this.hazeAmount=He(e.hazeAmount,t.hazeAmount,r),this.fog.strength=He(e.fog.strength,t.fog.strength,r),As(this.fog.color,e.fog.color,t.fog.color,r)}};const k5=It(.5,.5,.5),e1=It(1.5,1.5,1.5);let t1,os=class extends es.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandlesKey="viewHandles",this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new Z3,this._ambientLight=new X3,this._moonLight=new Y3,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!((e=this._renderer)!=null&&e.updating))}get weatherEnabled(){var e,t,r;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((r=(t=this._view)==null?void 0:t.state)==null?void 0:r.viewingMode)===Re.Global&&Im(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new Ri({view:e});const t=()=>this._updateRenderParameters(),r=()=>this._cameraHandler();this.addHandles([A(()=>e.environment.lighting,s=>this._updateLightingHandler(s),st),A(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,s=>this._lightingDateHandler(s),st),A(()=>e.stationary,()=>this._interactingStationaryHandler()),A(()=>e.environment.lighting.directShadowsEnabled,t,st),A(()=>e.qualitySettings.ambientOcclusion,t,st),A(()=>e.qualitySettings.reflections,t,st),A(()=>e.spatialReference,()=>this._resetReferencePosition(!0),st),A(()=>e.environment.weather.type,()=>this._updateLighting(null,El.Faded),st),A(()=>this.weatherEnabled,()=>this._updateLighting(null,El.Faded),st),A(()=>e.viewingMode,()=>this._resetReferencePosition(!0),vt),A(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),vt),A(()=>e.state.camera,r,vt),A(()=>this.disableQueries,r)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=te(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const r=this._view.spatialReference;if(!hu(r)){const s=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(s))return void this._requestReferencePositionUpdate(s)}if(this._preupdateTracking(e),this._referencePosWGS84Comparable!=null){const s=f0(this._referencePosWGS84Comparable,i1);s!=null&&(t.autoUpdate(null,s),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const r=t.stateManager.camera;r&&(this._cameraHandlerClientSide(r,e)||this._cameraHandlerServerSide(r))}_cameraHandlerClientSide(e,t){const r=Im(this._view.spatialReference);if(r&&!hu(this._view.spatialReference))return this._view.environment.lighting.type==="virtual"&&this._updateLighting(),!1;const s=e.position;return this._referencePosWGS84Comparable==null&&(this._referencePosWGS84Comparable=v()),r?G3(s,this._referencePosWGS84Comparable):Ie(this._referencePosWGS84Comparable,s.longitude??0,s.latitude??0,s.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(t.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,t=El.Immediate){const r=this._view;e=e||(r.environment.lighting.type==="virtual"?null:r.environment.lighting.date);const s=this._referencePosWGS84Comparable,n=s?j5:W5,a=this.weatherVisible?r.environment.weather.type:"disabled";s!=null?aS(e,s,r.state.viewingMode,a,r.state.camera,n):r.environment.lighting.type==="virtual"&&oS(r.state.camera,r.state.viewingMode,n.direct.directionToLightSource);const o=this._mainLight,l=n.direct;re(o.intensity,l.color,l.intensity*Math.PI),le(o.direction,l.directionToLightSource),o.specularStrength=n.specularStrength,o.environmentStrength=n.environmentStrength;const c=this._ambientLight;re(c.intensity,n.ambient.color,n.ambient.intensity);const d=this._moonLight;As(d.intensity,Z5,X5,n.globalFactor);const u=(1-.5*n.globalFactor)*(1-.4*n.noonFactor*(1-n.globalFactor));re(d.intensity,d.intensity,u),le(d.direction,l.directionToLightSource),this._renderer.updateLightSources([o,c,d],n.noonFactor,n.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;const r=Q5;r.setTime((t||this._view.environment.lighting.date).getTime());const s=f0(e,i1);if(s==null)return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===s.hours&&n.minutes===s.minutes&&n.seconds===s.seconds)return!1}else n=s;const a=r.getUTCHours()-(s.hours-n.hours),o=r.getUTCMinutes()-(s.minutes-n.minutes),l=r.getUTCSeconds()-(s.seconds-n.seconds);return r.setUTCHours(a),r.setUTCMinutes(o),r.setUTCSeconds(l),!t&&this._view.environment.lighting.autoUpdate(r,s)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=this._referencePosWGS84Comparable==null||lS(this._referencePosWGS84Comparable[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const r=this._referencePosUpdateQuery=Ef(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===r){const n=()=>this._referencePosUpdateQuery!==r;return this._doReferencePositionUpdateQuery(n)}}).catch(n=>{n.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===r&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),s=this._referencePosUpdateTimer=Ef(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===s&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const r=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=r):this._referencePosWGS84Comparable=[t[0],t[1],r],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};h([p({type:Boolean,readOnly:!0})],os.prototype,"updating",null),h([p()],os.prototype,"disableQueries",void 0),h([p()],os.prototype,"_disableWeather",void 0),h([p()],os.prototype,"weatherEnabled",null),h([p()],os.prototype,"weatherVisible",null),h([p()],os.prototype,"referencePositionWGS84Comparable",null),h([p()],os.prototype,"_renderer",void 0),h([p()],os.prototype,"_referencePosWGS84Comparable",void 0),os=h([F("esri.views.3d.environment.SceneViewEnvironmentManager")],os);const j5=new Ob,W5=new Ob,Q5=new Date,i1={hours:0,minutes:0,seconds:0},Z5=It(.22,.22,.33),X5=It(.22,.22,.22);var ht;(function(i){i[i.NONE=0]="NONE",i[i.TILT=1]="TILT",i[i.ALTITUDE=2]="ALTITUDE",i[i.DISTANCE=4]="DISTANCE",i[i.COLLISION=8]="COLLISION",i[i.ALL=15]="ALL",i[i.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(ht||(ht={}));var Oe;(function(i){i[i.NONE=0]="NONE",i[i.ZOOM=1]="ZOOM",i[i.TUMBLE=2]="TUMBLE",i[i.LOOK_AROUND=3]="LOOK_AROUND",i[i.PAN=4]="PAN",i[i.ASCEND=5]="ASCEND"})(Oe||(Oe={}));var dn;(function(i){i[i.TUMBLE=0]="TUMBLE",i[i.LOOK_AROUND=1]="LOOK_AROUND"})(dn||(dn={}));let ts=class{constructor(e=ht.ALL,t=Oe.NONE,r=0,s=null,n=null,a=dn.TUMBLE){this.selection=e,this.interactionType=t,this.interactionFactor=r,this.interactionStartCamera=s,this.interactionDirection=n,this.tiltMode=a}};function gh(i,e){return(i&e)!=0}function Mu(i,e,t,r,s,n){i!==0&&(t?(n.min=Math.min(n.min,e),n.max=Math.max(n.max,e)):r!=null?(n.min-=Math.max(0,(e-n.min)*(1-r)),n.max+=Math.max(0,(e-n.max)*(1-r))):s&&(n.min-=Math.max(0,e-n.min-s),n.max+=Math.max(0,e-n.max-s)))}const Oo=new ts(ht.NONE);function yx(i,e,t,r){return e=e||i.viewForward,le(r,e),re(r,r,Math.sign(pe(e,t))),r}function Y5(i,e,t=Oo){const r=Cg(i,e,t);if(r===0)return!1;const s=i.renderCoordsHelper,n=s.getAltitude(e.eye)+r,a=yx(e,t.interactionDirection,eO(i,e,Math.sign(r),sO),rO),o=le(nO,e.viewForward),l=s.intersectInfiniteManifold(wo(e.eye,a),n,Vp);return e.eye=l??s.setAltitude(Vp,n,e.eye),e.center=yT(Vp,e.eye,o,e.center),!0}function Cg(i,e,t=Oo){if(!K5(i,t)||!i.state.constraints.altitude)return 0;const r=tO(i.state.constraints.altitude,iO);J5(i,t,r);const s=i.renderCoordsHelper.getAltitude(e.eye),n=ie(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}function K5(i,e){const t=i.state.constraints.altitude;return!(!i.state.isGlobal||!t)&&(e.interactionType!==Oe.TUMBLE||!gh(e.selection,ht.TILT))}function J5(i,e,t){const r=e.interactionType;if(r===Oe.NONE)return;const{min:s,max:n}=t,{interactionStartCamera:a,interactionFactor:o}=e;if(!a)return;const l=r===Oe.TUMBLE||r===Oe.ZOOM,c=Cg(i,a),d=c===0?0:i.renderCoordsHelper.getAltitude(a.eye);t.min=s,t.max=n,Mu(c,d,l,o,.05*d,t)}function eO(i,e,t,r){return i.renderCoordsHelper.worldUpAtPosition(e.eye,r),re(r,r,t),r}function tO(i,e){return e.min=i.min,e.max=i.max,e}const iO={min:0,max:0},rO=v(),sO=v(),nO=v(),Vp=v();function Tg(i,e,t=Oo){if(!i.state.isLocal)return 0;const r=i.state.constraints.distance;if(!i.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;Wh.min=0,Wh.max=r,oO(i,t,Wh);const s=Pg(i,e),n=Wh.max-s;return n>=-1e-6?0:n}function aO(i,e,t=Oo){const r=Tg(i,e,t);if(r===0)return!1;const s=i.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=Pg(i,e)+r,a=le(cO,e.eye),o=yx(e,t.interactionDirection,lO(e,s.renderLocation,uO),dO);if(!rp(hS(s.renderLocation,n),wo(e.eye,o),Qh))return!1;e.eye=Qh;const l=ve(hO,e.eye,a);e.center=fe(Qh,e.center,l);const c=i.renderCoordsHelper.getAltitude(e.center),d=i.renderCoordsHelper.intersectInfiniteManifold(e.ray,c,Qh);return d!=null&&(e.center=d),!0}function oO(i,e,t){const r=e.interactionType;if(r===Oe.NONE)return;const{min:s,max:n}=t,{interactionStartCamera:a,interactionFactor:o}=e;if(!a)return;const l=r===Oe.ZOOM||r===Oe.PAN,c=Tg(i,a),d=c===0?0:Pg(i,a);t.min=s,t.max=n,Mu(c,d,l,o,.05*d,t)}function Pg(i,e){const t=i.pointsOfInterest.surfaceOrigin;return t.renderLocation?cr(e.eye,t.renderLocation):0}function lO(i,e,t){return Wu(t,i.eye,e)}const Wh={min:0,max:0},cO=v(),hO=v(),dO=v(),uO=v(),Qh=v();function Ql(i,e,t=Xr.EYE){const r=i.state.constraints;if(!r.collision.enabled)return!1;const s=Y_(i,e.eye),n=i.renderCoordsHelper.getAltitude(e.eye),a=s+r.collision.elevationMargin;if(n>=a)return!1;const o=we(e.eye);if(ve(Zh,e.center,e.eye),e.eye=i.renderCoordsHelper.setAltitude(pO,a,e.eye),t===Xr.EYE_AND_CENTER)e.center=fe(Zh,e.eye,Zh);else if(t===Xr.EYE_AND_CENTER_SCALE){const l=(o-n+a)/o;e.center=re(Zh,e.center,l)}return!0}var Xr;(function(i){i[i.EYE=0]="EYE",i[i.EYE_AND_CENTER=1]="EYE_AND_CENTER",i[i.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(Xr||(Xr={}));const Zh=v(),pO=v();function Ra(i,e,t){i.worldUpAtPosition(e,r1),ve(Up,t,e);const r=we(Up);return r===0?0:on(pe(Up,r1)/r)}const r1=v(),Up=v();function vx(i,e,t,r=!0){nc.eyeCenterDistance=0,nc.requiresTwoSteps=!1;const s=Sg(i,e,t,Oo,nc);if(s===0)return!1;switch(yo(Xh,-s,e.viewRight),t.tiltMode){case dn.LOOK_AROUND:Xt(Xn,e.viewForward,Xh),re(Xn,Xn,nc.eyeCenterDistance),e.center=fe(la,e.eye,Xn);break;case dn.TUMBLE:ve(Xn,e.center,e.eye),Xt(Xn,Xn,Xh),e.eye=ve(la,e.center,Xn);break;default:ba(t.tiltMode)}return e.up=Xt(la,e.up,Xh),!nc.requiresTwoSteps||!r||vx(i,e,t,!1)}function Sg(i,e,t,r=Oo,s){if(!i.state.constraints.tilt)return 0;const n=e.distance,a=i.state.constraints.tilt(n,CO);return wO(i,t,a),r.interactionType===Oe.TUMBLE&&gh(r.selection,ht.ALTITUDE)&&bx(i,r.interactionStartCamera,a),t.tiltMode===dn.LOOK_AROUND||r.tiltMode===dn.LOOK_AROUND?_O(i,e,a,s):mO(i,e,a)}function mO(i,e,t){const r=Ra(i.renderCoordsHelper,e.center,e.eye),s=r-ie(r,t.min,t.max);return fh(s)?s:0}function _O(i,e,t,r){switch(r&&(r.requiresTwoSteps=!1),i.viewingMode){case"global":return fO(i,e,t,r);case"local":return gO(i,e,t,r)}}function gO(i,e,t,r){const s=Ra(i.renderCoordsHelper,e.center,e.eye),n=ie(s,t.min,t.max),a=s-n;if(!fh(a))return 0;if(r){const o=i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=i.renderCoordsHelper.getAltitude(e.eye)-o,c=Math.cos(n);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=e.distance}return a}function fO(i,e,t,r){const s=yO(i,e,TO),n=ie(s.tiltAtCenter,t.min,t.max);if(!fh(s.tiltAtCenter-n))return 0;let a,o;return s.centerIsOnSurface?(a=vO(s),o=bO(s,a)):(a=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&a<Math.PI/2&&(r.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=xO(s,a)),r&&(r.eyeCenterDistance=m_(s,a)),o}function yO(i,e,t){const r=i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+bt(i.spatialReference).radius,n=i.renderCoordsHelper.intersectManifold(e.ray,r,la);return t.eyeCenterDistance=e.distance,t.centerIsOnSurface=!1,n!=null?(t.eyeCenterDistance=cr(e.eye,n),t.tiltAtCenter=Ra(i.renderCoordsHelper,n,e.eye),t.centerIsOnSurface=!0):i.state.isLocal?t.tiltAtCenter=Ra(i.renderCoordsHelper,e.center,e.eye):(sp(lg(cg,s),e.ray,la),t.eyeCenterDistance=cr(e.eye,la),t.tiltAtCenter=on(-pe(e.viewForward,oe(la,la)))),t.radius=s,t.eyeRadius=we(e.eye),t.constraints=i.state.constraints,t}function fh(i){return Math.abs(i)>1e-9}function vO(i){const{constraints:e,eyeCenterDistance:t,tiltAtCenter:r}=i;let s=r,n=e.clampTilt(t,r);const a=m_(i,n);if(e.clampTilt(a,r)===n)return n;let o=0;for(;o<10&&fh(n-s);){const l=(s+n)/2,c=m_(i,l);fh(e.clampTilt(c,l)-l)?s=l:n=l,o++}return n}function m_(i,e){if(!i.centerIsOnSurface)return i.eyeCenterDistance;const t=Math.PI-ie(e,0,Math.PI),r=rh(i.radius/i.eyeRadius*Math.sin(t)),s=Math.PI-t-r,n=Math.sin(s)/Math.sin(t);if(i.eyeRadius<i.radius&&n>1){const a=Math.PI-r,o=Math.PI-t-a;return Math.sin(o)/Math.sin(t)*i.eyeRadius}return n*i.eyeRadius}function bO(i,e){const t=rh(i.radius/i.eyeRadius*Math.sin(i.tiltAtCenter)),r=rh(i.radius/i.eyeRadius*Math.sin(e));return i.eyeRadius>i.radius?t-r:r-t}function xO(i,e){return i.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function wO(i,e,t){if(e.interactionType===Oe.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=e;if(!r)return;const{min:n,max:a}=t,o=Sg(i,r,Oo,e),l=o===0?0:Ra(i.renderCoordsHelper,r.center,r.eye);t.min=n,t.max=a,e.interactionType===Oe.TUMBLE?(gh(e.selection,ht.ALTITUDE)&&bx(i,r,t),Mu(o,l,!0,s,s1,t)):Mu(o,l,!1,s,s1,t)}function bx(i,e,t){const r=i.state.constraints;if(i.state.isLocal||!r.altitude||!e)return;const s=xs(e.center),n=Math.sqrt(s),a=e.distance,o=bt(i.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,d=(l*l-a*a-s)/(-2*n*a),u=(c*c-a*a-s)/(-2*n*a);t.min=Math.max(t.min,Math.min(Math.PI-on(u),t.max)),t.max=Math.min(t.max,Math.PI-on(d))}const Xn=v(),Xh=ct(),la=v(),s1=Wt(5),CO={min:0,max:0},TO={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},nc={eyeCenterDistance:0,requiresTwoSteps:!1},PO=i=>i,op=i=>i*i,Rg=i=>1-op(1-i),SO=i=>i<.5?op(2*i)/2:(Rg(2*(i-.5))+1)/2,Og=i=>i*i*i,xx=i=>1-Og(1-i),wx=i=>i<.5?Og(2*i)/2:(xx(2*(i-.5))+1)/2,Eg=i=>i*i*i*i,Cx=i=>1-Eg(1-i),RO=i=>i<.5?Eg(2*i)/2:(Cx(2*(i-.5))+1)/2,Ag=i=>i*i*i*i*i,Tx=i=>1-Ag(1-i),OO=i=>i<.5?Ag(2*i)/2:(Tx(2*(i-.5))+1)/2,Mg=i=>1-Math.cos(i*Math.PI/2),Px=i=>1-Mg(1-i),EO=i=>i<.5?Mg(2*i)/2:(Px(2*(i-.5))+1)/2,Dg=i=>2**(10*(i-1)),$h=i=>1-Dg(1-i),AO=i=>i<.5?Dg(2*i)/2:($h(2*(i-.5))+1)/2,$g=i=>-(Math.sqrt(1-i*i)-1),Sx=i=>1-$g(1-i),MO=i=>i<.5?$g(2*i)/2:(Sx(2*(i-.5))+1)/2;function is(i){const e=2*(i-Math.sqrt((i-1)*i)),t=e/2/i;return r=>r<t?i*r*r:e*r-e+1}function rs(i,e){return(t,r)=>t<e?e*i(t/e,r):1-i((1-t)/(1-e),r)*(1-e)}const DO=rs(is(1),1),$O=rs(is(1),0),Rx=rs(is(1),.5),LO=rs(is(2),1),IO=rs(is(2),0),NO=rs(is(2),.5),FO=rs(is(3),1),VO=rs(is(3),0),UO=rs(is(3),.5),zO=rs(is(4),1),qO=rs(is(4),0),BO=rs(is(4),.5),HO={linear:PO,"in-quad":op,"out-quad":Rg,"in-out-quad":SO,"in-coast-quad":DO,"out-coast-quad":$O,"in-out-coast-quad":Rx,"in-cubic":Og,"out-cubic":xx,"in-out-cubic":wx,"in-coast-cubic":LO,"out-coast-cubic":IO,"in-out-coast-cubic":NO,"in-quart":Eg,"out-quart":Cx,"in-out-quart":RO,"in-coast-quart":FO,"out-coast-quart":VO,"in-out-coast-quart":UO,"in-quint":Ag,"out-quint":Tx,"in-out-quint":OO,"in-coast-quint":zO,"out-coast-quint":qO,"in-out-coast-quint":BO,"in-sine":Mg,"out-sine":Px,"in-out-sine":EO,"in-expo":Dg,"out-expo":$h,"in-out-expo":AO,"in-circ":$g,"out-circ":Sx,"in-out-circ":MO};function Ut(i,e,t=WO,r=e){r!==e&&r.copyFrom(e),r.computeUp(i.state.viewingMode);let s=!1;for(let o=0;o<QO;o++){let l=0;for(const c of jO)if(gh(t.selection,c.type)){const d=Math.abs(c.error(i,r,t));c.apply(i,r,t)&&(s=!0,l+=d)}if(l===0)break}const n=gh(t.selection,ht.COLLISION),a=GO(t.interactionType,i);return n&&Ql(i,r,a)&&(s=!0),s&&r.computeUp(i.state.viewingMode),s}function GO(i,e){switch(i){case Oe.PAN:return Xr.EYE_AND_CENTER;case Oe.ASCEND:return e.state.isGlobal?Xr.EYE_AND_CENTER_SCALE:Xr.EYE_AND_CENTER;default:return Xr.EYE}}function bs(i){const e=Math.min(1,i/150);return wx(e)}function kO(i,e,t){return Sg(i,e,t)*e.distance}const jO=[{type:ht.TILT,error:kO,apply:vx},{type:ht.ALTITUDE,error:Cg,apply:Y5},{type:ht.DISTANCE,error:Tg,apply:aO}],WO=new ts,QO=5;let n1=class{constructor(e){this.viewingMode=e,this.center=v(),this.pitch=0,this.yaw=0,this.distance=0,this.direction=Hn(a1),this.fov=55,this.size=1}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Re.Global){const n=(we(this.center)+we(e.center))/2;t.pan=Wm(this.center,e.center)*n}else t.pan=cr(this.center,e.center);let r=Math.abs(e.yaw-this.yaw);r>=Math.PI&&(r=2*Math.PI-r);const s=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(r,s),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,r){this.viewingMode===Re.Global?B3(e.center,t.center,r.pan,this.center):As(this.center,e.center,t.center,r.pan),this.distance=isFinite(t.distance)?He(e.distance,t.distance,r.zoom):e.distance,this.pitch=He(e.pitch,t.pitch,r.rotate);let s=e.yaw;const n=t.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=He(s,n,r.rotate)}copyFrom(e){le(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,le(this.direction,e.direction),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,o1);le(this.center,e.center),ve(Si,e.center,e.eye),Qs(Si,Si,t),Qs(Kn,e.up,t),this.distance=we(Si),this.distance!==0&&(Si[0]/=this.distance,Si[1]/=this.distance,Si[2]/=this.distance),this.pitch=this._eyeUpToPitch(Si),this.yaw=ZO(Si,Kn),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,o1);kl(t,t),this._axisAngleVec3(Ud,this.pitch-Math.PI/2,a1,Si),this._axisAngleVec3(so,this.yaw,Si,Si),this._axisAngleVec3(Ud,this.pitch-Math.PI/2,so,Kn),this._axisAngleVec3(so,this.yaw,Kn,Kn),re(Si,Si,this.distance),Qs(Si,Si,t),Qs(Kn,Kn,t),e.center=this.center,e.eye=ve(Si,this.center,Si),e.up=Kn}_axisAngleVec3(e,t,r,s){const n=Math.cos(t),a=Math.sin(t);return re(Sr,r,n),dt(xr,e,r),re(xr,xr,a),re(Yn,e,(1-n)*pe(e,r)),fe(s,fe(s,Sr,xr),Yn)}_lookAtOrientation(e,t=$s()){return this._upAtLookAt(e,Yn),dt(Sr,this.direction,Yn),oe(Sr,Sr),Sr[0]===0&&Sr[1]===0&&Sr[2]===0&&le(Sr,Ud),dt(xr,Yn,Sr),oe(xr,xr),t[0]=Sr[0],t[1]=xr[0],t[2]=Yn[0],t[3]=Sr[1],t[4]=xr[1],t[5]=Yn[1],t[6]=Sr[2],t[7]=xr[2],t[8]=Yn[2],t}_upAtLookAt(e,t){return this.viewingMode===Re.Local?le(t,so):oe(t,e)}_eyeUpToPitch(e){return Math.PI-Wm(so,e)}};function ZO(i,e){const t=XO;return Math.abs(e[2])<.5?(le(t,e),i[2]>0&&re(t,t,-1)):le(t,i),dt(xr,t,so),oe(xr,xr),Wm(Ud,xr,so)}const Sr=v(),xr=v(),Yn=v(),Si=v(),Kn=v(),XO=v(),so=cC,a1=hC,Ud=dC,o1=$s(),Du={desiredScreenFlow:2,minDuration:Ye(500),maxDuration:Ye(8e3)};let YO=class Ox{constructor(e){this._createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:Du.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new Ox(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,r){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow!=null?r.desiredScreenFlow:Du.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}},KO=class{constructor(){this.segments=[]}get time(){return this.segments.reduce((e,t)=>gs(e+t.time),gs(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let r=0,s=0;const n=this.definition;for(let a=0;a<this.segments.length;a++){const o=this.segments[a],l=o.definition;if(e<=o.time||a===this.segments.length-1){if(t=this.segmentInterpolateComponentsAt(o,o.time===0?0:e/o.time,t),n.hasPan&&!isNaN(t.pan)&&isFinite(n.compared.pan)?t.pan=(r+l.compared.pan*t.pan)/n.compared.pan:t.pan=1,n.hasRotate&&!isNaN(t.rotate)&&isFinite(n.compared.rotate)?t.rotate=(s+l.compared.rotate*t.rotate)/n.compared.rotate:t.rotate=1,n.hasZoom&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){const c=t.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,d=this.segments[0].definition.compared.sourceZoom,u=this.segments[this.segments.length-1].definition.compared.targetZoom;t.zoom=(c-d)/(u-d)}else t.zoom=1;return t}e-=o.time,r+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,r){return e.interpolateComponentsAt(t,r)}},zp=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,r=t.sourceZoom,s=t.targetZoom;this._zoomSign=r>s?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(r);const n=(e.source.pixelsPerRotateAtZoom(r)+e.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=t.rotate*n}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:r,hasPan:s,hasRotate:n}=this.definition;let a=0,o=0;r&&(s&&(a=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(o=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(r&&s&&n){const c=a+o+a*o;this._zoomPixelFlow=a*o/c*l,this._panPixelFlow=o/c*l,this._rotatePixelFlow=a/c*l}else if(r&&s){const c=1+a;this._zoomPixelFlow=a/c*l,this._panPixelFlow=1/c*l}else if(r&&n){const c=1+o;this._zoomPixelFlow=o/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,d=1+c;this._panPixelFlow=c/d*l,this._rotatePixelFlow=1/d*l}else s?this._panPixelFlow=l:r?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:r?this.zoomTime:s?this.panTime:gs(0)}get rotateTime(){return this.definition.hasRotate?gs(this._rotatePixels/this._rotatePixelFlow):gs(0)}get zoomTime(){return this.definition.hasZoom?gs(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):gs(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return gs(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return gs(this._panPixelsAtSource/this._panPixelFlow)}return gs(0)}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(t*(t/r)**-e-t)/(r-t)}return e}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const r=this._interpolateComponentsZoom(e),s=this._interpolateComponentsPan(e),n=this._interpolateComponentsRotate(e);return t?(t.zoom=r,t.pan=s,t.rotate=n):t={zoom:r,pan:s,rotate:n},t}};function JO(i,e,t){const r=e-i.compared.sourceZoom,s=i.halfWindowPanAtZoom(r);return-i.halfWindowSize*(t.ascensionFactor*Math.LN2*i.compared.pan+s)*Math.log(i.compared.sourceZoom/e)/(i.desiredPixelFlow*Math.LN2*s)}function e4(i,e,t){const r=1/e,s=Math.log(i.compared.sourceZoom*r),n=1/i.desiredPixelFlow,a=1/Math.LN2,o=e-i.compared.sourceZoom,l=1/o,c=(t.ascensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(o))/i.halfWindowPanAtZoom(1);return i.halfWindowSize*r*n*a*l*c-i.halfWindowSize*s*n*a*l+i.halfWindowSize*s*n*a*c/(o*o)}function t4(i,e,t){const r=e-i.compared.sourceZoom,s=1/r,n=1/e,a=Math.log(i.compared.sourceZoom*n),o=(t.ascensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(r))/i.halfWindowPanAtZoom(1);return i.halfWindowSize*s*(-2*s*n*o+2*s*a+2*n-2*a*o/(r*r)-o/(e*e))/(i.desiredPixelFlow*Math.LN2)}function i4(i,e){return-i.halfWindowSize*Math.log(i.compared.sourceZoom/e)/(i.desiredPixelFlow*Math.LN2)}function r4(i,e){return i.halfWindowSize/(e*i.desiredPixelFlow*Math.LN2)}function s4(i,e){return-i.halfWindowSize/(e*e*i.desiredPixelFlow*Math.LN2)}function n4(i,e,t){return-i.compared.pan*i.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(i.desiredPixelFlow*i.halfWindowPanAtZoom(e))}function a4(i,e,t){return i.compared.pan*i.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(i.desiredPixelFlow*i.halfWindowPanAtZoom(e*e))}function o4(i,e,t){return-2*i.compared.pan*i.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(i.desiredPixelFlow*i.halfWindowPanAtZoom(e*e*e))}function l4(i,e,t){return i.halfWindowSize*(-i.halfWindowPanAtZoom(e)-t.descensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(i.compared.targetZoom))*Math.log(e/i.compared.targetZoom)/(i.desiredPixelFlow*Math.LN2*i.halfWindowPanAtZoom(-e+i.compared.targetZoom))}function c4(i,e,t){const r=Math.log(e/i.compared.targetZoom),s=1/i.desiredPixelFlow,n=1/Math.LN2,a=-e+i.compared.targetZoom,o=1/a,l=(-i.halfWindowPanAtZoom(e)-t.descensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(i.compared.targetZoom))/i.halfWindowPanAtZoom(1);return-i.halfWindowSize*r*s*n*o+i.halfWindowSize*r*s*n*l/(a*a)+i.halfWindowSize*s*n*o*l/e}function h4(i,e,t){const r=e-i.compared.targetZoom,s=1/r,n=1/e,a=Math.log(e/i.compared.targetZoom),o=(i.halfWindowPanAtZoom(e)+t.descensionFactor*Math.LN2*i.compared.pan-i.halfWindowPanAtZoom(i.compared.targetZoom))/i.halfWindowPanAtZoom(1);return i.halfWindowSize*s*(-2*s*n*o-2*s*a+2*n+2*a*o/(r*r)-o/(e*e))/(i.desiredPixelFlow*Math.LN2)}function d4(i,e){return i.halfWindowSize*Math.log(e/i.compared.targetZoom)/(i.desiredPixelFlow*Math.LN2)}function u4(i,e){return i.halfWindowSize/(e*i.desiredPixelFlow*Math.LN2)}function p4(i,e){return-i.halfWindowSize/(e*e*i.desiredPixelFlow*Math.LN2)}function m4(i){const e=Math.LN2*i.compared.pan,t=i.compared.sourceZoom-i.compared.targetZoom,r=i.halfWindowPanAtZoom(t),s=i.halfWindowSize*Math.log(i.compared.sourceZoom/i.compared.targetZoom)/(i.desiredPixelFlow*Math.LN2*r);return i.compared.sourceZoom<=i.compared.targetZoom?s*(e-r):s*(e+r)}function _4(i,e){let t=g4(i,e);const r={ascensionFactor:e.ascensionFactor!=null?e.ascensionFactor:.5,descensionFactor:e.descensionFactor!=null?e.descensionFactor:.5},s=r.ascensionFactor===0,n=r.descensionFactor===0,a=s?i4:JO,o=s?r4:e4,l=s?s4:t4,c=n?d4:l4,d=n?u4:c4,u=n?p4:h4,m=T=>a(i,T,r)+n4(i,T,r)+c(i,T,r),_=T=>o(i,T,r)+a4(i,T,r)+d(i,T,r),f=T=>l(i,T,r)+o4(i,T,r)+u(i,T,r);let y=m(t);const b=m4(i);let x;const w=e.maximumIterations||20,C=e.maximumDistance!=null?e.maximumDistance:1/0;for(x=0;x<w;x++){const P=(_(t)+1e-6)/f(t);if(isNaN(P)||t>=C&&P<0){if(!isFinite(C))return null;t=C,y=m(t);break}if(t-=P,t<i.compared.sourceZoom||t<i.compared.targetZoom)return null;const S=m(t);if(Math.abs(S-y)/y<=.005)break;y=S}return y>b*(1-.3)||t<i.compared.sourceZoom||t<i.compared.targetZoom?null:t}function g4(i,e){const t=Math.max(i.compared.sourceZoom,i.compared.targetZoom),r=i.source.zoomAtPixelsPerPan(i.desiredPixelFlow/i.compared.pan)/2;return r<t?e.maximumDistance!=null?t+(e.maximumDistance-t)/2:1.5*t:e.maximumDistance?Math.min(e.maximumDistance,r):r}let f4=class extends KO{constructor(e,t){super(),this._preallocSegments=[new zp,new zp,new zp],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let r=null;t!=null&&t.apex&&(r=_4(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r==null?this._updateWithoutApex():this._updateWithApex(r,t==null?void 0:t.apex)}segmentInterpolateComponentsAt(e,t,r){return r=e.interpolateComponentsAt(t,r),e===this._ascensionSegment?r.zoom=Rg(r.zoom):e===this._descensionSegment&&(r.zoom=op(r.zoom)),r}_updateWithApex(e,t){const[r,s,n]=this._preallocSegments,a=(t==null?void 0:t.ascensionFactor)??.5,o=Math.min(1-a,(t==null?void 0:t.ascensionFactor)!=null&&t.descensionFactor!=null?t.descensionFactor:.5),l=1-a-o;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*a,r.definition.compared.rotate=this.definition.compared.rotate*a,r.update(),this._ascensionSegment=r,this.segments.push(r),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=e,s.definition.compared.targetZoom=e,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=e,n.definition.compared.pan=this.definition.compared.pan*o,n.definition.compared.rotate=this.definition.compared.rotate*o,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}};const y4={zoom:0,pan:0,rotate:0};let v4=class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=Ye(0),this.definition=new YO(e),this.path=new f4}update(e,t,r){this.definition.update(e,t,r),this.path.update(this.definition,r),this._time=this._applyTimeSettings(Ov(isFinite(this.path.time)?this.path.time:gs(0)),r),this._easing=r.easing??(this._time>=1e3?Rx:$h)}cameraAt(e,t){t=t||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const r=this.path.interpolateComponentsAt(e,y4);return t.interpolate(this.definition.source,this.definition.target,r),t}_normalizedEasing(e){const t=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(r-t)}_applyTimeSettings(e,t){const r=t.speedFactor!=null?t.speedFactor:1;t.duration!=null?e=t.duration:t.speedFactor!=null&&(e=Ye(e/r));const s=t.minDuration!=null?t.minDuration:Du.minDuration/r,n=t.maxDuration!=null?t.maxDuration:Du.maxDuration/r;return Ye(Math.min(Math.max(s,e),n))}},b4=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=Ye(0),this._animation=new v4(()=>new n1(e)),this._current=new n1(e)}update(e,t,r){const{source:s,target:n}=this._animation.definition,a=ve(x4,t.center,e.center),o=we(a);o>=1e-5?(a[0]/=o,a[1]/=o,a[2]/=o):(a[0]=0,a[1]=1,a[0]=0),le(s.direction,a),le(n.direction,a),s.copyFromRenderCamera(e),n.copyFromRenderCamera(t),this._current.copyFrom(s),this._animation.update(s,n,r),this.currentTime=Ye(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Ct,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=Ye(this.currentTime+Ov(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}};const x4=v();var yt;(function(i){i[i.Ready=0]="Ready",i[i.Rejected=1]="Rejected",i[i.Running=2]="Running",i[i.Stopped=3]="Stopped",i[i.Finished=4]="Finished"})(yt||(yt={}));let En=class extends Pe{constructor(e){super(e),this.state=yt.Ready}get active(){return this.state===yt.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=yt.Stopped,!0)}finishController(){this.state=yt.Finished}get steppingFinished(){return!1}};h([p({constructOnly:!0})],En.prototype,"view",void 0),h([p({readOnly:!0})],En.prototype,"active",null),h([p()],En.prototype,"state",void 0),h([p({readOnly:!0})],En.prototype,"isInteractive",null),En=h([F("esri.views.3d.state.controllers.CameraController")],En);let yh=class extends En{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(Ts()),this._asyncResult=null),this.state===yt.Finished||this.state===yt.Stopped?(uC(e),this.state===yt.Finished?e.resolve():e.reject(Ts())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=yt.Running,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){this.viewAnimation==null||this.state!==yt.Ready&&this.state!==yt.Running||(this.viewAnimation.state===Nl.State.FINISHED?this.finish():this.viewAnimation.state===Nl.State.STOPPED&&(this.state=yt.Stopped))}onControllerEnd(){this.viewAnimation==null||this.viewAnimation.done||(this.state===yt.Finished?this.viewAnimation.finish():this.state===yt.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===yt.Finished?this._asyncResult.resolve():this._asyncResult.reject(Ts()))}finish(){this.finishController()}};yh=h([F("esri.views.3d.state.controllers.AnimationController")],yh);let In=class extends yh{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new b4(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new Nl}get isInteractive(){return this.mode==="interaction"}begin(e,t){this._hasTarget=!0;const r=this.animationSettings(t);Yh.copyFrom(this.view.state.camera);const s=Gn(this.view.state.viewingMode);this.intersectionHelper.intersectRay(Yh.ray,s,l1)&&(Yh.center=l1),this.animation.update(Yh,e,r),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?HO[e.easing]:e.easing}}};h([p({constructOnly:!0})],In.prototype,"mode",void 0),h([p({readOnly:!0})],In.prototype,"isInteractive",null),In=h([F("esri.views.3d.state.controllers.PointToPointAnimationController")],In);const Yh=new Ct,l1=v();function lp(i=C4){return[i[0],i[1],i[2],i[3]]}function vh(i,e){return w4(i[0],i[1],i[2],e,bS.get())}function w4(i,e,t,r,s=lp()){return s[0]=i,s[1]=e,s[2]=t,s[3]=r,s}function Lg(i,e,t){return dt(t,i,e),oe(t,t),t[3]=hg(i,e),t}const C4=[0,0,1,0];function Ig(i,e,t,r){const s=Wl(e,t,T4);return rp(i,s,r)}const T4=jl();var Vl;(function(i){i[i.Ellipsoid=0]="Ellipsoid",i[i.Silhouette=1]="Silhouette"})(Vl||(Vl={}));const Ex=30,$u=[1,3e8],cp=80,Ax=8,Mx=200,Dx=1508e5,$x=5,Lx=50,P4=5,S4=10,qp=90,Eo={exclude:new Set([uh])};function mo(i,e,t){return t[0]=e[0]/(i.fullWidth/i.pixelRatio),t[1]=e[1]/(i.fullHeight/i.pixelRatio),t}function __(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}function Oa(i,e,t){const r=yo(xS.get(),t[3],t);r==null||pC(r,Bc)||(ve(et,i.eye,e),Xt(et,et,r),i.eye=fe(et,et,e),ve(et,i.center,e),Xt(et,et,r),i.center=fe(et,et,e),i.up=Xt(et,i.up,r))}function R4(i,e,t,r){return dg(i,Mb(e,t,Vg),r)}function g_(i,e,t,r){return dg(i,Wl(e,t,Vg),r)}function Ng(i,e,t,r){const s=Rt.get();let n=1-t;ve(s,e,i.eye);const a=we(s);let o=a*(1-n);n>=0&&o<r&&(o=r,n=-(o-a)/a),Math.abs(a-o)<1e-6||(re(s,s,n),i.eye=fe(et,i.eye,s),i.center=As(et,i.center,e,n))}function Ix(i,e,t){e.getScreenCenter(c1),Ig(i,e,c1,et)&&(e.center=et);const r=e.distance,s=r*t;if(Math.abs(r-s)<1e-6)return;const n=re(Rt.get(),e.viewForward,s);e.eye=ve(et,e.center,n)}const c1=qt();function Bp(i,e){Ie(e,0,0,0);for(const t of i)fe(e,e,t);re(e,e,1/i.length)}function zd(i,e,t,r){return Math.sin(i/we(e))*(t+r.radius)}function h1(i,e,t,r){return zd(Math.PI/2,e,t,r)+(i-Math.PI/2)}var gi;(function(i){i[i.Vertical=0]="Vertical",i[i.Horizontal=1]="Horizontal"})(gi||(gi={}));const d1={Elevation:3e4,Angle:Wt(16)},Kh={Pole:.95,Angle:Wt(18),Tilt:45},Nx=Wt(80);function Fx(i,e,t,r,s,n){const a=v(),o=Ds();let l=!0,c=!0;return i.intersectScreen(t,a,n)?o[3]=we(a):(c=!1,e.aboveGround&&s!==Vl.Ellipsoid?o[3]=Math.max(we(e.center),.9*r.radius):o[3]=we(e.eye)-e.relativeElevation,s===Vl.Silhouette?bh(o,e,t,a):l=Ig(o,e,t,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:c}}function hp(i,e,t){return we(i.eye)-t.radius>d1.Elevation?gi.Horizontal:(Wl(i,e,v1),-Math.sign(i.relativeElevation)*(.5*Math.PI+hg(i.eye,v1.direction))<d1.Angle?gi.Vertical:gi.Horizontal)}function Vx(i,e,t){ve(Hp,t,e),i.eye=ve(et,i.eye,Hp),i.center=ve(et,i.center,Hp)}const Hp=v();function bh(i,e,t,r){const s=Wl(e,t,Vg);return s!=null&&(sp(i,s,Jh),rp(i,s,r)?!(ma(Jh,s.origin)<ma(r,s.origin))||(le(r,Jh),!1):(ve(Uo,e.eye,e.center),oe(Uo,Uo),Eb(Uo,-pe(oe(Uo,Uo),Jh),u1),dg(u1,s,r),!1))}const Jh=v(),Uo=v(),u1=Co();function Ux(i,e,t,r,s,n){let a=0;if(dt(Nu,i,e),ve(rd,i,e),we(i)<=s||!r.aboveGround){dt(t,rd,r.eye);const o=pe(i,e)/(we(i)*we(e));if(o<.9999)a=on(o);else{const c=we(dt(v(),i,e))/(we(i)*we(e));a=rh(c)}const l=Math.cos(ie(Pa.normalize(Wt(n)),0,Nx));a=-a-Math.max(0,we(e)-s)/(l*s)}else ve(p1,r.eye,r.center),dt(t,rd,p1),a=-we(rd)/s;return oe(t,t),re(t,t,we(Nu)),a}const p1=v();function m1(i,e,t,r){let s,n;const a=Math.cos(ie(Pa.normalize(Wt(r)),0,Nx));return s=e>t?-(e-t)/(a*t):e<-t?Math.PI-(e+t)/(a*t):on(e/t),n=i>t?-(i-t)/(a*t):i<-t?Math.PI-(i+t)/(a*t):on(i/t),(n-s)*t}function O4(i,e,t,r,s,n,a,o,l,c){const d=m1(i[2],e[2],n[3],o),u=l?m1(i[0],e[0],n[3],180):e[0]-i[0],m=Math.sin(a)*u-Math.cos(a)*d,_=Math.cos(a)*u+Math.sin(a)*d;oe(et,s);const f=l?m/Math.sqrt(Math.abs(n[3]**2-pe(t,et)**2)):m/n[3],y=_/Math.sqrt(Math.abs(n[3]**2-pe(t,r)**2));sn(c,f,y)}function zx(i,e,t,r,s,n,a,o,l,c){dt(Nu,i,e),Bm(n.up,n.eye,ed,td,id),Bm([0,0,1],n.eye,zn,ya,Gx),le(t,ya),le(r,zn),oe(t,t),re(t,t,we(Nu)),kf(i,oe(td,td),oe(id,id),oe(ed,ed),_1),kf(e,td,id,ed,g1),O4(_1,g1,i,zn,ya,a,o,l,c,s)}function E4(i,e,t,r,s,n,a){yo(Lu,s,r),yo(Iu,a,n),Yr(_l,Lu,Iu),ve(e,i,t),Xt(e,e,_l),fe(e,e,t)}function qx(i,e,t,r,s,n){yo(Lu,r,t),yo(Iu,n,s),Yr(_l,Lu,Iu),ve(et,i.eye,e),Xt(et,et,_l),i.eye=fe(et,et,e),ve(et,i.center,e),Xt(et,et,_l),i.center=fe(et,et,e),ve(et,i.up,e),Xt(et,et,_l),i.up=fe(et,et,e)}function Fg(i,e,t,r,s,n){return(Math.abs(r)>Math.PI-Kh.Angle||Math.abs(r)<Kh.Angle)&&(Math.abs(i[2])<t*Kh.Pole||Math.abs(e)>t)&&n.aboveGround&&s<Kh.Tilt}function Bx(i,e,t,r,s,n){if(n)Lg(t,r,f1),Oa(e,At(i),f1);else{const a=Ux(t,r,y1,e,i[3],s);Oa(e,At(i),vh(y1,a))}}function Hx(i,e,t,r,s,n,a){const o=a?20:1,l=1e-12;let c,d;le(Ia,r),sd.copyFrom(e);for(let u=0;u<o&&ma(t,Ia)>l&&(c=ma(t,Ia),zx(t,Ia,ya,zn,ac,sd,i,s,n,a),qx(sd,At(i),zn,ac[1],ya,ac[0]),E4(Ia,Ia,At(i),zn,ac[1],ya,ac[0]),d=ma(t,Ia),d<c||u===0);u++)e.copyFrom(sd)}function A4(i,e,t,r,s,n,a){Fg(t,pe(e.up,t),i[3],-Pa.normalize(Wt(s)),n,e)?Hx(i,e,t,r,-Pa.normalize(Wt(s)),n,a):Bx(i,e,t,r,n,a)}function M4(i,e,t,r,s,n){const{eye:a}=i;Bm([0,0,1],a,zn,ya,Gx);const o=e.translation[0]*t.pan,l=s.mode==="zoom"?0:e.translation[1]*t.pan,c=Math.max(Math.sqrt(Math.abs(1-pe(i.center,zn)**2/we(i.center)**2)),.5),d=(Math.sin(n)*l+Math.cos(n)*o)/c,u=-Math.cos(n)*l+Math.sin(n)*o;switch($n(r.pan.matrix,r.pan.matrix,d,zn),r.pan.enabled=!0,s.mode){case"pan":$n(r.pan.matrix,r.pan.matrix,u,ya),r.pan.enabled=!0;break;case"zoom":r.zoom=-e.translation[1]*t.zoom}}function D4(i,e,t,r,s){const{eye:n,viewRight:a}=i,o=dt(Rt.get(),a,n),l=e.translation[0]*t.pan;switch(l!==0&&($n(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const c=e.translation[1]*t.pan;c!==0&&($n(r.pan.matrix,r.pan.matrix,c,a),r.pan.enabled=!0);break}case"zoom":r.zoom=-e.translation[1]*t.zoom}}function $4(i,e,t,r,s,n,a,o,l){Fg(i.center,pe(i.up,i.center),we(i.center),-Pa.normalize(Wt(n)),a,e)?M4(e,t,r,o,l,-Pa.normalize(Wt(s))):D4(e,t,r,o,l)}const zn=v(),ya=v(),Gx=v(),ed=v(),td=v(),id=v(),_1=v(),g1=v(),ac=Di(),f1=lp(),Lu=ct(),Iu=ct(),_l=ct(),Ia=v(),et=v(),rd=v(),sd=new Ct,Nu=v(),y1=v(),Vg={origin:v(),direction:v()},v1={origin:v(),direction:v()},b1=.6,Gp=4,L4=60;let Fu=class extends In{constructor(){super(...arguments),this._zoomLocation=v(),this._tmpCamera=new Ct,this._tmpViewDir=v(),this._tmpRayDir={origin:v(),direction:v()},this._targetOnSphere=v(),this._tmpCenter=v(),this._beginCamera=new Ct,this._constraintOptions=new ts(ht.ALL_EXCEPT_COLLISION,Oe.ZOOM,null,this._beginCamera),this._sphere=Ds()}initialize(){this._intersector=Gn(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const r=this.view.state;this.animation.finished?this._beginCamera.copyFrom(r.camera):this.animation.cameraAt(1,this._beginCamera);let s=!1,n=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?Eo:{})&&(s=e>0,n=!0),this._tmpCamera.copyFrom(r.camera),s?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,n),this.begin(this._tmpCamera)}animationSettings(){return{duration:Ye(600),easing:$h}}_updateCamera(e,t,r,s,n){const a=bt(this.view.spatialReference),o=hp(e,s,a),l=Math.abs(this.view.camera.position.z);oe(ad,e.eye),re(ad,ad,-1),Wl(e,s,this._tmpRayDir),oe(this._tmpRayDir.direction,this._tmpRayDir.direction);const c=ie(Math.min(Ax,1/Math.abs(pe(ad,this._tmpRayDir.direction)))*l,Mx,Dx);if(o===gi.Horizontal){let d=b1**t;this._sphere[3]=we(r),ve(this._tmpViewDir,e.center,e.eye);const u=Math.min(we(this._tmpViewDir),c);let m=u*d;if(d<=1&&m<Gp&&(m=Gp,d=m/u),Math.abs(u-m)<1e-6)return;const _=we(e.center);if(this._sphere[3]!==_){const f=this._sphere[3]+d*(_-this._sphere[3]);e.center=re(nd,e.center,f/_)}re(this._tmpViewDir,this._tmpViewDir,-d),e.eye=fe(nd,e.center,this._tmpViewDir),Ut(this.view,e,this._constraintOptions),ma(r,e.center)>1e-12&&Ig(this._sphere,e,s,this._targetOnSphere)&&A4(this._sphere,e,r,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let d=b1**Math.abs(t);const u=t>0?1:-1;ve(this._tmpViewDir,r,e.eye);const m=we(this._tmpViewDir),_=this.view._stage.renderView.getMinimalDepthForArea(null,s[0],s[1],this.view.state.camera,L4);let f=_??c;f=n&&t>0?Math.min(f,m):f,re(this._tmpRayDir.direction,this._tmpRayDir.direction,f),fe(r,this._tmpRayDir.origin,this._tmpRayDir.direction);let y=f*d;const b=Math.max(Gp,1.01*e.nearFar[0]);if(t>0&&y<b&&(y=b,d=y/f),Math.abs(f-y)<1e-6)return;re(this._tmpRayDir.direction,this._tmpRayDir.direction,u*(1-d)),e.eye=fe(nd,e.eye,this._tmpRayDir.direction),e.center=fe(nd,e.center,this._tmpRayDir.direction)}Ql(this.view,e)}};Fu=h([F("esri.views.3d.state.controllers.global.ZoomStepController")],Fu);const nd=v(),ad=v();let qd,Bd=null;const Al=new Map;async function KI(i){Bd==null&&(qd==null&&(qd=he(()=>import("./VoxelWasmPerSceneView-C_CYk5nP.js"),__vite__mapDeps([365,1,2,132,45,48,102,47,41,34,21,38,30,20,31,8,32,33,40,26,42,19,43,44,39,35,53,162,163,24,12,18,25,17,14,60,111,11,13,15,16,22,23,27,28,84,85,56,79,86,87,29,70,52,36,37,55,57,69,58,88,51,128,129,130,131,6,7,9,10,46,49,50,54,59,61,62,63,64,65,66,67,68,71,72,73,74,75,76,77,78,80,81,82,83,89,90,91,92,93,94,95,96,97,98,99,100,101,103,104,105,106,107,108,109,110,119,133,116,134,135,136,137,4,138,122,123,124,125,139,140,141,142,143,144,145,146,147,148,149,150,151,112,113,114,152,153,154,155,156,157,158,159,160,161,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188]))),Bd=await qd);const e=i.view;let t=Al.get(e);return t||(t=new Bd.default({view:e}),Al.set(e,t)),t.addVoxelLayer(i)}function xh(i){return Al.get(i)}function JI(i){const e=i.view,t=Al.get(e);t&&t.removeVoxelLayer(i)<1&&(Al.delete(e),Al.size===0&&(qd=null,Bd=null))}const I4=.6,N4=4,F4=60;let Vu=class extends In{constructor(){super(...arguments),this._zoomLocation=v(),this._tmpCamera=new Ct,this._tmpRayDir=v(),this._tmpCenter=v(),this._beginCamera=new Ct,this._constraintOptions=new ts(ht.ALL,Oe.ZOOM,null,this._beginCamera)}zoomStep(e,t){if(!this.active)return;const r=this.view.state;this.animation.finished?this._beginCamera.copyFrom(r.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(r.camera);const s=Gn(this.view.state.viewingMode);let n=!1;e>0?(n=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.map.ground.opacity===0?Eo:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center);const a=I4**e;let o=this.view._stage.renderView.getMinimalDepthForArea(xh(this.view),t[0],t[1],this.view.state.camera,F4);ve(od,this._tmpCamera.eye,this._zoomLocation),oe(od,od);const l=ie(Math.min(Ax,1/Math.abs(pe(V4,od)))*Math.abs(this.view.camera.position.z),Mx,Dx);if(o=o??l,o){const c=v();ve(c,this._zoomLocation,this._tmpCamera.eye),(o<we(c)||!n)&&(oe(c,c),fe(this._zoomLocation,this._tmpCamera.eye,re(c,c,o)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:Ye(600),easing:$h}}_updateCamera(e,t,r){ve(this._tmpRayDir,r,e.eye);const s=we(this._tmpRayDir);let n=s*t;const a=t<=1,o=Math.max(N4,1.01*e.nearFar[0]);n!==0&&(a&&n<o&&(n=o,t=n/s),Math.abs(s-n)<1e-6||(re(this._tmpRayDir,this._tmpRayDir,t),e.eye=ve(x1,r,this._tmpRayDir),e.center=As(x1,e.center,r,1-t),Ut(this.view,e,this._constraintOptions)))}};Vu=h([F("esri.views.3d.state.controllers.local.ZoomStepController")],Vu);const x1=v(),V4=It(0,0,1),od=v();let U4=class extends Is{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,r=>this._handleDoubleClick(r))}_handleDoubleClick(e){const t=e.data;if(GT(t,"primary")){const r=this._view.state.isGlobal?new Fu({view:this._view,mode:"animation"}):new Vu({view:this._view,mode:"animation"});this._view.state.switchCameraController(r),r.zoomStep(Math.log(.5)/Math.log(.6),qt(t.x,t.y)),e.stopPropagation()}}};function z4(i,e,t){return i===Re.Global?new B4(t):new q4(e,t)}let q4=class{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=bt(t),this._unitInMeters=Ev(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,r,s,n){var C;n||(n={near:0,far:0});let a=e[2]*this._unitInMeters;const o=a,l=a-s,c=(C=this._elevationProvider)==null?void 0:C.visibleElevationBounds;c&&(a=l>=0?o-this._unitInMeters*c.min:this._unitInMeters*c.max-o);const d={x:(r=r??new Zs({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},u=Math.max(d.x,d.y,d.z);ve(Na,t,e),zo[0]=Na[0]>0?r.xmax:r.xmin,zo[1]=Na[1]>0?r.ymax:r.ymin,zo[2]=Na[2]>0?u/2:-u/2,ve(zo,zo,e),oe(Na,Na);const m=1.1*pe(zo,Na)*this._unitInMeters,_=Math.sqrt(a*(a+2*this._referenceEllipsoid.radius)),f=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),y=f*k4*this._unitInMeters,b=f*j4*this._unitInMeters,x=ie((a-b)/(y-b),0,1)**3,w=Math.min(He(_,m,x),_)*Math.max(Math.log(Math.abs(l)),1);return kx(Math.min(w,Math.max(34064e4,u))/this._unitInMeters,H4,this._unitInMeters,n)}},B4=class{constructor(e){this._referenceEllipsoid=bt(e)}compute(e,t,r,s,n){n||(n={near:0,far:0});const a=we(e),o=a-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,s),c=Math.abs(o-s),d=Math.max(c,Math.abs(o)),u=Math.sqrt(d*(d+2*l)),m=a+this._referenceEllipsoid.radius;return kx(1.2*He(u,m,_g(d)),ie(2e4-(Math.log(d)-7.983)/9.011*19e3,1e3,2e4),1,n)}};function kx(i,e,t,r){const s=G4/t;return i/e>s?(r.far=i,r.near=r.far/e):(r.near=s,r.far=r.near*e),r}const H4=2e4,G4=2,k4=.001,j4=1e-4,zo=v(),Na=v();let Hd=class extends Pe{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;e.spatialReference!=null&&Zv(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>Ql(this.view,e,Xr.EYE_AND_CENTER))}};h([p({constructOnly:!0})],Hd.prototype,"view",void 0),Hd=h([F("esri.views.3d.state.ElevationCollisionConstraint")],Hd);let Rc=class extends Pe{constructor(e){super(e),this.nearFarHeuristic=z4(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([A(()=>{var e,t,r,s;return[(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.near,(s=(r=this.view.constraints)==null?void 0:r.clipDistance)==null?void 0:s.far]},()=>this._clipDistanceNearFarChanged()),A(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),A(()=>this.view.renderDataExtent,()=>this._updateNearFar(),st),A(()=>{var e,t,r,s;return[(t=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:t.min,(s=(r=this.view.constraints)==null?void 0:r.altitude)==null?void 0:s.max]},()=>this._updateAltitude(),st),A(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.max},()=>this._updateTiltMax(),st),A(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.mode},()=>this._updateTilt(),st),A(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),st),A(()=>{var e,t,r,s,n,a;return[(r=(t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.navigationConstraint)==null?void 0:r.type,(a=(n=(s=this.view.state)==null?void 0:s.constraints)==null?void 0:n.collision)==null?void 0:a.enabled]},()=>this._updateCollision(),st)]),this.view.state.isLocal&&this.addHandles(A(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),oi)),this._updateNearFar(),this.view.state.viewingMode!==Re.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Hd({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=(t=this.view.constraints)==null?void 0:t.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(r=>this._updateCameraNearFarManual(r,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,Y_(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var s,n,a;const e=(a=(n=(s=this.view.map)==null?void 0:s.ground)==null?void 0:n.navigationConstraint)==null?void 0:a.type,t=!e||e==="stay-above",r=this.view.state.constraints.collision;if(t!==r.enabled){r.enabled=t,t&&this._reapplyConstraints(ht.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Re.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Wt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const r=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Lm(r))}}_updateLocalSurfaceDistance(e){if(e==null)return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));const r=this.view.state,s=3*t/Math.atan(r.camera.fov/2);s!==r.constraints.distance&&(r.constraints.distance=s)}_reapplyConstraints(e=ht.ALL){this.view.state.updateCamera(t=>Ut(this.view,t,new ts(e,Oe.NONE,null)))}};h([p({constructOnly:!0})],Rc.prototype,"view",void 0),h([p({readOnly:!0})],Rc.prototype,"surfaceCollisionConstraint",void 0),Rc=h([F("esri.views.3d.state.ConstraintsManager")],Rc);let ca=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=Tu(),this._points=SS(),this.lines=new Array(12),this._origin=v(),this._direction=v(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:v(),endpoint:null}}update(e){RS(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),le(this._origin,e.eye),le(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)le(this._points[t],e[t]);OS(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return np(this.frustum,e)}intersectsRay(e){return ES(this.frustum,e)}intersectsLineSegment(e,t){return AS(this.frustum,e,t)}intersectsPoint(e){return MS(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const r=t+4;kp(this.lines[t],e[t],e[r]),kp(this.lines[t+4],e[t],t===3?e[0]:e[t+1]),kp(this.lines[t+8],e[r],t===3?e[4]:e[r+1])}}};function kp(i,e,t){i.origin=e,i.endpoint=t,Wu(i.direction,e,t)}ca.planePointIndices=DS,ca.nearFarLineIndices=[[mt.NEAR_BOTTOM_LEFT,mt.FAR_BOTTOM_LEFT],[mt.NEAR_BOTTOM_RIGHT,mt.FAR_BOTTOM_RIGHT],[mt.NEAR_TOP_RIGHT,mt.FAR_TOP_RIGHT],[mt.NEAR_TOP_LEFT,mt.FAR_TOP_LEFT]];let jc=class extends En{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=yt.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(e.spatialReference==null||Zv(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),Ql(this.view,e,Xr.EYE_AND_CENTER)||this.constraintEnabled||(this.state=yt.Stopped)})}};h([p({constructOnly:!0})],jc.prototype,"desiredCamera",null),jc=h([F("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],jc);let W4=class{constructor(e,t,r){this.target=e,this.options=t,this.view=r,this.state="pending",this._animationController=null,this.promise=new Promise((s,n)=>{this._resolveCallback=s,this._rejectCallback=n;const a=new AbortController;this.options.signal!=null&&Av(this.options.signal,()=>{this.abort()}),this._abortController=a,this.waitForReady()})}resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject(Ts())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await Nm(()=>this.view.ready,this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}async createViewPoint(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null;try{const e=await c3(this.view,this.target,this._abortController.signal);if(this.state==="finished")return;const t=e?this._getCameraFromViewpoint(e):null;if(t==null)return;if(this.options.animate){if(this._animationController==null)return;this.startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}catch(e){this.reject(e)}}}_getCameraFromViewpoint(e){var n;const t=!!(this.target instanceof Il&&this.target.camera||this.target instanceof vo),r=e.camera;if(r==null)return null;if(!this.view.stateManager.isCompatible(r)){const a=r.position,o=a&&a.spatialReference,l=o?o.wkid:"none",c=(n=this.view.spatialReference)==null?void 0:n.wkid;return this.reject(new Ir("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${l}, view: ${c})`,{camera:r})),null}const s=ia(this.view,r);return s==null?(this.reject(new Ir("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:t}}startAnimation(e,t){this.state="wait-for-animation-finish";const r=t.viewAnimation;if(r==null)return void this.reject(new Ir("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(e.viewpoint,"running"),!t.active||t.viewAnimation==null||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let s;e.isFullySpecified?(s=new jc({view:this.view,desiredCamera:e.camera}),Ql(this.view,e.camera,Xr.EYE_AND_CENTER)):Ut(this.view,e.camera),t.begin(e.camera,this.options);const n=()=>{const o=this.view.state.cameraController;s&&(o&&o.active?o instanceof In&&o.viewAnimation!=null&&o.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):t.viewAnimation!=null&&t.viewAnimation.target===e.viewpoint&&t.state===yt.Finished&&(this.view.state.cameraController=s))},a=o=>{if(this.view.state!=null)switch(t.state){case yt.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case yt.Ready:case yt.Rejected:case yt.Running:case yt.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(o)}}};r.when(n,o=>a(o)),t.asyncResult={resolve:()=>a(),reject:o=>a(o)}}_getAnimationController(){let e=null,t=null;const r=this.view.state.cameraController;return r instanceof In&&(r.updateStateFromViewAnimation(),r.active&&(e=r,t=e.viewAnimation)),e!=null||(e=new In({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(t!=null&&t.stop(),this.reject(new Ir("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}},Gt=class extends Pe{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=w1,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(t){this.viewStateManager._idleTimeout=t?w1:0}},this._propertiesPool=new Sa({frustum:ca},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Q4}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Nn(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),A(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},(e,t)=>this._cameraChangedHandler(e,t),st)]),Dl(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([Qu({prepare:()=>this._prepareFrame()}),A(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(cd)}),Nn(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=te(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Qf(this.view,this.view.state.camera,jp);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){var t,r;this._updatePropertyBeforeReady("camera",e)||((t=this.view.elevationProvider)==null||t.enableCache(!0),this.setStateCamera(ia(this.view,e),{applyConstraints:!1})||de.getLogger(this).error("#camera=","Invalid camera",e),(r=this.view.elevationProvider)==null||r.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Qf(this.view,this.view.state.contentCamera,jp);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=ia(this.view,e);t!=null?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(Wp),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,r=this.view.state.camera.distance**2,s=Mv(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([A(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(Wp),this.test.contentCameraResetState.clear())}),A(()=>this.zoom,a=>{a!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(a-t)/2),Math.abs(a-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))}),A(()=>this.view.state.camera,a=>{const o=ma(s,a.center);this.test.contentCameraResetState.set("camera.center",o/r),o>r?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})],Wp),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():de.getLogger(this).error("#center=","Invalid center",e):de.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):de.getLogger(this).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=Qv(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return t??this._get("extent")}set extent(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||de.getLogger(this).error("#extent=","Invalid extent",e):de.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):de.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){var t;const e=this.view.map;return e&&"initialViewProperties"in e?(t=e.initialViewProperties)==null?void 0:t.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Xv(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||de.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,r=e.pixelRatio,s=this._get("padding"),n=Math.round(t[wr.TOP]/r),a=Math.round(t[wr.RIGHT]/r),o=Math.round(t[wr.BOTTOM]/r),l=Math.round(t[wr.LEFT]/r);return s!=null&&s.top===n&&s.right===a&&s.bottom===o&&s.left===l?s:{top:n,right:a,bottom:o,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,ld),this.view.state.updateCamera(t=>t.padding=ld))}_paddingToArray(e,t,r){e?xa(r,e.top||0,e.right||0,e.bottom||0,e.left||0):xa(r,0,0,0,0);for(let s=0;s<4;s++)r[s]=Math.round(r[s]*t)}get screenCenter(){const e=this.padding;return Dv((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?h3(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){var t;if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||de.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const r=e.camera!=null?e.camera.position:e.targetGeometry,s=r!=null&&r.spatialReference;de.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(s?s.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e)}else de.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?d3(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||de.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){var s;if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const r=(s=this.view._stage.renderView.renderingContext)==null?void 0:s.parameters.maxTextureSize;return r&&og(this._tmpCanvasSize,r),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,t;return((t=(e=this.view)==null?void 0:e._stage)==null?void 0:t.renderer.isFeatureEnabled(Ln.PhysicalPixelRendering))??!1}get _usePhysicalPixelRenderingAny(){var t,r;const e=(r=(t=this.view)==null?void 0:t._stage)==null?void 0:r.renderer;return e&&(e.isFeatureEnabled(Ln.PhysicalPixelRendering,Wi.IDLE)||e.isFeatureEnabled(Ln.PhysicalPixelRendering,Wi.INTERACTING)||e.isFeatureEnabled(Ln.PhysicalPixelRendering,Wi.ANIMATING))}preinit(e){var t,r,s;return!(this._isOverridden("center")&&!tc(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!tc(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!tc(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||tc((t=this.viewpoint.targetGeometry)==null?void 0:t.spatialReference,e)&&tc((s=(r=this.viewpoint.camera)==null?void 0:r.position)==null?void 0:s.spatialReference,e))}init(){this._constraintsManager=new Rc({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const t=this._initialViewpoint||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===Re.Local&&this.addHandles(Dl(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(cd),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),cd)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(cd),this._constraintsManager=te(this._constraintsManager))}async goTo(e,t){const r={animate:!0,...t};return this._gotoOperation!=null&&this._gotoOperation.abort(r.animate),this._gotoOperation=new W4(e,r,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(u3(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,r=t==null?void 0:t.cameraController;r&&(t.updateCamera(s=>r.stepController(e,s)),r.steppingFinished&&r.finishController())}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:r,overrides:s}of X4){const n=e.has(r),a=this._isOverridden(r);!n&&a&&t.push({name:r,value:this._get(r)}),this._clearOverride(r),(n||a)&&s.forEach(o=>e.add(o))}return t}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof vo)return void this.setStateCamera(ia(this.view,e),{applyConstraints:!1});if(e instanceof Il){if(e.targetGeometry instanceof Zs){const n=wp(this.view,e.targetGeometry,0,.5,qh.LOCKED);return void(n!=null&&this.setStateCamera(ia(this.view,n),{applyConstraints:!0}))}const r={applyConstraints:!e.camera},s=this._viewpointToCamera(e);return void this.setStateCamera(s,r)}const t=wp(this.view,e,0,.5,qh.LOCKED);t!=null&&this.setStateCamera(ia(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&Z4.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof Il?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof vo?this.isCompatible(e.position):e.spatialReference&&!mC(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=Y4){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,r=Jn){const{heading:s,tilt:n}=this._getPreservingHeadingTilt(),a=p3(this.view,s,n,e,t,qh.ADJUST);return a==null?null:(r.copyFrom(this.view.state.camera),r.eye=a.eye,r.center=a.center,r.up=a.up,r)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const r=t.distance;return this._centerPointAtDistanceToCamera(e,r)}_extentToCamera(e){const{heading:t,tilt:r}=this._getPreservingHeadingTilt(),s=wp(this.view,e,t,r,qh.ADJUST,jp);return s?ia(this.view,s):null}_scaleToCamera(e){if(e==null)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const r=t.renderLocation,s=t.location.latitude,n=m3(this.view,e,s);return this._centerPointAtDistanceToCamera(r,n)}_zoomToCamera(e){return this._scaleToCamera(_3(this.view,e))}_viewpointToCamera(e){return ia(this.view,g3(this.view,e))}setStateCamera(e,t){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(r=>{t.positionAndOrientationOnly?(r.eye=e.eye,r.center=e.center,r.up=e.up):r.copyFrom(e),t.applyConstraints&&Ut(this.view,r)}),t.applyConstraints||(this.view.state.cameraController=new jc({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const r=this._computeCanvasSize();if(r.width!==0&&r.height!==0&&(t.width===r.width&&t.height===r.height||(t.width=r.width,t.height=r.height),this.view.state)){const s=this.view.state.camera;s.fullWidth===r.width&&s.fullHeight===r.height&&s.pixelRatio===r.pixelRatio||(Jn.copyFrom(s),Jn.pixelRatio!==r.pixelRatio&&(this._paddingToArray(this.padding,r.pixelRatio,ld),Jn.padding=ld),Jn.fullWidth=r.width,Jn.fullHeight=r.height,Jn.pixelRatio=r.pixelRatio,this.view.state.camera=Jn),this._updateViewState()}}_updateElevation(e){var n,a;const t=(n=this.view.basemapTerrain)==null?void 0:n.spatialReference,r=((a=this.view.renderCoordsHelper)==null?void 0:a.getAltitude(e.eye))??0,s=t?Y_(this.view,e.eye):0;e.relativeElevation=r-s}_updateViewState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Wi.ANIMATING:this.view.interacting?this.view.state.mode=Wi.INTERACTING:(this.view.state.mode===Wi.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=Wi.INTERACTING:this.view.state.mode=Wi.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};h([p({type:vo,dependsOn:["view.state.camera","ready"]})],Gt.prototype,"camera",null),h([p({type:vo,dependsOn:["view.state.contentCamera","ready"]})],Gt.prototype,"contentCamera",null),h([p({type:Ms})],Gt.prototype,"center",null),h([p({type:Zs})],Gt.prototype,"extent",null),h([p({readOnly:!0})],Gt.prototype,"frustum",null),h([p()],Gt.prototype,"_constraintsManager",void 0),h([p({readOnly:!0})],Gt.prototype,"constraintsManager",null),h([p()],Gt.prototype,"_initialViewpoint",null),h([p({readOnly:!0})],Gt.prototype,"hasInitialView",null),h([p({readOnly:!0,type:Boolean})],Gt.prototype,"ready",void 0),h([p({type:Number})],Gt.prototype,"scale",null),h([p()],Gt.prototype,"padding",null),h([p({readOnly:!0})],Gt.prototype,"screenCenter",null),h([p({constructOnly:!0})],Gt.prototype,"view",void 0),h([p({type:Il})],Gt.prototype,"viewpoint",null),h([p({type:Number})],Gt.prototype,"zoom",null),h([p({readOnly:!0})],Gt.prototype,"_rasterPixelRatio",null),h([p({readOnly:!0})],Gt.prototype,"_usePhysicalPixelRendering",null),h([p({readOnly:!0})],Gt.prototype,"_usePhysicalPixelRenderingAny",null),h([p()],Gt.prototype,"_windowDevicePixelRatio",void 0),h([p()],Gt.prototype,"_devicePixelRatioOverride",void 0),Gt=h([F("esri.views.3d.state.ViewStateManager")],Gt);let Q4=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}};const Z4=new Set(["camera","viewpoint","extent","scale","center","zoom"]),X4=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Y4={heading:0,tilt:0},jp=new vo,Jn=new Ct,ld=_i(),cd="pending-initial-view",Wp="content-camera-reset",w1=300,C1=100;let en=class extends En{constructor(){super(...arguments),this.startCamera=new Ct,this.currentCamera=new Ct,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<C1}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=yt.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),C1),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};h([p({readOnly:!0})],en.prototype,"isInteractive",null),h([p()],en.prototype,"_lastInteraction",void 0),en=h([F("esri.views.3d.state.controllers.InteractiveController")],en);var Cr;(function(i){i[i.CENTER=0]="CENTER",i[i.EYE=1]="EYE"})(Cr||(Cr={}));let Wc=class extends en{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=Cr.CENTER,this._rotScale=0,this._lastPoint=Di(),this._tmpWorldUp=v(),this._tmpViewDir=v(),this._tmpRotCurPoint=Di(),this._tmpTransf=ct(),this._tmpAxis=v(),this._tmpPivotPoint=v(),this._pivotPos=v(),this._constraintOptions=new ts(ht.ALL,Oe.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===Cr.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case Cr.EYE:le(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Oe.LOOK_AROUND,this._constraintOptions.tiltMode=dn.LOOK_AROUND,this._constraintOptions.selection=ht.NONE;break;case Cr.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?Eo:{});t||le(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.tiltMode=dn.TUMBLE,this._constraintOptions.selection=ht.ALL&~ht.DISTANCE;break}}mo(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const r=this.startCamera,s=v();ve(s,this._pivotPos,r.eye);const n=we(s),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(r.eye,T1);let o=Math.max(Math.min(P4,1/Math.abs(pe(T1,r.viewForward)))*a,S4);t&&(o=Math.min(n,o));const l=bt(this.view.spatialReference),c=qt(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),d=hp(this.startCamera,c,l);let u=this.view._stage.renderView.getMinimalDepthForArea(xh(this.view),r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,2.5*qp,qp),m=this.view._stage.renderView.getMinimalDepthForArea(xh(this.view),e[0],e[1],r,qp);u==null&&m==null||(u=u??m??0,m=m==null||d===gi.Horizontal?u:m,o=u>m?m:u,o=t?Math.min(o,n):o),oe(s,s),le(this._pivotPos,fe(this._tmpPivotPoint,r.eye,re(this._tmpPivotPoint,s,o)))}update(e){if(this.active){switch(this.pivot){case Cr.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case Cr.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Ut(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,t,r,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),mo(e,t,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;ve(this._tmpViewDir,r,s);const o=we(this._tmpViewDir),l=on(pe(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===Cr.EYE){n*=-.5;const c=.5*Math.PI-l,d=.5*Math.PI*.99;n=c-Math.max(-d,Math.min(d,c+n))}return n=ie(n+l,Ei.min,Ei.max)-l,dt(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===Cr.CENTER&&(a=-a),yo(this._tmpTransf,a,this._tmpWorldUp),$n(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),Xt(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Xt(Qp,e.up,this._tmpTransf),fe(Qp,s,this._tmpViewDir),Ca(this._lastPoint,this._tmpRotCurPoint),Qp}};h([p()],Wc.prototype,"pivot",void 0),Wc=h([F("esri.views.3d.state.controllers.RotateController")],Wc);const Qp=v(),T1=v();let Zp=class extends Is{constructor(e,t,r,s){super(!0),this._view=e,this.pointerAction=t,this._pivot=r,this.registerIncoming("drag",s,n=>this._handleDrag(n))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!X_(e.data,this.pointerAction))return;const r=qt(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Wc({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},f_=class extends en{constructor(){super(...arguments),this._pickPoint=v(),this._tmpP0=Di(),this._panAxisAngle=lp(),this._tmpRayDir=v(),this._tmpRayDirPick=v(),this._targetOnSphere=v(),this._navMode=gi.Horizontal,this._tmpRay={origin:v(),direction:v()},this.dragBeginPoint=qt(),this._normalizedAnchorPoint=Di(),this._constraintOptions=new ts(ht.ALL_EXCEPT_COLLISION,Oe.ZOOM,0,this.startCamera),this._sphere=Ds(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Ca(this.dragBeginPoint,e),mo(this.startCamera,e,this._normalizedAnchorPoint);const t=bt(this.view.spatialReference),r=Fx(this._intersectionHelper,this.startCamera,e,t,Vl.Ellipsoid,this.view.map.ground.opacity===0?Eo:{});if(this._navMode=hp(this.startCamera,e,t),this._navMode===gi.Horizontal)this._hasPickPoint=!!r.scenePickPoint,this._pickPoint=r.scenePickPoint??this._pickPoint,this._sphere=r.sphere;else{let s;Wl(this.startCamera,e,this._tmpRay),oe(this._tmpRay.direction,this._tmpRay.direction),r.scenePickPoint!=null&&(ve(this._tmpRayDirPick,this.startCamera.eye,r.scenePickPoint),s=we(this._tmpRayDirPick));const n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,P1);let a=ie(Math.min(Ex,1/Math.abs(pe(P1,this._tmpRay.direction)))*n,$u[0],$u[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,cp);a=o??a,a=s!=null?Math.min(a,s):a,this._hasPickPoint=!0,re(this._tmpRay.direction,this._tmpRay.direction,a),fe(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===gi.Horizontal){ve(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=we(this._tmpRayDir);mo(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=t*2**r;const n=this.view.state.constraints.minimumPoiDistance;if(r<0&&s<n&&(s=n),Math.abs(t-s)<1e-6)return;if(this._hasPickPoint&&s<t){const a=1-(1-s/t)*(1-this._sphere[3]/we(this.currentCamera.center));this.currentCamera.center=re(hd,this.currentCamera.center,a)}re(this._tmpRayDir,this._tmpRayDir,-s/t),this.currentCamera.eye=fe(hd,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=bs(hh(this.dragBeginPoint,e)),Ut(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(bh(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Lg(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Oa(this.currentCamera,At(this._sphere),this._panAxisAngle))}else{const t=we(this._tmpRay.direction);mo(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=t*2**r;const n=this.view.state.constraints.minimumPoiDistance;if(r<0&&s<n&&(s=n),Math.abs(t-s)<1e-6)return;re(this._tmpRayDir,this._tmpRay.direction,1-s/t),this.currentCamera.eye=fe(hd,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=fe(hd,this.currentCamera.center,this._tmpRayDir)}Ql(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};f_=h([F("esri.views.3d.state.controllers.global.ZoomController")],f_);const hd=v(),P1=v();let y_=class extends en{constructor(){super(...arguments),this._tmpP=v(),this._tmpDir=v(),this._tmpN=v(),this._tmpP0=Di(),this._tmpPoi=v(),this._tmpRayDir=v(),this.dragBeginPoint=qt(),this._normalizedAnchorPoint=Di(),this._constraintOptions=new ts(ht.ALL,Oe.ZOOM,0,this.startCamera,v()),this._plane=Co()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Ca(this.dragBeginPoint,e),mo(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?Eo:{});ve(this._tmpDir,this._tmpP,this.startCamera.eye);const r=we(this._tmpDir);oe(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z);let n=ie(Math.min(Ex,1/Math.abs(pe(K4,this._tmpDir)))*s,$u[0],$u[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(xh(this.view),e[0],e[1],this.view.state.camera,cp);n=a??n,n=t?Math.min(n,r):n,re(this._tmpDir,this._tmpDir,n),fe(this._tmpP,this.startCamera.eye,this._tmpDir),ve(this._tmpN,this.startCamera.eye,this.startCamera.center),oe(this._tmpN,this._tmpN),this._tmpN[1]<0&&rn(this._tmpN,this._tmpN),Ab(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.active)return;R4(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||le(this._tmpPoi,this.currentCamera.center),mo(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);Ca(this._normalizedAnchorPoint,this._tmpP0),ve(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const r=we(this._tmpRayDir);let s=r*(1-t);this._constraintOptions.interactionDirection&&(le(this._constraintOptions.interactionDirection,this._tmpRayDir),re(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/r));const n=this.view.state.constraints.minimumPoiDistance;t>=0&&s<n&&(s=n,t=-(s-r)/r),Math.abs(r-s)<1e-6||(re(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=fe(Fa,this.currentCamera.eye,this._tmpRayDir),As(Fa,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Fa[2]=Math.max(this.startCamera.center[2],Fa[2]):Fa[2]=Math.min(this.startCamera.center[2],Fa[2]),this.currentCamera.center=Fa,this._constraintOptions.interactionFactor=bs(hh(this.dragBeginPoint,e)),Ut(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};y_=h([F("esri.views.3d.state.controllers.local.ZoomController")],y_);const Fa=v(),K4=It(0,0,1);let J4=class extends Is{constructor(e,t,r){super(!0),this._view=e,this.pointerAction=t,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!X_(e.data,this.pointerAction))return;const r=qt(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new f_({view:this._view}):this._cameraController=new y_({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},co=class extends en{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Ct,this._headingStart=0,this._constraintOptions=new ts(ht.ALL,Oe.NONE,0,new Ct,null,dn.LOOK_AROUND)}handleEventGamepad(e){const t=jf(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||vp(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,Wf(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const t=Wf(this._keysButtonState,this._transformation);vp(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,r=1;this._filteredSurfaceElevation+=r*(t-this._filteredSurfaceElevation)*e}stepController(e,t){var r;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),(r=this._constraintOptions.interactionStartCamera)==null||r.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Va),this._applyDisabledMovementTypes(Va),this._applyPan(Va.pan),this._applyRotate(Va.rotate),this._applyZoom(Va.zoom),this._applyAscend(Va.ascend),this._constraintOptions.interactionType=Oe.NONE,this._constraintOptions.selection=ht.COLLISION,Ut(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;ve(er,t.center,t.eye),Xt(er,er,e.matrix),t.center=fe(er,er,t.eye),t.up=Xt(er,t.up,e.matrix),this._constraintOptions.interactionType=Oe.LOOK_AROUND,this._constraintOptions.selection=ht.ALL_EXCEPT_COLLISION,Ut(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=Xt(er,t.eye,e.matrix),t.center=Xt(er,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Xt(er,t.up,e.matrix)),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.selection=ht.ALL,Ut(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=fe(er,this.currentCamera.eye,re(Rt.get(),t,e)),le(oc,t),rn(oc,oc),this._constraintOptions.interactionDirection=oc,this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.selection=ht.ALL_EXCEPT_COLLISION,Ut(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Rt.get());if(this._constraintOptions.interactionDirection=le(oc,t),this.view.state.isGlobal){const r=we(this.currentCamera.eye),s=(r+e)/r;this.currentCamera.eye=re(er,this.currentCamera.eye,s),this.currentCamera.center=re(er,this.currentCamera.center,s)}else{const r=re(Rt.get(),t,e);this.currentCamera.eye=fe(er,this.currentCamera.eye,r),this.currentCamera.center=fe(er,this.currentCamera.center,r)}this._updateCameraCenter(),this._constraintOptions.interactionType=Oe.ASCEND,this._constraintOptions.selection=ht.COLLISION,Ut(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=ht.ALL_EXCEPT_COLLISION,Ut(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,r){aE(r);const s=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(s,t,r):this._calculateControlTransformationGlobal(s,t,r)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,r=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(r,e,er)}_calculateControlTransformationLocal(e,t,r){const{viewRight:s,viewForward:n}=t,a=this._transformation,o=this.view.navigation.gamepad,l=Ie(Rt.get(),n[0],n[1],0);oe(l,l);const c=a.translation[0]*e.pan;if(c!==0){const y=re(Rt.get(),s,c);sh(r.pan.matrix,r.pan.matrix,y),r.pan.enabled=!0}switch(o.mode){case"pan":{const y=-a.translation[1]*e.pan;if(y!==0){const b=re(Rt.get(),l,y);sh(r.pan.matrix,r.pan.matrix,b),r.pan.enabled=!0}r.zoom=a.zoom*e.zoom;break}case"zoom":r.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:ba(o.mode)}const d=a.translation[2]*e.ascend;r.ascend=d;const u=-a.heading*e.rotate;u!==0&&($n(r.rotate.matrix,r.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Rt.get())),r.rotate.enabled=!0);const m=a.tilt*e.rotate,_=Ra(this.view.renderCoordsHelper,t.center,t.eye),f=ie(_+m,Ei.min,Ei.max)-_;f&&($n(r.rotate.matrix,r.rotate.matrix,f,s),r.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,r){const{eye:s,viewRight:n}=t,a=this._transformation,o=this.view.navigation.gamepad,l=dt(Rt.get(),n,s);oe(l,l),rn(l,l),$4(this.startCamera,t,a,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,r,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Va.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,d=a.translation[2]*e.ascend;r.ascend=d;const u=-a.heading*e.rotate;u!==0&&($n(r.rotate.matrix,r.rotate.matrix,u,this._tmpCamera.eye),r.rotate.enabled=!0);const m=a.tilt*e.rotate,_=this._clampTiltDeltaGlobalToValidRange(m,t.ray,c);_!==0&&($n(r.rotate.matrix,r.rotate.matrix,_,this._tmpCamera.viewRight),r.rotate.enabled=!0),r.zoom+=a.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,r){const s=bt(this.view.spatialReference),n=zd(Ei.min,t.origin,r,s);let a=0,o=0;const l=Rt.get();if(this.view.renderCoordsHelper.intersectManifold(t,r,l)){const c=Ra(this.view.renderCoordsHelper,l,t.origin);a=zd(c,t.origin,r,s),o=zd(Ei.max,t.origin,r,s)}else{sp(lg(cg,r+s.radius),t,l);const c=Math.PI+hg(t.direction,l);a=h1(c,t.origin,r,s),o=h1(Ei.max,t.origin,r,s)}return ie(a+e,n,o)-a}_getPointAbsoluteSurfaceElevation(e,t,r){const{renderCoordsHelper:s}=this.view,n=s.getAltitude(e),a=t+Math.abs(n-t);return s.setAltitude(r,a,e),a}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:r}=this.view,{camera:s}=this.view.state,{direction:n}=f3(this.view,t,0,jx,nE),a=r.intersectManifoldClosestSilhouette(wo(t,n),e,Rt.get()),o=cr(t,a),l=r.intersectManifoldClosestSilhouette(wo(t,Wu(Rt.get(),t,s.center)),e,Rt.get()),c=cr(t,l);return Math.min(o,c)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:r}=this.view,{camera:s,isGlobal:n}=r,a=t.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,Rt.get());if(n){const o=ve(Rt.get(),e,a),l=we(o);re(o,o,1/l);const c=oe(Rt.get(),e),d=on(pe(c,o));return l*Math.sin(Math.min(tE,d))}{const o=le(Rt.get(),e);return t.setAltitude(o,this._filteredSurfaceElevation),cr(a,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:iE}_computeVelocities(e){const t=this._filteredSurfaceElevation,r=t+bt(this.view.spatialReference).radius,{camera:s,isGlobal:n}=this.view.state,a=Rt.get(),o=this._getPointAbsoluteSurfaceElevation(s.eye,t,a),l=this._clampedDistanceToSurface(t,a),c=s.width/2,d=S1*s.width,u=S1*s.width,m=l*Math.tan(.5*s.fovX)/c,_=m/r,f=m/this._computeHeadingRotateRadius(a),y=o-t;return{pan:(n?_:m)*d*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(d*e/c)*y-y),zoom:2**(d*e/c)*l-l,rotate:ie(f*u,rE,sE)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&du(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&du(e.rotate.matrix))}static activatesFor(e,t){const r=jf(t,e.navigation.gamepad,eE);return!(t.action==="end"||vp(r))}};h([p({constructOnly:!0})],co.prototype,"gamepadDevice",void 0),h([p({constructOnly:!0})],co.prototype,"disableMovements",void 0),co=h([F("esri.views.3d.state.controllers.GamepadKeyboardController")],co);const eE={translation:[0,0,0],heading:0,tilt:0,zoom:0},jx=80,tE=Wt(jx),S1=.75,iE=5,rE=Wt(30),sE=Wt(80),Va={zoom:0,ascend:0,pan:{enabled:!1,matrix:ct()},rotate:{enabled:!1,matrix:ct()}},er=v(),oc=v(),nE=y3();function aE(i){i.zoom=0,i.ascend=0,i.pan.enabled=!1,du(i.pan.matrix),i.rotate.enabled=!1,du(i.rotate.matrix)}let oE=class extends Is{constructor(e){super(!0),this._view=e,this._watchHandles=new ju,this._handle=this.registerIncoming("gamepad",t=>this._handleEventGamepad(t)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([A(()=>this._view.navigation.gamepad.enabled,t=>{t?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},oi),A(()=>this._view.navigation.gamepad.device,t=>{this._cameraControllerGamepad&&t&&this._cameraControllerGamepad.gamepadDevice!==t&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const r=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(r||co.activatesFor(this._view,e.data)){if(!r){const s=new co({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(s)&&(this._cameraControllerGamepad=s)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var vr;(function(i){i[i.LEFT=0]="LEFT",i[i.RIGHT=1]="RIGHT",i[i.FORWARD=2]="FORWARD",i[i.BACKWARD=3]="BACKWARD",i[i.UP=4]="UP",i[i.DOWN=5]="DOWN",i[i.HEADINGLEFT=6]="HEADINGLEFT",i[i.HEADINGRIGHT=7]="HEADINGRIGHT",i[i.TILTUP=8]="TILTUP",i[i.TILTDOWN=9]="TILTDOWN",i[i.ZOOMIN=10]="ZOOMIN",i[i.ZOOMOUT=11]="ZOOMOUT"})(vr||(vr={}));let lE=class extends Is{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Re.Local},this._keyToNumber={[t.left]:vr.LEFT,[t.right]:vr.RIGHT,[t.forward]:vr.FORWARD,[t.backward]:vr.BACKWARD,[t.up]:vr.UP,[t.down]:vr.DOWN,[t.headingLeft]:vr.HEADINGLEFT,[t.headingRight]:vr.HEADINGRIGHT,[t.tiltUp]:vr.TILTUP,[t.tiltDown]:vr.TILTDOWN,[t.zoomIn]:vr.ZOOMIN,[t.zoomOut]:vr.ZOOMOUT},this.registerIncoming("key-down",null,r=>this._handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this._handleKeyUp(r)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=kT(r=>r?null:this._handleStop())}onUninstall(){var e;(e=this._visibilityHandle)==null||e.remove(),this._handleStop()}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];t!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new co({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleStop(){var e;(e=this._cameraControllerKeyboard)!=null&&e.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];t!=null&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}},cE=class extends Is{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",t,r=>this._handleMouseWheel(r))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new Fu({view:this._view,mode:"interaction"}):new Vu({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,qt(t.x,t.y)),e.preventDefault(),e.stopPropagation()}},Uu=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},To=class extends yh{constructor(){super(...arguments),this._beginCamera=new Ct,this._elapsedTimeSec=0,this.constraintOptions=new ts(ht.ALL,Oe.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Nl}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Ut(this.view,t,this.constraintOptions)}};To=h([F("esri.views.3d.state.controllers.momentum.MomentumController")],To);let Qc=class extends To{constructor(e){super(e),this.interactionType=Oe.PAN,this._tmpPan=v()}momentumStep(e,t){const r=this.momentum.value(e);re(this._tmpPan,this.momentum.direction,r),t.eye=ve(R1,t.eye,this._tmpPan),t.center=ve(R1,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};h([p({constructOnly:!0})],Qc.prototype,"momentum",void 0),Qc=h([F("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Qc);const R1=v(),hE=v(),dd=v();let Gd=class extends To{constructor(e){super(e),this.interactionType=Oe.PAN}momentumStep(e,t){const r=this.momentum.value1(e),s=this.momentum.value2(e);le(dd,t.eye),oe(dd,dd),dt(this.momentum.axis2,dd,this.momentum.axis1),qx(t,hE,this.momentum.axis1,r,this.momentum.axis2,s)}};h([p({constructOnly:!0})],Gd.prototype,"momentum",void 0),Gd=h([F("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Gd);let no=class extends To{set center(e){this._set("center",Hn(e))}set axis(e){this._set("axis",Hn(e))}constructor(e){super(e),this.interactionType=Oe.TUMBLE}momentumStep(e,t){const r=this.momentum.value(e);Oa(t,this.center,vh(this.axis,r))}};h([p({constructOnly:!0})],no.prototype,"momentum",void 0),h([p({constructOnly:!0})],no.prototype,"center",null),h([p({constructOnly:!0})],no.prototype,"axis",null),no=h([F("esri.views.3d.state.controllers.momentum.MomentumController")],no);let gl=class extends To{set zoomCenter(e){this._set("zoomCenter",Hn(e))}constructor(e){super(e),this.interactionType=Oe.ZOOM,this.constraintOptions.interactionDirection=v()}momentumStep(e,t){const{interactionDirection:r}=this.constraintOptions;if(!r)return;le(r,t.eye);const s=this.momentum.valueDelta(0,e);Ng(t,this.zoomCenter,s,this.view.state.constraints.minimumPoiDistance),Wu(r,t.eye,r)}};h([p({constructOnly:!0})],gl.prototype,"momentum",void 0),h([p({constructOnly:!0})],gl.prototype,"zoomCenter",null),gl=h([F("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],gl);let Za=class extends To{set screenCenter(e){this._set("screenCenter",qt(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Hn(e))}constructor(e){super(e),this.interactionType=Oe.ZOOM,this.radius=0,this._tmpSceneCenter=v(),this._tmpZoomAxisAngle=lp(),this._sphere=Ds()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const r=this.momentum.valueDelta(0,e);Ix(this._sphere,t,r),this.constraintOptions.interactionType=Oe.ZOOM,Ut(this.view,t,this.constraintOptions),bh(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Lg(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Oa(t,At(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Oe.PAN}};h([p({constructOnly:!0})],Za.prototype,"momentum",void 0),h([p({constructOnly:!0})],Za.prototype,"screenCenter",null),h([p({constructOnly:!0})],Za.prototype,"sceneCenter",null),h([p({constructOnly:!0})],Za.prototype,"radius",void 0),Za=h([F("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Za);let O1=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const E1=1e-5;let dE=class extends jS{constructor(e,t,r,s,n,a=0,o){super(e,t,r),this._angularVelocity1=s,this.axis1=n,this.angularVelocity2=a,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},uE=class{constructor(e=300,t=12,r=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=r,this.enabled=!0,this._tmpAxis1=v(),this._tmpAxis2=v(),this._tmpAngles=Di(),this._time=new Op(.3),this._screen=[new Op(.4),new Op(.4)],this._angle1=new O1(.6),this._angle2=new O1(.6),this._axis1=v(),this._axis2=v(),this._lastScene=v()}addMomentumDirectRotation(e,t,r,s,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;let o=Ux(this._lastScene,t,this._tmpAxis2,s,n,a);this._angle2.update(0),xs(this._tmpAxis2)<E1?o=0:oe(this._axis1,this._tmpAxis2),this._angle1.update(o),le(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}addMomentumPreserveHeading(e,t,r,s,n,a,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;zx(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,s,n,a,o,!1),xs(this._tmpAxis2)<E1?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),oe(this._axis1,this._tmpAxis1),oe(this._axis2,this._tmpAxis2)),le(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=e==null||t==null?null:Math.sqrt(e*e+t*t),s=this._time.filteredDelta,n=r==null||s==null?0:r/s;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,t,r){const s=this._time.filteredDelta,n=this._angle1.filteredValue,a=this._angle2.filteredValue,o=s==null||a==null?0:a/s;return new dE(e,t,r,s==null||n==null?0:n/s,this._axis1,o,this._axis2)}},v_=class extends en{constructor(){super(...arguments),this._smoothRotation=new Uu(.05),this._rotationAxis=v(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Co(),this._beginRadius=0,this._smoothScaling=new Uu(.05),this._zoomCenterScreen=qt(),this._zoomMomentumEstimator=new Lb,this._rotationMomentumEstimator=new Ib,this._panSphericalMomentumEstimator=new uE,this._panPlanarMomentumEstimator=new Nb,this._adjustedSphere=Ds(),this._tmp3d=v(),this._tmpScreenPointArray=qt(),this._beginScreenPoint=qt(),this._beginScenePoint=v(),this._screenPickPoint=qt(),this._scenePickPoint=v(),this._mode=gi.Horizontal,this._sphere=Ds(),this._pointerCount=0,this._tmpInteractionDirection=v(),this._beginCamera=new Ct,this._constraintOptions=new ts(ht.ALL,Oe.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-Pa.normalize(Wt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),An(e.center,this._screenPickPoint),Ca(this._beginScreenPoint,this._screenPickPoint);const t=bt(this.view.spatialReference),r=Fx(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,Vl.Silhouette,this.view.map.ground.opacity===0?Eo:{});r.scenePickPoint!=null&&(this._scenePickPoint=r.scenePickPoint,this._sphere=r.sphere,le(this._beginScenePoint,this._scenePickPoint),this._mode=hp(this.startCamera,this._screenPickPoint,t),this._mode===gi.Vertical&&this._preparePlanarPanMode(e,r.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._mode===gi.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._mode===gi.Horizontal?new Za({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new gl({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new no({view:this.view,momentum:r,center:At(this._sphere),axis:this._rotationAxis});if(this._mode===gi.Horizontal){const s=this._panSphericalMomentumEstimator.evaluateMomentum();if(s)return new Gd({view:this.view,momentum:s})}else{const s=this._panPlanarMomentumEstimator.evaluateMomentum();if(s)return new Qc({view:this.view,momentum:s})}return null}_preparePlanarPanMode(e,t){const r=rn(this._tmp3d,this.startCamera.viewForward);Ab(this._scenePickPoint,r,this._panningPlane);const s=qt(this._screenPickPoint[0],0),n=v(),a=we(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],bh(this._adjustedSphere,this.startCamera,s,n);const o=Oh();this.startCamera.projectToRenderScreen(n,o);const l=v(),c=v(),d=v();ve(l,this._scenePickPoint,this.currentCamera.eye);const u=we(l);oe(l,l);const m=$x*Math.max(Math.abs(this.view.camera.position.z),Lx),_=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,cp);let f=_??m;f=t?Math.min(f,u):f,le(d,fe(c,this.currentCamera.eye,re(c,l,f))),this._panningPlane[3]=-pe(ks(this._panningPlane),d),this.startCamera.center=fe(c,this.startCamera.eye,re(c,this.startCamera.viewForward,f));const y=An(e.center,this._tmpScreenPointArray);g_(this._panningPlane,this.startCamera,y,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),Ix(this._sphere,this.currentCamera,this._smoothScaling.value),An(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.interactionFactor=bs(e.radius-this._beginRadius),Ut(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=An(e.center,this._tmpScreenPointArray);bh(this._sphere,this.currentCamera,t,this._tmp3d),Fg(this._beginScenePoint,pe(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(Hx(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(Bx(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.interactionFactor=bs(hh(this._screenPickPoint,t)),Ut(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){oe(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||rn(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,r=t+__(e.angle-t),s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Oa(this.currentCamera,At(this._sphere),vh(this._rotationAxis,n)),this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.interactionFactor=bs(e.radius*r),Ut(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=An(e.center,this._tmpScreenPointArray);g_(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Vx(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.interactionFactor=bs(hh(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Ut(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Ng(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.interactionFactor=bs(e.radius-this._beginRadius),Ut(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){le(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||rn(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let r=e.angle-t;r=__(r);const s=t+r,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(s);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),Oa(this.currentCamera,At(this._sphere),vh(this._rotationAxis,a)),this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.interactionFactor=bs(e.radius*a),Ut(this.view,this.currentCamera,this._constraintOptions)}};v_=h([F("esri.views.3d.state.controllers.global.PinchAndPanController")],v_);const A1=It(0,0,1),pE={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI};let b_=class extends en{constructor(){super(...arguments),this._rotationValueSmooth=new Uu(.05),this._scalingValueSmooth=new Uu(.05),this._planeHorizontal=Co(),this._planeVertical=Co(),this._rotationMomentumEstimator=new Ib,this._panMomentumEstimator=new Nb(300,12,.9),this._zoomMomentumEstimator=new Lb,this._beginRadius=0,this._beginCenter=v(),this._beginAngle=0,this._tmpPoints=[],this._panMode=gi.Horizontal,this._beginCenterScreen=qt(),this._tmpCentroid3d=v(),this._tmpCentroid2d=qt(),this._tmp2d=qt(),this._pointerCount=0,this._beginCamera=new Ct,this._constraintOptions=new ts(ht.ALL,Oe.NONE,0,this._beginCamera)}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),An(e.center,this._beginCenterScreen),Eb(A1,0,this._planeHorizontal);const r=v(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,r,this.view.map.ground.opacity===0?Eo:{}),n=v();rn(n,this.startCamera.viewForward);const a=v();le(a,A1);const o=pe(n,a),l=rh(o<0?-o:o);this._panMode=l>=pE.ANGLE_THRESHOLD?gi.Horizontal:gi.Vertical;const c=Math.min($x,1/Math.abs(pe(a,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),Lx);x0(this._planeHorizontal,this._planeHorizontal,r),this.startCamera.aboveGround||wS(this._planeHorizontal,this._planeHorizontal);const d=v(),u=v(),m=v();ve(d,r,this.currentCamera.eye);const _=we(d);if(oe(d,d),this._panMode===gi.Vertical){re(a,a,o),ve(ks(this._planeVertical),n,a),oe(ks(this._planeVertical),ks(this._planeVertical)),x0(this._planeVertical,this._planeVertical,r);const f=this.view._stage.renderView.getMinimalDepthForArea(xh(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,cp);let y=f??c;y=s?Math.min(y,_):y,le(m,fe(u,this.currentCamera.eye,re(u,d,y))),this._planeVertical[3]=-pe(ks(this._planeVertical),m),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),Bp(this._tmpPoints,this._beginCenter)}else{const f=s?_:c;le(m,fe(u,this.currentCamera.eye,re(u,d,f))),this._planeHorizontal[3]=-pe(ks(this._planeHorizontal),m),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),Bp(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,r=this._panMode===gi.Horizontal?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(t){const n=this._beginRadius/e.radius,a=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=a,this._scalingValueSmooth.update(n),Ng(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Oe.ZOOM,this._constraintOptions.interactionFactor=bs(Math.abs(e.radius-this._beginRadius)),Ut(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,r,this.currentCamera,this._tmpPoints),Bp(this._tmpPoints,this._tmpCentroid3d),An(e.center,this._tmpCentroid2d),Vx(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Oe.PAN,this._constraintOptions.interactionFactor=bs(hh(this._beginCenterScreen,this._tmpCentroid2d)),Ut(this.view,this.currentCamera,this._constraintOptions),t){const n=s,a=this._rotationValueSmooth.value,o=a+__(e.angle-a),l=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=l,this._rotationValueSmooth.update(o);const c=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(c,.001*e.timestamp);const d=ks(this._planeHorizontal);Oa(this.currentCamera,n,vh(d,c)),this._constraintOptions.interactionType=Oe.TUMBLE,this._constraintOptions.interactionFactor=bs(Math.abs(e.radius*c)),Ut(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new gl({view:this.view,momentum:t,zoomCenter:this._beginCenter});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new no({view:this.view,momentum:r,center:this._beginCenter,axis:ks(this._planeHorizontal)});const s=this._panMomentumEstimator.evaluateMomentum();return s?new Qc({view:this.view,momentum:s}):null}_computePlanePoints(e,t,r,s){s.length=e.size;const n=this._tmp2d;let a=0;return e.forEach(o=>{n[0]=o.x,n[1]=o.y,s[a]===void 0&&(s[a]=v()),g_(t,r,n,s[a]),a+=1}),s}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};b_=h([F("esri.views.3d.state.controllers.local.PinchAndPanController")],b_);let M1=class extends Is{constructor(e,t,r){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!X_(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,r=40,s=this._momentum&&this._momentum.active&&t<r;switch(e.data.action){case"start":case"update":if(s)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new v_({view:this._view}):new b_({view:this._view})}},mE=class extends Is{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}},Wx=class extends Is{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,r=>this._handleKeyDown(r))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}},_E=class extends Wx{constructor(e,t,r){super(t,r),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}},gE=class extends Wx{constructor(e,t,r){super(t,r),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}},fE=class extends Is{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",r=>this._handleTwoFinger(r))}_handleTwoFinger(e){var s,n,a;const t=this._invert?-1:1,r=qt(0,e.data.delta*t);switch(e.data.action){case"begin":(s=this._cameraController)==null||s.end(),this._cameraController=new Wc({view:this._view,pivot:Cr.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":(n=this._cameraController)==null||n.update(r);break;case"end":(a=this._cameraController)==null||a.end(),this._cameraController=null}}},yE=class extends Is{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new jT({start:(r,s)=>this._observeStart(r,s),update:(r,s,n)=>this._observeUpdate(r,s,n),end:(r,s)=>this._observeEnd(s)}),this.registerIncoming("drag",r=>this._dragEventSeparator.handle(r))}get failed(){return this._state==="failed"}_observeStart(e,t){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,t,r){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,r.data)?this._checkVerticalThresholdReached(t.data,r.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let r=-1/0,s=1/0,n=-1/0,a=1/0;for(const{x:y,y:b}of t.pointers.values())r=Math.max(r,y),s=Math.min(s,y),n=Math.max(n,b),a=Math.min(a,b);let o=-1/0,l=1/0,c=-1/0,d=1/0;for(const{x:y,y:b}of e.pointers.values())o=Math.max(o,y),l=Math.min(l,y),c=Math.max(c,b),d=Math.min(d,b);const u=r-s,m=n-a,_=o-l,f=c-d;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(_-u)<=this._maxDelta&&Math.abs(f-m)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let r=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((s,n)=>{const a=t.pointers.get(n);r=Math.min(r,Math.abs(s.y-a.y))}),r>=this._threshold}},ls=class extends Pe{destroy(){this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get updating(){var e;return!!((e=this._inputManager)!=null&&e.updating)}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}get multiTouchActive(){var e;return((e=this._inputManager)==null?void 0:e.multiTouchActive)??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=te(this._inputManager)}connect(){const e=this.view;this._source=new WT(this.view.surface,e.input);const t=[new QT,new ZT,new XT,new YT(this.view.navigation),new yE],r=new PS({eventSource:this._source,recognizers:t});this._inputManager=r,r.installHandlers("prevent-context-menu",[new KT],P0.INTERNAL),this._modeDragPan=new M1(e,"primary"),this._modeDragRotate=new Zp(e,"secondary",Cr.CENTER),this._modeDragZoom=new J4(e,"tertiary");const s={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};r.installHandlers("navigation",[new mE(e),new U4(e),new oE(e),new lE(e,s.pan),new cE(e),new gE(e,s.resetTilt),new _E(e,s.resetHeading),new Zp(e,"primary",Cr.EYE,[s.lookAround]),new Zp(e,"secondary",Cr.CENTER,[s.lookAround]),new M1(e,"tertiary",[s.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new fE(e)],P0.INTERNAL),this.view.viewEvents.connect(r),this._updateMode(),this.addHandles(A(()=>{var n;return(n=this.view.navigation)==null?void 0:n.browserTouchPanEnabled},n=>{this._source.browserTouchPanningEnabled=!n},oi))}isModifierKeyDown(e){var t;return((t=this._inputManager)==null?void 0:t.isModifierKeyDown(e))??!1}_updateMode(){var s;const e=this.mode,t=this.primaryDragAction,r=(s=x_.get(e))==null?void 0:s.get(t);r&&(this._modeDragPan&&(this._modeDragPan.pointerAction=r.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=r.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=r.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};h([p()],ls.prototype,"view",void 0),h([p({value:"pan"})],ls.prototype,"primaryDragAction",null),h([p({value:"default"})],ls.prototype,"mode",null),h([p({readOnly:!0})],ls.prototype,"updating",null),h([p()],ls.prototype,"latestPointerType",null),h([p()],ls.prototype,"latestPointerLocation",null),h([p()],ls.prototype,"multiTouchActive",null),h([p()],ls.prototype,"_inputManager",void 0),ls=h([F("esri.views.3d.input.SceneInputManager")],ls);const x_=new Map,Xp=new Map,Yp=new Map;Xp.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Xp.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Yp.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Yp.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),x_.set("default",Xp),x_.set("pro",Yp);const vE=ls;let Mr,Ml,w_=!1,C_=!1,T_=!1,P_=!1,Zc=null;function bE(i,e){if(!C_||!Ml)return;Qx();const t=Ml;let r=0;for(let s=0;s<i.accBinsNumX;s++)for(let n=0;n<i.accBinsNumY;n++){const a=i.accBins[s][i.accBinsNumY-1-n];r+=a.length;const o=s*i.accBinsSizeX,l=(s+1)*i.accBinsSizeX,c=n*i.accBinsSizeY,d=(n+1)*i.accBinsSizeY;t.fillText(a.length.toFixed(),o+5,c+15),Zx(o,l,c,d,"blue")}t.fillText("total totalShownLabels: "+r,70,40),t.fillText("total visible labels: "+e.size,70,50),t.fillText("total numTests: "+i.accNumTests,70,30)}function xE(i){T_=dr.DECONFLICTOR_SHOW_VISIBLE,P_=dr.DECONFLICTOR_SHOW_INVISIBLE,w_=T_||P_,C_=dr.DECONFLICTOR_SHOW_GRID,Zc=null,w_||C_?Zc=()=>wE(i):Mr&&(Mr.parentElement.removeChild(Mr),Mr=null)}function Qx(){Zc&&(Zc(),Zc=null)}function wE(i){Mr==null&&(Mr=document.createElement("canvas"),Mr.setAttribute("id","debugCanvas2d"),i.surface.parentElement.style.position="relative",i.surface.parentElement.appendChild(Mr));const{state:e}=i,{camera:t,pixelRatio:r}=e,{width:s,height:n}=t,a=s*r,o=n*r;Mr.setAttribute("width",`${a}px`),Mr.setAttribute("height",`${o}px`),Mr.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${n}px`),Ml=Mr.getContext("2d"),Ml.clearRect(0,0,s,n),Ml.font="12px Arial"}function Zx(i,e,t,r,s){Qx();const n=Mr.height,a=Ml;a.beginPath(),a.lineWidth=1,a.strokeStyle=s,a.moveTo(i,n-t),a.lineTo(e,n-t),a.stroke(),a.lineTo(e,n-r),a.stroke(),a.lineTo(e,n-t),a.stroke(),a.lineTo(i,n-t),a.stroke(),a.lineTo(i,n-t),a.stroke(),a.closePath()}function CE(i,e){w_&&(e&&T_||!e&&P_)&&Zx(i.aabr[0],i.aabr[2],i.aabr[1],i.aabr[3],e?"green":"red")}const Fs=v(),qo=_i(),lc=_i(),Kp=v(),TE=ct(),PE=Ds(),Jp=jl(),SE=v(),RE=ci();class OE{constructor(){this.aabr=ci(),this.distance=0,this.culled=!1,this.visible=!1}}class EE{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var br;(function(i){i[i.Idle=0]="Idle",i[i.Process=1]="Process",i[i.Sort=2]="Sort",i[i.Deconflict=3]="Deconflict",i[i.NumStates=4]="NumStates"})(br||(br={}));class AE{constructor(){this.camera=new Ct,this.slicePlane=Yu(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Z_(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let fl=class extends Pe{get dirty(){return this._dirty}get state(){return this._state}constructor(i){super(i),this._dirty=!1,this._viewState=new AE,this._state=br.Idle,this._active=new Map,this._visible=new Map,this._iterators=new LE,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==br.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const i=this._state/br.NumStates;return this._dirty?.5*i:i}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(i){switch(this._state){case br.Idle:this._startUpdate(),i.madeProgress();case br.Process:if(this._state=br.Process,!this._processActiveGraphics(i))return;case br.Sort:if(this._state=br.Sort,!this._sortVisibleGraphics(i))return;case br.Deconflict:if(this._state=br.Deconflict,!this._deconflictVisibleGraphics(i))return;default:bE(this,this._visible),this._state=br.Idle,this.notifyChange("updating")}}modifyGraphics(i,e){e?i.forEach(t=>this.addToActiveGraphics(t)):i.forEach(t=>this.removeFromActiveGraphics(t)),this.setDirty()}layerSupportsDeconfliction(i){if(i==null||i.type!=="object3d")return!1;const e=i.stageObject;if(((e==null?void 0:e.geometries.length)??0)!==1)return!1;const t=e==null?void 0:e.geometries[0];return(t==null?void 0:t.material)instanceof Fb}_startUpdate(){xE(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:e}=this._viewState.camera;this._initBins(i,e),this._resetIterators()}addToActiveGraphics(i){i.info[this.visibilityGroup]=new OE,this._active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty()}removeFromActiveGraphics(i){this._visible.delete(i.graphics3DGraphic.graphic.uid),ME(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this._active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(i){const e=this._ensureActiveGraphicsIterator(),t=ku(TE,this._viewState.camera.projectionMatrix),r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._viewState.camera.relativeElevation>0?PE:null;let s=0;for(r!=null&&(Xt(At(r),Fn,this._viewState.camera.viewMatrix),r[3]=bt(this.view.spatialReference).radius,s=dS(r,Fn));!i.done;){i.madeProgress();const n=e.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const a=n.value,o=a==null?void 0:a.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(a,t,r,s),o.culled?this._visible.delete(a.graphics3DGraphic.graphic.uid):this._visible.set(a.graphics3DGraphic.graphic.uid,a))}return!1}_sortVisibleGraphics(i){const e=this._ensureSortGraphicsIterator();for(;!i.done;){const t=e.next();if(i.madeProgress(),t.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(i){const e=this._ensureVisibleGraphicsIterator(),t=this.visibilityGroup===Qr.LABEL;for(;!i.done;){i.madeProgress();const r=e.next();if(r.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,n=s.info[this.visibilityGroup];if(!n||n.culled){this._setGraphicVisibility(s,!1);continue}const a=s.graphics3DGraphic,o=!t||a.isVisible();n.visible=o&&!this._isConflicted(s),n.visible&&this._addToBins(s),this._setGraphicVisibility(s,n.visible),CE(n,n.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=D1(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=D1(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=DE(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(i,e,t,r){const s=i.graphics3DGraphic;if(s.destroyed)return;const n=i.info[this.visibilityGroup];if(!s.isVisible(Qr.GRAPHIC,ws.DECONFLICTION))return void(n.culled=!0);const a=this.getGraphicsLayers(s);ln(n.aabr);let o=null;for(const l of a){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometries[0].material;if(o==null&&(o=FE,this._getProjectionInfo(l,e,o),o.isOutsideScreen||this._isCulledBySlice(i,Fs)||t!=null&&this._isCulledByHorizon(o,t,r)))return void(n.culled=!0);this._expandBoundingRect(n,l,c,o)}o==null?n.culled=!0:(n.distance=o.distance,n.culled=!1)}_getProjectionInfo(i,e,t){const r=this._viewState.camera,s=i.stageObject,n=s.geometries[0],a=n.material,o=At(s.boundingVolumeWorldSpace.bounds);Xt(Fs,o,r.viewMatrix);const l=n.attributes,c=l.get(ae.NORMAL).data,d=l.get(ae.CENTEROFFSETANDDISTANCE).data;a.applyShaderOffsetsView(Fs,c,s.transformation,d,r,t.scaleInfo,Fs),xa(qo,Fs[0],Fs[1],Fs[2],1),Fm(lc,qo,r.projectionMatrix),re(t.positionNDC,lc,1/lc[3]),a.applyShaderOffsetsNDC(t.positionNDC,d,r,t.positionNDC,Kp),t.distanceWithoutPolygonOffset=r.depthNDCToWorld(Kp[2]),t.distance=Kp[2]===t.positionNDC[2]?t.distanceWithoutPolygonOffset:r.depthNDCToWorld(t.positionNDC[2]),xa(lc,t.positionNDC[0],t.positionNDC[1],t.positionNDC[2],1),Fm(qo,lc,e),$v(qo,qo,1/qo[3]),Ie(t.positionView,Fs[0],Fs[1],Fs[2])}_isCulledByHorizon(i,e,t){return le(Jp.direction,i.positionView),Ie(Jp.origin,0,0,0),!!rp(e,Jp,SE)&&i.distanceWithoutPolygonOffset>t}_isCulledBySlice(i,e){return i.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&FT(this._viewState.slicePlane,e)}_expandBoundingRect(i,e,t,{positionNDC:r,scaleInfo:s}){const n=this._viewState.camera,a=e.getScreenSize(IE);vP(a,s.factor,a),a[0]*=n.pixelRatio,a[1]*=n.pixelRatio;const o=Lv(t.calculateRelativeScreenBounds(a,s.factorAlignment.scale,RE),He(0,n.fullWidth,.5+.5*r[0]),He(0,n.fullHeight,.5+.5*r[1])),l=this.marginFactor;if(l!==0){const c=l*Math.min(eo(o),nh(o));o[0]-=c,o[1]-=c,o[2]+=c,o[3]+=c}_a(i.aabr,o,i.aabr)}_isConflicted(i){const e=i.graphics3DGraphic.graphic.uid,t=i.info[this.visibilityGroup];let r=!0;for(let s=Math.floor(t.aabr[0]/this._accBinsSizeX);s<=Math.floor(t.aabr[2]/this._accBinsSizeX);s++)if(!(s<0||s>=this._accBinsNumX))for(let n=Math.floor(t.aabr[1]/this._accBinsSizeY);n<=Math.floor(t.aabr[3]/this._accBinsSizeY);n++){if(n<0||n>=this._accBinsNumY)continue;r=!1;const a=this._accBins[s][n];for(let o=0;o<a.length;o++){const l=a.data[o],c=l.info[this.visibilityGroup];if(c&&c.visible&&l.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,Zu(c.aabr,t.aabr)))return!0}}return r}_initBins(i,e){if(this._accBins==null){this._accBins=[];for(let t=0;t<this._accBinsNumX;t++){this._accBins.push([]);const r=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)r.push(new xt)}}else for(let t=0;t<this._accBinsNumX;t++)for(let r=0;r<this._accBinsNumY;r++)this._accBins[t][r].clear();this._accBinsSizeX=i/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(i){const e=i.info[this.visibilityGroup],t=Math.floor(e.aabr[0]/this._accBinsSizeX),r=Math.floor(e.aabr[2]/this._accBinsSizeX),s=Math.floor(e.aabr[1]/this._accBinsSizeY),n=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let a=t;a<=r;a++)if(!(a<0||a>=this._accBinsNumX))for(let o=s;o<=n;o++)o<0||o>=this._accBinsNumY||this._accBins[a][o].push(i)}_setGraphicVisibility(i,e){const t=i.graphics3DGraphic;t.destroyed||(t.setVisibilityFlag(this.visibilityGroup,ws.DECONFLICTION,e),this.visibilityGroup===Qr.LABEL&&this.view.labeler.setLabelGraphicVisibility(t,e))}};function ME(i,e){const t=i.graphics3DGraphic;t.destroyed||t.setVisibilityFlag(e,ws.DECONFLICTION,!0)}function*D1(i){if(Map.prototype.entries){const e=i.entries();for(let t=e.next();!t.done;t=e.next())yield t.value[1]}else yield*i.values()}function*DE(i,e,t){e.clear(),i.forEach((s,n)=>{var l;const a=e.pushNew();a.id=n,a.visible=s.graphics3DGraphic.getVisibilityFlag(t,ws.DECONFLICTION);const o=(l=s.info)==null?void 0:l[t];a.prio=s.graphics3DGraphic.deconflictionPriority,a.distance=o?o.distance:Number.MAX_VALUE}),yield;const r=e.iterableSort((s,n)=>s.prio!==n.prio?n.prio-s.prio:s.distance!==n.distance?s.distance-n.distance:s.visible!==n.visible?s.visible?-1:1:s.id-n.id);for(let s=r.next();!s.done;s=r.next())yield;e.forAll(s=>{const n=i.get(s.id);n&&(i.delete(s.id),i.set(s.id,n))}),e.clear()}h([p({constructOnly:!0})],fl.prototype,"view",void 0),h([p({type:Boolean,readOnly:!0})],fl.prototype,"updating",null),fl=h([F("esri.views.3d.layers.graphics.Deconflictor")],fl);class $E{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class LE{constructor(e=null,t=null,r=null){this.active=e,this.visible=t,this.sort=r,this.sortArray=new xt({allocator:s=>s||new $E})}}const IE=Di();class NE{constructor(){this.positionView=v(),this.positionNDC=v(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new WS}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}const FE=new NE,VE=2e3;let kd=class extends fl{constructor(e){super(e),this.visibilityGroup=Qr.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Yi;const t=performance.now();if(e.state!==Wi.IDLE&&t-this._lastDeconfliction<VE)return Yi;super.runTask(e),this.state===br.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};h([p({constructOnly:!0})],kd.prototype,"parent",void 0),kd=h([F("esri.views.3d.layers.graphics.LabelDeconflictor")],kd);let S_=class extends fl{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=Qr.GRAPHIC,this._marginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this.addHandles([A(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.state)==null?void 0:t.camera},()=>{this._updateViewState(),this.setDirty()}),A(()=>{var e,t,r;return(r=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:r.opacity},(e,t)=>{e!==1&&t!==1||this.setDirty()}),A(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},oi)]),this._frameTask=this.view.resourceController.scheduler.registerTask(fi.GRAPHICS_DECONFLICTOR,this),this._labels=new kd({view:this.view,parent:this})}destroy(){this._labels=te(this._labels),this._frameTask=Bn(this._frameTask)}get marginFactor(){return this._marginFactor}set marginFactor(e){this._marginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const r=!(this._graphicSupportsDeconfliction(t)&&em(e));t.setVisibilityFlag(Qr.GRAPHIC,ws.DECONFLICTION,r)}_updateViewState(){var e;(e=this.view)!=null&&e.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;e!=null&&VT(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){uu(this._contexts,(e,t)=>t.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:r=>this._addGraphic(e,t,r),removeGraphic:r=>this._removeGraphic(t,r),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(r=>this._removeGraphic(t,r.graphics3DGraphic))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(r=>this._removeGraphic(t,r.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,r){const s=r.graphic.uid,n=new EE(r,e.symbolCreationContext.slicePlaneEnabled);t.set(s,n),em(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&this._labels.addToActiveGraphics(n)}_removeGraphic(e,t){const r=t.graphic.uid,s=e.get(r);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(r),this.setDirty())}enabledChanged(e,t){const r=em(e);r||UE(e),this.modifyGraphics(t,r)}_slicePlaneEnabledChanged(e,t){const r=e.symbolCreationContext.slicePlaneEnabled;t.forEach(s=>s.slicePlaneEnabled=r),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!(t!=null&&t.length))return!1;for(const r of t)if(this.layerSupportsDeconfliction(r))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const r=new Map;return this._contexts.set(e,r),this.setDirty(),r}};function em(i){const e=i.layer;return!(!(e!=null&&e.featureReduction)||e.featureReduction.type!=="selection")}function UE(i){const e=i.graphics3DGraphics;e&&e.forEach(t=>t.setVisibilityFlag(Qr.GRAPHIC,ws.DECONFLICTION,!0))}S_=h([F("esri.views.3d.layers.graphics.GraphicsDeconflictor")],S_);function Ug(i){return i instanceof vT?i.graphics3DSymbol:i instanceof bT?i:null}const wh=()=>de.getLogger("esri.views.3d.layers.graphics.labelPlacement");let zE=class{constructor(e,t,r,s=null){this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=r,this.disablePlacement=s}};function $1(i){const e=ZE(i);if(e==null)return null;const t=qE(i,e);if(t==null)return null;const r=t.anchor,s=!!e.hasLabelVerticalOffset,n=e.verticalOffset;return HE(new xT(n,r,s),t,i)}function qE(i,e){if(e.anchor)return e;const t=i.labelClass.labelPlacement,r=Ss[t],s=r||zu(i);return t&&!r&&wh().warnOncePerTick(`the requested label placement '${t}' is currently unsupported in SceneView.`),BE(s,i)}function zg(i){const e=i.graphics3DGraphic.graphics3DSymbol,t=Ug(e);return t!=null?t.symbol.symbolLayers.at(0):null}function BE(i,e){const t=e.graphics3DGraphic.graphic.geometry;if(t==null)return null;if(e.disablePlacement!=null)return e.labelClass.labelPlacement?(wh().warnOncePerTick(L1(i==null?void 0:i.placement,e.disablePlacement.logEntityDescription)),zu(e)):i;const r=t.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return wh().warnOncePerTick(L1(i==null?void 0:i.placement,`'${r}' geometries`)),zu(e);break;case"point":case"mesh":return i}return i}function L1(i,e){return`the requested label placement '${i}' is currently unsupported for ${e} in SceneView.`}function zu(i){const e=i.graphics3DGraphic.graphic.geometry;if(e==null)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:Fn,anchor:"center"};case"polygon":{const t=zg(i);return t!=null&&t.type==="extrude"?Ss["above-center"]:{placement:"center-center",normalizedOffset:Fn,anchor:"center"}}case"point":case"mesh":return Ss["above-center"];default:return}}function HE(i,e,t){const r=t.graphics3DGraphic.graphic.geometry;if(r==null)return null;switch(r.type){case"point":kE(i,e,t);break;case"polygon":GE(i,e,t);break;case"mesh":qg(i,e,t.graphics3DGraphic.layers[0])}const s=wT-CT;return i.screenOffset[0]+=s*e.normalizedOffset[0],i.screenOffset[1]+=s*e.normalizedOffset[1],i}function GE(i,e,t){const r=zg(t);if(r!=null)switch(r.type){case"extrude":{const s=t.graphics3DGraphic.layers[0];s!=null?(s.getBoundingBoxObjectSpace(Xc),_C(Xc,i.translation),i.translation[2]=gC(Xc)/2):Ie(i.translation,0,0,0),qg(i,e,s);break}}}function kE(i,e,t){const r=zg(t);if(r==null)return;const s=t.graphics3DGraphic.layers[0];switch(s!=null?s.getCenterObjectSpace(i.translation):Ie(i.translation,0,0,0),r.type){case"icon":case"text":jE(i,e,t,s);break;case"object":qg(i,e,s)}}function jE(i,e,t,r){const{graphics3DGraphic:s}=t,n=r!=null?r.getScreenSize():null;if(s.isDraped||n==null)i.hasLabelVerticalOffset||i.anchor==="center"||(Ss[t.labelClass.labelPlacement]&&wh().warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),i.anchor="center");else{const a=WE(t);i.screenOffset[0]=n[0]/2*(e.normalizedOffset[0]-a[0]);const o=n[1]/2*(e.normalizedOffset[1]-a[1]);i.hasLabelVerticalOffset?(i.centerOffset[1]=o,i.centerOffsetUnits="screen"):i.screenOffset[1]=o}}function WE(i,e=XE){const{graphics3DGraphic:t}=i,r=t.layers[0],s=(r==null?void 0:r.stageObject.geometries[0].material)??null;if(s&&s instanceof Fb){const n=s.parameters.anchorPosition;e[0]=2*(n[0]-.5),e[1]=2*(n[1]-.5)}else e[0]=0,e[1]=0;return e}function qg(i,e,t){const r=t!=null?t.getBoundingBoxObjectSpace(Xc):Xc,s=It(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);i.centerOffset[0]=n/2*e.normalizedOffset[0];const a=i.translation[2],o=s[2]/2*e.normalizedOffset[1];i.translation[2]=0,i.elevationOffset=a+o;const l=we(s);i.centerOffset[2]=l/2*e.normalizedOffset[2]}function QE(i){return i==="above-center"}function ZE(i){const e=i.labelClass.labelPlacement,{labelSymbol:t,graphics3DGraphic:r}=i,s=Ug(r.graphics3DSymbol),n=(s==null?void 0:s.symbol.type)==="point-3d"?s.symbol:null,a=Ss[e]||zu(i);return n!=null&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:I1(n.verticalOffset),anchor:null,normalizedOffset:null}:!t||!t.hasVisibleVerticalOffset()||n!=null&&n.supportsCallout()&&n.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:a&&QE(a.placement)?{placement:"above-center",verticalOffset:I1(t.verticalOffset),anchor:"bottom",normalizedOffset:[0,a.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(wh().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}function I1(i){const{screenLength:e,minWorldLength:t,maxWorldLength:r}=i;return{screenLength:e,minWorldLength:t,maxWorldLength:r}}const Ss={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},N1={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const i in N1){const e=N1[i],t=Ss[i];e.forEach(r=>{Ss[r]=t})}Object.freeze&&(Object.freeze(Ss),Object.keys(Ss).forEach(i=>{var e;Object.freeze(Ss[i]),Object.freeze((e=Ss[i])==null?void 0:e.normalizedOffset)}));const XE=[0,0],Xc=Xu();let F1=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}},V1=class{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},YE=class{constructor(e,t,r,s,n){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=r,this.textRenderParameters=s,this.labelFunction=n,this.calloutSymbolLayerIndex=0}},KE=class{constructor(e,t,r,s,n,a,o,l){this.layer=t,this.graphics3DCore=r,this.scaleVisibility=s,this.emptySymbolLabelSupported=n,this.elevationInfoOverride=a,this.disablePlacement=o,this.active=l,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new MP(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}},Xa=class extends Pe{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([A(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),A(()=>{var e;return(e=this.view.state)==null?void 0:e.rasterPixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(fi.LABELER,this)]),this._textTextureAtlas=new Hf({view:this.view}),this._hudMaterialCollection=new F1(this.view._stage),this._calloutMaterialCollection=new F1(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=Ae(this._textTextureAtlas),this._hudMaterialCollection=Ae(this._hudMaterialCollection),this._calloutMaterialCollection=Ae(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),ss.graphic=null,ss.renderingInfo=null,ss.layer=null}_activateLabelingContext(e){e.graphics.forEach((t,r)=>{const s=new V1(e,t);this._labels.set(r,s),e.labelsToInitialize.set(r,s),t.setVisibilityFlag(Qr.LABEL,ws.USER,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((t,r)=>{t.setVisibilityFlag(Qr.LABEL,ws.USER,!1),this.setLabelGraphicVisibility(t,!1),t.clearLabelGraphics(),this._labels.delete(r)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const r=e.textRenderers[t._labelIndex];r&&(this._textTextureAtlas.addTextTexture(r,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const r=e.textRenderers[t._labelIndex];r!=null&&(this._textTextureAtlas.removeTextTexture(r,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Yi}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(tm(t))this._dirty=!0;else if(im(t.labelClassContexts)){if(t.labelClassContexts===null){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else uu(t.labelsToInitialize,(r,s)=>(this._ensureGraphics3DResources(r)&&(this._labels.set(s,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(s),e.madeProgress()),e.done))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var a,o;const t=(a=e.labelClassAbortController)==null?void 0:a.signal;e.layer.when&&await e.layer.when(),Tr(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const r=e.graphics3DCore,s=r.layer,n=(o=s.labelingInfo)==null?void 0:o.filter(l=>!!l.symbol);!n||n.length===0||(await fC(n,async(l,c)=>{const d=l.symbol,u=Ug(r.getOrCreateGraphics3DSymbol(d));if(u==null)return void de.getLogger(this).error("Failed to create Graphics3DSymbol for label");await u.load(),Tr(t);let m=null;yC(d)&&d.hasVisibleCallout()&&(m=TT(d,r.symbolCreationContext),await m.load(),Tr(t));const _=await vC(ZS(l,e.layer.fieldsIndex,this.view.spatialReference));if(Tr(t),_.ok===!0){const f=await this._createTextRenderParameters(u.symbol);Tr(t),e.labelClassContexts[c]=new YE(l,u,m,f,_.value)}else de.getLogger(this).error(`Label expression failed to evaluate: ${_.error}`)}),Tr(t))}async _createLabelClassContext(e){return e.labelClassPromise==null&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(fo(t))throw t;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return(t==null?void 0:t.type)!=="text"?null:PT.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const r of e.labelClassContexts)--r.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,So(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,r,s,n,a){const o=new ST(r,Gf(r.anchor),RT(r.anchor),e.text,Ju(e.displayWidth,e.displayHeight));return ss.graphic=t,ss.renderingInfo=null,ss.layer=s,n.createLabel(ss,o,this._hudMaterialCollection,this._textTextureAtlas,()=>{const l=$1(a);return l?l.elevationOffset:null})}_createLineCalloutGraphic(e,t,r,s,n){ss.graphic=e,ss.layer=n;const a=s.screenOffset[0];return ss.renderingInfo=new OT(null,t,s.translation,s.centerOffset,a,s.centerOffsetUnits,s.elevationOffset,this._calloutMaterialCollection),r.createGraphics3DGraphic(ss)}_ensureGraphics3DResources(e){var c;if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const r=e.labelingContext,s=r.labelClassContexts;if(im(s)||!r.emptySymbolLabelSupported&&t.layers.length===0)return!1;let n=!1;const a=t.graphic,o=r.layer,l=ud(r.layer);for(let d=0;d<s.length;d++){const u=e.textRenderers[d],m=e.textLabelPlacements[d];if(u==null||m==null)continue;const _=s[d],f=_.graphics3DSymbol,y=f.symbol&&f.symbol.type==="label-3d"?f.symbol:null,b=f.symbolLayers[0];if(!b)continue;b.setElevationInfoOverride(r.elevationInfoOverride);const x=new zE(t,y,_.labelClass),w=this._createTextSymbolGraphic(u,a,m,o,b,x);if(w==null)return!1;w._labelClass=_.labelClass,w._labelIndex=d,t.addLabelGraphic(w,r.stageLayer),t.deconflictionPriority=((c=_.textRenderParameters)==null?void 0:c.definition.size)??0,t.setVisibilityFlag(Qr.LABEL,ws.USER,l),t.setVisibilityFlag(Qr.LABEL,ws.SCALE_RANGE,!0),t.setVisibilityFlag(Qr.LABEL,ws.DECONFLICTION,!1),n=!0;const C=_.graphics3DCalloutSymbolLayer;if(C&&m.hasLabelVerticalOffset){C.setElevationInfoOverride(r.elevationInfoOverride);const T=this._createLineCalloutGraphic(a,y,C,m,o);T!=null&&(_.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(T,r.stageLayer))}break}return r.scaleVisibility&&n&&r.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const r of e.graphics3DGraphic.labelLayers){if(r._labelClass==null)continue;const s=t[r._labelIndex].graphics3DSymbol.symbolLayers[0];s==null||s.onRemoveGraphic(r)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){var n;if(e.textInitialized)return;const t=e.labelingContext,r=t.labelClassContexts;if(im(r))return;const s=e.graphics3DGraphic.graphic;for(let a=0;a<r.length;a++){const o=r[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,(o==null?void 0:o.textRenderParameters)==null)continue;const l=o.labelFunction;let c;if(l.type==="arcade")try{const w=l.needsHydrationToEvaluate()?QS(s,t.layer):s;c=l.evaluate(w)}catch{c=null}else c=l.evaluate(s);if(c==null||c===""||/^\s+$/.test(c))continue;const d=o.graphics3DSymbol,u=((n=d.symbol)==null?void 0:n.type)==="label-3d"?d.symbol:null;if(!d.symbolLayers[0])continue;const m=e.graphics3DGraphic,_=o.labelClass,f=t.disablePlacement,y=$1({graphics3DGraphic:m,labelSymbol:u,labelClass:_,disablePlacement:f});if(y==null)continue;const b=Gf(y.anchor),x=ET(b);e.textRenderers[a]=new AT(c,x,o.textRenderParameters,Hf.maxSize),e.textLabelPlacements[a]=y}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const r=t.graphic.uid;if(e.graphics.set(r,t),e.active){const s=new V1(e,t);this._labels.set(r,s),e.labelsToInitialize.set(r,s)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const r=t.graphic.uid,s=this._labels.get(r);e.graphics.delete(r),s&&(this._destroyGraphic(s,r),e.labelsToInitialize.delete(r),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const r of t){const s=e.graphics.get(r);s&&(this._removeGraphic(e,s),this._addGraphic(e,s))}}_globalPropertyChanged(e,t){for(const r of t.labelClassContexts){const s=new Map;t.graphics.forEach(a=>s.set(a.graphic.uid,a));const n=a=>a.labelLayers[0];if(r.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,s,n),r.graphics3DCalloutSymbolLayer){const a=o=>o.labelLayers[r.calloutSymbolLayerIndex];r.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,a)}}}_visibilityInfoChange(e){const t=ud(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,r)=>{const s=this._labels.get(r);s&&(this._destroyGraphic(s,r),s.visible=!1,e.labelsToInitialize.set(r,s))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,r){const s=r&&r.emptySymbolLabelSupported||!1,n=(r==null?void 0:r.elevationInfoOverride)||null,a=(r==null?void 0:r.disablePlacement)||null;if(this._findLabelingContext(e))return;const o=e.layer,l=new KE(this.view._stage,o,e,t,s,n,a,ud(o));return this._labelingContexts.push(l),this.setDirty(),{addGraphic:c=>this._addGraphic(l,c),removeGraphic:c=>this._removeGraphic(l,c),featureReductionChange:()=>{},layerLabelsEnabled:()=>ud(l.layer),labelingInfoChange:c=>this._labelingInfoChange(l,c),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const r=this._labelingContexts.indexOf(t);this._labelingContexts.splice(r,1),t.graphics.forEach(s=>this._removeGraphic(t,s)),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const r=e.graphic.uid,s=this._labels.get(r);s&&s.visible!==t&&(t&&!s.addedToTextureAtlas?(this._addLabelTextureToAtlas(s),s.textInitialized||s.labelingContext.labelsToInitialize.set(r,s)):!t&&s.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(s),s.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>tm(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,r)=>t+(tm(r)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function tm(i){return!!i.labelClassPromise&&!!i.labelClassAbortController}function im(i){return!i||i.length===0}function ud(i){var e;return i.labelsVisible===!0&&!!((e=i.labelingInfo)!=null&&e.some(t=>!!t.symbol))}h([p({constructOnly:!0})],Xa.prototype,"view",void 0),h([p({constructOnly:!0})],Xa.prototype,"deconflictor",void 0),h([p()],Xa.prototype,"_textTextureAtlas",void 0),h([p({type:Boolean,readOnly:!0})],Xa.prototype,"updating",null),Xa=h([F("esri.views.3d.layers.graphics.Labeler")],Xa);const ss=new MT(null,null,null);function JE(i,e,t,r,s,n,a=1){const o=Vm(e,s,bC);if(o==null)return!1;if(o===xC){if(i===r&&t===n)return!0;const c=t+a;for(let d=t,u=n;d<c;++d,++u)le(r[u],i[d]);return!0}const l=t+a;for(let c=t,d=n;c<l;++c,++d)o(i[c],0,r[d],0);return!0}let eA=class{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustumBoundingSphereCenter=v(),this._frustumBoundingSphereRadius=0,this._frustum=new ca(e),this._extendedFrustum=new ca(e),this._intersector=new DT({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e),this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(e){const t=this._renderCoordsHelper.viewingMode===Re.Global&&e.lij[0]>=tA&&e.lij[0]<iA,r=this._getOrCalculateSingleTileVisibility(e,!t);return r!==Gr.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):r}_shortenFrustumFarPlane(e){const t=ca.nearFarLineIndices,r=e.mutablePoints;for(const s of t){const[n,a]=s,o=r[n],l=r[a];ve(Rr,l,o),re(Rr,Rr,sA),fe(r[a],o,Rr)}e.updatePoints(r)}_calculateAggregatedChildrenVisibility(e){let t=Gr.INVISIBLE;const r=this._cache.get(e.id);if(r!=null)return r;const s=B1.acquire();e.getChildren(s);for(const n of s){const a=this.calculate(n);if(a!==Gr.INVISIBLE&&(t=a,a===Gr.VISIBLE_ON_SURFACE))break}return B1.release(s),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const r=this._cache.get(e.id);if(r!=null)return r;const s=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,s),s}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===Re.Global&&e.lij[0]<rA?this._calculateSingleTileVisibilitySided(e,!1)===Gr.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_isTileVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===Re.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,r=gA;oe(r,e.direction);const s=e.points,n=fA;zt(n,s[4],t);const a=.5*pe(n,n)/pe(r,n),o=this._frustumBoundingSphereCenter;tl(o,t,r,a);const l=1+a;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(e){const t=e.tilingScheme.spatialReference,r=e.extent,s=this._renderCoordsHelper.spatialReference,n=cA;if(n[0]=r[0],n[1]=r[1],n[2]=0,n[3]=r[2],n[4]=r[3],n[5]=0,!wC(n,t,0,n,s,0,2))return!1;const a=G1;Ie(a[0],n[0],n[1],0),Ie(a[1],n[3],n[1],0),Ie(a[2],n[3],n[4],0),Ie(a[3],n[0],n[4],0);const o=k1;Ie(o,.5*(n[0]+n[3]),.5*(n[1]+n[4]),.5*(n[2]+n[5]));const l=hA;Ie(l,0,0,1);const c=.5*Tl(a[0],a[2]),d=this._frustum,u=this._frustumBoundingSphereRadius,m=this._frustumBoundingSphereCenter,_=vA;zt(_,m,o);const f=pe(l,_),y=yA;if(tl(y,o,l,f),Tl(y,m)>c+u)return!1;const b=lA,x=f+u,w=f-u;for(let C=0;C<4;++C)tl(b[C],a[C],l,x),tl(b[C+4],a[C],l,w);return!R_(d.planes,b,8)}_isTileVisibleInFrustumGlobal(e){const t=e.tilingScheme.spatialReference,r=e.extent,s=this._renderCoordsHelper.spatialReference;if(e.lij[0]<Xx)return!0;const n=G1,a=.5*(r[0]+r[2]);if(Ie(n[0],r[0],r[1],0),Ie(n[1],r[2],r[1],0),Ie(n[2],r[2],r[3],0),Ie(n[3],r[0],r[3],0),Ie(n[4],a,r[1],0),Ie(n[5],a,r[3],0),!JE(n,t,0,n,s,0,6))return!1;const o=n[0][2]>0,l=n[3][2]<0,c=o||l,d=bt(s).radius;if(c){const M=It(0,0,1),G=dA;na(G,M,n[0]);const Q=uA;if(na(Q,M,n[1]),o){const N=j1,ce=n[4],be=W1;na(be,ce,M),na(N,be,ce);const xe=n[0];dt(xe,G,N),cc(xe,d);const Me=n[1];dt(Me,Q,N),cc(Me,d)}else if(l){const N=j1,ce=n[5],be=W1;na(be,ce,M),na(N,ce,be);const xe=n[3];dt(xe,N,G),cc(xe,d);const Me=n[2];dt(Me,N,Q),cc(Me,d)}}const u=k1;{const M=CA;zt(M,n[3],n[0]),oe(M,M);const G=TA;fe(G,n[0],n[3]),re(G,G,.5);const Q=-pe(G,M),N=PA,ce=SA;fe(N,n[0],n[1]),re(N,N,.5),fe(ce,n[2],n[3]),re(ce,ce,.5);const be=RA;zt(be,ce,N),oe(be,be);const xe=-(Q+pe(M,N))/pe(M,be);tl(u,N,be,xe),cc(u,d)}const m=this._frustumBoundingSphereRadius,_=this._frustumBoundingSphereCenter,f=this._frustum,y=f.planes;if(n.some(M=>f.intersectsPoint(M))||f.intersectsPoint(u))return!0;const b=pA;oe(b,u);const x=bA;zt(x,_,Q1);const w=pe(x,b);if(w<-m)return!1;const C=_A;oe(C,n[0]);const T=pe(C,b);if(T<=0)return!0;const P=mA;re(P,b,w);const S=Tl(P,_),R=t.isWGS84,V=e.lij,z=R&&V[2]===2**V[0]-1,K=R&&V[2]===0,J=K?FA:z?IA:$A,X=K?VA:z?NA:LA,me=f.points;{const M=n,G=UA,Q=OA,N=EA,ce=Q1;for(const be of J){const xe=M[be];if(H1(Q,M[(be+1)%4],xe),H1(N,ce,xe),na(G,N,Q),oA(G,me,1))return!1}}let D=null;if(w<2*m){const M=2.5*m;if(S>T*M+m)return!1;const G=wA,Q=M/T;for(let N=0;N<4;++N)re(G[N],n[N],Q/d);Ie(G[4],0,0,0),D=G}else{const M=(w+m)/T,G=(w-m)/T,Q=xA;for(let N=0;N<4;++N){const ce=n[N];re(Q[N+4],ce,G/d),re(Q[N],ce,M/d)}D=Q}if(R_(y,D,D.length))return!1;const O=f.lines,k=AA,H=MA;for(const M of X){oe(k,n[M]);for(const G of O)if(oe(H,G.direction),HA(H,k,D,me))return!1}return!0}_calculateSingleTileVisibilitySided(e,t){if(this._isTileVisibleInFrustum(e)){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);const r=bt(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._frustum,r,!0)?Gr.VISIBLE_ON_SURFACE:Gr.VISIBLE_WHEN_EXTENDED}return Gr.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,Rr);this._aboveGround||rn(t,t);const r=on(-pe(t,e.viewForward));if(this._hasExtendedFrustum=r>e.fovY/2,!this._hasExtendedFrustum)return;const s=this._extendedFrustumParameters(),n=this._extendedFrustum.mutablePoints;for(let a=0;a<4;a++){const o=s.pointIndices[a],l=n[o],c=this._renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this._renderCoordsHelper.worldUpAtPosition(l,Rr),o){case mt.FAR_BOTTOM_LEFT:case mt.FAR_TOP_LEFT:case mt.NEAR_BOTTOM_LEFT:case mt.NEAR_TOP_LEFT:w0(this._extendedFrustum.planes[Dn.LEFT],Rr,Rr);break;case mt.FAR_BOTTOM_RIGHT:case mt.FAR_TOP_RIGHT:case mt.NEAR_BOTTOM_RIGHT:case mt.NEAR_TOP_RIGHT:w0(this._extendedFrustum.planes[Dn.RIGHT],Rr,Rr)}re(Rr,Rr,s.direction),this._renderCoordsHelper.intersectInfiniteManifold(wo(l,Rr),s.zWithMargin,l)}}if(this._extendedFrustum.updatePoints(n),C0(n[mt.NEAR_BOTTOM_LEFT],n[mt.NEAR_BOTTOM_RIGHT],n[mt.NEAR_TOP_RIGHT],z1),C0(n[mt.NEAR_BOTTOM_RIGHT],n[mt.NEAR_TOP_RIGHT],n[mt.NEAR_TOP_LEFT],q1),pe(ks(z1),ks(q1))<0){const a=this._extendedFrustum.mutablePoints;this._aboveGround?[a[mt.NEAR_BOTTOM_LEFT],a[mt.NEAR_BOTTOM_RIGHT]]=[a[mt.NEAR_BOTTOM_RIGHT],a[mt.NEAR_BOTTOM_LEFT]]:[a[mt.NEAR_TOP_LEFT],a[mt.NEAR_TOP_RIGHT]]=[a[mt.NEAR_TOP_RIGHT],a[mt.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(a)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-U1;return{zWithMargin:e,pointIndices:ca.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+U1;return{zWithMargin:e,pointIndices:ca.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}};const tA=2,iA=6,rA=12,sA=.95,U1=1,Rr=v(),z1=Co(),q1=Co(),B1=new wa(Array,i=>{i.length!==4&&(i[0]=new vc,i[1]=new vc,i[2]=new vc,i[3]=new vc)},i=>{i[0].release(),i[1].release(),i[2].release(),i[3].release()});function na(i,e,t){return dt(i,e,t),oe(i,i),i}function H1(i,e,t){return zt(i,e,t),oe(i,i),i}function cc(i,e){return re(i,i,e/Hr(i)),i}const nA=[Dn.LEFT,Dn.RIGHT,Dn.BOTTOM,Dn.TOP,Dn.FAR];function aA(i,e,t){for(let r=0;r<t;++r)if(Fl(i,e[r])<0)return!1;return!0}function R_(i,e,t){for(const r of nA)if(aA(i[r],e,t))return!0;return!1}const Xx=3;function oA(i,e,t){for(const r of e)if(pe(r,i)<t)return!1;return!0}const lA=[v(),v(),v(),v(),v(),v(),v(),v()],cA=[0,0,0,0,0,0],G1=[v(),v(),v(),v(),v(),v()],k1=v(),hA=v(),j1=v(),dA=v(),uA=v(),W1=v(),pA=v(),mA=v(),_A=v(),gA=v(),fA=v(),yA=v(),vA=v(),Q1=It(0,0,0),bA=v(),xA=[v(),v(),v(),v(),v(),v(),v(),v()],wA=[v(),v(),v(),v(),v()],CA=v(),TA=v(),PA=v(),SA=v(),RA=v(),OA=v(),EA=v(),AA=v(),MA=v(),DA=v(),$A=[0,1,2,3],LA=[0,1,2,3],IA=[0,1,3],NA=[0,1,3],FA=[1,2,3],VA=[1,2,3],UA=v();function zA(i,e,t){let r=1/0,s=-1/0;for(const n of t){const a=pe(e,n);r=Math.min(r,a),s=Math.max(s,a)}i[0]=r,i[1]=s}function qA(i,e,t,r){let s=1/0,n=-1/0;for(const a of r){const o=pe(t,a);if(s=Math.min(s,o),n=Math.max(n,o),s<=e&&n>=i)return!1}return!0}const BA=[0,0];function HA(i,e,t,r){const s=DA;na(s,i,e);const n=BA;return zA(n,s,t),qA(n[0],n[1],s,r)}let GA=class{constructor(e){this._camera=new Ct,this._focusOnMap=[0,0],this._screenRect=ci(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new eA(e.renderCoordsHelper)}begin(e,t,r){this._camera.copyFrom(e),this._surfaceElevation=r,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,Iv(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,r)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=CC(e.extent,this._focusOnMap),e.measures.visibility!==Gr.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=kA,r=1<<t,s=e.measures.screenRect;ln(s);let n=0;const a=e.lij,o=a[0],l=o+t,c=a[1]<<t,d=a[2]<<t,u=this._tileSizeWithBias(e),m=u*u,_=this._camera,{frustum:f,viewport:y}=_;if(this._renderCoordsHelper.viewingMode===Re.Local||o>Xx){const b=Z1;this._tilingScheme.getExtent(a[0],a[1],a[2],b);const x=Bo,w=QA,C=ln();for(let S=0;S<4;++S)this._toRenderCoords(b,K1[S][0],K1[S][1],w[S]),_.projectToScreen(w[S],x[S]),Nv(C,x[S]);const T=R_(f,w,4),P=C[0]>y[2]||C[1]>y[3]||C[2]<y[0]||C[3]<y[1];if(T||P)return void(e.measures.shouldSplit=!1)}for(let b=0;b<r;b++)for(let x=0;x<r;x++)if(n+=this._computeScreenArea(l,c+b,d+x,s),n>m)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===Gr.VISIBLE_WHEN_EXTENDED?this._tileSize*jA:this._tileSize}_computeScreenArea(e,t,r,s){this._tilingScheme.ensureMaxLod(e);const n=Z1;this._tilingScheme.getExtent(e,t,r,n);const a=WA;return this._toRenderCoords(n,0,3,a[0]),this._toRenderCoords(n,2,3,a[1]),this._toRenderCoords(n,2,1,a[2]),this._toRenderCoords(n,0,1,a[3]),this._computeTriangleScreenArea([a[0],a[1],a[2]],s)+this._computeTriangleScreenArea([a[2],a[1],a[3]],s)}_computeTriangleScreenArea(e,t){const r=this._camera.frustum[Dn.NEAR];let s=0,n=-1,a=-1;for(let o=0;o<3;++o)Fl(r,e[o])>0?(s++,n===-1&&(n=o)):a===-1&&(a=o);if(s===0)return this._computeTriangleScreenAreaInside(e,t);if(s===1){const o=Y1,l=(n+1)%3,c=(n+2)%3,d=n;le(o[0],e[l]),le(o[1],e[c]),md(o[2],e[c],e[d],r);const u=this._computeTriangleScreenAreaInside(o,t);return md(o[1],e[l],e[d],r),u+this._computeTriangleScreenAreaInside(o,t)}if(s===2){const o=Y1,l=a;le(o[0],e[l]);const c=(a+1)%3,d=(a+2)%3;return md(o[1],e[l],e[c],r),md(o[2],e[l],e[d],r),this._computeTriangleScreenAreaInside(o,t)}return 0}_computeTriangleScreenAreaInside(e,t){for(let r=0;r<3;r++)this._camera.projectToRenderScreen(e[r],X1),this._camera.renderToScreen(X1,Bo[r]),_a(t,Bo[r],t);return XS(Bo[0],Bo[1],Bo[2])}_toRenderCoords(e,t,r,s){return pd[0]=e[t],pd[1]=e[r],pd[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(pd,this._tilingScheme.spatialReference,s),s}};const kA=2,jA=5,Bo=[qt(),qt(),qt(),qt()],Z1=ci(),pd=v(),WA=[v(),v(),v(),v()],X1=Oh(),Y1=[v(),v(),v()];function md(i,e,t,r){const s=Fl(r,e),n=Fl(r,t),a=Math.abs(n-s);re(i,e,Math.abs(n)/a),tl(i,i,t,Math.abs(s)/a)}const QA=[v(),v(),v(),v()],K1=[[0,3],[2,3],[2,1],[0,1]];let bi=class extends Pe{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e!=null&&!e.spatialReference.equals(this.viewState.spatialReference))return void de.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||t!=null&&e&&t.equals(e))return;const r=e!=null?e.clone():null;this._set("filterExtent",r),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;const e=ci();return Gv(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new go,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new xt}initialize(){this.addHandles([A(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),st),A(()=>{var e,t,r;return[this.tileSize,(e=this.cameraOnSurface)==null?void 0:e.location,this.tilingScheme,(t=this.viewState)==null?void 0:t.contentCamera,(r=this.focus)==null?void 0:r.location]},()=>this._setDirty(),vt)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(fi.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=Bn(this._frameWorker)}addClient(){const e=TC();return this._clients.add(e),this._clients.size===1&&this._setDirty(),pa(()=>this._removeClient(e))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Ys))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),this._frameWorker!=null&&(this._frameWorker.priority=fi.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||this._frameWorker==null||(this._frameWorker.priority=fi.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new GA({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map(t=>new vc(t[0],t[1],t[2],e))}_purgeHorizonTiles(e){if(e.sort((t,r)=>{const s=t.measures.screenRect,n=r.measures.screenRect;return s[1]+s[3]-(n[1]+n[3])}),!(e.length>XA))return e.toArray();ln(_d);for(let t=0;t<e.length;t++)if(_a(_d,e.data[t].measures.screenRect,_d),nh(_d)>ZA)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const r=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!Zu(this._filterExtentRect,r.extent)||(this._tileMeasurements.updateTile(r),r.measures.visibility!==Gr.INVISIBLE&&(r.measures.shouldSplit?(t.ensureMaxLod(r.lij[0]+1),this._pendingTiles.push(...r.getChildren())):this._newTiles.push(r)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const t=e.filter(s=>{const n=this._idToTile.get(s.id);return n?(n.copyMeasurementsFrom(s),n.used=!0):this._idToTile.set(s.id,s),!n}),r=this.tiles.items.filter(s=>!s.used&&(this._idToTile.delete(s.id),!0));this.tiles.removeMany(r),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===Gr.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};h([p({constructOnly:!0})],bi.prototype,"scheduler",void 0),h([p({constructOnly:!0})],bi.prototype,"renderCoordsHelper",void 0),h([p({constructOnly:!0})],bi.prototype,"tilingSchemeOwner",void 0),h([p({constructOnly:!0})],bi.prototype,"cameraOnSurface",void 0),h([p({constructOnly:!0})],bi.prototype,"focus",void 0),h([p({constructOnly:!0})],bi.prototype,"viewState",void 0),h([p({constructOnly:!0})],bi.prototype,"terrain",void 0),h([p()],bi.prototype,"tiles",void 0),h([p()],bi.prototype,"tileSize",void 0),h([p({readOnly:!0})],bi.prototype,"tilingScheme",null),h([p()],bi.prototype,"filterExtent",null),h([p({readOnly:!0})],bi.prototype,"_filterExtentRect",null),h([p({readOnly:!0})],bi.prototype,"_rootTileIds",null),h([p({value:!1})],bi.prototype,"suspended",null),h([p({readOnly:!0})],bi.prototype,"updating",null),bi=h([F("esri.views.3d.layers.support.FeatureTileTree3D")],bi);const _d=ci(),ZA=10,XA=50;let St=class extends Pe{constructor(){super(...arguments),this._propertiesPool=new Sa({camera:Ct},this),this._lastSeenCameraProjectionValues=new Ct,this.mode=Wi.ANIMATING,this._cssCamera=new Ct,this._camera=new Ct,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new es,this.viewingMode=Re.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new wn({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Sa({camera:Ct},this)}destroy(){var e;this.cameraController=null,(e=this._propertiesPool)==null||e.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Re.Global){const e=bt(this.spatialReference).radius;this.camera=new Ct({eye:It(4*e,0,0),center:It(e,0,0),up:It(0,0,1)})}else this.camera=new Ct({eye:It(0,0,100),center:It(0,0,0),up:It(0,1,0)})}get animation(){return this.cameraController instanceof yh&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:r,pixelRatio:s}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/s),e.width=Math.round(r/s),e}get camera(){return this._camera}set camera(e){e!==Ur&&Ur.copyFrom(e),Ur.computeUp(this.viewingMode),this.events.emit("before-camera-change",Ur);const t=this._camera;if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Ur)&&(this._lastSeenCameraProjectionValues.copyFrom(Ur),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Ur)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Ur),this._cameraChanged=!t.almostEquals(Ur),this._cameraChanged)){const r=PC(()=>{this._cameraChanged=!1,r.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===Wi.IDLE}get updating(){return this.mode!==Wi.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=e!=null?e.clone():null}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===Re.Global}get isLocal(){return this.viewingMode===Re.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){var t;this.stopActiveCameraController()?((t=this.cameraController)==null||t.destroy(),e&&(this.removeHandles(J1),this.addHandles(Dl(()=>e.state===yt.Finished||e.state===yt.Stopped,()=>{this._set("cameraController",null),this.updateCamera(r=>e.onControllerEnd(r))},{sync:!0,once:!0}),J1),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=yt.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==yt.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Ur.copyFrom(this._get("camera")),e(Ur),this.camera=Ur,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[wr.TOP]!==t.padding[wr.TOP]||e.padding[wr.RIGHT]!==t.padding[wr.RIGHT]||e.padding[wr.BOTTOM]!==t.padding[wr.BOTTOM]||e.padding[wr.LEFT]!==t.padding[wr.LEFT]}};h([p()],St.prototype,"mode",void 0),h([p({readOnly:!0,type:Nl})],St.prototype,"animation",null),h([p({type:Ct})],St.prototype,"cssCamera",null),h([p()],St.prototype,"_cssCamera",void 0),h([p({type:Ct})],St.prototype,"camera",null),h([p()],St.prototype,"_camera",void 0),h([p({readOnly:!0})],St.prototype,"pixelRatio",null),h([p()],St.prototype,"rasterPixelRatio",void 0),h([p()],St.prototype,"contentPixelRatio",void 0),h([p({readOnly:!0})],St.prototype,"alignPixelEnabled",null),h([p({readOnly:!0})],St.prototype,"updating",null),h([p({})],St.prototype,"_contentCamera",void 0),h([p({type:Ct})],St.prototype,"contentCamera",null),h([p({readOnly:!0})],St.prototype,"fixedContentCamera",null),h([p({readOnly:!0})],St.prototype,"constraints",void 0),h([p({readOnly:!0})],St.prototype,"events",void 0),h([p({readOnly:!0})],St.prototype,"isGlobal",null),h([p({readOnly:!0})],St.prototype,"isLocal",null),h([p({readOnly:!0})],St.prototype,"viewingMode",void 0),h([p({readOnly:!0})],St.prototype,"spatialReference",void 0),h([p()],St.prototype,"navigating",null),h([p()],St.prototype,"stationary",null),h([p()],St.prototype,"_cameraChanged",void 0),h([p()],St.prototype,"cameraController",null),St=h([F("esri.views.3d.state.ViewState")],St);const YA=St,Ur=new Ct,J1="ViewStateHandles";let KA=class{constructor(e,t,r){this.viewingMode=e,this._forEachLayer=t,this._view=r,this._externalIntersectionHandlers=new xt,this._tolerance=Cu,this._tmpRay=jl(),this._tmpRegion=ci(),this._validateHUDIntersector=Gn(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,r){return this.intersectRay(this._getPickRay(e,this._tmpRay),ey(this.viewingMode),t,r)}intersectScreenFreePointFallback(e,t,r){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,r)}intersectRayFreePointFallback(e,t,r){return this.intersectRay(e,ey(this.viewingMode),t,r)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,r,s){return t.options.selectionMode=!1,t.options.store=po.MIN,this.computeIntersection(e,t,s),!!t.results.min&&t.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,t,r=.5,s=.5){return e.getRenderCenter(fd,r,s),fd[0]+=.0466,fd[1]-=.0123,Db(e,fd,t)}intersectIntersectorScreen(e,t,r){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,r)}intersectToolIntersectorScreen(e,t,r){const s=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(s,t,r)}intersectToolIntersectorRay(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,r);const s=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||_S(s)&&s.intersector!==bn.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,r))}setTolerance(e=Cu){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((t,r)=>t.type===bn.TERRAIN?1:r.type===bn.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((t,r)=>t.type===bn.TERRAIN?1:r.type===bn.TERRAIN?-1:0)}_getPickRay(e,t){const r=this._view.state.camera;return Mb(r,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==Re.Local||e==null||fe(t,e.origin,oe(Rt.get(),e.direction)),!1}intersectElevationFromScreen(e,t,r=0,s=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,r,s)}_intersectElevation(e,t,r=0,s=null){if(e==null)return null;const n=this._view,{renderCoordsHelper:a}=n,o=SC(n.spatialReference),l=t!=null?t.mode:"absolute-height",c=YS(t)/o,d=(l!=="on-the-ground"?c+r:0)*o/a.unitInMeters,{camera:u}=n.state;if(l==="absolute-height"){const T=a==null?void 0:a.getAltitude(u.eye),P=pe(oe(hc,e.direction),a.worldUpAtPosition(u.eye,tM));if(T<d&&P<0||T>=d&&P>0)return null;if(a.intersectInfiniteManifold(e,d,hc)){const S=O0(n,hc);return S.z??(S.z=0),S.z-=c,S}return null}const m=Af(Rt.get());u.projectToRenderScreen(e.origin,m);const _=new ty(null,this._forEachLayer),{slicePlane:f}=n,y=f!=null?v0(f):null,b=Gn(this.viewingMode);b.options.store=po.MIN,b.options.verticalOffset=d;const x=e.origin,w=fe(Rt.get(),x,e.direction);b.reset(x,w,u),b.point=m;const C=s?"type"in s&&s.type==="graphics"?T=>T.layerUid!==s.uid:T=>T.graphicUid!==s.uid:null;switch(l){case"relative-to-scene":{const T=P=>(!C||C(P))&&!!P.lastValidElevationBB;b.intersect(_.layers,m,this._tolerance,null,T),this._externalIntersectionHandlers.forAll(P=>{if(P.type===bn.I3S||P.type===bn.TERRAIN||P.type===bn.TILES3D){const S=P.slicePlaneEnabled?y:null;P.intersect(b,S,b.rayBegin,b.rayEnd,m)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(T=>{if(T.isGround){const P=T.slicePlaneEnabled?y:null;T.intersect(b,P,b.rayBegin,b.rayEnd,m)}})}if(b.results.min.getIntersectionPoint(hc)){const T=O0(n,hc);return T.z=r,T}return null}computeIntersection(e,t,r,s){var y;if(e==null)return;const n=this._view.state.camera,a=Af(Rt.get());n.projectToRenderScreen(e.origin,a);const o=new ty(r,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const l=e.origin,c=fe(Rt.get(),e.origin,e.direction);t.reset(l,c,n),t.intersect(o.layers,a,this._tolerance);const d=this._view.slicePlane,u=d!=null?v0(d):null;t.intersect(o.sliceableLayers,a,this._tolerance,u);const m=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll(b=>{const x=b.layerUid,w=Array.isArray(x),C=w?x:[x];w&&(t.options.filteredLayerUids=[]);let T=!1;for(const P of C)o.filterLayerUid(P)?T=!0:w&&t.options.filteredLayerUids.push(P);if(t.options.isFiltered=!T,b.isGround&&m||!t.options.isFiltered){const P=b.slicePlaneEnabled?u:null;b.intersect(t,P,l,c,a,s)}});const _=Rt.get(),f=this._view.basemapTerrain;if(r&&r.enableDraped&&f.spatialReference!=null&&t.results.ground.getIntersectionPoint(_)){const b=f.overlayManager.renderer,x=this._view.renderCoordsHelper.spatialReference,w=Rt.get();this._view.renderCoordsHelper.fromRenderCoords(_,w,f.spatialReference),w[2]=((y=this._view.elevationProvider)==null?void 0:y.getElevation(_[0],_[1],_[2],x,"ground"))??0,b.intersect(t,w,t.results.ground,C=>o.filterRenderGeometry(C))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;Um(this._tmpRegion,RC);const r=this._view.state.camera,s=[],n=this._tmpRegion,a=x=>{const w=new eM(x);r.projectToRenderScreen(x.target.center,w.screenPoint),w.screenPoint[0]=Math.floor(w.screenPoint[0]),w.screenPoint[1]=Math.floor(w.screenPoint[1]),s.push(w),Nv(n,w.screenPoint)};e.sortResults(t.all),t.min.dist!=null&&a(t.min);for(const x of t.all)t.min.target.object!==x.target.object&&t.max.target.object!==x.target.object&&a(x);if(t.max.dist!=null&&t.max.target.object!==t.min.target.object&&a(t.max),!s.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const o=r.fullWidth,l=r.fullHeight,c=Math.max(0,n[0]-Oc),d=Math.max(0,n[1]-Oc),u=Math.min(eo(n)+2*Oc,o-c),m=Math.min(nh(n)+2*Oc,l-d);if(u<=0||m<=0)return;const _=new Uint8Array(u*m*4);this._view._stage.renderer.readHUDVisibility(c,d,u,m,_);let f=!0;const y=e.results.max.dist==null;let b=0;for(const x of s)for(const w of JA){const C=4*(Math.min(x.screenPoint[0]+w[0],o)-n[0]+(Math.min(x.screenPoint[1]+w[1],l)-n[1])*u);if(!(C<0||C>=_.length)&&_[C]){f&&(e.results.min.copy(x.result),f=!1),y&&e.results.max.copy(x.result),e.options.store===po.ALL&&e.results.all.splice(b++,0,x.result);break}}}};const Oc=1,JA=(()=>{const i=[],e=Oc;for(let t=-e;t<=e;t++)for(let r=-e;r<=e;r++)i.push([r+e,t+e]);return i})();let eM=class{constructor(e){this.result=e,this.screenPoint=Oh()}},gd;function ey(i){return gd&&gd.viewingMode===i||(gd=Gn(i)),gd}let ty=class{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,t(r=>{r.pickable&&this.filterLayerUid(r.apiLayerUid)&&(r.sliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(e){const{include:t,exclude:r}=this;return e==null?t==null&&r==null:(t==null||t.has(e))&&(r==null||!r.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function iy(i){return typeof i=="object"&&"intersect"in i}const hc=v(),tM=v(),fd=Oh();let Ec=class extends es.EventedMixin(Pe){get spatialReference(){var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=te(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,r,s,n){if(this._cacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&r===o.z&&Mf(s,o.spatialReference)&&n===o.queryContext)return o.result}let a=null;return a=yd(a,this._im,e,t,r,s,n),a==null&&(a=yd(a,this._ground,e,t,r,s,n)),n==="scene"&&(a=yd(a,this._scene,e,t,r,s,n)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:s,queryContext:n,result:a}),a}getSphereElevationBounds(e,t,r){const s=new Su;function n(a){for(const o of a)if(o.getSphereElevationBounds){const l=o.getSphereElevationBounds(e,t,r);l!=null&&s.expandElevationRangeValues(l.elevationRangeMin,l.elevationRangeMax)}}return n(this._ground),n(this._im),r==="scene"&&n(this._scene),s}getRootElevationBounds(){const e=new Su;for(const t of[this._im,this._ground,this._scene])t.forEach(r=>{if(r.getRootElevationBounds){const s=r.getRootElevationBounds();s!=null&&e.expandElevationRangeValues(s.elevationRangeMin,s.elevationRangeMax)}});return e}async queryElevation(e,t,r,s,n,a=null,o=0){const l=this._getElevationQuery(s);try{const c=await l.queryElevation(e,t,a,o);return n==="scene"?yd(c,this._scene,e,t,r,s,n):c}catch(c){return OC(c),this.getElevation(e,t,r,s,n)}}register(e,t){this.addHandles(t.on("elevation-change",r=>this.emit("elevation-change",r)),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const r=t.indexOf(e);r>-1&&t.splice(r,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(t!=null&&Mf(e,t.spatialReference))return t;t==null||t.destroy({completeTasks:!0});const{wkid:r,wkt:s,wkt2:n,latestWkid:a}=e,o=new $T(this.view.resourceController.scheduler,new zi({wkid:r,wkt:s,wkt2:n,latestWkid:a}),()=>{var l;return(l=this.view.map)==null?void 0:l.ground},{maximumAutoTileRequests:4});return this._cachedQuery=o,o}};function yd(i,e,t,r,s,n,a){for(const o of e){const l=o.getElevation(t,r,s,n,a);l!=null&&(i=i!=null?Math.max(l,i):l)}return i}h([p({constructOnly:!0})],Ec.prototype,"view",void 0),h([p()],Ec.prototype,"spatialReference",null),Ec=h([F("esri.views.3d.support.CombinedElevationProvider")],Ec);let Ch=class O_{static isValidProfile(e){return e in O_.profiles}static getDefaultProfile(){return li("esri-iPhone")?"low":"medium"}static apply(e,t){const r=O_.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=r.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=r.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=r.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=r.graphics3D.uncompressedTextureDownsamplingEnabled;const s=t.sceneService.object,n=r.sceneService.object;s.lodFactor=n.lodFactor,t.sceneService.point.lodFactor=r.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=r.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=r.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=r.tiledSurface.vtlContentZoom,t.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=r.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=r.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=r.fadeDuration,t.antialiasingEnabled=r.antialiasingEnabled,t.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,t.highQualityTransparency=r.highQualityTransparency,t.highResolutionAtmosphere=r.highResolutionAtmosphere,t.reflections=r.reflections,t.ambientOcclusion=r.ambientOcclusion,t.memoryLimit=r.memoryLimit,t.additionalCacheMemory=r.additionalCacheMemory,t.frameRate=r.frameRate,t.maximumPixelRatio=r.maximumPixelRatio}};Ch.test={reset(){const i=Yx();for(const e of Object.keys(i))Ch.profiles[e]=i[e]}};const dc={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function Yx(){const i=!!li("esri-mobile"),e=!!li("ios"),t=Ye(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,reduceTileLevelDifferences:!0},fadeDuration:Ye(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+dc.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:i?.8:1,polylineLodFactor:i?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:i},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:i},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,reduceTileLevelDifferences:!li("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:i?600+dc.GalaxyS20:750+dc.FullHD,additionalCacheMemory:i?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:i?1.2:2,polylineLodFactor:i?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,reduceTileLevelDifferences:!li("disable-feature:reduce-map-tile-levels")},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:i?900+dc.SurfacePro7:1500+dc.FullHDRetina,additionalCacheMemory:i?-150:0,frameRate:0,maximumPixelRatio:i?1:1/0}}}(function(i){i.profiles=Yx()})(Ch||(Ch={}));const jd=Ch,Kx=new ho([0,255,255]),Jx=1,ew=.25,tw=new ho([0,0,0]),iw=.4,rw=.2;let Bs=class extends Pe{constructor(){super(...arguments),this.color=Kx.clone(),this.haloColor=null,this.haloOpacity=Jx,this.fillOpacity=ew,this.shadowOpacity=iw,this.shadowColor=tw.clone(),this.shadowDifference=rw}};h([p({type:ho})],Bs.prototype,"color",void 0),h([p({type:ho})],Bs.prototype,"haloColor",void 0),h([p()],Bs.prototype,"haloOpacity",void 0),h([p()],Bs.prototype,"fillOpacity",void 0),h([p()],Bs.prototype,"shadowOpacity",void 0),h([p({type:ho})],Bs.prototype,"shadowColor",void 0),h([p()],Bs.prototype,"shadowDifference",void 0),Bs=h([F("esri.views.3d.support.HighlightOptions")],Bs);const sw=Bs;let iM=class{constructor(e,t){this.spatialReference=t,this.unitInMeters=Ev(this.spatialReference,bt(this.spatialReference).metersPerDegree);const r=e&&"portalItem"in e?e.portalItem:void 0;this._geometryServiceURLPromise=tR(r).catch(()=>{throw new Ir("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(e){const t=await this._geometryServiceURLPromise;let r,s=!0;Array.isArray(e[0])&&typeof e[0]!="number"?r=e:(r=[e],s=!1);const n=r.map(l=>l instanceof Ms?l:new Ms(l,this.spatialReference)),a=new iR({geometries:n,outSpatialReference:zi.WGS84}),o=(await rR(t,a)).map(l=>l.type==="point"?[l.x,l.y]:void 0).filter(l=>!!l);return s?o:o[0]}};var Te;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.MAP=1]="MAP"})(Te||(Te={}));const Ya=[Te.ELEVATION,Te.MAP];async function rM(i,e){var m,_,f,y,b;const{results:t,ground:r}=await sR(i,e),s=(!r.layer||!zm(r.layer.type))&&r.mapPoint,n=[],a=aM(i),o=s?sM(i,a):nM;let l=0,c=0;const d=()=>{const x=o.layerViews[c];s&&x&&"fetchPopupFeaturesAtLocation"in x&&n.push({mapPoint:r.mapPoint,layerView:x}),++c};let u=null;for(;l<t.length||c<o.layerViews.length;){const x=t[l];if(x&&x.type!=="graphic")++l;else if(((m=x==null?void 0:x.layer)==null?void 0:m.type)!=="scene"||((_=x==null?void 0:x.layer)==null?void 0:_.parent)!==((f=i==null?void 0:i.map)==null?void 0:f.basemap))if(x){const w=(y=x.layer)==null?void 0:y.uid,C=o.layerUids.has(w)&&x.distance===r.distance,T=a.get((b=x.layer)==null?void 0:b.uid);if(u??(u=x.mapPoint),c<o.layerViews.length&&(C||(x.distance??0)>r.distance)&&o.layerViews[c]!==T){d();continue}n.push({graphic:x.graphic,layerView:T}),++l}else d();else++l}return u??(u=r.mapPoint),{hits:n,location:u}}function sM(i,e){const t=new Set,r=[];for(let n=i.basemapTerrain.numLayers(Te.MAP)-1;n>=0;n--){const a=i.basemapTerrain.layerViewByIndex(n,Te.MAP);t.add(a.layer.uid),r.push(a)}const s=i.basemapTerrain.overlayManager.renderer.layers;for(const{uid:n}of s){const a=e.get(n);a&&(t.add(n),r.push(a))}return r.reverse(),{layerUids:t,layerViews:r}}const nM={layerUids:new Set,layerViews:[]};function aM(i){const e=new Map;for(const t of i.allLayerViews){const r=t.layer.uid;e.set(r,t)}return e}let Ar=class extends Pe{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};h([p()],Ar.prototype,"minTotalNumberOfFeatures",void 0),h([p()],Ar.prototype,"maxTotalNumberOfFeatures",void 0),h([p()],Ar.prototype,"maxNumberOfDrawCalls",void 0),h([p()],Ar.prototype,"maxTotalNumberOfVertices",void 0),h([p()],Ar.prototype,"snapshotAvailable",void 0),h([p()],Ar.prototype,"polygonLodFactor",void 0),h([p()],Ar.prototype,"polylineLodFactor",void 0),h([p()],Ar.prototype,"skipHighSymbolLods",void 0),h([p()],Ar.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Ar=h([F("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Ar);let Rs=class extends Pe{constructor(){super(...arguments),this.lodFactor=1}};h([p()],Rs.prototype,"lodFactor",void 0),Rs=h([F("esri.views.3d.support.QualitySettings.LoDFactorSettings")],Rs);let Rn=class extends Pe{constructor(){super(...arguments),this.object=new Rs,this.point=new Rs,this.integratedMesh=new Rs,this.pointCloud=new Rs,this.uncompressedTextureDownsamplingEnabled=!1}};h([p({type:Rs})],Rn.prototype,"object",void 0),h([p({type:Rs})],Rn.prototype,"point",void 0),h([p({type:Rs})],Rn.prototype,"integratedMesh",void 0),h([p({type:Rs})],Rn.prototype,"pointCloud",void 0),h([p()],Rn.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Rn=h([F("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Rn);let oa=class extends Pe{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.reduceTileLevelDifferences=!0}};h([p()],oa.prototype,"lodBias",void 0),h([p()],oa.prototype,"angledSplitBias",void 0),h([p()],oa.prototype,"vtlContentZoom",void 0),h([p()],oa.prototype,"reduceTileLevelDifferences",void 0),oa=h([F("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],oa);let yl=class extends Pe{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};h([p()],yl.prototype,"pixelRatio",void 0),h([p()],yl.prototype,"maxTotalNumberOfFeatures",void 0),yl=h([F("esri.views.3d.support.QualitySettings.HeatmapSettings")],yl);let Oi=class extends Pe{constructor(){super(...arguments),this.graphics3D=new Ar,this.sceneService=new Rn,this.tiledSurface=new oa,this.heatmap=new yl,this.fadeDuration=Ye(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};h([p({type:Ar})],Oi.prototype,"graphics3D",void 0),h([p({type:Rn})],Oi.prototype,"sceneService",void 0),h([p({type:oa})],Oi.prototype,"tiledSurface",void 0),h([p({type:yl})],Oi.prototype,"heatmap",void 0),h([p()],Oi.prototype,"fadeDuration",void 0),h([p()],Oi.prototype,"antialiasingEnabled",void 0),h([p()],Oi.prototype,"physicallyBasedRenderingEnabled",void 0),h([p()],Oi.prototype,"highQualityTransparency",void 0),h([p()],Oi.prototype,"highResolutionAtmosphere",void 0),h([p()],Oi.prototype,"reflections",void 0),h([p()],Oi.prototype,"ambientOcclusion",void 0),h([p()],Oi.prototype,"memoryLimit",void 0),h([p()],Oi.prototype,"additionalCacheMemory",void 0),h([p()],Oi.prototype,"frameRate",void 0),h([p()],Oi.prototype,"maximumPixelRatio",void 0),Oi=h([F("esri.views.3d.support.QualitySettings.QualitySettings")],Oi);const ry=Oi;var Ks;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.BASEMAP=1]="BASEMAP",i[i.I3S_INDEX=2]="I3S_INDEX",i[i.I3S_DATA=3]="I3S_DATA",i[i.SYMBOLOGY=4]="SYMBOLOGY"})(Ks||(Ks={}));const oM=(()=>{const i=new Array;return i[Ks.ELEVATION]=10,i[Ks.BASEMAP]=10,i[Ks.I3S_INDEX]=10,i[Ks.I3S_DATA]=10,i[Ks.SYMBOLOGY]=5,i})(),lM=30;function cM(i){return"usedMemory"in i&&"unloadedMemory"in i&&"ignoresMemoryFactor"in i}function hM(i){return new ki({view:i})}const sy=.1,vd=1,rm=1,dM=.75,uM=.6,ny=1.3;let ki=class extends Pe{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new EC,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(Qu({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(vd),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){e!=null&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new AC(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();this._memoryPredicted<uM&&this._canFastRecover?(this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(vd)):e?(this._memoryPredicted>1.1*rm||this._usedMemory>rm)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>sy&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/ny),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)):(this._downscaleMemoryUsed=0,this._usedMemory>rm?(this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/ny),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(this._usedMemory<dM&&this._quality<vd?(this._stableQuality=this._quality,e=this._updateQuality(this._quality+.05)):this._quality<1&&(this._canFastRecover=!0))),this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,sy),vd))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){var o,l,c,d,u;if(!this.view)return;(l=(o=this.view._stage)==null?void 0:o.renderer)==null||l.tick();const e=(d=(c=this.view._stage)==null?void 0:c.renderer)==null?void 0:d.usedMemory;let t=(((u=this.view.basemapTerrain)==null?void 0:u.usedMemory)??0)+(e?e.fbos+e.edges+e.plugins:0),r=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(m=>{if(cM(m)){const _=m.ignoresMemoryFactor?this._quality:1;t+=m.usedMemory*_,r+=m.unloadedMemory*_}});const s=this._warnMemoryUsage==null||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(t>n&&s){this._warnMemoryUsage=t;const m=f=>(f/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",_=Math.round(100*this._quality);de.getLogger(this).warn(`Memory Limit exceeded! Limit: ${m(n)} Current: ${m(t)} Projected: ${m(t+r)} Quality: ${_}%`)}this._usedMemory=t/n,this._memoryPredicted=(t+r)/n;const a=n-t;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t},disableMemCache:()=>e.disableMemCache()}}};h([p({constructOnly:!0})],ki.prototype,"view",void 0),h([p()],ki.prototype,"maxMemory",null),h([p()],ki.prototype,"additionalCacheMemory",null),h([p({readOnly:!0})],ki.prototype,"memoryFactor",null),h([p({readOnly:!0})],ki.prototype,"updating",null),h([p({readOnly:!0})],ki.prototype,"usedMemory",null),h([p({readOnly:!0})],ki.prototype,"usedCacheMemory",null),h([p()],ki.prototype,"_quality",void 0),h([p()],ki.prototype,"_usedMemory",void 0),h([p()],ki.prototype,"_updating",void 0),h([p()],ki.prototype,"_stableQuality",void 0),h([p()],ki.prototype,"_maxMemory",void 0),h([p()],ki.prototype,"_additionalCacheMemory",void 0),ki=h([F("esri.views.3d.support.MemoryController")],ki);let Wd=class extends Pe{constructor(){super(...arguments),this.updating=!1}};function pM(i){return new cs({view:i})}h([p({readOnly:!0})],Wd.prototype,"updating",void 0),Wd=h([F("esri.views.3d.support.ResourceControllerMain")],Wd);let cs=class extends Wd{constructor(){super(...arguments),this._immediateTask=wu,this._normalTask=wu,this._updatingObjects=Hc([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=nS(),this._memoryController=hM(this.view),this._streamDataLoader=new w3,this._streamDataLoader.setup(lM,oM,this._scheduler),this.addHandles([A(()=>{var e;return(e=this.view.state)==null?void 0:e.mode},e=>{e!=null&&(this._scheduler.state=e)},st),A(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=Qu({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(fi.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(fi.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=Bn(this._frameTask),this._streamDataLoader=te(this._streamDataLoader),this._memoryController=te(this._memoryController),this._scheduler=te(this._scheduler),this.view=null}get updating(){var e,t,r,s;return!!((e=this._memoryController)!=null&&e.updating||(t=this._streamDataLoader)!=null&&t.updating||(r=this._immediateTask)!=null&&r.updating)||((s=this._updatingObjects)==null?void 0:s.value.some(n=>n.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(r,s,n)=>t.request(r,s,e,n),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],pa(()=>{t.value=t.value.filter(r=>r!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(Rv(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};h([p()],cs.prototype,"view",void 0),h([p()],cs.prototype,"_scheduler",void 0),h([p()],cs.prototype,"_memoryController",void 0),h([p()],cs.prototype,"_streamDataLoader",void 0),h([p()],cs.prototype,"_immediateTask",void 0),h([p()],cs.prototype,"_normalTask",void 0),h([p()],cs.prototype,"_updatingObjects",void 0),h([p({readOnly:!0})],cs.prototype,"updating",null),cs=h([F("esri.views.3d.support.ResourceControllerImpl")],cs);let mM=class{constructor(e){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer;const t=e.performanceInfo;this.memory=t.usedMemory,this.displayedNumberOfFeatures=t.displayedFeatures,this.maximumNumberOfFeatures=t.maximumFeatures,this.totalNumberOfFeatures=t.totalFeatures}},_M=class{constructor(e){var t;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,e.resourceController!=null){const r=e.resourceController.memoryController;this.totalMemory=(r.maxMemory??0)*nR.MEGABYTES,this.usedMemory=Math.round(r.usedMemory*this.totalMemory),this.quality=e.quality,this.load=e.resourceController.scheduler.load,this.cachedMemory=r.usedCacheMemory}this.terrainMemory=((t=e.basemapTerrain)==null?void 0:t.usedMemory)??0,this.edgesMemory=e._stage.renderer.usedMemory.edges??0,this.fboMemory=e._stage.renderer.usedMemory.fbos??0,e.allLayerViews.items.forEach(r=>{LT(r)&&this.layerPerformanceInfos.push(new mM(r))}),this.layerPerformanceInfos.sort((r,s)=>s.memory-r.memory)}},gM=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,r){const s=r?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfMemCache.get(s);return n!=null?Promise.resolve(n):this._loadOnce(this._gltfLoading,this._gltfMemCache,s,a=>aR(new oR(a.streamDataRequester),e,a,r),t)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`,s=this._wosrMemCache.get(r);return s!=null?Promise.resolve(s):this._loadOnce(this._wosrLoading,this._wosrMemCache,r,n=>IS(e,n),t)}async _loadOnce(e,t,r,s,n){Tr(n);const a=Av(n,()=>this._abortLoad(e,r));let o=e.get(r);if(o)o.refCount++;else{const l=new AbortController;o={refCount:1,abortController:l,promise:s({...n,signal:l.signal})},e.set(r,o)}try{const l=await o.promise;return t.put(r,l,l.size),e.delete(r),Tr(n),l}finally{Bn(a)}}_abortLoad(e,t){const r=e.get(t);r!=null&&--r.refCount>0||(e.delete(t),r!=null&&r.abortController.abort())}},vl=class extends Pe{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(t==null?void 0:t.registerTask(fi.TEXTURE_UNLOAD))??wu}normalizeCtorArgs(){return{}}destroy(){var e,t,r;super.destroy(),(e=this._frameTask)==null||e.remove(),(t=this._textureRequests)==null||t.forEach(s=>this._releaseTextureRequest(s)),(r=this._textureRequests)==null||r.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const r=this.makeUid(e);let s=this._textureRequests.get(r);if(!s){const n=new aw;n.texture=t(),this._stage&&(n.texture.load(this._stage.renderView.renderingContext),this._stage.add(n.texture)),this._textureRequests.set(r,n),s=n}return s.referenceCount++,new nw(r,s.texture,()=>this._release(r))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){var r;if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||((r=t.texture)==null||r.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.texture?(t=this._stage)==null||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return t!=null?`${e}.${t}px`:e}};h([p()],vl.prototype,"_frameTask",void 0),h([p()],vl.prototype,"updating",null),vl=h([F("esri.views.3d.support.TextureCollection")],vl);let nw=class{constructor(e,t,r){this.uid=e,this.texture=t,this.release=r}},aw=class{constructor(){this.referenceCount=0}},fM=class extends vl{constructor(e,t,r){super(t,r),this._streamDataRequester=e}async fromUrl(e,t,r){Tr(r);const s=r==null?void 0:r.signal,n=this.makeUid(e,t);let a=this._textureRequests.get(n);if(!a){const o=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:n,signal:o.signal});a=new aw,a.abortController=o;const c=a;this._textureRequests.set(n,a),a.textureAsync=l.then(async d=>{const u=this._createTexture(e,d,t);return c.texture=u,c.abortController=null,await u.load(this._stage.renderView.renderingContext),this._stage.add(u),new nw(n,u,()=>this._release(n))},d=>{throw c.abortController=null,d})}a.referenceCount++;try{return await MC(a.textureAsync,s)}catch(o){throw this._release(n),o}}_createTexture(e,t,r){var n;const s={width:t.width,height:t.height,wrap:{s:Ji.CLAMP_TO_EDGE,t:Ji.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(Fv(e)){if(r||t.width===0&&t.height===0){const a=t.width?t.height/t.width:1;r=r||64,a>1?(t.width=Math.round(r/a),t.height=r):(t.width=r,t.height=Math.round(r*a))}(n=this._stage.renderView)!=null&&n.renderingContext.driverTest.svgPremultipliesAlpha.result&&(s.preMultiplyAlpha=!1)}return new K3(t,s)}},yM=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Ks.SYMBOLOGY),this.objectResourceCache=new gM((r,s)=>e.resourceController.memoryController.newCache(r,s)),this.textures=new fM(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=bt(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=mb(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=bP(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return pa();this._graphicsOwners.push(e);const t=A(()=>{var r;return(r=e.layer)==null?void 0:r.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),pa(()=>{t.remove(),DC(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(t=>{var r;return((r=t.layer)==null?void 0:r.screenSizePerspectiveEnabled)===!0});if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new ju;const t=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([A(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,t,st),this._viewState.events.on("camera-projection-changed",t)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=te(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;bd.distance=e.centerOnSurfaceInfrequent.distance,bd.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(bd),this.screenSizePerspectiveSettingsLabels.update(bd),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}};const bd={distance:0,fovY:0};let ol=class{constructor(e,t,r=""){this.graphics=e,this._symbol=new $C({symbolLayers:new go([new LC({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new IC({text:r,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(t==null)return;this.hide();const r=new Ms({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new NC({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){this._graphic!=null&&(this.graphics.remove(this._graphic),this._graphic=null)}},ha=class extends Pe{constructor(e){super(e)}};h([p({constructOnly:!0})],ha.prototype,"renderCoordsHelper",void 0),h([p({constructOnly:!0})],ha.prototype,"surface",void 0),h([p({constructOnly:!0})],ha.prototype,"state",void 0),ha=h([F("esri.views.3d.support.PointOfInterest")],ha);const vM=Array;let hs=class extends ha{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Sa({location:Ms,renderLocation:vM},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=v(),this._tmpPoint=new Ms}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(Nn(()=>{var t,r;return(r=(t=this.map)==null?void 0:t.ground)==null?void 0:r.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=te(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=cr(e.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Xv(r,t,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){var s;if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!((s=this.map)!=null&&s.ground))return this._updateSurfaceAltitude(0),Yi;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>bM&&this.renderCoordsHelper.viewingMode===Re.Global&&(e.isWGS84||e.isWebMercator);let r=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:r.signal,cache:this.cache,minDemResolution:t?xM:0}).then(n=>this._updateSurfaceAltitude(n.geometry.z??0)).catch(n=>{fo(n)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===r&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),r=null}),this._pendingElevationQueryController=r,Yi}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(sm,this._estimatedSurfaceAltitude,this._camera.eye),k_(this._get("renderLocation"),sm)||(this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),sm)),this.notifyChange("renderLocation"))}};h([p({constructOnly:!0})],hs.prototype,"scheduler",void 0),h([p({constructOnly:!0})],hs.prototype,"cache",void 0),h([p({constructOnly:!0})],hs.prototype,"task",void 0),h([p()],hs.prototype,"location",null),h([p({constructOnly:!0})],hs.prototype,"map",void 0),h([p()],hs.prototype,"renderLocation",void 0),h([p()],hs.prototype,"scale",null),h([p()],hs.prototype,"updating",null),hs=h([F("esri.views.3d.support.CameraOnSurface")],hs);const sm=v(),bM=1e5,xM=1e6,wM=Array;let Br=class extends ha{constructor(e){super(e),this._propertiesPool=new Sa({location:Ms,renderLocation:wM},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=v(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Bn(this._frameWorker),this._propertiesPool=te(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Yi}_updateRenderLocation(){const e=TM;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&r&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=PM;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,s)&&(le(e,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=cr(this._camera.eye,e):(re(e,this._camera.viewForward,this._get("distance")),fe(e,e,this._camera.eye)),k_(this._get("renderLocation"),e)||this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){var s,n;const r=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(r.ray,e,t))return!1;if(this.state.isGlobal){const a=bt(this.renderCoordsHelper.spatialReference).radius,o=a+e,l=xs(r.eye),c=l<o*o,d=cr(r.eye,t);if(c&&d>a/4){const u=o-Math.sqrt(l);return re(t,r.viewForward,u),fe(t,t,r.eye),!0}}else{const a=(s=this.surface)!=null&&s.ready?this.surface.extent:null;a!=null&&kv(a,(n=this.surface)==null?void 0:n.spatialReference,uc,this.renderCoordsHelper.spatialReference)&&(t[0]=ie(t[0],uc[0],uc[2]),t[1]=ie(t[1],uc[1],uc[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(dr.TESTS_DISABLE_OPTIMIZATIONS)return!0;const r=this._camera.eye,s=cr(r,e),n=cr(r,t);if(Math.abs(n-s)/s>CM)return!0}return!1}};h([p({constructOnly:!0})],Br.prototype,"scheduler",void 0),h([p({constructOnly:!0})],Br.prototype,"task",void 0),h([p()],Br.prototype,"distance",void 0),h([p({constructOnly:!0})],Br.prototype,"estimateSurfaceAltitudeAtCenter",void 0),h([p({readOnly:!0})],Br.prototype,"location",null),h([p({readOnly:!0})],Br.prototype,"renderLocation",void 0),h([p()],Br.prototype,"updating",void 0),Br=h([F("esri.views.3d.support.CenterOnSurface")],Br);const CM=.05,TM=v(),PM=v(),uc=ci();let SM=class{constructor(e){this._handles=new ju,this.events=new es,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",t=>this._layerViewsChanged(t))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=te(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach(t=>{t.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(t.on("visible-geometry-changed",()=>this._contentChanged()),t.uid)}),e.removed.forEach(t=>this._handles.remove(t.uid))}_contentChanged(){this.events.emit("request-update",RM)}};const RM={},OM=Array;let ds=class extends ha{constructor(e){super(e),this._propertiesPool=new Sa({location:Ms,renderLocation:OM},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([A(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),A(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(fi.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=te(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,r=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,r.worldUpAtPosition(t,ay);const n=Math.max(0,(Math.acos(pe(ay,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!ah(e,t)){const c=this._propertiesPool.get("renderLocation");le(c,t),this._set("renderLocation",c)}return Yi}const a=1-ie(n/(.5*Math.PI),0,1),o=a*a*a;this._calculateScreenHorizontalEdgeOnSurface(oy);const l=this._propertiesPool.get("renderLocation");return As(l,t,oy,o),e&&ah(e,l)||this._set("renderLocation",l),Yi}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,r=t.getRenderCenter(Oh());if(r[1]=t.aboveGround?t.padding[wr.BOTTOM]:t.fullHeight-t.padding[wr.TOP],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,pc)){ve(pc,pc,t.eye);const n=oe(pc,pc);if(this.renderCoordsHelper.intersectInfiniteManifold(wo(t.eye,n),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,t.eye)}updateRenderLocation(){this._dirty=!0}};h([p()],ds.prototype,"_dirty",void 0),h([p({constructOnly:!0})],ds.prototype,"scheduler",void 0),h([p({constructOnly:!0})],ds.prototype,"centerOnSurface",void 0),h([p({constructOnly:!0})],ds.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),h([p()],ds.prototype,"updating",null),h([p()],ds.prototype,"location",null),h([p()],ds.prototype,"renderLocation",void 0),h([p()],ds.prototype,"worldUnitsPerContentPixel",null),ds=h([F("esri.views.3d.support.pointsOfInterest.Focus")],ds);const ay=v(),pc=v(),oy=v();let Cn=class extends Pe{get surface(){var e;return(e=this.view.map)==null?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=v();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([A(()=>{var e,t;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(t=this.surfaceView)==null?void 0:t.extent]},()=>this._update()),Nn(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}_update(){var r;if(this._updateController&&(this._updateController.abort(),this._updateController=null),((r=this.surfaceView)==null?void 0:r.extent)==null||this.surfaceView.spatialReference==null)return void this._set("location",null);const e=Vv(this.surfaceView.extent),t=new Ms({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(s=>{this._updateController=null,this._set("location",s.geometry)}).catch(s=>{fo(s)||s&&s.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",s)})):this._set("location",t)}};h([p({constructOnly:!0})],Cn.prototype,"view",void 0),h([p({constructOnly:!0})],Cn.prototype,"cache",void 0),h([p()],Cn.prototype,"surface",null),h([p()],Cn.prototype,"surfaceView",null),h([p({readOnly:!0})],Cn.prototype,"location",void 0),h([p({readOnly:!0})],Cn.prototype,"renderLocation",null),Cn=h([F("esri.views.3d.terrain.StableSurfaceCenter")],Cn);let Tn=class extends Pe{constructor(e){super(e),this._tileGeometryUpdateExtent=ln(),this._tileGeometryUpdateSpatialReference=null,this.events=new es,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(fi.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",EM),ln(this._tileGeometryUpdateExtent),this._set("updating",!1),Yi):Yi}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,_a(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const r=this.centerOnSurfaces[t];r.distance>e.distance&&(e=r)}return e}_centerIntersectsExtent(e,t){const r=this.state.contentCamera.eye,s=AM,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(r,Ua,t),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,za,t),Ua[0]<za[0]?(s[0]=Ua[0],s[2]=za[0]):(s[0]=za[0],s[2]=Ua[0]),Ua[1]<za[1]?(s[1]=Ua[1],s[3]=za[1]):(s[1]=za[1],s[3]=Ua[1]),Zu(s,e)}};h([p({constructOnly:!0})],Tn.prototype,"state",void 0),h([p({constructOnly:!0})],Tn.prototype,"centerOnSurfaces",void 0),h([p({constructOnly:!0})],Tn.prototype,"renderCoordsHelper",void 0),h([p({constructOnly:!0})],Tn.prototype,"scheduler",void 0),h([p({constructOnly:!0})],Tn.prototype,"surface",void 0),h([p({readOnly:!0})],Tn.prototype,"updating",void 0),Tn=h([F("esri.views.3d.support.SurfaceGeometryUpdates")],Tn);const EM={},Ua=v(),za=v(),AM=ln();let sr=class extends Pe{constructor(e){super(e),this.renderPointOfView=v(),this._pois=new Array,this._debugCenters=new Map,this._tmpRay=jl(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Sa({renderPointOfView:MM},this)}initialize(){var d;const{state:e,basemapTerrain:t,renderCoordsHelper:r,map:s}=this.view;this._surfaceIntersector=Gn(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=po.MIN,this._contentIntersector=Gn(e.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,o=(d=this.view.basemapTerrain)==null?void 0:d.elevationQueryCache,l={state:e,scheduler:a,surface:t,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new Br({...l,task:fi.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new Br({...l,task:fi.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new Br({...l,task:fi.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new hs({...l,cache:o,task:fi.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("surfaceGeometryUpdates",new Tn({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new SM({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new Cn({cache:o,view:this.view})),this._set("focus",new ds({state:e,scheduler:a,surface:t,renderCoordsHelper:r,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(u,m)=>this._estimateSurfaceIntersectionAtRenderPoint(u,this.view.state.contentCamera,m)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new ol(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new ol(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new ol(c,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new ol(c,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new ol(c,"green","Focus")),this.addHandles([A(()=>e.contentCamera,u=>this._cameraChanged(u),st),A(()=>t.extent,()=>this._updateCenterPointsOfInterest()),Dl(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),st),Nn(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Nn(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),Dl(()=>dr.SHOW_POI,u=>this._setDebug(u),oi)]),this._cameraChanged(this.view.state.contentCamera);for(const u of this._pois)u.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)!=null&&e.updating)&&!this._pois.some(t=>t.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Ho,$M)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Ho):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(e==null)return this._surfaceAltitudeAtCenter;const t=e.origin,r=fe(Ho,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(Ho)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Ho)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,r){const s=Db(t,e,DM);if(s==null)return null;const n=s.origin,a=fe(Ho,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,a),this._surfaceIntersector.results.min.getIntersectionPoint(r)?r:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;k_(this.renderPointOfView,t)||this._set("renderPointOfView",le(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(t=>t.hide()),void this.removeHandles("debug");for(const t of this._pois)this.addHandles(A(()=>t.renderLocation,r=>{var s;return(s=this._debugCenters.get(t))==null?void 0:s.show(r,t.renderCoordsHelper.spatialReference)},oi),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};h([p()],sr.prototype,"centerOnContent",void 0),h([p()],sr.prototype,"centerOnSurfaceFrequent",void 0),h([p()],sr.prototype,"centerOnSurfaceInfrequent",void 0),h([p()],sr.prototype,"cameraOnSurface",void 0),h([p()],sr.prototype,"focus",void 0),h([p()],sr.prototype,"renderPointOfView",void 0),h([p()],sr.prototype,"surfaceOrigin",void 0),h([p()],sr.prototype,"contentGeometryUpdates",void 0),h([p()],sr.prototype,"surfaceGeometryUpdates",void 0),h([p({constructOnly:!0})],sr.prototype,"view",void 0),h([p()],sr.prototype,"updating",null),sr=h([F("esri.views.3d.support.PointsOfInterest")],sr);const MM=Array,Ho=v(),DM=jl(),$M={exclude:new Set([uh])},MF={value:.5,readOnly:!0},LM={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let bl=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},IM=class{constructor(e,t,r){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new x3(r,t)}computeMinMaxValue(e,t,r,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return s;const a=2**n;if(!(Math.floor(t/a)===this.i&&Math.floor(r/a)===this.j))return s;let o=1/0,l=-1/0;const c=this.samplerData.data.width,d=this.samplerData.data.values,u=.5*lh;let m=(c-1)/a,_=(r-this.j*a)*m,f=(t-this.i*a)*m;if(m<1){const y=Math.floor(_),b=Math.floor(f),x=y+b*c,w=d[x],C=d[x+1],T=d[x+c],P=d[x+c+1];if(w+C+T+P<u){const S=_-y,R=f-b,V=Hh(w,C,T,P,S,R),z=Hh(w,C,T,P,S+m,R),K=Hh(w,C,T,P,S,R+m),J=Hh(w,C,T,P,S+m,R+m);return s.min=Math.min(V,z,K,J),s.max=Math.max(V,z,K,J),s}_=y,f=b,m=1}else _=Math.floor(_),f=Math.floor(f),m=Math.ceil(m);for(let y=_;y<=_+m;y++)for(let b=f;b<=f+m;b++){const x=d[y+b*c];x<u?(o=Math.min(o,x),l=Math.max(l,x)):s.hasNoDataValues=!0}return s.min=o,s.max=l,s}};const NM=.5*lh;function Tt(i,e,t){if(t==null)return null;for(const r of t){if(!r)continue;const s=r.safeWidth;let n=ie(r.dy*(r.y1-e),0,s),a=ie(r.dx*(i-r.x0),0,s);const o=Math.floor(n),l=Math.floor(a),c=r.data.width,d=o*c+l,u=r.data.values,m=u[d],_=u[d+1],f=d+c,y=u[f],b=u[f+1];if(m+y+_+b<NM){n-=o,a-=l;const x=m+(_-m)*a;return x+(y+(b-y)*a-x)*n}}return null}let qr=class extends Pe{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const r=t.layer;if(FC(r.operationalLayerType)&&this.viewSpatialReference!=null){const s=ow(r.fullExtent,this.viewSpatialReference);s!=null&&e.push(VC(s))}}),e}};function FM(i,e){return i===Re.Global?new E_(e):new A_(e)}h([p({readOnly:!0})],qr.prototype,"layerViewsExtent",null),h([p({readOnly:!0})],qr.prototype,"tiledLayersExtent",null),h([p({readOnly:!0})],qr.prototype,"stencilEnabledExtents",null),h([p()],qr.prototype,"viewSpatialReference",void 0),h([p()],qr.prototype,"tilingScheme",void 0),h([p()],qr.prototype,"defaultTiledLayersExtent",void 0),h([p({constructOnly:!0})],qr.prototype,"layers",void 0),h([p({constructOnly:!0})],qr.prototype,"layerViews",void 0),qr=h([F("esri.views.3d.terrain.ExtentHelper")],qr);let E_=class extends qr{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?C3:T3}};E_=h([F("esri.views.3d.terrain.ExtentHelperGlobal")],E_);let A_=class extends qr{_computeLayerViewsExtent(){const e=ln(),t=this.viewSpatialReference;this.layerViews.forEach(n=>{const a=n.layer;if(n.isResolved()&&(a.type!=="graphics"||!a.internal)){const o=ow("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,t);_a(e,o,e)}});const r=Df(e)?e:null,s=this._get("layerViewsExtent");return uo(r,s)?s:r}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,r=ln();this.layers.forEach(a=>{if(a.loaded&&zc(a)){const o=Ku(a,t,Re.Local);if(o==null)return;const{tileInfo:l,fullExtent:c}=o;l!=null&&c!=null&&(Yv(a)||e.compatibleWith(l)&&c.spatialReference.equals(e.spatialReference))&&_a(r,c,r)}}),_a(r,this.defaultTiledLayersExtent,r);const s=Df(r)?r:null,n=this._get("tiledLayersExtent");return uo(s,n)?n:s}};function ow(i,e){return i==null||i.spatialReference.equals(e)?i:UC(i,i.spatialReference,e)}A_=h([F("esri.views.3d.terrain.ExtentHelperLocal")],A_);function lw(){var e;const i=(e=globalThis.require)==null?void 0:e.modules;if(i){const t=Object.keys(i);for(const r of t)r.includes(".glsl")&&delete i[r]}}const cw=1.3,VM=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let ea,ir=class extends Pe{constructor(e){super(e),this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=li("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){const e=this.view;this.renderer=new DP({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.setDrawTexturesDirty();this._groundIntersector=Gn(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([A(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",r=>{var s;return(s=e._stage)==null?void 0:s.renderer.setParameters({hasOverlayWater:r})}),this.renderer.events.on("content-changed",t),A(()=>e.state.camera.pixelRatio,t),A(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),A(()=>{var r,s,n;return[(r=e.pointsOfInterest)==null?void 0:r.renderPointOfView,(n=(s=e.pointsOfInterest)==null?void 0:s.centerOnSurfaceFrequent)==null?void 0:n.location]},()=>this.setPlacementDirty()),A(()=>{var r,s;return[(r=e.state)==null?void 0:r.pixelRatio,(s=e.state)==null?void 0:s.contentPixelRatio]},()=>this.setPlacementDirty(),st),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(fi.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",r=>{this._updateOverlays(Ys,r.camera,jt.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(jt.BACKGROUND,r)})]),e._stage.renderer.renderOverlay=r=>this._renderOverlay(r)}destroy(){var e;(e=this.view)!=null&&e._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.renderOverlay=()=>{}),ea&&(ea.hide(),ea=null),this.renderer=te(this.renderer)}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||dr.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?bt(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return cw/this.view.resolutionScale}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}_renderOverlay(e){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._dispatchAnimationUpdate(e),this._drawOverlays(jt.UPDATE,this.view.state)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;e!=null&&t!=null?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new b0(-20037508342787e-6,20037508342787e-6):new b0(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}registerDrapeSource(e,t,r){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this.renderer.createDrapeSourceRenderer(e,t,r);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),s}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,$P)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&e.setDrapingExtent!=null&&this._spatialReference!=null&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,jt.UPDATE)}_updateOverlays(e,t,r){if(!this._spatialReference)return Yi;const s=this._computeOverlayResolution(t);this._computeOverlayExtents(t,s,Vs),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,Vs.stretch);const n=this._updateOverlay(Vr.INNER,Vs.inner,s,1*Vs.pixelRatioAdjustment,Vs.mapUnitsPerPixel),a=eo(Vs.inner)/eo(Vs.outer),o=this._updateOverlay(Vr.OUTER,Vs.outer,s,a*Vs.pixelRatioAdjustment,Vs.mapUnitsPerPixel);n!==Gs.EXTENT&&o!==Gs.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.surface.updateTileOverlayParams(r)),n===Gs.NONE&&o===Gs.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,r=e.fullWidth/e.pixelRatio*t,s=e.fullHeight/e.pixelRatio*t,n=Math.ceil(1.5*Math.max(r,s));return Math.min(Zm(n),this._maxResolution)}_updateOverlay(e,t,r,s,n){if(this.renderer.overlays.length===0)return Gs.NONE;const a=this.renderer.overlays[e],o=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=n,a.pixelRatio=s,UM(t,a.extent)&&r===a.resolution)return o===n?Gs.NONE:Gs.RERENDER_ONLY;Um(a.extent,t),a.resolution=r;const l=Vv(a.extent);return a.renderLocalOrigin=LP(l[0],l[1],0,"OV_"+this._latestOriginId++),Gs.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const r=this.renderer.overlays[Vr.INNER],s=this.renderer.overlays[Vr.OUTER],n=e.extent;this._rectInsideRect(r.extent,n)||this._rectanglesOverlap(n,r.extent)||this._rectanglesOverlap(n,s.extent)?(this._setTileOverlayData(n,Vr.INNER,t),this._setTileOverlayData(n,Vr.OUTER,t)):(this._clearTileOverlayData(Vr.INNER,t),this._clearTileOverlayData(Vr.OUTER,t))}else this._clearTileOverlayData(Vr.INNER,t),this._clearTileOverlayData(Vr.OUTER,t)}overlayPixelSizeInMapUnits(e,t){if(this.renderer.overlays.length===0)return t();const r=this.renderer.overlays[Vr.INNER],s=this.renderer.overlays[Vr.OUTER],n=this._pointIsInExtent(e,r.extent)?r:s;return(n.extent[2]-n.extent[0])/n.resolution}_setTileOverlayData(e,t,r){if(this.renderer.overlays.length===0)return;const s=this.renderer.overlays[t].extent,n=eo(s),a=nh(s);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(s[0],o);const l=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);o>l&&(o=l-(e[2]-e[0]))}r.setScale(t,eo(e)/n,nh(e)/a),r.setOffset(t,(o-s[0])/n,(e[1]-s[1])/a)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){lw(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(Ys)}_dispatchAnimationUpdate(e){const t=Ye(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||this.view.state.forcedAnimationTime!=null||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const r=Ye(t/this.surface.view._stage.renderer.animationTimeDilation),s=new _b(this.view.state.camera,r,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(s)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,r,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,HM,t,r);if(n==null)return!1;const a=n.origin,o=fe(xd,n.origin,n.direction);return this._groundIntersector.reset(a,o,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,o),this._groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(e,t){let r=.5;const s=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,l=ie(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+o,e.aboveGround?n-o:1/0),c=e.aboveGround;if(this.view.viewingMode==="global"){const d=xd;sp(lg(cg,bt(this.view.spatialReference).radius+l),wo(e.eye,e.viewForward),d),ve(d,d,e.eye);const u=Pa.normalize(CS(e.viewForward,d,e.viewRight))/e.fovY+.5,m=u<=0||u>=1?.5:s;r=c?m*u:u+m*(1-u)}else{const d=.5*Math.PI-Math.acos(-e.viewForward[2]),u=Math.tan(d),m=Jr(0,u,1,0),_=Fm(m,m,e.projectionMatrix)[1],f=ie(.5+.5*_,0,1);r=f===1||f===0?.5:c?f*s:1-(1-f)*s}return!!this._intersectGroundFromView(e,.5,r,t)&&zC(t,e.eye)<a.distance*a.distance}_computeOverlayExtents(e,t,r){const s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=v();this._findHorizonBasedPointOfInterest(e,n)||le(n,s),dr.OVERLAY_SHOW_CENTER?(ea==null&&(ea=new ol(this.view.graphics,"red")),ea.show(n,this._renderSR)):ea!=null&&ea.hide();const a=Math.max(.1,cr(e.eye,n)),o=Ra(this.view.renderCoordsHelper,s,e.eye);this._overlaySREqualsRenderSR||ph(n,this._renderSR,n,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&this._spatialReference&&this._spatialReference.isGeographic,d=c&&this._spatialReference?1/bt(this._spatialReference).metersPerDegree:1,u=this.view.state.contentPixelRatio,m=e.perScreenPixelRatio/u*a*d;r.mapUnitsPerPixel=m/this._worldToPCSRatio,r.stretch=this._overlayStretch;let _=t*m/2*r.stretch,f=!1,y=c?90:1/0;this._isSpherical&&l&&this._spatialReference&&(this._spatialReference.isWebMercator?(_/=Math.cos(qC(n[1])),y=l[3]):(f=!0,_/=bt(this._spatialReference).metersPerDegree,y=90),_>=y&&(_=y,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let b=1;f&&(b=1/Math.max(.2,Math.cos(Math.abs(Wt(n[1])))),_*b>180&&(b=180/_),r.mapUnitsPerPixel*=b);const x=Math.log(2)/12;_=Math.exp(Math.round(Math.log(_)/x)*x);const w=_*b,C=32,T=.5*t/(C*w),P=.5*t/(C*_);n[0]=Math.round(n[0]*T)/T,n[1]=Math.round(n[1]*P)/P;const S=r.inner;S[0]=n[0]-w,S[1]=n[1]-_,S[2]=n[0]+w,S[3]=n[1]+_,this._isSpherical&&this._shiftExtentToFitBounds(S,1/0,y);const R=r.outer;if(6*w>eo(l))Um(R,l);else if(Math.PI/2-Math.abs(o-Math.PI/2)<=.25*Math.PI)R[0]=S[0]-w,R[1]=S[1]-_,R[2]=S[2]+w,R[3]=S[3]+_;else{ph(e.eye,this._renderSR,xd,this._spatialReference),j3(qa,n,xd);let z=-Math.atan2(qa[1],qa[0])+.125*Math.PI;z<0&&(z+=2*Math.PI);const K=Math.floor(z/(.25*Math.PI));$v(qa,VM[K],2*_),qa[0]*=b,qa[2]*=b,BC(R,S,qa)}if(this._isSpherical)R[0]=this._longitudeCyclical.clamp(R[0]),R[2]=this._longitudeCyclical.clamp(R[2]),R[1]=Math.max(R[1],-y),R[3]=Math.min(R[3],y);else{const z=qm(S,l,qM),K=qm(R,l,BM);$f(z,K)&&(R[2]=R[0],R[3]=R[1])}const V=Math.abs(S[2]-S[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,V),r.pixelRatioAdjustment=r.mapUnitsPerPixel/V}_drawOverlays(e,t){if(!this.renderer.hasOverlays)return;if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const r=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const s=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),s!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(jt.UPDATE),r?(this.surface.requestRender(e),e===jt.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(jt.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return e!=null&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):Zu(e,t))}_rectInsideRect(e,t){return t!=null&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:$f(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,s=e.y;return r>t[0]&&r<t[2]&&s>t[1]&&s<t[3]}_shiftExtentToFitBounds(e,t,r){let s=0,n=0;e[0]<-t?s=e[0]+t:e[2]>t&&(s=t-e[2]),e[1]<-r?n=e[1]+r:e[3]>r&&(n=r-e[3]),Lv(e,s,n)}get test(){return{renderer:this.renderer,update:()=>this.runTask(Ys)}}};function UM(i,e){const r=dr.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(i[2]-i[0],i[3]-i[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-i[0])<=r&&Math.abs(e[1]-i[1])<=r&&Math.abs(e[2]-i[2])<=r&&Math.abs(e[3]-i[3])<=r}h([p()],ir.prototype,"_spatialReference",void 0),h([p({readOnly:!0})],ir.prototype,"running",null),h([p()],ir.prototype,"_placementDirty",void 0),h([p()],ir.prototype,"_contentUpdated",void 0),h([p()],ir.prototype,"_isSpherical",null),h([p()],ir.prototype,"_worldToPCSRatio",null),h([p()],ir.prototype,"renderer",void 0),h([p({constructOnly:!0})],ir.prototype,"view",void 0),h([p({constructOnly:!0})],ir.prototype,"surface",void 0),h([p()],ir.prototype,"suspended",null),h([p()],ir.prototype,"updating",null),h([p({type:Boolean})],ir.prototype,"rendersOccludedDraped",null),ir=h([F("esri.views.3d.terrain.OverlayManager")],ir);let zM=class{constructor(){this.inner=ci(),this.outer=ci(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=cw}};const qa=_i(),xd=v(),Vs=new zM,qM=ci(),BM=ci(),HM=jl();var Gs;(function(i){i[i.NONE=0]="NONE",i[i.EXTENT=1]="EXTENT",i[i.RERENDER_ONLY=2]="RERENDER_ONLY"})(Gs||(Gs={}));let GM=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=pu(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=tt(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,pu(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,r,s){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,s),t),fe(t,t,r)}getEdgeNormal(e,t,r){const{typedBuffer:s,typedBufferStride:n}=this.vertexAttributes.normalCompressed;uR(t,s,this.getEdgeAttributeIndex(e,r),n)}setEdgeNormalFromValues(e,t,r,s,n){this._setNormal(this.getEdgeAttributeIndex(e,t),r,s,n)}setEdgeVertexFromValuesRawPositionUV(e,t,r,s,n,a,o){const l=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(l,r,s,n),this._setUV(l,a,o)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,r,s,n,a,o,l,c,d){const u=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(u,r,s,n),this._setUV(u,a,o),this._setNormal(u,l,c,d)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,r,s){const{typedBuffer:n,typedBufferStride:a}=this.vertexAttributes.normalCompressed;mh(n,e,t,r,s,a)}_setUV(e,t,r){Es(this.vertexAttributes.uv0,e,t,r)}getEdgeAttributeIndex(e,t){return I(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}};const ly=16384;function Es(i,e,t,r){i.setValues(e,t*ly,r*ly)}let kM=class{constructor(){this.sinLonLUT=new Array(fc+1),this.cosLonLUT=new Array(fc+1),this.sinLatLUT=new Array(fc+1),this.cosLatLUT=new Array(fc+1)}update(e,t,r){const s=t[0],n=t[2];for(let a=0;a<=e;a++){const o=a/e,l=s*(1-o)+n*o;this.sinLonLUT[a]=Math.sin(l),this.cosLonLUT[a]=Math.cos(l);const c=r(o);this.sinLatLUT[a]=Math.sin(c),this.cosLatLUT[a]=Math.cos(c)}}},jM=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}},hw=class Qd{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=te(this._current),this._next=te(this._next),this._waiting=te(this._waiting),this._delayed=te(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}let e=Qd.test.fadeMoment;if(this._delayed!=null&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,va.Immediate),this._delayed=null)),this._next!=null){e=e||performance.now();const t=this._fadeDuration,r=this._current!=null&&this._next.texture===this._current.texture,s=this._next.type!==ni.FADING,n=e-this._fadeStart>=t;(r||s||n)&&(te(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;const e=Qd.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),r=this._fadeDuration;return t>r?0:1-t/r}get isFading(){return this._next!=null||this._delayed!=null}push(e,t=va.Immediate){this._delayed=te(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=e);const r=Qd.test.fadeMoment||performance.now();return t!==va.Immediate?(this._delayed=e,void(this._delayedTime=r+t)):this._next==null?(this._next=e,void(this._fadeStart=this._alignFadeStart(r))):void(e!=null&&(te(this._waiting),this._waiting=e))}get _fadeDuration(){return this._waiting==null?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}};var va;hw.test={fadeMoment:0},function(i){i[i.Immediate=0]="Immediate",i[i.Delayed=5e3]="Delayed"}(va||(va={}));var Ul;(function(i){i[i.BACK_TO_FRONT=-1]="BACK_TO_FRONT",i[i.NONE=0]="NONE",i[i.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(Ul||(Ul={}));let dw=class{constructor(){this._queue=new xt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),e!=null&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var t;const e=(t=this._last)==null?void 0:t.children;return e!=null&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},WM=class{constructor(){this._q=new xt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),e!=null){this._q.pushArray(e);for(let t=0;t<this._q.length;++t){const r=this._q.data[t];r.isLeaf||this._q.pushArray(r.children)}}}next(){return this._q.pop()}};function Yc(i,e,t){if((e==null?void 0:e.fullExtent)==null)return!1;const r=e.fullExtent,s=i.extent;if(t){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const n=i.surface.tilingScheme.levels[i.level].scale,a=e.minScale;if(a>0&&n>1.00000001*a)return!1;const o=e.maxScale;return!(o>0&&n<.99999999*o)}function qn(i,e){const t=i.lij,r=e.lij;return t[0]-r[0]||t[1]-r[1]||t[2]-r[2]}function uw(i,e,t=null){t==null||t.length===0?i===Ul.BACK_TO_FRONT?e.sort(QM):e.sort(ZM):e.sort((r,s)=>XM(r,s,i,t))}function QM(i,e){const t=e.screenDepth-i.screenDepth;if(t!==0)return t;const r=i.lij,s=e.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function ZM(i,e){const t=i.screenDepth-e.screenDepth;if(t!==0)return t;const r=i.lij,s=e.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function pw(i,e,t){const r=i.screenDepth,s=e.screenDepth;return r<s?-t:r>s?t:qn(i,e)}function XM(i,e,t,r){return cy(i,r)===cy(e,r)?pw(i,e,t):i?t:-t}function cy(i,e){for(const t of e)if(i.intersectsExtent(t))return!0;return!1}function YM(i,e){const t=i.distanceToPOI-e.distanceToPOI;if(t!==0)return t;const r=i.lij,s=e.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function KM(i,e){const t=i.length;for(let r=0;r<t;++r)i.at(r).updateDistanceToPOI(e);i.sort(YM)}function JM(i,e,t){let r=1,s=0,n=0;for(;i!==e;)if(r*=.5,s*=.5,n*=.5,1&i.lij[2]&&(s+=.5),!(1&i.lij[1])&&(n+=.5),(i=i.parent)==null)throw new Error("tile was not a descendant of upsampleTile");t.init(e,s,n,r)}function e9(i){for(let e=0;e<i.length;e++){const t=i[e],r=t.parent;if(r)for(let s=0;s<4;s++){const n=r.children[s];if(n&&n!==t)return!0}}return!1}function GF(i,e){if(!i||!e||i[0]===e[0])return!1;const t=i[0]<e[0],r=t?i:e,s=t?e:i,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}let Bg=class{get updating(){return!!this._tileRequested}init(e,t,r,s){this.tile=e,this._layerIdx=t,this._layerClass=r,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(t,r),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,ni.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,r=this.tile.surface.layerViewByIndex(e,t),s=Hm(r),{minLevel:n,maxLevel:a}=r.dataLevelRange,o=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+o,c=this._scaleRangeEnabled?Yc:()=>!0;let d=this.tile;const u=d.level;let m;const _=this._tileLayerInfo.upsampleInfo,f=_!=null?_.tile.level:-1,y=_!=null&&f-u>=o,b=s==null?void 0:s.tilemapCache,x=r.type==="vector-tile-3d"?r.schemaHelper:null;for(;d&&c(d,s,!1)&&d.level>=n;){const w=d.level,C=u-w,T=d.layerInfo[t][e];if(T.data&&C>=o){(!y||w>f)&&this._setUpsampleTile(d),T.dataInvalidated&&(m=d);break}const P=(x==null?void 0:x.getLevelRowColumn(d.lij))??d.lij;if((b==null?void 0:b.getAvailability(P[0],P[1],d.lij[2]))!=="unavailable"&&w<=a&&!T.data&&!T.dataMissing&&((!m||d.level===n||w%Kv==0||u-m.level<o)&&(m=d),C>=l))break;d=d.parent}if(m!=null&&u-m.level<o)if(_)m=null;else{const w=this._findAncestorWithData();w!=null&&(this._setUpsampleTile(w),m=w.layerInfo[t][e].dataInvalidated?w:null)}return m}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let r;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=t)return s;r=s}return r}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,ni.FADING,t)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}},t9=class extends Bg{get _desiredMinLevelDelta(){throw hy}get _progressiveLevelModulo(){throw hy}dispose(){}};const hy=new Error("Abstract method called on TileAgent"),yr=new t9;let mw=class extends Bg{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return Gm(this.tile.level)-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}},_w=class extends Bg{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Kv}};var _o,Po;(function(i){i[i.Stretch=0]="Stretch",i[i.Lut=1]="Lut",i[i.Hillshade=2]="Hillshade",i[i.COUNT=3]="COUNT"})(_o||(_o={})),function(i){i[i.Noop=0]="Noop",i[i.PerBand=1]="PerBand",i[i.COUNT=2]="COUNT"}(Po||(Po={}));function i9(i){i.fragment.uniforms.add(new Be("u_colormap",e=>e.u_colormap),new Ne("u_colormapOffset",e=>e.colormap.u_colormapOffset),new Ne("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new Ne("u_opacity",e=>e.common.u_opacity)),i.fragment.code.add(g`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function r9(i){i.fragment.uniforms.add(new Be("u_transformGrid",e=>e.u_transformGrid),new $i("u_transformSpacing",e=>e.common.u_transformSpacing),new $i("u_targetImageSize",e=>e.common.u_targetImageSize)),i.fragment.code.add(g`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}let gw=class extends di{constructor(){super(...arguments),this.scale=1,this.offset=yu}};function fw(i){i.attributes.add(ae.POSITION,"vec2"),i.attributes.add(ae.UV0,"vec2"),i.vertex.uniforms.add(new Ne("scale",e=>e.scale)),i.vertex.uniforms.add(new $i("offset",e=>e.offset)),i.varyings.add("uv","vec2"),i.varyings.add("vuv","vec2"),i.vertex.code.add(g`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}let s9=class extends gw{constructor(e,t,r){super(),this.common=e,this.u_image=t,this.u_transformGrid=r}};function n9(i,e){i.include(r9),i.fragment.uniforms.add(new Be("u_image",r=>r.u_image),new dh("u_flipY",r=>r.common.u_flipY),new dh("u_applyTransform",r=>r.common.u_applyTransform));const{requireBilinearWithNN:t}=e;t&&i.fragment.uniforms.add(new $i("u_srcImageSize",r=>r.common.u_srcImageSize)),i.fragment.code.add(g`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),t?i.fragment.code.add(g`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):i.fragment.code.add(g`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}var U;(function(i){i[i.Normal=0]="Normal",i[i.Average=1]="Average",i[i.Lighten=2]="Lighten",i[i.Lighter=3]="Lighter",i[i.Plus=4]="Plus",i[i.Screen=5]="Screen",i[i.ColorDodge=6]="ColorDodge",i[i.Darken=7]="Darken",i[i.Multiply=8]="Multiply",i[i.ColorBurn=9]="ColorBurn",i[i.Overlay=10]="Overlay",i[i.SoftLight=11]="SoftLight",i[i.HardLight=12]="HardLight",i[i.VividLight=13]="VividLight",i[i.Hue=14]="Hue",i[i.Saturation=15]="Saturation",i[i.Luminosity=16]="Luminosity",i[i.Color=17]="Color",i[i.DestinationOver=18]="DestinationOver",i[i.DestinationAtop=19]="DestinationAtop",i[i.DestinationIn=20]="DestinationIn",i[i.DestinationOut=21]="DestinationOut",i[i.SourceAtop=22]="SourceAtop",i[i.SourceIn=23]="SourceIn",i[i.SourceOut=24]="SourceOut",i[i.Xor=25]="Xor",i[i.Difference=26]="Difference",i[i.Exclusion=27]="Exclusion",i[i.Minus=28]="Minus",i[i.Invert=29]="Invert",i[i.Reflect=30]="Reflect",i[i.COUNT=31]="COUNT"})(U||(U={}));const M_={normal:U.Normal,average:U.Average,lighten:U.Lighten,lighter:U.Lighter,screen:U.Screen,plus:U.Plus,"color-dodge":U.ColorDodge,darken:U.Darken,multiply:U.Multiply,"color-burn":U.ColorBurn,overlay:U.Overlay,"soft-light":U.SoftLight,"hard-light":U.HardLight,"vivid-light":U.VividLight,hue:U.Hue,saturation:U.Saturation,luminosity:U.Luminosity,color:U.Color,difference:U.Difference,exclusion:U.Exclusion,minus:U.Minus,invert:U.Invert,reflect:U.Reflect,"destination-over":U.DestinationOver,"destination-atop":U.DestinationAtop,"destination-in":U.DestinationIn,"destination-out":U.DestinationOut,"source-atop":U.SourceAtop,"source-in":U.SourceIn,"source-out":U.SourceOut,xor:U.Xor};function a9(i){return i===U.DestinationOver||i===U.DestinationAtop||i===U.DestinationIn||i===U.DestinationOut||i===U.SourceAtop||i===U.SourceIn||i===U.SourceOut||i===U.Xor}function Hg(i){i.code.add(g`
    float lineFactorAtPosition(float value) {
      float pos = value * ${g.float(257)};
      if(pos < 0.5 || pos > ${g.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function o9(i,e){const t=e.blendMode;t!==U.Normal&&(t===U.Reflect&&i.code.add(g`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),t!==U.ColorDodge&&t!==U.VividLight||i.code.add(g`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),t!==U.ColorBurn&&t!==U.VividLight||i.code.add(g`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),t===U.Overlay&&i.code.add(g`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),t===U.HardLight&&i.code.add(g`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),t===U.SoftLight&&i.code.add(g`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),t===U.VividLight&&i.code.add(g`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),t!==U.Hue&&t!==U.Saturation&&t!==U.Color&&t!==U.Luminosity||(i.code.add(g`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),t!==U.Hue&&t!==U.Saturation||i.code.add(g`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),i.code.add(g`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${t===U.Multiply?g`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Average?g`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Lighten?g`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Darken?g`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Lighter?g`return vec4(cl * ol + cb * ob, ol + ob);`:t===U.Plus?g`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:t===U.Minus?g`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:t===U.Screen?g`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Difference?g`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Invert?g`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:t===U.DestinationOver?g`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:t===U.DestinationAtop?g`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:t===U.DestinationOut?g`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:t===U.SourceAtop?g`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:t===U.SourceOut?g`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:t===U.Xor?g`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:t===U.DestinationIn?g`return vec4(cb * ob * ol, ol * ob);`:t===U.SourceIn?g`return vec4(cl * ol * ob, ol * ob);`:t===U.Hue?g`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Saturation?g`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Color?g`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Luminosity?g`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Exclusion?g`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Reflect?g`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.ColorDodge?g`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.ColorBurn?g`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.Overlay?g`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.SoftLight?g`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.HardLight?g`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===U.VividLight?g`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:g``}
    }
  `))}var Zt,Ui,ys;(function(i){i[i.Composite=0]="Composite",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.GroupBackgroundComposite=3]="GroupBackgroundComposite",i[i.COUNT=4]="COUNT"})(Zt||(Zt={})),function(i){i[i.NotRequired=0]="NotRequired",i[i.Required=1]="Required",i[i.COUNT=2]="COUNT"}(Ui||(Ui={})),function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.COUNT=2]="COUNT"}(ys||(ys={}));function yw(i,e){const t=e.output===Zt.GridComposite,r=e.output===Zt.ColorComposite,s=e.output===Zt.GroupBackgroundComposite,n=e.output===Zt.Composite;t&&i.fragment.include(Hg),r&&i.fragment.uniforms.add(new Ai("backgroundColor",c=>c.backgroundColor));const a=e.baseOpacityMode===Ui.Required;a&&i.fragment.uniforms.add(new Ne("baseOpacity",c=>c.baseOpacity)),n&&i.fragment.uniforms.add(new Be("fboColor",c=>c.fboTexture));const o=e.blendMode!==U.Normal,l=e.premultipliedSource===ys.On;i.fragment.include(o9,e),i.fragment.code.add(g`
    vec4 getBackground(vec2 uv) {
      return ${a?g`baseOpacity *`:""} ${s?g`vec4(0.0, 0.0, 0.0, 0.0)`:r?g`vec4(backgroundColor, 1.0)`:t?g`vec4(gridColor(uv), 1.0)`:g`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${o?g`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:g`
          float composeAlpha = colorLayer.a * opacity;
          return ${!l&&(n&&!a||s)?g`colorLayer * opacity;`:g`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}let Lh=class extends s9{constructor(e,t,r,s,n,a){super(e,s,n),this.colormap=t,this.symbolizer=r,this.u_colormap=a,this.backgroundColor=Fn,this.fboTexture=null,this.baseOpacity=1}},vw=class extends Lh{},bw=class extends Lh{};function xw(i){const e=new Mt;return e.include(fw),e.include(n9,i),e.include(i9,i),e.include(yw,i),e.fragment.code.add(g`vec4 applyBackgroundBlend(vec4 layerColor) {
vec4 bgColor = getBackground(vuv);
return blendLayers(bgColor, layerColor, u_opacity);
}`),i.colorizerType===_o.Stretch?c9(e,i):i.colorizerType===_o.Lut?l9(e):i.colorizerType===_o.Hillshade&&h9(e,i),e}function l9(i){i.fragment.code.add(g`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}function c9(i,e){i.fragment.uniforms.add(new ab("u_bandCount",r=>r.symbolizer.u_bandCount),new Mn("u_minCutOff",r=>r.symbolizer.u_minCutOff,3),new Mn("u_maxCutOff",r=>r.symbolizer.u_maxCutOff,3),new Mn("u_factor",r=>r.symbolizer.u_factor,3),new Ne("u_minOutput",r=>r.symbolizer.u_minOutput),new Ne("u_maxOutput",r=>r.symbolizer.u_maxOutput),new dh("u_useGamma",r=>r.symbolizer.u_useGamma),new Mn("u_gamma",r=>r.symbolizer.u_gamma,3),new Mn("u_gammaCorrection",r=>r.symbolizer.u_gammaCorrection,3),new Ne("u_opacity",r=>r.common.u_opacity)),i.fragment.code.add(g`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e.applyColormap?g`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:g`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;i.fragment.code.add(g`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${e.stretchType===Po.Noop?g`
        fragColor = applyBackgroundBlend(currentPixel);`:g`
        if (currentPixel.a == 0.0) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${t}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}function h9(i,e){const t=i.fragment;t.uniforms.add(new Be("u_image",s=>s.u_image),new ab("u_hillshadeType",s=>s.symbolizer.u_hillshadeType),new Mn("u_sinZcosAs",s=>s.symbolizer.u_sinZcosAs,6),new Mn("u_sinZsinAs",s=>s.symbolizer.u_sinZsinAs,6),new Mn("u_cosZs",s=>s.symbolizer.u_cosZs,6),new Mn("u_weights",s=>s.symbolizer.u_weights,6),new $i("u_factor",s=>s.symbolizer.u_factor),new Ne("u_minValue",s=>s.symbolizer.u_minValue),new Ne("u_maxValue",s=>s.symbolizer.u_maxValue),new $i("u_srcImageSize",s=>s.common.u_srcImageSize)),t.include(ib),t.code.add(g`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),t.code.add(g`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=e.applyColormap?g`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:g`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;t.code.add(g`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}
    }
  `)}const d9=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:bw,ColorizerStretchUniforms:vw,ColorizerUniforms:Lh,build:xw},Symbol.toStringTag,{value:"Module"})),dy={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let u9=class{constructor(e,t,r=null,s=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=r||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=Ae(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...dy,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||dy}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((t,r)=>{var s;return!!((s=this._bandIds)!=null&&s[r])&&t===this._bandIds[r]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?Pr.LINEAR:Pr.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=Ae(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=pR(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:r,height:s,opacity:n}=this,a=mR(t,[r,s],[this.source.width,this.source.height],n),o=_R(e.colormap,e.colormapOffset),l=this.symbolizerParameters.type==="stretch"?gR(this.symbolizerParameters):null,c=this.symbolizerParameters.type==="hillshade"?fR(this.symbolizerParameters):null;return new Lh(a,o,l||c,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>t!=null?t.descriptor.width*t.descriptor.height*4:0).reduce((t,r)=>t+r,0)}return this._memoryUsed}release(){return this._rasterTexture=Ae(this._rasterTexture),this._transformGridTexture=Ae(this._transformGridTexture),this._colormapTexture=Ae(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const r=this.source?this.source.extractBands(t):null;if(!(r&&r.pixels&&r.pixels.length>0))return void(this._rasterTexture=Ae(this._rasterTexture));const s=t==null&&this.bandIds==null||t!=null&&this.bandIds!=null&&t.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&s)return;this._rasterTexture=Ae(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=yR(e,r,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some((s,n)=>s!==t[n])?(this._colormapTexture=Ae(this._colormapTexture),this._colormapTexture=A0(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=A0(e,r),void(this._colormap=r)):(this._colormapTexture=Ae(this._colormapTexture),void(this._colormap=null))}},Zd=class{constructor(){this.waitingAgents=new xt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=nm.acquire();return t._init(e),t}release(){this.dispose(),Xd.delete(this),nm.release(this)}dispose(){this.loadingAgent=Ae(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Pl(this._data)}static prune(){nm.prune(0)}_init(e){this.waitingAgents.clear(),this._data=Pl(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=So(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo!=null&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&t!=null){if(this._upsampleInfo==null)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),JM(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){Pl(this._data),this._data=e}};const nm=new wa(Zd,null,()=>{}),Xd=new Map;function p9(){Xd.size>0&&(console.log(`${Xd.size} live TilePerLayerInfo allocations:`),Xd.forEach(i=>console.log(i,`
`)))}let Ac=class{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){if(--this._refCount,this._refCount===0)if(this._cache){const e=`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`;this._cache.put(e,this)}else this.dispose()}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}};var ne;(function(i){i[i.NONE=0]="NONE",i[i.SPLIT=1]="SPLIT",i[i.ELEVATION=2]="ELEVATION",i[i.MERGE=4]="MERGE",i[i.GEOMETRY=8]="GEOMETRY",i[i.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",i[i.TEXTURE_FADING=32]="TEXTURE_FADING"})(ne||(ne={}));const m9=.1;let Gg=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=ci(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=ci(),this.centerAtSeaLevel=v(),this._center=[v(),Ds(),v()],this.up=HC(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=v(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}static prune(){kg.prune(0),jg.prune(0),Zd.prune()}get _isCached(){return!this.isLeaf&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[kt.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=(e==null?void 0:e.frustumVisibility)??lr.INTERSECTS;this._frustumVisibility=t===lr.INSIDE?lr.INSIDE:t===lr.OUTSIDE?lr.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const r=this._frustumVisibility!==lr.OUTSIDE&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,r,s,n){this._lij[0]=e,this._lij[1]=t,this._lij[2]=r,this.ellipsoid=bt(n.tilingScheme.spatialReference),n.tilingScheme.getExtent(e,t,r,this.extent),n.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,n.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[kt.MIDDLE][3]=0,this.elevationLevel=e,s&&!Number.isNaN(s.elevationBoundsMin)?(this._elevationBoundsMin=s.elevationBoundsMin,this._elevationBoundsMax=s.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=s,this.unsetChildren(),this._surface=n,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const a of Ya){const o=n.numLayers(a),l=this.layerInfo[a];for(const c of l)c.release();l.length=o;for(let c=0;c<o;c++)l[c]=Zd.acquire(this._surface.upsampleInfoPool),a===Te.ELEVATION&&this.findElevationBoundsForLayer(c,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(n.tilingScheme.pixelSize,fc)}dispose(){Jt(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of Ya){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[Te.MAP].reduce((e,t)=>e+(t instanceof Ep?t.usedMemory/t.referenced:0),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_ensureUsedMemory(){var r;if(this._usedMemory!=null)return this._usedMemory;this._usedMemory=this._baseUsedMemory,this._mapTileMemoryInternal=0;let e=0;for(const{data:s}of this.layerInfo[Te.MAP])s instanceof Ep?e+=this._getTerrainDataMemory(s):this._mapTileMemoryInternal+=this._getTerrainDataMemory(s);const t=this._cpuImageMemorySize;for(const s of this.layerInfo[Te.ELEVATION])this._usedMemory+=s.data?t:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=((r=this.renderData.texture)==null?void 0:r.usedMemory)??0),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,t){const r=this.layerInfo[e][t];return r!=null&&r.data?e===Te.MAP?this._isCached?0:this._getTerrainDataMemory(r.data):e===Te.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof Ac?e.texture.usedMemory:e instanceof HTMLImageElement||e instanceof P3?this._cpuImageMemorySize:e instanceof u9?e.memoryUsage:e instanceof Ep?e.usedMemory/e.referenced:0}updateScreenDepth(e){const t=this._center[kt.MIDDLE],r=e,s=t[0],n=t[1],a=t[2],o=r[2]*s+r[6]*n+r[10]*a+r[14];this.screenDepth=o<0?0:o/(r[3]*s+r[7]*n+r[11]*a+r[15])}shouldSplit(e,t,r){if(!this.visible||e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===lr.OUTSIDE))return ne.NONE;const s=this.level;ve(Cd,At(this._center[kt.MIDDLE]),t);let n=xs(Cd),a=Cd,o=At(this._center[kt.MIDDLE]);ve(am,this._center[kt.TOP],t);const l=xs(am);l<n&&(n=l,a=am,o=this._center[kt.TOP]),ve(om,this._center[kt.BOTTOM],t);const c=xs(om);if(c<n&&(n=c,a=om,o=this._center[kt.BOTTOM]),this._edgeLen2>n&&s<e.maxLod)return ne.SPLIT;const d=Math.sqrt(n),u=e.fovX*d*2,m=this._edgeLen/u,_=()=>{if(s<e.maxLod)return this.elevationLevel=s,ne.NONE;const R=s+Math.ceil(-Math.log2(e.relativeWidthLimit/m));return R!==this.elevationLevel?(this.elevationLevel=R,ne.ELEVATION):ne.NONE},f=r!=null?r-s:1/0;if(f<=.5)return _();const y=pe(this.up,Cd),b=this._elevationBoundsMax-this._elevationBoundsMin,x=b/this.edgeLen;if(e.aboveGround&&y>0&&x<.001&&y/d-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-x>0)return ne.NONE;const w=r!=null?3-Math.min(f,2):1;if(m*w<e.relativeWidthLimit||s>=e.maxLod)return _();if(s<7)return ne.SPLIT;re(yi,this.up,y),ve(yi,yi,a);const C=xs(yi);if(C<=this.radius*this.radius)return ne.SPLIT;re(yi,yi,this.radius/Math.sqrt(C)),fe(yi,yi,o),ve(yi,t,yi);const T=Math.min(1,(Math.abs(pe(yi,this.up))+.5*b+this._curvatureHeight)/we(yi)),P=m9/e.angledSplitBias,S=e.fovY*d*2;return T*(this._edgeLen/S*w)<P*e.relativeHeightLimit?ne.NONE:ne.SPLIT}setChildren(e,t,r,s){Jt(!!(e&&t&&r&&s),"Null child passed");const n=this._children;return n[0]=e,n[1]=t,n[2]=r,n[3]=s,n}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var e;return((e=this.renderData)==null?void 0:e.hasGeometry)??!1}load(){this.refMapData();for(const e of Ya)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const t of Ya){const r=this.layerInfo[t];for(const s of r)s.loadingAgent&&s.loadingAgent!==yr&&(wd(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(ne.GEOMETRY),this.resetPendingUpdate(ne.TEXTURE_NOFADING),this.resetPendingUpdate(ne.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[Te.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==yr&&(wd(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(uo(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,r=this._isWithinClippingArea;e!=null?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=r&&this._isWithinClippingArea,n=!(r||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(ne.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const r=this.layerInfo[t][e];return!(!(r!=null&&r.data)||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Ya){const t=this.layerInfo[e];for(const r of t)if(r.loadingAgent&&r.loadingAgent!==yr&&r.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(ne.SPLIT)||e!==Te.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===ne.SPLIT||e===ne.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,r){const s=this.layerInfo[t][e];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),t,e),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),t,e);const o=s.data&&"type"in s.data&&s.data.type==="vector-tile";return r.dataArrived(this,o),!0}if(s.requestPromise)return!0;So(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,t,s.requestAbort);if(!n)return s.requestAbort=null,!1;const a=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(a,a),!0}get isLeaf(){return this._children[0]==null}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return xs(ve(yi,At(this._center[kt.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const r=this.extent;return e>=r[0]&&t>=r[1]&&e<=r[2]&&t<=r[3]}unrequestLayerData(e,t,r){const s=this.layerInfo[t][e],n=s.waitingAgents,a=n.removeUnordered(r)!=null;Jt(a,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,r){const s=r!=null&&"type"in r&&r.type==="vector-tile",n=this.layerInfo[t][e];n.data=r,n.dataInvalidated=!1,n.waitingAgents.forAll(a=>a.dataArrived(this,s)),n.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t,r){r.notInTilemap||console.error(`Tile ${this._lij.toString()} layer ${t}/${e} error ${r}`);const s=this.layerInfo[t][e];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,r){switch(r&&this.forEachLoadedNeighbor(s=>s.updateRenderData(e,t)),e){case Te.MAP:return this._updateTexture(t);case Te.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===ni.FADING?ne.TEXTURE_NOFADING:ne.TEXTURE_FADING),this.setPendingUpdate(e===ni.FADING?ne.TEXTURE_FADING:ne.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(ne.GEOMETRY);for(const e of this.layerInfo[Te.ELEVATION])e.pendingUpdates|=ne.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax;let r=1/0,s=-1/0;const n=this.layerInfo[Te.ELEVATION];let a=!0;for(const o of n)o.elevationBounds!=null&&(r=Math.min(r,o.elevationBounds.min),s=Math.max(s,o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(a=!1));a&&(r=Math.min(r,0),s=Math.max(s,0)),e===r&&t===s||(this._elevationBoundsMin=r,this._elevationBoundsMax=s,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBoundsMin,t=this._elevationBoundsMax,r=.5*(e+t),s=this._center;re(yi,this.up,r),fe(At(s[kt.MIDDLE]),this.centerAtSeaLevel,yi),re(yi,this.up,e),fe(s[kt.TOP],this.centerAtSeaLevel,yi),re(yi,this.up,t),fe(s[kt.BOTTOM],this.centerAtSeaLevel,yi)}findElevationBoundsForLayer(e,t){const r=this.layerInfo[Te.ELEVATION][e],s=Gm(this.level),n=Math.max(this.elevationLevel-s,0),a=r.elevationBounds;if(a!=null&&a.level>=t&&a.level<=n)return;const o=this._surface.layerViewByIndex(e,Te.ELEVATION),l=Hm(o);if(!Yc(this,l,!1))return;const c=g9;let d=!1;const u=r.data;if(u&&u.level<=n){const m=r.data;c.min=m.samplerData.data.minValue,c.max=m.samplerData.data.maxValue,c.hasNoDataValues=m.samplerData.data.hasNoDataValues,c.level=this.level,d=!0}else{let m,_,f=0;for(let y=this._parent;y&&(!_||f<s)&&(f=this.elevationLevel-y.level,m=_||m,_=y.layerInfo[Te.ELEVATION][e].data,!(!_&&m&&y.level<=n));y=y.parent);_=_||m,_&&(_.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],c),c.min!==1/0&&(c.level=_.level,d=!0))}d&&(r.elevationBounds==null&&(r.elevationBounds=new bl),r.elevationBounds.copyFrom(c))}modifyLayers(e,t,r){const s=this.layerInfo[r];for(const o of s)o.loadingAgent&&o.loadingAgent!==yr&&(wd(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<s.length;++o)e[o]===void 0&&s[o].release();const n=new Array(...s),a=t.length;s.length=a;for(let o=0;o<a;o++){const l=t[o];s[o]=l>-1?n[l]:Zd.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,ni.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const r of t)r.loadingAgent===yr&&(r.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Ya){const t=this._isSuspended(e);for(const r of this.layerInfo[e])r.loadingAgent&&r.loadingAgent!==yr&&(r.loadingAgent.setSuspension(t),r.loadingAgent===yr&&this.updateRenderData(e,ni.FADING))}}removeLayerAgent(e,t){const r=this.layerInfo[t][e];r.loadingAgent&&r.loadingAgent!==yr&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(e,t){const r=this.layerInfo[t][e];r.loadingAgent=yr,r.data||r.upsampleInfo!=null||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||Ll(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,r){var s,n,a;for(let o=e;o<t;++o){const l=this._surface.layerViewByIndex(o,r);if(ch(l)&&((s=l==null?void 0:l.layer)==null?void 0:s.blendMode)!=="normal"||Ll((n=l==null?void 0:l.layer)==null?void 0:n.parent)&&this._hasBlendableAncestor((a=l==null?void 0:l.layer)==null?void 0:a.parent))return!0}return!1}_createOrUpdateAgents(e,t){const r=this.layerInfo[t];if(r.length===0)return;const s=this._isSuspended(t);for(let n=e;n<r.length;++n){const a=r[n];let o=!1;const l=this._surface.layerViewByIndex(n,t),c=Hm(l);if(a.loadingAgent?Yc(this,c,!1)?(a.loadingAgent!==yr&&a.loadingAgent.setSuspension(s),a.loadingAgent!==yr&&(o=a.loadingAgent.update())):a.dispose():Yc(this,c,!1)&&(a.loadingAgent=_9(this,n,t,s),o=a.loadingAgent.startLoading(),o?a.loadingAgent===yr&&this.setPendingUpdate(ne.GEOMETRY):(wd(a.loadingAgent),a.loadingAgent=yr)),a.loadingAgent===yr&&this.updateRenderData(t,ni.FADING),!this._hasBlendModes(e,r.length,t)&&o&&l.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,r=Math.max(this.level-e,Gm(this.level)-t),s=ie(1+(this.maxTesselation>>r),2,this.maxTesselation+1),n=this.getDefaultVerticesPerSide();return Math.max(s,n)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,t){if(!e)return null;const r=this.surface.rootTiles;if(r!=null){for(const s of r)if(f9(s,e)){let n=s,a=e[0]-n.level-1;for(;a>=0&&!n.isLeaf&&!t(n);){const o=e[1]>>a&1,l=e[2]>>a&1;n=n.children[2*o+l],a--}return t(n)?n:null}}return null}findNeighborTile(e,t){const r=this._lij,s=this.getNeighborLIJ(r,e);return s?Yd(r,s)?t(this)?this:null:this._findLIJ(s,t):null}findCorner(e,t){const r=e===_t.NORTH_EAST?1:e===_t.NORTH_WEST?0:e===_t.SOUTH_WEST?2:3;let s=this;for(;s.children[0]&&(!t||!t(s));)s=s.children[r];return s}findNeighborCornerTileExact(e,t){var r;return((r=this.findNeighborTile(e,s=>t(s)||s.level===this.level))==null?void 0:r.findCorner(gu(e),t))||null}forAllSubtreeOnSide(e,t){const r=e===_t.NORTH?[0,1]:e===_t.NORTH_EAST?[1]:e===_t.EAST?[1,3]:e===_t.SOUTH_EAST?[3]:e===_t.SOUTH?[2,3]:e===_t.SOUTH_WEST?[2]:e===_t.WEST?[0,2]:[0],s=n=>{const a=n.children;!t(n)&&a[0]&&r.forEach(o=>s(a[o]))};s(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const r=this.level-t.level;if(I(!Bi||r>=0),r===0)return 0;const s=2**r,n=(1&e)==1,a=n?0:1,o=t.lij[a+1]*s,l=this._lij[a+1],c=l-o,d=n?s-1-c:c;return Bi&&(I(o<=l&&l<o+s),I(0<=d&&d<s)),d}forEachLoadedNeighbor(e){const t=this.level,r=s=>s.level===t||s.isLoaded;Ps.forEach(s=>{const n=this.findNeighborTile(s,r);n!=null&&n!==this&&n.forAllSubtreeOnSide(K_(s),a=>!!a.isLoaded&&(e(a,s),!0))}),fu.forEach(s=>{var a;const n=(a=this.findNeighborTile(s,r))==null?void 0:a.findCorner(gu(s),o=>o.isLoaded);I(!n||D_(this,n,s)),n!=null&&n.isLoaded&&e(n,s)})}getNeighborLIJ(e,t){const r=Zf(t)?-1:Xf(t)?1:0,s=Yf(t)?-1:Kf(t)?1:0,n=[e[0],e[1]+r,e[2]+s];return n[1]<0?null:this.surface.isGlobal?this.wrapLIJ(n):n[2]<0?null:n}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return this._lij[2]===0}get isNorthEnd(){return this._lij[1]===0}get isSouthEnd(){const e=this.surface.extent,t=(e==null?void 0:e[1])??null;return t!=null&&this.extent[1]+GC()>=t}checkGeometryWaterproofness(){var e;km&&(I(this.isLoaded),(e=this.renderData)==null||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,r=this.surface.rootTilesExtent,s=.25*(t[2]-t[0]);if(Zf(e)&&t[3]+s>=r[3]||Xf(e)&&t[1]-s<=r[1])return!1;const n=this.surface.isGlobal;return!(!n&&Yf(e)&&t[0]-s<=r[0])&&!(!n&&Kf(e)&&t[2]+s>=r[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;le(this._lastPOI,e);const r=this._center[kt.MIDDLE],s=e[0]-r[0],n=e[1]-r[1],a=e[2]-r[2];this.distanceToPOI=s*s+n*n+a*a}};function _9(i,e,t,r){const s=t===Te.ELEVATION?jg.acquire():kg.acquire();return s.init(i,e,t,r),s}function wd(i){i.dispose(),i instanceof mw?jg.release(i):i instanceof _w&&kg.release(i)}const kg=new wa(_w),jg=new wa(mw),g9=new bl;var kt;function f9(i,e){const t=i.lij,r=e[0]-t[0];return!(r<0)&&e[1]>>r===t[1]&&e[2]>>r===t[2]}function Yd(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]}function y9(i,e,t){if(i==null||e==null)return!1;if(i.level===0&&e.level===0&&(i.isEastEnd&&e.isWestEnd&&t===_t.EAST||i.isWestEnd&&e.isEastEnd&&t===_t.WEST))return!0;const r=Math.max(1e-6*(i.extent[2]-i.extent[0]),1);switch(t){case _t.NORTH:return Wr(i.extent[3],e.extent[1],r);case _t.SOUTH:return Wr(i.extent[1],e.extent[3],r);case _t.EAST:return Wr(i.extent[2],e.extent[0],r)||Wr(i.extent[2],-e.extent[0],r);case _t.WEST:return Wr(i.extent[0],e.extent[2],r)||Wr(i.extent[0],-e.extent[2],r)}}function D_(i,e,t){return i!=null&&e!=null&&e!==i&&(i.level>=e.level?uy(i,e,t):uy(e,i,gu(t)))}function uy(i,e,t){I(i.level>=e.level);const r=S3(t),s=R3(t),n=i.extent,a=e.extent,o=[r?n[0]:n[2],s?n[3]:n[1]],l=[r?a[2]:a[0],s?a[1]:a[3]],c=1e-5*(n[2]-n[0]),d=Wr(o[0],l[0],c)||i.surface.isGlobal&&Wr(o[0],-l[0],c),u=Wr(o[1],l[1],c);if(d&&u)return!0;if(i.level===e.level)return I(!1),!1;if(!d&&!u)return I(!1),!1;const m=d?py(a[1],a[3],n[1],n[3],c):py(a[0],a[2],n[0],n[2],c);return I(m),m}function py(i,e,t,r,s){return i-s<=t&&t<=r&&r<=e+s}(function(i){i[i.TOP=0]="TOP",i[i.MIDDLE=1]="MIDDLE",i[i.BOTTOM=2]="BOTTOM"})(kt||(kt={}));const Cd=v(),am=v(),om=v(),yi=v();let v9=class{constructor(){this._scales=Jr(-1,-1,-1,-1),this._offsets=Jr(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,r){this._scales[2*e]=t,this._scales[2*e+1]=r}setOffset(e,t,r){this._offsets[2*e]=t,this._offsets[2*e+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}};function b9(i,e){i.varyings.add("tbnTangent","vec3"),i.varyings.add("tbnBiTangent","vec3"),e.spherical?i.vertex.code.add(g`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):i.vertex.code.add(g`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),i.fragment.code.add(g`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}var tn;(function(i){i[i.LayerOnly=0]="LayerOnly",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.COUNT=3]="COUNT"})(tn||(tn={}));let x9=class extends ug{constructor(){super(...arguments),this.overlayOpacity=1}};function w9(i,e){const{vertex:t,fragment:r,varyings:s}=i;s.add("vtc","vec2"),t.uniforms.add(new my("texOffsetAndScale")),r.uniforms.add(new _y("tex")),r.uniforms.add(new lm("textureOpacities"));const n=e.textureFadingEnabled&&!e.renderOccluded;n&&(t.uniforms.add(new my("nextTexOffsetAndScale")),s.add("nvtc","vec2"),r.uniforms.add(new _y("texNext")),r.uniforms.add(new lm("nextTexOpacities")),r.uniforms.add(new C9("fadeFactor")));const a=e.tileBlendInput===tn.ColorComposite,o=e.tileBlendInput===tn.GridComposite;o&&r.include(Hg),a&&r.uniforms.add(new lm("backgroundColor")),t.code.add(g`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${n?g`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:g``}
  }`),r.code.add(g`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${o||a?g`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${a?g`backgroundColor`:g`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:g`return color;`}
    }`),n?r.code.add(g`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(g`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}let C9=class extends Hl{constructor(e){super(e,"float")}},lm=class extends Hl{constructor(e){super(e,"vec3")}},my=class extends Hl{constructor(e){super(e,"vec4")}},_y=class extends Hl{constructor(e){super(e,"sampler2D")}},Wg=class extends x9{};function ww(i){const e=new Mt,{vertex:t,fragment:r,varyings:s}=e;e.include(J3),e.include(ob,i),e.include(ep,i);const n=()=>{e.include(IT,i),t.code.add(g`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};eP(t,i),e.include(Gb,i);const a=i.overlayMode!==vu.Disabled,o=a&&i.invisible;switch(i.output){case E.Color:{e.include(w9,i),e.include(Pu,i),a&&e.include(rc,{...i,pbrMode:i.pbrMode===Et.Simplified?Et.TerrainWithWater:Et.Water});const l=i.overlayMode===vu.EnabledWithWater;l&&e.include(b9,i),s.add("vnormal","vec3"),s.add("vpos","vec3"),s.add("vup","vec3"),n(),i.screenSizePerspective&&s0(t);const c=i.receiveShadows&&!i.renderOccluded;c&&e.include(lb,i),i.screenSizePerspective&&(s.add("screenSizeDistanceToCamera","float"),s.add("screenSizeCosAngle","float")),t.code.add(g`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${l?g`forwardVertexTangent(vnormal);`:g``}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${a?g`setOverlayVTC(uv);`:""}
          ${i.tileBorders?g`forwardTextureCoordinates();`:""}

          ${i.screenSizePerspective?g`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${c?g`forwardLinearDepth();`:""}

        }
      `),e.include(cb,i),e.include(Pu,i),e.include(NS,i),e.include(FS,i),tP(r,i),VS(r),$b(r),r.uniforms.add(t.uniforms.get("localOrigin"),new Ai("viewDirection",(d,u)=>oe(gy,Ie(gy,u.camera.viewMatrix[12],u.camera.viewMatrix[13],u.camera.viewMatrix[14])))),l&&r.uniforms.add(new Be("ovWaterTex",(d,u)=>{var m;return(m=u.overlay)==null?void 0:m.getTexture(vs.WaterNormal)}),new iP("view",(d,u)=>sh(T9,u.camera.viewMatrix,d.origin))),r.code.add(g`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),J_(r),hb(r),r.code.add(g`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${i.receiveShadows&&!i.renderOccluded?"readShadowMap(vpos, linearDepth)":i.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${a?g`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${i.invisible?g`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${i.pbrMode===Et.Simplified||i.pbrMode===Et.TerrainWithWater?g`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:g`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${l?g`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${i.screenSizePerspective?g`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${i.visualizeNormals?i.spherical?g`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:g`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${i.tileBorders?g`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          fragColor = highlightSlice(fragColor, vpos);
        }
      `)}break;case E.LinearDepth:o&&e.include(rc,i),e.include(Xm,i),n0(e),a0(e),t.code.add(g`
              void main(void) {
                ${o?g`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
              }
          `),r.code.add(g`
              void main() {
                ${o?g`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
                outputDepth(linearDepth);
              }
          `);break;case E.Shadow:case E.ShadowHighlight:case E.ShadowExcludeHighlight:e.include(Xm,i),n0(e),a0(e),t.code.add(g`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),r.code.add(g`void main() {
outputDepth(linearDepth);
}`);break;case E.Normal:o&&e.include(rc,i),s.add("vnormal","vec3"),s0(t),n(),t.code.add(g`
        void main(void) {
          ${o?g`setOverlayVTC(getUV0());`:""}
          gl_Position = transformPosition(proj, view, position);
          vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
        }
      `),r.code.add(g`
        void main() {
          ${o?g`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
          vec3 normal = normalize(vnormal);
          if (gl_FrontFacing == false) {
            normal = -normal;
          }
          fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
        }
      `);break;case E.Highlight:a&&e.include(rc,i),t.code.add(g`
          void main() {
            ${a?g`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),e.include(kb,i),r.code.add(g`
          void main() {
            ${a?g`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return i.output===E.ObjectAndLayerIdColor&&(a?(e.include(rc,{...i,pbrMode:Et.Disabled}),t.code.add(g`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),r.code.add(g`void main() {
fragColor = getOverlayColorTexel(vtcOverlay);
}`)):(t.code.add(g`void main(void) {}`),r.code.add(g`void main() {
fragColor = vec4(0.0);
}`))),e}const T9=ct(),gy=v(),P9=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:Wg,build:ww},Symbol.toStringTag,{value:"Module"}));let Cw=class Tw extends Ft{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.spherical=e.viewingMode===Re.Global}initializeProgram(e){return new Dt(e.rctx,Tw.shader.get().build(this.configuration),Pw)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,r=t.backfaceCullingEnabled&&!t.renderOccluded;return nt({blending:t.renderOccluded?cn(Z.ONE,Z.ONE_MINUS_SRC_ALPHA):null,culling:r?bb:null,depthTest:t.renderOccluded?null:{func:Hi.LESS},depthWrite:t.renderOccluded?null:xb,colorWrite:lt,stencilTest:e?rP(Gc.IntegratedMeshMaskExcluded):null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}};Cw.shader=new Nt(P9,()=>he(()=>Promise.resolve().then(()=>k$),void 0));const Pw=new Map([[ae.POSITION,0],[ae.UV0,1],[ae.NORMALCOMPRESSED,2]]);let S9=class{constructor(){this.geometry=new GM,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureRef=new hw(()=>this.tile.surface.fadeDuration),this.overlay=new v9,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new jM,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),Bi&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)I(this.geometry.getEdgeCount(t)===this.geometryState.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){var l;const r=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){const c=r.surface.extent;if(c!=null&&(e===0&&r.extent[3]>c[3]||e===1&&r.extent[2]>c[2]||e===2&&r.extent[1]<c[1]||e===3&&r.extent[0]<c[0]))return s}const n=r.level,a=Ps[e];if(!t)return I(((l=r.surface)==null?void 0:l.rootTiles)==null||r.surface.updatingRootTiles||!r.shouldHaveNeighbor(a)),s;if(t.isLoaded){const c=t,d=c.renderData.geometryState,u=n-c.level;if(I(u>=0),u===0){const f=d.numVerticesPerSide-1;return Math.max(f,s)}const m=2**u,_=d.edgeResolutions[(e+2)%4]/m;return Math.max(1,_)}I(!t.isLeaf);let o=s;return t.forAllSubtreeOnSide(K_(a),c=>c===r||(c.isLoaded?(o=Math.max(o,2**(c.level-n)),!0):(I(!c.isLeaf),!1))),o}updateNeighborData(){var a;const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,r=o=>(o.isLoaded||o.level===e.level)&&(o==null?void 0:o.intersectsClippingArea),s=t.edgePeerNeighbors,n=t.edgePeerNeighborSamplerVersions;for(let o=0;o<4;++o){const l=e.findNeighborTile(Ps[o],r),c=ao(e,l),d=((a=c==null?void 0:c.renderData)==null?void 0:a.geometryState.samplerDataVersion)??-1,u=s[o],m=c!==ao(e,u),_=n[o]!==d;Bi&&l&&(I(e.level>=l.level),I(e.level-l.level<=ei)),s[o]=l,(m||_)&&(n[o]=d,this._markEdgeDirty(o));const f=t.edgeResolutions[o],y=this._calculateEdgeResolution(o,l);I(oh(y)),I(y>=1),t.edgeResolutions[o]=y,f!==y&&this._markEdgeResolutionDirty(o)}for(let o=0;o<4;++o){const l=e.findNeighborTile(fu[o],r);t.cornerPeerNeighbors[o]=l;const c=ao(e,s[o]),d=ao(e,s[(o+1)%4]),u=ao(e,l);ns[o]=u,ns[(o+1)%4]=d,ns[(o+2)%4]=e,ns[(o+3)%4]=c,I(ns.some(y=>(y==null?void 0:y.isLoaded)||y===e));const m=ns.reduce((y,b)=>Math.min(y,(b==null?void 0:b.level)??1/0),1/0);ns.forEach((y,b)=>{y&&(y==null?void 0:y.level)>m&&(ns[b]=null)}),I(ns.some(y=>(y==null?void 0:y.isLoaded)||y===e));const _=t.cornerNeighborCornerTiles,f=t.cornerNeighborCornerTileSamplerVersions;for(let y=0;y<4;++y){const b=ns[y],x=(b==null?void 0:b.renderData.geometryState.samplerDataVersion)??-1,w=4*o+y,C=_[w]!==b,T=!C&&f[w]!==x;(C||T)&&(_[w]=b,f[w]=x,this._markCornerDirty(o))}Bi&&I(Qg.some(y=>{var b;return((b=_[4*o+y])==null?void 0:b.isLoaded)||_[4*o+y]===e}))}Bi&&I(this.geometryState.edgeResolutions.every(o=>o>0));for(let o=0;o<4;++o)ns[o]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;Bi&&I(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(_=>_>0)),this.intersectionData=null;const{tile:t,_vao:r,geometry:s,geometryState:n}=this,a=!r||!1||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,o=this.dirtyEdgeResolutions!==0,l=n.edgeResolutions.reduce((_,f)=>_+f+1,0),c=a||o&&l>((s==null?void 0:s.maxEdgeVertexCount)??0),d=!c&&o,u=!d&&(this.dirtyEdges!==0||o),m=!u&&this.dirtyCorners!==0;c?(this.releaseGeometry(),this._createGeometry(e)):d?t.updateEdgeElevationsAndResolutions():u||m?t.updateEdgeElevations():m?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=Ae(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,r){const s=t?hi.RGBA:hi.RGB;return this._texture==null||this._texture.descriptor.width===e&&this._texture.descriptor.pixelFormat===s||this.releaseTexture(),this._texture==null&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture!=null&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}get numVerticesPerSideChanged(){return(this._modifiedFlags&O9)!=0}get samplerDataChanged(){return(this._modifiedFlags&E9)!=0}get clippingAreaChanged(){return(this._modifiedFlags&A9)!=0}get wireframeChanged(){return(this._modifiedFlags&M9)!=0}get dirtyEdges(){return this._modifiedFlags>>cm&15}get dirtyCorners(){return this._modifiedFlags>>hm&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>dm&15}_markCornerDirty(e){const t=1<<e<<hm;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<cm;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<dm;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<hm|15<<cm|15<<dm}updateGeometryState(){const e=this._getElevationInfo(),t=this.tile,r=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),s=Math.max(r,5);let n=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(n=null);const a=this.geometryState;let o=!1;a.numVerticesPerSide!==s&&(this._modifiedFlags|=1,a.numVerticesPerSide=s,a.samplerDataVersion++,o=!0),e.changed&&(this._modifiedFlags|=2,a.samplerData=e.samplerData,a.samplerDataVersion++,o=!0),j_(a.clippingArea,n)||(this._modifiedFlags=4,a.clippingArea=n,o=!0);const l=t.surface.wireframe;return a.wireframe!==l&&(this._modifiedFlags=8,a.wireframe=l,o=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,r=this.geometry.indices,s=e.gl;this._vao=new jn(e,Pw,{geometry:Aa(t.layout)},{geometry:ur.createVertex(e,s.STATIC_DRAW,t.buffer)},ur.createIndex(e,s.STATIC_DRAW,r)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=va.Immediate){e!=null&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[Te.ELEVATION],r=t.length,s=new Array(r);let n=0,a=0,o=!1;for(let d=0;d<r;d++){const u=t[d];if(u.upsampleInfo!=null){const m=u.upsampleInfo.tile,_=m.layerInfo[Te.ELEVATION][d].data,f=_&&_.samplerData;e&&e[n]===f||(o=!0),s[n++]=f,a=Math.max(a,m.lij[0])}else if(u.data){const m=this.tile.surface.layerViewByIndex(d,Te.ELEVATION);if(Yc(this.tile,m.layer,!1)){const _=u.data;e&&e[n]===_.samplerData||(o=!0),s[n++]=_.samplerData,a=this.tile.level}}}e!=null&&e.length!==n&&(o=!0);const l=n>0,c=l?s:null;return l&&(s.length=n),{changed:o,samplerData:c,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){var t,r,s;const e=((t=this.intersectionData)==null?void 0:t.estimatedMemoryUsage)??0;return(((r=this.geometry.indices)==null?void 0:r.byteLength)??0)+(((s=this.geometry.vertexAttributes)==null?void 0:s.byteLength)??0)+e}get texture(){return this._texture}get test(){return{hasTexture:this._texture!=null}}checkGeometryWaterproofness(){if(!Bi)return;const e=this.tile;if(!e.isLoaded||!e.intersectsClippingArea||e.level===0)return void I(e==null?void 0:e.isLoaded);const t=e.surface.extent;if(t!=null&&!e.intersectsExtent(t))return;const r=Ps.map((o,l)=>t!=null&&(l<2?-1:1)*(e.extent[3-l]-t[3-l])<0),s=e.level;I(this.dirtyCorners===0),I(this.dirtyEdges===0),I(this.dirtyEdgeResolutions===0),I(!this.numVerticesPerSideChanged),I(!this.samplerDataChanged),I(!this.clippingAreaChanged),I(!this.wireframeChanged);const n=fu.map(o=>e.findNeighborCornerTileExact(o,l=>!l.intersectsClippingArea||l.isLoaded||l.level===e.level)??null).map(o=>o!=null&&o.intersectsClippingArea?o:null),a=this.geometryState;for(let o=0;o<4;++o){const l=a.cornerPeerNeighbors[o],c=n[o];I(c===l,`Tile[${e.lij}].corner[${o}] out of date: cur=[${l==null?void 0:l.lij}] exp=[${c==null?void 0:c.lij}]`)}Ps.forEach((o,l)=>{if(r[l])return;const c=e.findNeighborTile(o,N=>(N.level===s||(N==null?void 0:N.isLoaded))&&(N==null?void 0:N.intersectsClippingArea));if(!c){const N=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(o);return void I(!N)}I(c.isLoaded||c.level===e.level),I(c===this.geometryState.edgePeerNeighbors[l]);const d=s-c.level;if(!c.isLoaded)return I(!c.isLeaf),void I(d===0);const u=c.renderData;I(y9(e,c,o)),I(d>=0);const m=2**d;if(d<0)return void I(!1);const _=e.renderData,f=_.geometry,y=_.localOrigin,b=f.getEdgeCount(l),x=f.numVerticesPerSide-1,w=u.geometry;if(!w)return void I(!1);const C=u.localOrigin,T=this.geometryState.edgePeerNeighbors[l];if(T!=null&&T.isLoaded){const N=T.renderData;I(_.geometryState.edgePeerNeighborSamplerVersions[l]===N.geometryState.samplerDataVersion),I(this.geometryState.edgePeerNeighborSamplerVersions[l]===N.geometryState.samplerDataVersion)}const P=(l+2)%4,S=w.getEdgeCount(P),R=b-1,V=S-1;I(R*m===V,`Tile[${e.lij}]:e${l},res=${R} edgeRes mismatch with Neighbor[${c.lij}]:e${P},res=${V} (expected:${R*m})`);const z=e.extent,K=o===_t.NORTH||o===_t.SOUTH,J=S-1,X=J>>d,me=b-1;if(X<1)return void I(me===1);I(X===me),I(oh(X));const D=w.numVerticesPerSide-1;I(d>0||X===Math.max(D,x));const O=e.getNeighborEdgeStartVertexIndex(l,c);I(0<=O&&O<m);const k=O*X;I(0<=k&&k<=J-X);let H=0,M=k;f.getEdgeVertexPosition(l,Us,y,0),f.getEdgeVertexPosition(l,zs,y,b-1);const G=cr(Us,zs),Q=Math.max(R9,1e-4*G);for(let N=0;N<=X;++N){f.getEdgeVertexPosition(l,Us,y,H),w.getEdgeVertexPosition(P,zs,C,M);const ce=N/X,be=K?z[0]+ce*(z[2]-z[0]):o===_t.WEST?z[0]:z[2],xe=K?o===_t.SOUTH?z[1]:z[3]:z[1]+ce*(z[3]-z[1]),Me=e.surface.extent;if(Me==null||kC(Me,be,xe)){const $t=Tl(Us,zs),gt=Hr(Us)-js.radius,Qe=Hr(zs)-js.radius,Fe=$t<Q;if(!Fe){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${l}[${H}/${b}] and [${c.lij}].edge${P}[${M}/${S}]`),Me!=null&&console.warn("  surface extent= ",Me," x,y=",be,",",xe);const Ke=v();ve(Ke,_.localOrigin,u.localOrigin),Hr(Ke)>0&&console.warn(`   localOrigins: ${_.localOrigin} vs ${u.localOrigin} d=${Hr(Ke)} [${Ke}]`),(()=>{const j=Hn(Us),We=Hn(zs);e.updateEdgeElevations(),c.updateEdgeElevations(),f.getEdgeVertexPosition(l,Us,y,H),w.getEdgeVertexPosition(P,zs,C,M);const B=v();zt(B,Us,j),Hr(B)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${j} vs ${Us} d=${Hr(B)} [${B}]`),zt(B,zs,We),Hr(B)>0&&console.warn(`  XXX Neighbor[${c.lij}] edge out of date: ${We} vs ${zs} d=${Hr(B)} [${B}]`)})();const Ze=f.getEdgeCount(l),Lt=w.getEdgeCount(S);I(Fe,`Mismatch in tile [${e.lij}].edge[${l}][${H}/${Ze}] vs neighbor [${c.lij}].edge[${P}][${M}/${Lt}] ${gn(Us)} vs ${gn(zs)}  dist=${$t} h(t|n|d)=${gt}|${Qe}|${Qe-gt}`)}f.getEdgeNormal(l,Go,H),w.getEdgeNormal(P,ko,M),oe(fy,Go),oe(yy,ko);const it=pe(fy,yy),je=1-it<.01||!1||e===c;if(!je){const Ke=v();zt(Ke,Go,ko);const Ze=()=>`Mismatch in tile edge normal ${Jf(e.lij)} (${H}/${b-1}) edge ${l} vs neighbor ${Jf(c.lij)}  (${M}/${S-1}) nedge ${P} :${gn(Go)} vs ${gn(ko)}  dot = ${it} : ${gn(Ke)}`;console.warn("Mismatch in tile edge normal: ",Ze());{e.updateEdgeElevations(),c.updateEdgeElevations();const Lt=v(),j=v();f.getEdgeNormal(l,Lt,H),w.getEdgeNormal(P,j,M),ah(Go,Lt)||console.warn("Missing update in tile normal: ",gn(Go)," => ",gn(Lt)),ah(ko,j)||console.warn("Missing update in neighbor normal: ",gn(ko)," => ",gn(j))}I(je,Ze())}}H+=1,M+=1}})}};const Us=v(),zs=v(),Go=v(),ko=v(),fy=v(),yy=v(),R9=1,ns=[null,null,null,null];function ao(i,e){return e!=null&&e.isLoaded||e===i?e:null}const O9=1,E9=2,A9=4,M9=8,cm=4,hm=8,dm=12,Qg=[0,1,2,3],D9=65536;function $9(i,e){const{tile:t,geometry:r,geometryState:s}=i,{extentInRadians:n,surface:a}=t,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:c,wireframe:d}=s,u=c-1,m=(c-2)**2,_=o&&(e===Ws.HAS_SOUTH_POLE||e===Ws.HAS_BOTH_POLES),f=o&&(e===Ws.HAS_NORTH_POLE||e===Ws.HAS_BOTH_POLES),y=((_?1:0)+(f?1:0))*Kd*c,b=zw(s),x=m+y+4*b,w=l.tileGeometryCache.acquire(x);r.numVerticesPerSide=c,r.vertexAttributes=w,r.maxEdgeVertexCount=b;const{boundingBox:C}=r;pu(C);const T=Xg(i);wi.update(u,n,T),I9(i),r.poleVerticesStartIndex=m;const P=L9(i,_,f);r.edgeVerticesStartIndex=m+y,Kg(i),Zg(i),Dw(r,P,d),i.intersectionData=null}function L9(i,e,t){const{tile:r,localOrigin:s,geometry:n}=i,{extent:a,ellipsoid:o}=r,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:d,poleVerticesStartIndex:u}=n,m=c-1,_=s[0],f=s[1],y=s[2],b=o.radius,x=a[1],w=a[3],C=[];let T=u;const P=(S,R)=>{const V=R*c;Kr(-_,-f,S*b-y,l),C.push({connectedRowOffset:V,connectedOuterEdgeOffset:S===1?0:2,rowOffset:T,latitudeResolution:Kd});const z=Ow(S===-1?x:w,b),K=S*Math.PI/2-z,J=.99*(S===1?1:-1),X=b+0,{position:me,uv0:D}=d,{typedBuffer:O,typedBufferStride:k}=d.normalCompressed;for(let H=1;H<=Kd;++H){const M=z+K*(H/Kd),G=Math.cos(M),Q=Math.sin(M);for(let N=0;N<=m;N++){const ce=N/m,be=wi.sinLonLUT[N],xe=wi.cosLonLUT[N]*G,Me=be*G,$t=Q,gt=xe*X-_,Qe=Me*X-f,Fe=$t*X-y;Kr(gt,Qe,Fe,l),me.setValues(T,gt,Qe,Fe),Es(D,T,ce,J),mh(O,T,xe,Me,$t,k),++T}}};return e&&P(-1,0),t&&P(1,m),C}function I9(i){const{tile:e}=i;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:r,localOrigin:s}=i,{numVerticesPerSide:n,samplerData:a}=r,o=n-2,l=n-1,{vertexAttributes:c,boundingBox:d}=t,u=c.position,m=c.uv0,{typedBuffer:_,typedBufferStride:f}=c.normalCompressed,{extent:y}=e,b=y[0],x=y[2],w=y[1],C=y[3],T=e.ellipsoid.radius,P=s[0],S=s[1],R=s[2],V=u.typedBuffer,z=u.typedBufferStride,K=1/l;let J=0;if(1<=o){const X=K,me=w*(1-X)+C*X,D=wi.sinLatLUT[1],O=wi.cosLatLUT[1];for(let k=1;k<=o;k++){const H=k*K,M=b*(1-H)+x*H,G=wi.sinLonLUT[k],Q=wi.cosLonLUT[k],N=T+Tt(M,me,a),ce=N*Q*O-P,be=N*G*O-S,xe=N*D-R;Kr(ce,be,xe,d);const Me=(k-1)*z;V[Me]=ce,V[Me+1]=be,V[Me+2]=xe,Es(m,k-1,H,X)}}for(let X=1;X<=o;X++){const me=X*K,D=w*(1-me)+C*me,O=wi.sinLatLUT[X],k=wi.cosLatLUT[X],H=X+1,M=H*K,G=w*(1-M)+C*M,Q=wi.sinLatLUT[H],N=wi.cosLatLUT[H],ce=wi.sinLonLUT[0],be=wi.cosLonLUT[0],xe=T+Tt(b,D,a);let Me=be*k*xe-P,$t=ce*k*xe-S,gt=O*xe-R;const Qe=J*z;let Fe=V[Qe],it=V[Qe+1],je=V[Qe+2];for(let Ke=1;Ke<=o;Ke++){const Ze=Ke*K,Lt=b*(1-Ze)+x*Ze,j=wi.sinLonLUT[Ke],We=wi.cosLonLUT[Ke];let B=0,W=0,ue=0;if(Ke<o){const $e=(J+1)*z;B=V[$e],W=V[$e+1],ue=V[$e+2]}else{const $e=wi.sinLonLUT[l],ft=wi.cosLonLUT[l],Bt=T+Tt(x,D,a);B=ft*k*Bt-P,W=$e*k*Bt-S,ue=O*Bt-R}const Ce=Me,Y=$t,ge=gt;Me=Fe,$t=it,gt=je,Fe=B,it=W,je=ue;const q=B-Ce,se=W-Y,ye=ue-ge;let at=0,ut=0,pt=0;if(X>1){const $e=(J-o)*z;at=V[$e],ut=V[$e+1],pt=V[$e+2]}else{const $e=wi.sinLatLUT[0],ft=wi.cosLatLUT[0],Bt=T+Tt(Lt,w,a);at=We*ft*Bt-P,ut=j*ft*Bt-S,pt=$e*Bt-R}const Ge=T+Tt(Lt,G,a),Xe=We*N*Ge-P,Ve=j*N*Ge-S,ke=Q*Ge-R;if(X<o){const $e=J+o,ft=$e*z;V[ft]=Xe,V[ft+1]=Ve,V[ft+2]=ke,Kr(Xe,Ve,ke,d),Es(m,$e,Ze,M)}const ze=at-Xe,Je=ut-Ve,_e=pt-ke;let De=We*k,qe=j*k,rt=O;rt*rt<.999&&(De=ye*Je-se*_e,qe=q*_e-ye*ze,rt=se*ze-q*Je);const Yt=1/Math.sqrt(De*De+qe*qe+rt*rt);mh(_,J,De*Yt,qe*Yt,rt*Yt,f),++J}}}function N9(i){i.tile.intersectsClippingArea&&(Zg(i),Zl(i),i.intersectionData=null)}function F9(i){i.tile.intersectsClippingArea&&(Iw(i),Zg(i),Zl(i),Vw(i),i.intersectionData=null)}function V9(i){i.tile.intersectsClippingArea&&(Rw(i),Sw(i,!0),Zl(i),i.intersectionData=null)}function Zg(i){i.tile.intersectsClippingArea&&(Rw(i),Sw(i))}function Sw(i,e=!1){const{geometry:t,geometryState:r,tile:s,localOrigin:n}=i,{level:a,extent:o,extentInRadians:l,ellipsoid:c}=s,d=c.radius,u=l[0],m=l[2],_=l[1],f=l[3],{samplerData:y}=r,b=o[0],x=o[2],w=o[1],C=o[3],T=Xg(i),{boundingBox:P,vertexAttributes:S}=t,R=n[0],V=n[1],z=n[2],K=S.position,J=K.typedBuffer,X=K.typedBufferStride,me=S.uv0;for(let D=0;D<4;++D){const O=D===1||D===3,k=r.edgeResolutions[D];I(oh(k));const H=k+1,M=ao(s,r.edgePeerNeighbors[D]);if(Uw(s,M,D)){Nw(i,D,M);continue}const G=M!=null;I(!G||M.level===s.level),I(!G||qn(s,M)<=0);const Q=M==null?void 0:M.renderData,N=Q==null?void 0:Q.geometryState;if(Bi){const q=s.surface;if(!M&&q&&!q.updatingRootTiles){const se=Ps[D],ye=s.findNeighborTile(se,at=>at.isLoaded||at.isLeaf||at.level===s.level);ye?ye.intersectsClippingArea&&(I(!ye.isLoaded),I(!ye.isLeaf),I(ye.level===a)):I((q==null?void 0:q.rootTiles)==null||!s.shouldHaveNeighbor(se))}}const ce=D===1?o[2]:o[0],be=M==null?void 0:M.extent,xe=be&&O?D===1?be[0]:be[2]:ce,Me=D===0?o[3]:o[1],$t=D===1?1:0,gt=D===0?1:0,Qe=D===1?m:u,Fe=D===0?f:_,it=Math.sin(Qe),je=Math.cos(Qe),Ke=Math.sin(Fe),Ze=Math.cos(Fe),Lt=N==null?void 0:N.samplerData,j=G?(q,se,ye)=>.5*(Tt(q,se,y)+Tt(ye,se,Lt)):(q,se,ye)=>Tt(q,se,y),We=t.outerEdgesOffsetAndLength[2*D+0],B=e&&H>3?H-3:1,W=y!=null&&y.some(q=>q!=null),ue=Lt!=null&&Lt.some(q=>q!=null),Ce=W||ue,Y=1/k,ge=We;I(!be||Wr(be[2]-be[0],o[2]-o[0])),(()=>{const q=D===1?-1:D===3?1:0,se=D===0?-1:D===2?1:0,ye=(o[2]-o[0])*Y,at=q*ye,ut=se*ye,pt=O?q*((m-u)*Y):0,Ge=O?0:se*Y,Xe=gt,Ve=O?Qe+pt:Qe,ke=O?Math.sin(Ve):it,ze=O?Math.cos(Ve):je,Je=O?Qe-pt:Qe,_e=O?Math.sin(Je):it,De=O?Math.cos(Je):je,qe=O?Fe:T(Xe+Ge),rt=O?Ke:Math.sin(qe),Yt=O?Ze:Math.cos(qe),$e=O?Fe:T(Xe-Ge),ft=O?Ke:Math.sin($e),Bt=O?Ze:Math.cos($e);let Li=0,mr=0,_r=0;{const Ue=0*Y,wt=O?ce:b*(1-Ue)+x*Ue,pi=O?xe:wt,Pi=O?w*(1-Ue)+C*Ue:Me,Kt=O?Qe:u*(1-Ue)+m*Ue,gr=O?it:Math.sin(Kt),Ao=O?je:Math.cos(Kt),pn=O?T(Ue):Fe,Da=O?Math.sin(pn):Ke,mn=O?Math.cos(pn):Ze,_n=d+j(wt,Pi,pi);Li=Ao*mn*_n,mr=gr*mn*_n,_r=Da*_n}let Ii=0,ri=0,Ht=0;{const Ue=1*Y,wt=O?ce:b*(1-Ue)+x*Ue,pi=O?xe:wt,Pi=O?w*(1-Ue)+C*Ue:Me,Kt=O?Qe:u*(1-Ue)+m*Ue,gr=O?it:Math.sin(Kt),Ao=O?je:Math.cos(Kt),pn=O?T(Ue):Fe,Da=O?Math.sin(pn):Ke,mn=O?Math.cos(pn):Ze,_n=d+j(wt,Pi,pi);Ii=Ao*mn*_n,ri=gr*mn*_n,Ht=Da*_n}for(let Ue=1;Ue<H-1;Ue+=B){let wt=0,pi=0,Pi=0;{const fr=(Ue+1)*Y,Ns=O?ce:b*(1-fr)+x*fr,Wn=O?xe:Ns,Gi=O?w*(1-fr)+C*fr:Me,Qn=O?Qe:u*(1-fr)+m*fr,Io=O?it:Math.sin(Qn),Vh=O?je:Math.cos(Qn),Kl=O?T(fr):Fe,Uh=O?Math.sin(Kl):Ke,Jl=O?Math.cos(Kl):Ze,No=d+j(Ns,Gi,Wn);wt=Vh*Jl*No,pi=Io*Jl*No,Pi=Uh*No}const Kt=wt,gr=pi,Ao=Pi,pn=Ii,Da=ri,mn=Ht;Ii=Kt,ri=gr,Ht=Ao;{const fr=ge+Ue,Ns=fr*X,Wn=pn-R,Gi=Da-V,Qn=mn-z;J[Ns]=Wn,J[Ns+1]=Gi,J[Ns+2]=Qn,Kr(Wn,Gi,Qn,P);const Io=Ue*Y;Es(me,fr,O?$t:Io,O?Io:gt)}const _n=Li,J2=mr,eC=_r;Li=pn,mr=Da,_r=mn;const Xl=pn,Yl=Da,Mo=mn,Fh=1/Math.sqrt(Xl*Xl+Yl*Yl+Mo*Mo),gf=Mo*Fh;let Do=0,$o=0,Lo=0;if(Ce&&gf*gf<.999){let fr=0,Ns=0,Wn=0;{const Gi=D===0?-1:1;fr=Gi*(Kt-_n),Ns=Gi*(gr-J2),Wn=Gi*(Ao-eC)}{const Gi=Ue*Y,Qn=O?ce:b*(1-Gi)+x*Gi,Io=O?xe:Qn,Vh=O?w*(1-Gi)+C*Gi:Me,Kl=O?Qe:u*(1-Gi)+m*Gi,Uh=O?it:Math.sin(Kl),Jl=O?je:Math.cos(Kl),No=O?T(Gi):Fe,ff=O?Math.sin(No):Ke,yf=O?Math.cos(No):Ze;let mp=Xl,_p=Yl,gp=Mo;if(G){const $a=d+Tt(Io-at,Vh-ut,Lt),ec=O?yf:Bt;mp=(O?De:Jl)*ec*$a,_p=(O?_e:Uh)*ec*$a,gp=(O?ff:ft)*$a}{const $a=d+Tt(Qn+at,Vh+ut,y),ec=O?yf:Yt,vf=(O?ze:Jl)*ec*$a,bf=(O?ke:Uh)*ec*$a,xf=(O?ff:rt)*$a;G||(mp=2*Xl-vf,_p=2*Yl-bf,gp=2*Mo-xf);const fp=D===3?-1:1,wf=fp*(mp-vf),Cf=fp*(_p-bf),Tf=fp*(gp-xf);Do=Wn*Cf-Ns*Tf,$o=fr*Tf-Wn*wf,Lo=Ns*wf-fr*Cf;const yp=1/Math.sqrt(Do*Do+$o*$o+Lo*Lo);Do*=yp,$o*=yp,Lo*=yp}}}else Do=Xl*Fh,$o=Yl*Fh,Lo=Mo*Fh;t.setEdgeNormalFromValues(D,Ue,Do,$o,Lo)}})()}}function Rw(i){Fw(i)}function Ow(i,e){return Math.PI/2-2*Math.atan(Math.exp(-i/e))}function U9(i,e,t,r){return Ow(i*(1-r)+e*r,t)}function z9(i,e,t){return i*(1-t)+e*t}function Xg(i){const{tile:e}=i;if(e.surface.isWebMercator){const r=e.extent,s=e.ellipsoid.radius;return n=>U9(r[1],r[3],s,n)}const t=e.extentInRadians;return r=>z9(t[1],t[3],r)}function q9(i,e){const{tile:t,geometryState:r,geometry:s}=i,{extent:n,surface:a}=t,{wireframe:o}=r,l=n[0],c=n[1],d=n[2]-l,u=n[3]-c,{numVerticesPerSide:m,clippingArea:_}=r,f=_!=null?Math.max(0,(_[0]-l)/d):0,y=_!=null?Math.max(0,(_[1]-c)/u):0,b=_!=null?Math.min(1,(_[2]-l)/d):1,x=_!=null?Math.min(1,(_[3]-c)/u):1,w=(m-2)**2,C=zw(r),T=w+4*C,P=a.renderer.tileGeometryCache.acquire(T),{boundingBox:S}=s;pu(S),s.numVerticesPerSide=m,s.vertexAttributes=P,s.maxEdgeVertexCount=C,s.minu=f,s.minv=y,s.maxu=b,s.maxv=x,B9(i),s.edgeVerticesStartIndex=w,Kg(i),Yg(i),Dw(s,[],o),i.intersectionData=null}function B9(i){const{tile:e}=i;if(!e.intersectsClippingArea)return;const{geometry:t,geometryState:r,localOrigin:s}=i,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=r,{surface:l,extent:c,ellipsoid:d}=e,{isWebMercatorOnPlateCarree:u}=l,m=a??Jg,_=c[0],f=c[1],y=c[2],b=c[3],x=Math.max(_,m[0]),w=Math.min(y,m[2]),C=Math.max(f,m[1]),T=Math.min(b,m[3]),P=d.radius,S=e.horizontalScale,R=o-1,V=o-2,{minu:z,minv:K,maxu:J,maxv:X,boundingBox:me,vertexAttributes:D}=t,O=D.position,k=D.uv0,{typedBuffer:H,typedBufferStride:M}=D.normalCompressed,G=s[0],Q=s[1],N=s[2],ce=O.typedBuffer,be=O.typedBufferStride;let xe=0;const Me=ie(f,C,T),$t=u?(Math.PI/2-2*Math.atan(Math.exp(-Me/P)))*P:Me*S,gt=1/R,Qe=ie(f*(1-gt)+b*gt,C,T);let Fe=$t,it=u?(Math.PI/2-2*Math.atan(Math.exp(-Qe/P)))*P:Qe*S;for(let je=1;je<=V;je++){const Ke=je/R,Ze=ie(f*(1-Ke)+b*Ke,C,T),Lt=ie(Ke,K,X),j=it,We=(je-1)/R,B=ie(f*(1-We)+b*We,C,T),W=Fe,ue=(je+1)/R,Ce=ie(f*(1-ue)+b*ue,C,T),Y=u?(Math.PI/2-2*Math.atan(Math.exp(-Ce/P)))*P:Ce*S,ge=ie(ue,K,X);Fe=it,it=Y;const q=ie(_,x,w);let se=q*S,ye=Tt(q,Ze,n);const at=1/R,ut=ie(at,z,J),pt=ie(_*(1-ut)+y*ut,x,w);let Ge=ut,Xe=pt,Ve=pt*S,ke=Tt(pt,Ze,n);if(je===1){const ze=Ve-G,Je=Fe-Q,_e=ke-N,De=0*be;ce[De]=ze,ce[De+1]=Je,ce[De+2]=_e,Kr(ze,Je,_e,me);const qe=ie(at,z,J);Es(k,xe,qe,Lt)}for(let ze=1;ze<=V;ze++){const Je=Ve,_e=ke,De=(ze+1)/R,qe=ie(De,z,J),rt=ie(_*(1-De)+y*De,x,w),Yt=Xe;Xe=rt;{const ri=xe+1,Ht=ri*be;if(je===1||ze===V){const Ue=rt*S,wt=Tt(rt,Ze,n);if(je===1&&ze<V){const pi=Ue-G,Pi=j-Q,Kt=wt-N;ce[Ht]=pi,ce[Ht+1]=Pi,ce[Ht+2]=Kt,Kr(pi,Pi,Kt,me),Es(k,ri,qe,Lt)}Ve=Ue,ke=wt}else Ve=ce[Ht]+G,ke=ce[Ht+2]+N}const $e=Ve,ft=ke,Bt=se,Li=ye;se=Je,ye=_e;const mr=(xe-V)*be,_r=je===1?Tt(Yt,B,n):ce[mr+2]+N,Ii=Tt(Yt,Ce,n);if(je<V){const ri=xe+V,Ht=ri*be,Ue=Je-G,wt=Y-Q,pi=Ii-N;ce[Ht]=Ue,ce[Ht+1]=wt,ce[Ht+2]=pi,Kr(Ue,wt,pi,me);const Pi=Ge;Ge=qe,Es(k,ri,Pi,ge)}{const ri=$e-Bt,Ht=W-Y,Ue=Ht*(ft-Li),wt=ri*(_r-Ii),pi=-Ht*ri,Pi=Ue*Ue+wt*wt+pi*pi;if(Pi===0)mh(H,xe,0,0,1,M);else{const Kt=1/Math.sqrt(Pi);mh(H,xe,Ue*Kt,wt*Kt,pi*Kt,M)}}++xe}}}function H9(i,e){i.tile.intersectsClippingArea&&(Aw(i),Ew(i,!0),Zl(i),i.intersectionData=null)}function G9(i,e){i.tile.intersectsClippingArea&&(Iw(i),Yg(i),Zl(i),Vw(i),i.intersectionData=null)}function k9(i,e){i.tile.intersectsClippingArea&&(Yg(i),Zl(i),i.intersectionData=null)}function Yg(i,e){i.tile.intersectsClippingArea&&(Aw(i),Ew(i,!1))}function Ew(i,e){const{geometry:t,geometryState:r,tile:s,localOrigin:n}=i,{surface:a,extent:o}=s,{clippingArea:l,samplerData:c}=r,d=l??Jg,u=o[0],m=o[2],_=o[1],f=o[3],y=[f>d[3],m>d[2],_<d[1],u<d[0]],b=s.horizontalScale,x=Mw(a.isWebMercatorOnPlateCarree,s.ellipsoid.radius,b),{minu:w,minv:C,maxu:T,maxv:P,boundingBox:S}=t,R=Math.max(u,d[0]),V=Math.min(m,d[2]),z=Math.max(_,d[1]),K=Math.min(f,d[3]),J=n[0],X=n[1],me=n[2];for(let D=0;D<4;++D){const O=D===1||D===3,k=r.edgeResolutions[D];I(oh(k));const H=k+1,M=y[D],G=ao(s,r.edgePeerNeighbors[D]);if(!M&&Uw(s,G,D)){Nw(i,D,G);continue}const Q=G!=null&&!M,N=G==null?void 0:G.renderData,ce=N==null?void 0:N.geometryState;if(Bi&&(I(!Q||G.level===s.level),I(!Q||qn(s,G)<=0),s&&!G&&!a.updatingRootTiles)){const Y=Ps[D],ge=s.findNeighborTile(Y,q=>q.isLoaded||q.isLeaf||q.level===s.level);a.updatingRootTiles||(ge?ge.intersectsClippingArea&&(I(!ge.isLoaded),I(!ge.isLeaf),I(ge.level===s.level)):I((a==null?void 0:a.rootTiles)==null||!s.shouldHaveNeighbor(Y)))}const be=ie(D===1?m:u,R,V),xe=ie(D===0?f:_,z,K),Me=ce==null?void 0:ce.samplerData,$t=e&&H>3?H-3:1,gt=ie(D===1?1:0,w,T),Qe=ie(D===0?1:0,C,P),Fe=Q?(Y,ge)=>.5*(Tt(Y,ge,Me)+Tt(Y,ge,c)):(Y,ge)=>Tt(Y,ge,c),it=(m-u)/k,je=O?D===1?it:-it:0,Ke=O?0:D===0?it:-it,Ze=-je,Lt=-Ke;let j=0,We=0,B=0;{const Y=0/k,ge=O?be:ie(u*(1-Y)+m*Y,R,V),q=O?ie(_*(1-Y)+f*Y,z,K):xe,se=Fe(ge,q);j=ge*b,We=x(q),B=se}let W=0,ue=0,Ce=0;{const Y=1/k,ge=O?be:ie(u*(1-Y)+m*Y,R,V),q=O?ie(_*(1-Y)+f*Y,z,K):xe,se=Fe(ge,q);W=ge*b,ue=x(q),Ce=se}for(let Y=1;Y<H-1;Y+=$t){const ge=Y/k,q=W,se=ue,ye=Ce;{const _e=O?gt:ie(ge,w,T),De=O?ie(ge,C,P):Qe,qe=q-J,rt=se-X,Yt=ye-me;Kr(q,rt,Yt,S),t.setEdgeVertexFromValuesRawPositionUV(D,Y,qe,rt,Yt,_e,De)}{const _e=(Y+1)/k,De=O?be:ie(u*(1-_e)+m*_e,R,V),qe=O?ie(_*(1-_e)+f*_e,z,K):xe,rt=Fe(De,qe);W=De*b,ue=x(qe),Ce=rt}const at=W,ut=Ce,pt=j,Ge=We,Xe=B;j=q,We=se,B=ye;let Ve=0,ke=0,ze=0;if(O){const _e=ue-se,De=ut-ye,qe=Ge-se,rt=Xe-ye,Yt=ie(_*(1-ge)+f*ge,z,K),$e=be+Ze,ft=$e*b-q,Bt=Tt($e,Yt,c)-ye,Li=D===3?-1:1;if(Ve=Li*(-qe+_e)*Bt,ke=Li*ft*(-rt+De),ze=-Li*ft*(-qe+_e),Q){const mr=be+je,_r=mr*b-q;Ve=(-qe+_e)*(Bt-(Tt(mr,Yt,Me)-ye)),ke=(ft-_r)*(-rt+De),ze=-(ft-_r)*(-qe+_e)}}else{const _e=at-q,De=ut-ye,qe=pt-q,rt=Xe-ye,Yt=ie(u*(1-ge)+m*ge,R,V),$e=xe+Lt,ft=Tt(Yt,$e,c)-ye,Bt=x($e)-se,Li=D===2?-1:1;if(Ve=Li*Bt*(-rt+De),ke=Li*(-qe+_e)*ft,ze=-Li*Bt*(-qe+_e),Q){const mr=Yt,_r=xe+Ke,Ii=x(_r)-se;Ve=(-Bt+Ii)*(-rt+De),ke=(-qe+_e)*(-ft+(Tt(mr,_r,Me)-ye)),ze=-(-Bt+Ii)*(-qe+_e)}}const Je=1/Math.sqrt(Ve*Ve+ke*ke+ze*ze);t.setEdgeNormalFromValues(D,Y,Ve*Je,ke*Je,ze*Je)}}}function Aw(i,e){Fw(i)}function j9(i,e){return(Math.PI/2-2*Math.atan(Math.exp(-i/e)))*e}function W9(i,e){return i*e}function Mw(i,e,t){return i?r=>j9(r,e):r=>W9(r,t)}function Dw(i,e,t){const{numVerticesPerSide:r,vertexAttributes:s,maxEdgeVertexCount:n}=i,a=r-1,o=s.count,l=2*(r-3)*(r-3),c=4*(a+n-3),d=Qg.reduce((y,b)=>y+(a+i.getEdgeCount(b)-3),0),u=e.reduce((y,b)=>y+a*(2*(b.latitudeResolution-1)+1),0),m=3*(t?2:1),_=(l+c+u)*m,f=o>=D9?new Uint32Array(_):new Uint16Array(_);for(let y=0;y<_;++y)f[y]=0;i.indices=f,i.indexCount=(l+d+u)*m,i.poleIndicesStartIndex=l*m,i.edgeIndicesStartIndex=(l+u)*m,t?(X9(i),Y9(i,e),Lw(i)):(Q9(i),Z9(i,e),$w(i))}function Q9(i){const{numVerticesPerSide:e,indices:t,vertexAttributes:r}=i,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=e-2,l=e-3,c=0,d=e-3;let u=0;for(let m=0;m<l;++m){const _=m*o;for(let f=c;f<d;++f){const y=_+f,b=y+1,x=b+o,w=x-1;qw(y,b,x,w,a,n)?(t[u]=y,t[u+1]=b,t[u+2]=x,t[u+3]=x,t[u+4]=w,t[u+5]=y):(t[u]=y,t[u+1]=b,t[u+2]=w,t[u+3]=w,t[u+4]=b,t[u+5]=x),u+=6}}}function Z9(i,e){const{numVerticesPerSide:t,indices:r,poleIndicesStartIndex:s}=i,n=t-1;let a=s;for(const o of e){let l=i.getEdgeVertexIndex(o.connectedOuterEdgeOffset,0),c=1;for(let d=0;d<o.latitudeResolution;++d){const u=d===0?o.rowOffset:l+t;for(let m=0;m<n;m++){const _=u+m;r[a]=l,r[a+1]=l+1,r[a+2]=_,d<o.latitudeResolution-1?(r[a+3]=l+1,r[a+4]=_+1,r[a+5]=_,a+=6):a+=3,l+=c}l=u,c=1}}}function $w(i){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:r}=i,s=t-1,n=s-2;let a=r;for(let o=0;o<4;++o){const l=ef[o];let c=0,d=0;const u=i.getEdgeCount(o),m=l.count;I(m===s-1);const _=o===1||o===2,f=_?1:2,y=_?2:1,b=i.getEdgeFirstVertexIndex(o),x=1,w=l.vertex0Index,C=l.stride;for(;c<u-1||d<m-1;){const T=w+d*C,P=b+c*x,S=c<u-1,R=d<m-1,V=S&&(!R||(S?0+s*(c+.5)/(u-1):0)<=(R?1+n*(d+.5)/(m-1):0));V?++c:++d;const z=V?P+x:T+C;e[a]=T,e[a+f]=P,e[a+y]=z,a+=3}}i.indexCount=a}function X9(i){const{indices:e,numVerticesPerSide:t,vertexAttributes:r}=i,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=t-2;let l=0;for(let c=0;c<t-3;++c){const d=c*o;for(let u=0;u<t-3;++u){const m=c*o+u,_=m+1,f=_+o,y=f-1,b=d+u,x=b+1,w=x+o;qw(b,x,w,w-1,a,n)?(xl(e,l,m,_,f),l+=6,xl(e,l,f,y,m)):(xl(e,l,m,_,y),l+=6,xl(e,l,y,f,_)),l+=6}}}function Y9(i,e){const{indices:t,numVerticesPerSide:r,poleIndicesStartIndex:s}=i,n=r-1;let a=s;for(const o of e){const l=o.connectedOuterEdgeOffset;let c=i.getEdgeVertexIndex(l,0),d=1;for(let u=0;u<o.latitudeResolution;++u){const m=u===0?o.rowOffset:c+r;for(let _=0;_<n;_++)xl(t,a,c,c+1,m+_),a+=6,u<o.latitudeResolution-1&&(xl(t,a,c+1,m+_+1,m+_),a+=6),c+=d;c=m,d=1}}}function Lw(i){const{indices:e,numVerticesPerSide:t,edgeIndicesStartIndex:r}=i,s=t-1,n=s-2;let a=r;for(let o=0;o<4;++o){const l=ef[o];let c=0,d=0;const u=i.getEdgeCount(o),m=l.count;I(m===s-1);const _=o===1||o===2,f=_?1:3,y=_?3:1,b=i.getEdgeFirstVertexIndex(o),x=1,w=l.vertex0Index,C=l.stride;for(;c<u-1||d<m-1;){const T=w+d*C,P=b+c*x,S=c<u-1,R=d<m-1,V=S&&(!R||(S?0+s*(c+.5)/(u-1):0)<=(R?1+n*(d+.5)/(m-1):0));V?++c:++d;const z=V?P+x:T+C;e[a]=T,e[a+f]=P,e[a+f+1]=P,e[a+y]=z,e[a+y+1]=z,e[a+5]=T,a+=6}}i.indexCount=a}function Kg(i){const{geometry:e,geometryState:t}=i,{edgeResolutions:r}=t,{numVerticesPerSide:s,edgeVerticesStartIndex:n}=e,a=s-2;let o=n;for(let l=0;l<4;++l){{const c=l===0||l===2,d=(l===0?a-1:0)*a+(l===1?a-1:0),u=(c?0:1)*a+(c?1:0),m=ef[l];m.vertex0Index=d,m.stride=u,m.count=a}{const c=r[l]+1;e.outerEdgesOffsetAndLength[2*l+0]=o,e.outerEdgesOffsetAndLength[2*l+1]=c,o+=c}}}function Iw(i){Kg(i),i.geometryState.wireframe?Lw(i.geometry):$w(i.geometry)}function Nw(i,e,t){const r=(e+2)%4,{geometryState:s,geometry:n,tile:a,localOrigin:o}=i,l=a.level-t.level,c=e===1||e===3,d=s.edgeResolutions[e];I(oh(d));const u=d+1,{boundingBox:m,minu:_,minv:f,maxu:y,maxv:b,vertexAttributes:x}=n,w=ie(e===1?1:0,_,y),C=ie(e===0?1:0,f,b),T=t.renderData,P=T.geometryState,S=T.geometry,R=S.getEdgeCount(r),V=a.getNeighborEdgeStartVertexIndex(e,t)*d,z=d*2**l;I(P.edgeResolutions[r]===z),I(R-1===z);const K=T.localOrigin[0]-o[0],J=T.localOrigin[1]-o[1],X=T.localOrigin[2]-o[2],me=n.getEdgeFirstVertexIndex(e),D=x.position,O=D.typedBuffer,k=D.typedBufferStride,H=x.normalCompressed,M=H.typedBuffer,G=H.typedBufferStride,Q=x.uv0,N=S.vertexAttributes,ce=S.getEdgeFirstVertexIndex(r),be=N.position.typedBuffer,xe=N.position.typedBufferStride,Me=N.normalCompressed.typedBuffer,$t=N.normalCompressed.typedBufferStride;for(let gt=1;gt<u-1;++gt){const Qe=me+gt,Fe=ce+(V+gt),it=Qe*k,je=Fe*xe,Ke=be[je]+K,Ze=be[je+1]+J,Lt=be[je+2]+X;O[it]=Ke,O[it+1]=Ze,O[it+2]=Lt,Kr(Ke,Ze,Lt,m);const j=Qe*G,We=Fe*$t;M[j]=Me[We],M[j+1]=Me[We+1];const B=gt/d,W=c?w:ie(B,_,y),ue=c?ie(B,f,b):C;Es(Q,Qe,W,ue)}}function Fw(i){var Lt;const{geometry:e,geometryState:t,localOrigin:r,tile:s}=i,{clippingArea:n,samplerData:a}=t,{minu:o,minv:l,maxu:c,maxv:d,boundingBox:u,vertexAttributes:m}=e,{surface:_,ellipsoid:f,extent:y,extentInRadians:b,horizontalScale:x}=s,w=((Lt=_.view)==null?void 0:Lt.viewingMode)==="local",C=f.radius;let T=0,P=0,S=0;const R=(j,We,B)=>{const W=b[We===0?1:3],ue=b[j===0?0:2],Ce=Math.cos(W),Y=Math.sin(W),ge=Math.sin(ue),q=Math.cos(ue),se=C+B;T=q*Ce*se,P=ge*Ce*se,S=Y*se},V=w?(()=>{const j=n,We=j!=null&&(y[3]>j[3]||y[2]>j[2]||y[1]<j[1]||y[0]<j[0]),B=Mw(_.isWebMercatorOnPlateCarree,C,x);return(W,ue,Ce)=>{const Y=W===0?y[0]:y[2],ge=ue===0?y[1]:y[3],q=We?ie(Y,j[0],j[2]):Y,se=We?ie(ge,j[1],j[3]):ge,ye=Ce;T=q*x,P=B(se),S=ye}})():R;let z=0,K=0,J=0,X=0,me=0,D=0,O=0,k=0,H=0;const M=w&&_.isWebMercatorOnPlateCarree,G=(j,We,B,W,ue)=>{let Ce=0,Y=0,ge=0;if(w){const q=We*x,se=M?(Math.PI/2-2*Math.atan(Math.exp(-B/C)))*C:B*x;Ce=q-T,Y=se-P,ge=W-S}else{const q=Xg(j),se=j.tile,ye=se.extent,at=se.extentInRadians,ut=(We-ye[0])/(ye[2]-ye[0]),pt=(B-ye[1])/(ye[3]-ye[1]),Ge=at[0]*(1-ut)+at[2]*ut,Xe=q(pt),Ve=Math.cos(Xe),ke=Math.sin(Xe),ze=Math.sin(Ge),Je=Math.cos(Ge),_e=C+W;Ce=Je*Ve*_e-T,Y=ze*Ve*_e-P,ge=ke*_e-S}switch(ue){case 0:O+=Ce,k+=Y,H+=ge;break;case 1:X-=Ce,me-=Y,D-=ge;break;case 2:O-=Ce,k-=Y,H-=ge;break;case 3:X+=Ce,me+=Y,D+=ge}},Q=n??Jg,N=y[0],ce=y[2],be=y[1],xe=y[3],Me=[xe>Q[3],ce>Q[2],be<Q[1],N<Q[0]],$t=Math.max(N,Q[0]),gt=Math.min(ce,Q[2]),Qe=Math.max(be,Q[1]),Fe=Math.min(xe,Q[3]),it=j=>Math.max(Q[0],Math.min(Q[2],j)),je=j=>Math.max(Q[1],Math.min(Q[3],j)),Ke=j=>{const We=t.cornerNeighborCornerTiles;z=0,K=0,J=1,X=0,me=0,D=0,O=0,k=0,H=0;let B=1/0;for(let q=0;q<4;++q){const se=We[4*j+q];B=Math.min(B,(se==null?void 0:se.level)??1/0)}for(let q=0;q<4;++q){const se=We[4*j+q];mc[q]=(se==null?void 0:se.level)===B?se:null}let W=1,ue=0;for(let q=0;q<4;++q){const se=mc[q];se&&(W=Math.max(W,se==null?void 0:se.renderData.geometryState.numVerticesPerSide),ue=se.extent[2]-se.extent[0])}const Ce=ue,Y=W;I(Y>1);const ge=Ce/Y;for(let q=0;q<4;++q){const se=mc[(q+3)%4],ye=mc[q%4];if(!se&&!ye)continue;const at=q===0?1:q===1?2:q===2?3:0,ut=q===0?2:q===1?3:q===2?0:1;if(se&&ye){const pt=um[q][0]*ge,Ge=um[q][1]*ge,Xe=se.extent,Ve=it(Xe[at===0||at===1?2:0]+pt),ke=je(Xe[at===0||at===3?3:1]+Ge),ze=ye.extent,Je=it(ze[ut===0||ut===1?2:0]+pt),_e=je(ze[ut===0||ut===3?3:1]+Ge),De=se.renderData,qe=ye.renderData,rt=Tt(Ve,ke,De.geometryState.samplerData),Yt=Tt(Je,_e,qe.geometryState.samplerData);G(De,Ve,ke,.5*(rt+Yt),q)}else{const pt=se??ye,Ge=se?at:ut,Xe=pt.extent,Ve=um[q],ke=it(Xe[Ge===0||Ge===1?2:0]+Ve[0]*ge),ze=je(Xe[Ge===0||Ge===3?3:1]+Ve[1]*ge),Je=pt.renderData,_e=Tt(ke,ze,Je.geometryState.samplerData);G(Je,ke,ze,_e,q)}}if(!w){const q=Math.sqrt(T*T+P*P+S*S);z=T/q,K=P/q,J=S/q}if(w||J*J<.999){const q=Math.sqrt(X*X+me*me+D*D);X/=q,me/=q,D/=q;const se=Math.sqrt(O*O+k*k+H*H);O/=se,k/=se,H/=se,z=D*k-me*H,K=X*H-D*O,J=me*O-X*k;const ye=1/Math.sqrt(z*z+K*K+J*J);z*=ye,K*=ye,J*=ye}},Ze=t.cornerNeighborCornerTiles;for(let j=0;j<4;++j){const We=j,B=(j+1)%4,W=j===0||j===1?1:0,ue=j===0||j===3?1:0,Ce=ie(W,o,c),Y=ie(ue,l,d),ge=e.getEdgeFirstVertexIndex(We),q=e.getEdgeCount(We),se=j===0||j===3?q-1:0,ye=e.getEdgeFirstVertexIndex(B),at=e.getEdgeCount(B),ut=j===0||j===1?at-1:0;let pt=-1;for(let Ve=0;Ve<4;++Ve){const ke=Ze[4*j+Ve],ze=Ze[4*j+pt];ke&&(pt===-1||qn(ze,ke)>0)&&(pt=Ve)}const Ge=pt,Xe=Ze[4*j+Ge];if(Xe!==s){const Ve=s.level-Xe.level,ke=2**Ve,ze=[Xe.lij[0]+Ve,Xe.lij[1]*ke,Xe.lij[2]*ke],Je=[ze[1]+ke===s.lij[1],j===0&&(Ge===1||Ge===0&&Xe!==Ze[4*j+3])||j===1&&(Ge===0||Ge===1&&Xe!==Ze[4*j+2]),ze[1]===s.lij[1]+1,j===2&&(Ge===3||Ge===2&&Xe!==Ze[4*j+1])||j===3&&(Ge===2||Ge===3&&Xe!==Ze[4*j+0])],_e=Je.reduce(($e,ft)=>$e+(ft?1:0),0);I(_e===1||_e===2);let De=-1,qe=-1;const rt=Xe.renderData;if(_e===1){const $e=Je.findIndex(Bt=>Bt);I(0<=$e&&$e<=3),De=($e+2)%4;const ft=t.edgeResolutions[$e];qe=s.getNeighborEdgeStartVertexIndex($e,Xe)*ft+ft*($e===0&&j===0||$e===1&&j===0||$e===2&&j===1||$e===3&&j===3?1:0)}else{I(Je[1]||Je[3]),De=Je[1]?3:1;const $e=rt.geometryState.edgeResolutions[De];qe=j===0||j===3?0:$e}const Yt=rt.geometry;{const $e=ge+se,ft=ye+ut,Bt=Yt.getEdgeFirstVertexIndex(De)+qe,Li=Yt.vertexAttributes,mr=rt.localOrigin;{const Ii=Li.position,ri=Ii.typedBuffer,Ht=Bt*Ii.typedBufferStride,Ue=ri[Ht]+mr[0]-r[0],wt=ri[Ht+1]+mr[1]-r[1],pi=ri[Ht+2]+mr[2]-r[2];Kr(Ue,wt,pi,u);const Pi=m.position,Kt=Pi.typedBuffer;{const gr=$e*Pi.typedBufferStride;Kt[gr]=Ue,Kt[gr+1]=wt,Kt[gr+2]=pi}{const gr=ft*Pi.typedBufferStride;Kt[gr]=Ue,Kt[gr+1]=wt,Kt[gr+2]=pi}}const _r=m.uv0;Es(_r,$e,Ce,Y),Es(_r,ft,Ce,Y);{const Ii=Li.normalCompressed.typedBuffer,ri=Bt*Li.normalCompressed.typedBufferStride,Ht=m.normalCompressed,Ue=Ht.typedBuffer;{const wt=$e*Ht.typedBufferStride;Ue[wt]=Ii[ri],Ue[wt+1]=Ii[ri+1]}{const wt=ft*Ht.typedBufferStride;Ue[wt]=Ii[ri],Ue[wt+1]=Ii[ri+1]}}}}else{const Ve=Me[We],ke=Me[B];let ze;if(Ve||ke){const qe=ie(N*(1-W)+ce*W,$t,gt),rt=ie(be*(1-ue)+xe*ue,Qe,Fe);ze=Tt(qe,rt,a)}else ze=K9(Ze,j);V(W,ue,ze),Ke(j);const Je=T-r[0],_e=P-r[1],De=S-r[2];Kr(Je,_e,De,u),e.setEdgeVertexFromValuesRawPositionUVNormal(We,se,Je,_e,De,Ce,Y,z,K,J),e.setEdgeVertexFromValuesRawPositionUVNormal(B,ut,Je,_e,De,Ce,Y,z,K,J)}}for(let j=0;j<4;++j)mc[j]=null}function K9(i,e){var o,l;const t=4*e,r=Qg.reduce((c,d)=>{var u;return Math.min(c,((u=i[t+d])==null?void 0:u.level)??1/0)},1/0);Bi&&(I(!i[t+0]||!i[t+2]||D_(i[t+0],i[t+2],_t.SOUTH_WEST)),I(!i[t+1]||!i[t+3]||D_(i[t+1],i[t+3],_t.NORTH_WEST)));let s=0,n=0;for(let c=0;c<4;++c){const d=i[t+c];if(d&&d.level===r){const u=c===0||c===1,m=c===0||c===3,_=d.extent,f=_[u?0:2],y=_[m?1:3],b=(l=(o=d.renderData)==null?void 0:o.geometryState)==null?void 0:l.samplerData;n+=Tt(f,y,b),s++}}const a=s?n/s:0;return I(a!=null),a}function Zl(i){const{vao:e,geometry:t}=i,{vertexAttributes:r,edgeVerticesStartIndex:s}=t,n=r.position.typedBuffer;e.vertexBuffers.geometry.setSubData(n,s,s,n.length)}function Vw(i){const{vao:e,geometry:t}=i,{indices:r,indexCount:s,edgeIndicesStartIndex:n}=t;e.indexBuffer.setSubData(r,n,n,s)}const um=[[0,1],[1,0],[0,-1],[-1,0]],wi=new kM,Jg=Iv(-1/0,-1/0,1/0,1/0),mc=[null,null,null,null];function Uw(i,e,t){if(!e)return!1;const r=qn(i,e);return r>0||r===0&&t>=2}let Td=class{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return I(0<=e&&e<this.count),this.vertex0Index+this.stride*e}};const ef=[new Td,new Td,new Td,new Td];function Kr(i,e,t,r){i<r[0]?r[0]=i:i>r[3]&&(r[3]=i),e<r[1]?r[1]=e:e>r[4]&&(r[4]=e),t<r[2]?r[2]=t:t>r[5]&&(r[5]=t)}function zw(i){const{edgeResolutions:e,numVerticesPerSide:t}=i,r=1+Math.max(...e);return Math.max(t,r)}function qw(i,e,t,r,s,n){const a=i*s,o=n[a],l=n[a+1],c=n[a+2],d=e*s,u=n[d],m=n[d+1],_=n[d+2],f=t*s,y=n[f],b=n[f+1],x=n[f+2],w=r*s,C=n[w],T=n[w+1],P=n[w+2];return(u-C)*(u-C)+(m-T)*(m-T)+(_-P)*(_-P)>(o-y)*(o-y)+(l-b)*(l-b)+(c-x)*(c-x)}function xl(i,e,t,r,s){i[e]=t,i[e+1]=r,i[e+2]=r,i[e+3]=s,i[e+4]=s,i[e+5]=t}const Kd=6;let J9=class extends Gg{constructor(e,t,r,s,n){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=ci(),this._baseUsedMemory=900,this.init(e,t,r,s,n)}init(e,t,r,s,n){super.init(e,t,r,s,n);const a=n.view.renderSpatialReference,o=n.spatialReference,l=a!=null&&Uv(a)&&o!=null&&o.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;const{isWebMercatorOnPlateCarree:c}=n,d=this._extentInRenderSR,u=this.extent;if(c){const m=It(u[0],u[1],0);ph(m,zi.WebMercator,m,zi.PlateCarree);const _=It(u[2],u[3],0);ph(_,zi.WebMercator,_,zi.PlateCarree),d[0]=m[0],d[1]=m[1],d[2]=_[0],d[3]=_[1]}else for(let m=0;m<4;++m)d[m]=u[m]*l;this.centerAtSeaLevel[0]=.5*(d[0]+d[2]),this.centerAtSeaLevel[1]=.5*(d[1]+d[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(d[2]-d[0],d[3]-d[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),s=Math.sqrt(t*t+r*r),n=.5*(this.elevationBoundsMax-this.elevationBoundsMin),a=Math.max(s,n);this._center[kt.MIDDLE][3]=a}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),r=t[0],s=t[1],n=t[2],a=t[3],o=t[4],l=t[5];let c=!0;for(let d=0;d<6;d++){const u=e[d],m=u[0],_=u[1],f=u[2],y=u[3];if(m*(m>0?r:a)+_*(_>0?s:o)+f*(f>0?n:l)+y>=0)return lr.OUTSIDE;c=c&&m*(m<0?r:a)+_*(_<0?s:o)+f*(f<0?n:l)+y<=0}return c?lr.INSIDE:lr.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return jC(e[0],e[1],this.elevationBoundsMin,e[2],e[3],this.elevationBoundsMax)}intersectsRay(e,t,r,s){return Pd[0]=1/t[0],Pd[1]=1/t[1],Pd[2]=1/t[2],gb(this._aabb(),e,Pd,r,s)}createGeometry(){q9(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){H9(this.renderData,this._horizontalScaleFactor)}updateEdgeElevations(){k9(this.renderData,this._horizontalScaleFactor)}updateEdgeElevationsAndResolutions(){G9(this.renderData,this._horizontalScaleFactor)}get horizontalScale(){return this._horizontalScaleFactor}};const Pd=v();let eD=class{constructor(){this.extent=_i(),this.minLevel=0,this.maxLevel=0,this.callback=null}},Jd=class extends Pe{constructor(){super(...arguments),this._queries=new xt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new xt({initialSize:30}),this._queryPool=new wa(eD)}queryVisibleLevelRange(e,t,r,s){const n=this._queryPool.acquire();W_(n.extent,e),n.minLevel=t??-Number.MAX_VALUE,n.maxLevel=r??Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let r=0;for(;r<this._queriesInvPtr;){const s=this._queries.data[r],n=s.extent;t>=s.minLevel&&t<=s.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}};h([p()],Jd.prototype,"updating",null),Jd=h([F("esri.views.3d.terrain.ScaleRangeQueries")],Jd);function tD(i,e,t,r){const s=Math.cos(t);i[0]=Math.cos(e)*s*r,i[1]=Math.sin(e)*s*r,i[2]=Math.sin(t)*r}let iD=class extends Gg{constructor(e,t,r,s,n){super(),this._convexHull=new Array(24),this._boundingSphere=Ds(),this._baseUsedMemory=1816,this.init(e,t,r,s,n)}init(e,t,r,s,n){super.init(e,t,r,s,n);const a=this.ellipsoid.radius,o=this.extentInRadians[0],l=this.extentInRadians[1],c=this.extentInRadians[2],d=this.extentInRadians[3],u=He(l,d,.5),m=He(o,c,.5),_=e===0?0:Math.min(Math.abs(l),Math.abs(d));this._edgeLen=(c-o)*Math.cos(_)*a,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=a-Math.sqrt(a*a-this._edgeLen2/4),tD(this.centerAtSeaLevel,m,u,this.ellipsoid.radius),oe(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)Ie(At(e[kt.MIDDLE]),0,0,0),Ie(e[kt.TOP],0,0,0),Ie(e[kt.BOTTOM],0,0,0),e[kt.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();const t=e[kt.MIDDLE],r=this.convexHull;let s=0;for(let n=0;n<8;++n)s=Math.max(s,rD(At(t),r,3*n));e[kt.MIDDLE][3]=Math.sqrt(s)}}_calculateFrustumVisibilityStatus(e){if(!np(e,this._boundingSphere))return lr.OUTSIDE;if(this.lij[0]<10)return lr.INTERSECTS;const t=this.convexHull,r=this.surface.view.state.camera.near;let s=!0;for(let n=0;n<$S;n++){const a=n===Dn.NEAR,o=e[n],l=o[0],c=o[1],d=o[2],u=o[3]-(a?r:0);let m=!1;for(let _=0;_<8;++_){const f=3*_;if(l*t[f]+c*t[f+1]+d*t[f+2]+u<0){if(m=!0,!s)break}else s=!1}if(!m)return lr.OUTSIDE}return s?lr.INSIDE:lr.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){$9(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),Bi&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=At(e),r=this.elevationBoundsMin,s=this.elevationBoundsMax,n=this.ellipsoid.radius,a=s;if(this.level===0)Ie(t,0,0,0),e[3]=n+a;else{const o=this.extentInRadians,l=.5*(o[0]+o[2]),c=o[1],d=o[3];Ba(xy,l,c,n),Ba(wy,l,d,n),fe(t,xy,wy),re(t,t,(n+.5*(r+s))/Hr(t));const u=this.convexHull;let m=0;const _=(y,b)=>{const x=y[0]-u[3*b],w=y[1]-u[3*b+1],C=y[2]-u[3*b+2];return Math.sqrt(x*x+w*w+C*C)};for(let y=0;y<8;++y){const b=_(t,y);m=Math.max(m,b)}const f=m;e[3]=f+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(this.level===0)return;const r=this.elevationBoundsMin,s=this.elevationBoundsMax,n=this._getPatchType(),a=this.surface.isWebMercator,o=a&&n===Ws.HAS_NORTH_POLE,l=a&&n===Ws.HAS_SOUTH_POLE,c=l||o,d=Math.PI/2,u=e[0],m=e[2],_=l?-d:e[1],f=o?d:e[3],y=.5*(u+m),b=r,x=t+(c?Math.min(0,b-1):b),w=(H,M,G)=>Ba(H,M,G,x),C=v(),T=v(),P=v(),S=v();w(C,u,_),w(T,u,f),w(P,m,f),w(S,m,_);const R=(H,M)=>{for(let G=0;G<3;++G)this._convexHull[3*M+G]=H[G]};R(C,0),R(T,1),R(P,2),R(S,3);const V=s,z=t+(c?Math.max(0,V+1):V),K=v(),J=v(),X=v();Ba(J,y,f,x),Ba(X,y,_,x),fe(K,J,X),oe(K,K);const me=v(),D=v(),O=(H,M)=>{zt(D,H,M),oe(D,D);const G=-pe(H,me)/pe(D,me);I(G>=0),re(D,D,G),fe(H,H,D)};if(2**this.lij[0]>2*this.lij[1]){const H=X,M=v();dt(M,by,H),oe(M,M),dt(me,H,M),oe(me,me),I(Wr(pe(me,H)/Hr(H),0)),O(C,T),O(S,P),R(C,0),R(S,3)}else if(2**this.lij[0]!==2*this.lij[1]){const H=J,M=v();dt(M,by,H),oe(M,M),dt(me,M,H),oe(me,me),O(T,C),O(P,S),R(T,1),R(P,2)}const k=(H,M)=>{const G=z/pe(M,K);for(let Q=0;Q<3;++Q)this._convexHull[3*H+Q]=M[Q]*G};k(4,C),k(5,T),k(6,P),k(7,S)}_getPatchType(){const e=this.lij[1],t=e===0,r=e===(1<<this.level)-1;return t?r?Ws.HAS_BOTH_POLES:Ws.HAS_NORTH_POLE:r?Ws.HAS_SOUTH_POLE:Ws.REGULAR}intersectsRay(e,t,r,s){const n=this._boundingSphere,a=n[3]+r,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],l=n[0]-e[0],c=n[1]-e[1],d=n[2]-e[2],u=(l*t[0]+c*t[1]+d*t[2])/o,m=t[0]*u-l,_=t[1]*u-c,f=t[2]*u-d;return m*m+_*_+f*f<a*a}getDefaultVerticesPerSide(){return this.level<vy.length?vy[this.level]+1:2}updateCornerElevations(){V9(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){N9(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){F9(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var We;if(!Bi||this.level<=2)return;const e=this._boundingSphere,t=e[3],r=At(e),s=v(),n=this.ellipsoid.radius,a=this.elevationBoundsMin,o=this.elevationBoundsMax,l=n+a,c=1,d=0,u=this._center[kt.MIDDLE][3],m=this.convexHull,_=(B,W)=>{for(let ue=0;ue<3;++ue)B[ue]=m[3*W+ue]};{const B=v(),W=v(),ue=v(),Ce=v(),Y=v(),ge=(q,se,ye,at)=>{_(W,q),_(ue,se),_(Ce,ye),zt(W,W,ue),zt(Ce,Ce,ue),dt(B,W,Ce),oe(B,B);const ut=pe(B,ue);_(Y,at);const pt=pe(B,Y),Ge=Math.abs(pt-ut);I(Wr(Ge,0),`Non coplanar ${q},${se},${ye},${at} diff = ${Ge}`)};ge(0,1,2,3),ge(4,5,6,7),ge(0,1,4,5),ge(1,2,5,6),ge(2,3,6,7),ge(3,0,7,4)}const f=vR(24),y=(B,W,ue)=>{const Ce=4*B;for(let Y=0;Y<3;++Y)f[Ce+Y]=W[Y];f[Ce+3]=ue},b=v(),x=v(),w=v(),C=v(),T=(B,W,ue,Ce)=>{_(b,W),_(x,ue),_(w,Ce),zt(b,b,x),oe(b,b),zt(w,w,x),oe(w,w),dt(C,b,w),oe(C,C);const Y=pe(C,x);y(B,C,Y)};T(0,0,1,2),T(1,1,0,4),T(2,1,5,2),T(3,3,2,6),T(4,4,0,3),T(5,4,6,5);const P=1,S=(B,W,ue,Ce)=>{const Y=4*B;return f[Y]*W+f[Y+1]*ue+f[Y+2]*Ce-f[Y+3]},R=(B,W,ue,Ce)=>S(B,W,ue,Ce)>=-P,V=(B,W)=>R(B,W[0],W[1],W[2]),z=2**this.lij[0]>2*this.lij[1],K=(B,W,ue)=>Math.sqrt(Bw(B,W,ue,r[0],r[1],r[2]))<t,J=B=>K(B[0],B[1],B[2]),X=(B,W)=>K(B[W],B[W+1],B[W+2]),me=this.extentInRadians,D=.5*(me[0]+me[2]),O=me[1],k=me[3],H=v(),M=v();Ba(H,D,k,l),Ba(M,D,O,l);const G=z?"Upper":"Lower";let Q=!0;for(let B=0;B<6;++B){for(let W=0;W<8;++W){const ue=3*W,Ce=R(B,m[ue],m[ue+1],m[ue+2]);Q&&(Q=Ce),I(Ce,`Tile[${this.lij}] Convex hull point ${W} outside of plane ${B}`)}I(V(B,M),`Tile[${this.lij}] (${G}) bottom mid outside of plane ${B}`),I(V(B,H),`Tile[${this.lij}] (${G}) top mid outside of plane ${B}`)}I(Q,"Not all convex hull points are inside  convex hull polyhedron"),I(J(M),`Tile[${this.lij}] (${G}) bottom mid outside of bounding sphere`),I(J(H),`Tile[${this.lij}] (${G}) top mid outside of bounding sphere`);for(let B=0;B<8;++B){const W=X(m,3*B);I(W,`Tile[${this.lij}] Convex hull point ${B} outside of bounding sphere`)}for(let B=0;B<6;++B)for(let W=0;W<8;++W){const ue=3*W;R(B,m[ue],m[ue+1],m[ue+2])||console.error(`Tile[${this.lij}] Convex hull point ${W} outside of plane ${B}`)}const{extentInRadians:N}=this,ce=Math.max(N[2]-N[0],N[3]-N[1]),be=Math.round(ce*n),{renderData:xe}=this;if(!xe)return;const{geometry:Me,geometryState:$t,localOrigin:gt}=xe,Qe=(We=Me.vertexAttributes)==null?void 0:We.position;if(!Qe)return;const Fe=v(),it=Me.numVerticesPerSide-2,{indices:je,indexCount:Ke,edgeVerticesStartIndex:Ze,poleVerticesStartIndex:Lt}=Me;if(!je)return;const j=new Set;for(let B=0;B<Ke;++B){const W=je[B];if(j.has(W))continue;j.add(W);const ue=W<Lt,Ce=W>=Ze;let Y=!1,ge=-1;if(Ce){let _e=Ze;for(let De=0;De<4;++De){const qe=$t.edgeResolutions[De];if(W===_e||W===_e+qe-1){Y=!0;break}if(_e+=qe,W<_e){ge=De;break}}}const q=Ce?$t.edgePeerNeighbors[ge]:null,se=Ce&&q&&qn(this,q)>0;Qe.getVec(W,s),fe(Fe,s,gt);const ye=Hr(Fe)-n;let at=0,ut=!1;const pt=a-ye,Ge=ye-o,Xe=pt>c,Ve=Ge>c,ke=Xe||Ve,ze=()=>{const _e=ue?"internal":Ce&&!Y?"edge":Y?"corner":"pole";return`Tile[${this.lij}].vertex[${W}]:${_e}`+(Xe?"(below)":Ve?"(above)":"")+(se?"(Neighbor)":"")},Je=Tl(Fe,r);if(Je>=t+d){const _e=Je-t;ke||(console.error(`${ze()} is out of the bounding sphere by ${_e.toFixed(0)} / ${t.toFixed(0)}[tol=${d}] h=${ye.toFixed(0)} / [${a.toFixed(0)}..${o.toFixed(0)}] (${(_e/t).toFixed(0)})`),ut=!0)}for(let _e=0;_e<6;++_e)if(!R(_e,Fe[0],Fe[1],Fe[2])){const De=S(_e,Fe[0],Fe[1],Fe[2]),qe=W%it,rt=(W-qe)/it;_e===0&&pt||_e===5&&Ge||(console.error(`${ze()} (${qe},${rt})|${it}] is out of the bounding trapezoid plane ${_e} h=${Math.round(ye)} / [${Math.round(a)}..${Math.round(o)}] dist=${Math.round(De)} radii = ${Math.round(t)}/${Math.round(u)}} : maxL = ${be}`),++at)}if(ut||at>0)break}}get convexHull(){return this._convexHull}};const vy=[128,64,64,32,16,8,8,4];function rD(i,e,t){return Bw(i[0],i[1],i[2],e[t],e[t+1],e[t+2])}function Bw(i,e,t,r,s,n){const a=r-i,o=s-e,l=n-t;return a*a+o*o+l*l}const Ba=(i,e,t,r)=>{const s=Math.cos(e),n=Math.sin(e),a=Math.cos(t),o=Math.sin(t);i[0]=r*a*s,i[1]=r*a*n,i[2]=r*o},by=[0,0,1],xy=v(),wy=v();let us=class extends Pe{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};h([p()],us.prototype,"fovX",void 0),h([p()],us.prototype,"fovY",void 0),h([p()],us.prototype,"relativeWidthLimit",void 0),h([p()],us.prototype,"relativeHeightLimit",void 0),h([p()],us.prototype,"maxLod",void 0),h([p()],us.prototype,"angledSplitBias",void 0),h([p()],us.prototype,"aboveGround",void 0),h([p()],us.prototype,"frustum",void 0),us=h([F("esri.views.3d.terrain.SplitLimits")],us);const sD=Ma().vec3f(ae.POSITION).vec2i16(ae.UV0).vec2i16(ae.NORMALCOMPRESSED,{glNormalized:!0});let nD=class{constructor(e){this._storage=new tp((t,r)=>e.newCache(t,r),"TileGeometry")}acquire(e){const r=Math.ceil(e/4)*4,s=this._storage,n=aD(r),a=s.pop(n);if(a)return a;const o=sD.createBuffer(r);return o.release=()=>s.put(n,o),o}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function aD(i){return i.toString()}let Hw=class extends Ls{constructor(){super(...arguments),this.blendMode=U.Normal}};h([$({count:U.COUNT})],Hw.prototype,"blendMode",void 0);let Kc=class extends Hw{constructor(){super(...arguments),this.output=Zt.Composite,this.baseOpacityMode=Ui.NotRequired,this.premultipliedSource=ys.Off}};h([$({count:Zt.COUNT})],Kc.prototype,"output",void 0),h([$({count:Ui.COUNT})],Kc.prototype,"baseOpacityMode",void 0),h([$()],Kc.prototype,"premultipliedSource",void 0);var Ea;function Gw(i){const e=new Mt;if(e.include(fw),i.background===Ea.Only){const t=i.output===Zt.ColorComposite;return t?e.fragment.uniforms.add(new Ai("backgroundColor",r=>r.backgroundColor)):e.fragment.include(Hg),e.fragment.code.add(g`
    void main() {
      fragColor = vec4(${t?g`backgroundColor`:g`gridColor(uv)`}, 1.0);
    }
  `),e}return e.include(yw,i),e.fragment.uniforms.add(new Be("tex",t=>t.texture)),e.fragment.uniforms.add(new Ne("opacity",t=>t.opacity)),e.fragment.code.add(g`void main() {
vec4 bgColor = getBackground(uv);
fragColor = blendLayers(bgColor, texture(tex, uv), opacity);
}`),e}(function(i){i[i.BelowLayer=0]="BelowLayer",i[i.Only=1]="Only",i[i.COUNT=2]="COUNT"})(Ea||(Ea={}));const oD=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Ea},build:Gw},Symbol.toStringTag,{value:"Module"}));let lD=class extends gw{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Fn}},kw=class jw extends Ft{initializeProgram(e){return new Dt(e.rctx,jw.shader.get().build(this.configuration),Pt)}initializePipeline(){return nt({blending:cn(Z.ONE,Z.ONE_MINUS_SRC_ALPHA),colorWrite:lt})}};kw.shader=new Nt(oD,()=>he(()=>Promise.resolve().then(()=>j$),void 0));let Ww=class extends Kc{constructor(){super(...arguments),this.background=Ea.BelowLayer}};h([$()],Ww.prototype,"background",void 0);let pm=class{constructor(e,t,r,s,n,a){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=Jr(r.offset[0],r.offset[1],r.scale,r.scale),this.opacities=It(s,n,a)}destroy(){this.texture.release()}};const cD=.125;let hD=class{constructor(){this._renderParams={reshuffleManager:new CR,context:null,drawPhase:1,state:new JT({viewpoint:new Il({targetGeometry:new Ms(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new hR(new xR(0,0,0,0),0,0,0,512,512,4096,4096)}dispose(){this._renderParams=null}renderBackground(e,t,r,s,n,a,o,l,c,d){const u=this._backgroundTile;this._updateRenderParameters(e,t,u,r,n,a,o,l,c,d),this._renderParams.stencilSymbols=!1,r.drawBackground(this._renderParams,u,s)}renderContent(e,t,r,s,n,a,o,l,c,d,u,m){this._stencilSymbols(e,t,r,s,n,a,o,Math.round(1/l),c,d,u,m);let _=1;r.stencilRef=_++,e.setStencilFunction(Hi.EQUAL,r.stencilRef,255),this._render(e,t,r,n,a,o,l,c,d,u,m),s.forAll(f=>{f.sourceLayerInfo.data.stencilRef=_++,this._renderSymbols(e,f.sourceLod,f.sourceLayerInfo.data,n,a,o,Math.round(1/l),f.offset,d,u,m)})}_stencilSymbols(e,t,r,s,n,a,o,l,c,d,u,m){let _=1;r.stencilRef=_++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(Tp.KEEP,Tp.KEEP,Tp.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(Hi.ALWAYS,r.stencilRef,255),this._stencilTileSymbols(e,t,r,n,a,o,l,c,d,u,m);for(const f of s.toArray()){const{sourceLod:y,offset:b,sourceLayerInfo:x}=f;x.data.stencilRef=_++,e.setStencilFunction(Hi.ALWAYS,x.data.stencilRef,255),this._stencilTileSymbols(e,y,x.data,n,a,o,l,b,d,u,m)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,r,s,n,a,o,l,c,d,u){e.setStencilFunction(Hi.EQUAL,r.stencilRef,255),this._render(e,t,r,s,n,a,o,l,c,d,u,wR.SYMBOL)}_render(e,t,r,s,n,a,o,l,c,d,u,m){this._updateRenderParameters(e,t,r,s,a,o,l,c,d,u),this._renderParams.stencilSymbols=!1,s.drawTile(this._renderParams,r,n,m)}_stencilTileSymbols(e,t,r,s,n,a,o,l,c,d,u){this._updateRenderParameters(e,t,r,s,a,o,l,c,d,u),this._renderParams.stencilSymbols=!0,r.triangleCount=0,s.drawSymbols(this._renderParams,r,n)}_updateRenderParameters(e,t,r,s,n,a,o,l,c,d){"type"in r&&r.type==="vector-tile"&&!r.stage&&r.attachWithContext(e);const u=t[0]-n.getLevelShift(t[0]),m=this._renderParams;m.context=e,m.painter=s,m.glyphMosaic=s.glyphMosaic,m.spriteMosaic=s.spriteMosaic,m.pixelRatio=c*d,m.displayLevel=u,m.requiredLevel=u;const _=n.getScale(t[0]),[f,y]=n.getOffset(t,a*_),b=cD*a*_/l,x=r.transforms.displayViewScreenMat3;x[0]=b,x[4]=-b,x[6]=-1-f-o[0]*a*2,x[7]=1+y+(1-o[1])*a*2-2,m.state.size[0]=l/d,m.state.size[1]=l/d,m.state.pixelRatio=d}},Qw=class Zw extends Ft{initializeProgram(e){return new Dt(e.rctx,Zw.shader.get().build(this.configuration),Pt)}initializePipeline(){return nt({blending:cn(Z.ONE,Z.ONE_MINUS_SRC_ALPHA),colorWrite:lt})}};Qw.shader=new Nt(d9,()=>he(()=>Promise.resolve().then(()=>W$),void 0));let Mc=class extends Kc{constructor(){super(...arguments),this.colorizerType=_o.Stretch,this.stretchType=Po.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}};h([$({count:_o.COUNT})],Mc.prototype,"colorizerType",void 0),h([$({count:Po.COUNT})],Mc.prototype,"stretchType",void 0),h([$()],Mc.prototype,"applyColormap",void 0),h([$()],Mc.prototype,"requireBilinearWithNN",void 0);let Cy=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const r=new Mh(this._rctx,new ui(e),new Rb(vb.DEPTH24_STENCIL8,e));return this._fbos.set(e,r),r}};const dD=()=>de.getLogger("esri.views.3d.terrain");let uD=class{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._fbos=[],this._vectorTileHelper=new hD,this._bindParameters=new ng(null,null),this._blendLayersTechniqueConfig=new Ww,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=un(this._rctx,Dh)}dispose(){this._fbos.forEach(Ae),this._fbos=null,this._vtFBO=Ae(this._vtFBO),this._vaoQuad=Ae(this._vaoQuad),this._vectorTileHelper=Ae(this._vectorTileHelper),this._backgroundTechnique=tt(this._backgroundTechnique),this._applyOpacityTechnique=tt(this._applyOpacityTechnique),this._blendLayersTechnique=tt(this._blendLayersTechnique)}_getBlendLayersTechnique(e,t,r,s=ys.Off,n=Ea.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=r,this._blendLayersTechniqueConfig.premultipliedSource=s,this._blendLayersTechniqueConfig.background=n,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(kw,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const r=this._getBlendLayersTechnique(U.Normal,t?Zt.ColorComposite:Zt.GridComposite,Ui.NotRequired,ys.Off,Ea.Only),s=this._rctx.bindTechnique(r,this._bindParameters,e);this._render(s)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Ti.TRIANGLE_STRIP,0,Un(this._vaoQuad,"geometry"))}drawGroup(e,t,r,s,n=ys.On){t===Zt.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);const a=e.baseOpacity<1?Ui.Required:Ui.NotRequired,o=this._getBlendLayersTechnique(s,t,a,n),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawRasterData(e,t,r,s,n=ys.Off){if(e.texture==null)return;const a=e.baseOpacity<1?Ui.Required:Ui.NotRequired;e.fboTexture=t===Zt.GroupBackgroundComposite||s===U.Normal&&a===Ui.NotRequired&&n===ys.Off?null:this.switch(r).colorTexture;const o=this._getBlendLayersTechnique(s,t,a,n),l=this._rctx.bindTechnique(o,this._bindParameters,e);this._render(l)}drawImageryTileData(e,t,r,s,n){const a=n.sourceLayerInfo.data;if(!a.source||(n.tile.surface.layerViewByIndex(n.layerIndex,Te.MAP).ensureSymbolizerParameters(a),!a.bind(this._rctx)))return;const o=e.baseOpacity<1?Ui.Required:Ui.NotRequired;e.fboTexture=s===U.Normal&&o===Ui.NotRequired?null:this.switch(r).colorTexture;const l=this._getRasterColorizerTechnique(a,t,s,o);a.opacity=e.opacity;const c=a.getUniforms();c.scale=n.scale,c.offset=n.offset,c.backgroundColor=e.backgroundColor,c.fboTexture=e.fboTexture,c.baseOpacity=e.baseOpacity;const d=this._rctx.bindTechnique(l,null,c);this._render(d)}_getRasterColorizerTechnique(e,t,r,s){const n=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(n.type);return this._rasterColorizerConfig==null&&(this._rasterColorizerConfig=new Mc,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=r,this._rasterColorizerConfig.baseOpacityMode=s,this._rasterColorizerConfig.colorizerType=a,this._rasterColorizerConfig.applyColormap=!!n.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?Po.Noop:Po.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(Qw,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,r,s,n,a,o,l){const c=this._rctx,d=n.sourceLayerInfo.data,u=n.tile.surface.layerViewByIndex(n.layerIndex,Te.MAP),m=e.baseOpacity<1?Ui.Required:Ui.NotRequired,_=m===Ui.Required||e.opacity<1||s!==U.Normal||t!==Zt.Composite,f=_?ys.On:ys.Off,y=this._getBlendLayersTechnique(s,t,m,f);c.setPipelineState(y.getPipeline());let b=null,x=null;_?(x=this.currentFBO(r),this._vtFBO==null&&(this._vtFBO=new Cy(this._rctx)),b=this._vtFBO.get(r),c.bindFramebuffer(b),this._clearCurrentFBO()):l&&c.clearSafe(Mi.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.renderBackground(c,n.sourceLod,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/n.scale),n.offset,o,a,u.contentZoom),d&&this._vectorTileHelper.renderContent(c,n.sourceLod,d,n.vtlNeighborInfos,u.painter,u.layer.styleRepository,u.schemaHelper,Math.round(1/n.scale),n.offset,o,a,u.contentZoom)}catch(w){dD().warnOnce("A render call containing vector tiles did not resolve correctly.",w)}return b==null||(c.bindFramebuffer(x),e.texture=b.colorTexture,e.offset=yu,e.scale=1,this.drawRasterData(e,t,r,s,f),l)}copyFBOToTexture(e){const t=this._rctx,r=t.bindTexture(e.texture,Ci.TEXTURE_UNIT_FOR_UPDATES),s=e.descriptor;t.gl.copyTexImage2D(Jm.TEXTURE_2D,0,s.pixelFormat,0,0,s.width,s.height,0),e.generateMipmap(),t.bindTexture(r,Ci.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clearSafe(Mi.COLOR_BUFFER_BIT|Mi.DEPTH_BUFFER_BIT|Mi.STENCIL_BUFFER_BIT)}_initFBO(e,t,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,r=!0){if(this._current=t,t>=this._fbos.length)for(let s=this._fbos.length;s<=t;s++)this._fbos.push(new Cy(this._rctx));this._initFBO(this._fbos[t].get(e),e,r)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},pD=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new xt({allocator:e=>e||new mD})}},mD=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}},_D=class{constructor(e,t,r,s,n,a){this.start=e,this.end=t,this.blendMode=r,this.opacity=s,this.output=n,this.baseOpacity=a}},gD=class{constructor(e,t,r,s){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=s,this._passParameters=new lD,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new uD(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=Ae(this._composition),this._backgroundTexture=tt(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let n=0,a=0,o=this.tileSize,l=!1,c=!1;const d=r.view.state.contentPixelRatio;let u=!1;qu.clear(),jo.length=0;const m=e.layerInfo[Te.MAP];let _=0,f=null;for(;_<m.length;_++){const x=r.layerViewByIndex(_,Te.MAP),w=x.layer.opacity,C=x.fullOpacity;if(c=c||$d(x.layer),ch(x)){let S=x.layer.blendMode!=="normal";if(Ll(x.layer.parent)){const R=$_(x.layer.parent);R!=null&&R!==""&&(S=Xw(x.layer.parent)||S)}S&&(u=S,l=!1)}if(w===0&&!u){m[_].pendingUpdates&=~(ne.TEXTURE_NOFADING&ne.TEXTURE_FADING);continue}++a;const T=qc(x),P=mm(e,_,T);if(P){if(m[_].pendingUpdates&=~(ne.TEXTURE_NOFADING&ne.TEXTURE_FADING),Ll(x.layer.parent)){const S=$_(x.layer.parent);S!=null&&S!==""&&Yw(x.layer.parent,_)}T?o=Math.max(o,this.tileSize*d):s===1&&C===1&&(x.isOpaque||this._dataToTexture(P)&&P.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++n,f===null&&(f=_)}}const y=o/this.tileSize,b=this._ensureBackgroundTexture(this.tileSize);n!==0&&f!==null?n===1&&!u&&this._useLayerTexture(e,f)||this._composeMapLayers(e,t,_-1,c,o,y,!l||u,qu,u):this._useBackgroundTexture(e,a,b,t!==ni.FADING)}_ensureBackgroundTexture(e){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=yu,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,this.backgroundColor!=null),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useBackgroundTexture(e,t,r,s){const n=e.renderData,a=!s&&n.textureReference!=null&&(e.surface.view.layerViewManager.updating||t>0)?va.Delayed:va.Immediate;n.setTextureReference(new pm(r,ni.FADING,Ty,e.surface.baseOpacity,0,1),a)}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,Te.MAP),s=$d(r.layer),n=s?e.surface.baseOpacity:1,a=s?1:e.surface.baseOpacity,o=r.fullOpacity,l=mm(e,t,!1);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new pm(l.sourceLayerInfo.data,ni.FADING,l,n,a,o)),!0)}_composeMapLayers(e,t,r,s,n,a,o,l,c){this._composition.ensureBuffer(n);const d=e.surface.baseOpacity;let u=!1,m=Pr.LINEAR_MIPMAP_LINEAR,_=!1,f=0;for(let w=r;w>=0;w--){const C=e.surface.layerViewByIndex(w,Te.MAP),T=qc(C),P=mm(e,w,T),S=C.layer.opacity;if(!P||S===0&&!c)continue;const R=!$d(C.layer)&&!u;R&&(u=!0);let V=!1;l.forEach(X=>{X.start===w&&(X.output=s?Zt.Composite:o&&R?this.backgroundIsGrid?Zt.GridComposite:Zt.ColorComposite:Zt.Composite,X.baseOpacity=R?d:1,jo.push(X),this._composition.openGroup(n),V=!0)}),this._passParameters.baseOpacity=R&&!V&&d<1?d:1;const z=f===0,K=V?Zt.GroupBackgroundComposite:o&&z?this.backgroundIsGrid?Zt.GridComposite:Zt.ColorComposite:Zt.Composite,J=M_[ch(C)?C.layer.blendMode:"normal"];for(this._passParameters.opacity=S,O3(P)?_=this._composition.drawVectorData(this._passParameters,K,n,J,P,a,this.tileSize,_):E3(P)?(this._composition.drawImageryTileData(this._passParameters,K,n,J,P),this._hasNearestInterpolation(P)&&(m=Pr.NEAREST)):this._dataToTexture(P)&&(this._passParameters.texture=P.sourceLayerInfo.data.texture,this._passParameters.offset=P.offset,this._passParameters.scale=P.scale,this._composition.drawRasterData(this._passParameters,K,n,J));jo.length>0&&jo[jo.length-1].end===w;){const X=jo.pop();this._passParameters.baseOpacity=X.baseOpacity,this._passParameters.opacity=X.opacity,this._passParameters.offset=yu,this._passParameters.scale=1,this._composition.drawGroup(this._passParameters,X.output,n,M_[X.blendMode])}f++}const y=e.renderData,b=c||u&&d<1,x=y.ensureTexture(n,b,()=>this._buildTexture(n,b,m));this._composition.copyFBOToTexture(x),this._composition.unbind(),y.setTextureReference(new pm(x,t,Ty,u?1:d,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&t.interpolation==="nearest"}_dataToTexture(e){if(A3(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return M3(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,r=Pr.LINEAR_MIPMAP_LINEAR){if(e==null)return null;const s=new ui;s.wrapMode=Ji.CLAMP_TO_EDGE,s.samplingMode=r,s.maxAnisotropy=this._maxAnisotropy,s.preMultiplyAlpha=!0,s.flipped=!0,s.hasMipmap=!0,t||(s.pixelFormat=hi.RGB);const n=this._rctx;let a;if(typeof e=="number"){s.width=s.height=e;const l=`${e} ${s.pixelFormat}`;a=this._cache.pop(l),a?a.retain():a=new Ac(new Ci(n,s),this._cache)}else if(D3(e)){s.isOpaque=e.isOpaque,s.isOpaque&&(s.pixelFormat=hi.RGB);const l=`${e} ${s.pixelFormat}`;a=this._cache.pop(l),a?(a.retain(),a.texture.setData(e.image)):a=new Ac(new Ci(n,s,e.image),this._cache),e.release()}else try{s.width=e.width,s.height=e.height,a=new Ac(new Ci(n,s,e))}catch{a=new Ac(Xb(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=n.bindTexture(a.texture,Ci.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),n.bindTexture(o,Ci.TEXTURE_UNIT_FOR_UPDATES),a}get test(){return{backgroundTexture:this._backgroundTexture}}};function mm(i,e,t){Ni.layerIndex=e,Ni.vtlNeighborInfos.clear();const r=i.layerInfo[Te.MAP][e];if(sn(Ni.offset,0,0),Ni.tile=i,Ni.scale=1,Ni.sourceLod=i.lij,Ni.sourceLayerInfo=r,Ni.isVTLBackground=t,r.data)return t&&i.forEachLoadedNeighbor((n,a)=>{if(n.level!==i.level)return;const o=n.layerInfo[Te.MAP][e];if(!$3(o)||r.data===o.data)return;const l=Ni.vtlNeighborInfos.pushNew();l.offset=Pn[a],l.sourceLod=n.lij,l.sourceLayerInfo=o}),Ni;const s=r.upsampleInfo;if(s){const n=s.tile.layerInfo[Te.MAP][e];return Ni.tile=s.tile,Ca(Ni.offset,s.offset),Ni.scale=s.scale,Ni.sourceLod=s.tile.lij,Ni.sourceLayerInfo=n,Ni}return t?Ni:null}function $_(i){return i.uid}function Xw(i){let e=i.blendMode!=="normal";return Ll(i.parent)&&(e=Xw(i.parent)||e),e}function Yw(i,e){Ll(i.parent)&&Yw(i.parent,e);const t=$_(i);if(t!=null&&t!==""){const r=qu.get(t);r?r.start=e:qu.set(t,new _D(e,e,i.blendMode,i.opacity,Zt.Composite,1))}}const qu=new Map,jo=new Array,Ni=new pD,Ty={offset:[0,0],scale:1},Pn=new Array;Pn[_t.NORTH]=[0,-1],Pn[_t.NORTH_EAST]=[-1,-1],Pn[_t.EAST]=[-1,0],Pn[_t.SOUTH_EAST]=[-1,1],Pn[_t.SOUTH]=[0,1],Pn[_t.SOUTH_WEST]=[1,1],Pn[_t.WEST]=[1,0],Pn[_t.NORTH_WEST]=[1,-1];const Kw=200,_m=40,fD=.8,yD=10,Dc=1e-6;function vD(i,e,t){const r=e,s=t;let n=0,a=1/0;for(let o=0;o<3;++o){{const l=i[o];if(r[o]<l){if(s[o]<=Dc)return!1;const c=(l-r[o])/s[o];n=Math.max(n,c)}else if(s[o]<=-Dc){const c=(l-r[o])/s[o];a=Math.min(a,c)}if(n>a)return!1}{const l=i[o+3];if(r[o]>l){if(s[o]>=-Dc)return!1;const c=(l-r[o])/s[o];n=Math.max(n,c)}else if(s[o]>=Dc){const c=(l-r[o])/s[o];a=Math.min(a,c)}if(n>a)return!1}}return!0}let Py=class{constructor(e,t,r,s,n){this.aabb=e,this.axis=t,this.d=r,this.midStartIndex=s,this.rightStartIndex=n}},tf=class L_{constructor(e,t,r,s){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=s,this._rayDirection=v(),this.bspNodeTree=new Array;const n=r-t,a=n<=Jw?new Uint16Array(n):new Uint32Array(n);this.indices=a;for(let o=0;o<n;++o)a[o]=o;{const o=TD(e,t,r,s.data,s.stride),l=ie(Math.log2(n/_m),2,yD),c=(d,u,m)=>{const _=wD(a,o,d,u),f=u-d;if(f<=_m){const T=new Py(_,void 0,0,d,u);return this.bspNodeTree.push(T),T}const{axis:y,midValue:b}=CD(_),x=xD(a,o,d,u,y,b),w=(T,P)=>{if(m>l)return;const S=P-T;return S<_m||S>=fD*f?void 0:c(T,P,m+1)},C=new Py(_,y,b,x.next,x.mid);return this.bspNodeTree.push(C),C.leftNode=w(d,x.next),C.rightNode=w(x.mid,u),C};c(0,n,0),this.triangleVertexIndices=PD(a,e,t,r)}}intersectRayTriangleRange(e,t){if(e>=t)return;const r=this.triangleVertexIndices,s=this.positions.data,n=this.positions.stride,a=this._rayOrigin,o=a[0],l=a[1],c=a[2],d=this._rayDirection,u=d[0],m=d[1],_=d[2];for(let f=e,y=3*e;f<t;++f){const b=r[y]*n,x=s[b],w=s[b+1],C=s[b+2],T=r[y+1]*n,P=s[T],S=s[T+1],R=s[T+2],V=r[y+2]*n;y+=3;const z=P-x,K=S-w,J=R-C,X=s[V]-x,me=s[V+1]-w,D=s[V+2]-C,O=m*D-me*_,k=_*X-D*u,H=u*me-X*m,M=z*O+K*k+J*H;if(Math.abs(M)<=Number.EPSILON)continue;const G=o-x,Q=l-w,N=c-C,ce=G*O+Q*k+N*H;if(M>0){if(ce<0||ce>M)continue}else if(ce>0||ce<M)continue;const be=Q*J-K*N,xe=N*z-J*G,Me=G*K-z*Q,$t=u*be+m*xe+_*Me;if(M>0){if($t<0||ce+$t>M)continue}else if($t>0||ce+$t<M)continue;const gt=(X*be+me*xe+D*Me)/M;if(gt>=0){const Qe=this.indices[f]+this.firstTriangleIndex,Fe=xP(z,K,J,X,me,D,bD);this._callback(gt,Fe,Qe,!1)}}L_.numFacesTested+=t-e}intersectRay(e,t,r){L_.numFacesTested=0;const s=e,n=t,a=n[0]-s[0],o=n[1]-s[1],l=n[2]-s[2];if(a*a+o*o+l*l<Dc)return;this._rayOrigin=s;const c=this._rayDirection;c[0]=a,c[1]=o,c[2]=l;const d=this.triangleVertexIndices.length/3;this._callback=r;const u=this.bspNodeTree[0];this.intersectRayBSP(u,0,d)}intersectRayBSP(e,t,r){const s=this._rayOrigin,n=this._rayDirection;if(!vD(e.aabb,s,n))return;const a=e.axis,o=e.d;if(s[a]<o||n[a]<0){const l=t,c=e.midStartIndex;if(l<c){const d=e.leftNode;d!==void 0?this.intersectRayBSP(d,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),s[a]>o||n[a]>0){const l=e.rightStartIndex,c=r;if(l<c){const d=e.rightNode;d!==void 0?this.intersectRayBSP(d,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}};tf.numFacesTested=0;const bD=v(),Wo=[1/0,1/0,1/0],Qo=[-1/0,-1/0,-1/0];function xD(i,e,t,r,s,n){let a=t,o=r;for(;a<o;){const c=i[a];e[6*c+s+3]<=n?++a:(--o,i[a]=i[o],i[o]=c)}let l=a;for(o=r;l<o;){const c=i[o-1];e[6*c+s]>=n?--o:(i[o-1]=i[l],i[l]=c,++l)}return{next:a,mid:l}}function wD(i,e,t,r){if(r<=t)return Lf(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*i[t];for(let n=0;n<3;++n)Wo[n]=e[s+0+n],Qo[n]=e[s+3+n]}for(let s=t+1;s<r;++s){const n=6*i[s];for(let a=0;a<3;++a)Wo[a]=Math.min(Wo[a],e[n+0+a]),Qo[a]=Math.max(Qo[a],e[n+3+a])}return Lf(Wo[0],Wo[1],Wo[2],Qo[0],Qo[1],Qo[2])}function CD(i){const e=i[3]-i[0],t=i[4]-i[1],r=i[5]-i[2],s=e>t?e>r?0:t>r?1:2:t>r?1:r>e?2:0;return{axis:s,midValue:(i[s]+i[s+3])/2}}function TD(i,e,t,r,s){const n=t-e,a=new Float32Array(6*n);for(let o=0;o<n;++o){const l=3*(o+e),c=i[l]*s,d=i[l+1]*s,u=i[l+2]*s;for(let m=0;m<3;++m){const _=r[c+m],f=r[d+m],y=r[u+m];a[6*o+m]=Math.min(_,f,y),a[6*o+3+m]=Math.max(_,f,y)}}return a}function PD(i,e,t,r){const s=r-t;let n=0;for(let o=t;o<r;++o)for(let l=0;l<3;++l)n=Math.max(e[3*o+l],n);const a=n<=Jw?new Uint16Array(3*s):new Uint32Array(3*s);for(let o=0;o<s;++o){const l=3*(i[o]+t);for(let c=0;c<3;++c){const d=e[l+c];a[3*o+c]=d}}return a}const Jw=65535;let Vt=class extends tg{constructor(){super(...arguments),this.output=E.Color,this.overlayMode=vu.Disabled,this.tileBlendInput=tn.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=Et.Simplified}};h([$({count:E.COUNT})],Vt.prototype,"output",void 0),h([$({count:vu.COUNT})],Vt.prototype,"overlayMode",void 0),h([$({count:tn.COUNT})],Vt.prototype,"tileBlendInput",void 0),h([$()],Vt.prototype,"spherical",void 0),h([$()],Vt.prototype,"doublePrecisionRequiresObfuscation",void 0),h([$()],Vt.prototype,"receiveShadows",void 0),h([$()],Vt.prototype,"hasSlicePlane",void 0),h([$()],Vt.prototype,"backfaceCullingEnabled",void 0),h([$()],Vt.prototype,"textureFadingEnabled",void 0),h([$()],Vt.prototype,"renderOccluded",void 0),h([$()],Vt.prototype,"hasScreenSpaceReflections",void 0),h([$()],Vt.prototype,"hasCloudsReflections",void 0),h([$()],Vt.prototype,"invisible",void 0),h([$()],Vt.prototype,"tileBorders",void 0),h([$()],Vt.prototype,"visualizeNormals",void 0),h([$()],Vt.prototype,"screenSizePerspective",void 0),h([$()],Vt.prototype,"receiveAmbientOcclusion",void 0),h([$({count:Et.COUNT})],Vt.prototype,"pbrMode",void 0),h([$({constValue:Dr.Compressed})],Vt.prototype,"normalType",void 0),h([$({constValue:Ta.Compressed})],Vt.prototype,"textureCoordinateType",void 0),h([$({constValue:!1})],Vt.prototype,"highStepCount",void 0),h([$({constValue:!1})],Vt.prototype,"useCustomDTRExponentForWater",void 0),h([$({constValue:!1})],Vt.prototype,"useFillLights",void 0),h([$({constValue:!0})],Vt.prototype,"hasColorTexture",void 0);const gm=7,SD=10,fm=Xu();var Zi;(function(i){i[i.Opaque=0]="Opaque",i[i.Semitransparent=1]="Semitransparent",i[i.TransparentWithDraped=2]="TransparentWithDraped",i[i.Empty=3]="Empty"})(Zi||(Zi={}));let zr=class extends sP{get _isGlobal(){return this._stage.viewingMode===Re.Global}get _techniques(){return this._context.techniqueRepository}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,r,s,n){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=r,this._ellipsoidRadius=s,this.type=bn.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new Vt,this._passParameters=new Wg,this._drawParameters=new d0,this._renderDataPool=new wa(S9),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new dw,this._transparencyState=Zi.Opaque,this._castShadows=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=xi.Occlude,this.produces=new Map([[L.OPAQUE_TERRAIN,()=>this._produces()],[L.TRANSPARENT_TERRAIN,()=>this._produces()],[L.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileTextureCache=new tp((a,o)=>n.newCache(a,o),"TileTexture"),this.tileGeometryCache=new nD(n)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(A(()=>this._overlayRenderer.rendersOccludedDraped,e=>{this.renderOccludedFlags=e?u0:xi.Occlude,this.setNeedsRender()},st))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?sb:nb}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===Zi.TransparentWithDraped||e===Zi.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return uh}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,this._tileRenderer!=null&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,ne.TEXTURE_FADING)}updateTileTexture(e,t){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(e,t===ne.TEXTURE_FADING?ni.FADING:ni.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const r of e.layerInfo[Te.ELEVATION])r.pendingUpdates&=~ne.GEOMETRY;e.resetPendingUpdate(ne.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=SD-gm,r=Math.max(0,Math.floor((e.level-t)/gm)*gm);if(this._isGlobal&&r===0)return Fn;for(;e.parent&&e.level>r;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=jt.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=jt.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=jt.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new gD(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=Xb(this._rctx)}uninitializeRenderContext(){this._emptyTex=Ae(this._emptyTex),this._tileRenderer=Ae(this._tileRenderer)}intersect(e,t,r,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==Zi.Opaque)return;const n=RD,a=OD;ve(n,s,r),Ie(a,1/n[0],1/n[1],1/n[2]);const o=e.results.min,l=e.results.max,c=e.results.ground,d=e.options.store===po.MIN,u=!!e.results.ground.target,m=TS(e.verticalOffset),_=e.tolerance;let f,y=d&&o.dist!=null?o.dist:1/0;const b=w=>{const C=w.renderData;if(!(C!=null&&C.vao))return;const T=C.geometry;WC(fm,T.boundingBox);const P=C.localOrigin;m!=null&&(m.localOrigin=P,m.applyToAabb(fm));const S=fm;if(Zo[0]=r[0]-P[0],Zo[1]=r[1]-P[1],Zo[2]=r[2]-P[2],!gb(S,Zo,a,_,y))return;const R=(k,H,M)=>{k.set(this.type,w,H,M,Bc),y=d&&o.dist!=null?o.dist:1/0},V=(k,H)=>{if(H!=null&&k>=0&&(e.options.backfacesTerrain||pe(H,n)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||t==null||t(r,s,k))){if((c.dist==null||k<c.dist)&&R(c,k,H),e.options.isFiltered)return;e.options.store===po.ALL&&(f==null?(f=gS(e.ray),R(f,k,H),e.results.all.push(f)):k<f.dist&&R(f,k,H)),(o.dist==null||k<o.dist)&&R(o,k,H),e.options.store!==po.MIN&&(l.dist==null||k>l.dist)&&R(l,k,H)}},z=ED;ve(z,s,P);const{indices:K,indexCount:J}=T,X=T.vertexAttributes,me=X.getField(ae.POSITION,bR),D=new Ub(me.typedBuffer,3,X.stride/4),O=J/3;if(!m&&O>Kw){const k=w.renderData;k.intersectionData==null&&(k.intersectionData=new tf(K,0,O,D)),k.intersectionData.intersectRay(Zo,z,V)}else fb(Zo,z,0,O,K,D,null,m,V)},x=this._rootTiles;x!=null&&(()=>{const w=this._tileIterator;w.reset(x);const C=e.options.invisibleTerrain;for(let T=w.next();T;T=w.next())!(T.visible||C&&T.intersectsClippingArea)||m==null&&!T.intersectsRay(r,n,_,y)||u&&this._useStencilForTile(T)?w.skipSubtree():b(T)})()}processScaleRangeQueries(e,t){var r;if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const s of this._visiblePatchesByOrigin.values())for(const n of s)((r=n.renderData)==null?void 0:r.textureReference)!=null&&e.queriesForTile(n);e.process(),t.madeProgress()}}prepareTechnique(e){const t=li("enable-feature:terrain-shadows")&&e.bindParameters.shadowMap.enabled;if(t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0),e.bindParameters.slot===L.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&u0))return null}else{const r=this.transparency===Zi.Opaque?L.OPAQUE_TERRAIN:L.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==r)return null}if(this.transparency===Zi.Empty)return null;switch(e.output){case E.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.lastFrameColor!=null,this._techniqueConfiguration.hasCloudsReflections=e.bindParameters.cloudsFade.data!=null,this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssao!=null,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(E.Color,e.bindParameters.slot===L.OCCLUDED_TERRAIN);case E.Shadow:case E.ShadowExcludeHighlight:return this._castShadows?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.Shadow,!1)):null;case E.LinearDepth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.LinearDepth,!1);case E.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.Normal,!1);case E.ObjectAndLayerIdColor:return this._updateTechnique(E.ObjectAndLayerIdColor,!1);case E.Highlight:return this._overlayRenderer.hasHighlights?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(E.Highlight,!1)):null}return null}renderNode(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case E.Color:{const r=e.bindParameters.slot===L.OCCLUDED_TERRAIN?vs.Occluded:vs.Color;this._renderMaterialPass(e,t,r);break}case E.LinearDepth:case E.Normal:this._renderAuxiliaryPass(e,t,vs.Color,this._visiblePatchesByOrigin);break;case E.Highlight:this._renderAuxiliaryPass(e,t,vs.Highlight,this._visiblePatchesByOrigin);break;case E.Shadow:case E.ShadowExcludeHighlight:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case E.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,vs.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(this._tileRenderer==null)return;const t=this._tileRenderer;let r;if(e!=null){const s=ho.toUnitRGBA(e);r=It(s[0]||0,s[1]||0,s[2]||0)}t.setBackground(r),this._allTiles.forAll(s=>t.updateTileTexture(s,ni.FADING)),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?tn.GridComposite:t.backgroundColor!=null?tn.ColorComposite:tn.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Ul.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const r of e)uw(this.renderOrder,r,t);e.sort((r,s)=>pw(r[0],s[0],this.renderOrder)),this._visiblePatchesByOrigin=new Map(e.map(r=>[r[0].renderData.localOrigin,r])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){var t;const e=this._rootTiles;if(e!=null){(t=e[0])==null||t.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const r of e)this._rebuildPatchGroupsForRootTile(r)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const r=t.next(),s=r.renderData;if(!s){this._numTilesCulled++;continue}const n=s.localOrigin;if(this._castShadows){let o=this._allPatchesByOrigin.get(n);o||(o=[],this._allPatchesByOrigin.set(n,o)),o.push(r)}if(!r.visible){this._numTilesCulled++,t.skipSubtree();continue}let a=this._visiblePatchesByOrigin.get(n);a||(a=[],this._visiblePatchesByOrigin.set(n,a)),a.push(r),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,r,s){const n=e.rctx;this._passParameters.overlayContent=r,n.bindTechnique(t,e.bindParameters,this._passParameters);const a=this._stencilEnabledLayerExtents.length>0;s.forEach(o=>{this._drawParameters.origin=o[0].renderData.localOrigin,t.program.bindDraw(this._drawParameters,e.bindParameters,this._passParameters);for(let l=0;l<o.length;l++)this._renderPatch(e,t,o[l],Ti.TRIANGLES,a,r)}),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,r){var m;const{rctx:s}=e;this._passParameters.overlayContent=r,s.bindTechnique(t,e.bindParameters,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const n=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const _=mb(this._stage.viewingMode,this._ellipsoidRadius),f=this.pointsOfInterest.centerOnSurfaceFrequent.distance;_.update({distance:f,fovY:n.fovY})}const o=this._stencilEnabledLayerExtents.length>0,l=r===vs.Occluded;l&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",Fn),a.setUniform4fv("texOffsetAndScale",B_));const c=((m=this._tileRenderer)==null?void 0:m.backgroundColor)!=null?this._tileRenderer.backgroundColor:Fn;this._techniqueConfiguration.tileBlendInput===tn.ColorComposite&&a.setUniform3fv("backgroundColor",c);const d=this.wireframe?Ti.LINES:Ti.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);const u=this._visiblePatchesByOrigin;for(const _ of u.values()){const f=_[0].renderData.localOrigin;t.program.bindDraw(new d0(f),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const y of _){const b=y.renderData,x=b.textureReference;if(x!=null){if(!l){a.setUniform4fv("texOffsetAndScale",x.offsetAndScale),a.bindTexture("tex",x.texture.texture);const w=b.textureFadeFactor,C=w<1?b.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&C!=null&&w<1?(a.setUniform1f("fadeFactor",w),a.setUniform4fv("nextTexOffsetAndScale",C.offsetAndScale),a.setUniform3fv("nextTexOpacities",C.opacities),a.bindTexture("texNext",C.texture.texture)):a.setUniform1f("fadeFactor",1),b.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",x.opacities)}this._renderPatch(e,t,y,d,o,r),y.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,r,s,n,a){const o=r.renderData,l=o.vao,c=l==null?void 0:l.indexBuffer;if(!l||c==null)return void(Bi&&console.error("Rendered tile with no indices: ",r.lij," : ",o));const d=t.program;a==null||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(d,o.overlay),n&&(t.useStencil=this._useStencilForTile(r),e.rctx.setPipelineState(t.getPipeline()));const u=o.geometry.indexCount;e.rctx.bindVAO(l),d.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(s,u,c.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,this._techniqueConfiguration.renderOccluded=t,this._shaderTechnique=this._techniques.releaseAndAcquire(Cw,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};h([p({readOnly:!0})],zr.prototype,"_isGlobal",null),h([p()],zr.prototype,"renderOccludedFlags",void 0),h([p({value:!1})],zr.prototype,"renderingDisabled",null),h([p({value:!0})],zr.prototype,"visible",null),h([p()],zr.prototype,"renderPatchBorders",null),h([p()],zr.prototype,"visualizeNormals",null),h([p()],zr.prototype,"cullBackFaces",null),h([p({value:Ul.FRONT_TO_BACK})],zr.prototype,"renderOrder",null),h([p()],zr.prototype,"wireframe",null),zr=h([F("esri.views.3d.terrain.TerrainRenderer")],zr);const RD=v(),OD=v(),Zo=v(),ED=v();let AD=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Hs=class extends Pe{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),A(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!zc(t)||t.isRejected())&&!(t.isFulfilled()&&!MD(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!((t==null?void 0:t.type)==="vector-tile"||Yv(t)))),e)if(e.isResolved()){const t=Ku(e,this.viewSpatialReference,this.viewingMode);if(t!=null){const r=new Fo(t.tileInfo);this._lockTilingScheme(r)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Re.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Fo.makeWebMercatorAuxiliarySphere(t):hu(e.spatialReference)&&(e=Fo.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(A(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Re.Global){const e=this.extentHelper.viewSpatialReference,t=hu(e)||G_(e)||H_(e);e.isWebMercator?this.tilingScheme=Fo.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Fo.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;e==null||uo(e,this.extent)||(this.tilingScheme=Fo.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function MD(i,e,t){return Ku(i,e,t)!=null}h([p()],Hs.prototype,"tilingScheme",void 0),h([p({readOnly:!0})],Hs.prototype,"extent",void 0),h([p({value:!1})],Hs.prototype,"tilingSchemeLocked",void 0),h([p({constructOnly:!0})],Hs.prototype,"viewSpatialReference",void 0),h([p({constructOnly:!0})],Hs.prototype,"layers",void 0),h([p({constructOnly:!0})],Hs.prototype,"extentHelper",void 0),h([p({constructOnly:!0})],Hs.prototype,"viewingMode",void 0),Hs=h([F("esri.views.3d.terrain.TilingSchemeLogic")],Hs);let DD=class{constructor(){this.offset=Di(),this.scale=0,this.tile=null}init(e,t,r,s){this.tile=e,this.offset[0]=t,this.offset[1]=r,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}};var eu;let Se=eu=class extends es.EventedMixin(Pe){constructor(i){var e,t,r;super(i),this._scaleRangeQueries=new Jd,this._iteratorPool=new wa(dw,s=>s.remove=()=>this._iteratorPool.release(s)),this._postorderIterator=new WM,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new AD,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=v(),this._eyePosSurfaceSR=v(),this._splitLimits=new us,this._frustum=Tu(),this._viewProjectionMatrix=ct(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new ip,this._frameTask=wu,this._allTiles=new xt,this._upsampleInfoPool=new wa(DD),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=ci(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=zi.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new bl(1/0,-1/0),this.rootTileElevationBounds=new bl(1/0,-1/0),this._sebProjectorMap=new Map,this._sebProjectorCache=QC(),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new ir({...i,surface:this}),this._isGlobal=!((t=(e=i.view)==null?void 0:e.state)!=null&&t.isLocal),this._isGeographic=((r=this._spatialReference)==null?void 0:r.isGeographic)??!1,this._tileConstructor=this._isGlobal?iD:J9}initialize(){const i=this.view,e=i.resourceController;this._lercDecoder=lR(e);const t=e.memoryController;this._tileCache=new tp((l,c)=>t.newCache(l,c),"terrain-tile"),this._upsampleMapCache=t.newCache("terrain-upsample",l=>l.unloadMapData()),this._elevationQueryCache=new KS(t.newCache("elevation-query"));const r=this.overlayManager;this._renderer=new zr(r.renderer,i._stage,this._allTiles,bt(i.spatialReference).radius,t),this.addHandles([A(()=>r.renderer.isEmpty,()=>this._evaluateTransparency()),A(()=>this.renderer.visible,l=>this.suspended=!l)],"overlayManager"),this.addHandles([A(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?ni.UNFADED:ni.IMMEDIATE)},vt),A(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?ni.UNFADED:ni.IMMEDIATE),vt),A(()=>this.backgroundColor,(l,c)=>{l!=null&&l.equals(c)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},st),A(()=>this.snapLevel,()=>this._viewChanged=!0,st),A(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus.renderLocation,()=>this._allTilesSorted=!1)}),A(()=>dr.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?he(()=>import("./TerrainTileTree3DDebugger-BvhlzHU-.js"),__vite__mapDeps([366,1,2,367])).then(({TerrainTileTree3DDebugger:c})=>{!this._treeDebugger&&dr.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new c({view:i}))}):l||(this._treeDebugger=te(this._treeDebugger))},oi)]);const{spatialReference:s}=i;this._extentHelper=FM(this.viewingMode,{layers:i.map.allLayers,layerViews:i.allLayerViews,viewSpatialReference:s});const n=new ZC({getCollections:()=>{var l,c;return(c=(l=i.defaultsFromMap)==null?void 0:l.mapCollections)==null?void 0:c.map(({layers:d})=>d)},getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),a=new Hs({layers:n,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:s});this._set("tilingSchemeLogic",a),this._updateTilingScheme(),this._elevationDataRequester=e.createStreamDataRequester(Ks.ELEVATION),this._mapDataRequester=e.createStreamDataRequester(Ks.BASEMAP);const o=e.scheduler;this._frameTask=o.registerTask(fi.TERRAIN_SURFACE,this),this.addHandles([A(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),oi),A(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),st),A(()=>this.extent,()=>this._updateRootTiles(),oi),i.on("resize",()=>this._viewChangeUpdate()),A(()=>{const l=i.state;return[this._lodBias,this.lodSnapping,i.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),vt),A(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.fadeDuration},l=>this._renderer.textureFadingEnabled=l>0,oi),A(()=>{var l;return(l=i.qualitySettings)==null?void 0:l.physicallyBasedRenderingEnabled},l=>this._renderer.pbrMode=l?Et.Simplified:Et.Disabled,oi),A(()=>this._userClippingExtent,()=>this._updateClippingExtent(),st)]),this.addHandles(i.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._lercDecoder=tt(this._lercDecoder),this._removeAllTiles(),this._set("tilingSchemeLogic",te(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((i,e)=>this._unregisterTiledLayerView(e)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",te(this.overlayManager)),this._tileCache=te(this._tileCache),Gg.prune(),this._treeDebugger=te(this._treeDebugger),this._renderer=te(this._renderer),this._iteratorPool=te(this._iteratorPool),this._upsampleMapCache=te(this._upsampleMapCache),this._elevationQueryCache=te(this._elevationQueryCache),this._set("view",null),this._extentHelper=te(this._extentHelper),this._upsampleInfoPool=te(this._upsampleInfoPool),dR(),p9()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var i,e;if(this.lodSnapping===Pp.ON){const t=this.view,r=this.tilingScheme,s=(e=(i=t.pointsOfInterest)==null?void 0:i.cameraOnSurface)==null?void 0:e.scale;if(r&&s){const n=t.state.contentCamera;let a=v3(t,n.eye,n.viewForward,n.up).tilt;a>90&&(a=180-a);const o=2*(a/90)**2,l=r.levelAtScale(s)-o,c=Math.min(l+t.qualitySettings.tiledSurface.lodBias,this._splitLimits.maxLod||1/0);return c<=0?null:c}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Pp.ON:Pp.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:i}=this,{clippingArea:e}=this.view;if(e==null||i==null)return null;const t=ci(),r=Gv(e,t,i)?t:null,s=this._get("extent");return uo(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const i=qm(this.groundExtent,this._userClippingExtent,ci()),e=this._get("extent");return uo(i,e)?e:i}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var i;return(i=this.tilingSchemeLogic)==null?void 0:i.extent}get updating(){var i,e;return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||(i=this._watchUpdatingTracking)!=null&&i.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||(e=this.overlayManager)!=null&&e.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){var i,e,t;return((t=(e=(i=this.view)==null?void 0:i.map)==null?void 0:e.ground)==null?void 0:t.opacity)??1}set baseOpacity(i){this.view.map.ground.opacity=i}get viewingMode(){return this.view.state.viewingMode}get ready(){return this._rootTiles!=null}set renderOrder(i){this._renderer.renderOrder=i,this._set("renderOrder",i)}get rootTiles(){return this._rootTiles}get spatialReference(){var i;return((i=this.tilingScheme)==null?void 0:i.spatialReference)??null}get backgroundColor(){var i,e,t;return(t=(e=(i=this.view)==null?void 0:i.map)==null?void 0:e.ground)==null?void 0:t.surfaceColor}set backgroundColor(i){this.view.map.ground.surfaceColor=i}set slicePlaneEnabled(i){this._renderer.slicePlaneEnabled=i,this._set("slicePlaneEnabled",i),this._evaluateTransparency()}get tilingSchemeLocked(){var i;return((i=this.tilingSchemeLogic)==null?void 0:i.tilingSchemeLocked)??!1}get wireframe(){var i;return(i=this._renderer)==null?void 0:i.wireframe}set wireframe(i){i!==this._renderer.wireframe&&(this._renderer.wireframe=i,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===Zi.Opaque}set suspended(i){this._set("suspended",i),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(i,e,t,r){this._renderer.intersect(i,e,t,r)}getElevation(i,e,t,r){const s=this._rootTiles;if(!(s!=null&&s.length)||s[0].layerInfo[Te.ELEVATION].length===0)return null;let n=this._elevationProjectorCache.get(r);if(n===void 0&&(n=Vm(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,n)),n==null)return de.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=Ie(_c,i,e,t);return n(a,0,a,0),Sy(s,a[0],a[1])}getElevations(i,e,t){const r=this._rootTiles,s=r?r[0].layerInfo[Te.ELEVATION].length:0;if(r!=null&&r.length&&s!==0)for(let n=0;n<e;++n){const a=3*n;t(n,Sy(r,i[a],i[a+1]))}else for(let n=0;n<e;++n)t(n,null)}getScale(i){if(!this.tilingScheme)return null;if(!_u(i,_c,this.spatialReference))return de.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this._rootTiles;if(e!=null){for(const t of e)if(t!=null&&t.containsPoint(_c)){let r=t;for(;r.children[0]&&!r.rendered;){const s=r.children[0].extent;let n=0;_c[0]>s[2]&&(n+=1),_c[1]<s[1]&&(n+=2),r=r.children[n]}return this._getLodBiasCorrectedScale(r.level)}}return 1/0}_ensureSEBProject(i){const e=this._sebProjectorMap.get(i);if(e)return e;const t=Vm(i,this._tilingSchemeSpatialReference,this._sebProjectorCache)??null;return this._sebProjectorMap.set(i,t),t}getSphereElevationBounds(i,e){const t=this._ensureSEBProject(e);if(t==null)return de.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;uS(i,Xo);const r=At(Xo);t(r,0,r,0);const s=new Su,n=this._rootTiles;if(n!=null){const a=[];for(const l of n)a.push(l);let o=0;for(;o<a.length;){const l=a[o];if(++o,!If(l.extent,Xo))continue;const c=l.children;if(c[0]==null||l.rendered)s.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(const d of c)a.push(d)}}return s}getRootElevationBounds(){return new Su(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getSphereScale(i,e){if(!this.tilingScheme)return null;if(!_u(i,At(Xo),this.spatialReference))return de.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Xo[3]=e;let t=null;const r=n=>{if(n&&If(n.extent,Xo)){const a=n.children;if(a[0]&&!n.rendered)for(const o of a)r(o);else{const o=this._getLodBiasCorrectedScale(n.level);t=t==null?o:Math.min(t,o)}}},s=this._rootTiles;if(s!=null)for(const n of s)r(n);return t}queryVisibleScaleRange(i,e,t,r){const s=e?this.tilingScheme.levelAtScale(e):0,n=t?this.tilingScheme.levelAtScale(t):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(i,s+a,n+a,r)}_evaluateTransparency(){var n,a;const i=this.baseOpacity,e=this.overlayManager.renderer.isEmpty,t=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?e?Zi.Empty:Zi.TransparentWithDraped:i>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Zi.Opaque:Zi.Semitransparent,s=t!==r;return s&&(this._renderer.transparency=r,(a=(n=this.view)==null?void 0:n._stage)==null||a.renderer.setParameters({terrainTransparency:this._renderer.transparency})),s}_updateTilingScheme(){var t,r,s,n;const i=this.tilingSchemeLogic.tilingScheme;if(i===this.tilingScheme)return;Jt(!!i,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((r=(t=this.view)==null?void 0:t.state)!=null&&r.isLocal),this.tilingScheme&&this._removeAllTiles();const e=(i==null?void 0:i.spatialReference)??zi.WebMercator;this._spatialReference=e,this._isWebMercator=!!(e!=null&&e.isWebMercator),this._isWebMercatorOnPlateCarree=this._isWebMercator&&Uv((s=this.view)==null?void 0:s.renderSpatialReference),this._isGeographic=(e==null?void 0:e.isGeographic)??!1,this._set("tilingScheme",i),this._tilingSchemeSpatialReference=(n=this.tilingScheme)==null?void 0:n.spatialReference,this._sebProjectorMap.clear(),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference),this._updateRootTiles())}_acquireTile(i,e,t,r){const s=this._tileCache.pop(eu._tileMemcacheKey);return s?(s.init(i,e,t,r,this),s):new this._tileConstructor(i,e,t,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:i,tilingScheme:e}=this;if(!e)return;const t=LD;let r=e.rootTilesInExtent(i,t,5*Bh);if(this._rootTiles!=null){if(r.length>Bh)return void de.getLogger(this).warn(L3);const s=this._rootTiles.map(a=>a.lij),n=XC(s,r,Yd);if(this._updatingRootTiles=!0,n.removed.length>0||n.added.length>0){const a=this._rootTiles.filter(o=>!(n.removed.findIndex(l=>Yd(l,o.lij))>-1)||(this._purgeTile(o),!1));n.added.forEach(o=>a.push(this._newRootTile(o))),this._setRootTiles(a)}}else this._updatingRootTiles=!0,r.length>Bh&&(de.getLogger(this).warn(I3),r=e.rootTilesInExtent(i,t,Bh)),this._setRootTiles(r.map(s=>this._newRootTile(s)));uo(t,this._rootTilesExtent)||(this._rootTilesExtent=ci(t)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const i=this._allTiles.filter(e=>e.isLoaded&&e.intersectsClippingArea);i.forEach(e=>this._renderer.updateTileGeometryState(e)),i.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(i),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(i){if(i.length===0)return;i.sort(qn);const e=this.renderer;i.forEach(t=>e.updateGeometryIfNeeded(t)),i.forEach(t=>this._pendingTilesForElevationUpdateEvent.add(t))}_shouldSplit(i){return i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===ne.SPLIT}_newRootTile(i){const e=this._acquireTile(0,i[1],i[2],null);return this._shouldSplit(e)&&e.setPendingUpdate(ne.SPLIT),this._loadTile(e),this._markTileToUpdate(e),this._updateRootTileElevationBounds(),e}_setRootTiles(i){if(this._rootTiles=i,this._allTiles.clear(),i!=null){const e=this._iteratorPool.acquire();for(e.reset(i);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(i)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(i){i.updateClippingStatus(this.extent)&&i.resetPendingUpdate(ne.GEOMETRY)&&this._updateTileGeometryState(i)}_updateTilesVisibility(i){if(i==null)return;const e=e9(i),t=this.visibleElevationBounds;let r=e?t.min:1/0,s=e?t.max:-1/0;const n=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(i);!o.done;){const l=o.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(ne.GEOMETRY)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(a),l.renderData&&(r=Math.min(l.elevationBoundsMin,r),s=Math.max(l.elevationBoundsMax,s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(t.min!==r||t.max!==s)&&(this.visibleElevationBounds=new bl(r,s))}_updateRootTileElevationBounds(){let i=1/0,e=-1/0;const t=this._rootTiles;t!=null&&t.forEach(({elevationBoundsMin:s,elevationBoundsMax:n})=>{i=Math.min(i,s),e=Math.max(e,n)});const r=this.rootTileElevationBounds;r.min===i&&r.max===e||(this.rootTileElevationBounds=new bl(i,e))}_updateViewDependentParameters(){const{camera:i,contentCamera:e}=this.view.state,t=Math.tan(.5*e.fovX),r=Math.tan(.5*e.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*i.pixelRatio;this._splitLimits.aboveGround=i.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/i.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/i.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=r_(this._splitLimits.frustum??Tu(),e.frustum):this._splitLimits.frustum=null,r_(this._frustum,i.frustum),Yr(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),le(this._eyePosRenderSR,e.eye),ph(i.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(i){i.updateVisibility(),this._renderer.updateTileGeometryState(i)&&this._markTileToUpdate(i),this._usedMemory=null}_markAllTileNeighborsForUpdate(i){i.forEachLoadedNeighbor(e=>{this._layerViews[Te.MAP].some(qc)&&e.setPendingUpdate(ne.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)})}_updateTileTexture(i,e){const t=i.resetPendingUpdate(ne.TEXTURE_FADING)?ne.TEXTURE_FADING:!!i.resetPendingUpdate(ne.TEXTURE_NOFADING)&&ne.TEXTURE_NOFADING;t&&(this._renderer.updateTileTexture(i,t),this._usedMemory=null,e.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const i=vm.extent;ln(i),this._pendingTilesForElevationUpdateEvent.forEach(e=>_a(i,e.extent,i)),this._pendingTilesForElevationUpdateEvent.clear(),vm.spatialReference=this.spatialReference,this.emit("elevation-change",vm),this._shouldEmitChangeEvent=!1}runTask(i){this._handleLayerViewChanges(i),this._frameTask.processQueue(i),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,i),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(i),this._sortTiles(i);const e=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(i,e),this._updateElevation(i),this._updateTextures(i),e||this._mergeAndSplit(i,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),i.done&&i.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),Bi&&this._checkTileInvariant(),!i.hasProgressed)return Yi}_checkTileInvariant(){const i=new Map;this._allTiles.forAll(e=>i.set(e,new Set)),this._allTiles.forAll(e=>{var t;if(Jt(e.rendered===e.isLeaf,` rendered ${e.rendered} != ${e.isLeaf} leaf`),!e.isLeaf){const r=n=>n.unmergableChildCount===0&&n.maxLevelDeltaNeighborCount===0,s=e.children.reduce((n,a)=>n+(r(a)?0:1),0);if(Jt(e.unmergableChildCount===s,` Tile[${e.lij.toString()}] unmergeable child count mismatch: actual ${e.unmergableChildCount} vs ${s}`),e.hasPendingUpdate(ne.MERGE)){Jt(!e.hasPendingUpdate(ne.SPLIT),"Tile can be both split and merge at the same time");for(const n of e.children)Jt(n.isLeaf||n.hasPendingUpdate(ne.MERGE),"Child of tile to merge must also merge")}}for(let r=0;r<4;++r){if(e.rendered){const o=(t=e.renderData)==null?void 0:t.geometryState.edgePeerNeighbors[r];if(o!=null){{const l=e.level-o.level<=ei;l||(console.log(`tile level delta [${e.lij.toString()}] vs [${o.lij.toString()}] > ${ei}  (edge[${r}])`),Jt(l,`tile level delta [${e.level}] vs [${o.level}] > ${ei}`))}Jt(e.level-o.level<=ei,`Max tile lod delta exceeded: [${e.lij.toString()}] vs [${o.lij.toString()}]`)}}const s=e.level-ei,n=o=>o.isLeaf||o.level===e.level,a=e.findNeighborTile(Ps[r],n);if(a!=null){if(e.isLeaf&&e.level>=ei){let o=a;for(;e.level-o.level<ei;)o=o.parent;const l=[s,e.lij[1]>>ei,e.lij[2]>>ei];if(!Yd(l,o.lij)){const c=i.get(o);Jt(!c.has(e),"Cannot already have neighbor"),c.add(e)}}Jt(a.rendered||a.level===e.level,"Non-same-level-neighbor of rendered must be rendered"),Jt(e.level-a.level<=ei,`Tile level delta [${e.level}] vs [${a.level}] > ${ei}`)}}}),this._allTiles.forAll(e=>{const t=e.maxLevelDeltaNeighborCount,r=i.get(e);Jt(t===r.size,`Tile[${e.lij.toString()}] merge-blocker mismatch: actual ${t} vs ${r.size}`)})}_updateAllTilesStatus(i){if(!this._viewChanged||!this._rootTiles||i.done)return;this._viewChanged=!1;const e=new ID(this._allTiles.length);e.pushAll(this._rootTiles);const t=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll(a=>{a.maxLevelDeltaNeighborCount=0,a.unmergableChildCount=0});const n=this._viewProjectionMatrix;for(;!e.empty;){const a=e.pop(),o=a.parent,l=o!=null&&o.hasPendingUpdate(ne.MERGE),c=l?ne.MERGE:a.shouldSplit(r,s,t),d=c===ne.SPLIT;a.isLeaf?bm(a,d):e.pushAll(a.children),l?(a.resetPendingUpdate(ne.SPLIT),a.isLeaf||a.setPendingUpdate(ne.MERGE),this._updateClippingStatus(a),a.updateVisibility(),a.updateScreenDepth(n)):d?(a.resetPendingUpdate(ne.MERGE),a.isLeaf&&a.setPendingUpdate(ne.SPLIT)):(a.resetPendingUpdate(ne.SPLIT)&&a.updateAgentSuspension(),c===ne.ELEVATION&&a.updateAgents(Te.ELEVATION),a.isLeaf||(a.setPendingUpdate(ne.MERGE),a.resetPendingUpdate(ne.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),i.madeProgress()}_sortTiles(i){i.done||this._allTilesSorted||(KM(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),i.madeProgress())}_markTileToUpdate(i){I(i.isLoaded),i.intersectsClippingArea&&(this._pendingTilesToUpdate.add(i),this._markAllTileNeighborsForUpdate(i))}_updatePendingTileGeometries(){const i=this._pendingTilesToUpdate,e=Array.from(i.keys()).filter(s=>s.isLoaded&&s.intersectsClippingArea);if(e.length===0)return void i.clear();const t=(s,n)=>{!(n!=null&&n.isLoaded)||!n.intersectsClippingArea||n.level<s.level||i.has(n)||(i.add(n),e.push(n),n.renderData.updateNeighborData())};e.sort(qn);const r=e.length;for(let s=0;s<r;++s){const n=e[s];I(n.isLoaded),I(n.intersectsClippingArea);const a=n.renderData;a.updateNeighborData();const o=a.dirtyEdgeResolutions,l=a.geometryState,c=d=>{var m;const u=fu[d];t(n,(m=l.cornerPeerNeighbors[d])==null?void 0:m.findCorner(gu(u),_=>_.isLoaded))};for(let d=0;d<4;++d)if(o&1<<d){const u=a.geometryState.edgePeerNeighbors[d];u&&(u==null?void 0:u.level)>=n.level&&u.forAllSubtreeOnSide(K_(Ps[d]),m=>!(!m.isLoaded||!m.intersectsClippingArea)&&(I(i.has(m)||qn(n,m)<0),t(n,m),!0)),c((d+1)%4),c(d)}}i.clear(),this._updateTilesGeometries(e),this._shouldEmitChangeEvent=!0,Bi&&km&&this.checkAllTilesWaterproofness()}_mergeAndSplit(i,e){if(this.suspended||i.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let t=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!i.done;){s=!0;let n=!1;const a=!this._allTiles.some(o=>{if(!t&&!r&&!o.visible)return i.done;let l=o;if(o.hasPendingUpdate(ne.MERGE)){if(!e||o.unmergableChildCount>0)return i.done;for(o.resetPendingUpdate(ne.MERGE);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(ne.MERGE);)l=l.parent;this._mergeTile(l),n=!0,i.madeProgress()}else if(o.resetPendingUpdate(ne.SPLIT)){let c=!0;const d=o.level;if(d>=ei){const u=m=>m.isLeaf||d-m.level<ei;for(let m=0;m<4;++m){const _=o.findNeighborTile(Ps[m],u);_!=null&&d-_.level===ei&&(c=!1,Bi&&(I(_.isLeaf),I(_.hasPendingUpdate(ne.SPLIT))))}}c?(this._splitTile(o),i.madeProgress(),n=!0):o.setPendingUpdate(ne.SPLIT)}return i.done});if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!t){t=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?i.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(i)}_updateElevation(i){i.done||(this._allTiles.some(e=>(e.resetPendingUpdate(ne.GEOMETRY)&&(this._updateTileGeometryState(e),this._shortBatches&&this._updatePendingTileGeometries(),i.madeProgress()),i.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(i){i.done||this._allTiles.some(e=>(this._updateTileTexture(e,i),i.done))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(jt.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const i=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-i)*N3}_getLodBiasCorrectedScale(i){const e=this.tilingScheme.levels,t=ie(i-this._lodBias,0,e.length-1),r=t-Math.floor(t);return e[Math.floor(t)].scale*(1-r)+e[Math.ceil(t)].scale*r}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(i=>this._purgeTile(i)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeDescendantTiles(i){if(!i.children[0])return;const e=i.children.slice();i.unsetChildren();for(let t=0;t<4;++t)this._purgeTile(e[t])}_purgeTile(i){i.isLeaf?Ry(i):this._purgeDescendantTiles(i),this._allTiles.removeUnordered(i),this._unloadTile(i),this._tileCache.put(eu._tileMemcacheKey,i)}_unloadTile(i){this._pendingTilesToUpdate.delete(i),this._pendingTilesForElevationUpdateEvent.delete(i),i.unload(this._renderer)}_splitTile(i){Jt(i.isLeaf,"Tile that is already split should not be split again!"),Jt(i.rendered,"Tile marked to split is not rendered"),Ry(i);const e=i.level+1,t=2*i.lij[1],r=2*i.lij[2],s=i.setChildren(this._createTile(e,t,r,i),this._createTile(e,t,r+1,i),this._createTile(e,t+1,r,i),this._createTile(e,t+1,r+1,i));this._allTiles.pushArray(s),i.updateAgentSuspension(),Jt(i.rendered,"parent should be rendered"),this._unloadTile(i),s.forEach(n=>this._loadTile(n)),s.forEach(n=>this._pendingTilesToUpdate.add(n)),this._markAllTileNeighborsForUpdate(i),this._emitTileScaleChange(i,i.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),s.forEach(n=>bm(n,n.hasPendingUpdate(ne.SPLIT))),++this._performanceInfo.numSplit}_emitTileScaleChange(i,e=i.level){Sd.spatialReference=this.spatialReference,Sd.extent=i.extent,Sd.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",Sd)}_createTile(i,e,t,r){Jt(!!r,"_createTile sanity check");const s=this._acquireTile(i,e,t,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(ne.SPLIT),s}get _shortBatches(){return this.view.state.mode!==Wi.IDLE}_mergeTile(i){Jt(!i.hasPendingUpdate(ne.SPLIT),"_mergeTile sanity check"),Jt(!i.isLeaf,"Cannot merge a leaf"),i.isLeaf||(this._purgeDescendantTiles(i),Jt(!i.renderData,"_mergeTile sanity check"),this._loadTile(i),this._markTileToUpdate(i),this._emitTileScaleChange(i),this._shortBatches&&this._updatePendingTileGeometries(),bm(i,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(i){i.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(i)}_elevationDataArrived(i,e,t){const r=new IM(i.lij,i.extent,t);i.dataArrived(e,Te.ELEVATION,r);const s=[i],n=i.level,a=this._iteratorPool.acquire();for(a.reset(s);!a.done;){const o=a.next();o.findElevationBoundsForLayer(e,n),o.computeElevationBounds()}n===0&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(i=Ys){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const t=new Set;let r=-1;for(let s=this.view.allLayerViews.length-1;s>=0;s--){const n=this.view.allLayerViews.items[s];if(t.add(n.uid),jm(n)||ic(n))if(this._basemapLayerViewHandles.has(n.uid)&&!ic(n)){const a=this._layerClassFromLayerView(n),o=this._getLayerIdxByUID(a,n.uid);o!=null&&((o<r||r==null)&&(e=!0),r=o)}else this._registerTiledLayerView(n),n.layer.loaded&&(e=!0)}this._basemapLayerViewHandles.forEach((s,n)=>{t.has(n)||(this._unregisterTiledLayerView(n),e=!0)}),e&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),i.madeProgress()}_allSurfaceLayersTransparent(){var e,t;let i=((t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.opacity)===0;for(const r of this.view.allLayerViews.items)if(e0(r)&&!$d(r.layer)&&r.fullOpacity!==0)return i=!1,i;return i}_hasCompositeBlendMode(){for(const i of this.view.allLayerViews.items)if((ch(i)||ic(i))&&a9(M_[i.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(i){return t0(i)?Te.ELEVATION:Te.MAP}_registerTiledLayerView(i){const e=[];if((ch(i)||ic(i))&&e.push(A(()=>i.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(ni.UNFADED)})),!ic(i)){const t=this._layerClassFromLayerView(i);e.push(A(()=>i.suspended,()=>this._updateTiledLayers())),e.push(A(()=>i.fullOpacity,()=>this._updateTileTextures(ni.UNFADED))),e.push(A(()=>"effectiveScaleRange"in i.layer?i.layer.effectiveScaleRange:null,()=>this._restartAllAgents(t))),e.push(i.on("data-changed",()=>{const r=this._getLayerIdxByUID(t,i.uid);r!=null&&this._invalidateLayerData(r,t)}))}this._unregisterTiledLayerView(i.uid),this._basemapLayerViewHandles.set(i.uid,e)}_unregisterTiledLayerView(i){const e=this._basemapLayerViewHandles.get(i);if(e){for(const t of e)t.remove();this._basemapLayerViewHandles.delete(i)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const i=this.view.allLayerViews,e=[[],[]];let t=null;i.forEach(r=>{if(!r.layer||r.suspended||!jm(r)||!r.fullExtent)return;const s=this._layerClassFromLayerView(r);if(s===Te.MAP){const n=r.displayLevelRange.maxLevel;n!==1/0&&(t===null||n>t)&&(t=n)}e[s].push(r)});for(const r of Ya){const s=this._layerViews[r],n=e[r];n.reverse();const a=n.length;let o=s.length!==a;const l=new Array(a),c=new Array(s.length);this._layerIndexByUid[r].clear();for(let d=0;d<a;d++){const u=n[d].uid;this._layerIndexByUid[r].set(u,d);const m=s.indexOf(n[d]);l[d]=m,d!==m&&(o=!0),m>-1&&(c[m]=d)}if(o){const d=this._postorderIterator;for(d.reset(this._rootTiles);!d.done;)d.next().modifyLayers(c,l,r);this._layerViews[r]=n,this._restartAllAgents(r),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(t)&&this._viewChangeUpdate()}_restartAllAgents(i){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;){const t=e.next();t.restartAgents(i),i===Te.ELEVATION&&t.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(i,e){return this._layerViews[e][i]}numLayers(i){return this._layerViews[i].length}_updateTileTextures(i){this._allTiles.forAll(e=>{e.updateAgents(Te.MAP),i===ni.IMMEDIATE?this.renderer.updateTileTexture(e,ne.TEXTURE_NOFADING):e.updateRenderData(Te.MAP,i)}),this._evaluateTransparency()}_invalidateLayerData(i,e){this._allTiles.forAll(t=>t.removeLayerAgent(i,e)),this._allTiles.forAll(t=>t.invalidateLayerData(i,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(i=jt.UPDATE){this.renderer.setNeedsRender(i)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(i,e,t,r){const s=this.layerViewByIndex(e,t),n=s.layer;return!n.tilemapCache||qc(s)?this._requestTileData(i,t,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(i.lij[0],i.lij[1],i.lij[2],{...r,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(a=>{throw--this._asyncWorkItems,Tr(r),fo(a)||this._dataMissing(i,t,s,{notInTilemap:!0}),a}).then(()=>this._frameTask.schedule(()=>this._requestTileData(i,t,s,r),r.signal)))}_requestTileData(i,e,t,r){return e===Te.ELEVATION?t0(t)?this._requestElevationTileData(i,t,r):Promise.reject():e0(t)?this._requestMapTileData(i,t,r):Promise.reject()}_requestElevationTileData(i,e,t){++this._asyncWorkItems;const r=a=>{if(Ja(t))return;const o=this._layerIndexByUid[Te.ELEVATION].get(e.uid);o!=null?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(i,o,a)):de.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",Te.ELEVATION,i.lij.toString())},s=a=>{fo(a)||(this._dataMissing(i,Te.ELEVATION,e,a),this.requestUpdate())};if(i0(e.layer))return e.layer.fetchTile(i.lij[0],i.lij[1],i.lij[2],{noDataValue:lh,signal:t.signal}).then(a=>{if(!Ja(t))return this._frameTask.schedule(()=>r(a),t.signal,s);de.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")},s).finally(()=>{--this._asyncWorkItems});const n=e.getTileUrl(i.lij[0],i.lij[1],i.lij[2]);return this._elevationDataRequester.request(n,"binary",t).then(a=>this._lercDecoder.decode(a,{noDataValue:lh},t.signal)).then(a=>{a?r(new cR(a)):s(new Error("LERC decoding failed"))},s).finally(()=>{--this._asyncWorkItems})}_requestMapTileData(i,e,t){++this._asyncWorkItems;const r=(c,d)=>{--this._asyncWorkItems,Pl(d),Ja(t)||(this._dataMissing(i,Te.MAP,e,c),this.requestUpdate())},s=c=>d=>r(d,c),n=c=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Ja(t)?Pl(c):this._mapTileDataArrived(i,e,c)},t.signal,s(c)).catch(s(c)),a=(c,d=null)=>this._frameTask.schedule(()=>r(c,d));if(qc(e)){const c=e.schemaHelper.getLevelRowColumn(i.lij);return e.fetchTile(c[0],c[1],c[2],t).then(n,a)}if(F3(e))return e.fetchTile(i.lij[0],i.lij[1],i.lij[2],t).then(n,a);if(V3(e)&&i0(e.layer))return e.layer.fetchTile(i.lij[0],i.lij[1],i.lij[2],t).then(c=>{if(Ja(t))return de.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(Ts());n(c)},a);let o=e.getTileUrl(i.lij[0],i.lij[1],i.lij[2]);YC(e.layer)&&e.layer.refreshTimestamp&&(o+=`${o.includes("?")?"&":"?"}_ts=${e.layer.refreshTimestamp}`);const l=e.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,l,t).then(n,a)}_mapTileDataArrived(i,e,t){const r=this._getLayerIdxByUID(Te.MAP,e.uid);r!=null?i.dataArrived(r,Te.MAP,t):(Pl(t),de.getLogger(this).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(i,e){return this._layerIndexByUid[i].get(e)}_dataMissing(i,e,t,r){const s=this._getLayerIdxByUID(e,t.uid);s!=null?i.dataMissing(s,e,r):de.getLogger(this).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(i){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(e=>{e.renderData&&this.overlayManager.setTileParameters(e)}),this._renderer.setNeedsRender(i))}get performanceInfo(){const i=this._performanceInfo;return i.numNodes=this._allTiles.length,i.numLeaves=i.numVisible=i.numRendered=i.numLoadedPerLevel.length=i.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.isLeaf&&i.numLeaves++;const t=e.level;e.renderData&&(i.numLoadedPerLevel[t]=(i.numLoadedPerLevel[t]||0)+1),e.visible&&(i.numVisible++,e.rendered&&(i.numRenderedPerLevel[t]=(i.numRenderedPerLevel[t]||0)+1,i.numRendered++))}),i}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((i,e)=>i+e.usedMemory,0)):null}getUsedMemoryForLayerView(i){let e=0;const t=this._layerClassFromLayerView(i),r=this._getLayerIdxByUID(t,i.uid);return r!=null&&this._allTiles.forAll(s=>e+=s.getUsedMemoryForLayer(t,r)),e}getTile(i){if(i==null||this._rootTiles==null)return null;const e=i.split("/").map(a=>+a);if(e[0]===0)return this._rootTiles.find(a=>a.lij[1]===e[1]&&a.lij[2]===e[2]);const t=e[0],r=e[1]>>t,s=e[2]>>t;let n;if(this._rootTiles.some(a=>a.lij[1]===r&&a.lij[2]===s&&(n=a,!0)),n){let a=1<<e[0]-1;for(;n.lij[0]<e[0];){let o=e[1]&a?2:0;if((e[2]&a)>0&&o++,!n.children[o])return null;n=n.children[o],a>>=1}return Jt(n.lij[0]===e[0]&&n.lij[1]===e[1]&&n.lij[2]===e[2],"not the right tile?"),n}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(i){this._renderer.renderPatchBorders=i}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(i){this._renderer.visualizeNormals=i}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(i){this._renderer.renderingDisabled=i}get test(){const i=this;return{renderer:i._renderer,lercDecoder:i._lercDecoder,forceReload:()=>{i._rootTiles!=null&&i._rootTiles.length>0&&(i._mergeTile(i._rootTiles[0]),i._viewChangeUpdate())},getTiles:()=>i._allTiles.toArray(),getRenderedTiles(){ym.clear(),i._allTiles.forAll(t=>{t.visible&&t.rendered&&ym.push(t)});const e=ym.toArray();return uw(i.renderOrder,e),e},lockTilingScheme(e,t){i._extentHelper.defaultTiledLayersExtent=t,i.tilingSchemeLogic.test.lockTilingScheme(e)}}}checkAllTilesWaterproofness(){if(!km)return;const i=this._rootTiles;if(i==null)return;const e=n=>{var a,o,l;return((l=(o=(a=n==null?void 0:n.renderData)==null?void 0:a.geometry)==null?void 0:o.indices)==null?void 0:l.length)>0},t=(n,a)=>{e(n)&&console.error("Tile[",n.lij,"] has geometry although parent[",a.lij,"] has geom")},r=n=>{var a,o;if(n.intersectsClippingArea)if(n.renderData&&!n.renderData.geometryState&&console.error("Tile[",n.lij,"] has renderData but not geometryState"),n.renderData&&!n.renderData.geometry&&console.error("Tile[",n.lij,"] has renderData but not geometryInfo"),!((a=n.renderData)!=null&&a.geometry)||(((o=n.renderData.geometry.indices)==null?void 0:o.length)??0)>0||console.error("Tile[",n.lij,"] has renderData but no indices - geometryInfo: ",n.renderData.geometry),e(n)){n.checkGeometryWaterproofness();for(const l of n.children)t(l,n)}else if(n.isLeaf)console.error("Tile[",n.lij,"] has no geometry and no children, from root to leaf");else for(const l of n.children)r(l)},s=n=>{var c;const a=((c=n.parent)==null?void 0:c.visible)??!0,o=n.visible;n.computeVisibility();const l=n.visible;if(o!==l&&a&&console.error(" Tile[",n.lij,"] has out of date visibility: ",o," instead of ",l),!n.isLeaf)for(const d of n.children)s(d)};for(const n of i)r(n),s(n)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(i){return this._isGlobal&&i[2]===this.lijEastEnd(i[0])-1}isWestEndWrap(i){return this._isGlobal&&i[2]===0}lijEastEnd(i){return 1<<i+(this._isGeographic?1:0)}wrapEastWest(i){const e=this.lijEastEnd(i[0]),t=i[2];if(0<=t&&t<e)return i;if(!this._isGlobal)return null;const r=(t+(t<0?e:0))%e;return[i[0],i[1],r]}enableInternalChecks(i){U3(i)}enableWaterproofnessChecks(i){z3(i)}};Se._tileMemcacheKey="TerrainTileMemcache",h([p()],Se.prototype,"_renderer",void 0),h([p({constructOnly:!0})],Se.prototype,"_scaleRangeQueries",void 0),h([p({constructOnly:!0})],Se.prototype,"view",void 0),h([p({constructOnly:!0})],Se.prototype,"overlayManager",void 0),h([p()],Se.prototype,"_hasPendingUpdates",void 0),h([p()],Se.prototype,"_asyncWorkItems",void 0),h([p()],Se.prototype,"_allTilesDirty",void 0),h([p()],Se.prototype,"_allTilesSorted",void 0),h([p()],Se.prototype,"_viewChanged",void 0),h([p()],Se.prototype,"_splitLimits",void 0),h([p({readOnly:!0})],Se.prototype,"_watchUpdatingTracking",void 0),h([p()],Se.prototype,"_frameTask",void 0),h([p({readOnly:!0})],Se.prototype,"snapLevel",null),h([p({readOnly:!0})],Se.prototype,"lodSnapping",null),h([p()],Se.prototype,"_userClippingExtent",null),h([p()],Se.prototype,"_rootTilesExtent",void 0),h([p({readOnly:!0})],Se.prototype,"extent",null),h([p({readOnly:!0})],Se.prototype,"groundExtent",null),h([p({readOnly:!0})],Se.prototype,"_tilingSchemeExtent",null),h([p({readOnly:!0})],Se.prototype,"updating",null),h([p({readOnly:!0})],Se.prototype,"running",null),h([p(LM)],Se.prototype,"updatingProgress",void 0),h([p({readOnly:!0})],Se.prototype,"updatingProgressValue",null),h([p()],Se.prototype,"_maxNumUpdating",void 0),h([p()],Se.prototype,"baseOpacity",null),h([p()],Se.prototype,"hasCompositeBlendMode",void 0),h([p({readOnly:!0})],Se.prototype,"viewingMode",null),h([p()],Se.prototype,"maxTextureScale",void 0),h([p({readOnly:!0})],Se.prototype,"ready",null),h([p({value:Ul.FRONT_TO_BACK})],Se.prototype,"renderOrder",null),h([p({readOnly:!0})],Se.prototype,"rootTiles",null),h([p()],Se.prototype,"_rootTiles",void 0),h([p({readOnly:!0})],Se.prototype,"spatialReference",null),h([p({type:ho})],Se.prototype,"backgroundColor",null),h([p({value:!1})],Se.prototype,"slicePlaneEnabled",null),h([p({readOnly:!0})],Se.prototype,"tilingScheme",void 0),h([p({readOnly:!0})],Se.prototype,"tilingSchemeLocked",null),h([p({readOnly:!0})],Se.prototype,"tilingSchemeLogic",void 0),h([p()],Se.prototype,"wireframe",null),h([p({value:!1})],Se.prototype,"suspended",null),h([p()],Se.prototype,"fadeDuration",null),h([p()],Se.prototype,"visibleElevationBounds",void 0),h([p()],Se.prototype,"rootTileElevationBounds",void 0),h([p()],Se.prototype,"_layerViewsDirty",void 0),h([p()],Se.prototype,"renderPatchBorders",null),h([p()],Se.prototype,"visualizeNormals",null),h([p()],Se.prototype,"renderingDisabled",null),Se=eu=h([F("esri.views.3d.terrain.TerrainSurface")],Se);const $D=Se,_c=v(),Xo=Ds(),LD=ci(),ym=new xt,vm=new NT("ground"),Sd={spatialReference:null,extent:null,scale:0};function Sy(i,e,t){var r;for(const s of i){if(!s.containsPointXY(e,t))continue;let n=s;for(;n&&!n.renderData;){const o=(e>n.extentMidX?1:0)+(t<n.extentMidY?2:0);n=n.children[o]}const a=((r=n==null?void 0:n.renderData)==null?void 0:r.geometryState.samplerData)??null;return Tt(e,t,a)}return null}class ID{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(t===0)return;const r=this._tail;if(!(r+t<=this.capacity))throw new Error("Queue full");for(let s=0;s<t;++s)this._data[r+s]=e[s];this._tail=r+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function bm(i,e){!i.isLeaf||i.level<ei||rf(i,t=>{e&&e2(t);const r=I_(t);if(t.maxLevelDeltaNeighborCount++,r){let s=t.parent;for(;s;){const n=I_(s);if(s.unmergableChildCount++,!n)break;s=s.parent}}})}function e2(i){if(i.hasPendingUpdate(ne.SPLIT))return;let e=i.parent;for(;e&&e.resetPendingUpdate(ne.MERGE);)e=e.parent;i.resetPendingUpdate(ne.MERGE),i.isLeaf&&i.setPendingUpdate(ne.SPLIT),i.level<ei||rf(i,t=>{e2(t)})}function Ry(i){i.level<ei||rf(i,e=>{if(e.maxLevelDeltaNeighborCount--,e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0){let t=e.parent;for(;t&&(t.unmergableChildCount--,I_(t));)t=t.parent}})}function I_(i){return i.maxLevelDeltaNeighborCount===0&&i.unmergableChildCount===0}function rf(i,e){if(i.level<ei)return;const t=i.level-ei,r=i.lij[1]>>ei,s=i.lij[2]>>ei,n=a=>a.isLeaf||a.level===t;for(let a=0;a<4;++a){const o=i.findNeighborTile(Ps[a],n);if(!o||o.level!==t)continue;const l=o.lij;l[1]===r&&l[2]===s||e(o)}}let ND=class{constructor(e,t,r,s){this.operation=e,this.geometry=t,this.states=r,this.sync=s}},$c=class extends Pe{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach((s,n)=>{const a=this._ensureGeomRecord(e,n);s.forEach(({geometry:o,operation:l,states:c},d)=>{let u=!1;if(l===Qt.UPDATE){const m=a.get(d);if(m){if(c&fn.TRANSFORMATION){const _=this.model.getObject(n);this.model.updateRenderGeometryTransformation(_,o,m)&&(u=!0)}u||t.updates.push({renderGeometry:m,updateType:c})}else Js(!1,"ModelDirtySet.commitLayer: invalid update")}if(l===Qt.REMOVE||u){const m=a.get(d);m?(t.removes.push(m),a.delete(d)):l===Qt.REMOVE&&Js(!1,"ModelDirtySet.commitLayer: invalid remove")}if(l===Qt.ADD||u){const m=this.model.getObject(n);if(m!=null){const _=this.model.getRenderGeometry(m,o);t.adds.push(_),a.set(d,_)}}}),a.size===0&&this._residentGeomRecords.get(e).delete(n)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}commitSyncUpdates(e,t){const r=this._dirtyGeomRecords.get(e);r&&r.forEach((s,n)=>{const a=this._ensureGeomRecord(e,n);s.forEach(({geometry:o,operation:l,states:c,sync:d},u)=>{let m=!1;if(l===Qt.UPDATE&&d){const _=a.get(u);if(_){if(c&fn.TRANSFORMATION){const f=this.model.getObject(n);this.model.updateRenderGeometryTransformation(f,o,_)&&(m=!0)}m||t.updates.push({renderGeometry:_,updateType:c})}else Js(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}getResidentRenderGeometries(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach(s=>s.forEach(n=>t.push(n)))}_objectStateChanged(e,t){for(const r of t.geometries)this._updateOrCreateDirtyRecord(t,r,null,Qt.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(fn.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(fn.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(fn.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:r}){this._updateOrCreateDirtyRecord(e,t,null,Qt.UPDATE,fn.GEOMETRY,r)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const r=e.id;for(const s of t.geometries)this._geometryAdded(t,s,r)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const r=e.id;for(const s of t.geometries)this._geometryRemoved(t,s,r)}transformationChanged(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach(s=>{this._updateOrCreateDirtyRecord(e,s.geometry,t,Qt.UPDATE,fn.TRANSFORMATION)})}shaderTransformationChanged(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach(s=>{s.objectShaderTransformationChanged(e.shaderTransformation)})}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,Qt.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,Qt.REMOVE)}_updateOrCreateDirtyRecord(e,t,r,s,n=fn.NONE,a=!1){r=r??this._getParentLayerId(e);const o=e.id,l=t.id,c=this._ensureDirtyRecord(r,o),d=c.get(l);if(d){const u=d.operation;u===Qt.REMOVE&&s===Qt.ADD&&d.states!==fn.NONE?d.operation=Qt.UPDATE:u===Qt.REMOVE&&s===Qt.ADD||u===Qt.ADD&&s===Qt.REMOVE?c.delete(l):u!==Qt.UPDATE||s!==Qt.REMOVE&&s!==Qt.UPDATE?(Js((u===Qt.REMOVE||u===Qt.ADD)&&s===Qt.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),d.states|=n):(d.operation=s,d.states|=n),d.sync=d.sync||a}else c.set(l,new ND(s,t,n,a));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let s=r.get(t);return s||(s=new Map,r.set(t,s)),s}get _hasDirtyGeometryRecords(){return uu(this._dirtyGeomRecords,e=>uu(e,t=>t&&t.size>0))}_ensureDirtyRecord(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let s=r.get(t);return s||(s=new Map,r.set(t,s)),s}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:KC}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((r,s)=>{r.forEach((n,a)=>{t.length>0&&(t+=`
`),t+=s+"."+a;const o=[];n.forEach(l=>{const c=l.operation;o[c]||(o[c]=[]),o[c].push(l.geometry.id)});for(let l=0;l<o.length;l++)if(o[l]){t+=" "+e[l-1]+": ";for(let c=0;c<o[l].length;c++)t+=o[l][c]+", "}})}),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((t,r)=>t+r.size,0)},commit:t=>e._dirtyGeomRecords.forEach((r,s)=>e.commitLayer(s,t))}}};h([p({constructOnly:!0})],$c.prototype,"model",void 0),h([p()],$c.prototype,"dirty",void 0),$c=h([F("esri.views.3d.webgl-engine.lib.ModelDirtySet")],$c);const FD=$c;let tu=class extends Pe{constructor(){super(...arguments),this.dirtySet=new FD({model:this}),this._content=new Map,this._originFactory=new Cb(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;Js(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),bu(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),bu(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&(Js(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&(Js(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(r=>{r.type===e&&t(r)})}getRenderGeometry(e,t){const r=new IP(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});r.transformation=e.getCombinedStaticTransformation(t,Oy);const{localOrigin:s}=t;return r.localOrigin=s??this._originFactory.getOrigin(At(r.boundingSphere)),r}updateRenderGeometryTransformation(e,t,r){if(e==null)return!1;r.transformation=e.getCombinedStaticTransformation(t,Oy);const s=this._originFactory.getOrigin(At(r.boundingSphere));return r.localOrigin!==s}getStats(){const e={},t=Array.from(this._content.values());for(let r=0;r<zb.COUNT;++r)e[r]=t.filter(s=>s.type===r).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};h([p({constructOnly:!0})],tu.prototype,"dirtySet",void 0),tu=h([F("esri.views.3d.webgl-engine.parts.Model")],tu);const Oy=ct();let VD=class{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let r=0,s=t.length/2;if(e<t[2*r]||e>t[2*s]+t[2*s+1])return!1;for(;s-r>0;){const n=Math.floor(.5*(r+s)),a=t[2*n];if(e<a){if(s-r==1)return!1;s=n;continue}if(e<a+t[2*n+1])return!0;if(s-r==1)return!1;r=n+1}return!1}}get componentCount(){if(this._componentCountCache===-1){const e=this._indexRanges;let t=0;for(let r=0;r<e.length;r+=2)t+=e[r+1];this._componentCountCache=t}return this._componentCountCache}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=UD(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const s=t[r],n=s+t[r+1];for(let a=s;a<n;a++)if(!e(a))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const s=t[r];if(!e(s,s+t[r+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),r=this._indexRanges;for(let s=0;s<r.length;s+=2){const n=r[s],a=n+r[s+1],o=e[n],l=e[a];t[s]=o,t[s+1]=l-o}return t}};function UD(i){const e=new Array;if(i.length===0)return e;let t=i[0],r=1;for(let s=1;s<i.length;s++){const n=i[s];t+r===n?r+=1:(e.push(t),e.push(r),t=n,r=1)}return e.push(t),e.push(r),e}let zD=class{constructor(e,t){this.offsets=t,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;const r=this.count;this.visibility=new VD(r),this.materialDataBuffer=e.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let s=0;s<r;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this.cachedGeometryRanges==null&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return this.highlightCounts==null?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return this.highlightCounts==null?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((this.cachedHighlightRanges==null||this.cachedDefaultRanges==null)&&this.highlightCounts!=null){const{highlightRanges:e,defaultRanges:t}=qD(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}};function qD(i,e,t){const r=[],s=[];let n=t.length,a=t.length;return e.forEachComponent(o=>(i[o]>0?(n!==o-1&&(r.length&&r.push(t[n+1]-r[r.length-1]),r.push(t[o])),n=o):(a!==o-1&&(s.length&&s.push(t[a+1]-s[s.length-1]),s.push(t[o])),a=o),!0)),r.length&&r.push(t[n+1]-r[r.length-1]),s.length&&s.push(t[a+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}let BD=class{constructor(e,t,r,s,n,a){this.transform=e,this.toMapSpace=t,this.obb=r,this.components=s,this.renderable=n,this.intersectionGeometry=a,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=te(this.intersectionGeometry),this.renderable=te(this.renderable),this.components=te(this.components)}};function HD(i,e,t,r){if(t>=e)return i;i==null&&(i=GD());const s=i.isVisibleBit;let n=i.data;const a=t2(n),o=t/a|0,l=t-a*o,c=(e-1)/a|0,d=n,u=r===s;if(!(t<d.length*a)&&u){const m=o+1,_=Math.ceil(d.length*JC),f=c+1;let y=Math.max(m,_);y=Math.min(y,f),n=new Uint32Array(y),n.set(d)}return o<n.length&&(n[o]=jD(n[o],l,u)),i.data=n,i}function N_(i,e){if(i==null)return!0;const{isVisibleBit:t,data:r}=i,s=t2(r);return e<r.length*s?kD(t,r,e,s):!i.isVisibleBit}function GD(i=!0){return{isVisibleBit:!i,data:new Uint32Array(0)}}function kD(i,e,t,r){const s=t/r|0,n=t-s*r;return WD(e[s],n)===i}function t2(i){return i.BYTES_PER_ELEMENT*8}function jD(i,e,t){return i&~(1<<e)|(t?1:0)<<e}function WD(i,e){return(i&1<<e)!=0}let QD=class{constructor(e,t,r){this.viewingMode=e,this.positionData=t,this._components=r,this._planetCenter=v(),this._planetNorth=v(),this._componentIndicesForBsp=null,this._componentBspNodes=[],this._aabb=[0,0,0,0,0,0],this._indices=t.indices?qb(t.indices):SR(t.positions.length/3),this._positions=t.positions,this._componentIntersectionData=new Array(r.count)}destroy(){this._positions=null,this._indices=null,this._componentIntersectionData.length=0,this._perComponentAabbs=null}getComponentAabb(e,t){const r=this._ensureComponentAabbs(),s=6*e;return t[0]=r[s],t[1]=r[s+1],t[2]=r[s+2],t[3]=r[s+3],t[4]=r[s+4],t[5]=r[s+5],t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,r,s,n,a,o,l){const{position:c}=o,d=zt(YD,e,c),u=zt(KD,t,c),m=Ah(JD,o.rotationScale);Qs(d,d,m),Qs(u,u,m);const _=kl(e8,m),f=new Ub(this._positions,3),y=this._indices,b=this._components.offsets,x=wP(d,u,ZD);if(this.viewingMode===Re.Global){const S=this._planetCenter;rn(S,c),Qs(S,S,m);const R=this._planetNorth;Ie(R,0,0,1),Qs(R,R,m),oe(R,R)}const w=le(t8,d),C=le(i8,u),T=zt(r8,u,d);oe(T,T);const P=S=>{const R=this.getComponentAabb(S,XD);if(n!=null){const J=n[S];s==null||l?(d[2]=w[2]-J,u[2]=C[2]-J):s.componentOffset=J}if(s==null||l||s.applyToAabb(R),!CP(R,d,x,r))return;const V=b[S]/3,z=b[S+1]/3,K=(J,X,me)=>a(S,J,Qs(X,X,_),me);(s==null||l)&&z-V>Kw?(this._componentIntersectionData[S]==null&&(this._componentIntersectionData[S]=new tf(this._indices,V,z,f)),this._componentIntersectionData[S].intersectRay(d,u,K)):fb(d,u,V,z,y,f,void 0,s,K)};this._intersectComponents(P,l,d,u)}_intersectComponents(e,t,r,s){const n=this._components.pickability,a=this._components.visibility;if(this._components.visibility.componentCount<c8){const d=u=>(N_(n,u)&&e(u),!0);return void a.forEachComponent(d)}this._componentBspNodes.length===0&&this._generateComponentBspRoot();const o=this._componentIndicesForBsp,l=d=>{N_(n,d)&&a.isVisible(d)&&e(d)},c=(d,u)=>{for(let m=d;m<u;++m)l(o[m])};if(t){let d=0;for(;d>=0;){const u=this._componentBspNodes[d],m=u.plane;if(!m||u.child0===-1&&u.child1===-1){c(u.minComponentIndexIndex,u.maxComponentIndexIndex);break}{c(u.minMidComponentIndexIndex,u.maxMidComponentIndexIndex);const _=pe(m,r)-m[3];if(_<0){if(u.child0===-1){c(u.minComponentIndexIndex,u.minMidComponentIndexIndex);break}d=u.child0}else{if(!(_>0))break;if(u.child1===-1){c(u.maxMidComponentIndexIndex,u.maxComponentIndexIndex);break}d=u.child1}}}}else{const d=h8;zt(d,s,r),oe(d,d);const u=this._componentBspNodes,m=_=>{const f=u[_],y=f.plane;if(!y||f.child0===-1&&f.child1===-1)c(f.minComponentIndexIndex,f.maxComponentIndexIndex);else{const b=pe(y,r)-y[3],x=pe(y,d);f.minComponentIndexIndex<f.minMidComponentIndexIndex&&(b<=0||x<0)&&(f.child0!==-1?m(f.child0):c(f.minComponentIndexIndex,f.minMidComponentIndexIndex)),c(f.minMidComponentIndexIndex,f.maxMidComponentIndexIndex),f.maxMidComponentIndexIndex<f.maxComponentIndexIndex&&(b>=0||x>0)&&(f.child1!==-1?m(f.child1):c(f.maxMidComponentIndexIndex,f.maxComponentIndexIndex))}};m(0)}}_generateComponentBspRoot(){const e=this._components.count,t=new Uint16Array(e);this._componentIndicesForBsp=t;for(let x=0;x<e;++x)t[x]=x;const r=this._ensureComponentAabbs(),s=this._planetCenter,n=this._planetNorth,a=a8;rn(a,s),oe(a,a),dt(o8,n,a);const o=this._aabb,l=o[2],c=[];let d=0;const u=this._componentBspNodes;u.length=0;const m=(x,w)=>{const C=6*x,T=r[C],P=r[C+1],S=r[C+2],R=r[C+3],V=r[C+4],z=r[C+5],K=Ie(Ay,.5*(T+R),.5*(P+V),.5*(S+z)),J=.5*(R-T),X=.5*(V-P),me=.5*(z-S),D=Math.sqrt(J*J+X*X+me*me),O=w,k=w[3],H=pe(O,K)-k;return Math.abs(H)>D?Math.sign(H):0},_=(x,w,C)=>{let T=1/0,P=1/0,S=1/0,R=-1/0,V=-1/0,z=-1/0;for(let K=w;K<C;++K){const J=6*t[K];T=Math.min(T,r[J]),R=Math.max(R,r[J+3]),P=Math.min(P,r[J+1]),V=Math.max(V,r[J+4]),S=Math.min(S,r[J+2]),z=Math.max(z,r[J+5])}x[0]=T,x[1]=P,x[2]=S,x[3]=R,x[4]=V,x[5]=z},f=this.viewingMode===Re.Local;let y=!1;if(!f){const x=Ie(Ay,.5*(o[0]+o[3]),.5*(o[1]+o[4]),.5*(o[2]+o[5])),w=Tl(s,x);y=l>.5*w}const b=(x,w,C,T,P)=>{const S=u.length;let R;if(y||C>=l8||w-x<xm)R=new Ey(x,w,w,w,null);else{_(Yo,x,w);const V=Yo[0],z=Yo[1],K=Yo[2],J=Yo[3],X=Yo[4],me=J-V,D=X-z,O=_i(),k=O;if(f)me>=D?(Ie(k,1,0,0),O[3]=-.5*(V+J)):(Ie(k,0,1,0),O[3]=-.5*(z+X));else{const G=s8,Q=n8;Ie(G,.5*(V+J),.5*(z+X),K),zt(G,G,s),oe(G,G),dt(Q,G,n),oe(Q,Q),me>=D?le(k,Q):(dt(k,Q,G),oe(k,k)),O[3]=pe(k,s)}let H,M;{let G=x,Q=w;for(;G<Q;){const ce=t[G];m(ce,O)<0?++G:(--Q,t[G]=t[Q],t[Q]=ce)}H=G;let N=G;for(Q=w;N<Q;){const ce=t[Q-1];m(ce,O)>0?--Q:(t[Q-1]=t[N],t[N]=ce,++N)}M=Q}R=new Ey(x,H,M,w,O),H>=x+xm&&c.push(()=>b(x,H,C+1,S,!0)),w>=M+xm&&c.push(()=>b(M,w,C+1,S,!1))}if(u.push(R),T!==-1){const V=u[T];P?V.child0=S:V.child1=S}};for(c.push(()=>b(0,e,0,-1,!1));d<c.length;)(0,c[d])(),++d}_computePerComponentAabbs(){const e=this._components.count,t=rb(6*e),r=this._indices,s=this._positions,n=this._components.offsets;let a=0,o=1/0,l=1/0,c=1/0,d=-1/0,u=-1/0,m=-1/0;for(let _=0;_<e;_++){const f=n[_],y=n[_+1];let b=1/0,x=1/0,w=1/0,C=-1/0,T=-1/0,P=-1/0;for(let S=f;S<y;S++){const R=3*r[S],V=s[R],z=s[R+1],K=s[R+2];b=Math.min(b,V),x=Math.min(x,z),w=Math.min(w,K),C=Math.max(C,V),T=Math.max(T,z),P=Math.max(P,K)}t[a++]=b,t[a++]=x,t[a++]=w,t[a++]=C,t[a++]=T,t[a++]=P,o=Math.min(o,b),l=Math.min(l,x),c=Math.min(c,w),d=Math.max(d,C),u=Math.max(u,T),m=Math.max(m,P)}return this._aabb[0]=o,this._aabb[1]=l,this._aabb[2]=c,this._aabb[3]=d,this._aabb[4]=u,this._aabb[5]=m,t}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}},Ey=class{constructor(e,t,r,s,n){this.minComponentIndexIndex=e,this.minMidComponentIndexIndex=t,this.maxMidComponentIndexIndex=r,this.maxComponentIndexIndex=s,this.plane=n,this.child0=-1,this.child1=-1}};const ZD=v(),XD=Xu(),Yo=[0,0,0,0,0,0],YD=v(),KD=v(),JD=$s(),e8=$s(),t8=v(),i8=v(),r8=v(),s8=v(),n8=v(),a8=v(),o8=v(),Ay=v(),xm=5,l8=10,c8=7,h8=v();let d8=class{constructor(e,t,r){this.material=e,this.geometry=t,this.meta=r}destroy(){this.material.dispose(),this.geometry.dispose()}},u8=class{constructor(e,t,r,s){this.vao=e,this.primitiveType=t,this.parameters=r,this.indexed=s}dispose(){this.vao.dispose()}},sf=class{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}};function p8(i,e){return{near:i,far:e}}function Ih(i){return i?Th(i,1/0,-1/0):p8(1/0,-1/0)}function Th(i,e,t){return i.near=e,i.far=t,i}function zl(i,e){e!=null&&(i.near=Math.min(i.near,e.near),i.far=Math.max(i.far,e.far))}function Rd(i,e){return i.near<=e&&e<=i.far}const F_={near:0,far:0};function m8(i,e){const t=Ih(),{eye:r,frustum:s,viewForward:n}=i;e.forAll(a=>{const o=a.offsetObb!=null?a.offsetObb:a.obb,l=pe(zt(Or,o.center,r),n),c=o.projectedRadius(n);if(Rd(t,l-c)&&Rd(t,l+c))return;const d=v8(o,s);if(d===-1)return;if(d===0)return vn.far=l+c,vn.near=l-c,void zl(t,vn);const u=Od.pushNew();u.near=l-c,u.far=l+c,u.mask=d,u.object=a});for(let a=0;a<Od.length;a++){const o=Od.data[a];if(Rd(t,o.near)&&Rd(t,o.far))continue;vn.far=o.far,vn.near=1/0,y8(o.object.offsetObb!=null?o.object.offsetObb:o.object.obb,r,_8,c=>{let d=g8;for(let u=0;u<i2&&c.length>0;u++){if(!(o.mask&1<<u))continue;f8(s[u],c,d);const m=c;c=d,d=m}for(let u=0;u<c.length;u+=3){Ie(nr,c.data[u],c.data[u+1],c.data[u+2]);const m=pe(zt(nr,nr,r),n);vn.near=Math.min(vn.near,m)}})===0&&(vn.near=0),zl(t,vn)}return Od.length=0,t}const Od=new xt({allocator:i=>i||{near:1/0,far:-1/0,mask:0,object:null},deallocator:i=>(i.object=null,i)}),vn=Ih(),nr=v(),Ha=v(),_8=new xt({deallocator:null}),g8=new xt({deallocator:null});function f8(i,e,t){t.length=0;const r=e.length-3;wm(nr,e,r);const s=Fl(i,nr);s<=0&&(t.push(nr[0]),t.push(nr[1]),t.push(nr[2]));let n=0,a=s;for(;n<r;n+=3){wm(Ha,e,n);const o=Fl(i,Ha);a*o<0&&(As(nr,Ha,nr,o/(o-a)),ar(t,nr)),o<=0&&ar(t,Ha),a=o,le(nr,Ha)}a*s<0&&(wm(Ha,e,r),As(nr,Ha,nr,s/(s-a)),ar(t,nr))}function wm(i,e,t){return Ie(i,e.data[t],e.data[t+1],e.data[t+2])}function ar(i,e){i.push(e[0]),i.push(e[1]),i.push(e[2])}function y8(i,e,t,r){yS(Dy,i.quaternion),zt(Or,e,i.center),eT(Or,Or,Dy);const s=i.halfSize,n=8*((Or[0]<-s[0]?-1:Or[0]>s[0]?1:0)+3*(Or[1]<-s[1]?-1:Or[1]>s[1]?1:0)+9*(Or[2]<-s[2]?-1:Or[2]>s[2]?1:0)+13),a=My[n];if(a===0)return a;eS(Ed,i.quaternion),tS(Ed,Ed,i.halfSize);const o=(l,c)=>{const d=My[n+c+1];return Ie(l,((1&d)<<1)-1,(2&d)-1,((4&d)>>1)-1),Qs(l,l,Ed),fe(l,i.center,l)};return t.length=0,ar(t,o(Cm,0)),ar(t,o($y,1)),ar(t,o(Or,2)),ar(t,o(Ly,3)),r(t),a===1||(t.length=0,ar(t,Cm),ar(t,Ly),ar(t,o(Or,4)),ar(t,o(Iy,5)),r(t),a===2||(t.length=0,ar(t,Cm),ar(t,Iy),ar(t,o(Or,6)),ar(t,$y),r(t))),a}const My=(()=>{const i=new Array(216);let e=0;const t=r=>{for(let s=0;s<r.length;s++)i[e+s]=r[s];e+=8};return t([3,0,6,2,3,1,5,4]),t([2,0,2,3,1,5,4,0]),t([3,1,0,2,3,7,5,4]),t([2,0,1,3,2,6,4,0]),t([1,0,1,3,2,0,0,0]),t([2,1,5,7,3,2,0,0]),t([3,2,0,1,3,7,6,4]),t([2,2,0,1,3,7,6,0]),t([3,3,0,1,5,7,6,2]),t([2,0,1,5,4,6,2,0]),t([1,0,1,5,4,0,0,0]),t([2,1,3,7,5,4,0,0]),t([1,0,2,6,4,0,0,0]),t([0,0,0,0,0,0,0,0]),t([1,1,3,7,5,0,0,0]),t([2,2,3,7,6,4,0,0]),t([1,2,3,7,6,0,0,0]),t([2,3,1,5,7,6,2,0]),t([3,4,0,1,5,7,6,2]),t([2,5,7,6,4,0,1,0]),t([3,5,0,1,3,7,6,4]),t([2,4,5,7,6,2,0,0]),t([1,4,5,7,6,0,0,0]),t([2,5,1,3,7,6,4,0]),t([3,6,0,2,3,7,5,4]),t([2,6,2,3,7,5,4,0]),t([3,7,6,2,3,1,5,4]),i})(),i2=4;function v8(i,e){let t=0;for(let r=0;r<i2;r++){const s=i.intersectPlane(e[r]);if(s>0)return-1;s===0&&(t|=1<<r)}return t}const Ed=$s(),Dy=vS(),Or=v(),Cm=v(),$y=v(),Ly=v(),Iy=v();let b8=class{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(e,t,r))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?m8(e,this._objects.visibleObjects):null}};function x8(i){const e=Ma().vec3f(ae.POSITION);return i.hasNormals&&e.vec2i16(ae.NORMALCOMPRESSED,{glNormalized:!0}),i.textureCoordinates===Ta.Default?e.vec2f(ae.UV0):i.textureCoordinates===Ta.Atlas&&(e.vec2f(ae.UV0),e.vec4u16(ae.UVREGION,{glNormalized:!0})),i.colors&&e.vec4u8(ae.COLOR,{glNormalized:!0}),e}let w8=class{constructor(){this.externalColor=_i(),this.externalColorMixMode=Ou.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}},C8=class extends Hl{constructor(e,t){super(e,"int",Hb.Draw,(r,s,n)=>r.setUniform1i(e,t(s,n)))}};var nn;(function(i){i[i.Uniform=0]="Uniform",i[i.Varying=1]="Varying",i[i.COUNT=2]="COUNT"})(nn||(nn={}));const nf=429496.7296;function r2(i,e){n_(i/nf*.5+.5,e)}function T8(i,e){switch(e.componentData){case nn.Varying:return P8(i,e);case nn.Uniform:return S8(i,e);case nn.COUNT:return;default:ba(e.componentData)}}function P8(i,e){const{vertex:t,fragment:r}=i;t.include(Ro),t.uniforms.add(new xo("componentColorTex",n=>n.componentParameters.texture.texture)),i.attributes.add(ae.COMPONENTINDEX,"float"),i.varyings.add("vExternalColorMixMode","mediump float"),i.varyings.add("vExternalColor","vec4");const s=e.output===E.ObjectAndLayerIdColor;s&&i.varyings.add("vObjectAndLayerIdColor","vec4"),i.include(US),t.constants.add("elevationScale","float",2*nf),t.constants.add("stride","float",li("enable-feature:objectAndLayerId-rendering")?3:2),t.code.add(g`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),t.code.add(g`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);

    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

   float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);

    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return (rgba2float(encodedElevation) - 0.5) * elevationScale;
  }

  ${s?g`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);

            vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
          }`:g`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),r.code.add(g`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${s?g`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}function S8(i,e){const{vertex:t,fragment:r}=i;t.uniforms.add(new Tb("externalColor",n=>n.componentParameters.externalColor)),r.uniforms.add(new C8("externalColorMixMode",n=>n.componentParameters.externalColorMixMode)),i.varyings.add("vExternalColor","vec4"),t.code.add(g`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`);const s=e.output===E.ObjectAndLayerIdColor;r.code.add(g`
  void readExternalColor(out vec4 color, out int colorMixMode) {
    color = vExternalColor;
    colorMixMode = externalColorMixMode;
  }

  void outputObjectAndLayerIdColor() {
    ${s?g`fragColor = vec4(0,0,0,0);`:""}
 }
`)}var Lr;function R8(i,e){const t=i.vertex;switch(t.code.add(g`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case Lr.None:t.code.add(g`#define vertexDiscardByOpacity(_opacity_) {}`);break;case Lr.Opaque:t.code.add(g`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case Lr.Transparent:t.code.add(g`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case Lr.COUNT:break;default:ba(e.vertexDiscardMode)}}(function(i){i[i.None=0]="None",i[i.Transparent=1]="Transparent",i[i.Opaque=2]="Opaque",i[i.COUNT=3]="COUNT"})(Lr||(Lr={}));var an;function KV(i){return i&&G_(i)?an.Mars:i&&H_(i)?an.Moon:an.Earth}(function(i){i[i.Earth=1]="Earth",i[i.Mars=2]="Mars",i[i.Moon=3]="Moon",i[i.COUNT=4]="COUNT"})(an||(an={}));var Zr;(function(i){i[i.None=0]="None",i[i.NoOverlay=1]="NoOverlay",i[i.ColorOverlay=2]="ColorOverlay",i[i.ColorOverlayWithWater=3]="ColorOverlayWithWater",i[i.COUNT=4]="COUNT"})(Zr||(Zr={}));let Ee=class extends Ls{constructor(){super(...arguments),this.output=E.Color,this.textureCoordinateType=Ta.None,this.componentData=nn.Uniform,this.cullFace=mg.Back,this.vertexDiscardMode=Lr.None,this.doubleSidedMode=ua.WindingOrder,this.alphaDiscardMode=Rl.Opaque,this.integratedMeshMode=Zr.None,this.transparencyPassType=ti.NONE,this.ellipsoidMode=an.Earth,this.pbrMode=Et.Disabled,this.normalType=Dr.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.hasNormalTextureTransform=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1}};h([$({count:E.COUNT})],Ee.prototype,"output",void 0),h([$({count:Ta.COUNT})],Ee.prototype,"textureCoordinateType",void 0),h([$({count:nn.COUNT})],Ee.prototype,"componentData",void 0),h([$({count:mg.COUNT})],Ee.prototype,"cullFace",void 0),h([$({count:Lr.COUNT})],Ee.prototype,"vertexDiscardMode",void 0),h([$({count:ua.COUNT})],Ee.prototype,"doubleSidedMode",void 0),h([$({count:Rl.COUNT})],Ee.prototype,"alphaDiscardMode",void 0),h([$({count:Zr.COUNT})],Ee.prototype,"integratedMeshMode",void 0),h([$({count:ti.COUNT})],Ee.prototype,"transparencyPassType",void 0),h([$({count:an.COUNT})],Ee.prototype,"ellipsoidMode",void 0),h([$({count:Et.COUNT})],Ee.prototype,"pbrMode",void 0),h([$({count:Dr.COUNT})],Ee.prototype,"normalType",void 0),h([$()],Ee.prototype,"spherical",void 0),h([$()],Ee.prototype,"doublePrecisionRequiresObfuscation",void 0),h([$()],Ee.prototype,"hasVertexColors",void 0),h([$()],Ee.prototype,"hasNormals",void 0),h([$()],Ee.prototype,"hasSlicePlane",void 0),h([$()],Ee.prototype,"hasColorTexture",void 0),h([$()],Ee.prototype,"receiveAmbientOcclusion",void 0),h([$()],Ee.prototype,"receiveShadows",void 0),h([$()],Ee.prototype,"blendingEnabled",void 0),h([$()],Ee.prototype,"hasScreenSpaceReflections",void 0),h([$()],Ee.prototype,"hasPolygonOffset",void 0),h([$()],Ee.prototype,"hasMetallicRoughnessTexture",void 0),h([$()],Ee.prototype,"hasEmissionTexture",void 0),h([$()],Ee.prototype,"hasOcclusionTexture",void 0),h([$()],Ee.prototype,"hasNormalTexture",void 0),h([$()],Ee.prototype,"hasOccludees",void 0),h([$()],Ee.prototype,"multipassEnabled",void 0),h([$()],Ee.prototype,"cullAboveGround",void 0),h([$()],Ee.prototype,"hasNormalTextureTransform",void 0),h([$()],Ee.prototype,"hasCloudsReflections",void 0),h([$()],Ee.prototype,"snowCover",void 0),h([$()],Ee.prototype,"objectAndLayerIdColor",void 0),h([$({constValue:!1})],Ee.prototype,"occlusionPass",void 0),h([$({constValue:Hb.Draw})],Ee.prototype,"pbrTextureBindType",void 0),h([$({constValue:!0})],Ee.prototype,"hasSliceHighlight",void 0),h([$({constValue:!1})],Ee.prototype,"hasSliceInVertexProgram",void 0),h([$({constValue:!1})],Ee.prototype,"useCustomDTRExponentForWater",void 0),h([$({constValue:!1})],Ee.prototype,"hasVertexTangents",void 0),h([$({constValue:!0})],Ee.prototype,"supportsTextureAtlas",void 0),h([$({constValue:!1})],Ee.prototype,"highStepCount",void 0),h([$({constValue:!1})],Ee.prototype,"instancedDoublePrecision",void 0),h([$({constValue:!1})],Ee.prototype,"hasModelTransformation",void 0),h([$({constValue:!0})],Ee.prototype,"useFillLights",void 0),h([$({constValue:!1})],Ee.prototype,"objectAndLayerIdColorInstanced",void 0);function Ny(i,e){i.include(jb,e),i.fragment.include(zS);const t=i.fragment;t.uniforms.add(new Tb("baseColor",r=>r.baseColor)),t.uniforms.add(new Sl("objectOpacity",r=>r.objectOpacity)),e.hasVertexColors?t.code.add(g`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):t.code.add(g`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),t.code.add(g`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function Fy(i,e){const t=i.fragment;switch(e.doubleSidedMode){case ua.None:t.code.add(g`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case ua.View:i.include(Id,e),t.code.add(g`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case ua.WindingOrder:t.code.add(g`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:ba(e.doubleSidedMode);case ua.COUNT:}switch(e.normalType){case Dr.Attribute:case Dr.Compressed:i.include(db,e),t.code.add(g`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Dr.ScreenDerivative:i.include(Id,e),t.code.add(g`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Dr.Ground:e.spherical?(i.include(Id,e),t.code.add(g`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):t.code.add(g`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),t.code.add(g`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:ba(e.normalType);case Dr.COUNT:}}function O8(i,e){const t=i.fragment;if(e.hasColorTexture&&(e.output===E.Color||e.alphaDiscardMode!==Rl.Opaque)){i.include(nP,e);const r=e.textureCoordinateType===Ta.Atlas;t.uniforms.add(new xo("baseColorTexture",s=>s.texture)),r?(i.include(aP),t.code.add(g`vec4 readBaseColorTexture() {
return textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);
}`)):t.code.add(g`vec4 readBaseColorTexture() {
return texture(baseColorTexture, vuv0);
}`)}else t.code.add(g`vec4 readBaseColorTexture() { return vec4(1.0); }`)}function s2(i){const e=new Mt;e.include(Id,i),e.include(db,i),e.include(jb,i),e.include(ep,i),e.include(lb,i),e.include(T8,i),e.include(qS,i),e.include(oP,i),e.include(O8,i),e.include(R8,i);const{vertex:t,fragment:r}=e;i.pbrMode!==Et.Normal&&i.pbrMode!==Et.Schematic||(e.include(lP,i),i.hasNormalTexture&&e.include(BS,i));const s=i.output===E.Shadow||i.output===E.ShadowHighlight||i.output===E.ShadowExcludeHighlight;s&&i.componentData===nn.Varying?t.code.add(g`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):t.code.add(g`#define discardShadows(castShadows) {}`);const n=i.integratedMeshMode===Zr.ColorOverlay||i.integratedMeshMode===Zr.ColorOverlayWithWater,a=n&&i.output===E.Color&&i.pbrMode===Et.WaterOnIntegratedMesh;return n&&(e.include(Pu,i),e.include(NP,i),i.spherical?t.code.add(g`
      const float invEllipsoidRadius = ${g.float(1/(i.ellipsoidMode===an.Earth?js.radius:i.ellipsoidMode===an.Mars?tT.radius:iT.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.code.add(g`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),a&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3")),t.code.add(g`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${i.output===E.ObjectAndLayerIdColor?g`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${g.float(cP)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${i.output===E.ObjectAndLayerIdColor?g`forwardObjectAndLayerIdColor();`:""}
      ${a?i.spherical?g`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:g`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${n?g`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),i.output===E.Alpha&&(r.include(bo),e.include(Ym,i),e.include(Ny,i),n&&r.uniforms.add(new Be("ovColorTex",(o,l)=>p0(o,l))),r.code.add(g`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${i.multipassEnabled?g`terrainDepthTest(vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?g`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        fragColor = vec4(materialColor.a);
      }
    `)),i.output===E.Color&&(r.include(bo),e.include(Ym,i),e.include(Ny,i),e.include(Fy,i),e.include(Pu,i),i.receiveShadows?(e.include(pg,i),r.code.add(g`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):r.code.add(g`float evaluateShadow() { return 0.0; }`),n&&r.uniforms.add(new Be("ovColorTex",(o,l)=>p0(o,l))),r.code.add(g`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${i.multipassEnabled?g`terrainDepthTest(vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?g`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),i.pbrMode===Et.Normal||i.pbrMode===Et.Schematic||i.pbrMode===Et.Simplified?(hb(r),r.code.add(g`
        ${i.pbrMode===Et.Normal?g`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),i.hasNormalTexture?r.code.add(g`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):r.code.add(g`vec3 shadingNormal = normalVertex;`),r.code.add(g`${i.spherical?g`vec3 normalGround = normalize(positionWorld());`:g`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),r.code.add(g`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        ${i.pbrMode===Et.Simplified?g` float ssao = 1.0 - evaluateAmbientOcclusionInverse();`:g` float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();`}
        ${i.snowCover?g`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                ssao = mix(ssao, 0.5 * ssao, snow);
                shadingNormal = mix(shadingNormal, surfaceNormal, snow);`:""}

        ${n?g` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        ${i.pbrMode===Et.Simplified?g` vec4 shadedColor = vec4(evaluatePBRSimplifiedLighting(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround), materialColor.a);`:"vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);"}
        `)):(i.receiveShadows?r.code.add(g`float shadow = evaluateShadow();`):i.spherical?($b(r),r.code.add(g`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):r.code.add(g`float shadow = 0.0;`),a&&r.uniforms.add(new Be("ovNormalTex",(o,l)=>{var c;return(c=l.overlay)==null?void 0:c.getTexture(vs.WaterNormal)})),i.snowCover&&r.code.add(g`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`),r.code.add(g`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${n?g` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${a?g`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),r.code.add(g`
        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${i.transparencyPassType===ti.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `)),(i.output===E.LinearDepth||s)&&(e.include(Xm,i),r.code.add(g`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),i.output===E.Normal&&(e.include(Fy,i),r.code.add(g`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material to influence ambient occlusion,
        // see the ssao fragment shader
        float alpha = ${i.normalType===Dr.Ground?"0.0":"1.0"};
        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),i.output===E.ObjectAndLayerIdColor&&e.fragment.code.add(g`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?g`fragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),i.output===E.Highlight&&(e.include(kb),r.code.add(g`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?g`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  fragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),e}const E8=Object.freeze(Object.defineProperty({__proto__:null,build:s2},Symbol.toStringTag,{value:"Module"}));let n2=class a2 extends Ft{initializeConfiguration(e,t){t.spherical=e.viewingMode===Re.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Dt(e.rctx,a2.shader.get().build(this.configuration),o2)}_setPipelineState(e){const t=this.configuration,r=t.integratedMeshMode!==Zr.None,s=e===ti.NONE,n=e===ti.FrontFace;return nt({blending:t.output!==E.Color&&t.output!==E.Alpha||!t.blendingEnabled?null:s?wb:TP(e),culling:PP(t.cullFace),depthTest:{func:SP(e)},depthWrite:s||n?xb:null,colorWrite:lt,stencilWrite:r||t.hasOccludees?hP:null,stencilTest:r?dP(Gc.IntegratedMeshMaskExcluded):t.hasOccludees?uP:null,polygonOffset:s||n?t.hasPolygonOffset?{factor:2,units:2}:null:RP})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};n2.shader=new Nt(E8,()=>he(()=>Promise.resolve().then(()=>Q$),void 0));const o2=new Map([[ae.POSITION,0],[ae.NORMAL,1],[ae.NORMALCOMPRESSED,1],[ae.COLOR,2],[ae.UV0,3],[ae.UVREGION,4],[ae.COMPONENTINDEX,5]]);let A8=class extends di{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},af=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function Ot(i={}){return(e,t)=>{const r=e._parameterCount??0;if(e._parameterCount=r+1,i.vectorOps){const s=i.vectorOps;Object.defineProperty(e,t,{get(){return this[r]},set(n){const a=this[r];if(a==null)this[r]=n;else{if(s.equals(a,n))return;s.copy(a,n)}this._setDirty()}})}else Object.defineProperty(e,t,{get(){return this[r]},set(s){this[r]!==s&&(i.dispose&&this[r]&&this[r].dispose(),this[r]=s,this._setDirty())}})}}function Vy(){return(i,e)=>{const t=i._parameterCount??0;i._parameterCount=t+1,i._parameterBlocks=i._parameterBlocks||[],i._parameterBlocks.push(t),Object.defineProperty(i,e,{get(){return this[t]},set(r){this[t]!==r&&(this[t]=r,this._setDirty())}})}}let dp=class{constructor(e){this._low=v(),this._high=v(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){le(this._low,le(Uy,e));const t=zt(Uy,e,this._low);le(this._high,t)}get(e){return fe(e,this._low,this._high)}getLowScaled(e){return re(e,this._low,1)}};const Uy=rS();let mi=class extends A8{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=Jr(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Mv(HS),this.emissiveFactor=It(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new iu,this.componentParameters=new Jc,this.textureAlphaCutoff=pP,this.alphaDiscardMode=Rl.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=an.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new Ee;const r=new dp(e.position),s=mS(e.rotationScale);Ah(s,s),kl(s,s),this.transformNormalGlobalFromModel=s,this.transformWorldFromModelTL=r.low,this.transformWorldFromModelTH=r.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=tt(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return this.baseColorTexture!=null?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return this.metallicRoughnessTexture!=null?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return this.emissionTexture!=null?this.emissionTexture.glTexture:null}get textureOcclusion(){return this.occlusionTexture!=null?this.occlusionTexture.glTexture:null}get textureNormal(){return this.normalTexture!=null?this.normalTexture.glTexture:null}prepareTechnique(e,t,r,s){const n=this._techniqueConfiguration;n.hasVertexColors=s.colors,n.hasNormals=s.hasNormals,n.textureCoordinateType=s.textureCoordinates,n.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,n.hasEmissionTexture=this.emissionTexture!=null,n.hasOcclusionTexture=this.occlusionTexture!=null,n.hasNormalTexture=this.normalTexture!=null,n.transparencyPassType=t.identifier===il.Material&&r.transparencyPassType!=null?r.transparencyPassType:ti.NONE,n.multipassEnabled=t.identifier===il.Material&&r.multipassEnabled,n.cullAboveGround=t.identifier===il.Material&&r.multipassTerrain.cullAboveGround,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?ua.View:ua.None,n.hasColorTexture=this.baseColorTexture!=null;const a=this._computeWhichMaterialPass();if(n.blendingEnabled=a===ji.Transparent||a===ji.OpaqueAndTransparent,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?$8(r)?D8(r)?Zr.ColorOverlayWithWater:Zr.ColorOverlay:Zr.NoOverlay:Zr.None,n.hasPolygonOffset=this.polygonOffsetEnabled,n.pbrMode=n.integratedMeshMode===Zr.ColorOverlayWithWater?Et.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?li("enable-feature:im-shading")&&this.isIntegratedMesh?Et.Simplified:Et.Schematic:Et.Normal:Et.Disabled,n.normalType=s.needsNormals?n.hasNormals?Dr.Compressed:Dr.ScreenDerivative:Dr.Ground,n.hasSlicePlane=r.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,t.identifier===il.ShadowMap)n.output=E.Shadow,n.vertexDiscardMode=Lr.None;else if(t.identifier===il.Highlight)n.output=E.Highlight,n.vertexDiscardMode=Lr.None;else{switch(a===ji.OpaqueAndTransparent?n.vertexDiscardMode=t.transparent?Lr.Opaque:Lr.Transparent:n.vertexDiscardMode=Lr.None,n.output=t.output,n.receiveAmbientOcclusion=!1,n.receiveShadows=!1,t.output){case E.Color:n.receiveAmbientOcclusion=r.ssao!=null,n.hasOccludees=r.hasOccludees,n.receiveShadows=r.shadowMap.ready,n.hasScreenSpaceReflections=r.ssr.lastFrameColor!=null,n.hasCloudsReflections=r.cloudsFade.data!=null;break;case E.Alpha:n.hasOccludees=r.hasOccludees;break;case E.ObjectAndLayerIdColor:n.objectAndLayerIdColor=!0}n.snowCover=this.hasSnowCover(r)}return this._technique=e.releaseAndAcquire(n2,n,this._technique),this._setClean(),this._technique}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,t,r){if(this.objectOpacity===0)return;const s=r.renderable.geometry,n=r.components,a=r.renderable.meta.cameraDepthSquared,o=n.geometryRanges,l=n.highlightRanges,c=n.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case ji.Opaque:e.materialOpaque.submitDraw(this,s,o,a);break;case ji.Transparent:e.materialTransparent.submitDraw(this,s,o,a);break;case ji.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,s,o,a),e.materialTransparent.submitDraw(this,s,o,a);break;case ji.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,s,o,a),M8(t)&&e.highlightIntegratedMesh.submitDraw(this,s,o,a)}const d=this.componentParameters.castShadows!==ai.None;d&&e.shadowMap.submitDraw(this,s,o,a),l!=null&&(e.highlight.submitDraw(this,s,l,a),d&&e.highlightShadowMap.submitDraw(this,s,l,a)),d&&c!=null&&e.defaultShadowMap.submitDraw(this,s,c,a)}_computeWhichMaterialPass(){return this.isIntegratedMesh?ji.IntegratedMesh:this.objectOpacity<1?ji.Transparent:this.componentParameters.opaqueOverride===ai.All?ji.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===Rl.Blend||this.alphaDiscardMode===Rl.MaskBlend?ji.Transparent:this.componentParameters.transparent===ai.None?ji.Opaque:this.componentParameters.transparent===ai.All?ji.Transparent:ji.OpaqueAndTransparent}};var ji,ai;h([Ot({vectorOps:zv})],mi.prototype,"baseColor",void 0),h([Ot()],mi.prototype,"usePBR",void 0),h([Ot()],mi.prototype,"hasParametersFromSource",void 0),h([Ot({vectorOps:Nf})],mi.prototype,"mrrFactors",void 0),h([Ot({vectorOps:Nf})],mi.prototype,"emissiveFactor",void 0),h([Ot({dispose:!0})],mi.prototype,"baseColorTexture",void 0),h([Ot({dispose:!0})],mi.prototype,"metallicRoughnessTexture",void 0),h([Ot({dispose:!0})],mi.prototype,"emissionTexture",void 0),h([Ot({dispose:!0})],mi.prototype,"occlusionTexture",void 0),h([Ot({dispose:!0})],mi.prototype,"normalTexture",void 0),h([Ot()],mi.prototype,"objectOpacity",void 0),h([Vy()],mi.prototype,"commonMaterialParameters",void 0),h([Vy()],mi.prototype,"componentParameters",void 0),h([Ot()],mi.prototype,"textureAlphaCutoff",void 0),h([Ot()],mi.prototype,"alphaDiscardMode",void 0),h([Ot()],mi.prototype,"isIntegratedMesh",void 0),h([Ot()],mi.prototype,"polygonOffsetEnabled",void 0),h([Ot()],mi.prototype,"ellipsoidMode",void 0),h([Ot()],mi.prototype,"hasOccludees",void 0),function(i){i[i.Opaque=0]="Opaque",i[i.Transparent=1]="Transparent",i[i.OpaqueAndTransparent=2]="OpaqueAndTransparent",i[i.IntegratedMesh=3]="IntegratedMesh"}(ji||(ji={}));let iu=class extends af{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=mg.Back,this.hasSlicePlane=!0}};h([Ot()],iu.prototype,"doubleSided",void 0),h([Ot()],iu.prototype,"cullFace",void 0),h([Ot()],iu.prototype,"hasSlicePlane",void 0);let Jc=class extends af{constructor(){super(...arguments),this.externalColor=Jr(1,1,1,1),this.externalColorMixMode=Ou.Multiply,this.castShadows=ai.All}get transparent(){return this.externalColor[3]<1?ai.All:ai.None}get opaqueOverride(){return this.externalColorMixMode===Ou.Replace&&this.externalColor[3]===1?ai.All:ai.None}get visible(){return this.externalColor[3]>0?ai.All:ai.None}get type(){return nn.Uniform}};h([Ot({vectorOps:zv})],Jc.prototype,"externalColor",void 0),h([Ot()],Jc.prototype,"externalColorMixMode",void 0),h([Ot()],Jc.prototype,"castShadows",void 0),function(i){i[i.All=0]="All",i[i.Some=1]="Some",i[i.None=2]="None"}(ai||(ai={}));let Lc=class extends af{constructor(){super(...arguments),this.texture=null,this.transparent=ai.None,this.opaqueOverride=ai.None,this.castShadows=ai.None}get type(){return nn.Varying}};function M8(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(vs.Highlight))!=null}function D8(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(vs.WaterNormal))!=null}function $8(i){var e;return((e=i.overlay)==null?void 0:e.getTexture(vs.ColorNoRasterImage))!=null}h([Ot()],Lc.prototype,"texture",void 0),h([Ot()],Lc.prototype,"transparent",void 0),h([Ot()],Lc.prototype,"opaqueOverride",void 0),h([Ot()],Lc.prototype,"castShadows",void 0);let L8=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},I8=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const r=new ui(this.textureWidth,1);r.samplingMode=Pr.NEAREST,r.wrapMode=Ji.CLAMP_TO_EDGE,this._texture=new Ci(this._rctx,r),this._data=new Ru(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,r,s,n,a){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,r),this._data.set(o,1,s),this._data.set(o,2,n),this._data.set(o,3,a)}setDataElement(e,t,r,s){const n=e*this._fieldCount+t;this._dirty=!0,this._data.set(n,r,s)}getDataElement(e,t,r){const s=e*this._fieldCount+t;return this._dirty=!0,this._data.get(s,r)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const r=Math.ceil(t/this.textureWidth)*this.textureWidth,s=new Ru(new ArrayBuffer(4*r));s.typedBuffer.set(this._data.typedBuffer),this._data=s}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const l2=65536;let N8=class{constructor(e,t=1){this.textureBuffer=new I8(e,t),this._indexManager=new L8(l2)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},c2=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const r of this._buffers)if(r.availableCount>=e)return r;if(e>l2)return null;const t=new N8(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const zy=()=>de.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class F8{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._visible=new xt,this._hidden=new xt,this._renderSubmit=new b8(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=li("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new c2(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){Js(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll(e=>e.destroy()),this._hidden.forAll(e=>e.destroy()),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,r=new zD(this._componentBufferManager,qb(t.componentOffsets)),s=this._createRenderable(e,r),n=new QD(this._viewingMode,t.positionData,r),a=new BD(e.transform,e.toMapSpace,e.obb.clone(),r,s,n);return(a.visible?this._visible:this._hidden).push(a),a}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const r=e;t!==r.visible&&(t?(this._hidden.removeUnordered(r),this._visible.push(r)):(this._visible.removeUnordered(r),this._hidden.push(r)),r.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(r=>r.renderable.meta.cameraDepthSquared=ma(t,r.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const r=e.renderable.material;t(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const r=e;r.components.visibility.reset(t),r.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,r=t.components.visibility.componentCount;return{visible:r,invisible:t.components.count-r}}setComponentData(e,t){const r=e,s=r.renderable.material,n=r.components,a=n.materialDataBuffer,o=n.materialDataIndices,l=new w8,c=a.textureBuffer,d=new Uint8Array(4),u=new Uint32Array(d.buffer);let m=0,_=0,f=0,y=n.verticalOffsets,b=1/0,x=-1/0,w=!1,C=!1,T=0;for(let P=0;P<n.count;P++){t(P,l),m+=+(l.externalColor[3]<1),_+=+(l.externalColorMixMode===Ou.Replace&&l.externalColor[3]===1),f+=+l.castShadows,OR(l.externalColor,l.externalColorMixMode,d),d[2]=254&d[2]|+l.castShadows,c.setData(o[P],0,d[0],d[1],d[2],d[3]),w||(w=P>0&&T!==u[0]),T=u[0],C||(C=l.elevationOffset!==0),C&&y==null&&(y=new Array(P).fill(0)),y!=null&&(y[P]=l.elevationOffset),b=Math.min(b,l.elevationOffset),x=Math.max(x,l.elevationOffset),r2(l.elevationOffset,d),c.setData(o[P],1,d[0],d[1],d[2],d[3]);const S=l.objectAndLayerIdColor;S!=null&&c.setData(o[P],2,S[0],S[1],S[2],S[3]),l.pickable!==N_(n.pickability,P)&&(n.pickability=HD(n.pickability,n.count,P,l.pickable))}n.verticalOffsets=C?y:null,r.offsetObb=C?ER(r.obb,b,x,this._viewingMode,r.offsetObb??r.obb.clone()):null,w||C||this._hasObjectAndLayerId?(s.componentParameters=new Lc,s.componentParameters.castShadows=Tm(f,n.count),s.componentParameters.transparent=Tm(m,n.count),s.componentParameters.opaqueOverride=Tm(_,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new Jc,s.componentParameters.castShadows=l.castShadows?ai.All:ai.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,r,s=!1){e.intersectionGeometry.getComponentAabb(t,r);const n=e,a=n.components.verticalOffsets;if(s||a==null)return r;const o=a[t];if(this._viewingMode===Re.Local||o===0)return r[2]+=o,r[5]+=o,r;const l=T0(o);return l.localOrigin=n.transform.position,l.applyToAabb(r)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,r){return e.intersectionGeometry.getComponentPositions(t,r)}expandRangeWithComponentObjectElevationRange(e,t,r,s){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||s.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const n=e,a=n.components,o=a.count,l=a.verticalOffsets,c=n.intersectionGeometry,d=this._viewingMode===Re.Local,u=c.getComponentAabbs(),m=U8;let _=1/0,f=-1/0;for(let y=0;y<o;y++){const b=6*y,x=(l==null?void 0:l[y])??0;let w=1/0,C=-1/0;if(d)w=u[b+2]+x+t,C=u[b+5]+x+t;else{if(m[0]=u[b],m[1]=u[b+1],m[2]=u[b+2],m[3]=u[b+3],m[4]=u[b+4],m[5]=u[b+5],x!==0){const R=T0(x);R.localOrigin=n.transform.position,R.applyToAabb(m)}const T=Math.max(Math.abs(m[3]),Math.abs(m[0])),P=Math.max(Math.abs(m[4]),Math.abs(m[1])),S=t+m[5]+r;s.expandElevationRangeValues(t+m[2],Math.sqrt(T*T+P*P+S*S)-r)}s.expandElevationRangeValues(w,C),_=Math.min(_,w),f=Math.max(f,C)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=_,this._elevationRangeCacheMax=f}intersect(e,t,r,s,n,a,o){const l=e,{transform:c}=l,{position:d}=c;return n!=null&&(n.localOrigin=d),l.intersectionGeometry.intersect(t,r,s,n,l.components.verticalOffsets,a,c,o??!1)}addEdges(e,t,r,s){const n=e,{indices:a,positions:o}=n.intersectionGeometry,l=n.components.offsets;return t.addComponentObject(n,o,a,l,r,s)}async extractEdgeInformation(e,t,r){const s=e,n=s.components.visibility;if(n.allInvisible())return{buffer:AR.createBuffer(0),origin:[0,0,0]};const{indices:a,positions:o}=s.intersectionGeometry,l=s.components.offsets,c=s_.createBuffer(o.length/3);Vb(c.position.typedBuffer,o,c.position.typedBufferStride,3),RR(c.position,c.position,s.transform.rotationScale),this._setComponentIndices(c.componentIndex,a,l);const d=c.count,u=this._computeVisibilityIndices(a,n,l,d);return{origin:Hn(s.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:u,indicesLength:u.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},r)}}_setComponentIndices(e,t,r){let s=0;for(let n=0;n<r.length-1;n++){const a=r[n],o=r[n+1];for(let l=a;l<o;l++){const c=t?t[l]:l;e.set(c,s)}s++}}_computeVisibilityIndices(e,t,r,s){if(e&&t.allVisible())return e;let n=0;t.forEachComponentRange((l,c)=>(n+=r[c]-r[l],!0));const a=rT(e)?new Array(n):(e==null?void 0:e.BYTES_PER_ELEMENT)===2||s<=65536?new Uint16Array(n):new Uint32Array(n);let o=0;return t.forEachComponentRange((l,c)=>{const d=r[l],u=r[c];for(let m=d;m<u;m++)a[o++]=e?e[m]:m;return!0}),a}addComponentHighlight(e,t){const r=e.components;r.highlightCounts==null&&(r.highlightCounts=new Uint32Array(r.count+1)),r.highlightCounts[t]++===0&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}removeComponentHighlight(e,t){const r=e.components;if(r.highlightCounts==null)return void zy().warn("Removing non-existing highlight.");const s=r.highlightCounts[t],n=r.highlightCounts[r.count];if(s!==0){if(s>1)return r.highlightCounts[t]=s-1,void(r.highlightCounts[r.count]=n-1);r.highlightCounts[t]=0,r.highlightsDirty(),this._notifyDirty(),n===1?r.highlightCounts=null:r.highlightCounts[r.count]=n-1}else zy().warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;t.highlightCounts!=null&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const r=this._renderManager.rctx,s=e.geometry,n=s.vertices.layoutParameters,a=ur.createVertex(r,Nr.STATIC_DRAW,s.vertices.data),o=s.indices?ur.createIndex(r,Nr.STATIC_DRAW,s.indices):null,l=Aa(x8(n)),c=new Uint16Array(s.vertices.count);for(let y=0;y<t.count;y++){const b=t.offsets[y],x=t.offsets[y+1],w=t.materialDataIndices[y];if(s.indices!=null)for(let C=b;C<x;C++)c[s.indices[C]]=w;else for(let C=b;C<x;C++)c[C]=w}const d=ur.createVertex(r,Nr.STATIC_DRAW,c.buffer),u=new mi(e.transform,e.toMapSpace),m=new IR(r,o2,{data:l,componentIndices:V8},{data:a,componentIndices:d},o),_=new u8(m,Ti.TRIANGLES,n,o!=null),f={cameraDepthSquared:.5,gpuMemoryEstimate:a.usedMemory+d.usedMemory+(o!=null?o.usedMemory:0)};return new d8(u,_,f)}_notifyDirty(){this._renderManager.notifyDirty()}}const V8=Aa(Ma().u16(ae.COMPONENTINDEX));function Tm(i,e){return i===e?ai.All:i===0?ai.None:ai.Some}const U8=Xu();let up=class extends di{constructor(){super(...arguments),this.opacity=1}};function h2(i){const e=new Mt;return e.include(Fr),e.fragment.uniforms.add(new Be("tex",t=>t.texture)),i.hasOpacityFactor&&e.fragment.uniforms.add(new Ne("opacity",t=>t.opacity)),e.fragment.code.add(g`
    void main() {
      fragColor = texture(tex, uv) ${i.hasOpacityFactor?"* opacity":""};
    }`),e}const z8=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:up,build:h2},Symbol.toStringTag,{value:"Module"}));var qi;(function(i){i[i.None=0]="None",i[i.Alpha=1]="Alpha",i[i.PremultipliedAlpha=2]="PremultipliedAlpha",i[i.COUNT=3]="COUNT"})(qi||(qi={}));let Bu=class extends Ls{constructor(){super(...arguments),this.alphaMode=qi.None,this.hasOpacityFactor=!1}};h([$({count:qi.COUNT})],Bu.prototype,"alphaMode",void 0),h([$()],Bu.prototype,"hasOpacityFactor",void 0);let of=class d2 extends Ft{initializeProgram(e){return new Dt(e.rctx,d2.shader.get().build(this.configuration),Pt)}initializePipeline(){switch(this.configuration.alphaMode){case qi.None:return nt({colorWrite:lt});case qi.Alpha:return nt({blending:pr(Z.SRC_ALPHA,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),colorWrite:lt});case qi.PremultipliedAlpha:case qi.COUNT:return nt({blending:cn(Z.ONE,Z.ONE_MINUS_SRC_ALPHA),colorWrite:lt})}}};of.shader=new Nt(z8,()=>he(()=>Promise.resolve().then(()=>Z$),void 0));let lf=class extends di{};function u2(){const i=new Mt;return i.include(Fr),i.fragment.uniforms.add(new Be("tex",e=>e.texture)),i.fragment.code.add(g`void main() {
fragColor = vec4(1.0 - texture(tex, uv).a);
}`),i}const q8=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:lf,build:u2},Symbol.toStringTag,{value:"Module"}));let p2=class m2 extends Ft{initializeProgram(e){return new Dt(e.rctx,m2.shader.get().build(),Pt)}initializePipeline(){return nt({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};p2.shader=new Nt(q8,()=>he(()=>Promise.resolve().then(()=>X$),void 0));let cf=class extends di{};function _2(){const i=new Mt;return i.include(Fr),i.fragment.uniforms.add(new Be("colorTexture",e=>e.colorTexture),new Be("alphaTexture",e=>e.alphaTexture),new Be("frontFaceTexture",e=>e.frontFaceTexture)),i.fragment.code.add(g`void main() {
vec4 srcColor = texture(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture(alphaTexture, uv).r;
vec4 frontFace = texture(frontFaceTexture, uv);
fragColor = vec4(mix(srcColor.rgb / srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`),i}const B8=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:cf,build:_2},Symbol.toStringTag,{value:"Module"}));let g2=class f2 extends Ft{initializeProgram(e){return new Dt(e.rctx,f2.shader.get().build(),Pt)}initializePipeline(){return nt({blending:pr(Z.SRC_ALPHA,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),colorWrite:lt})}};g2.shader=new Nt(B8,()=>he(()=>Promise.resolve().then(()=>Y$),void 0));let H8=class{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._configuration=new Bu,this._passParameters=new up,this._oitParameters=new cf,this._hudParameters=new lf}compositeOIT(e,t,r,s){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=r,this._oitParameters.frontFaceTexture=s;const n=this._techniqueRepository.acquire(g2);this._rctx.bindTechnique(n,e,this._oitParameters),this._rctx.screen.draw(),n.release()}compositeHUD(e,t){this._hudParameters.texture=t;const r=this._techniqueRepository.acquire(p2);this._rctx.bindTechnique(r,e,this._hudParameters),this._rctx.screen.draw(),r.release()}composite(e,t,r=qi.None,s=1){this._configuration.alphaMode=r,this._configuration.hasOpacityFactor=s!==1,this._passParameters.texture=t,this._passParameters.opacity=s;const n=this._techniqueRepository.acquire(of,this._configuration);this._rctx.bindTechnique(n,e,this._passParameters),this._rctx.screen.draw(),n.release()}};const G8=1e4,V_=100,k8=500,j8=500,W8=.1;function Q8(i,e,t){return NR(e,i)*(t[1]-t[0])+t[0]}function Z8(i,e,t){let r=0;if(!e.some(n=>!!n.materialReference&&(r+=n.numGeometries,r>=G8)))return r6.compute(i,e);const s=Ih();return t.forAll(n=>zl(s,X8(i,n))),s}function X8(i,e){if(!e.visible)return;const t=Ih(),r=e.getSpatialQueryAccelerator();return r?Y8(t,i,r):K8(t,i,e.objects),t}function Y8(i,e,t){const r=e.eye,s=e.viewForward,n=e.frustum,a=l=>l.visible,o=t.objectCount;if(o<k8)Th(kr,e.near,Math.min(i.near,e.far)),t.forEachInDepthRange(r,s,lo.DepthOrder.FRONT_TO_BACK,kr,(l,c)=>{U_(i,e,l),kr.far=i.near,c.setRange(kr)},n,a),Th(kr,Math.max(i.far,e.near),e.far),t.forEachInDepthRange(r,s,lo.DepthOrder.BACK_TO_FRONT,kr,(l,c)=>{U_(i,e,l),kr.near=i.far,c.setRange(kr)},n,a);else{const l=Math.max(Math.min(o,j8),Math.ceil(o*W8)),c=t.findClosest(s,lo.DepthOrder.FRONT_TO_BACK,n,a,l),d=t.findClosest(s,lo.DepthOrder.BACK_TO_FRONT,n,a,l);c&&d&&(qy(i,e,c.boundingVolumeWorldSpace.bounds),qy(i,e,d.boundingVolumeWorldSpace.bounds))}}function K8(i,e,t){Ko.clear(),t.forAll(r=>{r.visible&&r.geometries.length!==0&&Ko.add(r)}),Ko.empty||(Ko.sort(e),Th(kr,e.near,Math.min(i.near,e.far)),Ko.forEachInDepthRange(kr,lo.DepthOrder.FRONT_TO_BACK,(r,s)=>{s<i.near&&U_(i,e,r)}),Th(kr,Math.max(i.far,e.near),e.far),Ko.forEachInDepthRange(kr,lo.DepthOrder.BACK_TO_FRONT,(r,s,n)=>{i.far=Math.max(i.far,n)}))}function U_(i,e,t){if(!t.visible||!np(e.frustum,t.boundingVolumeWorldSpace.bounds))return;const r=t.transformation,s=i6;t.geometries.forEach(n=>{Yr(s,r,n.transformation);const a=Qm(s);y2(i,e,n.boundingInfo,s,a)})}function y2(i,e,t,r,s){if(t==null)return;Xt(At(Qi),t.center,r);const{eye:n,viewForward:a}=e,o=a[0]*(Qi[0]-n[0])+a[1]*(Qi[1]-n[1])+a[2]*(Qi[2]-n[2]);if(Qi[3]=t.radius*s,!(o-Qi[3]>i.near&&o+Qi[3]<i.far)&&np(e.frustum,Qi))if(t.radius>V_&&t.getChildren())for(const l of t.getChildren())y2(i,e,l,r,s);else z_.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}function qy(i,e,t){const r=e.eye,s=e.viewForward,n=(t[0]-r[0])*s[0]+(t[1]-r[1])*s[1]+(t[2]-r[2])*s[2];i.near=Math.min(i.near,n-t[3]),i.far=Math.max(i.far,n+t[3])}let J8=class{constructor(){this._items=new xt({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll(s=>{const n=s.object.boundingVolumeWorldSpace.bounds,a=(n[0]-t[0])*r[0]+(n[1]-t[1])*r[1]+(n[2]-t[2])*r[2];s.distance=a,s.near=a-n[3],s.far=a+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(e,t,r){if(t===lo.DepthOrder.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<e.near||n.near>e.far||r(n.object,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<e.near||n.near>e.far||r(n.object,n.near,n.far)}}},e6=class{constructor(){this._view=ct(),this._viewProj=ct(),this._frustum=Tu(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),Bl(this._view,e.viewMatrix),Yr(this._viewProj,e.projectionMatrix,this._view),r_(this._frustum,e.frustum);const r=this._view,s=r[2],n=r[6],a=r[10],o=r[14];t.forAll(m=>{m.materialReference&&m.forEachGeometry&&m.forEachGeometry(_=>{if(!_.visible||!_.castShadow)return;const f=_.boundingSphere,y=s*f[0]+n*f[1]+a*f[2]+o,b=y-f[3],x=y+f[3];this._geometries.push(_),this._near.push(-x),this._far.push(-b)})});const l=new sf;if(this._geometries.length===0)return l;for(let m=0;m<this._geometries.length;++m)this._near[m]>l.far&&(l.far=this._near[m]),this._near[m]>2&&this._far[m]<l.near&&(l.near=this._far[m]);const c=this._looseRange;c.near=Math.max(.5*l.near,2),c.far=2*l.far;let d=0,u=0;for(let m=0;m<this._geometries.length;++m)this._near[m]<l.near&&(this._near[m]>=c.near?l.near=this._near[m]:this._nearCandidates[d++]=m),this._far[m]>l.far&&(this._far[m]<=c.far?l.far=this._far[m]:this._farCandidates[u++]=m);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return l;this._nearCandidates.sort((m,_)=>this._near[m]<this._near[_]?-1:this._near[m]>this._near[_]?1:0),this._farCandidates.sort((m,_)=>this._far[m]<this._far[_]?1:this._far[m]>this._far[_]?-1:0);for(let m=0;m<this._nearCandidates.length;++m){const _=this._nearCandidates[m];if(this._near[_]<l.near){const f=this._geometries[_],y=f.boundingInfo;this._includeNearBoundingInfoRec(y,f.shaderTransformation,l)}}for(let m=0;m<this._farCandidates.length;++m){const _=this._farCandidates[m];if(this._far[_]>l.far){const f=this._geometries[_],y=f.boundingInfo;this._includeFarBoundingInfoRec(y,f.shaderTransformation,l)}}return this._reset(),l}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,r){if(e==null)return;const s=e.center;Xt(At(Qi),s,t);const n=Qm(t),a=Qi[0],o=Qi[1],l=Qi[2],c=e.radius*n,d=this._frustum;if(d[0][0]*a+d[0][1]*o+d[0][2]*l+d[0][3]>c||d[1][0]*a+d[1][1]*o+d[1][2]*l+d[1][3]>c||d[2][0]*a+d[2][1]*o+d[2][2]*l+d[2][3]>c||d[3][0]*a+d[3][1]*o+d[3][2]*l+d[3][3]>c)return;const u=this._view[2]*a+this._view[6]*o+this._view[10]*l+this._view[14],m=u+c;if(!(-(u-c)<2||-m>=r.near))if(-m>this._looseRange.near)r.near=-m;else{if(c>V_){const _=e.getChildren();if(_!==void 0){for(const f of _)this._includeNearBoundingInfoRec(f,t,r);return}}z_.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,r){if(e==null)return;let s=e.radius;const n=e.center;Xt(At(Qi),n,t);const a=Qm(t),o=Qi[0],l=Qi[1],c=Qi[2];s*=a;const d=this._frustum;if(d[0][0]*o+d[0][1]*l+d[0][2]*c+d[0][3]>s||d[1][0]*o+d[1][1]*l+d[1][2]*c+d[1][3]>s||d[2][0]*o+d[2][1]*l+d[2][2]*c+d[2][3]>s||d[3][0]*o+d[3][1]*l+d[3][2]*c+d[3][3]>s)return;const u=this._view[2]*o+this._view[6]*l+this._view[10]*c+this._view[14]-s;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(s>V_){const m=e.getChildren();if(m!==void 0){for(const _ of m)this._includeFarBoundingInfoRec(_,t,r);return}}z_.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}};class t6{constructor(){this._modelViewProj=ct(),this._clipPosition=[_i(),_i(),_i(),_i(),_i(),_i(),_i(),_i()]}unionDepthRangeWithAABB(e,t,r,s,n){const a=this._modelViewProj;Yr(a,t,r);let o=!1;for(let l=0;l<8;++l){const c=this._clipPosition[l],d=l===0||l===3||l===4||l===7?s[0]:n[0],u=l===0||l===1||l===4||l===5?s[1]:n[1],m=l<4?s[2]:n[2];c[0]=a[0]*d+a[4]*u+a[8]*m+a[12],c[1]=a[1]*d+a[5]*u+a[9]*m+a[13],c[2]=a[2]*d+a[6]*u+a[10]*m+a[14],c[3]=a[3]*d+a[7]*u+a[11]*m+a[15]}for(let l=0;l<12;++l){const c=this._clipPosition[Pm[l][0]],d=this._clipPosition[Pm[l][1]],u=this._clipPosition[Pm[l][2]],m=this._clipTriangle(c,d,u);let _=!0;for(let f=0;f<m.length;++f)if(m[f][3]>=2){_=!1;break}if(!_){o=!0;for(let f=0;f<m.length;++f){const y=m[f][3];Number.isFinite(y)&&(e.near=Math.min(y,e.near),e.far=Math.max(y,e.far))}}}return o}_inside(e,t){return t===0?e[0]>=-e[3]:t===1?e[1]>=-e[3]:t===2?e[0]<=e[3]:t===3?e[1]<=e[3]:void Js(!1)}_intersect(e,t,r){let s=0;return r===0?s=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):r===1?s=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):r===2?s=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):r===3&&(s=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),sT(_i(),e,t,s)}_clipTriangle(e,t,r){let s=[e,t,r];for(let n=0;n<4;++n){const a=s;s=[];for(let o=0;o<a.length;++o){const l=a[o],c=a[(o+1)%a.length];this._inside(c,n)?(this._inside(l,n)||s.push(this._intersect(l,c,n)),s.push(c)):this._inside(l,n)&&s.push(this._intersect(l,c,n))}}return s}}const Pm=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Qi=Ds(),i6=ct(),kr=Ih(),Ko=new J8,r6=new e6,z_=new t6;let s6=class{},n6=class extends di{constructor(){super(...arguments),this.textures=new s6}};function a6(){const i=new Mt;return i.attributes.add(ae.POSITION,"vec2"),i.vertex.uniforms.add(new Vn("drawPosition",(e,t)=>o6(e,t))),i.varyings.add("vUV","vec2"),i.vertex.code.add(g`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),i.fragment.uniforms.add(new Be("textureInput",e=>e.textures.input)),i.fragment.uniforms.add(new Be("textureMask",e=>e.textures.mask)),i.fragment.uniforms.add(new Be("textureOverlay",e=>e.textures.overlay)),i.fragment.uniforms.add(new dh("maskEnabled",e=>e.magnifier.maskEnabled)),i.fragment.uniforms.add(new dh("overlayEnabled",e=>e.magnifier.overlayEnabled)),i.fragment.code.add(g`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),i}function o6(i,e){const t=e.camera.pixelRatio,r=i.magnifier.offset.x*t,s=i.magnifier.offset.y*t;An(i.magnifier.position,By);const n=e.camera.screenToRender(By,l6),a=Math.ceil(t*i.magnifier.size),o=e.camera.fullWidth,l=e.camera.fullHeight;return xa(c6,(n[0]+r)/o*2-1,(n[1]-s)/l*2-1,a/o*2,a/l*2)}const By=qt(),l6=qv(),c6=_i();let ll=class extends Pe{constructor(){super(...arguments),this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new n6,this.events=new es,this.attributeLocations=new Map([[ae.POSITION,0]]),this._tmpScreenPoint=qt(),this._tmpRenderPoint=qv()}get updating(){return this._imageSources==null&&this._imageLoadTask!=null&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};this._magnifier!=null&&this.addHandles(A(()=>{var r;return(r=this._magnifier)==null?void 0:r.version},t)),t()}get enabled(){return this._validMagnifier!=null}get _validMagnifier(){return this._magnifier!=null&&this._magnifier.visible&&this._magnifier.position!=null&&this._magnifier.size>0?this._magnifier:null}get _factor(){return this._magnifier!=null&&this._magnifier.factor||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const r=this._validMagnifier;if(r==null)return;const s=t.camera.pixelRatio,n=Math.ceil(s*r.size);if(this._updateResources(e,n),this._resources==null)return;const a=this._passParameters.textures,o=Math.ceil(1/this._factor*n);a.input.resize(o,o),An(r.position,this._tmpScreenPoint);const l=t.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),c=t.camera.fullWidth,d=t.camera.fullHeight,u=.5*o,m=.5*o;l[0]=ie(l[0],u,c-u-1),l[1]=ie(l[1],m,d-m-1);const _=Math.floor(l[0]-u),f=Math.floor(l[1]-m),y=this._resources.program;y.bindTexture("textureInput",a.input),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,_,f,o,o,0),this._passParameters.magnifier=r,e.useProgram(y),y.bindPass(this._passParameters,t),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(Ti.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(e==null)return;const t=e.maskUrl,r=e.overlayUrl;this._imageLoadTask==null||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===r||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),this._imageSources==null&&this._imageLoadTask==null&&(this._imageLoadTask={maskUrl:t,overlayUrl:r,task:Hu(async s=>{const n=t==null||r==null?TR(s):null,a=t!=null?_h(t,{signal:s}):n.then(l=>l.mask),o=r!=null?_h(r,{signal:s}):n.then(l=>l.overlay);this._imageSources={mask:await a,overlay:await o},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(this._resources!=null){if(this._passParameters.textures.size!==t){const s=this._createTextureResources(e,t);if(s==null)return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=s}return}const r=this._createTextureResources(e,t);r!=null&&(this._resources={program:this._createProgram(e),vao:un(e,gg,this.attributeLocations,0,1),pipelineState:nt({blending:cn(Z.ONE,Z.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:lt})},this._passParameters.textures=r)}_disposeResources(){this._resources!=null&&(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(this._imageSources==null)return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const r=new ui;r.internalFormat=hi.RGBA,r.wrapMode=Ji.CLAMP_TO_EDGE,r.flipped=!0,r.preMultiplyAlpha=!Fv(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result;const s=new Ci(e,r,this._imageSources.overlay);r.pixelFormat=r.internalFormat=hi.ALPHA,r.preMultiplyAlpha=!1;const n=new Ci(e,r,this._imageSources.mask);return r.pixelFormat=r.internalFormat=hi.RGBA,r.flipped=!1,{input:new Ci(e,r),mask:n,overlay:s,size:t}}_createProgram(e){return new Dt(e,a6(),this.attributeLocations)}};h([p()],ll.prototype,"_imageSources",void 0),h([p()],ll.prototype,"_imageLoadTask",void 0),h([p({readOnly:!0})],ll.prototype,"updating",null),ll=h([F("esri/views/3d/webgl-engine/lib/MagnifierHelper")],ll);let h6=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Ru(new ArrayBuffer(4)),this._layerToOidToColor=new D0,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new D0,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,r,s,n,a=null,o=null,l=null){e&&t&&r&&s&&(this._layerUidToId.set(s,r),this._layerUidToPopupEnabled.set(s,n),n&&this._layerUidToGraphicsUidToObjectId.set(s,t,{objectId:e,attributeNodeId:a,attributeIndex:o,subLayerId:l}))}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return Jr(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){var a;if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(t===void 0)return de.getLogger(this).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(t===!1)return this.colorZero;const r=(a=this._layerUidToGraphicsUidToObjectId.get(e.layerUid,e.graphicUid))==null?void 0:a.objectId;if(!r)return this.colorZero;let s=this._layerToOidToColor.get(e.layerUid,r);if(!s){for(;!s;){const o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(s=o)}if(s>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(e.layerUid,r,s),this._colorToUID.set(s,e)}const n=new ArrayBuffer(4);return new DataView(n).setUint32(0,s,!1),new Ru(n)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,r]of this._colorToUID.entries()){const s=this._layerUidToGraphicsUidToObjectId.get(r.layerUid,r.graphicUid);s||de.getLogger(this).warn("getColorMapping: no entry found for graphicsId "+r.graphicUid);const n=this._layerUidToId.get(r.layerUid);n||de.getLogger(this).warn("no layerId found for uid "+r.layerUid),s&&n&&e.set(t,s.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:s.objectId,lid:n,attrId:s.attributeNodeId,attrIdx:s.attributeIndex,subLayerId:s.subLayerId}:{type:"object-and-layer-id",oid:s.objectId,lid:n})}return e}},v2=class{constructor(e,t){this.key=e,this.free=t,this.incarnation=0,this._refCount=1}retain(){++this._refCount}release(){return this._refCount===0?(console.log(`Releasing already released FBO attachment in ${new Error().stack}`),!0):(--this._refCount,this._refCount===0&&(this.free(),!0))}};var ql;(function(i){i[i.FBO=0]="FBO",i[i.DEPTH=1]="DEPTH",i[i.COLOR=2]="COLOR"})(ql||(ql={}));let b2=class extends v2{constructor(e,t,r){super(e,r),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}},d6=class extends b2{constructor(e,t,r){super(e,t,r),this.attachment=t,this.type=ql.COLOR}},Hy=class extends b2{constructor(){super(...arguments),this.type=ql.DEPTH}},u6=class extends v2{constructor(e,t,r,s,n,a){super(e,a),this.type=ql.FBO,this._colors=new Map,this._name="composite-color",this.acquireDepth=null,this.acquireColor=null,this._name=t,this.fbo=r,this.acquireDepth=s,this.acquireColor=n}dispose(){this.fbo.dispose()}get usedMemory(){return this.fbo.usedMemory}get name(){return this._name}setName(e){this._name=e}getTexture(e=h0.COLOR_ATTACHMENT0){var t,r;return e===e_?(t=this.fbo)==null?void 0:t.depthStencilTexture:(r=this.fbo)==null?void 0:r.getColorTexture(e)}getAttachment(e=h0.COLOR_ATTACHMENT0){return e===e_?this._depth:this._colors.get(e)}attachDepth(e){return e==null||e.retain(),this.detachDepth(),e&&this.fbo.attachDepthStencil(e.attachment),this._depth=e,this}detachDepth(){this.fbo.detachDepthStencilTexture(),this.fbo.detachDepthStencilBuffer(),this._depth=tt(this._depth)}attachColor(e,t){return e.retain(),this.detachColor(t),this.fbo.attachColorTexture(e.attachment,t),this._colors.set(t,e),this}detachColor(e){this.fbo.detachColorTexture(e);const t=this._colors.get(e);this._colors.delete(e),t==null||t.release()}detachAll(){this._colors.forEach((e,t)=>this.detachColor(t)),this.detachDepth()}},Sm=class{constructor(e,t){this._last=new xt,this._incarnation=0,this._cache=new tp(e,t)}destroy(){var e;(e=this._last)==null||e.forAll(t=>t.dispose()),this._last=null,this._cache.destroy()}set interactive(e){var t;e&&!this._last?this._last=new xt:e||((t=this._last)==null||t.forAll(r=>r.dispose()),this._last=null)}clean(){var e;(e=this._last)==null||e.filterInPlace(t=>!(t.incarnation<this._incarnation)||(this._cache.put(t.key,t),!1))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find(r=>r.key===e);if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){var e;return((e=this._last)==null?void 0:e.reduce((t,r)=>t+r.usedMemory,0))??0}};class p6{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new Sm(e.newCache,"FBOCache"),this._depthCache=new Sm(e.newCache,"DepthAttachmentCache"),this._colorCache=new Sm(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach(t=>t.type===ql.FBO&&e(t.name,t.fbo))}get usedMemory(){return Array.from(this._acquired.values()).reduce((e,t)=>{var r;return e+("getTexture"in t?((r=t.getTexture())==null?void 0:r.usedMemory)??0:t.usedMemory)},this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,r,s=si.RGBA){const n=Rm(s,e,t);let a=this._cache.pop(n);return a?(a.retain(),a.setName(r)):a=new u6(n,r,new Mh(this.rctx,{...Gy[s],width:e,height:t}),o=>{o??(o=or.DEPTH_STENCIL_TEXTURE);const l=this._acquireDepth(o,a.fbo.width,a.fbo.height,`${a.name} depth`);return a.attachDepth(l),l.release(),a},(o,l)=>{l??(l=si.RGBA);const c=this._acquireColor(l,e,t,`${a.name} color ${o}`);return a.attachColor(c,o),c.release(),a},()=>{this.debugCallback&&this.debugCallback(a.name,a.fbo),this._acquired.delete(a),a.detachAll(),this._cache.put(a)}),this._trackHandle(a)}acquireDepth(e,t,r,s){return this._acquireDepth(e,t,r,s)}_acquireDepth(e,t,r,s){const n=Rm(e,t,r),a=this._depthCache.pop(n);if(a)return a.retain(),a.name=s,this._trackHandle(a);const o=e===or.DEPTH_STENCIL_TEXTURE?new Hy(n,new Ci(this.rctx,{...ky[e],width:t,height:r}),()=>{this._acquired.delete(o),this._depthCache.put(o)}):new Hy(n,new sS(this.rctx,{...ky[e],width:t,height:r}),()=>{this._acquired.delete(o),this._depthCache.put(o)});return o.name=s,this._trackHandle(o)}_acquireColor(e,t,r,s){const n=Rm(e,t,r),a=this._colorCache.pop(n);if(a)return a.retain(),a.name=s,this._trackHandle(a);const o=new d6(n,new Ci(this.rctx,{...Gy[e],width:t,height:r}),()=>{this._acquired.delete(o),this._colorCache.put(o)});return o.name=s,this._trackHandle(o)}_trackHandle(e){return this._acquired.add(e),e}}function Rm(i,e,t){return`${i}x${e}x${t}`}const ru=new ui;ru.pixelFormat=hi.RED,ru.internalFormat=Gl.R8,ru.wrapMode=Ji.CLAMP_TO_EDGE;const su=new ui;su.pixelFormat=hi.RG,su.internalFormat=Gl.RG8,su.wrapMode=Ji.CLAMP_TO_EDGE;const nu=new ui;nu.internalFormat=Gl.RGBA4,nu.dataType=ga.UNSIGNED_SHORT_4_4_4_4,nu.wrapMode=Ji.CLAMP_TO_EDGE;const x2=new ui;x2.wrapMode=Ji.CLAMP_TO_EDGE;const Ic=new ui;Ic.wrapMode=Ji.CLAMP_TO_EDGE,Ic.samplingMode=Pr.LINEAR_MIPMAP_LINEAR,Ic.hasMipmap=!0,Ic.maxAnisotropy=8;const Nc=new ui;Nc.pixelFormat=hi.RED,Nc.dataType=ga.HALF_FLOAT,Nc.internalFormat=Gl.R16F,Nc.samplingMode=Pr.NEAREST;const au=new ui;au.dataType=ga.HALF_FLOAT,au.internalFormat=Gl.RGBA16F,au.samplingMode=Pr.NEAREST;const Gy={[si.RED]:ru,[si.RG]:su,[si.RGBA4]:nu,[si.RGBA]:x2,[si.RGBA_MIPMAP]:Ic,[si.R16F]:Nc,[si.RGBA16F]:au},Fc=new ui;Fc.pixelFormat=hi.DEPTH_STENCIL,Fc.dataType=ga.UNSIGNED_INT_24_8,Fc.samplingMode=Pr.NEAREST,Fc.wrapMode=Ji.CLAMP_TO_EDGE;const ky={[or.DEPTH_STENCIL_TEXTURE]:Fc,[or.DEPTH16_BUFFER]:new Rb(vb.DEPTH_COMPONENT16,4)};var Ph;(function(i){i[i.FrontToBack=0]="FrontToBack",i[i.BackToFront=1]="BackToFront"})(Ph||(Ph={}));let ta=class{constructor(e,t,r=Ph.FrontToBack){this._rctx=e,this._techniqueRepository=t,this._sorting=r,this._draws=new xt({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=r,n.material=e,n.depthSquaredHint=s,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0}prepare(e,t){return this._draws.map(r=>r.material.prepareTechnique(this._techniqueRepository,e,t,r.geometry.parameters))}dispatch(e,t,r){const s=this._rctx;this._previouslyBoundDraw.clear();let n=null;const a=this._draws.length;for(let o=0;o<a;o++){const l=r[o];l===n&&l.configuration.transparencyPassType===ti.NONE||(s.bindTechnique(l,t,e),n=l);const c=this._draws.data[o],d=c.geometry;s.bindVAO(d.vao),this._previouslyBoundDraw.get(l)!==c.material&&(l.program.bindDraw(c.material,t,e),this._previouslyBoundDraw.set(l,c.material));const u=c.geometryRanges,m=u.length;if(c.indexType!==0){const _=ou.get(c.indexType);for(let f=0;f<m;f+=2){const y=u[f],b=u[f+1];s.drawElements(d.primitiveType,b,c.indexType,y*_)}}else for(let _=0;_<m;_+=2){const f=u[_],y=u[_+1];s.drawArrays(d.primitiveType,f,y)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===Ph.FrontToBack?1:-1;this._draws.sort((t,r)=>{const s=e*(t.depthSquaredHint-r.depthSquaredHint);return s!==0?s:t.geometry.vao.byteSize-r.geometry.vao.byteSize})}get count(){return this._draws.length}};const ou=new Map;ou.set(Xi.UNSIGNED_BYTE,1),ou.set(Xi.UNSIGNED_SHORT,2),ou.set(Xi.UNSIGNED_INT,4);let q_=class extends mP{constructor(){super({}),this._passes=null,this.produces=new Map([[L.OPAQUE_MATERIAL,e=>this._produces(e)],[L.TRANSPARENT_MATERIAL,e=>!!(this._passes&&this._passes.materialTransparent.count>0)&&this._produces(e)],[L.INTEGRATED_MESH,e=>this._produces(e)]]),this._materialPassParameters=new FP,this._shadowPassParameters=new VP,this._highlightPassParameters=new UP,this._systems=new Set}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx,r=e.techniqueRepository;this._passes={materialOpaque:new ta(t,r),materialTransparent:new ta(t,r,Ph.BackToFront),materialIntegratedMesh:new ta(t,r),shadowMap:new ta(t,r),highlight:new ta(t,r),highlightIntegratedMesh:new ta(t,r),highlightShadowMap:new ta(t,r),defaultShadowMap:new ta(t,r)}}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e){return this._systems.size!==0&&this._passes!==null&&(e===E.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:e!==E.ShadowHighlight||this._passes.highlight.count>0)}prepareRender(e){if(this._systems.size!==0&&this._passes!==null){for(const t of Object.values(this._passes))t.prepareSubmit();this._systems.forEach(t=>t.submit(this._passes,e.bindParameters));for(const t of Object.values(this._passes))t.finishSubmit();this._context.techniqueRepository.frameUpdate()}}prepareTechniques(e){if(this._systems.size===0)return null;const t=e.output===E.Shadow||e.output===E.ShadowHighlight||e.output===E.ShadowExcludeHighlight?this._shadowPassParameters:e.output===E.Highlight?this._highlightPassParameters:this._materialPassParameters,r=e.bindParameters;return this._updateParameters(r.camera,t,r.slot===L.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e,(s,n)=>s.prepare(n,e.bindParameters))}renderNode(e,t){this._invoke(e,(r,s)=>r.dispatch(s,e.bindParameters,t))}_invoke(e,t){if(this._passes===null)return null;switch(e.bindParameters.slot){case L.OPAQUE_MATERIAL:switch(e.output){case E.Color:case E.LinearDepth:case E.Normal:case E.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case E.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case E.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case E.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case E.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters)}break;case L.TRANSPARENT_MATERIAL:switch(e.output){case E.Color:case E.Alpha:case E.LinearDepth:case E.Normal:case E.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case L.INTEGRATED_MESH:switch(e.output){case E.Color:case E.LinearDepth:case E.Normal:case E.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case E.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new sf;return this._systems.forEach(r=>zl(t,r.queryShadowCasterDepthRange(e))),t}_updateParameters(e,t,r){const s=e.viewInverseTransposeMatrix;Ie(Om,s[3],s[7],s[11]),Em.set(Om),le(t.transformWorldFromViewTH,Em.high),le(t.transformWorldFromViewTL,Em.low),le(t.slicePlaneLocalOrigin,Om),ag(t.transformViewFromCameraRelativeRS,e.viewMatrix),Bl(t.transformProjFromView,e.projectionMatrix),t.identifier===il.Material&&(this._materialPassParameters.transparent=r,kl(jy,t.transformViewFromCameraRelativeRS),Ah(t.transformNormalViewFromGlobal,jy))}};q_=h([F("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],q_);const Om=v(),jy=$s(),Em=new dp;let m6=class{constructor(e){this._context=e,this._nodes=new xt}destroy(){this._nodes.forEach(e=>e.destroy()),this._nodes.clear()}add(e){this._nodes.push(e),_0&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}remove(e){this._nodes.remove(e),_0&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:t})=>t).join(", ")}`)}produces(e){return this._nodes.some(({produces:t})=>t===e)}require(e,t){return this._nodes.reduce((r,{consumes:s,produces:n})=>r+(s.required.includes(e)&&n===t?1:0),0)}optional(e,t){return this._nodes.reduce((r,{consumes:s,produces:n})=>{var a;return r+((a=s.optional)!=null&&a.includes(e)&&n===t?1:0)},0)}updateAnimation(){return this._nodes.reduce((e,t)=>t.updateAnimation()||e,!1)}render(e,t,r){const s=e.name,n=this._nodes.filter(({produces:a})=>a===s);return n.length===0||(n.forEach(a=>{const o=[e];for(const l of a.consumes.required){if(l===s)continue;const c=t.get(l);if(!c)return void r(o);o.push(c)}if(a.consumes.optional)for(const l of a.consumes.optional){if(l===s)continue;const c=t.get(l);c&&o.push(c)}try{const l=a.doRender(o,this._context);l&&l!==e&&(e.release(),e=l,t.set(s,e))}catch(l){de.getLogger(a).errorOnce(l)}r(o)}),this._context.rctx.enforceState()),e}},_6=class{constructor(e){this._context=e,this._renderPlugins=new xt,this._slots=new Array,this._renderVersion=Hc(0);for(let t=0;t<L.MAX_SLOTS;++t)this._slots[t]=[]}destroy(){this._renderPlugins.forEach(e=>e.destroy()),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const r=()=>{if(t!=null&&t.aborted)throw e.uninitializeRenderContext(),Ts();this._renderPlugins.push(e),e.produces.forEach((n,a)=>{this._slots[a].push(e)}),this._context.requestRender(),this._renderVersion.value++},s=e.initializeRenderContext(this._context,t);if(Q_(s))return s.then(r);r()}remove(e){if(this._renderPlugins.removeUnordered(e)!=null){for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(r=>r!==e);e.uninitializeRenderContext(),this._context.requestRender(),this._renderVersion.value++}}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forAll(r=>{r.updateAnimation&&(t=r.updateAnimation(e)||t)}),t}renderFeatureChanged(){this._renderPlugins.forAll(e=>{e.renderFeatureChanged&&e.renderFeatureChanged()})}prepare(e){this._context.renderContext.bindParameters.slot=e,this._slots[e].forEach(t=>{const r=t.produces.get(e);r&&r(E.Color)&&(Km(t)&&t.prepareTechnique(this._context.renderContext),o0(t)&&t.prepareTechniques(this._context.renderContext))})}_getRenderables(e){this._context.renderContext.bindParameters.slot=e;const t=this._context.renderContext.output??E.Color,r=new Map;return this._slots[e].forEach(s=>{const n=s.produces.get(e);if(n&&n(t)&&(!s.isDecoration||this._context.renderContext.bindParameters.decorations!==Cs.OFF))if(Km(s)){const a=s.prepareTechnique(this._context.renderContext);a!=null&&r.set(s,a)}else if(o0(s)){const a=s.prepareTechniques(this._context.renderContext);a!=null&&r.set(s,a)}else r.set(s,null)}),r}render(e,t=null,r=null){return this._getRenderables(e).forEach((s,n)=>r=n.renderNode(this._context.renderContext,s,t,r)),r}queryDepthRange(e){const t=new sf;return this._renderPlugins.forAll(r=>{var n;const s=(n=r.queryDepthRange)==null?void 0:n.call(r,e);zl(t,s)}),t}get updating(){return this._renderVersion.value>=0&&this._renderPlugins.some(e=>e.running)}produces(e,t=E.Color){return this._slots[e].some(r=>{const s=r.produces.get(e);return!!s&&s(t)})}consumes(e){return this._renderPlugins.some(t=>t.consumes().required.includes(e))}getMaterialRenderer(e){return this._renderPlugins.find(t=>t.materialReference===e)}removeEmptyMaterialRenderers(){this._renderPlugins.filterInPlace(e=>!e.materialReference||e.numGeometries!==0||(e.destroy(),!1))}get hasDecorations(){return this._renderPlugins.some(e=>e.isDecoration)}get hasOccludees(){return this._renderPlugins.some(e=>e.hasOccludees)}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|t.renderOccludedFlags,xi.None)}get usedMemory(){return this._renderPlugins.reduce((e,t)=>t.materialReference!==null?e:e+(t.usedMemory??0),0)}get test(){return{plugins:this._renderPlugins}}},cl=class extends Eh{constructor(e){super(e),this._context=null,this.opacity=1,this.alphaMode=qi.None,this._blitConfiguration=new Bu,this._blitParameters=new up,this.produces=new Map([[L.BLIT,()=>this._context!=null]])}consumes(){return ub}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){this._context=null}destroy(){}renderNode(e,t,r,s){var o;const n=(o=r==null?void 0:r.get("composite-color"))==null?void 0:o.getTexture();if(!this._context||!n)return s;const a=this._context.techniqueRepository.acquire(of,this._blitConfiguration);return a!=null&&a.compiled?(e.rctx.bindFramebuffer(s==null?void 0:s.fbo),this._blitParameters.texture=n,this._blitParameters.opacity=this.opacity,e.rctx.bindTechnique(a,e.bindParameters,this._blitParameters),e.rctx.screen.draw(),a.release(),s):(this._context.requestRender(),s)}};h([p()],cl.prototype,"_context",void 0),h([p()],cl.prototype,"opacity",void 0),h([p()],cl.prototype,"alphaMode",void 0),cl=h([F("esri.views.3d.webgl-engine.effects.blit.Blit")],cl);let hf=class extends di{};function w2(){const i=new Mt,{outputs:e,fragment:t}=i;return i.include(Fr),t.uniforms.add(new xo("textureInput",r=>r.input)),t.constants.add("sampleArea","int",Math.ceil(Sh/2)),e.add("fragGrid","vec2"),t.code.add(g`
    void main() {
      float red = 0.0;
      float green = 1.0;
      int cellSize = ${g.int(fs)};
      vec2 texelSize = 1.0 / vec2(textureSize(textureInput, 0));
      vec2 offset = floor(gl_FragCoord.xy) * vec2(float(cellSize));

      for(int x = -sampleArea; x < cellSize + sampleArea; x += 2) {
        for(int y = -sampleArea; y < cellSize + sampleArea; y += 2) {
          vec2 coord = (offset + vec2(float(x), float(y))) * texelSize;
          vec4 value = texture(textureInput, coord);
          float mx = floor(max(value.g, value.b));

          red = max(red, ceil(value.r));
          green = min(green, mx);
          if(red == 1.0 && green == 0.0) {
            fragGrid = vec2(red, green);
            return;
          }
        }
      }
      fragGrid = vec2(red, green);
    }`),i}const fs=32,Sh=9,df=.4,g6=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:hf,blurSize:df,build:w2,gridCellPixelSize:fs,outlineSize:Sh},Symbol.toStringTag,{value:"Module"}));function C2(){const i=new Mt,{vertex:e,fragment:t}=i,r=e.code,s=t.code;return i.attributes.add(ae.POSITION,"vec2"),i.varyings.add("uv","vec2"),i.attributes.add(ae.UV0,"vec2"),e.uniforms.add(new Be("coverageTex",n=>n.coverageTexture),new $i("coverageRounding",n=>n.coverageRounding)),r.add(g`void main() {
vec4 cov = texture(coverageTex, uv0 * coverageRounding);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),t.uniforms.add(new Be("tex",n=>n.blurTexture),new Be("highlightTexture",n=>n.highlightTexture),new Vn("uColor",n=>n.color),new Vn("haloColor",n=>n.haloColor),new Vn("opacities",n=>xa(f6,n.haloOpacity,n.haloOpacityOccluded,n.fillOpacity,n.fillOpacityOccluded))),t.constants.add("inner","float",1-(Sh-df)/Sh),s.add(g`void main() {
vec4 blurredHighlightValue = texture(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture(highlightTexture, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float outlineFactor = smoothstep(0.0, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
fragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),i}const f6=_i(),y6=Object.freeze(Object.defineProperty({__proto__:null,build:C2},Symbol.toStringTag,{value:"Module"}));let T2=class P2 extends Ft{initializeProgram(e){return new Dt(e.rctx,P2.shader.get().build(),Pt)}initializePipeline(){return nt({blending:pr(Z.SRC_ALPHA,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),colorWrite:lt})}};T2.shader=new Nt(y6,()=>he(()=>Promise.resolve().then(()=>K$),void 0));let uf=class extends di{constructor(){super(...arguments),this.blurSize=Di()}};function S2(){const i=new Mt,{attributes:e,varyings:t,vertex:r,fragment:s}=i;return e.add(ae.POSITION,"vec2"),e.add(ae.UV0,"vec2"),t.add("blurCoordinate","vec3"),r.uniforms.add(new Be("coverageTex",n=>n.coverageTexture),new $i("coverageRounding",n=>n.coverageRounding)),r.code.add(g`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture(coverageTex, uv0 * coverageRounding);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), cov.g);
}`),s.uniforms.add(new GS("blurSize",n=>n.blurSize),new xo("tex",n=>n.blurInputTexture)),s.code.add(g`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture(tex, uv);
if (blurCoordinate.z == 1.0) {
fragColor = center;
} else {
vec4 sum = center * 0.204164;
sum += texture(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture(tex, uv - blurSize * 3.294215) * 0.093913;
fragColor = sum;
}
}`),i}const v6=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:uf,build:S2},Symbol.toStringTag,{value:"Module"}));let R2=class O2 extends Ft{initializeProgram(e){return new Dt(e.rctx,O2.shader.get().build(),Pt)}initializePipeline(){return nt({colorWrite:lt})}};R2.shader=new Nt(v6,()=>he(()=>Promise.resolve().then(()=>J$),void 0));let E2=class A2 extends Ft{initializeProgram(e){return new Dt(e.rctx,A2.shader.get().build(),Pt)}initializePipeline(){return nt({colorWrite:lt})}};E2.shader=new Nt(g6,()=>he(()=>Promise.resolve().then(()=>eL),void 0));let b6=class extends di{constructor(){super(...arguments),this.color=Jr(1,0,1,1),this.haloColor=Jr(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.coverageRounding=Ju(1,1)}},Vc=class extends Eh{constructor(e){super(e),this._context=null,this._passParameters=new b6,this._downsampleDrawParameters=new hf,this._blurDrawParameters=new uf,this._blurColorFormat=li("mac")?si.RGBA:si.RGBA4,this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0},this.produces=new Map([[L.HIGHLIGHT,()=>!0]])}consumes(){return pb}initializeRenderContext(e){this._context=e,this._blurTechnique==null&&(this._blurTechnique=this._context.techniqueRepository.acquire(R2)),this._downsampleTechnique==null&&(this._downsampleTechnique=this._context.techniqueRepository.acquire(E2)),this._applyTechnique==null&&(this._applyTechnique=this._context.techniqueRepository.acquire(T2)),this.addHandles([A(()=>this.view.highlightOptions.color,t=>{this._passParameters.color=th(t??Kx),this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color),this._context.requestRender()},vt),A(()=>this.view.highlightOptions.haloColor,t=>{this._passParameters.haloColor=t!=null?th(t):this._passParameters.color,this._context.requestRender()},vt),A(()=>this.view.highlightOptions.haloOpacity,t=>{this._passParameters.haloOpacity=t??Jx,this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity,this._context.requestRender()},vt),A(()=>this.view.highlightOptions.fillOpacity,t=>{this._passParameters.fillOpacity=t??ew,this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity,this._context.requestRender()},vt)])}uninitializeRenderContext(){this._context=null}dispose(){this._blurTechnique=tt(this._blurTechnique),this._downsampleTechnique=tt(this._downsampleTechnique),this._applyTechnique=tt(this._applyTechnique),this._grid.coverage=tt(this._grid.coverage),this._grid.vao=Ae(this._grid.vao)}renderNode(e,t,r,s){var T,P;const n=(T=r==null?void 0:r.get("highlights"))==null?void 0:T.getTexture();if(!this._context||!n)return;if(!(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled))return void this._context.requestRender();const a=e.bindParameters.camera,o=a.fullWidth,l=a.fullHeight,c=a.pixelRatio,d=Math.ceil(o/c),u=Math.ceil(l/c),m=this._context.fbos,_=m.rctx;this._gridUpdateResources(n),this._gridComputeCoverage(n,e.bindParameters),this._passParameters.highlightTexture=n,this._passParameters.coverageTexture=(P=this._grid.coverage)==null?void 0:P.getTexture();const{width:f,height:y}=n.descriptor;sn(this._passParameters.coverageRounding,f/(Math.ceil(f/fs)*fs),y/(Math.ceil(y/fs)*fs));const b=this._grid.vao;_.bindVAO(b);const x=m.acquire(d,u,"highlight blur",this._blurColorFormat);_.unbindTexture(x.fbo.colorTexture),_.bindFramebuffer(x.fbo),_.setClearColor(0,0,0,0),_.clearSafe(Mi.COLOR_BUFFER_BIT),_.setViewport(0,0,d,u),this._blurDrawParameters.blurInputTexture=n,sn(this._blurDrawParameters.blurSize,1/d,0);const w=_.bindTechnique(this._blurTechnique,e.bindParameters,this._passParameters,this._blurDrawParameters);_.drawArrays(this._blurTechnique.primitiveType,0,Un(b,"geometry"));const C=m.acquire(d,u,"highlight blur",this._blurColorFormat);_.unbindTexture(C.fbo.colorTexture),_.bindFramebuffer(C.fbo),_.setClearColor(0,0,0,0),_.clearSafe(Mi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=x.getTexture(),sn(this._blurDrawParameters.blurSize,0,1/u),w.bindDraw(this._blurDrawParameters,e.bindParameters,this._passParameters),_.drawArrays(this._blurTechnique.primitiveType,0,Un(b,"geometry")),_.bindFramebuffer(s==null?void 0:s.fbo),_.setViewport4fv(a.fullViewport),this._passParameters.blurTexture=C.getTexture(),_.bindTechnique(this._applyTechnique,e.bindParameters,this._passParameters),_.drawArrays(this._applyTechnique.primitiveType,0,Un(b,"geometry")),x.release(),C.release()}_gridUpdateResources(e){var m;if(!this._context)return;const t=this._context.fbos.rctx,r=this._grid,s=Math.ceil(e.descriptor.height/fs),n=Math.ceil(e.descriptor.width/fs);if(r.vao&&r.verticalCellCount===s&&r.horizontalCellCount===n)return;r.verticalCellCount=s,r.horizontalCellCount=n;const a=s+1,o=n+1,l=1/s,c=1/n,d=new Float32Array(6*4*a*o);let u=0;for(let _=0;_<a;_++)for(let f=0;f<o;f++)d[u++]=(f-.5)*c*2-1,d[u++]=(_-.5)*l*2-1,d[u++]=f*c,d[u++]=_*l,d[u++]=(f+.5)*c*2-1,d[u++]=(_-.5)*l*2-1,d[u++]=f*c,d[u++]=_*l,d[u++]=(f-.5)*c*2-1,d[u++]=(_+.5)*l*2-1,d[u++]=f*c,d[u++]=_*l,d[u++]=(f-.5)*c*2-1,d[u++]=(_+.5)*l*2-1,d[u++]=f*c,d[u++]=_*l,d[u++]=(f+.5)*c*2-1,d[u++]=(_-.5)*l*2-1,d[u++]=f*c,d[u++]=_*l,d[u++]=(f+.5)*c*2-1,d[u++]=(_+.5)*l*2-1,d[u++]=f*c,d[u++]=_*l;(m=r.vao)==null||m.dispose(),r.vao=new jn(t,Pt,{geometry:Dh},{geometry:ur.createVertex(t,Nr.STATIC_DRAW,d)})}_gridComputeCoverage(e,t){var l;if(!this._context)return;const r=this._context.fbos.rctx,s=this._grid,n=e.descriptor,a=Math.ceil(n.width/fs),o=Math.ceil(n.height/fs);this._downsampleDrawParameters.input=e,(l=s.coverage)==null||l.release(),s.coverage=this._context.fbos.acquire(a,o,"highlight coverage",si.RG),r.unbindTexture(s.coverage.fbo.colorTexture),r.bindFramebuffer(s.coverage.fbo),r.bindTechnique(this._downsampleTechnique,t,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,a,o),r.screen.draw()}get test(){return{coverage:this._grid.coverage}}};h([p()],Vc.prototype,"_context",void 0),h([p()],Vc.prototype,"view",void 0),Vc=h([F("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Vc);let pf=class extends Ls{constructor(){super(...arguments),this.receiveShadows=!0}};h([$()],pf.prototype,"receiveShadows",void 0);const x6=.99999,w6=.025;function M2(i){const e=new Mt;e.include(pg,i),e.include(ig),e.include(Fr);const t=e.fragment;return t.include(Ro),t.include(bo),t.uniforms.add(new Be("defaultDepthTex",(r,s)=>s.shadowMap.getSnapshot(xu.ExcludeHighlight)),new Be("highlightDepthTex",(r,s)=>s.shadowMap.getSnapshot(xu.Highlight)),new Be("depthMap",(r,s)=>{var n;return(n=s.linearDepth)==null?void 0:n.getTexture()}),new Be("highlightTexture",r=>r.highlight),new Vn("uColor",r=>r.shadowColor),new $i("nearFar",(r,s)=>s.camera.nearFar),new Ne("opacity",r=>r.shadowOpacity),new Ne("occludedOpacity",r=>r.occludedShadowOpacity),new Ne("terminationFactor",r=>r.opacityElevation*r.dayNightTerminator),new Ai("lightingMainDirectionView",(r,s)=>oe(Qy,Xt(Qy,s.lighting.mainLight.direction,s.camera.viewInverseTransposeMatrix))),new Ki("inverseViewMatrix",(r,s)=>mu(Wy,sh(Wy,s.camera.viewMatrix,s.camera.center)))),t.constants.add("unoccludedHighlightFlag","vec4",GR),t.code.add(g`
    vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, ivec2 iuv) {
      float leftPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(-1, 0), 0), nearFar);
      float rightPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(1, 0), 0), nearFar);
      float bottomPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(0, -1), 0), nearFar);
      float topPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(0, 1), 0), nearFar);

      bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
      bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);

      vec3 fragCoordHorizontal = pickLeft
                                  ? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
                                  : vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
      vec3 fragCoordVertical = pickBottom
                                  ? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
                                  : vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);

      vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
      vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);

      vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
      // Flip normal depending on triangle winding order for consistency
      return pickLeft == pickBottom ? normal : -normal;
    }

    void main(void) {
      vec4 highlightInfo = texture(highlightTexture, uv);
      float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
      if (visiblyHighlighted > ${g.float(x6)}) {
        discard;
      }

      ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
      float depth = rgba2float(texelFetch(depthMap, iuv, 0));
      // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
      if (depth == 0.0) {
        discard;
      }

      float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
        discard;
      }

      vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
      vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

      mat4 shadowMatrix;
      float linearDepth = -currentPixelDepth;
      int i = chooseCascade(linearDepth, shadowMatrix);
      if (i >= numCascades) {
        discard;
      }

      vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

      // vertex completely outside? -> no shadow
      if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
        discard;
      }

      ivec2 texSize = textureSize(highlightDepthTex, 0);
      ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));

      float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
      bool shadowHighlight = depthHighlight < lvpos.z;
      if (!shadowHighlight) {
        discard;
      }

      float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
      bool shadowDefault = depthDefault < lvpos.z;

      vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, iuv);
      bool shaded = dot(normal, lightingMainDirectionView) < ${g.float(w6)};

      float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
      fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
    }
  `),e}const Wy=ct(),Qy=v(),C6=Object.freeze(Object.defineProperty({__proto__:null,build:M2},Symbol.toStringTag,{value:"Module"}));let T6=class extends ug{constructor(){super(...arguments),this.shadowColor=Jr(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},D2=class $2 extends Ft{constructor(e){super(e,new pf,()=>this.destroy())}initializeProgram(e){return new Dt(e.rctx,$2.shader.get().build(this.configuration),Pt)}initializePipeline(){return nt({blending:pr(Z.SRC_ALPHA,Z.ONE,Z.ONE_MINUS_SRC_ALPHA,Z.ONE_MINUS_SRC_ALPHA),colorWrite:lt,depthTest:null,depthWrite:null})}get primitiveType(){return Ti.TRIANGLE_STRIP}};D2.shader=new Nt(C6,()=>he(()=>Promise.resolve().then(()=>tL),void 0));const P6=.001953125,S6=4e4,R6=5e4;let hl=class extends Eh{constructor(i){super(i),this._maxOpacity=1,this._passParameters=new T6,this._shadowDifference=.2,this._context=null,this.produces=new Map([[L.SHADOW_HIGHLIGHT,()=>this._isVisible]])}consumes(){return pb}initializeRenderContext(i){this._context=i,this.addHandles([A(()=>this.view.highlightOptions.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??iw,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()},vt),A(()=>this.view.highlightOptions.shadowDifference,e=>{this._shadowDifference=e??rw,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()},vt),A(()=>this.view.highlightOptions.shadowColor,e=>{this._passParameters.shadowColor=th(e??tw),this._updateMaxOpacity()},vt)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const i=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=i*this._passParameters.shadowColor[3]}uninitializeRenderContext(){this._context=null}enable(){this._context&&this._technique==null&&(this._technique=this._context.techniqueRepository.acquire(D2))}renderNode(i,e,t,r){var o,l;const s=(o=t==null?void 0:t.get("highlights"))==null?void 0:o.getTexture();if(!this._context||!s||!this._isVisible)return;if(!((l=this._technique)!=null&&l.compiled))return void this._context.requestRender();const n=i.bindParameters;if(!n.shadowMap.enabled||!n.linearDepth)return;this._passParameters.highlight=s,this._passParameters.origin=n.camera.center;const a=i.rctx;a.bindFramebuffer(r==null?void 0:r.fbo),a.bindTechnique(this._technique,n,this._passParameters),a.screen.draw()}updateParameters(i,e){this._passParameters.opacityElevation=1-ih(S6,R6,i.relativeElevation);const t=this.viewingMode===Re.Global?oe(Zy,i.center):Ie(Zy,0,0,1),r=pe(t,e);this._passParameters.dayNightTerminator=ih(0,1,ie(30*r,0,1)),this._isVisible&&this.enable()}get _isVisible(){const{opacityElevation:i,dayNightTerminator:e}=this._passParameters;return this._maxOpacity*i*e>=P6}};h([p()],hl.prototype,"_context",void 0),h([p()],hl.prototype,"view",void 0),h([p()],hl.prototype,"viewingMode",void 0),hl=h([F("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],hl);const Zy=v(),Jo={maxSearchSteps:8,maxDistanceAreaTex:16};function L2(){const i=new Mt;return i.include(Fr),i.fragment.uniforms.add(new Be("edgesTexture",e=>e.inputTexture),new Be("areaTexture",e=>e.areaTexture),new Be("searchTexture",e=>e.searchTexture)),i.fragment.code.add(g`
    #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
    #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

    vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset, vec2 resolution) {
      return texture(tex, coord + offset.x * resolution, 0.0);
    }

    float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture( searchTex, e, 0.0 ).r;
    }

    float searchLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 0.0, 1.0 );
      for ( int i = 0; i < ${g.int(Jo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord -= vec2( 2.0, 0.0 ) * resolution;
        if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 0.0, 1.0 );
      for ( int i = 0; i < ${g.int(Jo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord += vec2( 2.0, 0.0 ) * resolution;
        if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
      return texcoord.x;
    }

    float searchUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 1.0, 0.0 );
      for ( int i = 0; i < ${g.int(Jo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord += vec2( 0.0, 2.0 ) * resolution;
        if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
      return texcoord.y;
    }

    float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 1.0, 0.0 );
      for ( int i = 0; i < ${g.int(Jo.maxSearchSteps)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord -= vec2( 0.0, 2.0 ) * resolution;
        if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
      return texcoord.y;
    }

    vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
      vec2 texcoord = float( ${g.int(Jo.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
      texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
      texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
      return texture( areaTex, texcoord, 0.0 ).rg;
    }

    void main() {
      vec2 size = vec2(textureSize(edgesTexture, 0));
      vec2 resolution = 1.0 / size;
      vec2 pixelCoord = uv * size;
      vec4 offsets[2];
      offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
      offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
      vec4 maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${g.int(Jo.maxSearchSteps)} );

      ivec4 subsampleIndices = ivec4(0.0);
      vec4 weights = vec4(0.0);
      vec2 e = texture( edgesTexture, uv ).rg;
      if ( e.g > 0.0 ) {
        vec2 d;
        vec2 coords;
        coords.x = searchLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x, resolution );
        coords.y = offsets[1].y;
        d.x = coords.x;
        float e1 = texture( edgesTexture, coords, 0.0 ).r;
        coords.x = searchRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y, resolution );
        d.y = coords.x;
        d = d * size.x - pixelCoord.x;
        vec2 sqrt_d = sqrt( abs(d) );
        coords.y -= 1.0 * resolution.y;
        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ), resolution).r;
        weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
      }

      if ( e.r > 0.0 ) {
        vec2 d;
        vec2 coords;
        coords.y = searchUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z, resolution );
        coords.x = offsets[0].x;
        d.x = coords.y;
        float e1 = texture( edgesTexture, coords, 0.0 ).g;
        coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w, resolution );
        d.y = coords.y;
        d = d * size.y - pixelCoord.y;
        vec2 sqrt_d = sqrt(abs(d));
        coords.y -= 1.0 * resolution.y;
        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0), resolution).g;
        weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

        // for some reason the following lines are necessary to prevent
        // texture lookup precision issues on some Intel integrated graphics chips
        vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
        weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
      }
      fragColor = weights;
    }`),i}const O6=Object.freeze(Object.defineProperty({__proto__:null,build:L2},Symbol.toStringTag,{value:"Module"}));let I2=class N2 extends Ft{initializeProgram(e){return new Dt(e.rctx,N2.shader.get().build(),Pt)}initializePipeline(){return nt({colorWrite:lt})}};I2.shader=new Nt(O6,()=>he(()=>Promise.resolve().then(()=>iL),void 0));function F2(){const i=new Mt;return i.include(Fr),i.fragment.uniforms.add(new Be("blendWeightsTexture",e=>e.inputTexture),new Be("colorTexture",e=>e.color)),i.fragment.code.add(g`void main() {
vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}
}`),i}const E6=Object.freeze(Object.defineProperty({__proto__:null,build:F2},Symbol.toStringTag,{value:"Module"}));let V2=class U2 extends Ft{initializeProgram(e){return new Dt(e.rctx,U2.shader.get().build(),Pt)}initializePipeline(){return nt({colorWrite:lt})}};V2.shader=new Nt(E6,()=>he(()=>Promise.resolve().then(()=>rL),void 0));const Xy={threshold:.05,localConstrastAdaption:2};function z2(){const i=new Mt;return i.include(Fr),i.fragment.uniforms.add(new Be("colorTexture",e=>e.color)),i.outputs.add("fragEdges","vec2"),i.fragment.code.add(g`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
      vec4 offsets[3];
      offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
      offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
      offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture(colorTexture, uv).rgb;

      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${g.float(Xy.threshold)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges *= step(maxDelta, float(${g.float(Xy.localConstrastAdaption)}) * delta.xy);

      fragEdges = edges;
    }
  `),i}const A6=Object.freeze(Object.defineProperty({__proto__:null,build:z2},Symbol.toStringTag,{value:"Module"}));let q2=class B2 extends Ft{initializeProgram(e){return new Dt(e.rctx,B2.shader.get().build(),Pt)}initializePipeline(){return nt({colorWrite:lt})}};q2.shader=new Nt(A6,()=>he(()=>Promise.resolve().then(()=>sL),void 0));let M6=class extends di{},Ka=class extends Eh{constructor(e){super(e),this._context=null,this._areaTexture=null,this._searchTexture=null,this._isEnabled=!1,this._smaaParameters=new M6,this.produces=new Map([[L.ANTIALIASING,()=>this._isEnabled&&this._context!=null]])}consumes(){return ub}get updating(){return this._abortController!=null}initializeRenderContext(e){this._context=e,this.addHandles([A(()=>this.view.qualitySettings.antialiasingEnabled,()=>this.renderFeatureChanged(),vt)])}renderFeatureChanged(){var e;this.view.qualitySettings.antialiasingEnabled||(e=this._context)!=null&&e.isFeatureEnabled(Ln.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable(),this._context=null}async enable(){var t;if(this._isEnabled||!this._context||this._abortController)return;if(this._edgeTechnique??(this._edgeTechnique=this._context.techniqueRepository.acquire(q2)),this._blendTechnique??(this._blendTechnique=this._context.techniqueRepository.acquire(I2)),this._blurTechnique??(this._blurTechnique=this._context.techniqueRepository.acquire(V2)),this._areaTexture&&this._searchTexture)return void(this._isEnabled=!0);this._abortController=new AbortController;const e=this._abortController.signal;try{const r=await he(()=>import("./SMAAData-DCEZ61Cs.js"),__vite__mapDeps([]));await this._loadTextures(this._context,r,e),(t=this._context)==null||t.requestRender()}catch{}this._abortController=null}async _loadTextures(e,t,r){if(Tr(r),!e)throw Ts();const[s,n]=await Promise.allSettled([_h(t.areaTexture,{signal:r}),_h(t.searchTexure,{signal:r})]);Tr(r),s.status==="fulfilled"&&n.status==="fulfilled"&&(this._areaTexture=Yy(e.fbos.rctx,Pr.LINEAR,hi.RGB,s.value),this._searchTexture=Yy(e.fbos.rctx,Pr.NEAREST,hi.LUMINANCE,n.value),this._isEnabled=!0)}_disposeTextures(){this._areaTexture=Ae(this._areaTexture),this._searchTexture=Ae(this._searchTexture)}disable(){this._abortController=So(this._abortController),this._isEnabled=!1}destroy(){this.disable(),this._disposeTextures()}renderNode(e,t,r,s){var m,_,f,y;const n=(m=r==null?void 0:r.get("composite-color"))==null?void 0:m.getTexture();if(!(this._isEnabled&&this._context&&r&&n))return s;if(!((_=this._edgeTechnique)!=null&&_.compiled&&((f=this._blendTechnique)!=null&&f.compiled)&&((y=this._blurTechnique)!=null&&y.compiled)))return this._context.requestRender(),s;const a=n.descriptor.width,o=n.descriptor.height,l=this._context.fbos,c=e.rctx;c.setViewport(0,0,a,o);const d=l.acquire(a,o,"smaa edges",si.RG);c.unbindTexture(d.fbo.colorTexture),c.bindFramebuffer(d.fbo),c.setClearColor(0,0,0,1),c.clear(Mi.COLOR_BUFFER_BIT),this._smaaParameters.color=n,c.bindTechnique(this._edgeTechnique,null,this._smaaParameters),c.screen.draw();const u=l.acquire(a,o,"smaa blend");return c.unbindTexture(u.fbo.colorTexture),c.bindFramebuffer(u.fbo),c.setClearColor(0,0,1,1),c.clear(Mi.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=d.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,c.bindTechnique(this._blendTechnique,null,this._smaaParameters),c.screen.draw(),c.bindFramebuffer(s==null?void 0:s.fbo),d.release(),c.setClearColor(0,1,0,1),c.clear(Mi.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=u.getTexture(),c.bindTechnique(this._blurTechnique,null,this._smaaParameters),c.screen.draw(),u.release(),s}};function Yy(i,e,t,r){const s=new ui;return s.pixelFormat=t,s.wrapMode=Ji.CLAMP_TO_EDGE,s.width=r.width,s.height=r.height,s.samplingMode=e,new Ci(i,s,r)}h([p()],Ka.prototype,"view",void 0),h([p()],Ka.prototype,"_context",void 0),h([p()],Ka.prototype,"_abortController",void 0),h([p({readOnly:!0})],Ka.prototype,"updating",null),Ka=h([F("esri.views.3d.webgl-engine.effects.smaa.SMAA")],Ka);let D6=class{constructor(){this._step=ev,this._dilation=1,this._firstIdleTime=Ye(0)}frame(e,t){if(t?this._firstIdleTime===0&&(this._firstIdleTime=Ye(performance.now())):this._firstIdleTime=Ye(0),li("disable-feature:high-quality-idle"))this._dilation=1;else{const s=t?performance.now()-this._firstIdleTime:0;if(s>=Ky+L6)return this._step=Ye(1/0),void(this._dilation=1);this._dilation=s>=Ky?I6:1}const r=ie(e/$6,ev,F6);this._step===1/0?this._step=Ye(r):this._step=Ye(this._step*Jy+r*(1-Jy))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=Ye(0)}};const $6=.5,Ky=Ye(12e4),L6=Ye(1e4),I6=10,Jy=.9,N6=30,ev=Ye(1e3/1),F6=Ye(1e3/N6);let V6=class{constructor(e,t){this._fbos=e,this.compositingHelper=t,this._width=4,this._height=4,this._clearColor=_i()}dispose(){this._color=tt(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(e,t,r){this._fbos.interactive=r===On.Default;const s=this._fbos.rctx;this._width=e.fullWidth,this._height=e.fullHeight,og(this,s.parameters.maxTextureSize);const n=this._color;return this._color=null,this.releaseBuffers(),W_(this._clearColor,t),n}releaseBuffers(){var e;(e=this._color)==null||e.detachDepth(),this._depth=tt(this._depth)}renderHUDVisibility(e,t,r){return(e==null?void 0:e.fbo.width)===this._width&&(e==null?void 0:e.fbo.height)===this._height||(e==null||e.release(),e=this._fbos.acquire(this._width,this._height,"hud visibility",si.RGBA4)),e.attachDepth(r||this.depth),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(U6),t(),e.detachDepth(),e}compositeToHUDVisibility(e,t){var r;this._fbos.rctx.bindFramebuffer((r=e.hudVisibility)==null?void 0:r.fbo),this.compositingHelper.compositeHUD(e,t)}renderOITPass(e,t,r){let s,n;const{_width:a,_height:o}=this;switch(t){case ti.Color:s=this._fbos.acquire(a,o,r?"oit hud color":"oit color",si.RGBA16F),n=[0,0,0,0];break;case ti.Alpha:s=this._fbos.acquire(a,o,r?"oit hud alpha":"oit alpha",si.R16F),n=[1,1,1,1];break;case ti.FrontFace:s=this._fbos.acquire(a,o,r?"oit hud front":"oit front"),n=[0,0,0,0]}return r?s.acquireDepth(or.DEPTH16_BUFFER):s.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(s.fbo),this._fbos.rctx.clearFramebuffer(n,r,r),e(),s.detachDepth(),s}compositeToFramebuffer(e,t,r,s){this.bindFbo(),this.compositingHelper.composite(e,t,r,s)}compositeTransparentOntoOpaque(e,t,r,s,n){n?(this._fbos.rctx.bindFramebuffer(n.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clearSafe(Mi.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(e,t.getTexture(),r.getTexture(),s.getTexture())}renderDepthDetached(e){this._bindTarget(this.color),e(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(e,t,r,s,n=si.RGBA,a=or.DEPTH16_BUFFER,o=this._width,l=this._height,c=null){return(e==null?void 0:e.fbo.width)===o&&(e==null?void 0:e.fbo.height)===l||(e=tt(e)),e=e??this._fbos.acquire(o,l,t,n),c==null||c.forEach(d=>e.acquireColor(d.attachment,d.format)),a!=null&&e.acquireDepth(a),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(s,!0,!0),r(),e}renderToTargets(e,t,r,s,n=!1,a=!1){this._bindTarget(t,r),this._fbos.rctx.clearFramebuffer(s,n,a),e(),t.detachDepth()}bindFbo(){const e=this._color==null;if(this._bindTarget(this.color,this.depth),e){const t=this._fbos.rctx;t.setClearStencil(0),t.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),t.clearSafe(Mi.COLOR_BUFFER_BIT|Mi.DEPTH_BUFFER_BIT|Mi.STENCIL_BUFFER_BIT)}}_bindTarget(e,t){e.attachDepth(t),this._fbos.rctx.bindFramebuffer(e.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(e,t){const r=this._ensureColor();r.attachDepth(this.depth),r.setName(t),this._color=e(r)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(or.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}};const U6=[0,1,0,1],Nh=255,z6=1/Nh;function H2(i){const e=new Mt,t=e.fragment;return t.include(Ro),t.include(bo),e.include(ig),e.include(Fr),e.include(pg,i),t.uniforms.add(new Be("shadowMap",(r,s)=>s.shadowMap.depthTexture),new Be("depthMap",(r,s)=>{var n;return(n=s.linearDepth)==null?void 0:n.getTexture()}),new Ki("inverseViewMatrix",(r,s)=>mu(tv,sh(tv,s.camera.viewMatrix,s.camera.center))),new $i("nearFar",(r,s)=>s.camera.nearFar)),t.constants.add("sampleValue","float",z6),e.outputs.add("sampleCount","float"),t.code.add(g`void main(void) {
float depth = rgba2float(texture(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
ivec2 texSize = textureSize(shadowMap, 0);
ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));
float depthShadow = readShadowMapDepth(uvShadow, shadowMap);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
sampleCount = sampleValue;
}`),e}const tv=ct(),q6=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Nh,build:H2},Symbol.toStringTag,{value:"Module"}));let mf=class extends di{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=Bv(B6),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}};const B6=Jr(.01,0,.25,1);function G2(i){const e=new Mt,t=e.fragment;t.include(Ro),t.include(bo),e.include(ig),e.include(Fr);const{visualization:r,bandsEnabled:s}=i;t.constants.add("inverseSampleValue","float",Nh),t.uniforms.add(new Be("shadowCastMap",o=>o.shadowCastMap),new Ne("sampleScale",o=>o.sampleScale),new Ne("opacityFromElevation",o=>o.opacityFromElevation),new Vn("uColor",o=>o.color));const n=r===y0.Gradient,a=r===y0.Threshold;return n&&s?t.uniforms.add(new Ne("bandSize",o=>o.bandSize)):a&&t.uniforms.add(new Ne("threshold",o=>o.threshold)),t.code.add(g`
    void main(void) {
      float record = texture(shadowCastMap, uv).r;
      float pixelSamples = record * inverseSampleValue;
      if (pixelSamples < 1.0) {
        discard;
      }

      float strength = pixelSamples * sampleScale;

      ${a?g`
          if (strength <= threshold) {
            discard;
          }`:""}

      ${n&&s?g`strength = ceil(strength / bandSize) * bandSize;`:""}

      fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?g`* strength`:""});
    }
  `),e}const H6=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:mf,build:G2},Symbol.toStringTag,{value:"Module"}));let k2=class j2 extends Ft{constructor(e,t){super(e,t,()=>this.destroy())}initializeProgram(e){return new Dt(e.rctx,j2.shader.get().build(this.configuration),Pt)}initializePipeline(){return nt({blending:wb,colorWrite:lt,depthTest:null,depthWrite:null})}get primitiveType(){return Ti.TRIANGLE_STRIP}};k2.shader=new Nt(H6,()=>he(()=>Promise.resolve().then(()=>nL),void 0));const G6=4e4,k6=5e4,W2=1/512;let lu=class extends Pe{constructor(e,t,r,s){super({}),this._techniqueRepository=e,this._rctx=t,this._data=r,this._requestRender=s,this._passParameters=new mf(this._data),this._techniqueConfig=new cS,this._enabled=!1,this._vao=un(t)}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=Ae(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(k2,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,Un(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>W2}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;nT(e,t)||(W_(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};h([p()],lu.prototype,"opacityFromElevation",null),lu=h([F("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],lu);let Q2=class Z2 extends Ft{constructor(e){super(e,new pf,()=>this.destroy())}initializeProgram(e){return new Dt(e.rctx,Z2.shader.get().build(this.configuration),Pt)}initializePipeline(){return nt({blending:pr(Z.ONE,Z.ONE,Z.ONE,Z.ONE),colorWrite:lt,depthTest:null,depthWrite:null})}get primitiveType(){return Ti.TRIANGLE_STRIP}};Q2.shader=new Nt(q6,()=>he(()=>Promise.resolve().then(()=>aL),void 0));let rr=class extends Pe{constructor(i,e,t,r,s,n){super({}),this.fbos=i,this._stage=t,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._progress=0,this._sampleCount=0,this._passParameters=new ug,this._cachedLightDirections=[],this._depthRange=F_,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=i.rctx,this._bindParameters=new ng(new Pb(i,t.viewingMode),null),this._bindParameters.shadowMap.enabled=!0,this._vao=un(this._rctx),this._accumulationRenderer=new lu(e,this._rctx,this,n);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(fi.SHADOW_ACCUMULATOR,this),A(()=>t.renderView,o=>{this.removeHandles(iv),o!=null&&this.addHandles(o.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),iv)},vt),A(()=>this._previewing,()=>this._requestRenderIfEnabled(),st)],this._shadowAccumulatorKey)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=Ae(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=Ae(this._fbo),this._vao=Ae(this._vao),this._accumulationTechniqueCached=tt(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){var i;return(i=this._fbo)==null?void 0:i.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(this._accumulationTechniqueCached==null){const i={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new Q2(i)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._fbo!=null&&this._sampleCount>0}get canAccumulate(){var i;return((i=this._bindParameters.linearDepth)==null?void 0:i.getTexture())!==null&&this._depthRange!==F_&&this._opacityFromElevation>W2}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(i){const e=this._cachedLightDirections;if(j_(e,i,ah))return;const t=Math.min(Nh,i.length);e.length=t,this._sampleCount=t;for(let r=0;r<t;++r)e[r]=le(e[r]??v(),i[r]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(i){this._accumulationRenderer.opacityFromElevation=i}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(i){for(this._prepareForShadowMapPass(this._bindParameters);!i.done&&!this._isDoneAccumulating;)this._accumulateShadow(),i.madeProgress();this._requestRender()}renderAccumulation(i,e,t,r){if(this._depthRange=e,this._updateCamera(t),this._bindParameters.contentCamera=r,this._bindParameters.linearDepth=i,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(j6,this._sampleCount-this._progress);for(let n=0;n<s;++n)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(i){this._accumulationRenderer.render(i)}setOptions(i){if(i.enabled!==void 0){const e=this._fbo!=null;i.enabled!==e&&(i.enabled?this._enable():this._disable())}i.previewing!==void 0&&(this._previewing=i.previewing),i.lightDirections!==void 0&&(this._lightDirections=i.lightDirections),this._accumulationRenderer.setOptions(i)}readAccumulatedShadow(i,e){return!this._isActive||!this._fbo||this._progress<1||i<0||i>=this._fbo.width||e<0||e>=this._fbo.height?0:(this._fbo.readPixels(i,e,1,1,hi.RED,ga.UNSIGNED_BYTE,rv),rv[0]/this._progress)}_enable(){this._progress=0;const i=new ui;i.pixelFormat=hi.RED,i.internalFormat=Gl.R8,i.wrapMode=Ji.CLAMP_TO_EDGE,this._fbo=new Mh(this._rctx,i),this._requestRender()}_disable(){this._fbo=Ae(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Mi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const i=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(i,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,Un(this._vao,"geometry"))}_updateCamera(i){const e=this._fbo;if(e==null)return;const t=this._bindParameters.camera;i.equals(t)||t.copyFrom(i),e.resize(i.fullWidth,i.fullHeight),this._opacityFromElevation=1-ih(G6,k6,i.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){const i=this;return{lightDirections:this._lightDirections,get isDone(){return i._isDoneAccumulating},get isActive(){return i._isActive}}}};h([p()],rr.prototype,"_progress",void 0),h([p()],rr.prototype,"_sampleCount",void 0),h([p()],rr.prototype,"_fbo",void 0),h([p()],rr.prototype,"_depthRange",void 0),h([p()],rr.prototype,"_previewing",void 0),h([p()],rr.prototype,"_accumulationRenderer",void 0),h([p()],rr.prototype,"_isRefining",null),h([p()],rr.prototype,"_isActive",null),h([p()],rr.prototype,"canAccumulate",null),h([p()],rr.prototype,"_isDoneAccumulating",null),h([p()],rr.prototype,"_opacityFromElevation",null),h([p()],rr.prototype,"running",null),rr=h([F("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],rr);const j6=6,iv="renderView",rv=new Uint8Array(1),sv=Yu();let W6=class{constructor(){this._plane=Yu()}get isEnabled(){return!UT(this.plane,sv)}get plane(){return this._plane}set plane(e){Z_(e||sv,this._plane)}};function Q6(i,e){const t=-i[0],r=-i[1],s=-i[2],n=e[3],a=e[7],o=e[11],l=e[15];e[0]+=n*t,e[1]+=n*r,e[2]+=n*s,e[4]+=a*t,e[5]+=a*r,e[6]+=a*s,e[8]+=o*t,e[9]+=o*r,e[10]+=o*s,e[12]+=l*t,e[13]+=l*r,e[14]+=l*s}function Z6(i,e){const t=i[0],r=i[1],s=i[2];e[12]+=t*e[0]+r*e[4]+s*e[8],e[13]+=t*e[1]+r*e[5]+s*e[9],e[14]+=t*e[2]+r*e[6]+s*e[10],e[14]+=t*e[3]+r*e[7]+s*e[11]}let X6=class{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const t=this._originData.get(e.id)||new Y6(e);return t.refCount++,this._originData.has(t.origin.id)||this._originData.set(t.origin.id,t),t}release(e){e.refCount--,e.refCount===0&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach(t=>{Bl(t.viewMatrix,e),Z6(t.origin.vec3,t.viewMatrix)})}},Y6=class{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=ct()}},K6=class extends _P{constructor(e,t){super(),this.distanceFalloffFactor=e,this.transparency=t,this.transformNormalViewFromGlobal=$s()}},J6=class extends gP{constructor(){super(...arguments),this.transformNormalViewFromGlobal=$s(),this.slicePlaneLocalOrigin=v(),this.transformNormalGlobalFromModel=$s()}};function e$(i){const e=g`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;i.code.add(e)}const t$=Ju(.5,-4e-4);function i$(i,e){const t=i.vertex;t.include(e$),t.constants.add("depthBias","vec2",t$),t.uniforms.add(new $i("inverseViewport",(r,s)=>s.inverseViewport)),e.legacy?(t.uniforms.add(new Ki("proj",(r,s)=>s.camera.projectionMatrix)),t.code.add(g`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(t.uniforms.add(new eg("transformNormalViewFromGlobal",r=>r.transformNormalViewFromGlobal),new Ki("transformProjFromView",r=>r.transformProjFromView)),t.code.add(g`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),t.code.add(g`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function r$(i){const e=i.fragment;e.constants.add("coverageTestThreshold","float",.01),e.code.add(g`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`)}function s$(i,e){const t=i.vertex;e.silhouette?(t.code.add(g`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),e.legacy?t.code.add(g`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {
vec3 viewNormalA = _modelToViewNormal(data.normal);
vec3 viewNormalB = _modelToViewNormal(data.normal2);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):t.code.add(g`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {
vec3 worldNormalA = _modelToWorldNormal(data.normal);
vec3 worldNormalB = _modelToWorldNormal(data.normal2);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):t.code.add(g`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {
return false;
}`)}function n$(i,e){const t=i.vertex;t.include(Ro),i.include(ob,e),t.uniforms.add(new Ne("distanceFalloffFactor",r=>r.distanceFalloffFactor)),t.code.add(g`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),t.uniforms.add(new xo("componentDataTex",r=>r.componentDataTexture)),i.attributes.add(ae.COMPONENTINDEX,"float"),t.constants.add("componentColorFieldOffset","float",0),t.constants.add("componentOtherFieldOffset","float",1),t.constants.add("componentVerticalOffsetFieldOffset","float",2),t.constants.add("componentFieldCount","float",3),t.constants.add("lineWidthFractionFactor","float",8),t.constants.add("extensionLengthOffset","float",128),t.constants.add("verticalOffsetScale","float",2*nf),t.code.add(g`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
      float texSize = float(textureSize(componentDataTex, 0).x);
      float colIndex = mod(fieldIndex, texSize);
      float rowIndex = floor(fieldIndex / texSize);

      return vec2(colIndex, rowIndex) + 0.5;
    }

    struct ComponentData {
      vec4 color;
      vec3 normal;
      vec3 normal2;
      float lineWidth;
      float extensionLength;
      float type;
      float verticalOffset;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);
      vec3 normal = normalModel();
      vec3 normal2 = ${e.silhouette?g`decompressNormal(normal2Compressed)`:g`normal`};

      vec4 colorValue = texelFetch(componentDataTex, ivec2(colorIndex), 0);
      vec4 otherValue = texelFetch(componentDataTex, ivec2(otherIndex), 0);
      float verticalOffset = (rgba2float(texelFetch(componentDataTex, ivec2(verticalOffsetIndex), 0)) - 0.5) * verticalOffsetScale;

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        normal, normal2,
        otherValue.x * (255.0 / lineWidthFractionFactor),
        otherValue.y * 255.0 - extensionLengthOffset,
        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
        verticalOffset
      );
    }
  `),e.legacy?t.code.add(g`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(t.uniforms.add(new l0("transformNormalGlobalFromModel",r=>r.transformNormalGlobalFromModel)),t.code.add(g`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),e.silhouette?(i.attributes.add(ae.NORMAL2COMPRESSED,"vec2"),t.code.add(g`vec3 worldNormal(ComponentData data) {
return _modelToWorldNormal(normalize(data.normal + data.normal2));
}`)):t.code.add(g`vec3 worldNormal(ComponentData data) {
return _modelToWorldNormal(data.normal);
}`),e.legacy?t.code.add(g`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(t.include(fP,e),t.uniforms.add(new eg("transformViewFromCameraRelativeRS",r=>r.transformViewFromCameraRelativeRS),new l0("transformWorldFromModelRS",r=>r.transformWorldFromModelRS),new c0("transformWorldFromModelTL",r=>r.transformWorldFromModelTL),new c0("transformWorldFromModelTH",r=>r.transformWorldFromModelTH),new Ai("transformWorldFromViewTL",r=>r.transformWorldFromViewTL),new Ai("transformWorldFromViewTH",r=>r.transformWorldFromViewTH)),t.code.add(g`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${e.spherical?g`normalize(transformWorldFromModelTL + rotatedModelPosition);`:g`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),t.uniforms.add(new Ki("transformProjFromView",(r,s)=>s.camera.projectionMatrix)),t.code.add(g`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),t.code.add(g`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function a$(i){return i.mode===ii.SKETCH||i.mode===ii.MIXED}var ii,oo;(function(i){i[i.SOLID=0]="SOLID",i[i.SKETCH=1]="SKETCH",i[i.MIXED=2]="MIXED",i[i.COUNT=3]="COUNT"})(ii||(ii={})),function(i){i[i.REGULAR=0]="REGULAR",i[i.SILHOUETTE=1]="SILHOUETTE"}(oo||(oo={}));function _f(i,e){const t=i.vertex;switch(i.attributes.add(ae.SIDENESS,"vec2"),e.mode===ii.MIXED?t.code.add(g`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):t.code.add(g`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),e.mode){case ii.MIXED:t.code.add(g`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case ii.SKETCH:t.code.add(g`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case ii.SOLID:t.code.add(g`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case ii.COUNT:break;default:ba(e.mode)}}function o$(i,e){const t=i.vertex;switch(i.include(_f,e),e.mode){case ii.SOLID:t.code.add(g`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case ii.SKETCH:t.uniforms.add(new Sl("strokesAmplitude",r=>r.strokesTexture.amplitude)),t.code.add(g`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case ii.MIXED:t.uniforms.add(new Sl("strokesAmplitude",r=>r.strokesTexture.amplitude)),t.code.add(g`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function l$(i,e){i.include(_f,e);const{vertex:t,fragment:r}=i;switch(a$(e)&&(t.uniforms.add(new xo("strokesTexture",s=>s.strokesTexture.texture)),t.uniforms.add(new Sl("strokesLog2Resolution",s=>Math.log2(s.strokesTexture.resolution)),new Sl("strokeVariants",s=>s.strokesTexture.variants)),i.varyings.add("vStrokeUV","vec2"),r.uniforms.add(new xo("strokesTexture",s=>s.strokesTexture.texture),new Sl("strokesNormalizationScale",s=>s.strokesTexture.normalizationScale)),t.code.add(g`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) / vec2(textureSize(strokesTexture, 0));
vStrokeUV.x += variantOffset;
}`),i.fragment.include(Ro),r.code.add(g`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),e.mode){case ii.SOLID:t.code.add(g`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(g`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case ii.SKETCH:t.code.add(g`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(g`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case ii.MIXED:i.varyings.add("vType","float"),t.code.add(g`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(g`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function X2(i){const e=new Mt,{vertex:t,fragment:r}=e;return i.legacy&&t.uniforms.add(new nv("model"),new nv("localView")),e.include(i$,i),e.include(n$,i),e.include(o$,i),e.include(_f,i),e.include(l$,i),e.include(cb,i),e.include(s$,i),e.include(r$,i),e.include(Ym,i),e.varyings.add("vColor","vec4"),e.varyings.add("vRadius","float"),e.varyings.add("vPosition","vec3"),e.varyings.add("vWorldPosition","vec3"),i.multipassEnabled&&e.varyings.add("vViewPos","vec3"),e.varyings.add("vLineLengthPixels","float"),e.varyings.add("vSizeFalloffFactor","float"),t.uniforms.add(new $i("pixelToNDC",(s,n)=>sn(c$,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new Vn("viewport",(s,n)=>n.camera.fullViewport),new Ne("pixelRatio",(s,n)=>n.camera.pixelRatio)),e.attributes.add(ae.POSITION0,"vec3"),e.attributes.add(ae.POSITION1,"vec3"),e.attributes.add(ae.VARIANTOFFSET,"float"),e.attributes.add(ae.VARIANTSTROKE,"float"),e.attributes.add(ae.VARIANTEXTENSION,"float"),t.code.add(g`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      ${i.multipassEnabled?"vViewPos = viewPos;":""}

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 ndcToPixel = viewport.zw * 0.5;
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

      const float aaPaddingPixels = 1.0;

      // Line size with padding
      float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
      float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard short edges below a certain length threshold
      ${i.mode===ii.SKETCH?g`
        if (lineLengthPixels <= 3.0) {
          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return;
        }`:i.mode===ii.MIXED?g`
        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {
           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
           return;
        }`:""}
      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0, component)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(component), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),r.code.add(g`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float positionX = position.x - calculateLineOffset();

      if (radius < 1.0) {
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);
        return vec2(0.5 - min(coverageX, coverageY), 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${i.multipassEnabled?"terrainDepthTest(vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      fragColor = vec4(vColor.rgb, vColor.a * coverage);
    }
  `),e}const c$=Di();class nv extends Hl{constructor(e){super(e,"mat4")}}const h$=Object.freeze(Object.defineProperty({__proto__:null,build:X2},Symbol.toStringTag,{value:"Module"}));class pp extends Ft{initializeProgram(e){return new Dt(e.rctx,pp.shader.get().build(this.configuration),Bb)}initializePipeline(e){return nt({blending:pr(Z.ONE,Z.ONE,Z.ZERO,Z.ONE,yb.ADD,e.rctx.gl.MAX),depthTest:{func:Hi.LEQUAL},colorWrite:lt})}}pp.shader=new Nt(h$,()=>he(()=>Promise.resolve().then(()=>oL),void 0));let ps=class extends tg{constructor(){super(...arguments),this.mode=ii.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.doublePrecisionRequiresObfuscation=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.spherical=!1}};h([$({count:ii.COUNT})],ps.prototype,"mode",void 0),h([$()],ps.prototype,"hasSlicePlane",void 0),h([$()],ps.prototype,"silhouette",void 0),h([$()],ps.prototype,"legacy",void 0),h([$()],ps.prototype,"doublePrecisionRequiresObfuscation",void 0),h([$()],ps.prototype,"multipassEnabled",void 0),h([$()],ps.prototype,"cullAboveGround",void 0),h([$()],ps.prototype,"spherical",void 0),h([$({constValue:!1})],ps.prototype,"occlusionPass",void 0),h([$({constValue:Dr.Compressed})],ps.prototype,"normalType",void 0);const d$=8,Am=128,u$={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},p$={solid:ii.SOLID,sketch:ii.SKETCH,uber:ii.MIXED};class eh{constructor(e,t,r){this._rctx=e,this._shaderTechniqueRepository=t,this._configuration=new ps,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[Le.TRANSPARENT]:{[Le.TRANSPARENT]:new xt,[Le.OPAQUE]:new xt},[Le.OPAQUE]:{[Le.TRANSPARENT]:new xt,[Le.OPAQUE]:new xt}},this._renderablesDirty=!1,this._drawParameters=new J6,this._settings={...u$,...r},this.key=eh.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:dr.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=p$[this._settings.type],this._configuration.silhouette=!1,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=r.spherical}dispose(){this._technique=tt(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,t){this._renderablesDirty&&this._sortRenderables();const r=this._sortedRenderables[t];r[Le.TRANSPARENT].forAll(e),r[Le.OPAQUE].forAll(e)}updateTechnique(e,t){return this._configuration.multipassEnabled=!!e.multipassEnabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(pp,this._configuration,this._technique),this._technique}bindRegularEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!1),t,e)}bindSilhouetteEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!0),t,e)}renderRegularEdges(e,t,r,s,n){this._render(e,t,t.regular.vao,r,s,n)}renderSilhouetteEdges(e,t,r,s,n){this._render(e,t,t.silhouette.vao,r,s,n)}_render(e,t,r,s,n,a){a>0&&(this._bindDraw(e,t,s,n),this._rctx.bindVAO(r),this._rctx.drawArraysInstanced(Ti.TRIANGLE_FAN,0,4,a))}_bindDraw(e,t,r,s){if(this._drawParameters.componentDataTexture=t.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in t.transform)this._lastOriginId!==t.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",t.transform.origin.viewMatrix),this._lastOriginId=t.transform.origin.origin.id),e.setUniformMatrix4fv("model",t.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=t.transform.origin.origin.vec3;else{const n=new dp(t.transform.position),a=kl(av,Ah(av,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=n.low,this._drawParameters.transformWorldFromModelTH=n.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=a;const o=s.camera.viewInverseTransposeMatrix;Ie(this._drawParameters.slicePlaneLocalOrigin,o[3],o[7],o[11])}e.bindDraw(this._drawParameters,s,r)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[Le.TRANSPARENT][Le.TRANSPARENT].clear(),this._sortedRenderables[Le.TRANSPARENT][Le.OPAQUE].clear(),this._sortedRenderables[Le.OPAQUE][Le.TRANSPARENT].clear(),this._sortedRenderables[Le.OPAQUE][Le.OPAQUE].clear(),this._renderables.forEach(t=>{t.objectTransparency!==Le.INVISIBLE&&t.edgeTransparency!==Le.INVISIBLE&&this._sortedRenderables[t.objectTransparency][t.edgeTransparency].push(t)});const e=(t,r)=>"origin"in t.transform?"origin"in r.transform?t.transform.origin.origin.id<r.transform.origin.origin.id?-1:t.transform.origin.origin.id>r.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[Le.TRANSPARENT][Le.TRANSPARENT].sort(e),this._sortedRenderables[Le.TRANSPARENT][Le.OPAQUE].sort(e),this._sortedRenderables[Le.OPAQUE][Le.TRANSPARENT].sort(e),this._sortedRenderables[Le.OPAQUE][Le.OPAQUE].sort(e)}static getKey(e,t,r){return`edges-t:${e}:${t}:${r}`}}const av=e3();function m$(i){const t=gc.resolution,r=t/2,s=new Uint8Array(4*t*t),n=4*t*r,a=gc.amplitude,o=2*a,l=4*t,c=Math.log2(t)+1,d=gc.strokes.length;let u=(c-1)*d*l;for(const{distance:_,pressure:f}of gc.strokes){let y=_,b=f,x=u;for(let w=0;w<c;w++){w!==0&&(y=ov(y,Rh.DISTANCE),b=ov(b,Rh.PRESSURE));for(let C=0;C<gc.resolution;C++){const T=.5+(y?y[C%y.length]/o:0),P=b?b[C%b.length]:1;n_(T,s,x),n_(P,s,x+n),x+=4}x-=l*(d+1)}u+=l}const m=new Ci(i,new ui(t),s);return new g$(t,o,a,d,m)}function ov(i,e){if(!i)return null;const t=i.length/2,r=_$*t,s=new Array(t);let n=0;const a=e===Rh.PRESSURE;for(let o=0;o<i.length;o+=2){const l=(i[o]+i[o+1])/2;s[n++]=a?Math.min(r,1-(1-l)*lv):Math.min(r,l*lv)}return s}var Rh;(function(i){i[i.DISTANCE=0]="DISTANCE",i[i.PRESSURE=1]="PRESSURE"})(Rh||(Rh={}));const _$=.1,lv=.5;let g$=class{constructor(e,t,r,s,n){this.resolution=e,this.normalizationScale=t,this.amplitude=r,this.variants=s,this.texture=n}dispose(){this.texture=Ae(this.texture)}};const gc={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function cv(i){let e=null;for(const t of i){const r=t.type;if(f$(t)){if(e==null)e=r;else if(e!==r)return"uber"}}return e??"uber"}function hv(i){let e=Le.INVISIBLE;for(const{material:t}of i)if(Y2(t)){if(t.color[3]*t.opacity<1)return Le.TRANSPARENT;e=Le.OPAQUE}return e}function dv(i){let e=Le.INVISIBLE;for(const{material:t}of i)if(Y2(t)){switch(t.objectTransparency){case Le.TRANSPARENT:case Le.INVISIBLE:return Le.TRANSPARENT;case Le.OPAQUE:if(t.opacity<1)return Le.TRANSPARENT}e=Le.OPAQUE}return e}function Y2(i){return i.size*i.color[3]*i.opacity>0}function f$(i){return i.size*i.color[3]>0}function uv(i,e,t,r){for(let s=0;s<i.length;s++){const n=i[s].index,a=e[s],o=e[s+1];if(r)for(let l=a;l<o;l++){const c=r[l];t.set(c,n)}else for(let l=a;l<o;l++)t.set(l,n)}}let ms=class extends Pe{constructor(i){super(i),this._updatingHandles=new ip,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=v(),this._localOrigins=new X6(new Cb(i.renderSR))}initialize(){this._worker=new VR(this.schedule),this._componentColorManager=new c2(this.rctx,3);const i=MR.createBuffer(4);for(let e=0;e<4;e++)i.sideness.set(e,0,e===0||e===3?0:1),i.sideness.set(e,1,e===0||e===1?0:1);this._verticesBufferObject=ur.createVertex(this.rctx,Nr.STATIC_DRAW,i.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach(i=>this._discardObjectEntry(i)),this._perObjectData.clear(),this._strokesTexture=Ae(this._strokesTexture),this._componentColorManager=te(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=Ae(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",w$))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(i,e,t,r,s,n){if(this.hasObject(i))return this.getObjectMemoryUsage(i);let a;const o=new mv(new Promise(c=>a=c),i.obb.center,i.obb.radius);this._perObjectData.set(i,o);const l=await this._updatingHandles.addPromise(this._addComponentGeometry(i.transform,o,e,t,r,s,n));return this.setNeedsRender(),a(),l}async addOrUpdateObject3D(i,e,t,r){if(this.destroyed)return void de.getLogger(this).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(i);let n;(s==null?void 0:s.renderables.length)>0&&this._perObjectDataEvictionCache.add(s);const a=i.boundingVolumeWorldSpace.bounds,o=new mv(new Promise(c=>n=c),At(a),pS(a));this._perObjectData.set(i,o);const l=new Array;if(t.mergeGeometries&&i.geometries.length>1&&y$(i))l.push(this._addObjectMergedGeometries(i,o,e,t,r));else for(let c=0;c<i.geometries.length;c++){const d=i.geometries[c];d.material.supportsEdges&&l.push(this._addGeometry(i,o,d,e[0],t,r))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(o),this._discardObjectEntry(s),this.setNeedsRender(),n()}fastUpdateObject3DEdgesTransform(i){if(this.destroyed)return!1;const e=this._perObjectData.get(i);if(!e)return!1;const{geometries:t}=i,{renderables:r}=e;if(t.length===0||r.length===0)return!0;if(r.length>1)return!1;const[s]=r,n=s.transform;if(!(n instanceof Mm))return!1;const[a]=t;if(a.localOrigin!==n.origin.origin)return!1;const o=ct(),l=this._computeModelTransformWithLocalOrigin(i,a,o);return s.transform=new Mm(o,l),this.setNeedsRender(),!0}_discardObjectEntry(i){i&&(i.renderables.length&&(i.renderables.forEach(e=>this._removeRenderable(e)),this.setNeedsRender()),i.loaded=null)}hasObject(i){return this._perObjectData.has(i)}async updateAllComponentOpacities(i,e){const t=await this._updatingHandles.addPromise(this._getObjectEntry(i));if(t==null)return;const r=e instanceof Array?s=>e[s]:()=>e;t.renderables.forEach(s=>{const n=s.components.meta.length;for(let a=0;a<n;a++){const o=r(a),l=s.components.meta[a],c=l.index;l.material.opacity=o,s.components.buffer.textureBuffer.setDataElement(c,1,3,255*o)}this._updateTransparency(s)}),this.setNeedsRender()}async getObjectMemoryUsage(i){const e=await this._getObjectEntry(i);return e!=null?e.renderables.reduce((t,r)=>t+r.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(i,e,t,r){const s=i instanceof zP,n=!!t.hasSlicePlane,a=cv(e),o=eh.getKey(a,n,s),l=await this._updatingHandles.addPromise(this._getObjectEntry(i));l!=null&&(l.renderables.forEach(c=>{if(o!==c.rendererKey){const d=this._renderers.get(c.rendererKey),u=this._acquireRenderer(a,n,s);d.removeRenderable(c),--d.refCount,c.rendererKey=o,u.addRenderable(c)}for(let d=0;d<e.length;d++)c.components.meta[d].material=e[d];r&&this._updateComponentBuffer(c.components),this._updateTransparency(c)}),this.setNeedsRender())}async updateAllVerticalOffsets(i,e){const t=await this._updatingHandles.addPromise(this._getObjectEntry(i));t!=null&&(t.renderables.forEach(r=>{const s=r.components.meta;for(let n=0;n<s.length;n++)r.components.meta[n].verticalOffset=(e==null?void 0:e[n])??0;this._updateComponentBuffer(r.components)}),this.setNeedsRender())}async updateObjectVisibility(i,e){const t=await this._updatingHandles.addPromise(this._getObjectEntry(i));t!=null&&(t.renderables.forEach(r=>r.visible=e),this.setNeedsRender())}removeObject(i){const e=this._perObjectData.get(i);e&&(this._perObjectData.delete(i),this._discardObjectEntry(e))}async _getObjectEntry(i){const e=this._perObjectData.get(i);if(!e)throw new Error("no object");return await e.loaded,e.loaded==null?null:e}render(i,e){if(this._componentColorManager==null)return;this._localOrigins.updateViewMatrices(i.camera.viewMatrix);const t=i.camera.viewInverseTransposeMatrix,r=v(),s=new dp;let n=0,a=0;if(this._renderers.forEach(l=>{if(l.refCount===0)return this._renderers.delete(l.key),void l.dispose();let c=!0,d=!0;l.forEachRenderable(u=>{u.visible&&(n+=u.statistics.averageEdgeLength,a++,c&&u.regular&&(l.updateTechnique(i,!1),c=!1),d&&u.silhouette&&(l.updateTechnique(i,!0),d=!1))},e)}),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),a===0)return;const o=new K6(40*n/a,e);Ie(r,t[3],t[7],t[11]),s.set(r),le(o.transformWorldFromViewTH,s.high),le(o.transformWorldFromViewTL,s.low),ag(o.transformViewFromCameraRelativeRS,i.camera.viewMatrix),kl(yv,o.transformViewFromCameraRelativeRS),Ah(o.transformNormalViewFromGlobal,yv),o.transformProjFromView=i.camera.projectionMatrix,this._updateObjectCameraDistances(i),this._renderers.forEach(l=>{this._renderRegularEdges(l,i,o),this._renderSilhouetteEdges(l,i,o)})}_updateTransparency(i){const e=hv(i.components.meta),t=dv(i.components.meta);e===i.edgeTransparency&&t===i.objectTransparency||(i.edgeTransparency=e,i.objectTransparency=t,this._renderers.get(i.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(i,e,t){i.getCombinedShaderTransformation(e,t);const r=e.localOrigin!=null?this._localOrigins.register(e.localOrigin):this._localOrigins.acquire(Ie(this._tmpModelPosition,t[12],t[13],t[14]));return e.localOrigin=r.origin,Q6(r.origin.vec3,t),r}_updateComponentBuffer(i){const{meta:e,buffer:t}=i,r=new Uint8Array(4);for(let s=0;s<e.length;s++){const n=e[s].material,a=e[s].index,o=ie(Math.round(n.size*d$),0,255),l=ie(n.extensionLength,-Am,255-Am)+Am,c=n.type==="solid"?M0.SOLID:M0.SKETCH,d=255*n.opacity,u=n.color,m=255*u[0],_=255*u[1],f=255*u[2],y=255*u[3];t.textureBuffer.setData(a,0,m,_,f,y),t.textureBuffer.setData(a,1,o,l,c,d),r2(e[s].verticalOffset,r),t.textureBuffer.setData(a,2,r[0],r[1],r[2],r[3])}}_createComponentBuffers(i){if(this._componentColorManager==null)return null;const e=new Array,t=this._componentColorManager.getBuffer(i.length);for(let s=0;s<i.length;s++){const n=i[s],a=t.acquireIndex();e.push({index:a,verticalOffset:0,material:n})}const r=new v$(t,e);return this._updateComponentBuffer(r),r}_extractEdges(i,e,t,r,s,n=s.length){return this._worker.process({data:e,indices:s,indicesLength:n,writerSettings:i,skipDeduplicate:t},this._workerAbort.signal,r)}_createRenderable(i,e,t,r,s){const n=c=>this._verticesBufferObject!=null?new b$(new jn(this.rctx,Bb,{vertices:DR,instances:c===oo.REGULAR?$R.glLayout:LR.glLayout},{vertices:this._verticesBufferObject,instances:ur.createVertex(this.rctx,Nr.STATIC_DRAW,c===oo.REGULAR?i.regular.instancesData.buffer:i.silhouette.instancesData.buffer)}),c===oo.REGULAR?i.regular.lodInfo:i.silhouette.lodInfo):null,a=i.regular.lodInfo.lengths.length>0?n(oo.REGULAR):null,o=i.silhouette.lodInfo.lengths.length>0?n(oo.SILHOUETTE):null,l=((a==null?void 0:a.vao.usedMemory)??0)+((o==null?void 0:o.vao.usedMemory)??0);return new x$(a,o,{gpuMemoryUsage:l,externalMemoryUsage:s,averageEdgeLength:i.averageEdgeLength},t,hv(e.meta),dv(e.meta),e,r)}async _addGeometry(i,e,t,r,s,n){if(t.edgeIndicesLength<=0)return;const a=t.attributes.get(ae.POSITION),o=ct(),l=this._computeModelTransformWithLocalOrigin(i,t,o),c=new fv(a,o,l);return this._addPositionData(e,c,t.edgeIndicesLength,r,s,n)}async _addPositionData(i,e,t,r,s,n=!1){if(i.loaded==null)return;const a=this._createComponentBuffers([r]);if(a==null)return;const o=this._acquireRenderer(r.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:c}=e,d=e.position.indices,u=e.position,m=u.data.length/u.size,_=s_.createBuffer(m);for(let b=0;b<m;b++)_.position.set(b,0,u.data[b*u.size]),_.position.set(b,1,u.data[b*u.size+1]),_.position.set(b,2,u.data[b*u.size+2]);uv(a.meta,[0,_.componentIndex.count],_.componentIndex);const f=await this._updatingHandles.addPromise(this._extractEdges(o.writerSettings,_,!1,n,d,t));if(i.loaded==null)return;const y=this._createRenderable(f,a,new Mm(l,c),o.key,!1);i.renderables.push(y),o.addRenderable(y),this._gpuMemoryUsage+=y.statistics.gpuMemoryUsage}async _addComponentGeometry(i,e,t,r,s,n,a){if(e.loaded==null)return 0;const o=this._createComponentBuffers(n);if(o==null)return 0;const l=cv(n),c=this._acquireRenderer(l,a.hasSlicePlane||!1,!1),d=s_.createBuffer(t.length/3);Vb(d.position.typedBuffer,t,d.position.typedBufferStride,3),uv(o.meta,s,d.componentIndex,r);const u=!0,m=c.writerSettings,_=await this._updatingHandles.addPromise(this._extractEdges(m,d,u,!1,r));if(e.loaded==null)return 0;const f=this._createRenderable(_,o,i,c.key,!0);return e.renderables.push(f),c.addRenderable(f),f.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(i,e,t,r,s){const n=new Map;let a=0,o=null,l=0;const c=i.geometries.filter(w=>{if(w.edgeIndicesLength<=0||!w.material.supportsEdges)return!1;!o&&w.localOrigin&&(o=w);const C=w.attributes.get(ae.POSITION);return l+=C.data.length/C.size,a+=w.edgeIndicesLength,!0});if(c.length===0)return;const d=l>=65536?Uint32Array:Uint16Array,u=a?new d(a):null,m=[];let _=0;c.forEach(w=>{const C=w.attributes.get(ae.POSITION),T=C.indices;let P=n.get(C.data);if(P==null){P=m.length/3;for(let S=0;S<C.data.length;S+=C.size)m.push(C.data[S]),m.push(C.data[S+1]),m.push(C.data[S+2]);n.set(C.data,P)}for(let S=0;S<w.edgeIndicesLength;S++)u[_++]=P+T[S]});const f=o||i.geometries[0],y=ct(),b=this._computeModelTransformWithLocalOrigin(i,f,y);for(let w=0;w<i.geometries.length;w++)i.geometries[w].localOrigin=b.origin;const x=new fv(new PR(m,u,3),y,b);await this._updatingHandles.addPromise(this._addPositionData(e,x,u.length,t[0],r,s))}_acquireRenderer(i,e,t){const r=eh.getKey(i,e,t);let s=this._renderers.get(r);return this._strokesTexture==null&&(this._strokesTexture=m$(this.rctx)),s||(s=new eh(this.rctx,this.techniqueRepository,{type:i,hasSlicePlane:e,strokesTexture:this._strokesTexture,legacy:t,spherical:this.viewingMode===Re.Global}),this._renderers.set(r,s)),++s.refCount,s}_removeRenderable(i){pv(i.regular),pv(i.silhouette);const e=this._renderers.get(i.rendererKey);if(e){e.removeRenderable(i),--e.refCount,"origin"in i.transform&&this._localOrigins.release(i.transform.origin),this._gpuMemoryUsage-=i.statistics.externalMemoryUsage?0:i.statistics.gpuMemoryUsage;for(const t of i.components.meta)i.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(i){const e=i.camera.eye,t=i.camera.viewForward,r=v(),s=n=>{zt(r,n.center,e);const a=pe(r,t),o=n.radius,l=a<-o?1/0:a<o?0:a-o;n.renderables.forEach(c=>c.distanceToCamera=l)};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(i,e,t){const r=i.bindRegularEdges(t,e),s=t.transparency,n=e.camera.perScreenPixelRatio;i.forEachRenderable(a=>{if(!_v(a)||!a.visible)return;const o=Ad(a.regular.lod.lengths,a.distanceToCamera,n);i.renderRegularEdges(r,a,t,e,o)},s)}_renderSilhouetteEdges(i,e,t){const r=i.bindSilhouetteEdges(t,e),s=t.transparency,n=e.camera.perScreenPixelRatio;i.forEachRenderable(a=>{if(!gv(a)||!a.visible)return;const o=Ad(a.silhouette.lod.lengths,a.distanceToCamera,n);i.renderSilhouetteEdges(r,a,t,e,o)},s)}get test(){return{hasRenderedPrimitives:i=>{let e=!1;const t=i.perScreenPixelRatio,r=(s,n)=>s.forEachRenderable(a=>{a.visible&&!e&&(_v(a)&&(e=Ad(a.regular.lod.lengths,a.distanceToCamera,t)>0),!e&&gv(a)&&(e=Ad(a.silhouette.lod.lengths,a.distanceToCamera,t)>0))},n);return this._renderers.forEach(s=>{e||(r(s,Le.OPAQUE),r(s,Le.TRANSPARENT))}),e},getObjectData:i=>this._perObjectData.get(i)}}};function pv(i){i!=null&&(i.vao.vertexBuffers.instances.dispose(),i.vao.disposeVAOOnly(),i.vao=null)}function y$(i){let e=null,t=null;for(let r=0;r<i.geometries.length;r++){const s=i.geometries[r];if(s.material.supportsEdges){if(e){if(!j_(e,s.transformation))return!1}else e=s.transformation;if(t||s.localOrigin==null){if((t==null?void 0:t.localOrigin)!=null&&s.localOrigin!=null&&t.localOrigin.id!==s.localOrigin.id)return!1}else t=s}}return!0}h([p({constructOnly:!0})],ms.prototype,"rctx",void 0),h([p({constructOnly:!0})],ms.prototype,"renderSR",void 0),h([p({constructOnly:!0})],ms.prototype,"viewingMode",void 0),h([p({constructOnly:!0})],ms.prototype,"techniqueRepository",void 0),h([p({constructOnly:!0})],ms.prototype,"setNeedsRender",void 0),h([p({constructOnly:!0})],ms.prototype,"schedule",void 0),h([p({readOnly:!0})],ms.prototype,"_updatingHandles",void 0),h([p({readOnly:!0})],ms.prototype,"updating",null),ms=h([F("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],ms);class mv{constructor(e,t,r){this.radius=r,this.renderables=new Array,this.loaded=e,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)}),this.center=Hn(t)}}class v${constructor(e,t){this.buffer=e,this.meta=t}}class b${constructor(e,t){this.vao=e,this.lod=t}}class Mm{constructor(e,t){this.modelMatrix=e,this.origin=t}}class x${constructor(e,t,r,s,n,a,o,l){this.regular=e,this.silhouette=t,this.statistics=r,this.transform=s,this.edgeTransparency=n,this.objectTransparency=a,this.components=o,this.rendererKey=l,this.distanceToCamera=0,this.visible=!0}}function _v(i){return i.regular!=null}function gv(i){return i.silhouette!=null}function Ad(i,e,t){const r=e*t,s=aT(i,r,!0);return s===-1?r<i[0]?i.length:0:i.length-s}let fv=class{constructor(e,t,r){this.position=e,this.modelTransform=t,this.origin=r}};const yv=$s(),w$=()=>Promise.reject();function C$(i,e){const t=i.capabilities.disjointTimerQuery;return t==null?null:new T$(t,e)}class T${constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(r=>{const s=this._timer.createQuery(),n=this._timer.createQuery();this._queryPool.push(s,n),this._queryResults.set(r,null)})}start(){UR||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(t==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const r=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,r}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}}var ot;(function(i){i.OVERLAY="overlay",i.PREPARE="prepare",i.SHADOW_MAP="shadow map",i.LINEAR_DEPTH="linear depth",i.ACCUMULATED_SHADOWS="accumulated shadows",i.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",i.NORMALS="normals",i.SSAO="SSAO",i.OPAQUE="opaque",i.OPAQUE_EDGES="opaque edges",i.VOXEL="voxel",i.TRANSPARENT="transparent",i.TRANSPARENT_EDGES="transparent edges",i.HUD_VISIBILITY="HUD visibility",i.TRANSPARENT_TERRAIN="transparent terrain",i.ENVIRONMENT="environment",i.LASER_LINES="laser lines",i.OCCLUDED="occluded",i.ANTIALIASING="antialiasing",i.HIGHLIGHTS="highlights",i.HUD="HUD",i.HUD_OCCLUDED="HUD occluded",i.FINISH="finish"})(ot||(ot={}));const vv="Total";let P$=class{constructor(e){this._rctx=e,this._startTimeStampCPU=Ye(0),this._lastTimeStampCPU=Ye(0),this._totalCPUTime=new zh(vv),this._cpuTimeSamplers=new Map(Object.values(ot).map(t=>[t,new zh(t)])),this._enableGPUTimer=0,this._totalGPUTime=new zh("GPU"),this._gpuTimeSamplers=new Map(Object.values(ot).map(t=>[t,new zh(t)])),this._totalTime=Ye(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return Ye(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){const t=[...Object.values(ot),vv];this._gpuTimerPool=C$(this._rctx,t)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=Ae(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=Ye(performance.now()),this._gpuTimerPool&&this._gpuTimerPool.start()}advance(e){const t=Ye(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const r=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(r),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const t=this._gpuTimerPool.stop(ot.FINISH);this._gpuTimeSamplers.get(ot.FINISH).record(t),this._rctx.gl.flush()}const e=Ye(performance.now()-this._startTimeStampCPU);this._totalTime=Ye(this._totalTime+e),this._totalCPUTime.record(e),this._gpuTimerPool&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((t,r)=>t+(r.last||0),0)),++this._totalFrameCount}};class dl{constructor(e,t,r,s,n,a,o,l){this._stage=e,this._techniqueRepository=s,this._rctx=n,this._compositingHelper=a,this._magnifierHelper=o,this._requestRender=l,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=c=>{},this._isRendering=!1,this._backgroundColor=Jr(0,0,0,1),this._sliceHelper=new W6,this._state=Hc(Wi.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=Zi.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new D6,this._reprojectionMatrixVersion=Hc(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Map,this._releaseNormals=c=>{var d;(d=c.find(({name:u})=>u==="normals"))!=null&&d.release()&&this._pluginInput.delete("normals")},this._debugLinearDepth=!1,this.fboCache=new p6(n),this._renderStateFeatures=Hc(Rp(!li("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new V6(this.fboCache,this._compositingHelper),this.performanceInfo=new P$(this._rctx),this._shadowMap=new Pb(this.fboCache,e.viewingMode),this._highlight=new Vc({view:e.view}),this._shadowHighlight=new hl({view:e.view,viewingMode:e.viewingMode}),this._shadowAccumulator=new rr(this.fboCache,s,e,c=>{const d=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(c.camera,c.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=d},(c,d,u)=>{const m=this._stage.view.qualitySettings.maximumPixelRatio;c.shadowMap.start(c.camera,d,u,!0,m),this._renderShadowCascades(E.Shadow,c.shadowMap),c.shadowMap.finish(),c.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(c.camera,c.contentCamera)},l),this._ssao=new kS({view:this._stage.view}),this._renderContext=new qP(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new m6(this._renderContext),this._plugins=new _6({renderContext:this._renderContext,techniqueRepository:s,textureRepository:r,materialRepository:t,requestRender:l,controller:e,fbos:this.fboCache,isFeatureEnabled:c=>this.isFeatureEnabled(c)}),this.renderPassManager=new q_,this._plugins.add(this.renderPassManager),this._smaa=new Ka({view:this._stage.view}),this._plugins.add(this._smaa),this._blit=new cl({opacity:1,alphaMode:qi.None}),this._plugins.add(this._blit),this._plugins.add(this._ssao),this._plugins.add(this._highlight),this._plugins.add(this._shadowHighlight),this._handles=[A(()=>this._stage.view.state.camera,()=>l(),vt),A(()=>dr.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,c=>{this._renderHiddenTransparentEdges=c?()=>this._renderEdges(Le.TRANSPARENT):()=>{},l()},oi),A(()=>{var c;return(c=this._stage.view.environment.background)==null?void 0:c.color},c=>{const d=c?th(c):B_;xa(this._backgroundColor,d[0]*d[3],d[1]*d[3],d[2]*d[3],d[3]),l()},vt)]}destroy(){this._handles.forEach(e=>e.remove()),this._gpuTimerHandle=Bn(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._highlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=te(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),FR.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(e=null,t=!li("disable-feature:high-quality-idle")){this._renderStateFeatures.value=Rp(t,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,r){this._renderStateFeatures.mutate(s=>s.set(t,e,r)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Ln.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(Ln.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations}get hasHighlights(){return this._plugins.produces(L.OPAQUE_MATERIAL,E.Highlight)||this._plugins.produces(L.TRANSPARENT_MATERIAL,E.Highlight)||this._plugins.produces(L.DRAPED_MATERIAL,E.Highlight)}get _magnifierEnabled(){return this._bindParameters.decorations===Cs.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(Ln.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=tt(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.linearDepth=tt(this._bindParameters.multipassTerrain.linearDepth),this._bindParameters.multipassGeometry.linearDepth=tt(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.linearDepth=tt(this._bindParameters.linearDepth),this._bindParameters.hudVisibility=tt(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||this._edgeView!=null&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}ensureEdgeView(){if(this._edgeView==null){const e=this._stage.view.resourceController;this._edgeView=new ms({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:S$(e)}),this._handles.push(A(()=>{var t;return(t=this._edgeView)==null?void 0:t.updating},()=>this._requestRender(),st)),this._requestRender()}return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&oT(this._bindParameters.ssr.reprojectionMatrix,Bc)}set _reprojectionMatrix(e){lT(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){var e;return!!((e=this._shadowMap)!=null&&e.enabled)}setParameters(e){var s;const{_shadowMap:t,_bindParameters:r}=this;if(((s=e.qualitySettings)==null?void 0:s.reflections)!==void 0&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),e.shadowMap!==void 0&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),e.environment!=null){e.environment.weather!=null&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const n=e.environment.lighting.type!=="virtual";r.enableFillLights!==n&&(r.enableFillLights=n,this._requestRender())}e.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),e.hasOverlayWater!==void 0&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),e.slicePlane!==void 0&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),e.terrainTransparency!==void 0&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),e.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:s,updates:n}=e;if(r.length===0&&s.length===0&&n.length===0)return;const a=BP(e);let o=!1;a.forEach((l,c)=>{if(t.done)return;let d=this._plugins.getMaterialRenderer(c);if(d==null&&l.adds.length>0){const u=new HP({material:c});u.initializeRenderContext(this._plugins._context),d=u,this._plugins.add(d)}d&&(d.modify(l),d.numGeometries===0&&(o=!0)),l.removes.forEach(u=>e.removes.removeUnordered(u)),l.adds.forEach(u=>e.adds.removeUnordered(u)),l.updates.forEach(u=>e.updates.removeUnordered(u)),t.madeProgress()}),o&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(L.LINE_CALLOUTS_HUD_DEPTH)||this._plugins.produces(L.HUD_MATERIAL)||this._plugins.produces(L.LABEL_MATERIAL),e.water=this._plugins.produces(L.DRAPED_WATER,E.Normal),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const t=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e),this._hasAnimations=this._nodes.updateAnimation()||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?Bn(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,r=On.Default,s=Cs.ON){this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const n=this._offscreen,{camera:a,contentCamera:o,mode:l,alignPixelEnabled:c}=e;this._state.value=l,this._bindParameters.overlay=this.renderOverlay(t),this.performanceInfo.advance(ot.OVERLAY),this._renderContext.time=t,this._bindParameters.transparencyPassType=ti.NONE,this._bindParameters.alignPixelEnabled=c,this._bindParameters.decorations=s,this._bindParameters.mainColor=this._bindParameters.mainDepth=null;const d=Yu(this._sliceHelper.plane);s===Cs.OFF&&(this._sliceHelper.plane=null),a.setGLViewport(this._rctx);const u=n.initializeFrame(a,this._backgroundColor,r);this.hasReflections?this._bindParameters.ssr.lastFrameColor=u:u==null||u.release(),this._ensureBindParametersCamera(a,o),this._plugins.prepareRender(),this.performanceInfo.advance(ot.PREPARE);const m=this._computeDepthRange(a);this._renderShadowMap(a,this._bindParameters.lighting.mainLight.direction,m),this.performanceInfo.advance(ot.SHADOW_MAP),this._ensureBindParametersCamera(a,o);const _=this._plugins.produces(L.OPAQUE_TERRAIN)&&(this._terrainTransparency===Zi.Semitransparent||this._terrainTransparency===Zi.TransparentWithDraped),f=this._highQualityTransparency&&_,y=this._plugins.produces(L.TRANSPARENT_MATERIAL,E.Color);this._prepareShaders(f,y),this._pluginInput.set("normals",this._renderNormals()),this.performanceInfo.advance(ot.NORMALS),this._renderSSAO(),this.performanceInfo.advance(ot.SSAO),this._renderLinearDepth(),this.performanceInfo.advance(ot.LINEAR_DEPTH),this._renderShadowAccumulation(m,a,o),this.performanceInfo.advance(ot.ACCUMULATED_SHADOWS),this._ensureBindParametersSSR(t),this._renderContext.output=E.Color,n.bindFbo(),this._bindParameters.mainColor=n.colorTexture,this._bindParameters.mainDepth=n.depthTexture,this._renderOpaqueGeometry(),this._offscreen.updateColor(R=>this._invokeRenderNodes(R),"opaque-color"),this._plugins.render(L.ENVIRONMENT_OPAQUE),this.performanceInfo.advance(ot.OPAQUE),this.fboCache.debugCallback&&this.fboCache.debugCallback("opaque-color",this._offscreen.color.fbo),this._renderTerrainLinearDepth(f),this._setMultipassTerrain(f),this._renderEdges(Le.OPAQUE),this.performanceInfo.advance(ot.OPAQUE_EDGES),n.bindFbo(),this._plugins.render(L.VOXEL),this.performanceInfo.advance(ot.VOXEL),this._renderHiddenTransparentEdges(),y&&(this._oitEnabled?this._renderOITPass(wl.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor(R=>this._invokeRenderNodes(R),"transparent-color"),this.performanceInfo.advance(ot.TRANSPARENT);const b=this._renderGeometryLinearDepth(f);this._renderHUDVisibility(b),f||this._plugins.render(L.LINE_CALLOUTS),this.performanceInfo.advance(ot.HUD_VISIBILITY);const x=r===On.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this.performanceInfo.advance(ot.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(Le.TRANSPARENT,b),b==null||b.release(),this.performanceInfo.advance(ot.TRANSPARENT_EDGES);const w=_?this._renderTransparentTerrain():null;w&&this._bindParameters.hudVisibility&&(f?this._renderLineCallouts(yn.Occluded):n.compositeToHUDVisibility(this._bindParameters,w.getTexture()),this._renderHUD(yn.Occluded,n.color),this.performanceInfo.advance(ot.HUD_OCCLUDED)),this.performanceInfo.advance(ot.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),w&&(n.compositeToFramebuffer(this._bindParameters,w.getTexture(),qi.PremultipliedAlpha,1),w.release(),f&&(this._renderEdges(Le.OPAQUE),this.performanceInfo.advance(ot.OPAQUE_EDGES),y&&(this._oitEnabled?this._renderOITPass(wl.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(ot.TRANSPARENT),this._renderEdges(Le.TRANSPARENT),this.performanceInfo.advance(ot.TRANSPARENT_EDGES))),this._bindParameters.ssao=tt(this._bindParameters.ssao),f&&this._renderLineCallouts(yn.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),n.bindFbo(),this._plugins.render(L.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.render(L.ENVIRONMENT_TRANSPARENT),this.performanceInfo.advance(ot.ENVIRONMENT),this._renderLaserlines(),this.performanceInfo.advance(ot.LASER_LINES),this._renderOccluded(),this.performanceInfo.advance(ot.OCCLUDED);let C=this._renderHighlightPrepass();C&&this._renderShadowHighlights(C,this._bindParameters);const T=this._magnifierEnabled&&r===On.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"magnifier"):null,P=r!==On.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"screenshot"):null,S=this._renderComposite(T??P,C)??P;return this.performanceInfo.advance(ot.ANTIALIASING),this._renderHUD(yn.NotOccluded,S),this.performanceInfo.advance(ot.HUD),C&&(this._renderHighlights(S,C,this._bindParameters),C=tt(C)),this.performanceInfo.advance(ot.HIGHLIGHTS),this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters),S!==P&&(this._rctx.bindFramebuffer(P==null?void 0:P.fbo),this._compositingHelper.composite(this._bindParameters,T==null?void 0:T.getTexture(),qi.None)),r===On.Default&&(T==null||T.release()),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=d,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),r!==On.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:P,oid:x}}_prepareShaders(e,t){this._renderContext.output=E.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(L.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(L.LINE_CALLOUTS),t&&this._prepareTransparencySlots(),this._plugins.prepare(L.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.prepare(L.ENVIRONMENT_TRANSPARENT),this._plugins.prepare(L.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!li("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,t=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return t.acquireDepth(or.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(E.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=yn.NotOccluded,this._plugins.render(L.HUD_MATERIAL),this._renderContext.output=e,t}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,r=e===jt.BACKGROUND;if(r||t){const s=r?this.performanceInfo.elapsedTime:0,n=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),a=Math.max(s,n);this._animationTimestep.frame(a,r)}}readDepthPixels(e,t,r){var o;const s=(o=this._bindParameters.linearDepth)==null?void 0:o.fbo;if(s!=null&&s.colorTexture)return void s.readPixels(t[0],t[1],t[2],t[3],hi.RGBA,ga.UNSIGNED_BYTE,r);const n=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"depth").acquireDepth(or.DEPTH16_BUFFER);this._rctx.bindFramebuffer(n.fbo),this._ensureBindParametersCamera(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const a=Mi.COLOR_BUFFER_BIT|Mi.DEPTH_BUFFER_BIT|Mi.STENCIL_BUFFER_BIT;this._rctx.clearSafe(a),this._renderAllGeometry(E.LinearDepth),n.fbo.readPixels(t[0],t[1],t[2],t[3],hi.RGBA,ga.UNSIGNED_BYTE,r),n.release()}readHUDVisibility(e,t,r,s,n){var a;(a=this._bindParameters.hudVisibility)==null||a.fbo.readPixels(e,t,r,s,hi.RGBA,ga.UNSIGNED_BYTE,n)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e,t){const r=this._edgeView;if(r!=null&&r.shouldRender()){const{width:s,height:n,depth:a}=this._offscreen,o=this.fboCache.acquire(s,n,"edges"),l=()=>r.render(this._bindParameters,e);this._offscreen.renderToTargets(l,o,t??a,bv),this._offscreen.compositeToFramebuffer(this._bindParameters,o.getTexture(),qi.Alpha,1),o.release()}}_renderShadowMap(e,t,r){const s=this._shadowMap;s.enabled&&(s.start(e,t,r,this.isFeatureEnabled(Ln.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,t),this._needsShadowHighlight?(this._renderShadowCascades(E.ShadowHighlight,this._shadowMap),s.moveSnapshot(xu.Highlight),this._renderShadowCascades(E.ShadowExcludeHighlight,this._shadowMap),s.copySnapshot(xu.ExcludeHighlight),this._renderShadowCascades(E.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(E.Shadow),s.finish(),e.setGLViewport(this._rctx))}_renderShadowCascades(e,t=this._shadowMap){for(const r of t.cascades)r.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(r.camera,r.camera),this._renderAllGeometry(e)}get _needsLinearDepth(){return this._plugins.consumes(E.LinearDepth)||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugLinearDepth}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,"linear-depth",()=>this._renderAllGeometry(E.LinearDepth),[0,0,0,0],si.RGBA,or.DEPTH_STENCIL_TEXTURE),this._bindParameters.linearDepth.detachDepth()):this._bindParameters.linearDepth=tt(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(e){if(e){const t=this._renderContext.output;this._renderContext.output=E.LinearDepth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,"terrain depth",()=>this._renderTransparentTerrain(),[-1e10,-1e10,-1e10,1]),this._bindParameters.multipassTerrain.linearDepth.detachDepth(),this._renderContext.output=t}else this._bindParameters.multipassTerrain.linearDepth=tt(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.linearDepth=tt(this._bindParameters.multipassGeometry.linearDepth));const t=this._renderContext.output;this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,"geometry depth",()=>this._renderOpaqueGeometryAndTransparentMaterial(E.LinearDepth),[1,1,1,1]),this._renderContext.output=t;const r=this._bindParameters.multipassGeometry.linearDepth.getAttachment(e_);return r==null||r.retain(),this._bindParameters.multipassGeometry.linearDepth.detachDepth(),r}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return F_;const t=Z8(e,this._plugins.plugins,this._stage.layers);return zl(t,this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderNormals(){const e=this._plugins.produces(L.SSAO),t=this._nodes.require("normals","composite-color")+this._nodes.require("normals","opaque-color")+this._nodes.require("normals","transparent-color");let r=(e?1:0)+t+(e||t>0?this._nodes.optional("normals","composite-color")+this._nodes.optional("normals","opaque-color")+this._nodes.optional("normals","transparent-color"):0);if(r===0)return;const s=this._offscreen.renderToCachedFBO(null,"normals",()=>this._renderGeometryForSSAO(E.Normal),[0,0,0,0],si.RGBA,or.DEPTH_STENCIL_TEXTURE);for(;--r>0;)s.retain();return s}_renderSSAO(){const e=this._pluginInput.get("normals");this._plugins.produces(L.SSAO)&&e&&(this._bindParameters.ssao=this._plugins.render(L.SSAO,this._pluginInput),e.detachDepth(),e.release()&&this._pluginInput.delete("normals"))}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(L.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(L.TRANSPARENT_MATERIAL),this._plugins.prepare(L.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(L.INTEGRATED_MESH),this._plugins.render(L.OPAQUE_TERRAIN),this._plugins.render(L.OPAQUE_MATERIAL),this._plugins.render(L.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_prepareOpaqueGeometry(){this._plugins.prepare(L.INTEGRATED_MESH),this._plugins.prepare(L.OPAQUE_TERRAIN),this._plugins.prepare(L.OPAQUE_MATERIAL),this._plugins.prepare(L.OPAQUE_NO_SSAO_DEPTH),this._plugins.prepare(L.ENVIRONMENT_OPAQUE)}_renderOpaqueGeometry(){this._plugins.render(L.INTEGRATED_MESH),this._plugins.render(L.OPAQUE_TERRAIN),this._plugins.render(L.OPAQUE_MATERIAL),this._plugins.render(L.OPAQUE_NO_SSAO_DEPTH)}_renderTransparentMaterial(){this._plugins.render(L.TRANSPARENT_MATERIAL),this._plugins.render(L.TRANSPARENT_NO_SSAO_DEPTH)}_renderTransparentTerrain(){if(!this._plugins.produces(L.TRANSPARENT_TERRAIN))return;const e=()=>this._plugins.render(L.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==E.Color)return void e();const{width:t,height:r,depth:s}=this._offscreen,n=this.fboCache.acquire(t,r,"transparent terrain");return this._offscreen.renderToTargets(e,n,s,[0,0,0,0]),n}_renderHUDVisibility(e){this._plugins.produces(L.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,()=>this._plugins.render(L.OCCLUSION_PIXELS),e),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=tt(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===yn.Occluded){const t=()=>{this._plugins.render(L.LINE_CALLOUTS)},{width:r,height:s,color:n}=this._offscreen,a=this.fboCache.acquireDepth(or.DEPTH16_BUFFER,r,s,"line callouts");this._offscreen.renderToTargets(t,n,a,void 0,!0,!0),a.release()}else this._plugins.render(L.LINE_CALLOUTS)}_renderLaserlines(){if(this._plugins.render(L.LASERLINES),this._plugins.produces(L.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:t,height:r,depth:s}=e,n=this.fboCache.acquire(t,r,"laser lines"),a=()=>this._plugins.render(L.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(a,n,s,bv),e.compositeToFramebuffer(this._bindParameters,n.getTexture(),qi.PremultipliedAlpha,1),n.release()}}_renderHUD(e,t){if(this._pluginsHas.hudElements)if(this._oitEnabled){const r=this._renderOITPass(wl.HUD,e);this._rctx.bindFramebuffer(t==null?void 0:t.fbo),this._compositingHelper.composite(this._bindParameters,r.getTexture(),qi.PremultipliedAlpha),r.release()}else if(e===yn.Occluded){this._renderContext.output=E.Color;const r=()=>this._renderHUDElements(e),{width:s,height:n,color:a}=this._offscreen,o=this.fboCache.acquireDepth(or.DEPTH16_BUFFER,s,n,"hud");this._offscreen.renderToTargets(r,a,o,void 0,!0,!0),o.release()}else this._renderContext.output=E.Color,this._rctx.bindFramebuffer(null),t==null||t.acquireDepth(or.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t==null?void 0:t.fbo),this._renderHUDElements(e),t==null||t.detachDepth()}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(L.LINE_CALLOUTS_HUD_DEPTH),this._plugins.prepare(L.HUD_MATERIAL),this._plugins.prepare(L.LABEL_MATERIAL),this._plugins.render(L.LINE_CALLOUTS_HUD_DEPTH),this._plugins.render(L.HUD_MATERIAL),this._plugins.render(L.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(L.SHADOW_HIGHLIGHT)&&this._plugins.produces(L.OPAQUE_MATERIAL,E.ShadowHighlight)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=()=>{this._renderAllGeometry(E.Highlight),this._rctx.clearSafe(Mi.DEPTH_BUFFER_BIT),this._renderHUDElements(yn.Both)},t=this._offscreen.renderToCachedFBO(null,"highlights",e,[0,0,0,0],si.RGBA4,or.DEPTH_STENCIL_TEXTURE);return t.detachDepth(),t}_renderShadowHighlights(e,t){this.hasHighlights&&t.decorations!==Cs.OFF&&this._needsShadowHighlight&&this._offscreen.updateColor(r=>(this._pluginInput.set("highlights",e),this._plugins.render(L.SHADOW_HIGHLIGHT,this._pluginInput,r),r),"transparent-color")}_renderHighlights(e,t,r){this.hasHighlights&&r.decorations!==Cs.OFF&&this._plugins.produces(L.HIGHLIGHT)&&(this._pluginInput.set("highlights",t),this._plugins.render(L.HIGHLIGHT,this._pluginInput,e))}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,t,r){var s;this._needsShadowCast&&((s=this._bindParameters.linearDepth)!=null&&s.getTexture())&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,e,t,r)}_prepareTransparencySlots(){this._renderContext.output=E.Alpha,this._bindParameters.transparencyPassType=ti.Alpha,this._plugins.prepare(L.TRANSPARENT_MATERIAL),this._renderContext.output=E.Color,this._bindParameters.transparencyPassType=ti.Color,this._plugins.prepare(L.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=ti.FrontFace,this._plugins.prepare(L.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=ti.NONE}_renderOITPass(e,t=yn.Both){const r=e===wl.HUD,s=r?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,n=r?()=>this._renderHUDElements(t):()=>this._renderTransparentMaterial(),a=this._renderContext.output;this._renderContext.output=E.Alpha,this._bindParameters.transparencyPassType=ti.Alpha;const o=this._offscreen.renderOITPass(n,ti.Alpha,r);this._renderContext.output=E.Color,this._bindParameters.transparencyPassType=ti.Color;const l=this._offscreen.renderOITPass(n,ti.Color,r);this._bindParameters.transparencyPassType=ti.FrontFace;const c=this._offscreen.renderOITPass(n,ti.FrontFace,r);return this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,l,o,c,s),s==null||s.detachDepth(),c.release(),l.release(),o.release(),this._bindParameters.transparencyPassType=ti.NONE,this._renderContext.output=a,s}_renderOccluded(){let e=0;as.clear(),this._plugins.plugins.forAll(o=>{o.materialReference&&o.queryRenderOccludedState(xi.OccludeAndTransparentStencil)&&(e|=xi.OccludeAndTransparentStencil,as.push(o))});const t=this._offscreen,r=(o,l,c,d,u)=>{if(!(e&l))return;const{width:m,height:_,depth:f}=t,y=this.fboCache.acquire(m,_,"tmp color");t.renderToTargets(c,y,f,[0,0,0,0],d,u),t.compositeToFramebuffer(this._bindParameters,y.getTexture(),qi.PremultipliedAlpha,o),y.release()},s=(o,l)=>{this._bindParameters.slot=o,l.forAll(c=>{if(Km(c)){const d=c.prepareTechnique(this._renderContext);d&&c.renderNode(this._renderContext,d)}})};as.length!==0&&(s(L.OCCLUDER_MATERIAL,as),r(.5,xi.OccludeAndTransparentStencil,()=>s(L.TRANSPARENT_OCCLUDER_MATERIAL,as),!1,!1)),as.clear(),this._plugins.plugins.forAll(o=>{if(!o.materialReference)return;const l=o.queryRenderOccludedState(xi.OccludeAndTransparent),c=o.queryRenderOccludedState(xi.Transparent),d=o.queryRenderOccludedState(xi.Opaque);(l||c||d)&&(e|=l?xi.OccludeAndTransparent:c?xi.Transparent:xi.Opaque,as.push(o))});const n=this._plugins.renderOccludedFlags;if(e|=n,!e)return;const a=o=>{this._renderContext.renderOccludedMask=o,n>xi.Occlude&&this._plugins.render(L.OCCLUDED_TERRAIN),s(L.OPAQUE_MATERIAL,as),s(L.TRANSPARENT_MATERIAL,as),s(L.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,as),this._renderContext.renderOccludedMask=GP};this._renderContext.output=E.Color,r(.5,xi.OccludeAndTransparent,()=>a(xi.OccludeAndTransparent),!0,Gc.OutlineVisualElementMask),r(.5,xi.Transparent,()=>a(xi.Transparent),!0,Gc.OutlineVisualElementMask),r(1,xi.Opaque,()=>a(xi.Opaque),!0,Gc.OutlineVisualElementMask),as.clear()}_invokeRenderNodes(e){return this._nodes.render(e,this._pluginInput,this._releaseNormals)}_renderComposite(e,t){this._offscreen.updateColor(s=>(this._pluginInput.set("highlights",t),s=this._nodes.render(s,this._pluginInput,this._releaseNormals),this._pluginInput.set(s.name,s),this._pluginInput.delete("highlights"),s),"composite-color");const r=this._plugins.produces(L.ANTIALIASING);return this._plugins.render(r?L.ANTIALIASING:L.BLIT,this._pluginInput,e)}_ensureBindParametersCamera(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Bc:(mu(wv,this._bindParameters.camera.viewMatrix),mu(xv,this._bindParameters.camera.projectionMatrix),Yr(el,wv,xv),Yr(el,this._renderContext.lastFrameCamera.viewMatrix,el),Yr(el,this._renderContext.lastFrameCamera.projectionMatrix,el),this._reprojectionMatrix=el);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Bc,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){var e;return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:((e=this.edgeView)==null?void 0:e.usedMemory)??0}}get test(){return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,renderPlugins:this._plugins,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{this._renderStateFeatures.value=Rp(),this._plugins.renderFeatureChanged(),this._requestRender()},getFramebufferTexture:e=>{var t,r;switch(e){case Cl.Color:return this._offscreen.colorTexture;case Cl.LinearDepth:return(t=this._bindParameters.linearDepth)==null?void 0:t.getTexture();case Cl.ShadowMap:return this._shadowMap.depthTexture;case Cl.HudVisibility:return(r=this._bindParameters.hudVisibility)==null?void 0:r.getTexture()}},debugLinearDepth:e=>{this._debugLinearDepth=e,this._requestRender()}}}}var wl,Cl;h([p({readOnly:!0})],dl.prototype,"fullResolutionAtmosphere",null),h([p()],dl.prototype,"_smaa",void 0),h([p()],dl.prototype,"_blit",void 0),h([p()],dl.prototype,"_edgeView",void 0),h([p()],dl.prototype,"updating",null),function(i){i[i.Geometry=0]="Geometry",i[i.HUD=1]="HUD"}(wl||(wl={})),function(i){i[i.Color=0]="Color",i[i.LinearDepth=1]="LinearDepth",i[i.ShadowMap=2]="ShadowMap",i[i.HudVisibility=3]="HudVisibility"}(Cl||(Cl={}));const bv=[0,0,0,0],as=new xt,xv=ct(),wv=ct(),el=ct();function S$(i){return e=>i.immediate.schedule(e)}class R${constructor(e){this._rctx=e,this._vao=O$(e)}destroy(){this._vao=Ae(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(Ti.TRIANGLES,0,3))}get test(){var e,t,r,s;return{cachedWebGLObjects:Dm((e=this._vao)==null?void 0:e.glName)+Dm((r=(t=this._vao)==null?void 0:t.indexBuffer)==null?void 0:r.glName)+Dm((s=this._vao)==null?void 0:s.vertexBuffers.geometry)}}}function O$(i,e=gg,t=Pt){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new jn(i,t,{geometry:e},{geometry:ur.createVertex(i,Nr.STATIC_DRAW,r)})}function Dm(i){return i!=null?1:0}class E$ extends zR{constructor(e,t,r){super(e,t),this.gl=e,this.newCache=r,this._appleAmdDriverHelper=null,this._refCount=1,this.screen=new R$(this)}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){var e;super.dispose(),(e=this._appleAmdDriverHelper)==null||e.dispose(),this.screen.destroy()}bindTechnique(e,t,r,s,n){return this.useProgram(e.program),this.setPipelineState(e.getPipeline(!!n)),e.program.bindPass(r,t),s&&e.program.bindDraw(s,t,r),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??(this._appleAmdDriverHelper=new qR(this)),this._appleAmdDriverHelper.run())}get test(){var e;return{cachedWebGLObjects:this.programCache.test.cachedWebGLProgramObjects+this.screen.test.cachedWebGLObjects+(((e=this._appleAmdDriverHelper)==null?void 0:e.test.cachedWebGLObjects)??0)}}}function Cv(i){return!!i.frameUpdate}let ul=class extends Pe{constructor(i,e,t){super({}),this._stage=i,this._techniqueRepository=e,this._rctx=t,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new es,this._frameTask=i.view.resourceController.scheduler.registerTask(fi.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(zb.Texture,i=>i.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return this._textureTechnique==null&&(this._textureTechnique=this._techniqueRepository.acquire(kP,new jP)),this._textureTechnique}acquire(i){const e=this._textures.get(i);return e?(e.ref(),e.loadingPromise??e):this._createNewRef(i)}update(){let i=!1;this._frameUpdates.forEach(e=>{const t=e.texture.frameUpdate(e.previousToken);t>=0&&t!==e.previousToken&&(e.previousToken=t,i=!0)}),i&&this.events.emit("changed",jt.BACKGROUND)}_createNewRef(i){const e=this._stage.getObject(i);if(e==null)return Js(e!==void 0),null;const t=e.events.on("unloaded",()=>{t.remove(),this._onTextureUnloaded(i)}),r=new A$(i,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&e.unload()})});return this._textures.set(i,r),r.ref(),e.glTexture?(this._updateGLTexture(r,e.glTexture),Cv(e)&&this._frameUpdates.set(i,{texture:e,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{const s=e.load(this._rctx),n=o=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,o),Cv(e)&&this._frameUpdates.set(i,{texture:e,previousToken:-1}),r),a=o=>(this._loadingCount--,r.loadingPromise=null,fo(o)||de.getLogger(this).error(o),null);return Q_(s)?s.then(n,a):n(s)}),r.loadingPromise)}_updateGLTexture(i,e){i.glTexture=e,this.events.emit("changed",jt.UPDATE)}_onTextureUnloaded(i){this._textures.delete(i),this._frameUpdates.delete(i)}};h([p()],ul.prototype,"_loadingCount",void 0),h([p()],ul.prototype,"_frameTask",void 0),h([p()],ul.prototype,"updating",null),ul=h([F("esri.views.3d.webgl-engine.lib.TextureRepository")],ul);let A$=class{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(de.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}};function M$(i,e){return new WP(t=>QP(t,i),t=>t,e)}let Uc=class extends Pe{constructor(){super(...arguments),this._passParameters=new D$,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=So(this._resourcesTask),this._passParameters.waveNormal=Ae(this._passParameters.waveNormal),this._passParameters.wavePerturbation=Ae(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(i){return this._resourcesTask||(this._resourcesTask=Hu(async e=>{await Promise.allSettled([this._loadImageResource(i,Ff("esri/images/materials/water/normals.jpg"),t=>this._passParameters.waveNormal=t,e),this._loadImageResource(i,Ff("esri/images/materials/water/perturbation.jpg"),t=>this._passParameters.wavePerturbation=t,e)])})),this._resourcesTask.finished?E0.LOADED:E0.LOADING}async _loadImageResource(i,e,t,r){try{const s=await _h(e,{signal:r});Tr(r);const n=new ui(s.width,s.height);n.pixelFormat=hi.RGB,n.samplingMode=Pr.LINEAR_MIPMAP_LINEAR,n.hasMipmap=!0,n.maxAnisotropy=8,t(new Ci(i,n,s))}catch(s){de.getLogger(this).error("Failed to load water material normal texture.",s)}}};h([p()],Uc.prototype,"_resourcesTask",void 0),h([p({type:Boolean,readOnly:!0})],Uc.prototype,"updating",null),Uc=h([F("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],Uc);let D$=class extends di{};class $${constructor(e,t,r){this.parameters=e,this.frameHasDecorations=t,this.fbos=r}}class L${constructor(e,t,r){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=r,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(jt.BACKGROUND);const t=Sv();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const r of this._screenshotQueue){if(this._rctx==null){r.resolver.reject();continue}const s={...r.settings,pixelRatio:r.settings.pixelRatio*e.parameters.camera.pixelRatio},n=this._renderScreenshot(e,s,t);r.resolver(n)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,r){e.width=t.width,e.height=t.height;const s=e.getContext("2d"),n=r.pixelRatio;return s.save(),s.translate(0,t.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(n,n),t=this._renderFunctions.renderOverlay(e,r.disableDecorations?Cs.OFF:Cs.ON,t),s.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:r,framebufferHeight:s,region:n,resample:a}=e,o=this._ensureScreenshotEncodeCanvas();let l=Ap(r,s,o);this._rctx.gl.readPixels(0,0,r,s,hi.RGBA,Xi.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(o,l,{...e,region:void 0});const c=Ap(n.width,n.height,o);return t3(l,c,!0,a.region.x,s-(a.region.y+a.region.height),a.region.width,a.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:r,region:s}=e,n=this._ensureScreenshotEncodeCanvas(),a=Ap(s.width,s.height,n);return this._rctx.gl.readPixels(s.x,r-(s.y+s.height),s.width,s.height,hi.RGBA,Xi.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(n,a,e)}_renderScreenshot(e,t,r){const s=e.parameters.camera,n={width:t.framebufferWidth,height:t.framebufferHeight};og(n,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let a=!1;const o=t.disableDecorations&&e.frameHasDecorations,l=n.width!==s.fullWidth||n.height!==s.fullHeight,c=t.ignorePadding&&s.pixelRatio!==t.pixelRatio,d=l||o||c||t.objectAndLayerIdColor;let u=null,m=null;if(d){const b=s.clone();if(t.ignorePadding){const P=Bv(b.padding);for(let S=0;S<4;S++)P[S]=Math.round(P[S]/b.pixelRatio*t.pixelRatio);b.padding=P}b.fullWidth=n.width,b.fullHeight=n.height,b.pixelRatio=t.pixelRatio;const x=s.fovX-b.fovX,w=s.fovY-b.fovY;x<0&&x<w?b.fovX=s.fovX:w<0&&w<x&&(b.fovY=s.fovY);const C={camera:b,contentCamera:b,mode:Wi.IDLE,alignPixelEnabled:!0,contentPixelRatio:b.pixelRatio};this._forceCameraHook(C),a=!0;const T=this._renderFunctions.renderScene(C,r,t.objectAndLayerIdColor?On.ObjectAndLayerID:On.Screenshot,t.disableDecorations?Cs.OFF:Cs.ON);m=T.screen,u=T.oid}const _=()=>{this._rctx.bindFramebuffer(null),m==null||m.release()};this._rctx.bindFramebuffer(m==null?void 0:m.fbo);const f=this._readbackScreenshot(t,_);let y=null;if(t.objectAndLayerIdColor){const b=()=>{this._rctx.bindFramebuffer(null),u==null||u.release()};this._rctx.bindFramebuffer(u==null?void 0:u.fbo),y=this._readbackScreenshot(t,b),this._rctx.bindFramebuffer(null)}if(d&&!this._rctx.contextAttributes.alpha)for(let b=3;b<f.data.length;b+=4)f.data[b]=255;if(y&&!this._rctx.contextAttributes.alpha)for(let b=3;b<y.data.length;b+=4)y.data[b]=255;return a&&this._forceCameraHook(e.parameters),[f,y]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}let vi=class extends Pe{constructor(i){super({}),this.events=new es,this.waterTextures=new Uc,this._magnifierHelper=new ll,this.objectAndLayerIdRenderHelper=li("enable-feature:objectAndLayerId-rendering")?new h6:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=i.container,this._viewingMode=i.viewingMode;try{this._initializeContext(i)}catch(r){return void console.error("Failed to initialize context",r)}this.addHandles([A(()=>{var r;return(r=this.waterTextures)==null?void 0:r.updating},()=>this.requestRender(),oi),A(()=>i.view.qualityProfile,r=>{var s;return(s=this.renderer)==null?void 0:s.updateRenderFeatures(r)},vt),this._magnifierHelper.events.on("request-render",()=>this.requestRender())]);const{memoryController:e}=i.view.resourceController;this.stippleTextures=ZP(this._rctx,e),this.markerTextures=M$(this._rctx,e),this._shaderTechniques=new XP({rctx:this._rctx,viewingMode:i.viewingMode,stippleTextureRepository:this.stippleTextures,waterTextureRepository:this.waterTextures,markerTextureRepository:this.markerTextures}),this._textures=new ul(i,this._shaderTechniques,this._rctx),this.addHandles(this._textures.events.on("changed",r=>this.requestRender(r))),this._materialRepository=new YP(this._textures,this._shaderTechniques,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new H8(this._rctx,this._shaderTechniques),this.renderer=new dl(i,this._materialRepository,this._textures,this._shaderTechniques,this._rctx,this._compositingHelper,this._magnifierHelper,r=>this.requestRender(r));const t={renderScene:(r,s,n,a)=>this.renderer.render(r,s,n,a),requestRenderScene:r=>this.requestRender(r),prepareOverlay:()=>i.options.screenshot.prepareOverlay(),renderOverlay:(r,s,n)=>i.options.screenshot.renderOverlay(r,s,n)};this._screenshotManager=new L$(this._rctx,t,r=>this.events.emit("force-camera-for-screenshot",r)),this._registerFrameTask(i)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Bn(this._frameTask),this._shaderTechniques=te(this._shaderTechniques),this._componentObjects=te(this._componentObjects),this._screenshotManager=te(this._screenshotManager),te(this.renderer),this._textures=te(this._textures),te(this._magnifierHelper),te(this.waterTextures),te(this.markerTextures),te(this.stippleTextures),this._canvas=null,this._container=null,this._rctx=te(this._rctx)}requestRender(i=jt.UPDATE){this._needsRender=!0,i===jt.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating||this._magnifierHelper.updating}get textureRepository(){return this._textures}get compositingHelper(){return this._compositingHelper}set magnifier(i){this._magnifierHelper.magnifier=i}setIdleSuspend(i){this._idleSuspend!==i&&(this._idleSuspend=i,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(i){return this._screenshotManager.takeScreenshot(i).then(e=>e[0])}takeScreenshotWithOID(i){return i.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(i)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(i,e,t,r,s,n=s){const a=r.constrainWindowSize(e,t,s*r.pixelRatio,n*r.pixelRatio),o=this._ensureDepthBuffer(a);this.renderer.readDepthPixels(r,a,o);let l=Number.MAX_VALUE;for(let c=0;c<a[2]*a[3];c++){const d=Q8(4*c,o,r.nearFar);l>d&&d!==r.nearFar[0]&&d!==r.nearFar[1]&&(l=d)}if(i){const c=i.pickDepth(e*r.pixelRatio,t*r.pixelRatio,r);c!=null&&l>c&&c!==r.nearFar[0]&&c!==r.nearFar[1]&&(l=c)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(i){const e=4*i[2]*i[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}async reloadShaders(){lw(),await this._shaderTechniques.reloadAll(),this.requestRender()}_registerFrameTask(i){const e=i.view.state;let t=!1,r=jt.BACKGROUND,s=!1;const n={preRender:({time:a})=>{t=this.updating,r=this._needsUpdate?jt.UPDATE:jt.BACKGROUND,i.commitSyncLayers();const o=Ye(a-this._lastAnimationUpdate);if(o>this.renderer.animationTimestep||e.forcedAnimationTime!=null||t||this._needsRender){const l=Ye(o/this.renderer.animationTimeDilation),c=new _b(e.camera,l,e.forcedAnimationTime);this.renderer.updateAnimation(c)&&this.requestRender(jt.BACKGROUND),this._lastAnimationUpdate=a}},render:({time:a})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const o=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(e,a),s=!0,o&&this.renderer.hasReflections&&(this.requestRender(jt.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:a})=>{const o=this.renderer.hasSlicePlane||this._magnifierHelper.enabled||this.renderer.hasDecorations||this.renderer.hasHighlights,l=new $$(e,o,this.renderer.fboCache);this._textures.update(),this._screenshotManager.update(l,a)},finish:()=>{s&&(this.renderer.finish(e.mode===Wi.IDLE?r:jt.UPDATE),s=!1)}};this._frameTask=Qu(n)}_initializeContext(i){const e=i.options;this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const t={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:e.preserveDrawingBuffer??!1},r=BR(this._canvas,t);r!=null?(this._rctx=this._newRenderingContext(r,i),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&de.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&li("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):de.getLogger(this).error("A WebGL2 context could not be created.")}_newRenderingContext(i,e){const t={disabledExtensions:e.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.options.debugWebGLExtensions||{},maxAnisotropy:8},r=(s,n)=>e.view.resourceController.memoryController.newCache(s,n);return new E$(i,t,r)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(i){return this.objectAndLayerIdRenderHelper!=null?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(i):null}get componentObjectCollection(){return this._componentObjects==null&&(this._componentObjects=new F8(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(i){this._componentObjects=i}};h([p({type:Boolean,readOnly:!0})],vi.prototype,"updating",null),h([p()],vi.prototype,"_rctx",void 0),h([p()],vi.prototype,"_container",void 0),h([p()],vi.prototype,"_canvas",void 0),h([p()],vi.prototype,"stippleTextures",void 0),h([p()],vi.prototype,"markerTextures",void 0),h([p()],vi.prototype,"waterTextures",void 0),h([p()],vi.prototype,"_magnifierHelper",void 0),h([p({readOnly:!0})],vi.prototype,"objectAndLayerIdRenderHelper",void 0),h([p()],vi.prototype,"_textures",void 0),h([p({readOnly:!0})],vi.prototype,"renderer",void 0),h([p()],vi.prototype,"_screenshotManager",void 0),h([p()],vi.prototype,"componentObjectCollection",null),h([p()],vi.prototype,"_componentObjects",void 0),h([p()],vi.prototype,"_needsUpdate",void 0),h([p()],vi.prototype,"_needsWaterReflectionUpdate",void 0),vi=h([F("esri.views.3d.webgl-engine.parts.RenderView")],vi);let Er=class extends Pe{constructor(i){super(i),this._model=new tu,this._layers=new xt,this._asyncChangeSet=new m0,this._syncChangeSet=new m0,this._layerSyncSet=new Set}initialize(){this._set("renderView",new vi(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(fi.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var i;return(i=this.renderView)==null?void 0:i.renderer}add(i){this._model.add(i),bu(i)&&this._addLayer(i),this.renderView.requestRender()}remove(i){i!=null&&!this.destroyed&&this._model.remove(i)&&(bu(i)&&this._removeLayer(i),this.renderView.requestRender())}addMany(i){i!=null&&(this._model.addMany(i),this.renderView.requestRender())}removeMany(i){var e,t;i!=null&&((e=this._model)==null||e.removeMany(i),(t=this.renderView)==null||t.requestRender())}forEachOfType(i,e){this._model.forEachOfType(i,e)}handleEvent(i,e){this.destroyed||(this._model.dirtySet[i](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(i){if(this._frameTask.processQueue(i),this._commit(i),!i.hasProgressed)return Yi}_commit(i){const e=this._model.dirtySet;this._asyncChangeSet.empty||i.done||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{if(i.done)return;const r=this._layerSyncSet.has(t.id)||t.updatePolicy===Sp.SYNC,s=r?this._syncChangeSet:this._asyncChangeSet;e.commitLayer(t.id,s),this._layerSyncSet.delete(t.id),s.empty||(this.renderer.modify(s,r?Ys:i),this.renderView.requestRender(),i.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ys),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{i.done||this._layerSyncSet.has(t.id)||t.updatePolicy!==Sp.ASYNC||(e.commitLayer(t.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const i=this._model.dirtySet;this._layers.forAll(e=>{this._layerSyncSet.has(e.id)||e.updatePolicy===Sp.SYNC?(i.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id)):i.commitSyncUpdates(e.id,this._syncChangeSet)});for(const e of this._layerSyncSet)i.commitLayer(e,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ys),this.renderView.requestRender())}_commitLayer(i){this._model.dirtySet.commitLayer(i.id,this._syncChangeSet),this._layerSyncSet.delete(i.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ys),this.renderView.requestRender())}schedule(i,e){return this._frameTask.schedule(i,e)}reschedule(i,e){return this._frameTask.reschedule(i,e)}syncLayer(i){this._layerSyncSet.add(i),this.renderView.requestRender()}getObject(i){return this._model.getObject(i)}get layers(){return this._layers}_addLayer(i){this._layers.includes(i)||this._layers.push(i)}_removeLayer(i){this._commitLayer(i),this._layers.removeUnordered(i)!=null&&(this._model.dirtySet.getResidentRenderGeometries(i.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Ys))}addRenderPlugin(i,e){const t=this.renderer.plugins.add(i,e),r=()=>{iy(i)&&this.view.sceneIntersectionHelper.addIntersectionHandler(i)};if(Q_(t))return t.then(r);r()}removeRenderPlugin(i){this.destroyed||(iy(i)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(i),this.renderer.plugins.remove(i))}get performanceInfo(){return this._model.getStats()}get test(){const i=this;return{getCount:e=>i._model.test.content.filter(t=>t.type===e).length,model:i._model}}};Er.DebugSettings={endFrameContentValidation:!1},h([p({constructOnly:!0})],Er.prototype,"view",void 0),h([p({constructOnly:!0})],Er.prototype,"options",void 0),h([p({readOnly:!0})],Er.prototype,"viewingMode",null),h([p({constructOnly:!0})],Er.prototype,"container",void 0),h([p({readOnly:!0})],Er.prototype,"updating",null),h([p({constructOnly:!0})],Er.prototype,"_model",void 0),h([p()],Er.prototype,"renderView",void 0),h([p({readOnly:!0})],Er.prototype,"renderer",null),h([p({readOnly:!0})],Er.prototype,"running",null),Er=h([F("esri.views.3d.webgl-engine.Stage")],Er);let cu=class extends jv{constructor(i){super(i),this.components=["attribution","zoom","navigation-toggle","compass"]}};h([p()],cu.prototype,"components",void 0),cu=h([F("esri.views.ui.3d.DefaultUI3D")],cu);const K2=cu;let ee=class extends i3(r3(s3(l3))){constructor(i){super(i),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new Sa({slicePlane:zT},this),this._resourceController=pM(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new S_({view:this}),this.labeler=new Xa({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new Wv,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new ro,this.environment=new al,this.environmentManager=new os,this.floors=new go,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new QR({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new YA,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new K2,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new sw,cT();const e=(t=null)=>{t!=null&&t.type===Bf.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async r=>{try{await r.when()}catch{}this._updatingChanged()}))};this.addHandles([Nn(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",t=>e(t),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",t=>this._updateUpdatingMonitors(t)),A(()=>this.map,t=>{t&&"load"in t&&t.load&&t.load().catch(()=>{})})]),this.inputManager=new vE({view:this}),this.stateManager=new Gt({view:this})}initialize(){this.groundView=new jR({view:this}),this._updateUpdatingMonitors();const i=()=>this._updateDefaultToMapOptions();this.addHandles(Nn(()=>{var e;return(e=this.map)==null?void 0:e.allLayers},"after-changes",i,{onListenerAdd:i,onListenerRemove:i})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},oi),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},oi),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>hT(e>0?1e3/Math.ceil(e):0),oi),this.updatingHandles.add(()=>{var e;return(e=this.map)==null?void 0:e.ground},i,vt),this.updatingHandles.add(()=>{var e,t;return(t=(e=this.map)==null?void 0:e.ground)==null?void 0:t.opacity},()=>this._updateDefaultHitTestOptions(),vt),this.addHandles(A(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),st))}destroy(){var i;this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=te(this.sharedSymbolResources),this._set("labeler",te(this.labeler)),this._set("deconflictor",te(this.deconflictor)),this._resourceController=te(this._resourceController),this._set("stateManager",te(this.stateManager)),this._set("inputManager",te(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",te(this.environmentManager)),this._set("environment",te(this.environment)),this.groundView=te(this.groundView),this._exitBasemapTerrain(),(i=this._stage)==null||i.destroy())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var i;return(i=this.basemapTerrain)==null?void 0:i.spatialReference}get animation(){var i;return(i=this.state)==null?void 0:i.animation}get camera(){var i;return(i=this.stateManager)==null?void 0:i.camera}set camera(i){this.stateManager&&(this.stateManager.camera=i)}get contentCamera(){var i;return(i=this.stateManager)==null?void 0:i.contentCamera}set contentCamera(i){this.stateManager&&(this.stateManager.contentCamera=i)}installContentCameraReset(i={sticky:!1}){return this.stateManager.installContentCameraReset(i)}get center(){var i;return(i=this.stateManager)==null?void 0:i.center}set center(i){this.stateManager&&(this.stateManager.center=i)}get clippingArea(){if(this.viewingMode==="global")return null;const i=this.map;let e=this._userClippingArea||Vf(i,"clippingArea");return!this._userClippingArea&&!Vf(i,"clippingEnabled")||e==null?(this._clippingArea=null,null):e instanceof Zs?this.spatialReference&&(e=Md(e,this.spatialReference),e==null)?(de.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),e.intersection(this._groundAndLayersExtent)==null&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(de.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(i){this.ready&&this.viewingMode==="global"&&i!=null?de.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=i}get renderDataExtent(){if(this.state.viewingMode===Re.Global)return null;const i=this.renderSpatialReference,e=this.dataExtent;return e==null||i==null||e.spatialReference.equals(i)?e:Md(e,i)}get dataExtent(){let i=this._groundAndLayersExtent;const e=this.spatialReference||zi.WGS84,t=Md(this.clippingArea,e);t!=null&&(i=i!=null?i.intersection(t):t);const r=this._get("dataExtent");return i!=null&&i.equals(r)?r:i}get _groundAndLayersExtent(){const i=this.spatialReference||zi.WGS84;let e;const t=n=>{const a=Md(n,i);a!=null&&(e!=null?e.union(a):e=a.clone())},r=this.basemapTerrain;if(r!=null&&r.spatialReference){const n=r.groundExtent;t(new Zs({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const n=a=>{a.fullExtent==null||a.type==="graphics"&&a.internal||t(a.fullExtent)};this.map.allLayers.forEach(a=>n(a))}if(e==null)return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const s=this._get("_groundAndLayersExtent");return e.equals(s)?s:e}castEnvironment(i){var e;return i?i instanceof al?i:i instanceof tb?((e=this.environment)==null?void 0:e.cloneWithWebsceneEnvironment(i))??al.fromWebsceneEnvironment(i):dT(al,i):new al}get extent(){var i;return(i=this.stateManager)==null?void 0:i.extent}set extent(i){this.stateManager&&(this.stateManager.extent=i)}get screenCenter(){var i;return(i=this.stateManager)==null?void 0:i.screenCenter}get frustum(){var i;return(i=this.stateManager)==null?void 0:i.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){var i;return this.navigating||(((i=this.toolViewManager)==null?void 0:i.interacting)??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state==null||this.state.stationary)}get navigating(){var i;return((i=this.state)==null?void 0:i.navigating)??!1}get padding(){var i;return(i=this.stateManager)==null?void 0:i.padding}set padding(i){this.stateManager&&(this.stateManager.padding=i)}set qualityProfile(i){jd.isValidProfile(i)&&(jd.apply(i,this.qualitySettings),this._set("qualityProfile",i))}get qualityProfile(){return this._get("qualityProfile")||jd.getDefaultProfile()}set slicePlane(i){if(this._stage!=null&&this._stage.renderer.setParameters({slicePlane:i}),i==null)return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");Z_(i,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&this.stateManager.preinit(this.spatialReference)}get resolution(){return this.spatialReference!=null?HT(this.scale,this.spatialReference):0}get scale(){var i;return(i=this.stateManager)==null?void 0:i.scale}set scale(i){this.stateManager&&(this.stateManager.scale=i)}get heightModelInfo(){const i=this.getDefaultHeightModelInfo();return i!=null?uT.deriveUnitFromSR(i,this.spatialReference):null}get updating(){var s,n,a,o;if(this.destroyed)return!1;let i=0,e=this.layerViewManager.updating,t=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(l=>{if(l.isFulfilled()){if(l.updating){if(e=!0,l.suspended||jm(l))return;++t,i+=l.updatingProgress}}else++t});for(const l of this._updatingObjects)l!=null&&l.updating&&(t+=.1,i+=.5*.1);for(const l of this._updatingObjectsWithProgress)l!=null&&l.updating&&(++t,i+=l.updatingProgress);const r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(e=!!(e||t>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._createGraphicsViewController||(s=this.inputManager)!=null&&s.updating||(a=(n=this.map)==null?void 0:n.allLayers)!=null&&a.some(l=>!l.isFulfilled())||(o=this.textures)!=null&&o.updating),e?(this._numUpdating=Math.max(t,this._numUpdating),i+=this._numUpdating-t):this._numUpdating=0,this._numUpdating>0?i/=this._numUpdating:i=e?0:1,this._get("updatingProgress")!==i){const l=performance.now();if(i<1){const c=Math.min((l-this._lastUpdateTime)/2e3,1);i=this.updatingProgress*(1-c)+i*c}this._set("updatingProgress",i),this._lastUpdateTime=e&&i<1?l:0}return e}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){var t;const i=this._predeterminedViewingMode;if(i!=null)return Cp(i);const e=this.spatialReference;return e?((t=this.defaultsFromMap)==null?void 0:t.viewingMode)!=null&&e.equals(this.defaultsFromMap.spatialReference)?Cp(this.defaultsFromMap.viewingMode):$0(e,Re.Global)?"global":"local":"global"}set viewingMode(i){this.ready?de.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",i)}get viewpoint(){var i;return(i=this.stateManager)==null?void 0:i.viewpoint}set viewpoint(i){this.stateManager&&(this.stateManager.viewpoint=i)}get zoom(){return this.stateManager.zoom}set zoom(i){this.stateManager&&(this.stateManager.zoom=i)}get resourceController(){return this._resourceController}get quality(){var i,e;return((e=(i=this._resourceController)==null?void 0:i.memoryController)==null?void 0:e.memoryFactor)??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new _M(this)}on(i,e,t,r){return this.viewEvents.on(i,e,t,r)||super.on(i,e)}hasEventListener(i){return super.hasEventListener(i)||this.viewEvents.hasHandler(i)}toMap(i,e){if(!this.ready)return de.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const t=S0(i)?R0(this,i):i;return JS(this,t,e,this._defaultToMapOptions)}toScreen(i){if(!this.ready)return de.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=(i.z==null?fS(this.elevationProvider,i):null)??0;return _u(i,Dd,this.renderSpatialReference,e),this.state.camera.projectToScreen(Dd,$m),Dv($m[0],$m[1])}pixelSizeAt(i){return this.ready?i?(_u(i,Dd,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(Dd)):0:(de.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(i){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(i,()=>this.pixelSizeAt(i)):1}hitTest(i,e){if(!this.ready)return de.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const t=S0(i)?R0(this,i):i;return eR(this,t,e,this._defaultHitTestOptions)}async popupHitTest(i){return rM(this,i)}goTo(i,e){return this.updatingHandles.addPromise(this.stateManager.goTo(i,e))}async whenAnalysisView(i){if(i.parent==null)throw new Ir("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:i});switch(i.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(i.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(i)}}whenLayerView(i){return super.whenLayerView(i)}async takeScreenshot(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return bp(t,e,this._pixelFormat())}async _takeScreenshot(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return xp(t,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e);return[xp(t[0],this._pixelFormat()),xp(t[1],this._pixelFormat())]}_completeSettings(i){const e=n3(i,this);return e.pixelRatio/=this.state.pixelRatio,a3(e,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:i=>this._takeScreenshot(i),takeScreenshotWithObjectAndLayerId:i=>this._takeScreenshotWithObjectAndLayerId(i)}}async takeScreenshotWithObjectAndLayerId(i){if(!li("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e),r=bp(t[0],e,this._pixelFormat()),s=this._completeSettings(i);return s.format="png",[r,bp(t[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(this._stage.renderView.objectAndLayerIdRenderHelper==null)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(i){return this.updatingHandles.addPromise(i)}importLayerView(i){return N0.importLayerView(i)}hasLayerViewModule(i){return N0.hasLayerViewModule(i)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var i,e,t;return this.map&&"initialViewProperties"in this.map&&((i=this.map.initialViewProperties)==null?void 0:i.spatialReference)||((e=this.defaultsFromMap)==null?void 0:e.spatialReference)||((t=this.defaultsFromMap)==null?void 0:t.ready)&&this._initialDefaultSpatialReference||null}async validate(){let i=o3(this.type);const e=li("safari");if(e&&e<9&&(i=new Ir("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),i!=null)throw de.getLogger(this).warn("#validate()",i.message),i}get _predeterminedViewingMode(){var e;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)??null;return i!=null?r0(i):null}getSpatialReferenceSupport({spatialReference:i,layer:e}){const t=this._predeterminedViewingMode;if(t!=null)return this._validateSpatialReferenceForViewingMode(i,e,t)?{constraints:this._makeSpatialReferenceConstraints(i,e,t)}:null;const r=this._validateSpatialReferenceForViewingMode(i,e,Re.Local),s=this._validateSpatialReferenceForViewingMode(i,e,Re.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(i,e,null)}:r?{constraints:this._makeSpatialReferenceConstraints(i,e,Re.Local)}:{constraints:this._makeSpatialReferenceConstraints(i,e,Re.Global)}:null}_validateSpatialReferenceForViewingMode(i,e,t){return!!$0(i,t)&&(e==null||!!Uf(e)||(!zc(e)||Ku(e,i,t)!=null)&&(!zf(e)||t!==Re.Global))}_makeSpatialReferenceConstraints(i,e,t){if(e==null)return[{spatialReference:i,viewingMode:t}];const r=i.isWebMercator,s=i.isWGS84;return Uf(e)&&(r||s)?!s||t===Re.Local||q3(e.tileInfo,e.fullExtent,i,Re.Global)===null?[{spatialReference:i,viewingMode:t},{spatialReference:zi.WebMercator,viewingMode:t}]:[{spatialReference:r?zi.WGS84:zi.WebMercator,viewingMode:t}]:zc(e)||zf(e)||!r&&!s?zc(e)&&r&&t!==Re.Global?[{spatialReference:i,viewingMode:t},{spatialReference:zi.WGS84,viewingMode:Re.Local}]:[{spatialReference:i,viewingMode:t}]:[{spatialReference:i,viewingMode:t},{spatialReference:r?zi.WGS84:zi.WebMercator,viewingMode:t}]}_validateSpatialReference(i){const e=this.getSpatialReferenceSupport({spatialReference:i})!=null,t=this._predeterminedViewingMode;return e||(t!=null?de.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${Cp(t)} viewing mode.`):i.isGeographic&&de.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(i=>{this.ready?i(this):this._resolveWhenReady.push(i)})}trackGraphicState(i){if(!i.graphic)return de.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(i.graphic);let t=null,r=!1;const s=n=>{var a;!r&&n!=null&&"processor"in n&&((a=n.processor)==null?void 0:a.type)==="graphics-3d"&&n.processor.graphicsCore&&(t=n.processor.graphicsCore.trackGraphicState(i))};return e!=null?s(e):this.whenViewForGraphic(i.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),pa(()=>{r=!0,t!=null&&(t.remove(),t=null)})}highlight(i){if(Array.isArray(i))return qf(i.map(t=>this.highlight(t)));if(go.isCollection(i))return qf(i.toArray().map(t=>this.highlight(t)));const e=this.getViewForGraphic(i);return e&&"highlight"in e?e.highlight(i):pa()}maskOccludee(i){if(!i)return de.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(i);let t=null,r=!1;const s=n=>{!r&&n!=null&&HR(n)&&(t=n.maskOccludee(i))};return e!=null?s(e):this.whenViewForGraphic(i,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),pa(()=>{r=!0,t!=null&&(t.remove(),t=null)})}getViewForGraphic(i){return i.layer===this.graphics?this.graphicsView:i.layer?this.allLayerViews.find(e=>e.layer===i.layer):null}graphicChanged(i){this.graphicsView!=null&&this.graphicsView.graphicChanged(i)}async whenViewForGraphic(i,e){if(i.layer===this)return await Nm(()=>this.graphicsView),this.graphicsView;if(!i.layer||!this.map)throw new Ir("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(i.layer)?new Promise((t,r)=>{const s=this.map.allLayers.on("change",n=>{n.added.includes(i.layer)&&(s.remove(),this.whenLayerView(i.layer).then(t,r))})}):this.whenLayerView(i.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new $D({view:this})),this._set("elevationProvider",new Ec({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new sr({view:this})),this._set("featureTiles",new bi({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const i=()=>{var t;const e=(t=this.basemapTerrain)==null?void 0:t.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const r=this.basemapTerrain.extent!=null&&this.basemapTerrain.spatialReference!=null?Hv(Pv(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea!=null?this.featureTiles.filterExtent=this.clippingArea.intersection(r):this.featureTiles.filterExtent=r}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add(()=>dr.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(he(()=>import("./FeatureTileTree3DDebugger-CErcsNtb.js"),__vite__mapDeps([368,1,2,116,367]))).then(({FeatureTileTree3DDebugger:t})=>{!this._featureTreeDebugger&&dr.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))}):e||!this._featureTreeDebugger||dr.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},vt),this.updatingHandles.add(()=>this.clippingArea,i,vt),this.updatingHandles.add(()=>this.basemapTerrain.extent,i,vt)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const i=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(i)||this._set("mapCoordsHelper",new iM(this.map,i));const e=this.state.isGlobal,t=qT(e,i);t!==this.renderSpatialReference&&(this._set("renderCoordsHelper",BT.create(this.state.viewingMode,t)),e||this.addHandles(A(()=>{var r;return(r=this.basemapTerrain)==null?void 0:r.extent},r=>{const s=this.renderCoordsHelper.spatialReference;r==null||r[0]===0&&r[1]===0&&r[2]===0&&r[3]===0||!kv(r,this.basemapTerrain.spatialReference,Tv,s)||(this.renderCoordsHelper.extent=Tv)},st),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Cu/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(i=null){i!=null&&i.type===Bf.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(A(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),st),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(i,e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const r=i.getContext("2d");return r.putImageData(t,0,0),this.overlay.renderCanvas(i,{disableDecorations:e===Cs.OFF}),r.getImageData(0,0,t.width,t.height)}_initStage(){const i={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(r,s,n)=>this._renderScreenshotOverlay(r,s,n)}},e=new KA(this.state.viewingMode,r=>this._stage.layers.forAll(r),this);this._set("sceneIntersectionHelper",e);const t=gT(this.surface);this._stage=new Er({view:this,options:i,container:t}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,r=>this._stage.renderer.setParameters({highQualityTransparency:r}),oi),A(()=>this.magnifier,r=>this._stage.renderView.magnifier=r,vt),this.on("pointer-move",()=>{var r;return(r=this._stage)==null?void 0:r.renderer.resetAnimation()}),pT(this._stage.renderView.canvas,"webglcontextlost",r=>{this.fatalError=new Ir("webgl-context-lost",r.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Cu/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=te(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(i){this._exitSurface(),this.state.init(i,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new yM({view:this,viewingMode:i,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const i=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(i,i),this._updatingChanged()}async _createGraphicsViewAsync(i){const e=(await he(()=>import("./GraphicsView3D-Bodv-Ylg.js"),__vite__mapDeps([369,1,2,254,116,46,47,48,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,220,221,222,223,224,225,134,127,188]))).default;Tr(i),await Nm(()=>{var t;return(t=this.basemapTerrain)==null?void 0:t.ready},i),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),this.graphicsView!=null&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){var r;const i=r0(this.viewingMode);i===Re.Global&&(this._clippingArea=null),this._initSurface(i),this._set("ready",!0),this.addHandles(Nn(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded();const e=this.map&&"initialViewProperties"in this.map?(r=this.map.initialViewProperties)==null?void 0:r.environment:void 0;e&&Wb(this.environment,e),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new vl(this._stage,this.resourceController.scheduler));const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach(s=>s(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",te(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(uh);for(const i of this.map.allLayers.items)zm(i.type)&&this._defaultToMapOptions.include.add(i.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(uh);for(const i of this.map.allLayers.items)zm(i.type)&&i.opacity<1&&this._defaultHitTestOptions.exclude.add(i.uid)}}};function Md(i,e){return i!=null&&mT(i.spatialReference,e)?Hv(i,e):null}ee.type="3d",h([p()],ee.prototype,"_userClippingArea",void 0),h([p()],ee.prototype,"_resourceController",void 0),h([p()],ee.prototype,"_stage",void 0),h([p({readOnly:!0})],ee.prototype,"deconflictor",void 0),h([p({readOnly:!0})],ee.prototype,"labeler",void 0),h([p(fT(Wv,"analyses"))],ee.prototype,"analyses",void 0),h([p({type:Nl,readOnly:!0})],ee.prototype,"animation",null),h([p({readOnly:!0})],ee.prototype,"basemapTerrain",void 0),h([p({readOnly:!0})],ee.prototype,"elevationProvider",void 0),h([p()],ee.prototype,"camera",null),h([p({type:vo})],ee.prototype,"contentCamera",null),h([p({readOnly:!0})],ee.prototype,"canvas",void 0),h([p({type:Ms})],ee.prototype,"center",null),h([p({type:Zs})],ee.prototype,"clippingArea",null),h([p({type:ro})],ee.prototype,"constraints",void 0),h([p({type:Zs,readOnly:!0})],ee.prototype,"renderDataExtent",null),h([p({type:Zs,readOnly:!0})],ee.prototype,"dataExtent",null),h([p({type:Zs,readOnly:!0})],ee.prototype,"_groundAndLayersExtent",null),h([p({type:al})],ee.prototype,"environment",void 0),h([$l("environment")],ee.prototype,"castEnvironment",null),h([p({readOnly:!0})],ee.prototype,"environmentManager",void 0),h([p({type:Zs})],ee.prototype,"extent",null),h([p()],ee.prototype,"floors",void 0),h([p()],ee.prototype,"screenCenter",null),h([p()],ee.prototype,"frustum",null),h([p({type:Number,readOnly:!0})],ee.prototype,"fullOpacity",void 0),h([p({readOnly:!0})],ee.prototype,"graphicsView",void 0),h([p({readOnly:!0})],ee.prototype,"analysisViewManager",void 0),h([p()],ee.prototype,"groundView",void 0),h([p({type:Boolean})],ee.prototype,"initialExtentRequired",null),h([p()],ee.prototype,"_defaultsFromMapSettings",null),h([p()],ee.prototype,"interacting",null),h([p()],ee.prototype,"stationary",null),h([p()],ee.prototype,"navigating",null),h([p()],ee.prototype,"map",void 0),h([p({readOnly:!0})],ee.prototype,"mapCoordsHelper",void 0),h([p()],ee.prototype,"padding",null),h([p({type:sr,readOnly:!0})],ee.prototype,"pointsOfInterest",void 0),h([p({type:bi,readOnly:!0})],ee.prototype,"featureTiles",void 0),h([p()],ee.prototype,"_featureTreeDebugger",void 0),h([p({type:Boolean})],ee.prototype,"screenSizePerspectiveEnabled",void 0),h([p({constructOnly:!0})],ee.prototype,"deactivatedWebGLExtensions",void 0),h([p({constructOnly:!0})],ee.prototype,"debugWebGLExtensions",void 0),h([p({constructOnly:!0})],ee.prototype,"renderCanvas",void 0),h([p({constructOnly:!0})],ee.prototype,"state",void 0),h([p({readOnly:!0})],ee.prototype,"inputManager",void 0),h([p({readOnly:!0})],ee.prototype,"stateManager",void 0),h([p({type:["low","medium","high"]})],ee.prototype,"qualityProfile",null),h([p({type:ry,get(){let i=this._get("qualitySettings");return i||(i=new ry,jd.apply(this.qualityProfile,i)),i}})],ee.prototype,"qualitySettings",void 0),h([p()],ee.prototype,"slicePlane",null),h([p({readOnly:!0})],ee.prototype,"typeSpecificPreconditionsReady",null),h([p({readOnly:!0})],ee.prototype,"renderCoordsHelper",void 0),h([p({readOnly:!0})],ee.prototype,"sceneIntersectionHelper",void 0),h([p({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],ee.prototype,"resolution",null),h([p({type:Number})],ee.prototype,"scale",null),h([p()],ee.prototype,"heightModelInfo",null),h([p()],ee.prototype,"spatialReference",void 0),h([p({type:Boolean,constructOnly:!0})],ee.prototype,"alphaCompositingEnabled",void 0),h([p({constructOnly:!0})],ee.prototype,"preserveDrawingBufferEnabled",void 0),h([p({type:Boolean})],ee.prototype,"supersampleScreenshotsEnabled",void 0),h([p({readOnly:!0})],ee.prototype,"type",void 0),h([p(),$l(i=>i instanceof jv?i:_T(K2,i))],ee.prototype,"ui",void 0),h([p({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],ee.prototype,"updating",null),h([p()],ee.prototype,"_updatingObjects",null),h([p()],ee.prototype,"_updatingObjectsWithProgress",null),h([p({type:Number,readOnly:!0,dependsOn:["updating"]})],ee.prototype,"updatingProgress",void 0),h([p({type:["global","local"]})],ee.prototype,"viewingMode",null),h([p({type:Il})],ee.prototype,"viewpoint",null),h([p({type:Number})],ee.prototype,"zoom",null),h([p({type:sw})],ee.prototype,"highlightOptions",void 0),h([p({readOnly:!0})],ee.prototype,"quality",null),h([p({readOnly:!0})],ee.prototype,"resolutionScale",null),h([p()],ee.prototype,"textures",void 0),ee=h([F("esri.views.SceneView")],ee);const Dd=v(),$m=qt(),Tv=ci(),I$=ee,iz=Object.freeze(Object.defineProperty({__proto__:null,default:I$},Symbol.toStringTag,{value:"Module"})),N$=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:Ol,build:Qb},Symbol.toStringTag,{value:"Module"})),F$=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:fg,build:Yb},Symbol.toStringTag,{value:"Module"})),V$=Object.freeze(Object.defineProperty({__proto__:null,build:ex},Symbol.toStringTag,{value:"Module"})),U$=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:yg,build:rx},Symbol.toStringTag,{value:"Module"})),z$=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:vg,build:ax},Symbol.toStringTag,{value:"Module"})),q$=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:bg,build:lx},Symbol.toStringTag,{value:"Module"})),B$=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:wg,SimpleAtmospherePassParameters:ap,build:dx},Symbol.toStringTag,{value:"Module"})),H$=Object.freeze(Object.defineProperty({__proto__:null,build:px},Symbol.toStringTag,{value:"Module"})),G$=Object.freeze(Object.defineProperty({__proto__:null,build:_x},Symbol.toStringTag,{value:"Module"})),k$=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:Wg,build:ww},Symbol.toStringTag,{value:"Module"})),j$=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Ea},build:Gw},Symbol.toStringTag,{value:"Module"})),W$=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:bw,ColorizerStretchUniforms:vw,ColorizerUniforms:Lh,build:xw},Symbol.toStringTag,{value:"Module"})),Q$=Object.freeze(Object.defineProperty({__proto__:null,build:s2},Symbol.toStringTag,{value:"Module"})),Z$=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:up,build:h2},Symbol.toStringTag,{value:"Module"})),X$=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:lf,build:u2},Symbol.toStringTag,{value:"Module"})),Y$=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:cf,build:_2},Symbol.toStringTag,{value:"Module"})),K$=Object.freeze(Object.defineProperty({__proto__:null,build:C2},Symbol.toStringTag,{value:"Module"})),J$=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:uf,build:S2},Symbol.toStringTag,{value:"Module"})),eL=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:hf,blurSize:df,build:w2,gridCellPixelSize:fs,outlineSize:Sh},Symbol.toStringTag,{value:"Module"})),tL=Object.freeze(Object.defineProperty({__proto__:null,build:M2},Symbol.toStringTag,{value:"Module"})),iL=Object.freeze(Object.defineProperty({__proto__:null,build:L2},Symbol.toStringTag,{value:"Module"})),rL=Object.freeze(Object.defineProperty({__proto__:null,build:F2},Symbol.toStringTag,{value:"Module"})),sL=Object.freeze(Object.defineProperty({__proto__:null,build:z2},Symbol.toStringTag,{value:"Module"})),nL=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:mf,build:G2},Symbol.toStringTag,{value:"Module"})),aL=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:Nh,build:H2},Symbol.toStringTag,{value:"Module"})),oL=Object.freeze(Object.defineProperty({__proto__:null,build:X2},Symbol.toStringTag,{value:"Module"}));export{Ks as A,ud as B,ai as I,iz as S,x8 as a,KV as b,ca as c,ka as d,MF as e,xc as f,lM as g,sy as h,JI as i,un as j,KI as l,u9 as m,I$ as n,xh as o,LM as t,GF as x};
