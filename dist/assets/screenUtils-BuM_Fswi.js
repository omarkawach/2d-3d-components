import{my as S,mz as C,mA as y,w as k,P as v,o as l,y as c,X as M,bO as H,cW as P,g8 as f,g2 as w}from"./index-8ERthB3p.js";import{r as b}from"./signal-DoM1gSF0.js";let D=class{constructor(e,t){this._owner=t,this._properties={},this._afterDispatchHandle=null;for(const n in e){const s=e[n],r=new S(s,void 0,void 0,2,2);this._properties[n]={pool:r,acquired:[]}}this._afterDispatchHandle=C(()=>this._release())}destroy(){this._afterDispatchHandle&&(this._afterDispatchHandle.remove(),this._afterDispatchHandle=null);for(const e in this._properties){const t=this._properties[e];for(const n of t.acquired)y(n)||t.pool.release(n);t.pool.destroy(),t.pool=null,t.acquired=null}this._properties=null,this._owner=null}get(e){const t=this._owner._get(e),n=this._properties[e];let s=n.pool.acquire();for(n.acquired.push(s);s===t;)n.acquired.push(s),s=n.pool.acquire();return s}_release(){for(const e in this._properties){const t=this._properties[e];let n=0;for(const s of t.acquired)y(s)?t.acquired[n++]=s:t.pool.release(s);t.acquired.length=n}}};const A=k("mac")?"Meta":"Ctrl",x=new Set(["Alt","Ctrl","Meta","Shift","Primary"]),R=i=>x.has(i);class K{constructor(e,t=[]){this.eventType=e,this.keyModifiers=t}matches(e){if(e.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const t=e.modifiers;for(const n of this.keyModifiers)if(!t.has(n))return!1;return!0}}const E=()=>v.getLogger("esri.views.input.InputHandler");let T=class{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const t=this._incoming[e];for(const n of t)this._incomingEventMatches.push(n.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(e=>e.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager?E().error("This InputHandler has already been registered with an InputManager"):(e.setEventCallback(t=>this._handleEvent(t)),e.setUninstallCallback(()=>this._onUninstall()),this._manager=e)}onUninstall(){}registerIncoming(e,t,n){let s;typeof t=="function"?(n=t,s=[]):s=t||[];const r=typeof e=="string"?new K(e,s):e,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=p=>{const _=this._incoming[p.match.eventType];if(_){const I=_.indexOf(p);_.splice(I,1),o(),this._manager&&this._manager.updateDependencies()}},d=new L(r,n,{onPause:a,onRemove:a,onResume:p=>{const _=this._incoming[p.match.eventType];_&&!_.includes(p)&&(_.push(p),o(),this._manager&&this._manager.updateDependencies())}});let g=this._incoming[r.eventType];return g||(g=[],this._incoming[r.eventType]=g),g.push(d),o(),this._manager&&this._manager.updateDependencies(),d}registerOutgoing(e){if(this._outgoing[e])throw new Error("There is already a callback registered for this outgoing InputEvent: "+e);const t=new O(e,{onEmit:(n,s,r,o)=>{var a;(a=this._manager)==null||a.emit(n.eventType,s,r,o)},onRemove:n=>{var s;delete this._outgoing[n.eventType],(s=this._manager)==null||s.updateDependencies()}});return this._outgoing[e]=t,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),t}startCapturingPointer(e){var t;(t=this._manager)==null||t.setPointerCapture(e,!0)}stopCapturingPointer(e){var t;(t=this._manager)==null||t.setPointerCapture(e,!1)}refreshHasPendingInputs(){var e;(e=this._manager)==null||e.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):E().error("This InputHandler is not registered with an InputManager")}_handleEvent(e){var n;const t=this._incoming[e.type];if(t){for(const s of t)if(s.match.matches(e)&&((n=s.callback)==null||n.call(s,e),e.shouldStopPropagation()))break}}},L=class{constructor(e,t,n){this.match=e,this._callback=t,this._handler=n}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}};class O{constructor(e,t){this.eventType=e,this._removed=!1,this._handler=t}emit(e,t,n){this._removed||this._handler.onEmit(this,e,t,n)}remove(){this._removed=!0,this._handler.onRemove(this)}}class $ extends T{constructor(e){super(!0),this._onChange=e,this._value="mouse",this._x=null,this._y=null,this.registerIncoming("pointer-move",t=>{this._update(t.data)})}_update(e){const t=e.native.pointerType==="touch"?"touch":"mouse",{x:n,y:s}=e;t===this._value&&this._x===n&&this._y===s||(this._value=t,this._x=n,this._y=s,this._onChange(t,n,s))}}let N=class extends T{get multiTouchActive(){return this._multiTouchActive.value}constructor(){super(!0),this._activeTouchPointerIds=new Set,this._multiTouchActive=b(!1),this._onPointerAdd=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.add(e.native.pointerId),this._update())},this._onPointerRemove=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.delete(e.native.pointerId),this._update())},this.registerIncoming("pointer-down",this._onPointerAdd),this.registerIncoming("pointer-up",this._onPointerRemove),this.registerIncoming("pointer-capture-lost",this._onPointerRemove),this.registerIncoming("pointer-cancel",this._onPointerRemove)}_update(){this._multiTouchActive.value=this._activeTouchPointerIds.size>1}},h=class extends H{constructor(i){super(i),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._handlersPriority=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=A,this._latestPointerType="mouse",this._propertiesPool=new D({latestPointerLocation:G},this),this.latestPointerLocation=null,this._paused=!1,this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const i=Object.keys(this._nameToGroup);for(const e of i)this.uninstallHandlers(e);this.eventSource.destroy(),this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some(i=>i.handler.hasPendingInputs)}get latestPointerType(){return this._latestPointerType}get multiTouchActive(){return this._multiTouchHandler.multiTouchActive}get updating(){return this.hasPendingInputs||this._paused}installHandlers(i,e,t=m.INTERNAL){if(this._nameToGroup[i])return void v.getLogger(this).error("There is already an InputHandler group registered under the name `"+i+"`");if(e.length===0)return void v.getLogger(this).error("Can't register a group of zero handlers");const n={name:i,handlers:e.map(s=>({handler:s,active:!0,removed:!1,priorityIndex:0,groupPriority:t,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[i]=n;for(let s=n.handlers.length-1;s>=0;s--){const r=n.handlers[s];this._handlers.push(r),r.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(o,a,d,g,p)=>{this._emitInputEvent(r.priorityIndex+1,o,a,d,p,g)},setPointerCapture:(o,a)=>{this._setPointerCapture(n,r,o,a)},setEventCallback:o=>{r.eventCallback=o},setUninstallCallback:o=>{r.uninstallCallback=o},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(i){const e=this._nameToGroup[i];e?(e.handlers.forEach(t=>{var n;t.removed=!0,(n=t.uninstallCallback)==null||n.call(t)}),delete this._nameToGroup[i],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):v.getLogger(this).error("There is no InputHandler group registered under the name `"+i+"`")}hasHandlers(i){return this._nameToGroup[i]!==void 0}isModifierKeyDown(i){return this._activeKeyModifiers&&this._activeKeyModifiers.has(i)}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const i=new Set,e=new Set;this._handlersPriority=[];for(let t=this._handlers.length-1;t>=0;t--){const n=this._handlers[t];n.priorityIndex=t,this._handlersPriority.push(n)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let t=this._handlersPriority.length-1;t>=0;t--){const n=this._handlersPriority[t];n.priorityIndex=t;let s=n.handler.hasSideEffects;if(!s){for(const r of n.handler.outgoingEventTypes)if(i.has(r)){s=!0;break}}if(s)for(const r of n.handler.incomingEventMatches){i.add(r.eventType);for(const o of r.keyModifiers)R(o)||e.add(o)}n.active=s}this._sourceEvents=i,this._keyModifiers=e,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(i,e,t){this._latestPointerType=i;const n=this._get("latestPointerLocation");if(n==null||n.x!==e||n.y!==t){const s=this._propertiesPool.get("latestPointerLocation");s.x=e,s.y=t,this._set("latestPointerLocation",s)}}_onEventReceived(i,e){if(i==="pointer-capture-lost"){const s=e;this._pointerCaptures.delete(s.native.pointerId)}this._updateKeyModifiers(i,e);const t=this.test.timestamp!=null?this.test.timestamp:e.native?e.native.timestamp:void 0,n=e.native?e.native.cancelable:void 0;this._emitInputEventFromSource(i,e,t,n)}_updateKeyModifiers(i,e){if(!e)return;let t=!1;const n=()=>{if(!t){const o=new Set;this._activeKeyModifiers.forEach(a=>{o.add(a)}),this._activeKeyModifiers=o,t=!0}},s=(o,a)=>{a&&!this._activeKeyModifiers.has(o)?(n(),this._activeKeyModifiers.add(o)):!a&&this._activeKeyModifiers.has(o)&&(n(),this._activeKeyModifiers.delete(o))};if(i==="key-down"||i==="key-up"){const o=e.key;this._keyModifiers.has(o)&&s(o,i==="key-down")}const r=e.native;s("Alt",!(!r||!r.altKey)),s("Ctrl",!(!r||!r.ctrlKey)),s("Shift",!(!r||!r.shiftKey)),s("Meta",!(!r||!r.metaKey)),s("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new $((i,e,t)=>this._setLatestPointer(i,e,t)),this._multiTouchHandler=new N,this.installHandlers("input-manager-logic",[this._latestPointerHandler,this._multiTouchHandler],m.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,m.INTERNAL)}_setPointerCapture(i,e,t,n){const s=i.name+"-"+e.priorityIndex,r=this._pointerCaptures.get(t.pointerId)||new Set;this._pointerCaptures.set(t.pointerId,r),n?(r.add(s),r.size===1&&this.eventSource&&this.eventSource.setPointerCapture(t,!0)):r.has(s)&&(r.delete(s),r.size===0&&(this._pointerCaptures.delete(t.pointerId),this.eventSource&&this.eventSource.setPointerCapture(t,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(i=>!i.removed),this.updateDependencies()}_emitInputEventFromSource(i,e,t,n){this._emitInputEvent(0,i,e,t,n)}_emitInputEvent(i,e,t,n,s,r){const o=n!==void 0?n:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),a=s!==void 0&&s,d={event:new z(e,t,o,r||this._activeKeyModifiers,a),priorityIndex:i};this._currentPropagation?this._currentPropagation.events.push(d):this._doNewPropagation(d)}_doNewPropagation(i){this._currentPropagation={events:new P,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:i.event.timestamp},this._currentPropagation.events.push(i),this._continuePropagation()}_continuePropagation(){var e,t,n;this._paused=!1;const i=this._currentPropagation;if(i){for(;i.events.length>0;){const{event:s,priorityIndex:r}=i.events.pop(),o=(e=s.data)==null?void 0:e.eventId;if(!(o!=null&&this._stoppedPropagationEventIds.has(o)))for(i.currentHandler=this._handlersPriority[r];i.currentHandler;){if(i.currentHandler.removed)i.needsHandlerGarbageCollect=!0;else{if(i.currentHandler.active&&!s.shouldStopPropagation()&&((n=(t=i.currentHandler).eventCallback)==null||n.call(t,s)),s.shouldStopPropagation()){o!=null&&this._stoppedPropagationEventIds.add(o);break}if(s.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:s,priorityIndex:i.currentHandler.priorityIndex+1})}i.currentHandler=this._handlersPriority[i.currentHandler.priorityIndex+1]}}i.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(i){const e=new P;e.push(i);const t=this._currentPropagation;if(t){for(;t.events.length;)e.push(t.events.pop());t.events=e,t.currentHandler=null,this._paused=!0}}_compareHandlerPriority(i,e){if(i.handler.hasSideEffects!==e.handler.hasSideEffects)return i.handler.hasSideEffects?1:-1;if(i.groupPriority!==e.groupPriority)return i.groupPriority>e.groupPriority?-1:1;for(const t of i.handler.incomingEventMatches)for(const n of e.handler.incomingEventMatches){if(t.eventType!==n.eventType)continue;const s=t.keyModifiers.filter(r=>n.keyModifiers.includes(r));if(s.length===t.keyModifiers.length!=(s.length===n.keyModifiers.length))return t.keyModifiers.length>n.keyModifiers.length?-1:1}return i.priorityIndex>e.priorityIndex?-1:1}_sortHandlersPriority(i){const e=[];for(const t of i){let n=0;for(;n<e.length&&this._compareHandlerPriority(t,e[n])>=0;)n++;e.splice(n,0,t)}return e}get debug(){const i=e=>{const t=this._setPointerCapture;this._setPointerCapture=()=>{},e(),this._setPointerCapture=t};return{injectEvent:(e,t)=>{i(()=>{this._onEventReceived(e,t)})},disablePointerCapture:i}}};l([c({readOnly:!0})],h.prototype,"hasPendingInputs",null),l([c({constructOnly:!0})],h.prototype,"eventSource",void 0),l([c({constructOnly:!0})],h.prototype,"recognizers",void 0),l([c()],h.prototype,"_latestPointerType",void 0),l([c()],h.prototype,"latestPointerType",null),l([c()],h.prototype,"multiTouchActive",null),l([c({readOnly:!0})],h.prototype,"latestPointerLocation",void 0),l([c()],h.prototype,"_paused",void 0),l([c({readOnly:!0})],h.prototype,"updating",null),h=l([M("esri.views.input.InputManager")],h);class z{constructor(e,t,n,s,r){this.type=e,this.data=t,this.timestamp=n,this.modifiers=s,this.cancelable=r,this._propagationState=u.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=u.STOPPED}shouldStopPropagation(){return(this._propagationState&u.STOPPED)!=0}async(e){this._propagationState|=u.PAUSED;const t=(n,s)=>{this._propagationState&=~u.PAUSED;const r=this._resumeCallback;if(this._resumeCallback=null,r&&r(),s)throw n;return n};return(typeof e=="function"?e():e).then(n=>t(n,!1),n=>t(n,!0))}shouldPausePropagation(e){return!!(this._propagationState&u.PAUSED)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}}var u;(function(i){i[i.NONE=0]="NONE",i[i.STOPPED=1]="STOPPED",i[i.PAUSED=2]="PAUSED"})(u||(u={}));const m={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};class U{}const G=U;function q(i){return f(i.x,i.y)}function Q(i){return w(i.x,i.y)}function j(i,e){var n;const t=(n=i instanceof HTMLElement?i:i.surface)==null?void 0:n.getBoundingClientRect();return t?f(e.clientX-t.left,e.clientY-t.top):f(0,0)}function V(i,e){return e instanceof Event?j(i,e):q(e)}function Z(i){if(i instanceof Event)return!0;if(typeof i=="object"&&"type"in i)switch(i.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}export{m as _,Z as a,j as b,Q as c,h as d,T as i,q as n,D as o,V as r,A as t};
