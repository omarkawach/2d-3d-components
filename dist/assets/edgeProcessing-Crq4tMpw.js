import{e as dt}from"./deduplicate-j8p9VETP.js";import{H as C}from"./InterleavedLayout-s3MgOYN8.js";import{e as l}from"./VertexAttribute-BnAa5VW0.js";import{r as J}from"./glUtil-DS73TAjp.js";import{cp as nt,kN as It,fm as St,dg as X,cj as ot,cf as U,dh as Ot,fn as ht,cg as lt,dm as rt,bX as ut,bW as w,di as At,kO as Et}from"./index-8ERthB3p.js";import{s as z}from"./Normals-BAXqRpCA.js";const Tt=C().vec3f(l.POSITION).u16(l.COMPONENTINDEX),wt=C().vec2u8(l.SIDENESS),Ut=J(wt),K=C().vec3f(l.POSITION0).vec3f(l.POSITION1).vec2i16(l.NORMALCOMPRESSED).u16(l.COMPONENTINDEX).u8(l.VARIANTOFFSET,{glNormalized:!0}).u8(l.VARIANTSTROKE).u8(l.VARIANTEXTENSION,{glNormalized:!0}),k=C().vec3f(l.POSITION0).vec3f(l.POSITION1).vec2i16(l.NORMALCOMPRESSED).vec2i16(l.NORMAL2COMPRESSED).u16(l.COMPONENTINDEX).u8(l.VARIANTOFFSET,{glNormalized:!0}).u8(l.VARIANTSTROKE).u8(l.VARIANTEXTENSION,{glNormalized:!0}),zt=new Map([[l.POSITION0,0],[l.POSITION1,1],[l.COMPONENTINDEX,2],[l.VARIANTOFFSET,3],[l.VARIANTSTROKE,4],[l.VARIANTEXTENSION,5],[l.NORMALCOMPRESSED,6],[l.NORMAL2COMPRESSED,7],[l.SIDENESS,8]]),R=-1;var st;function vt(t,e,o,s=Vt){const r=t.vertices.position,i=t.vertices.componentIndex,N=nt(s.anglePlanar),a=nt(s.angleSignificantEdge),p=Math.cos(a),f=Math.cos(N),u=j.edge,I=u.position0,S=u.position1,d=u.faceNormal0,v=u.faceNormal1,O=Mt(t),$=Rt(t),n=$.length/4,c=e.allocate(n);let g=0;const m=n,h=o.allocate(m);let T=0,y=0,A=0;const Y=It(0,n),F=new Float32Array(n);F.forEach((M,E,L)=>{r.getVec($[4*E],I),r.getVec($[4*E+1],S),L[E]=St(I,S)}),Y.sort((M,E)=>F[E]-F[M]);const Z=new Array,tt=new Array;for(let M=0;M<n;M++){const E=Y[M],L=F[E],W=$[4*E],pt=$[4*E+1],V=$[4*E+2],_=$[4*E+3],et=_===R;if(r.getVec(W,I),r.getVec(pt,S),et)X(d,O[3*V],O[3*V+1],O[3*V+2]),ot(v,d),u.componentIndex=i.get(W),u.cosAngle=U(d,v);else{if(X(d,O[3*V],O[3*V+1],O[3*V+2]),X(v,O[3*_],O[3*_+1],O[3*_+2]),u.componentIndex=i.get(W),u.cosAngle=U(d,v),yt(u,f))continue;u.cosAngle<-.9999&&ot(v,d)}y+=L,A++,et||$t(u,p)?(e.write(c,g++,u),Z.push(L)):Pt(u,N)&&(o.write(h,T++,u),tt.push(L))}const mt=new Float32Array(Z.reverse()),Nt=new Float32Array(tt.reverse());return{regular:{instancesData:e.trim(c,g),lodInfo:{lengths:mt}},silhouette:{instancesData:o.trim(h,T),lodInfo:{lengths:Nt}},averageEdgeLength:y/A}}function $t(t,e){return t.cosAngle<e}function yt(t,e){return t.cosAngle>e}function Pt(t,e){const o=Ot(t.cosAngle),s=j.fwd,r=j.ortho;return ht(s,t.position1,t.position0),o*(U(lt(r,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function Rt(t){const e=t.faces.length/3,o=t.faces,s=t.neighbors;let r=0;for(let a=0;a<e;a++){const p=s[3*a],f=s[3*a+1],u=s[3*a+2],I=o[3*a],S=o[3*a+1],d=o[3*a+2];r+=p===R||I<S?1:0,r+=f===R||S<d?1:0,r+=u===R||d<I?1:0}const i=new Int32Array(4*r);let N=0;for(let a=0;a<e;a++){const p=s[3*a],f=s[3*a+1],u=s[3*a+2],I=o[3*a],S=o[3*a+1],d=o[3*a+2];(p===R||I<S)&&(i[N++]=I,i[N++]=S,i[N++]=a,i[N++]=p),(f===R||S<d)&&(i[N++]=S,i[N++]=d,i[N++]=a,i[N++]=f),(u===R||d<I)&&(i[N++]=d,i[N++]=I,i[N++]=a,i[N++]=u)}return i}function Mt(t){const e=t.faces.length/3,o=t.vertices.position,s=t.faces,r=H.v0,i=H.v1,N=H.v2,a=new Float32Array(3*e);for(let p=0;p<e;p++){const f=s[3*p],u=s[3*p+1],I=s[3*p+2];o.getVec(f,r),o.getVec(u,i),o.getVec(I,N),rt(i,i,r),rt(N,N,r),lt(r,i,N),ut(r,r),a[3*p]=r[0],a[3*p+1]=r[1],a[3*p+2]=r[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(st||(st={}));const j={edge:{position0:w(),position1:w(),faceNormal0:w(),faceNormal1:w(),componentIndex:0,cosAngle:0},ortho:w(),fwd:w()},H={v0:w(),v1:w(),v2:w()},Vt={anglePlanar:4,angleSignificantEdge:35};function it(t,e,o){const s=e/3,r=new Uint32Array(o+1),i=new Uint32Array(o+1),N=(n,c)=>{n<c?r[n+1]++:i[c+1]++};for(let n=0;n<s;n++){const c=t[3*n],g=t[3*n+1],m=t[3*n+2];N(c,g),N(g,m),N(m,c)}let a=0,p=0;for(let n=0;n<o;n++){const c=r[n+1],g=i[n+1];r[n+1]=a,i[n+1]=p,a+=c,p+=g}const f=new Uint32Array(6*s),u=r[o],I=(n,c,g)=>{if(n<c){const m=r[n+1]++;f[2*m]=c,f[2*m+1]=g}else{const m=i[c+1]++;f[2*u+2*m]=n,f[2*u+2*m+1]=g}};for(let n=0;n<s;n++){const c=t[3*n],g=t[3*n+1],m=t[3*n+2];I(c,g,n),I(g,m,n),I(m,c,n)}const S=(n,c)=>{const g=2*n,m=c-n;for(let h=1;h<m;h++){const T=f[g+2*h],y=f[g+2*h+1];let A=h-1;for(;A>=0&&f[g+2*A]>T;A--)f[g+2*A+2]=f[g+2*A],f[g+2*A+3]=f[g+2*A+1];f[g+2*A+2]=T,f[g+2*A+3]=y}};for(let n=0;n<o;n++)S(r[n],r[n+1]),S(u+i[n],u+i[n+1]);const d=new Int32Array(3*s),v=(n,c)=>n===t[3*c]?0:n===t[3*c+1]?1:n===t[3*c+2]?2:-1,O=(n,c)=>{const g=v(n,c);d[3*c+g]=-1},$=(n,c,g,m)=>{const h=v(n,c);d[3*c+h]=m;const T=v(g,m);d[3*m+T]=c};for(let n=0;n<o;n++){let c=r[n];const g=r[n+1];let m=i[n];const h=i[n+1];for(;c<g&&m<h;){const T=f[2*c],y=f[2*u+2*m];T===y?($(n,f[2*c+1],y,f[2*u+2*m+1]),c++,m++):T<y?(O(n,f[2*c+1]),c++):(O(y,f[2*u+2*m+1]),m++)}for(;c<g;)O(n,f[2*c+1]),c++;for(;m<h;)O(f[2*u+2*m],f[2*u+2*m+1]),m++}return d}class gt{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?xt:Dt}write(e,o,s){const r=this._edgeHashFunction(s);b.seed=r;const i=b.getIntRange(0,255),N=b.getIntRange(0,this.settings.variants-1),a=.7,p=b.getFloat(),f=255*(.5*Ct(-(1-Math.min(p/a,1))+Math.max(0,p-a)/(1-a),1.2)+.5);e.position0.setVec(o,s.position0),e.position1.setVec(o,s.position1),e.componentIndex.set(o,s.componentIndex),e.variantOffset.set(o,i),e.variantStroke.set(o,N),e.variantExtension.set(o,f)}trim(e,o){return e.slice(0,o)}}const Q=new Float32Array(6),B=new Uint32Array(Q.buffer),P=new Uint32Array(1);function Dt(t){const e=Q;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],P[0]=5381;for(let o=0;o<B.length;o++)P[0]=31*P[0]+B[o];return P[0]}function xt(t){const e=Q;e[0]=D(t.position0[0]),e[1]=D(t.position0[1]),e[2]=D(t.position0[2]),e[3]=D(t.position1[0]),e[4]=D(t.position1[1]),e[5]=D(t.position1[2]),P[0]=5381;for(let o=0;o<B.length;o++)P[0]=31*P[0]+B[o];return P[0]}const ct=1e4;function D(t){return Math.round(t*ct)/ct}function Ct(t,e){const o=t<0?-1:1;return Math.abs(t)**e*o}class q{constructor(){this._commonWriter=new gt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return K.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s),At(x,s.faceNormal0,s.faceNormal1),ut(x,x);const{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;z(r,o,x[0],x[1],x[2],i)}trim(e,o){return this._commonWriter.trim(e,o)}}q.Layout=K,q.glLayout=J(K,1);class G{constructor(){this._commonWriter=new gt}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return k.createBuffer(e)}write(e,o,s){this._commonWriter.write(e,o,s);{const{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;z(r,o,s.faceNormal0[0],s.faceNormal0[1],s.faceNormal0[2],i)}{const{typedBuffer:r,typedBufferStride:i}=e.normal2Compressed;z(r,o,s.faceNormal1[0],s.faceNormal1[1],s.faceNormal1[2],i)}}trim(e,o){return this._commonWriter.trim(e,o)}}G.Layout=k,G.glLayout=J(k,1);const x=w(),b=new Et;function Kt(t){const e=Lt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return at.updateSettings(t.writerSettings),ft.updateSettings(t.writerSettings),vt(e,at,ft)}function Lt(t,e,o,s){if(e){const N=it(o,s,t.count);return new Ft(o,s,N,t)}const r=dt(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:s}),i=it(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:Tt.createView(r.buffer)}}class Ft{constructor(e,o,s,r){this.faces=e,this.facesLength=o,this.neighbors=s,this.vertices=r}}const at=new q,ft=new G,kt=C().vec3f(l.POSITION0).vec3f(l.POSITION1),jt=C().vec3f(l.POSITION0).vec3f(l.POSITION1).u16(l.COMPONENTINDEX);export{Tt as I,zt as R,wt as S,Ut as T,vt as a,kt as d,Kt as f,jt as m,st as p,Lt as u,G as w,q as y};
