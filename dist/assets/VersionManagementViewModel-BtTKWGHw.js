function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/createVersion-Bl_REmYH.js","assets/index-8ERthB3p.js","assets/index-CzRN3C0i.css","assets/utils-1zmckiYC.js","assets/CreateVersionParameters-BUEDWzXv.js","assets/deleteVersion-DKu1XfQA.js","assets/serverVersionUtils-BfJfWaCL.js","assets/DeleteVersionParameters-CO-3_2dw.js","assets/getVersion-DCiK8bqr.js","assets/getVersionInfos-D9mxgnNW.js","assets/GetVersionInfosParameters-DGLKxNv8.js","assets/reconcile-XhSmhDoW.js","assets/ReconcileParameters-Dz1CWtgA.js","assets/post-CUa0vubR.js","assets/PostParameters-BpcCNbVi.js","assets/alterVersion-HBZGNYag.js","assets/AlterVersionParameters-uDIkLafR.js","assets/startReading-D9t8eXYf.js","assets/stopReading-B0jjyaP7.js","assets/startEditing-D53ilrm-.js","assets/deleteForwardEdits-C5T4vrrS.js","assets/DeleteForwardEditsParameters-D-_etqFB.js","assets/stopEditing-DsM3ffn0.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{dY as $,d_ as z,t as J,ac as W,af as B,T as P,q as F,z as X,A as Y,B as K,E,U as k,s as L,o as d,y as l,aV as j,X as M,l3 as w,l4 as N,p as Z,l5 as ee,l6 as h,l7 as I,l8 as te,l9 as D,_ as c,la as V,iw as re,ei as ie,bO as se,cr as oe,gl as ne,P as A,Q as ae}from"./index-8ERthB3p.js";import{h as de}from"./UpdatingHandles-ugzlsvZF.js";import{t as ue}from"./utils-CPwzm7iO.js";import{p as C,g as le,m as ce,h as pe,b as he,I as me}from"./applyEditsUtils-Bml9xaqK.js";import{checkEditingCapabilities as ge,normalizeEdits as fe,normalizeGeometries as ve}from"./editingSupport-Do2EBIMO.js";import{f as x,n as _e,s as ye}from"./utils-1zmckiYC.js";import"./normalizeUtils-Cm7zySIZ.js";import"./normalizeUtilsCommon-DRIluWnF.js";import"./utils-D-bI9C7C.js";import"./infoFor3D-CxOdoily.js";function Ee(e){return{data:we(e),sync:ke(e),operations:Ve(e.capabilities,e),query:Se(e),editing:Ie(e)}}function we(e){return{isDataVersioned:w(e,"hasVersionedData",!1)}}function Ve(e,t){const r=e?e.toLowerCase().split(",").map(u=>u.trim()):[],i=r.includes("query"),o=r.includes("editing")&&!t.datesInUnknownTimezone;let n=o&&r.includes("create"),s=o&&r.includes("delete"),a=o&&r.includes("update");return o&&!(n||s||a)&&(n=s=a=!0),{supportsAdd:n,supportsDelete:s,supportsEditing:o,supportsChangeTracking:r.includes("changetracking"),supportsQuery:i,supportsQueryDataElements:w(t,"supportsQueryDataElements",!1),supportsQueryDomains:w(t,"supportsQueryDomains",!1),supportsQueryContingentValues:w(t,"supportsQueryContingentValues",!1),supportsSync:r.includes("sync"),supportsUpdate:a}}function Se(e){return{maxRecordCountFactor:N(e,"maxRecordCountFactor",void 0),maxRecordCount:N(e,"maxRecordCount",void 0)}}function Ie(e){const t=e==null?void 0:e.advancedEditingCapabilities;return{supportsGlobalId:w(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:w(t,"supportsReturnServiceEditsInSourceSR",!1),supportsSplit:w(t,"supportsSplit",!1),supportsAsyncApplyEdits:w(t,"supportsAsyncApplyEdits",!1)}}function ke(e){const t=e==null?void 0:e.syncCapabilities,r=t==null?void 0:t.supportedSyncDataOptions;return{supportsAsync:w(t,"supportsAsync",!1),supportedSyncDataOptions:{annotations:(1&r)==1,dimensions:(2&r)==2,contingentValues:(4&r)==4,attributeRules:(8&r)==8,utilityNetworkSystem:(16&r)==16,annotationFullModel:(32&r)==32,include3DObjects:(64&r)==64,utilityNetworkMissingLayers:(128&r)==128,preserveTrueCurves:(256&r)==256}}}let _=class extends $(z(J)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userTypeExtensions=[],this.layerInfos=[],this.tableInfos=[],this.capabilities=null}read(e,t){this.sourceJSON=e,super.read(e,t)}get utilityNetworkUrl(){for(const e of this.sourceJSON.layers)if(e.type==="Utility Network Layer")return`${this.url}/${e.id}`;return null}get versionManagementServiceUrl(){return this.sourceJSON.hasBranchVersionedData?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readCapabilities(e,t){return Ee(t)}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async applyEdits(e,t){let r=null;try{const{results:i,edits:o,editedFeatures:n}=await this._internalApplyEdits(e,t),s=u=>u.filter(m=>!m.error).map(W);let a=0;return i.map(u=>{r=B(this.url,u.id,t==null?void 0:t.gdbVersion,!0);const m={edits:o[a],addedFeatures:s(u.addFeatureResults),updatedFeatures:s(u.updateFeatureResults),deletedFeatures:s(u.deleteFeatureResults),addedAttachments:s(u.addAttachmentResults),updatedAttachments:s(u.updateAttachmentResults),deletedAttachments:s(u.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:u.editMoment?new Date(u.editMoment):null};a+=1,n.length>0&&(m.editedFeatures=n),r.resolve(m),r=null}),i}catch(i){throw r&&r.reject(i),i}}async _internalApplyEdits(e,t){const r=(t==null?void 0:t.globalIdUsed)??!1,i=P.fromJSON(this.sourceJSON.spatialReference),{edits:o,options:n}=await this._processApplyEditsParams(e,t),s=await Promise.all(o.map(async v=>{var T,b;const S=((T=v.addFeatures)==null?void 0:T.map(R=>C({spatialReference:i},R,null)))??[],U=(await Promise.all(S)).filter(F),H=((b=v.updateFeatures)==null?void 0:b.map(R=>C({spatialReference:i},R,null)))??[],O=(await Promise.all(H)).filter(F),G=le(v.identifierFields,v.deleteFeatures,r);X(U,O,i);const Q=await ce(v.identifierFields,v);return{id:v.id,adds:U,updates:O,deletes:G,attachments:Q}})),a={gdbVersion:n==null?void 0:n.gdbVersion,rollbackOnFailure:!0,useGlobalIds:r,returnEditMoment:!0,honorSequenceOfEdits:n==null?void 0:n.honorSequenceOfEdits,usePreviousEditMoment:n==null?void 0:n.usePreviousEditMoment,returnServiceEditsInSourceSR:n==null?void 0:n.returnServiceEditsInSourceSR,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await Y(this.url,t==null?void 0:t.gdbVersion,!0);const u=K(this.url,(t==null?void 0:t.gdbVersion)||null);a.edits=JSON.stringify(s);const m=x(this.url),p=_e(m.query,{query:ye({...a,f:"json"}),method:"post"});let f;u&&(p.authMode="immediate",p.query.sessionId=E);try{f=await k(this.url+"/applyEdits",p)}catch(v){if(!pe(v))throw v;p.authMode="immediate",f=await k(this.url+"/applyEdits",p)}return{...this._createServiceEditsResult(f),edits:o}}_createServiceEditsResult(e){const t=e.data,r=[];return{results:t.map(i=>{const o={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment},n=he(o),s=i.editedFeatures,a=s!=null&&s.spatialReference?new P({wkid:s==null?void 0:s.spatialReference.wkid,wkt:s==null?void 0:s.spatialReference.wkt,latestWkid:s==null?void 0:s.spatialReference.latestWkid,latestVcsWkid:s==null?void 0:s.spatialReference.latestVcsWkid,vcsWkid:s==null?void 0:s.spatialReference.vcsWkid}):null,u=s?me(s,a):null;return u&&r.push({layerId:i.id,editedFeatures:u}),{id:i.id,editedFeatures:u,...n}}),editedFeatures:r}}async _processApplyEditsParams(e,t){const r={...t};return{edits:await Promise.all(e.map(async i=>{const o=this.capabilities,n=i&&(i.addFeatures||i.updateFeatures||i.deleteFeatures),s=i&&(i.addAttachments||i.updateAttachments||i.deleteAttachments);if(ge(i,o,t,!!n,!!s,"feature-service"),!o.data.isDataVersioned&&(t==null?void 0:t.gdbVersion))throw new L("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");const a=fe(i,o,"feature-service");return{...await ve(a),id:i.id,identifierFields:i.identifierFields}})),options:r}}async _fetchService(e,t){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:x(e)});const r=await k(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data)}};d([l()],_.prototype,"url",void 0),d([l()],_.prototype,"sourceJSON",void 0),d([l({readOnly:!0})],_.prototype,"utilityNetworkUrl",null),d([l({readOnly:!0})],_.prototype,"versionManagementServiceUrl",null),d([l()],_.prototype,"userTypeExtensions",void 0),d([l({json:{read:{source:"layers"}}})],_.prototype,"layerInfos",void 0),d([l({json:{read:{source:"tables"}}})],_.prototype,"tableInfos",void 0),d([l({readOnly:!0,json:{read:{source:["hasVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],_.prototype,"capabilities",void 0),d([j("service","capabilities")],_.prototype,"readCapabilities",null),_=d([M("esri.services.FeatureService")],_);const Le=_,q=(e,t)=>{for(const r of e)if(r.type==="feature"||r.type==="subtype-group"){if(!r.url)continue;const i=Z(r.url).url.path,o=t.get(i);if(o)o.layers.push(r);else{const n=new Le({url:i}),s=[r];t.set(i,{featureService:n,layers:s})}}else r.type==="group"&&q(r.layers,t)};function Re(e){const t=new Map;return q(e,t),t}class xe{constructor(t){this.moments=[],this.forwardMoments=[],this.moments.push(t)}push(t){return this.forwardMoments.length,this.moments.push(t)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const t=this.moments.pop();return this.forwardMoments.push(t),t}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const t=this.forwardMoments.pop();return this.moments.push(t),t}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}}let y=class extends $(J){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._applyEditsHandler=t=>{const{serviceUrl:r,gdbVersion:i,result:o}=t;r===this._featureServiceUrl&&o.then(n=>{const s=n.historicMoment;s&&this._addMomentToVersionItem(i,s)})}}initialize(){this.url=ee(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),h.has(this.url)||h.set(this.url,new Map);const e=(I.get(this.url)??0)+1;I.set(this.url,e),this.when().then(()=>this.addHandles(te(this._applyEditsHandler)),()=>{})}destroy(){const e=(I.get(this.url)??1)-1;I.set(this.url,e),e===0&&h.delete(this.url),D.delete(this._featureServiceUrl)}read(e,t){this.sourceJSON=e,super.read(e,t)}readDefaultVersionIdentifier(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}}writeDefaultVersionIdentifier(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async createVersion(e){const[{createVersion:t},{default:r}]=await Promise.all([c(()=>import("./createVersion-Bl_REmYH.js"),__vite__mapDeps([0,1,2,3])),c(()=>import("./CreateVersionParameters-BUEDWzXv.js"),__vite__mapDeps([4,1,2]))]),i=r.from(e);return t(this.url,i)}async deleteVersion(e){var n;const[{deleteVersion:t},{default:r}]=await Promise.all([c(()=>import("./deleteVersion-DKu1XfQA.js"),__vite__mapDeps([5,1,2,3,6])),c(()=>import("./DeleteVersionParameters-CO-3_2dw.js"),__vite__mapDeps([7,1,2]))]);let i;e.guid&&((n=h.get(this.url))!=null&&n.has(e.guid))&&(i=E??void 0);const o=new r({versionName:e.name,sessionId:i});return t(this.url,o)}async getVersionInfoExtended(e){const{getVersion:t}=await c(()=>import("./getVersion-DCiK8bqr.js"),__vite__mapDeps([8,1,2,3]));return t(this.url,e.guid)}async getVersionInfos(e={}){const[{getVersionInfos:t},{default:r}]=await Promise.all([c(()=>import("./getVersionInfos-D9mxgnNW.js"),__vite__mapDeps([9,1,2,3])),c(()=>import("./GetVersionInfosParameters-DGLKxNv8.js"),__vite__mapDeps([10,1,2]))]),i=r.from(e);return t(this.url,i)}async reconcile(e,t={}){const[{reconcile:r},{default:i}]=await Promise.all([c(()=>import("./reconcile-XhSmhDoW.js"),__vite__mapDeps([11,1,2,3,6])),c(()=>import("./ReconcileParameters-Dz1CWtgA.js"),__vite__mapDeps([12,1,2]))]),o=i.from(t);return o.sessionId=E,r(this.url,e.guid,o)}async post(e){const[{post:t},{default:r}]=await Promise.all([c(()=>import("./post-CUa0vubR.js"),__vite__mapDeps([13,1,2,3,6])),c(()=>import("./PostParameters-BpcCNbVi.js"),__vite__mapDeps([14,1,2]))]),i=r.from({sessionId:E});return t(this.url,e.guid,i)}async alterVersion(e,t){const[{alterVersion:r},{default:i}]=await Promise.all([c(()=>import("./alterVersion-HBZGNYag.js"),__vite__mapDeps([15,1,2,3,6])),c(()=>import("./AlterVersionParameters-uDIkLafR.js"),__vite__mapDeps([16,1,2]))]),o=i.from(t);return r(this.url,e.guid,o)}async startReading(e){const{startReading:t}=await c(()=>import("./startReading-D9t8eXYf.js"),__vite__mapDeps([17,1,2,3])),r=await t(this.url,e.guid,E);if(r){const i=await this.getVersionInfoExtended(e),o=new Date(i.modifiedDate),n={name:i.versionIdentifier.name,moment:o,lockType:"read"};this._addOrUpdateItem(e.guid,n),V(this._featureServiceUrl,null,e.name,o)}return r}async stopReading(e){var i;const{stopReading:t}=await c(()=>import("./stopReading-B0jjyaP7.js"),__vite__mapDeps([18,1,2,3])),r=await t(this.url,e.guid,E);return r&&((i=h.get(this.url))==null||i.delete(e.guid),V(this._featureServiceUrl,null,e.name,null)),r}async startEditing(e){const{startEditing:t}=await c(()=>import("./startEditing-D53ilrm-.js"),__vite__mapDeps([19,1,2,3])),r=await t(this.url,e.guid,E);if(r){const i=await this.getVersionInfoExtended(e),o=new Date(i.modifiedDate),n=new xe(o),s={name:e.name,moment:o,lockType:"edit",stack:n};this._addOrUpdateItem(e.guid,s),V(this._featureServiceUrl,null,e.name,o)}return r}async stopEditing(e,t){var o,n;if(t){const s=(o=h.get(this.url))==null?void 0:o.get(e.guid);if((n=s==null?void 0:s.stack)!=null&&n.canRedo()){const[{deleteForwardEdits:a},{default:u}]=await Promise.all([c(()=>import("./deleteForwardEdits-C5T4vrrS.js"),__vite__mapDeps([20,1,2,3])),c(()=>import("./DeleteForwardEditsParameters-D-_etqFB.js"),__vite__mapDeps([21,1,2]))]);if(!await a(this.url,e.guid,new u({sessionId:E,moment:s.moment})))return!1}}const{stopEditing:r}=await c(()=>import("./stopEditing-DsM3ffn0.js"),__vite__mapDeps([22,1,2,3])),i=await r(this.url,e.guid,E,t);if(i){const s=await this.getVersionInfoExtended(e),a=new Date(s.modifiedDate);this._addOrUpdateItem(e.guid,{name:e.name,moment:a,lockType:"read",editMomentStack:void 0}),V(this._featureServiceUrl,null,e.name,a)}return i}getLockType(e){var r,i;return((i=(r=h.get(this.url))==null?void 0:r.get(e.guid))==null?void 0:i.lockType)??"none"}changeVersionInternal(e,t,r){let i=null,o=null,n=null,s=null;const a=p=>!p||p===this.defaultVersionIdentifier.name,u=p=>{var v,S;const f=(S=(v=h)==null?void 0:v.get(this.url))==null?void 0:S.get(p.guid);n=p.name,s=(f==null?void 0:f.moment)??null},m=(p,f)=>!p&&!f||!(!p||!f)&&p.toISOString()===f.toISOString();if("name"in t){if(this.getLockType(t)!=="none")return!1;i=t.name,o=null,"name"in r?u(r):(n=this.defaultVersionIdentifier.name,s=r)}else i=this.defaultVersionIdentifier.name,o=t,"name"in r?u(r):(n=this.defaultVersionIdentifier.name,s=r);return(a(i)&&a(e.gdbVersion)&&m(e.historicMoment,o)||i===e.gdbVersion&&m(e.historicMoment,o))&&(e.gdbVersion=n,e.historicMoment=s),!0}async changeVersion(e,t,r){if("name"in r&&!await this.getVersionInfoExtended(r))throw new L("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in e){if(this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase())return this.changeVersionInternal(e,t,r)}else{let i;"layers"in e?(i=e.allTables.concat(e.allLayers),e.utilityNetworks&&e.utilityNetworks.forEach(o=>{this._featureServiceUrl.toLowerCase()===o.featureServiceUrl.toLowerCase()&&this.changeVersionInternal(o,t,r)})):i=e;for(const o of i)if(o.type==="feature"||o.type==="subtype-group"){const n=/^(.*\/FeatureServer)\/\d+$/,s=o.url.replace(n,"$1");if(this._featureServiceUrl.toLowerCase()===s.toLowerCase()&&!this.changeVersionInternal(o,t,r))return!1}else if(o.type==="group"){const n=o.allTables.concat(o.allLayers);for(const s of n)if(s.type==="feature"||s.type==="subtype-group"){const a=/^(.*\/FeatureServer)\/\d+$/,u=s.url.replace(a,"$1");if(this._featureServiceUrl.toLowerCase()===u.toLowerCase()&&!this.changeVersionInternal(s,t,r))return!1}}}return!0}async getVersionIdentifierFromName(e){var t;try{return((t=(await this.getVersionInfos({includeHidden:!0})).find(i=>i.versionIdentifier.name===e))==null?void 0:t.versionIdentifier)||null}catch{return null}}async getVersionIdentifierFromGuid(e){const{getVersion:t}=await c(()=>import("./getVersion-DCiK8bqr.js"),__vite__mapDeps([8,1,2,3]));try{return(await t(this.url,e)).versionIdentifier}catch{return null}}canUndo(e){var r,i;const t=(r=h.get(this.url))==null?void 0:r.get(e.guid);return!!((i=t==null?void 0:t.stack)!=null&&i.canUndo())}canRedo(e){var r,i;const t=(r=h.get(this.url))==null?void 0:r.get(e.guid);return!!((i=t==null?void 0:t.stack)!=null&&i.canRedo())}undo(e){var i,o,n;const t=(i=h.get(this.url))==null?void 0:i.get(e.guid),r=((o=t==null?void 0:t.stack)==null?void 0:o.undo())||void 0;if(t&&r){const s=t.stack.peek();V(this._featureServiceUrl,null,e.name,s),(n=h.get(this.url))==null||n.set(e.guid,{...t,moment:s})}}redo(e){var i,o,n;const t=(i=h.get(this.url))==null?void 0:i.get(e.guid),r=((o=t==null?void 0:t.stack)==null?void 0:o.redo())||void 0;t&&r&&(V(this._featureServiceUrl,null,e.name,r),(n=h.get(this.url))==null||n.set(e.guid,{...t,moment:r}))}_addMomentToVersionItem(e,t){const r=h.get(this.url);if(r)for(const[i,o]of r)o.name===e&&this._addToStack(i,t)}_canAddToStack(e,t){return e?e.getTime()<t.getTime():!0}_addToStack(e,t){const r=h.get(this.url),i=r==null?void 0:r.get(e);return!!(i!=null&&i.stack)&&(this._canAddToStack(i.stack.peek(),t)&&i.stack.push(t),r.set(e,{...i,moment:t}),!0)}_addOrUpdateItem(e,t){const r=h.get(this.url),i=r==null?void 0:r.get(e);return i?(r.set(e,{...i,...t}),!0):!(!t.name||!t.lockType)&&(r==null||r.set(e,{...t,lockType:t.lockType}),!0)}async _fetchService(e,t){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:x(e)});const i=new re(this.url).host;return void D.set(i,this.defaultVersionIdentifier.name)}const r=await k(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data)}};d([l()],y.prototype,"url",void 0),d([l()],y.prototype,"sourceJSON",void 0),d([l({type:String,json:{write:!0}})],y.prototype,"name",void 0),d([l({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],y.prototype,"defaultVersionIdentifier",void 0),d([j("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],y.prototype,"readDefaultVersionIdentifier",null),d([ie("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],y.prototype,"writeDefaultVersionIdentifier",null),d([l({json:{write:!0}})],y.prototype,"capabilities",void 0),y=d([M("esri.versionManagement.VersionManagementService")],y);const Me=y;let g=class extends se{constructor(e){super(e),this._initialValidationsFinished=!1,this._portalLookup=new Map,this._updatingHandles=new de,this._validConstructProperties=!0,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map}initialize(){this.addHandles([oe(()=>{var e;return(e=this.view)==null?void 0:e.map.layers.toArray()},async()=>{await this._onLayersChange()},ne)])}destroy(){this._updatingHandles.destroy()}get state(){return this.loadError||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._initialValidationsFinished?"ready":"loading"}set view(e){this._get("view")!==e&&this._set("view",e)}async alterVersion(e){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const t=this.versionManagementServiceLookup.get(e.featureServerUrl);if(!t)return void this._logNoVersionManagementServiceFoundError();if(!this.serverVersionLookup.has(e.featureServerUrl)||this.serverVersionLookup.get(e.featureServerUrl)<=11.1)return void this._logError("execution-error","no-valid-enterprise-version");if(!this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl))return void this._logError("execution-error","no-advanced-editing-user-type-extension");const{featureServerUrl:r,versionIdentifier:i,...o}=e;await t.alterVersion(i,o).catch(async n=>{await this.getVersionInfos(r,!0),this._logExecutionError(n)})})()):this._logError("load-error",this.loadError)}async changeVersion(e,t,r){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{var s;this._setExecutionError();const i=this.versionManagementServiceLookup.get(e);if(!i)return void this._logNoVersionManagementServiceFoundError();const o=this.versionIdentifierLookup.get(e)??{name:i.defaultVersionIdentifier.name,guid:i.defaultVersionIdentifier.guid},n={name:t,guid:r};await i.changeVersion((s=this.view)==null?void 0:s.map,o,n).catch(a=>{this._logExecutionError(a)})&&this.versionIdentifierLookup.set(e,n)})()):this._logError("load-error",this.loadError)}async createVersion(e){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{var a,u;this._setExecutionError();const t=e.featureServerUrl,r=this.versionManagementServiceLookup.get(t);if(!r)return void this._logNoVersionManagementServiceFoundError();const i=this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl),o=this.userLookup.get(t).toUpperCase(),n=this._isEmptyString(e.ownerName)?o:(a=e.ownerName)==null?void 0:a.trim().toUpperCase();if(n!==o){if(this.serverVersionLookup.get(t)<=11.1)return void this._logError("execution-error","versioning-api-error");if(!i)return void this._logError("execution-error","no-advanced-editing-user-type-extension")}if((n==null?void 0:n.toUpperCase())==="SDE"&&e.versionName.toUpperCase()==="DEFAULT"||(u=this.versionInfoLookup.get(t))!=null&&u.find(m=>m.versionIdentifier.name.toUpperCase()===(n+"."+e.versionName).toUpperCase()||m.versionIdentifier.name.toUpperCase()===(o+"."+e.versionName).toUpperCase()))return void this._logError("execution-error","no-valid-version-name");const s=await r.createVersion({versionName:e.versionName,access:n!==o?"public":e.access,description:e.description}).catch(m=>{this._logExecutionError(m)});if(!this.executionError&&n!==o){const{guid:m,name:p}=s.versionIdentifier,f={featureServerUrl:t,versionIdentifier:{guid:m,name:p},access:e.access,ownerName:n};await this.alterVersion(f),this.executionError&&this.deleteVersion(t,o+"."+e.versionName,s.versionIdentifier.guid)}await this.getVersionInfos(t,!0)})()):this._logError("load-error",this.loadError)}async deleteVersion(e,t,r){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const i=this.versionManagementServiceLookup.get(e);if(!i)return void this._logNoVersionManagementServiceFoundError();if(this.serverVersionLookup.get(e)<=11.1)return void this._logError("execution-error","versioning-api-error");if(!this.advancedEditingUserTypeExtensionLookup.get(e))return void this._logError("execution-error","no-advanced-editing-user-type-extension");const o={name:t,guid:r};await i.deleteVersion(o).catch(n=>{this._logExecutionError(n)})&&await this.getVersionInfos(e,!0).catch(n=>{this._logExecutionError(n)})})()):this._logError("load-error",this.loadError)}async getVersionInfos(e,t){if(this.state!=="disabled")return await this._updatingHandles.addPromise((async()=>{var o,n;this._setExecutionError();const r=(o=this.featureServiceLookup.get(e))==null?void 0:o.featureService;if(!r)return void this._logError("execution-error","no-feature-service-found");if(!r.loaded){await r.load().catch(u=>{this._logExecutionError(u)});const s=r.url;this.serverVersionLookup.set(s,((n=r.sourceJSON)==null?void 0:n.currentVersion)??0),this.serverVersionLookup.get(s)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(s,!1);const a=this.userLookup.get(e);this._portalLookup.get(e)&&a?this.advancedEditingUserTypeExtensionLookup.set(s,await ue(this._portalLookup.get(e),a,"advediting")):this.advancedEditingUserTypeExtensionLookup.set(s,!1)}r.versionManagementServiceUrl&&this.versionManagementServiceLookup.set(r.url,new Me({url:r.versionManagementServiceUrl}));const i=this.versionManagementServiceLookup.get(e);if(i){if(i.loaded||await i.load().catch(s=>{this._logExecutionError(s)}),!this.versionInfoLookup.get(e)||t){const s=await i.getVersionInfos().catch(a=>{this._logExecutionError(a)});this.versionInfoLookup.set(e,s)}}else this._logNoVersionManagementServiceFoundError()})()),this.versionInfoLookup.get(e);this._logError("load-error",this.loadError)}_isEmptyString(e){return!e||e.trim().length===0}_logError(e,t){switch(e){case"load-error":this._setLoadError(t),A.getLogger(this).error(new L(e,t));break;case"execution-error":this._setExecutionError(t),A.getLogger(this).error(new L(e,t))}}_logExecutionError(e){this._logError("execution-error",e.message)}_logNoVersionManagementServiceFoundError(){this._logError("execution-error","no-version-management-service-found")}async _onLayersChange(){var e;if(this._initialValidationsFinished=!1,this._setLoadError(),this._validConstructProperties=!0,!this.view)return this._logError("load-error","no-view-property"),void(this._validConstructProperties=!1);if(this.featureServiceLookup=Re(this.view.map.layers),!this.featureServiceLookup.size)return this._logError("load-error","no-feature-services"),void(this._validConstructProperties=!1);for(const t of this.featureServiceLookup.keys())if(!this.serviceNameLookup.has(t)){this.serviceNameLookup.set(t,t.split("/").at(-2));const r=new ae({authMode:"immediate",url:new URL(t).origin+"/portal"});await r.load(),this._portalLookup.set(t,r);const i=(e=r==null?void 0:r.user)==null?void 0:e.username;i&&this.userLookup.set(t,i)}this._initialValidationsFinished=!0}_setExecutionError(e){this._set("executionError",e)}_setLoadError(e){this._set("loadError",e)}};d([l()],g.prototype,"_initialValidationsFinished",void 0),d([l({readOnly:!0})],g.prototype,"advancedEditingUserTypeExtensionLookup",void 0),d([l({readOnly:!0})],g.prototype,"executionError",void 0),d([l()],g.prototype,"featureServiceLookup",void 0),d([l({readOnly:!0})],g.prototype,"loadError",void 0),d([l({readOnly:!0})],g.prototype,"serverVersionLookup",void 0),d([l()],g.prototype,"serviceNameLookup",void 0),d([l({readOnly:!0})],g.prototype,"state",null),d([l({readOnly:!0})],g.prototype,"userLookup",void 0),d([l({readOnly:!0})],g.prototype,"versionIdentifierLookup",void 0),d([l()],g.prototype,"versionInfoLookup",void 0),d([l()],g.prototype,"versionManagementServiceLookup",void 0),d([l()],g.prototype,"view",null),g=d([M("esri.widgets.VersionManagement.VersionManagementViewModel")],g);const $e=g;export{$e as default};
