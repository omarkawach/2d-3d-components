import{o,y as e,X as d,gI as O,bO as M,gJ as y,cN as k,cr as _,a7 as R,s as T,W as $}from"./index-8ERthB3p.js";import{o as C}from"./StreamFeatureManager-BeWeOtNg.js";import{createConnection as G}from"./createConnection-Bx-WZj1C.js";import{h as P}from"./EventedSet-DUmR4FeL.js";import{b as j}from"./HeatmapDensity.glsl-BN4vWD93.js";import{n as x}from"./LayerView3D-y7LfmsJ-.js";import{C as E}from"./RenderGeometry-rcUvJmRA.js";import{u as U}from"./LayerView-DO6TerBv.js";import{r as V}from"./StreamLayerView-D8lANDSI.js";import"./CircularArray-DfLrgW_-.js";import"./query-BtFvR4zF.js";import"./normalizeUtils-Cm7zySIZ.js";import"./normalizeUtilsCommon-DRIluWnF.js";import"./utils-1zmckiYC.js";import"./utils-D-bI9C7C.js";import"./pbfQueryUtils-D79yLlDs.js";import"./pbf-C8CvrhFv.js";import"./OptimizedGeometry-DLPswkPy.js";import"./OptimizedFeature-CXeSoBCN.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./signal-DoM1gSF0.js";import"./hydratedFeatures-DqrDm0_F.js";import"./projectVectorToVector-C3SBBDgz.js";import"./projectPointToVector-qKp-AJ2b.js";import"./UpdatingHandles-ugzlsvZF.js";import"./geometryServiceUtils-B-h5lvUN.js";import"./project-7u3NBcq6.js";import"./ReactiveMap-C-O0lKvJ.js";import"./dehydratedFeatures-Cp-_lWz0.js";import"./ViewingMode-Dodu7ZZk.js";import"./dehydratedFeatureComparison-DdCJ1gSj.js";import"./EdgeShader.glsl-DNm98Ote.js";import"./Viewpoint-CB1GAuK3.js";import"./Cyclical-BY9qISY1.js";import"./jsxFactory-BxQYPm-b.js";import"./GraphicsCollection-CKieR40M.js";import"./WaterSurface.glsl-JBHYhfkH.js";import"./ColorMaterial.glsl-uPKQoFFi.js";import"./mat3-CqxUQBLP.js";import"./mat3f64-BBpwCtoL.js";import"./mat4f64-Dk4dwAN8.js";import"./vec2f64-Diu2Kaa8.js";import"./BufferView-CHYzaV9A.js";import"./vec2-Dt9Foiri.js";import"./Texture-C7A05GrI.js";import"./interfaces-B8ge7Jg9.js";import"./BindType-BmZEZMMh.js";import"./Util-B8vYs4k8.js";import"./enums-DSseSvdG.js";import"./Texture-O7Pyotwx.js";import"./VertexAttribute-BnAa5VW0.js";import"./basicInterfaces-DngWxyLO.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./doublePrecisionUtils-B0owpBza.js";import"./Material-DwPnlQDw.js";import"./ContentObject-BTgEhnct.js";import"./requestImageUtils-DP1V3HlH.js";import"./InterleavedLayout-s3MgOYN8.js";import"./types-D0PSWh4d.js";import"./VertexColor.glsl-CScvx9pF.js";import"./OrderIndependentTransparency-Cua2R8AE.js";import"./floatRGBA-CCqnXShd.js";import"./Attribute-B-NAci_J.js";import"./Geometry-CqGtfd4N.js";import"./Indices-DP3oX5Sg.js";import"./triangle-CTblFuF6.js";import"./ObjectStack-BPo9QGhV.js";import"./lineSegment-DVvvMBnG.js";import"./plane-Du3EYICn.js";import"./quatf64-BrpT0VRp.js";import"./mathUtils-iSLnUy_4.js";import"./vec2f32-BbH2jxlN.js";import"./featureConversionUtils-BzfH5fda.js";import"./sphere-Bf4ezJdT.js";import"./edgeUtils-D8J_3GIe.js";import"./earcut-BqgeR2O3.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./computeTranslationToOriginAndRotation-BbJd4iYX.js";import"./DoubleArray-068mylUp.js";import"./vec3-DPXcG_yS.js";import"./SnappingCandidate-O5eRSE6e.js";import"./triangulationUtils-C0V38kt7.js";import"./deduplicate-j8p9VETP.js";import"./ElevationProvider-Bd4qfXCi.js";import"./boundedPlane-CLJ-Xnn_.js";import"./verticalOffsetUtils-BYv4Nk2v.js";import"./orientedBoundingBox-BQvYwCTM.js";import"./quat-DUnoL8dP.js";import"./spatialReferenceEllipsoidUtils-CmEPjh7T.js";import"./Normals-BAXqRpCA.js";import"./objectResourceUtils-D-wPKn4W.js";import"./devEnvironmentUtils-Blrp8lZ5.js";import"./DefaultMaterial_COLOR_GAMMA-D4SZcGoz.js";import"./resourceUtils-ayGD6aG4.js";import"./NestedMap-DgiGbX8E.js";import"./symbolColorUtils-B_k_VgHH.js";import"./RenderState-DaVlEYWY.js";import"./CIMSymbolHelper-C-U_lWVp.js";import"./BidiEngine-DL33fnW5.js";import"./fontUtils-Dz0hN_7q.js";import"./GeometryUtils-_MjrRDxY.js";import"./enums-BRqP_wXA.js";import"./definitions-B54owTRu.js";import"./mat2d-D9yIh3Tx.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./cimSymbolUtils-DwzauUMk.js";import"./utils-j-RBNfeR.js";import"./lineStippleUtils-B9K4R8oO.js";import"./projectVectorToPoint-CPW7kXva.js";import"./MeshComponent-BCGFLGQh.js";import"./imageUtils-D1MsbWS6.js";import"./meshVertexSpaceUtils-KRc33Yrq.js";import"./MeshLocalVertexSpace-C8ABjEju.js";import"./georeference-CwPKO8dc.js";import"./axisAngleDegrees-CaSFQR2z.js";import"./interfaces-DkjgzG8v.js";import"./frustum-BrAPXuhm.js";import"./DefaultLayouts-BrmJbx_o.js";import"./webStyleSymbolUtils-BzDS5WjL.js";import"./glUtil-DS73TAjp.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Octree-E7a40xr7.js";import"./BufferObject-CaEbWulZ.js";import"./Intersector-CTjLkyei.js";import"./Scheduler-DaHJO6l7.js";import"./debugFlags-BbJIqrPU.js";import"./weather-D00pIeau.js";import"./RenderCoordsHelper-zH8WjGkC.js";import"./scaleUtils-0K_Ry6I1.js";import"./DefaultUI-DIlogOoy.js";import"./screenUtils-BuM_Fswi.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./heightModelInfoUtils-CdtST1Ra.js";import"./mat2df64-CBKYtunK.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-DfZw-NIf.js";import"./accessibleHandler-DsewpcQ5.js";import"./Compass-C-feYp_a.js";import"./utils-DsJqvptN.js";import"./GoTo-BzS22eXk.js";import"./NavigationToggle-QjJqvxo5.js";import"./Zoom-Ct1er6X1.js";import"./viewpointUtils-BxfIO3H-.js";import"./earthUtils-ir2LnhMw.js";import"./spatialReferenceSupport-DPLkW2jK.js";import"./ElevationSamplerData-CC_B5wrl.js";import"./terrainUtils-hfv3Mblf.js";import"./TileInfo-BsGWbS2H.js";import"./TileKey-DZd6gJy7.js";import"./Environment-B2HYg6Z1.js";import"./projectPointToWGS84ComparableLonLat-D5kdMIn_.js";import"./projectVectorToWGS84ComparableLonLat-DuPw0-Mv.js";import"./vec3f32-Cw9Q6TO_.js";import"./Program-BB52p2Mx.js";import"./ShadowCastVisualizeTechniqueConfiguration-DqJ__9Ii.js";import"./ray-CCzLdiTI.js";import"./ZoomMomentumEstimator-PITOvV-p.js";import"./labelFormatUtils-BN4HkzS9.js";import"./FeatureTileDescriptor3D-BLJXkD6Q.js";import"./elevationInfoUtils-sHEwmo9N.js";import"./ElevationQueryTileCache-CV2Fph_A.js";import"./LayerConstants-B33OP6sh.js";import"./Intersector-8rpRuT_8.js";import"./ElevationRange-BrgM1moX.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./LercDecoder-FUH0zkya.js";import"./WorkerHandle-DKpIZ9kk.js";import"./RenderableTile-CQN7Nxvi.js";import"./enums-BRzLM11V.js";import"./TileStrategy-BMTAwxMt.js";import"./TileKey-Drwp1tmy.js";import"./QueueProcessor-DFkcFyJt.js";import"./VertexArrayObject-Cv4RwmVi.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-Co_GH1pH.js";import"./DisplayObject-B9oc5ibO.js";import"./rasterUtils-DImlUReg.js";import"./StyleDefinition-pu9RBNlY.js";import"./resources-DJFXXcdR.js";import"./edgeProcessing-Crq4tMpw.js";import"./EdgeWorkerHandle-CAkTfCpv.js";import"./workerHelper-CE2O_zfa.js";import"./testSVGPremultipliedAlpha-Dsq4J0WV.js";import"./RenderingContext-CzjLpUzJ.js";import"./ProgramCache-DX9Ty2iR.js";import"./layerViewUtils-Bi2wmOiN.js";import"./queryForSymbologySnapping-8JLrvhsd.js";import"./hash-CcEbRgUF.js";import"./Graphics3DObjectStates-CZBjX6i5.js";import"./rendererConversion-eHDRAZSQ.js";import"./optimizedFeatureQueryEngineAdapter-DY8fepQr.js";import"./centroid-DdLmOD72.js";import"./PooledRBush-CjYPNqwP.js";import"./quickselect-D0_cvEX6.js";import"./popupUtils-BHYiW8I-.js";import"./floorFilterUtils-DZ5C6FQv.js";import"./QueryEngine-BnxbU8wo.js";import"./WhereClause-CDY1MzWK.js";import"./TimeOnly-CdukLkzZ.js";import"./timeSupport-BFvqZpey.js";import"./json-Wa8cmqdu.js";import"./QueryEngineCapabilities-CTDe3LlQ.js";import"./utils-RSnx-Q9D.js";import"./utils-B6UP7_Wm.js";import"./utils-8IYHD2E1.js";import"./ClassBreaksDefinition-CNLSnW5r.js";import"./FeatureStore-BZ4BTL-O.js";import"./BoundsStore-CvIYB3Tm.js";import"./heatmapTextureUtils-Ccf4XLi5.js";import"./projectExtentUtils-9sG7uFGp.js";const N=2500;let a=class extends R{getObjectId(){return this.objectId}};o([e({type:Number,json:{read:!0}})],a.prototype,"objectId",void 0),a=o([d("esri.layers.graphics.controllers.StreamGraphic")],a);class F{constructor(r){this.onUpdate=r,this._idToGraphic=new Map}destroy(){this._idToGraphic.clear()}add(r){this._idToGraphic.set(r.objectId,r)}get(r){return this._idToGraphic.get(r)}forEach(r){this._idToGraphic.forEach(r)}removeById(r){const i=this._idToGraphic.get(r);return i?(i.sourceLayer=i.layer=null,this._idToGraphic.delete(r),i):null}update(r,i){this.onUpdate(r,i)}get size(){return this._idToGraphic.size}}let s=class extends O(M){constructor(){super(...arguments),this.isPaused=!1,this.graphics=new P,this._updateInfo={websocket:0,client:0},this._updateIntervalId=null,this._outSpatialReference=null}initialize(){this.addResolvingPromise(this.layer.when(()=>this._startup()))}destroy(){this.clear()}_clearInterval(){this._updateIntervalId!==null&&(clearInterval(this._updateIntervalId),this._updateIntervalId=null)}clear(){this._shutdown(),this.graphics.clear()}get updating(){return!this.connection||this.connection.connectionStatus==="connected"}_shutdown(){this._clearInterval(),this.connection=y(this.connection),this.store=y(this.store),this.removeAllHandles()}_startup(){const{layer:t,layerView:r}=this,{spatialReference:i,definitionExpression:m,geometryDefinition:c,objectIdField:l,timeInfo:f,purgeOptions:g,maxReconnectionAttempts:v,maxReconnectionInterval:I,customParameters:w}=t,S=t.geometryType?k.toJSON(t.geometryType):null,b=i,h=r.view.spatialReference;this.clear(),this._set("connection",G(t.parsedUrl,b,h,S,m,c,v,I,w??void 0)),this._outSpatialReference=h.toJSON(),this.store=new F(this._onUpdate.bind(this)),this.featuresManager=new C(this.store,l,f.toJSON(),g);const u="startup-watches";this.removeHandles(u),this.addHandles([t.on("send-message-to-socket",n=>this.connection.sendMessageToSocket(n)),t.on("send-message-to-client",n=>this.connection.sendMessageToClient(n)),this.connection.on("data-received",n=>this._onFeature(n)),this.connection.on("message-received",n=>this._onWebSocketMessage(n)),_(()=>[t.definitionExpression,t.geometryDefinition,t.purgeOptions],()=>this._startup())],u),this.isPaused||this._initUpdateInterval()}_onWebSocketMessage(t){if(this.layerView.emit("message-received",t),"type"in t)switch(t.type){case"delete":if(t.objectIds)for(const r of t.objectIds)this.featuresManager.removeById(r);if(t.trackIds)for(const r of t.trackIds)this.featuresManager.removeByTrackId(r);break;case"clear":this.store.forEach(r=>this.featuresManager.removeById(r.objectId))}}_onFeature(t){this._updateInfo.websocket++,this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry});try{t.geometry==null||t.geometry.spatialReference||(t.geometry.spatialReference=this._outSpatialReference);const r=a.fromJSON(t);r.sourceLayer=r.layer=this.layer,this.featuresManager.add(r)}catch{}}_onUpdate(t,r){r!=null&&this.graphics.removeMany(r),t!=null&&(this._updateInfo.client+=t.length,this.graphics.addMany(t))}_initUpdateInterval(){this._clearInterval();const{updateInterval:t}=this.layer;let r=performance.now();this._updateIntervalId=setInterval(()=>{const i=performance.now(),m=i-r;if(m>N){r=i;const c=Math.round(this._updateInfo.client/(m/1e3)),l=Math.round(this._updateInfo.websocket/(m/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",{client:c,websocket:l})}this.featuresManager.checkForUpdates()},t)}pauseStream(){this.isPaused=!0,this._clearInterval()}resumeStream(){this.isPaused=!1,this._initUpdateInterval()}disconnect(){this._shutdown()}connect(){this.connection==null&&this._startup()}clearGraphics(){this.graphics.clear()}};o([e()],s.prototype,"isPaused",void 0),o([e({constructOnly:!0})],s.prototype,"layer",void 0),o([e({constructOnly:!0})],s.prototype,"layerView",void 0),o([e()],s.prototype,"connection",void 0),o([e({readOnly:!0})],s.prototype,"updating",null),s=o([d("esri.layers.graphics.controllers.StreamController")],s);let p=class extends V(j(x(U))){constructor(){super(...arguments),this.type="stream-3d",this.updatePolicy=E.ASYNC,this.hasZ=!0,this.hasM=!1}initialize(){this.addHandles(_(()=>this.suspended,t=>{this.controller&&this._onSuspendedChange(t)}))}get connectionError(){var r,i;const t=(i=(r=this.controller)==null?void 0:r.connection)==null?void 0:i.errorString;return t?new T("stream-controller",t):null}createQuery(){return new $({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryLatestObservations(t,r){return this.queryEngine.executeQueryForLatestObservations(this._ensureQuery(t),r==null?void 0:r.signal)}get _streamConnectionStatus(){var t,r;return((r=(t=this.controller)==null?void 0:t.connection)==null?void 0:r.connectionStatus)??"disconnected"}createController(){return new s({layer:this.layer,layerView:this})}beforeSetController(){}_doPause(){var t;(t=this.controller)==null||t.pauseStream()}_doResume(){var t;(t=this.controller)==null||t.resumeStream()}_doDisconnect(){var t;(t=this.controller)==null||t.disconnect(),this._doPause()}_doConnect(){var t;(t=this.controller)==null||t.connect(),this.resume()}_doClear(){var t;(t=this.controller)==null||t.clearGraphics()}};o([e({readOnly:!0})],p.prototype,"updatePolicy",void 0),o([e({readOnly:!0})],p.prototype,"connectionError",null),o([e()],p.prototype,"controller",void 0),o([e({readOnly:!0})],p.prototype,"hasZ",void 0),o([e({readOnly:!0})],p.prototype,"hasM",void 0),o([e({readOnly:!0})],p.prototype,"_streamConnectionStatus",null),p=o([d("esri.views.3d.layers.StreamLayerView3D")],p);const Ji=p;export{Ji as default};
