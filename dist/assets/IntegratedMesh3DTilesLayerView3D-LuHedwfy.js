import{a7 as Le,s as Q,cr as be,gl as De,gJ as _e,cv as je,dQ as we,ku as Be,b_ as ke,kL as Ge,kM as Ne,bW as Y,di as ve,bV as $e,dE as ze,P as xe,o as D,y as K,X as We}from"./index-8ERthB3p.js";import{n as Je,s as Xe}from"./mat3-CqxUQBLP.js";import{e as Te,o as Z}from"./mat3f64-BBpwCtoL.js";import{e as Ce}from"./mat4f64-Dk4dwAN8.js";import{R as qe}from"./computeTranslationToOriginAndRotation-BbJd4iYX.js";import{x as Qe,f as Ye}from"./LayerElevationProvider-B7gdPc1Z.js";import{n as Ke}from"./projectVectorToVector-C3SBBDgz.js";import{c as Ze,x as et,L as tt,i as ee,O as it,E as rt,u as ot,k as st,B as Me,g as Pe}from"./BufferView-CHYzaV9A.js";import{r as P,a as te,S as j,N as O,e as g,m as at,d as nt,g as ie,t as M,n as re,i as R}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{l as lt}from"./ViewingMode-Dodu7ZZk.js";import{t as mt}from"./WaterSurface.glsl-JBHYhfkH.js";import{b as pt}from"./RenderGeometry-rcUvJmRA.js";import{n as ct}from"./LayerView3D-y7LfmsJ-.js";import{i as dt,l as B,a as Ee}from"./DefaultUI-DIlogOoy.js";import{s as $,e as A,u as Oe}from"./basicInterfaces-DngWxyLO.js";import{E as Ue,D as v}from"./enums-DSseSvdG.js";import{l as ht}from"./ElevationQueryTileCache-CV2Fph_A.js";import{i as ut,t as ft,G as gt}from"./ElevationProvider-Bd4qfXCi.js";import{e as yt}from"./ElevationRange-BrgM1moX.js";import{J as Ae}from"./orientedBoundingBox-BQvYwCTM.js";import{a as bt,I as _t,b as wt}from"./EdgeShader.glsl-DNm98Ote.js";import{s as vt}from"./RenderTexture-D39vYIOj.js";import{d as Ie,N as xt}from"./Texture-C7A05GrI.js";import{t as k}from"./Attribute-B-NAci_J.js";import{c as Tt}from"./Normals-BAXqRpCA.js";import{e as G}from"./VertexAttribute-BnAa5VW0.js";import{A as Ct}from"./VertexColor.glsl-CScvx9pF.js";import{u as Mt}from"./LayerView-DO6TerBv.js";import"./sphere-Bf4ezJdT.js";import"./ObjectStack-BPo9QGhV.js";import"./plane-Du3EYICn.js";import"./quatf64-BrpT0VRp.js";import"./vec2f64-Diu2Kaa8.js";import"./mathUtils-iSLnUy_4.js";import"./projectPointToVector-qKp-AJ2b.js";import"./vec2-Dt9Foiri.js";import"./ColorMaterial.glsl-uPKQoFFi.js";import"./Material-DwPnlQDw.js";import"./interfaces-B8ge7Jg9.js";import"./ContentObject-BTgEhnct.js";import"./Util-B8vYs4k8.js";import"./InterleavedLayout-s3MgOYN8.js";import"./types-D0PSWh4d.js";import"./OrderIndependentTransparency-Cua2R8AE.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./hydratedFeatures-DqrDm0_F.js";import"./BindType-BmZEZMMh.js";import"./floatRGBA-CCqnXShd.js";import"./Texture-O7Pyotwx.js";import"./Geometry-CqGtfd4N.js";import"./Indices-DP3oX5Sg.js";import"./triangle-CTblFuF6.js";import"./lineSegment-DVvvMBnG.js";import"./doublePrecisionUtils-B0owpBza.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-Cp-_lWz0.js";import"./featureConversionUtils-BzfH5fda.js";import"./OptimizedFeature-CXeSoBCN.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./OptimizedGeometry-DLPswkPy.js";import"./edgeUtils-D8J_3GIe.js";import"./earcut-BqgeR2O3.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./DoubleArray-068mylUp.js";import"./vec3-DPXcG_yS.js";import"./SnappingCandidate-O5eRSE6e.js";import"./triangulationUtils-C0V38kt7.js";import"./deduplicate-j8p9VETP.js";import"./objectResourceUtils-D-wPKn4W.js";import"./devEnvironmentUtils-Blrp8lZ5.js";import"./DefaultMaterial_COLOR_GAMMA-D4SZcGoz.js";import"./quat-DUnoL8dP.js";import"./resourceUtils-ayGD6aG4.js";import"./NestedMap-DgiGbX8E.js";import"./requestImageUtils-DP1V3HlH.js";import"./verticalOffsetUtils-BYv4Nk2v.js";import"./symbolColorUtils-B_k_VgHH.js";import"./RenderState-DaVlEYWY.js";import"./CIMSymbolHelper-C-U_lWVp.js";import"./BidiEngine-DL33fnW5.js";import"./fontUtils-Dz0hN_7q.js";import"./GeometryUtils-_MjrRDxY.js";import"./enums-BRqP_wXA.js";import"./definitions-B54owTRu.js";import"./mat2d-D9yIh3Tx.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./cimSymbolUtils-DwzauUMk.js";import"./utils-j-RBNfeR.js";import"./lineStippleUtils-B9K4R8oO.js";import"./projectVectorToPoint-CPW7kXva.js";import"./MeshComponent-BCGFLGQh.js";import"./imageUtils-D1MsbWS6.js";import"./meshVertexSpaceUtils-KRc33Yrq.js";import"./MeshLocalVertexSpace-C8ABjEju.js";import"./georeference-CwPKO8dc.js";import"./spatialReferenceEllipsoidUtils-CmEPjh7T.js";import"./axisAngleDegrees-CaSFQR2z.js";import"./interfaces-DkjgzG8v.js";import"./frustum-BrAPXuhm.js";import"./DefaultLayouts-BrmJbx_o.js";import"./webStyleSymbolUtils-BzDS5WjL.js";import"./glUtil-DS73TAjp.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Octree-E7a40xr7.js";import"./BufferObject-CaEbWulZ.js";import"./Intersector-CTjLkyei.js";import"./Scheduler-DaHJO6l7.js";import"./signal-DoM1gSF0.js";import"./debugFlags-BbJIqrPU.js";import"./weather-D00pIeau.js";import"./vec3f32-Cw9Q6TO_.js";import"./Intersector-8rpRuT_8.js";import"./VertexArrayObject-Cv4RwmVi.js";import"./heightModelInfoUtils-CdtST1Ra.js";import"./jsxFactory-BxQYPm-b.js";import"./UpdatingHandles-ugzlsvZF.js";import"./screenUtils-BuM_Fswi.js";import"./GraphicsCollection-CKieR40M.js";import"./ReactiveMap-C-O0lKvJ.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./Viewpoint-CB1GAuK3.js";import"./Cyclical-BY9qISY1.js";import"./mat2df64-CBKYtunK.js";import"./normalizeUtils-Cm7zySIZ.js";import"./normalizeUtilsCommon-DRIluWnF.js";import"./utils-1zmckiYC.js";import"./utils-D-bI9C7C.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-DfZw-NIf.js";import"./accessibleHandler-DsewpcQ5.js";import"./Compass-C-feYp_a.js";import"./utils-DsJqvptN.js";import"./GoTo-BzS22eXk.js";import"./NavigationToggle-QjJqvxo5.js";import"./Zoom-Ct1er6X1.js";import"./LayerConstants-B33OP6sh.js";import"./boundedPlane-CLJ-Xnn_.js";import"./RenderCoordsHelper-zH8WjGkC.js";import"./scaleUtils-0K_Ry6I1.js";import"./viewpointUtils-BxfIO3H-.js";import"./earthUtils-ir2LnhMw.js";import"./spatialReferenceSupport-DPLkW2jK.js";import"./ElevationSamplerData-CC_B5wrl.js";import"./terrainUtils-hfv3Mblf.js";import"./TileInfo-BsGWbS2H.js";import"./TileKey-DZd6gJy7.js";import"./Environment-B2HYg6Z1.js";import"./projectPointToWGS84ComparableLonLat-D5kdMIn_.js";import"./projectVectorToWGS84ComparableLonLat-DuPw0-Mv.js";import"./Program-BB52p2Mx.js";import"./ShadowCastVisualizeTechniqueConfiguration-DqJ__9Ii.js";import"./ray-CCzLdiTI.js";import"./ZoomMomentumEstimator-PITOvV-p.js";import"./labelFormatUtils-BN4HkzS9.js";import"./FeatureTileDescriptor3D-BLJXkD6Q.js";import"./elevationInfoUtils-sHEwmo9N.js";import"./geometryServiceUtils-B-h5lvUN.js";import"./project-7u3NBcq6.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./LercDecoder-FUH0zkya.js";import"./WorkerHandle-DKpIZ9kk.js";import"./RenderableTile-CQN7Nxvi.js";import"./enums-BRzLM11V.js";import"./TileStrategy-BMTAwxMt.js";import"./TileKey-Drwp1tmy.js";import"./QueueProcessor-DFkcFyJt.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-Co_GH1pH.js";import"./DisplayObject-B9oc5ibO.js";import"./rasterUtils-DImlUReg.js";import"./StyleDefinition-pu9RBNlY.js";import"./resources-DJFXXcdR.js";import"./edgeProcessing-Crq4tMpw.js";import"./EdgeWorkerHandle-CAkTfCpv.js";import"./workerHelper-CE2O_zfa.js";import"./testSVGPremultipliedAlpha-Dsq4J0WV.js";import"./RenderingContext-CzjLpUzJ.js";import"./ProgramCache-DX9Ty2iR.js";import"./layerViewUtils-Bi2wmOiN.js";class Pt extends mt{constructor(e,l,s,p,o,a,h){super(e,0,0,0,l),this.nodesCached=s,this.vboMB=p,this.textureMB=o,this.vboMBCached=a,this.textureMBCached=h}}const Et={[P.Points]:null,[P.Lines]:null,[P.LineStrip]:null,[P.Triangles]:Ue.TRIANGLES,[P.TriangleStrip]:Ue.TRIANGLE_STRIP,[P.NotSet]:null},Ve={[te.Opaque]:$.Opaque,[te.Mask]:$.Mask,[te.Blend]:$.Blend},Ot={[j.Back]:A.Back,[j.Front]:A.Front,[j.None]:A.None,[j.NotSet]:A.Back},Ut={[O.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[O.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[O.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[O.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[O.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},At={[g.U8]:1,[g.I8]:1,[g.U16]:2,[g.I16]:2,[g.U32]:4,[g.I32]:4,[g.F32]:4,[g.F64]:8,[g.Utf8String]:1,[g.NotSet]:1};class It{constructor(e){this.layerUid=[],this.type=ut.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,l,s,p){const o=e.results,a=e.options.store===ft.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const h=this.layerView.view._stage.renderView.componentObjectCollection;this.layerView.objects.forEach(b=>{b.visible&&b.intersectionGeometry&&h.intersect(b,s,p,e.tolerance,null,(x,d,f,m)=>{if(d>=0){if(l!=null&&!l(s,p,d))return;const n=i=>{const u=new ht(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));i.set(this.type,u,d,f)};if(this.isGround&&(o.ground.dist==null||d<o.ground.dist)&&n(o.ground),e.options.isFiltered)return;if((o.min.dist==null||d<o.min.dist)&&n(o.min),(o.max.dist==null||d>o.max.dist)&&n(o.max),a){const i=gt(e.ray);n(i),e.results.all.push(i)}}})})}_createTiles3DGraphic(e,l){return new Le({layer:e,sourceLayer:e,attributes:l})}}var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));class Vt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function N(t){return Math.round(t/1048.576)/1e3}let U=class extends ct(Mt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=pt.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Q("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=dt(this).then(e=>{this._intersectionHandler=new It(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,s=>this._slicePlaneEnabledChange(s)),this._elevationProvider=new Qe({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const l=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,s=>this._onRemoveFromCache(s));this._memCache=l,this._suspendedHandle=be(()=>this.suspended,s=>{const p=B(this.view);p&&p.setEnabled(this,!s)},De),this.addHandles([be(()=>this.layer.elevationInfo,s=>this._elevationInfoChanged(s))])}).catch(e=>{if(Ee(this),this._wasmLayerId=-1,e===at)throw new Q("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===nt)throw new Q("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Ee(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=_e(this._memCache),this._updatingHandles=_e(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=je(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const l=this._collection.getMaterial(e);l.commonMaterialParameters.hasSlicePlane=t,l.commonMaterialParameters.cullFace=t?A.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=(t==null?void 0:t.offset)??0,l=t!=null&&t.unit?we(t==null?void 0:t.unit):1,s=B(this.view);s&&s.setLayerOffset(this,e*l)}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get performanceInfo(){let t=0,e=0,l=0,s=0,p=0,o=0;return this._lyrHandleToObjects.forEach(a=>{a.isVisible?(t+=a.texMemoryUsage,e+=a.vboMemoryUsage,p++):(l+=a.texMemoryUsage,s+=a.vboMemoryUsage,o++)}),new Pt(this.usedMemory,p,o,N(e),N(t),N(s),N(l))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===lt.Local){const l=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(l!==3857&&l!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){var t,e;return(((t=this.layer.elevationInfo)==null?void 0:t.offset)??0)*((e=this.layer.elevationInfo)!=null&&e.unit?we(this.layer.elevationInfo.unit):1)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new yt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=B(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var n;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const l=Be(e.desc.origin),s=new Array,p=new Map,o=new Vt;o.handle=t.handle,this._lyrHandleToObjects.set(t.handle,o);const a=this.view.basemapTerrain.spatialReference;let h,b;if(this.view.viewingMode==="global"){const i=Ce();qe(ke,l,i,a),h=Je(Te(),i),b=Xe(Te(),h)}else h=Z,b=Z;const x=Ce();Ge(x,x,l);const d=Ne(Y(),x);let f=null;const m=Y();for(let i=0;i<e.desc.prims.length;i++){const u=e.desc.prims[i];if(u.ptype!==P.Lines||e.data==null)continue;const{positionView:c,positionAttr:E,indicesView:T}=this.getBufferViews(u,e.data.buffer,h,!1);E!=null&&c!=null&&T!=null&&(f=Ae(E),ve(m,f.center,l),f.center=m)}for(let i=0;i<e.desc.prims.length;i++){const u=e.desc.prims[i];if(this._dbg(y.VerboseAPI,JSON.stringify(u)),u.ptype===P.Lines)continue;if(Et[u.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+u.ptype+"). Skipping primitive.");continue}const c=(n=e.desc)!=null&&n.materials&&u.materialId!=null?e.desc.materials[u.materialId]:null,E=c!=null?c.lightingModel:ie.Unlit,T=E!==ie.Unlit,{positionView:_,positionAttr:C,normalsView:Re,normalsAttr:z,colorAttr:F,texCoord0Attr:H,indicesView:I}=this.getBufferViews(u,e.data.buffer,h,T);if(C==null||_==null||I==null)continue;const oe={colors:F!=null,textureCoordinates:H!=null?Ie.Default:Ie.None,hasNormals:Re!=null,needsNormals:T},Fe=C.data.length/C.size,W=(r,w)=>!r||r.data.length/r.size===Fe||(this._dbg(y.Error,`${w} !== numPos. Skipping primitive.`),!1);if(!W(H,"numTexcoord")||!W(F,"numColors")||!W(z,"normals"))continue;const se=bt(oe);let V;if(f!=null?V=f.clone():(V=Ae(C),ve(m,V.center,l),V.center=m),h!==Z)for(let r=0;r<_.count;r++)_.getVec(r,m),$e(m,m,h),_.setVec(r,m);const J=se.createBuffer(C.data.length),S=new Map([[G.POSITION,C]]);H!=null&&S.set(G.UV0,H),F!=null&&S.set(G.COLOR,F),z!=null&&S.set(G.NORMALCOMPRESSED,z),S.forEach((r,w)=>{r!=null&&Ct(w,r,null,null,J,0)});const He=new Uint32Array([0,I.typedBuffer.length]),Se={vertices:{data:J.buffer,count:J.byteLength/se.stride,layoutParameters:oe},positionData:{positions:_.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:He};o.cpuMemoryUsage+=_.count,o.cpuMemoryUsage+=I.count;const ae=this.view.renderSpatialReference,X=Y(),q=[1,1,1];Ye(d,ae,q,a)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),Ke(d,ae,X,a);const L=this._collection.createObject({toMapSpace:ze(X[0],X[1],q[0],q[1]),geometry:Se,obb:V,transform:{position:d,rotationScale:b}});c&&this._collection.updateMaterial(L,r=>{r.baseColor=c.baseColorFactor,r.usePBR=E===ie.Pbr,r.hasParametersFromSource=!1,r.baseColorTexture=this._getTexture(c.baseColorTex,e,p),r.usePBR&&(r.mrrFactors=[c.metallicFactor,c.roughnessFactor,0],r.emissiveFactor=c.emissiveFactor??[0,0,0],r.metallicRoughnessTexture=this._getTexture(c.metalTex,e,p),r.emissionTexture=this._getTexture(c.emissiveTex,e,p),r.occlusionTexture=this._getTexture(c.occlusionTex,e,p),r.normalTexture=this._getTexture(c.normalTex,e,p)),r.objectOpacity=0,r.alphaDiscardMode=$.Mask;const w=[];r.baseColorTexture&&w.push(r.baseColorTexture.loadPromise),r.usePBR&&r.metallicRoughnessTexture&&w.push(r.metallicRoughnessTexture.loadPromise),r.usePBR&&r.emissionTexture&&w.push(r.emissionTexture.loadPromise),r.usePBR&&r.occlusionTexture&&w.push(r.occlusionTexture.loadPromise),r.usePBR&&r.normalTexture&&w.push(r.normalTexture.loadPromise);const ne=Promise.all(w);s.push(ne),ne.then(()=>{var le,me,pe,ce,de,he,ue,fe,ge,ye;r.alphaDiscardMode=Ve[c.alphaMode],r.objectOpacity=1,o.texMemoryUsage+=((me=(le=r.baseColorTexture)==null?void 0:le.glTexture)==null?void 0:me.usedMemory)||0,r.usePBR&&(o.texMemoryUsage+=((ce=(pe=r.metallicRoughnessTexture)==null?void 0:pe.glTexture)==null?void 0:ce.usedMemory)||0,o.texMemoryUsage+=((he=(de=r.emissionTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,o.texMemoryUsage+=((fe=(ue=r.occlusionTexture)==null?void 0:ue.glTexture)==null?void 0:fe.usedMemory)||0,o.texMemoryUsage+=((ye=(ge=r.normalTexture)==null?void 0:ge.glTexture)==null?void 0:ye.usedMemory)||0)}),r.commonMaterialParameters.doubleSided=c.isDoubleSided,r.commonMaterialParameters.cullFace=c.faceCulling?Ot[c.faceCulling]:A.Back,this._initialCullFace.set(L,r.commonMaterialParameters.cullFace),r.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,r.componentParameters.castShadows=_t.All,r.textureAlphaCutoff=c.alphaCutoff??.1,r.alphaDiscardMode=Ve[c.alphaMode],r.isIntegratedMesh=!0,r.polygonOffsetEnabled=!1,r.hasOccludees=!1,r.ellipsoidMode=wt(this.view.spatialReference)}),o.components.push(L),o.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(L)}if(await Promise.all(s),p.forEach(i=>{o.textures.push(i)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${o.handle}`,o,o.totalMemory()),{memUsageBytes:o.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(l=>{this._stage.remove(l)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,l){if(this._memCache){for(let s=0;s<l;++s){const p=t[s],o=e[s];if(!o)continue;const a=this._lyrHandleToObjects.get(p);a&&(this._visibleGeometryChanged(),a.isVisible=o,a.components.forEach(h=>{this._collection.setObjectVisibility(h,o),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.pop(`${p}`))}for(let s=0;s<l;++s){const p=t[s],o=e[s];if(o)continue;const a=this._lyrHandleToObjects.get(p);a&&(this._visibleGeometryChanged(),a.isVisible=o,a.components.forEach(h=>{this._collection.setObjectVisibility(h,o),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.put(`${p}`,a,a.totalMemory()))}}}_getTexture(t,e,l){var p,o;let s=null;if(t&&((p=e.desc)!=null&&p.images)&&((o=e.data)!=null&&o.buffer)){const a=e.desc.images[t==null?void 0:t.imageId];if(s=l.get(a),!s&&a){const h=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,b=h>1,x=Ut[t.wrapMode??O.None];let d=a.alpha?4:3;const f=new Uint8Array(e.data.buffer,a.data.byteOffset,a.data.byteCount);let m=null,n=null,i=null;switch(a.format){case M.Raw:a.pixelFormat===re.R8?(m=f.buffer,d=1,n=""):a.pixelFormat===re.Rgb8?(m=f.buffer,d=3,n=""):a.pixelFormat===re.Rgba8&&(m=f.buffer,d=4,n="");break;case M.Dxt1:m=f.buffer,d=3,n=Oe.DDS_ENCODING;break;case M.Dxt5:m=f.buffer,d=4,n=Oe.DDS_ENCODING;break;case M.Png:n="image/png",i=document.createElement("img");break;case M.Jpeg:n="image/jpeg",i=document.createElement("img");break;case M.Etc2:n="image/ktx",i=document.createElement("img");break;case M.Astc:this._dbg(y.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(i&&n){const u=new Blob([f],{type:n});i.src=URL.createObjectURL(u),m=i}m&&n!=null&&(s=new xt(m,{mipmap:b,maxAnisotropy:h,encoding:n,wrap:x,components:d,noUnpackFlip:!0,width:a.mip0Width,height:a.mip0Height}),this._stage.add(s),l.set(a,s))}}return s?new vt(this.view._stage.renderView.textureRepository,s.id):null}getBufferViews(t,e,l,s){let p,o,a,h,b,x,d,f=null;for(let m=0;m<t.atrbs.length;m++){const n=t.atrbs[m],i=n.view,u=void 0,c=i.byteOffset+i.byteCount,E=i.byteCount/At[i.type],T=[...Array(E).keys()].map(_=>_);try{switch(n.sem){case R.Position:i.ncomp!==3||i.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+i+")"):(p=new ee(e,i.byteOffset,u,c),o=new k(p.typedBuffer,T,3));break;case R.Normal:if(i.ncomp!==3||i.type!==g.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+i+")");else if(s){const _=new ee(e,i.byteOffset,u,c),C=Tt(_.typedBuffer,l);b=new st(C),x=new k(b.typedBuffer,T,2)}break;case R.TexCoord:i.ncomp!==2||i.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+i+")"):h===void 0&&(h=new k(new ot(e,i.byteOffset,u,c).typedBuffer,T,2));break;case R.Color:i.ncomp===4?(i.type===g.F32&&(f=new Ze(e,i.byteOffset,u,c)),i.type===g.U8&&(f=new et(e,i.byteOffset,u,c)),i.type===g.U16&&(f=new tt(e,i.byteOffset,u,c))):i.ncomp===3&&(i.type===g.F32&&(f=new ee(e,i.byteOffset,u,c)),i.type===g.U8&&(f=new it(e,i.byteOffset,u,c)),i.type===g.U16&&(f=new rt(e,i.byteOffset,u,c))),f==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+i+")"):a=new k(f.typedBuffer,T,i.ncomp);break;case R.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+n.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const m=t.index.view,n=void 0,i=m.byteOffset+m.byteCount;switch(t.index.view.type){case g.U16:d=new Pe(e,m.byteOffset,n,i);break;case g.U32:d=new Me(e,m.byteOffset,n,i);break;case g.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+m.type+").")}}if(d==null&&p!=null){const m=p.count;if(m<65535){const n=new Uint16Array(m);d=new Pe(n)}else{const n=new Uint32Array(m);d=new Me(n)}for(let n=0;n<m;n++)d.set(n,n)}return{positionView:p,positionAttr:o,colorAttr:a,texCoord0Attr:h,indicesView:d,normalsView:b,normalsAttr:x}}_onRemoveFromCache(t){const e=B(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?xe.getLogger(this).error(e):xe.getLogger(this).warn(e))}};D([K()],U.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),D([K()],U.prototype,"layer",void 0),D([K()],U.prototype,"elevationOffset",null),U=D([We("esri.views.3d.layers.Tiles3DLayerView3D")],U);const is=U;export{is as default};
