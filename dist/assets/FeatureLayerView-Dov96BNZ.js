import{o as l,y as d,gK as A,gL as $,eZ as j,X as N,cr as S,ej as Q,ct as x,dU as E,gM as v,P as m,W as R,bq as L,gN as _,gO as T,gP as q,gQ as M,gR as G,gS as c,gT as g,s as F,ga as B,a0 as w}from"./index-8ERthB3p.js";import{o as P}from"./floorFilterUtils-DZ5C6FQv.js";import{p as I,n as C}from"./popupUtils-BHYiW8I-.js";const z=O=>{let a=class extends O{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([S(()=>{var t;const e=this.layer;return[e&&"elevationInfo"in e?(t=e.elevationInfo)==null?void 0:t.featureExpressionInfo:null,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),Q),x(()=>{var e;return(e=this.view)==null?void 0:e.floors},"change",()=>this._handleRequiredFieldsChange()),x(()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return"outFields"in e&&e.outFields?E(t,[...v(t,e.outFields),...i]):E(t,i)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){m.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=this.filter!=null?this.filter.createQuery(e):new R(e);if("floorInfo"in this.layer&&this.layer.floorInfo){const i=P(this);i!=null&&(t.where=t.where?`(${t.where}) AND (${i})`:i)}return this.timeExtent!=null&&(t.timeExtent=t.timeExtent!=null?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new R(e)}queryFeatures(e,t){throw new Error("missing implementation")}queryObjectIds(e,t){throw new Error("missing implementation")}queryFeatureCount(e,t){throw new Error("missing implementation")}queryExtent(e,t){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(e,t){return this._validateFetchPopupFeatures(e,t),this._fetchPopupFeatures(e,t)}_loadArcadeModules(e){var t;return(t=e.expressionInfos)!=null&&t.length||Array.isArray(e.content)&&e.content.some(i=>i.type==="expression")?L():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then(()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e=this.view.type==="3d",{layer:t,layer:{fieldsIndex:i,objectIdField:s}}=this,o="renderer"in t&&t.renderer,f="orderBy"in t&&t.orderBy,n="featureReduction"in t?t.featureReduction:null,r=new Set,p=await Promise.allSettled([o?o.collectRequiredFields(r,i):null,_(r,t),e&&"elevationInfo"in t?T(r,t):null,this.filter!=null?q(r,t,this.filter):null,e||this.featureEffect==null?null:q(r,t,this.featureEffect.filter),!e&&n?M(r,t,n):null,!e&&f?G(r,t,f):null]);if("timeInfo"in t&&t.timeInfo&&this.timeExtent&&c(r,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),"floorInfo"in t&&t.floorInfo&&c(r,t.fieldsIndex,[t.floorInfo.floorField]),t.type==="feature"&&e&&t.infoFor3D!=null&&(t.globalIdField==null&&m.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),c(r,t.fieldsIndex,[t.globalIdField])),t.type==="subtype-group"){g(r,i,t.subtypeField);const u=t.sublayers.map(y=>{var b;return Promise.all([(b=y.renderer)==null?void 0:b.collectRequiredFields(r,i),_(r,y)])});await Promise.allSettled(u)}t.type==="catalog-footprint"&&c(r,i,[t.parent.itemSourceField,t.parent.itemTypeField]);for(const u of p)u.status==="rejected"&&m.getLogger(this).error(u.reason);g(r,i,s),e&&"displayField"in t&&t.displayField&&g(r,i,t.displayField);const h=Array.from(r).sort();this._set("requiredFields",h)}_validateFetchPopupFeatures(e,t){if(t!=null)for(const i of e){const s=i.origin&&"layer"in i.origin?i.origin.layer:i.layer;if("popupEnabled"in s&&!s.popupEnabled)throw new F("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){const o="featureReduction"in s?s.featureReduction:null;if(!(o&&"popupTemplate"in o&&o.popupEnabled&&o.popupTemplate))throw new F("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!I(s,t))throw new F("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}_popupFeatureHasRequiredFields(e,t){return B(t,e)}async _fetchPopupFeatures(e,t){var f;const i=new Array(e.length),s=new Map,o=await this._createPopupQuery(e.map(n=>{var r;return((r=n.origin)==null?void 0:r.layer)??n.layer}),t);for(let n=0;n<e.length;n++){const r=e[n];if(r.isAggregate){i[n]=r;continue}const p=((f=r.origin)==null?void 0:f.layer)??r.layer;if(!p||!("popupEnabled"in p))continue;const h=v(this.layer.fieldsIndex,o.outFields),u=I(p,t);if(u==null)continue;const y=await this._loadArcadeModules(u);w(t),y&&y.arcadeUtils.hasGeometryOperations(u)||!this._popupFeatureHasRequiredFields(r,h)?s.set(r.getObjectId(),{graphic:r,index:n}):i[n]=r}if(this.layer.type==="stream"||s.size===0)return i.filter(Boolean);o.objectIds=Array.from(s.keys());try{const n=await this.layer.queryFeatures(o,t);for(const r of n.features){const{graphic:{geometry:p,origin:h},index:u}=s.get(r.getObjectId());r.geometry||(r.geometry=p),r.origin=h,i[u]=r}}catch{}return i.filter(Boolean)}async _createPopupQuery(e,t){const i=this.layer.createQuery(),s=new Set;let o=!1;const f=e??[this.layer];for(const n of f){if(!("popupEnabled"in n))continue;const r=I(n,t);if(r==null)continue;const p=await this._loadArcadeModules(r);w(t);const h=p&&p.arcadeUtils.hasGeometryOperations(r);o=!(this.layer.geometryType!=="point"&&!h);const u=await C(this.layer,r);w(t);for(const y of u)s.add(y)}if(i.returnGeometry=o,i.returnZ=o,i.returnM=o,i.outFields=Array.from(s),i.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const n=P(this);n!=null&&(i.where=i.where?`(${i.where}) AND (${n})`:n)}return i}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){return{createPopupQuery:e=>this._createPopupQuery(void 0,e)}}get test(){return this.getTest()}};return l([d()],a.prototype,"_updatingRequiredFieldsPromise",void 0),l([d({readOnly:!0})],a.prototype,"availableFields",null),l([d({readOnly:!0})],a.prototype,"dataUpdating",void 0),l([d({type:A})],a.prototype,"featureEffect",null),l([d({type:$})],a.prototype,"filter",void 0),l([d(j)],a.prototype,"timeExtent",void 0),l([d()],a.prototype,"layer",void 0),l([d({type:Number})],a.prototype,"maximumNumberOfFeatures",null),l([d({readOnly:!0,type:Boolean})],a.prototype,"maximumNumberOfFeaturesExceeded",null),l([d({readOnly:!0})],a.prototype,"requiredFields",void 0),l([d()],a.prototype,"suspended",void 0),l([d()],a.prototype,"view",void 0),a=l([N("esri.views.layers.FeatureLayerView")],a),a};export{z as j};
