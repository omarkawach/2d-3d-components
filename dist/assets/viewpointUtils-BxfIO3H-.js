import{d as te,l as Ge}from"./Viewpoint-CB1GAuK3.js";import{lG as Xt,cj as O,dC as nt,dj as R,dm as le,di as B,fx as Pe,cf as G,dk as j,bW as d,bX as ne,cg as k,cl as E,dh as Xe,lH as Vt,cp as b,jR as Yt,fc as ue,M as De,ci as we,fr as Qt,lI as en,g4 as tn,fy as Oe,T as J,gd as nn,Z as p,dA as an,dr as at,lC as rn,P as on,a0 as T,lJ as _,bD as sn,bG as cn,dF as it,s as Ee,cK as rt,lK as ln,lL as un,lM as fn,kK as mn,gA as dn,a7 as pn,fm as ot,bj as gn,eO as Ce,hx as Ve,eG as hn,dg as x,bV as yn,lN as wn,lO as xn,lP as vn}from"./index-8ERthB3p.js";import{i as He,o as Mn,s as st}from"./Cyclical-BY9qISY1.js";import{n as Rn,u as bn}from"./mat3-CqxUQBLP.js";import{e as Tn}from"./mat3f64-BBpwCtoL.js";import{e as Fe}from"./mat4f64-Dk4dwAN8.js";import{R as $n}from"./computeTranslationToOriginAndRotation-BbJd4iYX.js";import{c as fe,i as me}from"./projectPointToVector-qKp-AJ2b.js";import{t as L,c as ct}from"./projectVectorToPoint-CPW7kXva.js";import{n as W}from"./projectVectorToVector-C3SBBDgz.js";import{l as Sn}from"./frustum-BrAPXuhm.js";import{u as zn}from"./scaleUtils-0K_Ry6I1.js";import{T as Gn,c as xe}from"./ElevationProvider-Bd4qfXCi.js";import{l as Ie}from"./ViewingMode-Dodu7ZZk.js";import{l as Cn,s as An}from"./earthUtils-ir2LnhMw.js";import{r as Pn}from"./spatialReferenceSupport-DPLkW2jK.js";function Ja(e,t,n,i){return e.renderCoordsHelper.fromRenderCoords(t.eye,de,i)!=null&&Xt(n,de)}function Dn(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function K(e,t,n,i){const a=e.state.camera.clone();t&&n&&i&&(a.eye=t,a.center=n,a.up=i),On(e,a.ray,P)||O(P,a.center);const r=e.state.constraints,o=r.minimumPoiDistance;if(nt(a.eye,P)<o){const s=r.collision.enabled;O(I,a.viewForward),R(I,I,o),s?a.eye=le(de,P,I):B(P,a.eye,I);const c=e.renderCoordsHelper,l=c.getAltitude(a.eye),u=r.collision.elevationMargin;s&&l<u&&(le(I,P,a.eye),a.eye=c.setAltitude(de,u,a.eye),B(P,a.eye,I))}return a.center=P,a}function Ye(e,t,n){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const i=Dn(e,t),a=e.stateManager.constraintsManager.nearFarHeuristic,{far:r}=a.compute(t,n,e.renderDataExtent,i,Hn),o=r*r;return nt(t,n)>o}function On(e,t,n){let i=Qe[e.viewingMode];i||(i=Gn(e.state.viewingMode),i.options.backfacesTerrain=!e.state.isGlobal,i.options.invisibleTerrain=!0,Qe[e.viewingMode]=i);const{isGlobal:a}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,i,n)||Ye(e,t.origin,n))||!(!e.renderCoordsHelper.intersectManifold(t,0,n)||Ye(e,t.origin,n))||!!a&&En(t,n,Pe(e.spatialReference).radius)}function En(e,t,n){const i=G(e.origin,e.origin)-n*n,a=i>0?Math.sqrt(i)/3:1;return R(t,e.direction,a/j(e.direction)),B(t,t,e.origin),!0}const Qe={},de=d(),P=d(),I=d(),Hn={near:0,far:0},Fn=d(),re=d();function lt(){return{direction:d(),up:d()}}function ut(e,t,n,i,a){let r=ne(Fn,e),o=G(r,i);const s=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(G(t,i)),o<.99?(O(r,t),s&&R(r,r,-1)):r=null);let c=0;if(r){R(re,i,G(i,r)),le(r,r,re);const u=G(r,a)/(j(r)*j(a));k(re,r,a),c=(G(re,i)>0?1:-1)*E(Xe(u))}const l=E(Xe(-G(i,e)/j(e)));return n?(n.heading=c,n.tilt=l,n):{heading:c,tilt:l}}const ft=we(0,1,0),mt=we(0,0,1),V=Fe(),S=d(),z=d();function dt(e,t,n,i=lt()){const{direction:a,up:r}=i;return Vt(V,-b(t)),Yt(V,V,b(n)),ue(a,mt,V),R(a,a,-1),ue(r,ft,V),i}function In(e,t,n,i){return ut(t,n,i,mt,ft)}function Un(e,t,n,i){const a=dt(e,n,i),r=d();return R(r,a.direction,-t),B(r,r,e),{up:a.up,eye:r,heading:n,tilt:i}}function jn(e){return E(e)}function kn(e){return b(e)}function pt(e,t,n,i,a){const r=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return fe(t,S,r),fe(t,z,r),S[0]-=n/2,z[0]+=n/2,S[1]-=i/2,z[1]+=i/2,W(S,r,S,o),W(z,r,z,o),a?(a.xmin=S[0],a.ymin=S[1],a.xmax=z[0],a.ymax=z[1],a.spatialReference=o):a=new De(S[0],S[1],z[0],z[1],o),a}const _n=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:In,eyeForCenterWithHeadingTilt:Un,eyeTiltToLookAtTilt:kn,headingTiltToDirectionUp:dt,lookAtTiltToEyeTilt:jn,toExtent:pt},Symbol.toStringTag,{value:"Module"})),gt=we(0,0,1),ht=ne(d(),we(1,1,1)),Ln=new He(-180,180),Y=Fe(),D=d(),Z=d();function yt(e,t,n,i=lt()){k(D,e,gt),G(D,D)===0&&k(D,e,ht),Qt(Y,-b(t),e),en(Y,Y,-b(n),D);const{up:a,direction:r}=i;return k(a,D,e),ne(a,a),ue(a,a,Y),ne(r,e),tn(r,r),ue(r,r,Y),i}function Zn(e,t,n,i){const a=D,r=Z;return ne(a,e),k(Z,a,gt),G(Z,Z)===0&&k(Z,a,ht),k(r,Z,a),ut(t,n,i,a,r)}function qn(e,t,n,i){const a={eye:d(),up:null,tilt:i,heading:n},r=D;r[0]=e[0],r[1]=e[2],r[2]=-e[1];const o=t,s=b(n),c=b(i),l=Math.sin(s),u=Math.cos(s),h=Math.sin(c),f=Math.cos(c),y=j(r);let g;if(Math.abs(c)<1e-8)g=o+y;else{const Ne=y/h,Kt=Oe(o/Ne),Nt=Math.PI-c-Kt;g=Ne*Math.sin(Nt)}const $=f*o,A=o*o*(h*h),H=u*u*A,F=g-$,w=F*F,X=H*(H+w-r[1]*r[1]);if(X<0)return R(a.eye,r,g/y),a.tilt=0,oe(a,e);const qe=Math.sqrt(X),Be=r[1]*F,We=H+w;let Je;if(Je=u>0?-qe+Be:qe+Be,Math.abs(We)<1e-8)return y<1e-8?(a.eye[0]=0,a.eye[1]=0,a.eye[2]=o):R(a.eye,r,g/y),a.tilt=0,$e(a.eye),oe(a,e);a.eye[1]=Je/We;const Wt=l*l*A,Re=h*o,Jt=u*Re*a.eye[1],Ke=a.eye[1]*a.eye[1],ie=1-Ke,be=Math.sqrt(ie),Te=H*Ke+Wt-2*Jt*be*F+ie*w;return Math.abs(Te)<1e-8?(R(a.eye,r,g/y),a.tilt=0,$e(a.eye),oe(a,e)):(a.eye[0]=(ie*(g*r[0]-$*r[0])-Re*be*(r[0]*a.eye[1]*u+r[2]*l))/Te,a.eye[2]=(ie*(g*r[2]-$*r[2])-Re*be*(r[2]*a.eye[1]*u-r[0]*l))/Te,R(a.eye,a.eye,g),$e(a.eye),oe(a,e))}function $e(e){const t=e[1];e[1]=-e[2],e[2]=t}function oe(e,t){const n=yt(t,e.heading,e.tilt);return e.up=n.up,e}function Bn(e,t,n){const i=j(t),a=Math.sqrt(n*n+i*i-2*n*i*Math.cos(Math.PI-e)),r=Oe(n/(a/Math.sin(e)));return E(e-r)}function Wn(e,t,n){const i=b(e),a=j(t);return Oe(n/(a/Math.sin(i)))+i}function wt(e,t,n,i,a){let r,o,s,c;const l=t.latitude,u=Pe(e.spatialReference).radius,h=t.longitude,f=Cn(l,n,u)/2;r=h-f,o=h+f;const y=b(l),g=(1+Math.sin(y))/(1-Math.sin(y)),$=(g+1)*Math.tan(i/u/2),A=$*$;function H(w){const X=Math.PI/2;return(w=Mn.normalize(w,-X))>X&&(w=Math.PI-w),w}if(s=1.5*Math.PI-2*Math.atan(.5*($+Math.sqrt(4*g+A))),c=s+i/u,s=H(s),c=H(c),c<s){const w=c;c=s,s=w}if(s=Math.max(E(s),-90),c=Math.min(E(c),90),o=Ln.monotonic(r,o),o-r>180){const w=(o-r-180)/2;r+=w,o-=w}const F=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:J.WGS84;return a?(a.xmin=r,a.ymin=s,a.xmax=o,a.ymax=c,a.spatialReference=F):a=new De(r,s,o,c,F),e.spatialReference&&e.spatialReference.isWebMercator&&nn(a,!1,a),a}const Jn=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Zn,eyeForCenterWithHeadingTilt:qn,eyeTiltToLookAtTilt:Wn,headingTiltToDirectionUp:yt,lookAtTiltToEyeTilt:Bn,toExtent:wt},Symbol.toStringTag,{value:"Module"})),xt=()=>on.getLogger("esri.views.3d.support.cameraUtils"),vt=39.37,Mt=96,Ae=1,Kn=8,Nn=5,Rt=1,et=d(),Xn={heading:0,tilt:0},ee=d(),Vn=new He(-20037508342788905e-9,20037508342788905e-9),Yn=new He(-180,180);var v;function C(e){return e.spatialReference??J.WGS84}function N(e){return e.viewingMode==="global"?Jn:_n}function Ka(e,t,n,i,a){return N(e).headingTiltToDirectionUp(t,n,i,a)}function Qn(e,t){if(t==null)return null;const n=e.renderSpatialReference,i=N(e).headingTiltToDirectionUp,a=d();if(!fe(t.position,a,n))return null;const r=i(a,t.heading,t.tilt);R(r.direction,r.direction,e.state.camera.distance),B(r.direction,r.direction,a);const o=K(e,a,r.direction,r.up);return o.fov=b(t.fov),o.row=t.layout.row,o.rows=t.layout.rows,o.column=t.layout.column,o.columns=t.layout.columns,o}(function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"})(v||(v={}));const q=d();function ve(e,t,n){const i=e.renderSpatialReference,a=je(e,t.eye,t.viewForward,t.up,Xn);let r=C(e);return W(t.eye,i,q,r)||(r=J.WGS84,W(t.eye,i,q,r)),n==null?n=new te(new p(q,r),a.heading,a.tilt,E(t.fov)):(n.position.x=q[0],n.position.y=q[1],n.position.z=q[2],n.position.spatialReference=r,n.heading=a.heading,n.tilt=a.tilt,n.fov=E(t.fov)),n.layout.row=t.row,n.layout.rows=t.rows,n.layout.column=t.column,n.layout.columns=t.columns,n}function Ue(e,t,n){const i=e.state.camera,a=i.width/2/i.pixelRatio;return e.renderCoordsHelper.viewingMode===Ie.Global&&n!=null&&(t*=Math.cos(b(n))),t/=e.renderCoordsHelper.unitInMeters,a/(Mt*vt/t)/Math.tan(i.fovX/2)}function ae(e,t,n){const i=e.state.camera,a=t*Math.tan(i.fovX/2),r=i.width/2/i.pixelRatio;let o=Mt*vt/(r/a);return e.renderCoordsHelper.viewingMode===Ie.Global&&n!=null&&(o/=Math.cos(b(n))),o*e.renderCoordsHelper.unitInMeters}async function bt(e,t,n,i,a,r){return Tt(e,t,Ue(e,n,t.latitude),i,a,r)}function ea(e,t,n,i,a,r){return Ut(e,St(e,i.heading,i.tilt,t,n,a),i.fov,r)}async function Tt(e,t,n,i,a,r){const o=await zt(e,i.heading,i.tilt,t,n,a,r);return T(r),jt(e,o,i.fov,r)}function je(e,t,n,i,a){return N(e).directionToHeadingTilt(t,n,i,a)}function $t(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,ee,e.spatialReference)&&e.elevationProvider&&(xe(e.elevationProvider,ee)??0)>ee[2]-Rt)}async function ta(e,t,n){if($t(e,t))return!0;const{elevationProvider:i,spatialReference:a,renderCoordsHelper:r}=e;if(i==null||!r.fromRenderCoords(t,ee,a))return!1;const[o,s,c]=ee,l=await i.queryElevation(o,s,c,a,"ground",n)??0;return T(n),l>c-Rt}async function na(e,t,n){const i=d();if(t==null)return O(i,e.state.camera.center);if(t instanceof p){const{renderSpatialReference:a,basemapTerrain:r,elevationProvider:o}=e,s=t.spatialReference;if(await me(t,i,a,0,{signal:n}),T(n),t.z==null&&r!=null&&o!=null){const c=await o.queryElevation(t.x,t.y,t.z??0,s,"ground",n);T(n),c!=null&&e.renderCoordsHelper.setAltitude(i,c)}return i}return O(i,t)}function aa(e,t){const n=d();if(t==null)return O(n,e.state.camera.center);if(t instanceof p){if(!fe(t,n,e.renderSpatialReference))return null;const{basemapTerrain:i,elevationProvider:a}=e;if(t.z==null&&i!=null&&a!=null){const r=xe(a,t);r!=null&&e.renderCoordsHelper.setAltitude(n,r)}return n}return O(n,t)}function St(e,t,n,i,a,r){return Gt(e,t,n,i instanceof p?i:null,aa(e,i),a,r)}async function zt(e,t,n,i,a,r,o){const s=i instanceof p?i:null,c=await na(e,i,o);return T(o),Ct(e,t,n,s,c,a,r,o)}function Gt(e,t,n,i,a,r,o){if(a==null||!i&&(i=new p({spatialReference:C(e)}),!L(a,e.renderSpatialReference,i)))return null;const s=At(e,t,n,a,r,o);if(Pt(e,n,o)&&$t(e,s.eye)){const{tilt:c,mode:l}=Dt(e,n,a,r);return Gt(e,t,c,i,a,r,l)}return Ot(s,a)}async function Ct(e,t,n,i,a,r,o,s){i||(i=new p({spatialReference:C(e)}),await ct(a,e.renderSpatialReference,i,{signal:s})||(i=null)),T(s);const c=At(e,t,n,a,r,o);if(Pt(e,n,o)&&await ta(e,c.eye,s)){T(s);const{tilt:l,mode:u}=Dt(e,n,a,r);return Ct(e,t,l,i,a,r,u,s)}return Ot(c,a)}function At(e,t,n,i,a,r){const o=oa(e,t,n,i,a=Math.max(a,e.state.constraints.minimumPoiDistance),r);return(0,N(e).eyeForCenterWithHeadingTilt)(i,a,o.heading,o.tilt)}function Pt(e,t,n){const i=e.map.ground.navigationConstraint;return n===v.ADJUST&&e.viewingMode==="global"&&t>0&&(i==null||i.type==="stay-above")}function Dt(e,t,n,i){const a=It(e,n,i,ca(e,i,t,n));return{tilt:a,mode:t-a<1?v.LOCKED:v.ADJUST}}function Ot(e,t){return{...e,center:an(t)}}function Et(e,t){const{state:n,spatialReference:i}=e,a=t.spatialReference;return n.isGlobal&&Pn(a,Ie.Global)||n.isLocal&&i.equals(a)}function Ht(e,t){let n,i,a;if(e.state.isGlobal){const u=new p(t.xmin,t.ymin,t.spatialReference),h=new p(t.xmax,t.ymax,t.spatialReference),f=t.spatialReference.isGeographic?Yn:Vn;n=new p({x:f.center(u.x,h.x),y:(h.y+u.y)/2,z:t.zmax!=null&&t.zmin!=null?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const y=Pe(t.spatialReference),g=An(n,u,h);i=g.lon,a=g.lat,f.diff(u.x,h.x)>f.range/2&&(i+=y.halfCircumference),i=Math.min(i,y.halfCircumference),a=Math.min(a,y.halfCircumference)}else{const u=e.renderSpatialReference??t.spatialReference;u.equals(t.spatialReference)||(t=at(t,u)),i=t.xmax-t.xmin,a=t.ymax-t.ymin;const h=t.zmax!=null&&t.zmin!=null?(t.zmax+t.zmin)/2:void 0;n=new p({x:t.xmin+.5*i,y:t.ymin+.5*a,z:h,spatialReference:u})}const r=t.zmax!=null&&t.zmin!=null?t.zmax-t.zmin:0,o=e.state.camera,s=1/Math.tan(o.fovX/2),c=1/Math.tan(o.fovY/2),l=1/Math.tan(o.fov/2);return{center:n,distance:Math.max(.5*i*s,.5*a*c,.5*r*l)/Ae}}async function Ft(e,t,n,i,a,r){const o=Et(e,t)?t:await _(t,e.spatialReference,{signal:r});T(r);const{center:s,distance:c}=Ht(e,o),l=await zt(e,n,i,s,c,a,r);return T(r),jt(e,l,e.camera.fov,r)}function ia(e,t,n,i,a,r){let o;try{o=Et(e,t)?t:at(t,e.spatialReference)}catch{return null}const{center:s,distance:c}=Ht(e,o),l=St(e,n,i,s,c,a);return l==null?null:Ut(e,l,e.camera.fov,r)}function Na(e,t,n){const i=e.renderSpatialReference,a=new p({spatialReference:C(e)});if(!L(n,i,a))return null;const r=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),s=rn(t.eye,n),c=2*s*r*Ae,l=2*s*o*Ae;return e.viewingMode==="global"?wt(e,a,c,l):pt(e,a,c,l)}function ra(e,t,n){const i=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/i)/Math.LN2>Kn)return!0;const a=e.renderSpatialReference,r=C(e),o=new p({spatialReference:r});if(!L(t,a,o))return!1;const s=new p({spatialReference:r});if(!L(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a,s))return!1;const c=Math.tan(.5*e.state.camera.fov)*i;return s.distance(o)/c>Nn}function oa(e,t,n,i,a,r){let o=0;return r===v.ADJUST&&ra(e,i,a)?(t=0,o=sa(e,a,n,i)):o=ke(e,i,a,n),o=e.state.constraints.clampTilt(a,o),{heading:t,tilt:n=It(e,i,a,o)}}const pe=.7;function sa(e,t,n,i){const a=ke(e,i,t,n);if(!e.state.constraints.tilt)return a;const r=e.state.constraints.tilt(t);r.max=Math.min(r.max,.5*Math.PI);const o=r.min*(1-pe)+r.max*pe;return Math.min(a,o)}function ca(e,t,n,i){let a=ke(e,i,t,n);if(!e.state.constraints.tilt)return a;const r=e.state.constraints.tilt(t);return a=Math.min(a,.5*Math.PI),r.min*(1-pe)+a*pe}function It(e,t,n,i){return N(e).lookAtTiltToEyeTilt(i,t,n)}function ke(e,t,n,i){return N(e).eyeTiltToLookAtTilt(i,t,n)}function Ut(e,t,n,i){if(t==null)return null;const a=e.renderSpatialReference,r=new p({spatialReference:C(e)});return L(t.eye,a,r)?(i??(i=new te),i.position=r,i.heading=t.heading,i.tilt=t.tilt,i.fov=n,i):null}async function jt(e,t,n,i){const a=e.renderSpatialReference,r=new p({spatialReference:C(e)});return await ct(t.eye,a,r,{signal:i}),T(i),new te(r,t.heading,t.tilt,n)}function Xa(e,t){var i;const n=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(n)return n.levelAtScale(t);xt().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function la(e,t){var i;const n=(i=e.basemapTerrain)==null?void 0:i.tilingScheme;if(n)return n.scaleAtLevel(t);xt().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function kt(e,t){return W(t.center,e.renderSpatialReference,et,J.WGS84),ae(e,t.distance,et[1])}const ua=.66;function _t(e){return 360-st.normalize(e)}function Me(e){return st.normalize(360-e)}function fa(e,t,n){const i=t.camera;if(i!=null)return ma(i,C(e));const{targetGeometry:a}=t;if(a==null)return null;const{camera:r,mode:o}=Zt(e,t.rotation,n);if(a.type==="point")return pa(e,t,a,r,o);const s=a.extent;return s==null?null:ia(e,s,r.heading,r.tilt,o)}async function Lt(e,t,n,i){const a=t.camera;if(a!=null)return da(a,C(e),i);const{targetGeometry:r}=t;if(r==null)throw new Error("Viewpoint has no targetGeometry!");const{camera:o,mode:s}=Zt(e,t.rotation,n);if(r.type==="point")return ga(e,t,r,o,s,i);const c=r.extent;if(c==null)throw new Error("Target geometry has no extent!");return Ft(e,c,o.heading,o.tilt,s,i)}function ma(e,t){const n=e.position;let i;try{i=it(n,t)}catch{return null}if(!i)return null;const a=e.clone();return a.position=i.clone(),a}async function da(e,t,n){const i=e.position,a=await _(i,t,{signal:n});T(n);const r=e.clone();return r.position=a.clone(),r}function Zt(e,t,n){const i=ve(e,e.state.camera);let a=v.ADJUST;return t!=null&&(i.heading=_t(t),a=v.LOCKED),n!=null&&(i.tilt=n),{camera:i,mode:a}}function pa(e,t,n,i,a){const r=e.spatialReference;let o;try{o=it(n.clone(),r)}catch{return null}if(!o)return null;const s=t.scale!=null?Ue(e,t.scale,o.latitude):e.state.camera.distance;return ea(e,o,s,i,a)}async function ga(e,t,n,i,a,r){const o=e.spatialReference,s=await _(n.clone(),o,{signal:r});T(r);const c=t.scale!=null?Ue(e,t.scale,s.latitude):e.state.camera.distance;return Tt(e,s,c,i,a,r)}function ha(e,t,n=null){return n==null&&(n=new Ge),Ze(e,null,t.clone(),n)}async function ya(e,t,n){const i=za(e,t);if(!i)throw new Ee("viewpointutils-create:no-target","Missing target for creating viewpoint");const a=new te({fov:e.camera.fov}),r=new Ge({camera:a});if(i.target instanceof Ge)return U(await va(e,i.target,i,n,r));if(i.target instanceof te)return U(await Bt(e,i.target,n,r));const o=i.scale!=null||i.zoom!=null;if(i.target instanceof De){const l=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return U(o||l?await he(e,i,i.target.center,a,n,r):await Ta(e,i,i.target,a,n,r))}const s={boundingBox:rt(),hasZ:!1,screenSpaceObjects:[]},c=o?wa(e,i):void 0;if(await qt(e,i.target,c,s,n),isFinite(s.boundingBox[0])){let l;if(ln(s.boundingBox,m),M.x=m[0],M.y=m[1],M.z=m[2],M.spatialReference=e.spatialReference,isFinite(M.z)&&s.hasZ?l=un(s.boundingBox):(M.z=void 0,l=fn(mn(s.boundingBox,Ca))),o||l)return U(await he(e,i,M,a,n,r));const u=Ga(e,s.screenSpaceObjects);return U(await Sa(e,i,M,s.boundingBox,u,a,n,r))}return i.position?U(await Ra(e,i,a,r,n)):U(await ba(e,i,a,n,r))}function _e(e,t){return t.scale==null&&t.zoom!=null?la(e,t.zoom):t.scale}function wa(e,t){const n=_e(e,t);return n?zn(n):void 0}function Le(e,t){let n=!1;return t.heading!=null?(e.heading=t.heading,n=!0):t.rotation!=null&&(e.heading=_t(t.rotation),n=!0),t.tilt!=null&&(e.tilt=t.tilt,n=!0),t.fov!=null&&(e.fov=t.fov),n}function Ze(e,t,n,i){const a=e.spatialReference||J.WGS84;if((t=t??Qn(e,n))==null)return i;const r=new p({spatialReference:a});return L(t.center,e.renderSpatialReference,r)&&(i.targetGeometry=r,i.scale=kt(e,t),i.rotation=Me(n.heading),i.camera=n),i}async function ge(e,t,n,i){var h;const a=()=>new Ee("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw a();t.type==="mesh"&&(t=t.extent);const r=t.spatialReference,o=e.spatialReference,s=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let f;switch(t.type){case"point":f=t;break;case"multipoint":case"polyline":f=(h=t.extent)==null?void 0:h.center;break;case"extent":f=t.center;break;case"polygon":f=t.centroid}f!=null&&s!=null&&e.elevationProvider!=null?(f=await _(f,s,{signal:i}),m[2]=xe(e.elevationProvider,f)??0):m[2]=0}const c=Aa[t.type],l=new Array;if(c(t,t.hasZ?f=>{l.push([f[0],f[1],f[2]])}:f=>{l.push([f[0],f[1]])},m),l.length===0)throw a();const u=await _(new gn({spatialReference:r,hasZ:t.hasZ,hasM:!1,points:l}),o,{signal:i});if(t.hasZ&&(n.hasZ=!0),t.hasZ)for(const[f,y,g]of u.points)m[0]=f,m[1]=y,m[2]=g,Ce(n.boundingBox,m);else for(const[f,y]of u.points)m[0]=f,m[1]=y,Ce(n.boundingBox,m)}async function xa(e,t,n,i,a){const r=await Ve(e.whenViewForGraphic(t));if(r.ok===!1||r.value==null||!("whenGraphicBounds"in r.value))return void await ge(e,t.geometry,i,a);const o=r.value,s=await Ve(o.whenGraphicBounds(t,{minDemResolution:n}));if(s.ok===!1||!s.value)return void await ge(e,t.geometry,i,a);const{screenSpaceObjects:c,boundingBox:l}=s.value;hn(i.boundingBox,l),c&&c.forEach(u=>{i.screenSpaceObjects.push(u)}),isFinite(l[2])&&(i.hasZ=!0)}async function qt(e,t,n,i,a){var r;if(Array.isArray(t)&&t.length===2){const o=t[0],s=t[1];if(typeof o=="number"&&typeof s=="number")return M.x=o,M.y=s,M.z=void 0,M.spatialReference=(r=e.spatialReference)!=null&&r.isGeographic?e.spatialReference:J.WGS84,void await ge(e,M,i,a)}t&&"map"in t&&typeof t.map=="function"?await Promise.allSettled(t.map(o=>qt(e,o,n,i,a))):t instanceof dn?await ge(e,t,i,a):t instanceof pn&&await xa(e,t,n,i,a)}async function va(e,t,n,i,a){if(t.camera!=null)return Bt(e,t.camera,i,a);a.scale=t.scale,a.rotation=t.rotation,a.targetGeometry=t.targetGeometry!=null?t.targetGeometry.clone():null,a.camera=null,n.heading!=null?a.rotation=Me(n.heading):n.rotation!=null&&(a.rotation=n.rotation);const r=_e(e,n);return r!=null&&(a.scale=r),a.camera=await Lt(e,a,n.tilt,i),a}async function Bt(e,t,n,i){const a=e.spatialReference,r=await _(t.position,a,{signal:n});return(t=t.clone()).fov=e.camera.fov,t.position=r,Ze(e,null,t,i)}async function Ma(e,t,n,i,a,r,o){const s=e.renderSpatialReference;return await me(t,Se,s,0,{signal:o}),await me(n,ce,s,0,{signal:o}),r.targetGeometry=new p(t),a.position=new p(n),le(ye,Se,ce),je(e,ce,ye,i.up,a),r.scale=ae(e,ot(ce,Se),r.targetGeometry.latitude),r.rotation=Me(a.heading),r.camera=a,r}async function he(e,t,n,i,a,r){if(n==null)throw new Ee("createfromcenter","invalid point");r.targetGeometry=n.clone();const o=K(e);if(t.position)return Ma(e,r.targetGeometry,t.position,o,i,r,a);if(t.zoomFactor){const c=o.distance/t.zoomFactor,l=R(m,o.viewForward,-c);o.eye=B(m,o.center,l),r.scale=ae(e,c,n.latitude)}ve(e,o,i);const s=Le(i,t)?v.LOCKED:v.ADJUST;if(!t.zoomFactor){const c=_e(e,t);if(c==null){const{renderSpatialReference:l}=e;await me(n,m,l,0,{signal:a}),Sn(o.frustum,m)?r.scale=ae(e,ot(o.eye,m),n.latitude):r.scale=kt(e,o)}else r.scale=c;r.camera=await bt(e,r.targetGeometry,r.scale,i,s,a)}return r}async function Ra(e,t,n,i,a){const r=K(e);O(ye,r.viewForward),je(e,r.eye,ye,r.up,ze);const o=e.spatialReference,{position:s}=t;if(s){const c=await _(s,o,{signal:a});n.position=c}else n.position=new p;return n.heading=t.heading!=null?t.heading:ze.heading,n.tilt=t.tilt!=null?t.tilt:ze.tilt,Ze(e,null,n,i)}async function ba(e,t,n,i,a){const r=K(e),{spatialReference:o,renderSpatialReference:s}=e,c=new p({spatialReference:o});return L(r.center,s,c)?he(e,t,c,n,i,a):he(e,t,null,n,i,a)}async function Ta(e,t,n,i,a,r){r.targetGeometry=n.clone();const o=K(e);ve(e,o,i);const s=Le(i,t)?v.LOCKED:v.ADJUST;return r.camera=await Ft(e,n,i.heading,i.tilt,s,a),r}function $a(e,t,n,i,a){let r=0;n.z!=null?r=n.z:e.basemapTerrain&&e.elevationProvider&&(r=xe(e.elevationProvider,n)),x(m,n.x,n.y,r),$n(e.spatialReference,m,tt,e.renderSpatialReference),Rn(se,tt),bn(se,se),rt(Q);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let g=0;g<o.length;g++){const $=o[g];let A=i[$[2]];isFinite(A)||(A=r),x(m,i[$[0]],i[$[1]],A),W(m,e.spatialReference,m,e.renderSpatialReference),Ce(Q,yn(m,m,se))}const s=wn(Q),c=xn(Q),l=vn(Q),u=1/Math.tan(t.fovX/2),h=1/Math.tan(t.fovY/2),f=.5*Math.sqrt(s*s+l*l)*Math.max(h,u)+.5*c,y=.5*c*h+.5*Math.max(s,l);return Math.max(f,y)/a}async function Sa(e,t,n,i,a,r,o,s){s.targetGeometry=n.clone();const c=K(e),l=$a(e,c,n,i,a);ve(e,c,r);const u=Le(r,t)?v.LOCKED:v.ADJUST;return s.scale=ae(e,l,s.targetGeometry.latitude),s.camera=await bt(e,s.targetGeometry,s.scale,r,u,o),s}function za(e,t){if(!t||!e.spatialReference)return null;const n={target:void 0};return"declaredClass"in t||Array.isArray(t)?n.target=t:(Object.assign(n,t),t.center&&!n.target&&(n.target=t.center)),n}function U(e){return(e==null?void 0:e.camera)!=null&&(e.rotation=Me(e.camera.heading)),e}function Ga(e,t){const n=ua;if(!t.length)return n;let i=Number.NEGATIVE_INFINITY;for(let a=0;a<t.length;a++){const r=t[a].screenSpaceBoundingRect;i=Math.max(i,Math.abs(r[0]),Math.abs(r[1]),Math.abs(r[2]),Math.abs(r[3]))}return n-i/Math.min(e.width,e.height)*2}const m=d(),tt=Fe(),se=Tn(),Q=sn(),Ca=cn(),ye=d(),ce=d(),Se=d(),ze={heading:0,tilt:0},M=new p,Aa={point(e,t,n){n[0]=e.x,n[1]=e.y,e.z!=null&&(n[2]=e.z),t(n)},polygon(e,t,n){const i=e.hasZ;for(let a=0;a<e.rings.length;a++){const r=e.rings[a];for(let o=0;o<r.length;o++)n[0]=r[o][0],n[1]=r[o][1],i&&(n[2]=r[o][2]),t(n)}},polyline(e,t,n){const i=e.hasZ;for(let a=0;a<e.paths.length;a++){const r=e.paths[a];for(let o=0;o<r.length;o++)n[0]=r[o][0],n[1]=r[o][1],i&&(n[2]=r[o][2]),t(n)}},multipoint(e,t,n){const i=e.points,a=e.hasZ;for(let r=0;r<i.length;r++)n[0]=i[r][0],n[1]=i[r][1],a&&(n[2]=i[r][2]),t(n)},extent(e,t,n){e.zmin!=null&&e.zmax!=null?(t(x(n,e.xmin,e.ymin,e.zmin)),t(x(n,e.xmax,e.ymin,e.zmin)),t(x(n,e.xmin,e.ymax,e.zmin)),t(x(n,e.xmax,e.ymax,e.zmin)),t(x(n,e.xmin,e.ymin,e.zmax)),t(x(n,e.xmax,e.ymin,e.zmax)),t(x(n,e.xmin,e.ymax,e.zmax)),t(x(n,e.xmax,e.ymax,e.zmax))):(t(x(n,e.xmin,e.ymin,n[2])),t(x(n,e.xmax,e.ymin,n[2])),t(x(n,e.xmin,e.ymax,n[2])),t(x(n,e.xmax,e.ymax,n[2])))}},Va=Object.freeze(Object.defineProperty({__proto__:null,create:ya,fromCamera:ha,toCameraAsync:Lt,toCameraSync:fa},Symbol.toStringTag,{value:"Module"}));export{Ue as B,v as F,Ka as K,ae as Q,la as U,Qn as Y,ve as Z,St as a,Xa as b,lt as c,ya as d,Va as e,Dn as f,K as g,ha as h,fa as l,je as n,Ja as u,Na as v,ia as y};
