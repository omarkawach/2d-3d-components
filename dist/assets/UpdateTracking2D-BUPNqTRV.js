function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/geometryEngineJSON-Cp8Nw467.js","assets/geometryEngineBase-Cz__5BKm.js","assets/_commonjsHelpers-DCkdB7M8.js","assets/json-Wa8cmqdu.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{py as qn,_ as Kn,w as Ur,d1 as jn,s as Wr,P as je,br as S,o as d,aH as Qn,q2 as sr,jz as Jn,pN as F,q3 as Vi,bU as fi,q4 as ts,y as mi,X as es,bO as rs,cr as is}from"./index-8ERthB3p.js";import{a as ns,i as ss,c as os}from"./TurboLine-B0jwHtDu.js";import"./earcut-BqgeR2O3.js";import{c as Ri,i as Li,l as as}from"./GeometryUtils-_MjrRDxY.js";import{e as cs}from"./OptimizedGeometry-DLPswkPy.js";import{a as Ae,h as Qe,$ as Rt,r as Ge,l as Yr,S as us,g as ls,e as hs,_ as ds}from"./definitions-B54owTRu.js";import{$ as yi,A as gi,s as xi,b as ft,g as ps,c as fs,d as ms,O as ys,e as gs,f as xs}from"./CIMSymbolHelper-C-U_lWVp.js";import{t as bs,f as vs,w as _s,g as Ai,T as ws,r as ge}from"./LabelMetric-B0IKUycz.js";import{C as g}from"./enums-DSseSvdG.js";import{U as or,e as ar,w as cr,n as ur,i as Gi}from"./enums-BRqP_wXA.js";import{a as xe}from"./BindType-BmZEZMMh.js";import{s as $s}from"./Util-B8vYs4k8.js";import"./Texture-O7Pyotwx.js";import{r as Ss}from"./Program-BB52p2Mx.js";import{l as Ui}from"./highlightReasons-LsVPCozu.js";import{M as Wi,a as Ps,i as Ts,s as Is}from"./mat2d-D9yIh3Tx.js";import{n as Yi}from"./mat2df32-orApM5a3.js";import{i as ks}from"./BoundingBox-BhuXqU4L.js";import{t as yt}from"./constants-D5zmR9t2.js";import{S as be}from"./vec2-Dt9Foiri.js";import{s as Ms}from"./ReactiveMap-C-O0lKvJ.js";import{h as Ns}from"./UpdatingHandles-ugzlsvZF.js";function Oc(r){return r}function Vc(r){return r}function Es(r,t,e,i,n,s,o){fr=0;const a=(i-e)*s,c=n&&n.length,u=c?(n[0]-e)*s:a;let l,h,f,p,y,b=Hi(t,e,i,0,u,s,!0);if(b&&b.next!==b.prev){if(c&&(b=Cs(t,e,i,n,b,s)),a>80*s){l=f=t[0+e*s],h=p=t[1+e*s];for(let v=s;v<u;v+=s){const w=t[v+e*s],$=t[v+1+e*s];l=Math.min(l,w),h=Math.min(h,$),f=Math.max(f,w),p=Math.max(p,$)}y=Math.max(f-l,p-h),y=y!==0?1/y:0}oe(b,r,s,l,h,y,o,0)}}function Hi(r,t,e,i,n,s,o){let a;if(o===Ls(r,t,e,i,n,s)>0)for(let c=i;c<n;c+=s)a=bi(c+t*s,r[c+t*s],r[c+1+t*s],a);else for(let c=n-s;c>=i;c-=s)a=bi(c+t*s,r[c+t*s],r[c+1+t*s],a);return a&&St(a,a.next)&&(ae(a),a=a.next),a}function se(r,t=r){if(!r)return r;let e,i=r;do if(e=!1,i.steiner||!St(i,i.next)&&G(i.prev,i,i.next)!==0)i=i.next;else{if(ae(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function oe(r,t,e,i,n,s,o,a){if(!r)return;!a&&s&&(r=Zi(r,i,n,s));let c=r;for(;r.prev!==r.next;){const u=r.prev,l=r.next;if(s?Ds(r,i,n,s):zs(r))t.push(u.index/e+o),t.push(r.index/e+o),t.push(l.index/e+o),ae(r),r=l.next,c=l.next;else if((r=l)===c){a?a===1?oe(r=Gs(r,t,e,o),t,e,i,n,s,o,2):a===2&&Us(r,t,e,i,n,s,o):oe(se(r),t,e,i,n,s,o,1);break}}}function zs(r){const t=r.prev,e=r,i=r.next;if(G(t,e,i)>=0)return!1;let n=r.next.next;const s=n;let o=0;for(;n!==r.prev&&(o===0||n!==s);){if(o++,Bt(t.x,t.y,e.x,e.y,i.x,i.y,n.x,n.y)&&G(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function Ds(r,t,e,i){const n=r.prev,s=r,o=r.next;if(G(n,s,o)>=0)return!1;const a=n.x<s.x?n.x<o.x?n.x:o.x:s.x<o.x?s.x:o.x,c=n.y<s.y?n.y<o.y?n.y:o.y:s.y<o.y?s.y:o.y,u=n.x>s.x?n.x>o.x?n.x:o.x:s.x>o.x?s.x:o.x,l=n.y>s.y?n.y>o.y?n.y:o.y:s.y>o.y?s.y:o.y,h=dr(a,c,t,e,i),f=dr(u,l,t,e,i);let p=r.prevZ,y=r.nextZ;for(;p&&p.z>=h&&y&&y.z<=f;){if(p!==r.prev&&p!==r.next&&Bt(n.x,n.y,s.x,s.y,o.x,o.y,p.x,p.y)&&G(p.prev,p,p.next)>=0||(p=p.prevZ,y!==r.prev&&y!==r.next&&Bt(n.x,n.y,s.x,s.y,o.x,o.y,y.x,y.y)&&G(y.prev,y,y.next)>=0))return!1;y=y.nextZ}for(;p&&p.z>=h;){if(p!==r.prev&&p!==r.next&&Bt(n.x,n.y,s.x,s.y,o.x,o.y,p.x,p.y)&&G(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;y&&y.z<=f;){if(y!==r.prev&&y!==r.next&&Bt(n.x,n.y,s.x,s.y,o.x,o.y,y.x,y.y)&&G(y.prev,y,y.next)>=0)return!1;y=y.nextZ}return!0}function bi(r,t,e,i){const n=Ue.create(r,t,e);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function ae(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Fs(r){let t=r,e=r;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==r);return e}function Cs(r,t,e,i,n,s){const o=new Array;for(let a=0,c=i.length;a<c;a++){const u=Hi(r,t,e,i[a]*s,a<c-1?i[a+1]*s:e*s,s,!1);u===u.next&&(u.steiner=!0),o.push(Fs(u))}o.sort(As);for(const a of o)n=Bs(a,n);return n}function Bs(r,t){const e=Os(r,t);if(!e)return t;const i=qi(e,r);return se(i,i.next),se(e,e.next)}function Os(r,t){let e=t;const i=r.x,n=r.y;let s,o=-1/0;do{if(n<=e.y&&n>=e.next.y&&e.next.y!==e.y){const f=e.x+(n-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(f<=i&&f>o){if(o=f,f===i){if(n===e.y)return e;if(n===e.next.y)return e.next}s=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!s)return null;if(i===o)return s.prev;const a=s,c=s.x,u=s.y;let l,h=1/0;for(e=s.next;e!==a;)i>=e.x&&e.x>=c&&i!==e.x&&Bt(n<u?i:o,n,c,u,n<u?o:i,n,e.x,e.y)&&(l=Math.abs(n-e.y)/(i-e.x),(l<h||l===h&&e.x>s.x)&&ce(e,r)&&(s=e,h=l)),e=e.next;return s}function Zi(r,t,e,i){let n;for(;n!==r;n=n.next){if(n=n||r,n.z===null&&(n.z=dr(n.x,n.y,t,e,i)),n.prev.next!==n||n.next.prev!==n)return n.prev.next=n,n.next.prev=n,Zi(r,t,e,i);n.prevZ=n.prev,n.nextZ=n.next}return r.prevZ.nextZ=null,r.prevZ=null,Vs(r)}function Vs(r){let t,e=1;for(;;){let i,n=r;r=null,t=null;let s=0;for(;n;){s++,i=n;let o=0;for(;o<e&&i;o++)i=i.nextZ;let a=e;for(;o>0||a>0&&i;){let c;o===0?(c=i,i=i.nextZ,a--):a!==0&&i?n.z<=i.z?(c=n,n=n.nextZ,o--):(c=i,i=i.nextZ,a--):(c=n,n=n.nextZ,o--),t?t.nextZ=c:r=c,c.prevZ=t,t=c}n=i}if(t.nextZ=null,e*=2,s<2)return r}}function G(r,t,e){return(t.y-r.y)*(e.x-t.x)-(t.x-r.x)*(e.y-t.y)}function Xi(r,t,e,i){return!!(St(r,t)&&St(e,i)||St(r,i)&&St(e,t))||G(r,t,e)>0!=G(r,t,i)>0&&G(e,i,r)>0!=G(e,i,t)>0}function Rs(r,t){let e=r;do{if(e.index!==r.index&&e.next.index!==r.index&&e.index!==t.index&&e.next.index!==t.index&&Xi(e,e.next,r,t))return!0;e=e.next}while(e!==r);return!1}function Ls(r,t,e,i,n,s){let o=0;for(let a=i,c=n-s;a<n;a+=s)o+=(r[c+t*s]-r[a+t*s])*(r[a+1+t*s]+r[c+1+t*s]),c=a;return o}function Bt(r,t,e,i,n,s,o,a){return(n-o)*(t-a)-(r-o)*(s-a)>=0&&(r-o)*(i-a)-(e-o)*(t-a)>=0&&(e-o)*(s-a)-(n-o)*(i-a)>=0}function ce(r,t){return G(r.prev,r,r.next)<0?G(r,t,r.next)>=0&&G(r,r.prev,t)>=0:G(r,t,r.prev)<0||G(r,r.next,t)<0}function dr(r,t,e,i,n){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=32767*(r-e)*n)|r<<8))|r<<4))|r<<2))|r<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function St(r,t){return r.x===t.x&&r.y===t.y}function As(r,t){return r.x-t.x}function Gs(r,t,e,i){let n=r;do{const s=n.prev,o=n.next.next;!St(s,o)&&Xi(s,n,n.next,o)&&ce(s,o)&&ce(o,s)&&(t.push(s.index/e+i),t.push(n.index/e+i),t.push(o.index/e+i),ae(n),ae(n.next),n=r=o),n=n.next}while(n!==r);return n}function Us(r,t,e,i,n,s,o){let a=r;do{let c=a.next.next;for(;c!==a.prev;){if(a.index!==c.index&&Ws(a,c)){let u=qi(a,c);return a=se(a,a.next),u=se(u,u.next),oe(a,t,e,i,n,s,o,0),void oe(u,t,e,i,n,s,o,0)}c=c.next}a=a.next}while(a!==r)}function Ws(r,t){return r.next.index!==t.index&&r.prev.index!==t.index&&!Rs(r,t)&&ce(r,t)&&ce(t,r)&&Ys(r,t)}function Ys(r,t){let e=r,i=!1;const n=(r.x+t.x)/2,s=(r.y+t.y)/2;do e.y>s!=e.next.y>s&&e.next.y!==e.y&&n<(e.next.x-e.x)*(s-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==r);return i}function qi(r,t){const e=Ue.create(r.index,r.x,r.y),i=Ue.create(t.index,t.x,t.y),n=r.next,s=t.prev;return r.next=t,t.prev=r,e.next=n,n.prev=e,i.next=e,e.prev=i,s.next=i,i.prev=s,i}let Ue=class Ki{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const n=fr<pr.length?pr[fr++]:new Ki;return n.index=t,n.x=e,n.y=i,n.prev=null,n.next=null,n.z=null,n.prevZ=null,n.nextZ=null,n.steiner=!1,n}};const pr=[],Hs=8096;let fr=0;for(let r=0;r<Hs;r++)pr.push(new Ue);const Zs=1e-5,_t=new Ri(0,0,0,1,0),mr=new Ri(0,0,0,1,0);function vi(r,t,e){let i=0;for(let n=1;n<e;n++){const s=r[2*(t+n-1)],o=r[2*(t+n-1)+1];i+=(r[2*(t+n)]-s)*(r[2*(t+n)+1]+o)}return i}function Xs(r,t,e,i,n){let s=0;const o=2;for(let a=e;a<i;a+=3){const c=(r[a]-n)*o,u=(r[a+1]-n)*o,l=(r[a+2]-n)*o;s+=Math.abs((t[c]-t[l])*(t[u+1]-t[c+1])-(t[c]-t[u])*(t[l+1]-t[c+1]))}return s}function qs(r,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:n}=t,s=0,o=r;if(n)return!1;let a=0;for(let c=0;c<i.length;){let u=c,l=i[c],h=vi(e,a,l);const f=[];for(;++u<i.length;){const v=i[u],w=vi(e,a+l,v);if(!(w>0))break;h+=w,f.push(a+l),l+=v}const p=o.length;Es(o,e,a,a+l,f,2,s);const y=Xs(o,e,p,o.length,s),b=Math.abs(h);if(Math.abs((y-b)/Math.max(1e-7,b))>Zs)return o.length=0,!1;c=u,a+=l}return!0}function Ks(r){const{coords:t,lengths:e}=r,{buffer:i}=ns(t,e);return i}function js(r,t,e){let i=0;for(let n=0;n<r.lengths.length;n++){const s=r.lengths[n];for(let o=0;o<s;o++){const a=r.coords[2*(o+i)],c=r.coords[2*(o+i)+1];if(a<t||a>e||c<t||c>e)return!0}i+=s}return!1}function ji(r,t){if(r==null)return null;if(!js(r,-128,Ae+128))return r;_t.setPixelMargin(t),_t.reset(Li.Polygon);let e=0;for(let o=0;o<r.lengths.length;o++){const a=r.lengths[o];let c=r.coords[2*(0+e)],u=r.coords[2*(0+e)+1];_t.moveTo(c,u);for(let l=1;l<a;l++)c=r.coords[2*(l+e)],u=r.coords[2*(l+e)+1],_t.lineTo(c,u);_t.close(),e+=a}const i=_t.result(!1);if(!i)return null;const n=[],s=[];for(const o of i){let a=0;for(const c of o)s.push(c.x),s.push(c.y),a++;n.push(a)}return new cs(n,s)}function Qs(r,t){mr.setPixelMargin(t);const e=mr,i=-t,n=Ae+t;let s=[],o=!1;if(!r.nextPath())return null;let a=!0;for(;a;){r.seekPathStart();const c=[];if(!r.pathSize)return null;e.reset(Li.LineString),r.nextPoint();let u=r.x,l=r.y;if(o)e.moveTo(u,l);else{if(u<i||u>n||l<i||l>n){o=!0;continue}c.push({x:u,y:l})}let h=!1;for(;r.nextPoint();)if(u=r.x,l=r.y,o)e.lineTo(u,l);else{if(u<i||u>n||l<i||l>n){h=!0;break}c.push({x:u,y:l})}if(h)o=!0;else{if(o){const f=e.resultWithStarts();if(f)for(const p of f)s.push(p)}else s.push({line:c,start:0});a=r.nextPath(),o=!1}}return s=s.filter(c=>c.line.length>1),s.length===0?null:s}_t.setExtent(Ae),mr.setExtent(Ae);const Js=96/72;let to=class{static executeEffects(t,e,i,n){const s=Js,o=yi(t);let a=new xi(e);for(const c of t){const u=gi(c);u&&(a=u.execute(a,c,s,i,n,o))}return a}static applyEffects(t,e,i){if(!t)return e;const n=yi(t);let s,o=new xi(ft.fromJSONCIM(e));for(const u of t){const l=gi(u);l&&(o=l.execute(o,u,1,null,i,n))}const a=[];let c=null;for(;s=o.next();)a.push(...qn(s)),c=s.geometryType;return a.length===0||c===null?null:c==="esriGeometryPolygon"?{rings:a}:{paths:a}}},Qi=null;function Hr(){return Qi}async function eo(){Qi=await Kn(()=>import("./geometryEngineJSON-Cp8Nw467.js").then(r=>r.g),__vite__mapDeps([0,1,2,3]))}function Ji(r){switch(r){case g.BYTE:case g.UNSIGNED_BYTE:return 1;case g.SHORT:case g.UNSIGNED_SHORT:return 2;case g.FLOAT:case g.INT:case g.UNSIGNED_INT:return 4}}function ro(r){const t=[],e=[],i=[];for(const n of r){const s=Ji(n.type)*n.count;switch(s%2||s%4||4){case 4:t.push(n);continue;case 2:e.push(n);continue;case 1:i.push(n);continue;default:throw new Error("Found unexpected dataType byte count")}}return t.push(...e),t.push(...i),t}let io=class tn{static fromVertexSpec({attributes:t},e){let i,n,s;const o=[];for(const p in t){const y=t[p];(e==null?void 0:e[p])!==!1&&(y.pack==="position"?i={...y,name:p,offset:0}:y.pack==="id"?n={...y,name:p,offset:4}:p==="bitset"?s={...y,name:p,offset:7}:o.push({...y,name:p}))}const a=ro(o),c=[];let u=8,l=1;for(const p of a)c.push({...p,offset:u}),u+=Ji(p.type)*p.count,p.packAlternating&&(l=Math.max(p.packAlternating.count,l));const h=Uint32Array.BYTES_PER_ELEMENT,f=u%h;return new tn(i,n,s,c,u+(f?h-f:0),l)}constructor(t,e,i,n,s,o){this.position=t,this.id=e,this.bitset=i,this.standardAttributes=n,this.stride=s,this.packVertexCount=o,n.push(i),this._attributes=[t,e,i,...n]}get attributeLayout(){if(!this._attributeLayout){const t=bs(this._attributes),e=this._attributes.map(i=>({name:i.name,count:i.count,offset:i.offset,type:i.type,packPrecisionFactor:i.packPrecisionFactor,normalized:i.normalized??!1}));this._attributeLayout={attributes:e,hash:t,stride:this.stride}}return this._attributeLayout}},no=class en{static fromVertexSpec(t,e){const i=io.fromVertexSpec(t,e);return new en(i)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,e,i,n,s,o){var a;for(let c=0;c<this._spec.packVertexCount;c++){const u=c*this._spec.stride;this._packPosition(i,n,u),this._packId(e,u);const l=this._spec.bitset;if(o){if(l.packTessellation){const h=l.packTessellation(o,s);this._pack(h,l,u)}for(const h of this._spec.standardAttributes)if(h.packTessellation!=null){const f=h.packTessellation(o,s);this._pack(f,h,u)}else if((a=h.packAlternating)!=null&&a.packTessellation){const f=h.packAlternating.packTessellation(o,s);for(let p=0;p<this._spec.packVertexCount;p++){const y=f[p];this._pack(y,h,p*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,e){var i;for(const n of this._spec.standardAttributes)if(n.pack&&typeof n.pack!="string"){const s=n.pack(t,e);for(let o=0;o<this._spec.packVertexCount;o++)this._pack(s,n,o*this._spec.stride)}else if((i=n.packAlternating)!=null&&i.pack){const s=n.packAlternating.pack(t,e);for(let o=0;o<this._spec.packVertexCount;o++){const a=s[o];this._pack(a,n,o*this._spec.stride)}}}_packPosition(t,e,i){const{offset:n}=this._spec.position,s=this._spec.position.packPrecisionFactor??1,o=_s(t*s,e*s);this._dataView.setUint32(i+n,o,!0)}_packId(t,e){const i=t*(this._spec.id.packPrecisionFactor??1),n=4278190080&this._dataView.getUint32(e+this._spec.id.offset,!0);this._dataView.setUint32(e+this._spec.id.offset,i|n,!0)}_pack(t,e,i){vs(this._dataView,t,e,i)}};function so(r){if(!r)return!1;for(const t of r)switch(t.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1}let Gt=class{constructor(t,e,i,n){this._instanceId=t,this._evaluator=e,this._viewParams=i,this._optionalAttributes=n,this._evaluator.evaluator=s=>this.vertexSpec.createComputedParams(s)}get _vertexPack(){if(!this._cachedVertexPack){const t=no.fromVertexSpec(this.vertexSpec,this._optionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){var t;so((t=this._evaluator.inputMeshParams.params.effects)==null?void 0:t.effectInfos)&&await eo()}enqueueRequest(t,e,i){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,e,i)}write(t,e,i,n,s){var p;this.ensurePacked(e,i,n);const o=this.evaluatedMeshParams.effects;if(!o||o.length===0)return void this._write(t,i,void 0,s);const a=(p=i.readGeometryForDisplay())==null?void 0:p.clone();if(!a)return;const c=ft.fromOptimizedCIM(a,i.geometryType),u=Hr();c.invertY();const l=t.id||"",h=to.executeEffects(o,c,l,u);let f;for(;f=h.next();)f.invertY(),this._write(t,i,f,s)}ensurePacked(t,e,i){if(!this._evaluator.hasDynamicProperties)return;const n=this._evaluator.evaluateMeshParams(t,e,i);this._vertexPack.pack(n,this._viewParams)}_writeVertex(t,e,i,n,s){const o=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,e,i,n,o,s)}};const oo=100,ao=Ur("featurelayer-fast-triangulation-enabled");let rn=class extends Gt{async loadDependencies(){await Promise.all([super.loadDependencies(),ss()])}_write(t,e,i){const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);s&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,s),t.recordEnd())}_clip(t){if(!t)return null;const e=this.hasEffects;return ji(t,e?256:8)}_writeGeometry(t,e,i){const n=i.maxLength>oo,s=[],o=this.createTesselationParams(e);if(!n&&ao&&qs(s,i))return void(s.length&&this._writeVertices(t,e,i.coords,o,s));const a=Ks(i);this._writeVertices(t,e,a,o)}_writeVertices(t,e,i,n,s){const o=e.getDisplayId(),a=t.vertexCount(),c=this.hasEffects;let u=0;if(s)for(const l of s){const h=i[2*l],f=i[2*l+1];c&&t.recordBounds(h,f,0,0),this._writeVertex(t,o,h,f,n),u++}else for(let l=0;l<i.length;l+=2){const h=Math.round(i[l]),f=Math.round(i[l+1]);c&&t.recordBounds(h,f,0,0),this._writeVertex(t,o,h,f,n),u++}t.indexEnsureSize(u);for(let l=0;l<u;l++)t.indexWrite(l+a)}};const co={createComputedParams:r=>r,attributes:{id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1},pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:g.FLOAT,count:1,packTessellation:({inverseArea:r})=>r}}};let uo=class extends rn{constructor(){super(...arguments),this.vertexSpec=co}createTesselationParams(t){return{inverseArea:1/t.readGeometryArea()}}};const lo=()=>je.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils"),ho=0,po=100;function Ut(r,t){return[!!(r!=null&&r.minScale)&&t.scaleToZoom(r.minScale)||ho,!!(r!=null&&r.maxScale)&&t.scaleToZoom(r.maxScale)||po]}function Zt(r){return 1<<r}function de(r){let t=0;for(const[e,i]of r)i&&(t|=1<<e);return t}function L(r){let t;if(!r)return[0,0,0,0];if(typeof r=="string"){const o=jn.fromString(r);if(!o)return lo().errorOnce(new Wr("mapview:mesh-processing","Unable to parse string into color",{color:r})),[0,0,0,0];t=o.toArray()}else t=r;const[e,i,n,s]=t;return[e*(s/255),i*(s/255),n*(s/255),s]}function fo(r){switch(r){case"butt":case or.Butt:return ar.BUTT;case"round":case or.Round:return ar.ROUND;case"square":case or.Square:return ar.SQUARE}}function mo(r){switch(r){case"bevel":case cr.Bevel:return ur.BEVEL;case"miter":case cr.Miter:return ur.MITER;case"round":case cr.Round:return ur.ROUND}}function lr(r,t){return Math.round(Math.min(Math.sqrt(r*t),255))}function ve(r,t){return Math.round(r*t)/t}function _i(r,t){return Math.ceil(r*t)/t}const nn={createComputedParams:r=>r,attributes:{id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1},pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},zoomRange:{type:g.SHORT,count:2,packPrecisionFactor:Qe,pack:({scaleInfo:r},{tileInfo:t})=>Ut(r,t)},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)}}};let Zr=class extends rn{constructor(){super(...arguments),this.vertexSpec=nn}createTesselationParams(t){return null}};const Je={createComputedParams:r=>r,attributes:{...nn.attributes,tlbr:{count:4,type:g.UNSIGNED_SHORT,pack:({sprite:r})=>{const{rect:t,width:e,height:i}=r,n=t.x+Rt,s=t.y+Rt;return[n,s,n+e,s+i]}},inverseRasterizationScale:{count:1,type:g.BYTE,packPrecisionFactor:16,pack:({sprite:r})=>1/r.rasterizationScale}}};let sn=class extends Zr{constructor(){super(...arguments),this.vertexSpec=Je}_write(t,e,i){var a;const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);if(!s)return;const o=(a=this.evaluatedMeshParams.sprite)==null?void 0:a.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,o),this._writeGeometry(t,e,s),t.recordEnd()}};var wi;(function(r){r[r.Geographic=0]="Geographic",r[r.Arithmatic=1]="Arithmatic"})(wi||(wi={}));const Yc=3.14159265359/180,yo=3.14159265359/128,Hc=1,go=1.1,xo=1,Zc=24,Xc=8,bo=1e-5,$i=.05,vo=1e-30,Xr=4,qr=0,on=2,an=5,cn=6,_o=2,wo=3,$o=0,So=3,Po=16777216;function Kr(r){const{sprite:t,aspectRatio:e,scaleProportionally:i}=r,n=S(r.height),s=n>0?n:t.height;let o=n*e;return o<=0?o=t.width:i&&(o*=t.width/t.height),{width:o,height:s}}function un(r){const{applyRandomOffset:t,sampleAlphaOnly:e}=r,{width:i,height:n}=Kr(r);return de([[on,t],[Xr,e],[cn,i<Ge],[an,n<Ge]])}function ln(r){const{width:t}=Kr(r);return Math.round(t<Ge?t*Yr:t)}function hn(r){const{height:t}=Kr(r);return Math.round(t<Ge?t*Yr:t)}const dn={createComputedParams:r=>r,attributes:{...Je.attributes,bitset:{count:1,type:g.UNSIGNED_BYTE,pack:un},width:{count:1,type:g.UNSIGNED_SHORT,pack:ln},height:{count:1,type:g.UNSIGNED_SHORT,pack:hn},offset:{count:2,type:g.SHORT,pack:({offsetX:r,offsetY:t})=>[S(r),-S(t)]},scale:{count:2,type:g.UNSIGNED_BYTE,packPrecisionFactor:16,pack:({scaleX:r,scaleY:t})=>[r,t]},angle:{count:1,type:g.UNSIGNED_BYTE,pack:({angle:r})=>as(r)}}};let To=class extends sn{constructor(){super(...arguments),this.vertexSpec=dn}},Io=class{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}};const tr={createComputedParams:r=>r,attributes:{id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:g.UNSIGNED_BYTE,count:1},zoomRange:{type:g.SHORT,count:2,packPrecisionFactor:Qe,pack:({scaleInfo:r},{tileInfo:t})=>Ut(r,t)},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)},offset:{type:g.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:r,extrusionOffsetY:t})=>[ve(r,16),ve(t,16)]},normal:{type:g.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:r,normalY:t})=>[ve(r,16),ve(t,16)]},halfWidth:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({width:r})=>_i(S(.5*r),16)},referenceHalfWidth:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({referenceWidth:r})=>_i(S(.5*r),16)}}};let ko=class{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}};const Si=65535;let jr=class extends Gt{constructor(t,e,i,n){super(t,e,i,n),this.vertexSpec=tr,this._currentWrite=new ko,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:Si,textured:!1},this._tessParams=new Io,this._initializeTessellator()}writeLineVertices(t,e,i){const n=this._getLines(e);n!=null&&this._writeVertices(t,i,n)}_initializeTessellator(){this._lineTessellator=new os(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,e,i){const n=i??ft.fromFeatureSetReaderCIM(e);n&&this._writeGeometry(t,e,n)}_writeGeometry(t,e,i,n){t.recordStart(this.instanceId,this.attributeLayout,n),this.writeLineVertices(t,i,e),t.recordEnd()}_getLines(t){return Qs(t,Ai(this.evaluatedMeshParams))}_writeVertices(t,e,i){const{_currentWrite:n,_tessellationOptions:s,evaluatedMeshParams:o}=this,{width:a,capType:c,joinType:u,miterLimit:l,hasSizeVV:h}=o,f=S(.5*a);s.halfWidth=f,s.capType=fo(c),s.joinType=mo(u),s.miterLimit=l;const p=!h;n.out=t,n.id=e.getDisplayId(),n.vertexCount=0,n.indexCount=0,n.vertexFrom=t.vertexCount(),n.vertexBounds=p&&f<us?0:1;for(const{line:y,start:b}of i)s.initialDistance=b%Si,this._lineTessellator.tessellate(y,s,p)}_writeTesselatedVertex(t,e,i,n,s,o,a,c,u,l,h){const{out:f,id:p,vertexBounds:y}=this._currentWrite;return this.hasEffects&&f.recordBounds(t,e,y,y),this._tessParams.extrusionOffsetX=a,this._tessParams.extrusionOffsetY=c,this._tessParams.normalX=u,this._tessParams.normalY=l,this._tessParams.directionX=s,this._tessParams.directionY=o,this._tessParams.distance=h,this._writeVertex(f,p,t,e,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,e,i){const{out:n}=this._currentWrite;n.indexEnsureSize(3),n.indexWrite(t),n.indexWrite(e),n.indexWrite(i),this._currentWrite.indexCount+=3}};const pn={createComputedParams:r=>r,attributes:{...tr.attributes,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>0},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)}}},Qr={createComputedParams:r=>r,attributes:{...tr.attributes,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>de([[qr,!0]])},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:r})=>L(r)}}};let Jr=class extends jr{constructor(){super(...arguments),this.vertexSpec=Qr}},ti=class extends Zr{constructor(t,e,i,n){super(t,e,i,n),this.vertexSpec=pn,this._lineMeshWriter=this._createOutlineWriter(t,e,i,n)}_createOutlineWriter(t,e,i,n){return new Jr(t,e,i,n)}_write(t,e,i){const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);s&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,s),this._lineMeshWriter.writeLineVertices(t,ft.fromOptimizedCIM(s,"esriGeometryPolyline"),e),t.recordEnd())}_clip(t){return t?ji(t,Ai(this.evaluatedMeshParams)):null}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}};const fn=()=>je.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let mn=class{constructor(){this._includedModules=new Map}include(t,e){if(this._includedModules.has(t)){const i=this._includedModules.get(t);if(i!==e){fn().error("Trying to include shader module multiple times with different sets of options.");const n=new Set;for(const s of Object.keys(i))i[s]!==t[s]&&n.add(s);for(const s of Object.keys(t))i[s]!==t[s]&&n.add(s);n.forEach(s=>console.error(`  ${s}: current ${i[s]} new ${t[s]}`))}}else this._includedModules.set(t,e),t(this.builder,e)}},Mo=class extends mn{constructor(){super(...arguments),this.vertex=new Pi,this.fragment=new Pi,this.attributes=new zo,this.varyings=new Do,this.extensions=new yr,this.constants=new yn}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t,e=!0){const i=this.extensions.generateSource(t),n=this.attributes.generateSource(t),s=this.varyings.generateSource(t),o=t==="vertex"?this.vertex:this.fragment,a=o.uniforms.generateSource(),c=o.code.generateSource(),u=t==="vertex"?Co:Fo(e),l=this.constants.generateSource().concat(o.constants.generateSource());return`${e?"#version 300 es":""}
${i.join(`
`)}
${u}
${l.join(`
`)}
${a.join(`
`)}
${n.join(`
`)}
${s.join(`
`)}
${c.join(`
`)}`}generateBindPass(t){const e=new Map;this.vertex.uniforms.entries.forEach(s=>{const o=s.bind[xe.Pass];o&&e.set(s.name,o)}),this.fragment.uniforms.entries.forEach(s=>{const o=s.bind[xe.Pass];o&&e.set(s.name,o)});const i=Array.from(e.values()),n=i.length;return(s,o)=>{for(let a=0;a<n;++a)i[a](t,s,o)}}generateBindDraw(t){const e=new Map;this.vertex.uniforms.entries.forEach(s=>{const o=s.bind[xe.Draw];o&&e.set(s.name,o)}),this.fragment.uniforms.entries.forEach(s=>{const o=s.bind[xe.Draw];o&&e.set(s.name,o)});const i=Array.from(e.values()),n=i.length;return(s,o,a)=>{for(let c=0;c<n;++c)i[c](t,s,o,a)}}},No=class{constructor(){this._entries=new Map}add(...t){for(const e of t)this._add(e)}get(t){return this._entries.get(t)}_add(t){if(t!=null){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new Wr(`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}else fn().error(`Trying to add null Uniform from ${new Error().stack}.`)}generateSource(){return Array.from(this._entries.values()).map(t=>t.arraySize!=null?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`)}get entries(){return Array.from(this._entries.values())}},Eo=class{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}},Pi=class extends mn{constructor(){super(...arguments),this.uniforms=new No,this.code=new Eo,this.constants=new yn}get builder(){return this}},zo=class{constructor(){this._entries=new Array}add(t,e){this._entries.push([t,e])}generateSource(t){return t==="fragment"?[]:this._entries.map(e=>`in ${e[1]} ${e[0]};`)}},Do=class{constructor(){this._entries=new Map}add(t,e){this._entries.has(t)&&$s(this._entries.get(t)===e),this._entries.set(t,e)}generateSource(t){const e=new Array;return this._entries.forEach((i,n)=>e.push(t==="vertex"?`out ${i} ${n};`:`in ${i} ${n};`)),e}},yr=class gr{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const e=t==="vertex"?gr.ALLOWLIST_VERTEX:gr.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(i=>e.includes(i)).map(i=>`#extension ${i} : enable`)}};yr.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],yr.ALLOWLIST_VERTEX=[];let yn=class z{constructor(){this._entries=new Set}add(t,e,i){let n="ERROR_CONSTRUCTOR_STRING";switch(e){case"float":n=z._numberToFloatStr(i);break;case"int":n=z._numberToIntStr(i);break;case"bool":n=i.toString();break;case"vec2":n=`vec2(${z._numberToFloatStr(i[0])},                            ${z._numberToFloatStr(i[1])})`;break;case"vec3":n=`vec3(${z._numberToFloatStr(i[0])},                            ${z._numberToFloatStr(i[1])},                            ${z._numberToFloatStr(i[2])})`;break;case"vec4":n=`vec4(${z._numberToFloatStr(i[0])},                            ${z._numberToFloatStr(i[1])},                            ${z._numberToFloatStr(i[2])},                            ${z._numberToFloatStr(i[3])})`;break;case"ivec2":n=`ivec2(${z._numberToIntStr(i[0])},                             ${z._numberToIntStr(i[1])})`;break;case"ivec3":n=`ivec3(${z._numberToIntStr(i[0])},                             ${z._numberToIntStr(i[1])},                             ${z._numberToIntStr(i[2])})`;break;case"ivec4":n=`ivec4(${z._numberToIntStr(i[0])},                             ${z._numberToIntStr(i[1])},                             ${z._numberToIntStr(i[2])},                             ${z._numberToIntStr(i[3])})`;break;case"mat2":case"mat3":case"mat4":n=`${e}(${Array.prototype.map.call(i,s=>z._numberToFloatStr(s)).join(", ")})`}return this._entries.add(`const ${e} ${t} = ${n};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}};function Fo(r=!0){return`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif
${r?"out vec4 fragColor;":""}
`}const Co=`precision highp float;
precision highp sampler2D;`;function Bo(r){return r.split(" ").map((t,e)=>e>0?t.charAt(0).toUpperCase()+t.slice(1):t).join("")}function Oo(r,t){const e=[];for(e.push(t);e.length;){const i=e.pop();if(typeof i=="object"&&!r.has(i.uid)){r.add(i.uid);for(const n of i.children)e.push(n)}}}let kt=class xr{constructor(){this.uid=xr.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=Bo(t),this._debugName=t,this.isImplicit&&this.children[0]instanceof xr&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(t){t._debugName=this._debugName,t._isMutable=this._isMutable,t.isImplicit=this.isImplicit,t.uid=this.uid}};function x(r){return typeof r=="object"?r.clone():r}kt.NodeCount=0;let B=class extends kt{constructor(){super(...arguments),this.shaderType="primitive-node"}},Vo=class gn extends kt{constructor(t){super(),this.child=t,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const t=new gn(x(this.child));return this.cloneInto(t),t}},Ro=class xn extends kt{constructor(t,e,i){super(),this.property=t,this.target=e,this.returnType=i,this.shaderType="property-access-node"}get children(){const t=[this.target];return typeof this.property!="string"&&t.push(this.property),t}clone(){const t=new xn(this.property,x(this.target),this.returnType);return this.cloneInto(t),t}},Lo=class bn extends kt{constructor(t,e,i){super(),this.condition=t,this.ifTrue=e,this.ifFalse=i,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const t=x(this.ifTrue),e=this.ifFalse?x(this.ifFalse):null,i=new bn(this.condition,t,e);return this.cloneInto(i),i}},Ao=class vn extends kt{constructor(t,e,i,n){super(),this.captureList=t,this.returnType=e,this.generator=n,this.shaderType="block-node",i&&(this.subgraph=new Vo(i))}get children(){return Object.keys(this.captureList).map(t=>this.captureList[t]).concat(this.subgraph??[])}clone(){const t={};for(const i in this.captureList)t[i]=x(this.captureList[i]);const e=new vn(t,this.returnType,this.subgraph?x(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(e),e}},Pt=class _n extends kt{constructor(t,e,i,n,s,o=!1){super(),this.token=t,this._children=e,this.isInfix=i,this.isPropertyAccess=n,this.returnType=s,this.isTernary=o,this.shaderType="function-node"}get children(){return this._children}clone(){const t=new _n(this.token,this._children.map(x),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}};var te,br,vr,_r,wr,$r,Sr,Pr,Tr,Ir,kr,Mr,Nr,Er;function Go(r){const t=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const e of t)if(e.includes(r))return e.map(i=>Ho[i]);throw new Error("Unable to find type family")}function wn(r){return new Proxy(r,{get(t,e){if(e==="constructor")return new Proxy(t.constructor,{construct:(i,n,s)=>wn(new i(...n))});if(e in t)return t[e];if(typeof e=="string"){const i=Go(r.type);return X(r,e,i[e.length-1])}}})}function K(r){return new Proxy(r,{construct:(t,e,i)=>wn(new t(...e))})}function Uo(r){return new Proxy(r,{get(t,e){if(e in t)return t[e];if(typeof e=="string"){const i=parseInt(e,10);if(!isNaN(i))return X(r,`[${i}]`,r.elementType.constructor)}}})}function Wo(r){return new Proxy(r,{construct:(t,e,i)=>Uo(new t(...e))})}let zr=class extends Error{},rt=te=class extends B{constructor(r,t){super(),this.elementType=r,this.size=t,this.children=[],this.type="array"}clone(){const r=new te(this.elementType,this.size);return super.cloneInto(r),r}get(r){if(typeof r=="number"){const t=new xt(r);return t.isImplicit=!0,X(this,t,this.elementType.constructor)}return X(this,r,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(r,t,e){return qo(this,r,t,e)}glslFindIndex(r,t,e){return Ko(this,r,t,e)}static ofType(r,t){const e={construct:(i,n)=>new te(new r,t)};return new Proxy(te,e)}};rt.type="array",rt=te=d([Wo],rt);let ct=class $n extends B{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const t=new $n;return t.children=this.children.map(x),super.cloneInto(t),t}};ct.type="sampler2D";let m=class Ft extends B{constructor(t){super(),this.type="float",this.children=[t]}clone(){const t=new Ft(x(this.children[0]));return super.cloneInto(t),t}multiply(t){return vt(this,typeof t=="number"?O(t,Ft):t)}divide(t){return fe(this,typeof t=="number"?O(t,Ft):t)}add(t){return Wt(this,typeof t=="number"?O(t,Ft):t)}subtract(t){return me(this,typeof t=="number"?O(t,Ft):t)}};m.type="float";let T=br=class extends B{constructor(r,t){super(),this.type="vec2",this.children=[r,t].filter(e=>e!=null)}clone(){const r=new br(x(this.children[0]),x(this.children[1]));return super.cloneInto(r),r}get 0(){return X(this,"[0]",m)}get 1(){return X(this,"[1]",m)}get 2(){throw new zr}get 3(){throw new zr}multiply(r){return vt(this,typeof r=="number"?O(r,m):r)}divide(r){return fe(this,typeof r=="number"?O(r,m):r)}add(r){return Wt(this,typeof r=="number"?O(r,m):r)}subtract(r){return me(this,typeof r=="number"?O(r,m):r)}};T.type="vec2",T=br=d([K],T);let V=vr=class extends B{constructor(r,t,e){super(),this.type="vec3",this.children=[r,t,e].filter(i=>i!=null)}get 0(){return X(this,"[0]",m)}get 1(){return X(this,"[1]",m)}get 2(){return X(this,"[2]",m)}get 3(){throw new zr}clone(){const r=new vr(x(this.children[0]),x(this.children[1]),x(this.children[2]));return super.cloneInto(r),r}multiply(r){return vt(this,typeof r=="number"?O(r,m):r)}divide(r){return fe(this,typeof r=="number"?O(r,m):r)}add(r){return Wt(this,typeof r=="number"?O(r,m):r)}subtract(r){return me(this,typeof r=="number"?O(r,m):r)}};V.type="vec3",V=vr=d([K],V);let M=_r=class extends B{constructor(r,t,e,i){super(),this.type="vec4",this.children=[r,t,e,i].filter(n=>n!=null)}clone(){const r=new _r(x(this.children[0]),x(this.children[1]),x(this.children[2]),x(this.children[3]));return super.cloneInto(r),r}get 0(){return X(this,"[0]",m)}get 1(){return X(this,"[1]",m)}get 2(){return X(this,"[2]",m)}get 3(){return X(this,"[3]",m)}multiply(r){return vt(this,typeof r=="number"?O(r,m):r)}divide(r){return fe(this,typeof r=="number"?O(r,m):r)}add(r){return Wt(this,typeof r=="number"?O(r,m):r)}subtract(r){return me(this,typeof r=="number"?O(r,m):r)}};M.type="vec4",M=_r=d([K],M);let Me=wr=class extends B{constructor(r){super(),this.type="uint",this.children=[r]}clone(){const r=new wr(x(this.children[0]));return super.cloneInto(r),r}};Me.type="uint",Me=wr=d([K],Me);let Ne=$r=class extends B{constructor(r,t){super(),this.type="uvec2",this.children=[r,t].filter(e=>e!=null)}clone(){const r=new $r(x(this.children[0]),x(this.children[1]));return super.cloneInto(r),r}};Ne.type="uvec2",Ne=$r=d([K],Ne);let Ee=Sr=class extends B{constructor(r,t,e){super(),this.type="uvec3",this.children=[r,t,e].filter(i=>i!=null)}clone(){const r=new Sr(x(this.children[0]),x(this.children[1]),x(this.children[2]));return super.cloneInto(r),r}};Ee.type="uvec3",Ee=Sr=d([K],Ee);let ze=Pr=class extends B{constructor(r,t,e,i){super(),this.type="uvec4",this.children=[r,t,e,i].filter(n=>n!=null)}clone(){const r=new Pr(x(this.children[0]),x(this.children[1]),x(this.children[2]),x(this.children[3]));return super.cloneInto(r),r}};ze.type="uvec4",ze=Pr=d([K],ze);class Z extends B{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return Fr(this,t)}or(t){return Tn(this,t)}clone(){const t=new Z(x(this.children[0]));return super.cloneInto(t),t}}Z.type="bool";let De=Tr=class extends B{constructor(r,t){super(),this.type="bvec2",this.children=[r,t].filter(e=>e!=null)}all(){return ii(this)}any(){return ni(this)}clone(){const r=new Tr(x(this.children[0]),x(this.children[1]));return super.cloneInto(r),r}};De.type="bvec2",De=Tr=d([K],De);let Fe=Ir=class extends B{constructor(r,t,e){super(),this.type="bvec3",this.children=[r,t,e].filter(i=>i!=null)}all(){return ii(this)}any(){return ni(this)}clone(){const r=new Ir(x(this.children[0]),x(this.children[1]),x(this.children[2]));return super.cloneInto(r),r}};function O(r,t){return typeof r=="number"?new t(r):r}Fe.type="bvec3",Fe=Ir=d([K],Fe);let Ce=kr=class extends B{constructor(r,t,e,i){super(),this.type="bvec4",this.children=[r,t,e,i].filter(n=>n!=null)}all(){return ii(this)}any(){return ni(this)}clone(){const r=new kr(x(this.children[0]),x(this.children[1]),x(this.children[2]),x(this.children[3]));return super.cloneInto(r),r}};Ce.type="bvec4",Ce=kr=d([K],Ce);let xt=class Ct extends B{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return vt(this,O(t,Ct))}add(t){return Wt(this,O(t,Ct))}subtract(t){return me(this,O(t,Ct))}divide(t){return fe(this,O(t,Ct))}clone(){const t=new Ct(x(this.children[0]));return super.cloneInto(t),t}};xt.type="int";let Be=Mr=class extends B{constructor(r,t){super(),this.type="ivec2",this.children=[r,t].filter(e=>e!=null)}clone(){const r=new Mr(x(this.children[0]),x(this.children[1]));return super.cloneInto(r),r}};Be.type="ivec2",Be=Mr=d([K],Be);let Oe=Nr=class extends B{constructor(r,t,e){super(),this.type="ivec3",this.children=[r,t,e].filter(i=>i!=null)}clone(){const r=new Nr(x(this.children[0]),x(this.children[1]),x(this.children[2]));return super.cloneInto(r),r}};Oe.type="ivec3",Oe=Nr=d([K],Oe);let Ve=Er=class extends B{constructor(r,t,e,i){super(),this.type="ivec4",this.children=[r,t,e,i].filter(n=>n!=null)}clone(){const r=new Er(x(this.children[0]),x(this.children[1]),x(this.children[2]),x(this.children[3]));return super.cloneInto(r),r}};Ve.type="ivec4",Ve=Er=d([K],Ve);let Yo=class Sn extends B{constructor(t,e,i,n){super(),this.type="mat2",this.children=[t,e,i,n]}clone(){const t=new Sn(x(this.children[0]),x(this.children[1]),x(this.children[2]),x(this.children[3]));return super.cloneInto(t),t}};Yo.type="mat2";class H extends B{static identity(){return new H(1,0,0,0,1,0,0,0,1)}static fromRotation(t){const e=ai(t),i=In(t);return new H(i,e,0,We(e),i,0,0,0,1)}constructor(t,e,i,n,s,o,a,c,u){super(),this.type="mat3",this.children=[t,e,i,n,s,o,a,c,u]}add(t){return Wt(this,t)}multiply(t){return vt(this,t)}clone(){const t=new H(x(this.children[0]),x(this.children[1]),x(this.children[2]),x(this.children[3]),x(this.children[4]),x(this.children[5]),x(this.children[6]),x(this.children[7]),x(this.children[8]));return super.cloneInto(t),t}}H.type="mat3";class re extends B{static identity(){return new re(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,e,i,n,s,o,a,c,u,l,h,f,p,y,b,v){super(),this.type="mat4",this.children=[t,e,i,n,s,o,a,c,u,l,h,f,p,y,b,v]}static fromColumns(t,e,i,n){return new re(t.x,t.y,t.z,t.w,e.x,e.y,e.z,e.w,i.x,i.y,i.z,i.w,n.x,n.y,n.z,n.w)}multiply(t){return vt(this,t)}clone(){const t=new re(x(this.children[0]),x(this.children[1]),x(this.children[2]),x(this.children[3]),x(this.children[4]),x(this.children[5]),x(this.children[6]),x(this.children[7]),x(this.children[8]),x(this.children[9]),x(this.children[10]),x(this.children[11]),x(this.children[12]),x(this.children[13]),x(this.children[14]),x(this.children[15]));return super.cloneInto(t),t}}re.type="mat4";const Ho={float:m,vec2:T,vec3:V,vec4:M,int:xt,ivec2:Be,ivec3:Oe,ivec4:Ve,uint:Me,uvec2:Ne,uvec3:Ee,uvec4:ze,bool:Z,bvec2:De,bvec3:Fe,bvec4:Ce},Et=(...r)=>new xt(...r),D=(...r)=>new m(...r),Dr=(...r)=>new T(...r),Zo=(...r)=>new V(...r),Xo=(...r)=>new M(...r),Ti=(...r)=>new H(...r);function X(r,t,e){const i=new e(new Ro(t,r,e));return i.isImplicit=!0,i}function j(r,t,e,i=null){if(i){const s=new i,o=new i(new Pt(r,[t,e],!0,!1,s));return o.isImplicit=!0,o}if(t.type==="float"||t.type==="int"){const s=new e.constructor(new Pt(r,[t,e],!0,!1,e.constructor));return s.isImplicit=!0,s}if((t.type==="mat2"||t.type==="mat3"||t.type==="mat4")&&e.type!=="float"){const s=new e.constructor(new Pt(r,[t,e],!0,!1,e.constructor));return s.isImplicit=!0,s}const n=new t.constructor(new Pt(r,[t,e],!0,!1,t.constructor));return n.isImplicit=!0,n}function J(r,t,e=t.constructor){const i=new e(new Pt(r,[t],!1,!1,e));return i.isImplicit=!0,i}function Mt(r,t,e,i=t.constructor){const n=new i(new Pt(r,[t,e],!1,!1,i));return n.isImplicit=!0,n}function ei(r,t,e,i,n=t.constructor){const s=new n(new Pt(r,[t,e,i],!1,!1,n));return s.isImplicit=!0,s}function We(r){return vt(r,D(-1))}function Pn(r,t,e,i){return new t(new Ao(r,t,e,i))}function qo(r,t,e=0,i=r.size){const n=new xt(e).setMutable().setDebugName("FindIndexIterator"),s=t(r.get(n)).setDebugName("FindIndexPredicate");return Pn({iter:n},xt,s,({out:a,iter:c,subgraph:u})=>`
${a} = -1;

for (; ${c} < ${i}; ${c}++) {

${u.body}

  if (${u.varName}) {
    ${a} = ${c};
    break;
  }

}
`).setDebugName("FindIndexBlock")}function Ko(r,t,e=0,i=r.size){return Pn({array:r},xt,null,({out:s,array:o})=>`
${s} = -1;
for (int i = ${e}; i < ${i}; i++) {
  bool condition;
  ${t({array:o,i:"i",out:"condition"})}
  if (condition) {
    ${s} = i;
    break;
  }
}
`).setDebugName("GlslFindIndexBlock")}function R(r,t,e){const i=typeof t=="function"?t():t,n=typeof e=="function"?e():e,s=new i.constructor(new Lo(r,i,n));return s.isImplicit=!0,s}function pe(...r){const t=r.map(([a,c])=>typeof c=="function"?[a,c()]:[a,c]),e=t[0][1].constructor,i=t.findIndex(a=>a[0]===!0);if(i===-1)throw new Error("A cond must have a fallthrough case with `true`/; ");const n=t.slice(0,i),s=t[i][1],o=new e(n.reduceRight((a,c)=>R(c[0],c[1],a),s));return o.isImplicit=!0,o}function vt(r,t){return j("*",r,t)}function fe(r,t){return j("/",r,t)}function Wt(r,t){return j("+",r,t)}function me(r,t){return j("-",r,t)}function lu(r,t){return j(">>",r,t)}function hu(r,t){return j("&",r,t)}function ri(r,t){return j("==",r,t,Z)}function jo(r,t){return j("<",r,t,Z)}function er(r,t){return j("<=",r,t,Z)}function q(r,t){return j(">",r,t,Z)}function rr(r,t){return j(">=",r,t,Z)}function Tn(...r){return r.length<=1?r[0]:r.slice(1).reduce((t,e)=>Qo(t,e),r[0])}function Qo(r,t){return j("||",r,t,Z)}function Fr(...r){return r.length<=1?r[0]:r.slice(1).reduce((t,e)=>Jo(t,e),r[0])}function Jo(r,t){return j("&&",r,t,Z)}function ta(r){return J("abs",r)}function ii(r){return J("all",r,Z)}function ni(r){return J("any",r,Z)}function ea(r){return J("ceil",r)}function si(r,t,e){return ei("clamp",r,t,e,r.constructor)}function In(r){return J("cos",r)}function kn(r,t){return Mt("distance",r,t,m)}function oi(r,t){return Mt("dot",r,t,m)}function ra(r){return J("floor",r)}function Mn(r){return J("fract",r)}function Nn(r){return J("length",r,m)}function Vt(r,t){return Mt("max",r,t)}function Cr(r,t){return Mt("min",r,t)}function Nt(r,t,e){return ei("mix",r,t,e)}function Yt(r,t){return Mt("mod",r,t)}function ia(r){return J("normalize",r)}function na(r){return r.type==="bool"?J("!",r):J("not",r)}function ai(r){return J("sin",r)}function du(r,t,e){return ei("smoothstep",r,t,e)}function gt(r,t){return Mt("step",r,t,t.constructor)}function ut(r,t){return Mt("texture2D",r,t,M)}const Xt=5;function A(r,t,e){const i=t.split(`
`);for(const n of i)if(n.trim().length){{let s="";e!=null&&(s+=`/*id:${e??"000"}*/   `),r.body+=s.padEnd(14)}r.body+=" ".repeat(r.indent)+n+`
`}}let Ii=class{write(t){for(const e of t.rootOutputNodes())t.shouldPruneOutputNode(e)||(e.variableName=this._write(t,e.node));return t}_createVarName(t,e){let i="";return typeof e!="boolean"&&typeof e!="number"&&e.debugInfo.name&&(i=`${e.debugInfo.name}_`),`${i}v${t.varCount++}`}_write(t,e,i=!1){if(typeof e=="number"||typeof e=="boolean")return e.toString();let n=t.getEmit(e);if(n)return n;switch(e.shaderType){case"scope-node":n=this._writeScopeNode(t,e);break;case"primitive-node":n=this._writePrimitveNode(t,e,i);break;case"function-node":n=this._writeFunctionNode(t,e);break;case"property-access-node":n=this._writePropertyAccessNode(t,e);break;case"text-node":n=e.text;break;case"block-node":n=this._writeBlockNode(t,e);break;case"condition-node":n=this._writeConditionNode(t,e)}return t.setEmit(e,n),n}_writeScopeNode(t,e){const i=new e.child.constructor;i.setDebugName(e.debugInfo.name);const n=this._write(t,i,!0);return A(t,`{ /*ScopeStart: ${e.uid} ${e.debugInfo.name}*/`),t.indent+=2,A(t,`${n} = ${this._write(t,e.child)};`),t.indent-=2,A(t,`} /*ScopeEnd: ${e.uid} ${e.debugInfo.name}*/`),n}_writeConditionNode(t,e){const i=new e.ifTrue.constructor,n=this._write(t,i,!0);A(t,`if (${this._write(t,e.condition)}) {`),t.indent+=2;const s=t.createSubgraphContext(),o=this._write(s,e.ifTrue);if(t.body+=s.body,o&&A(t,`${n} = ${o};`),t.indent-=2,A(t,"}"),e.ifFalse){A(t,"else {"),t.indent+=2;const a=t.createSubgraphContext(),c=this._write(a,e.ifFalse);t.body+=a.body,c&&A(t,`${n} = ${c};`),t.indent-=2,A(t,"}")}return n}_writeBlockNode(t,e){const{captureList:i,generator:n,returnType:s}=e,o={};for(const l in i){if(!i[l])continue;const h=this._write(t,i[l]);o[l]=h}const a=new s,c=this._write(t,a,!0);if(o.out=c,e.subgraph){const l=t.createSubgraphContext(),h=this._write(l,e.subgraph.child),f=l.body;o.subgraph={varName:h,body:f}}const u=n(o);return A(t,`{
`),t.indent+=2,A(t,u),t.indent-=2,A(t,`}
`),c}_writePropertyAccessNode(t,e){const i=this._write(t,e.target);return typeof e.property=="string"&&e.property.includes("[")?`${i}${e.property}`:typeof e.property!="string"?`${i}[${this._write(t,e.property)}]`:`${i}.${e.property}`}_writeFunctionNode(t,e){const i=e.returnType.type;if(e.isInfix){const[o,a]=e.children.map(u=>this._write(t,u)),c=this._createVarName(t,e);return A(t,`${i.padEnd(Xt)} ${c} = ${o} ${e.token} ${a};`,e.uid),c}const n=e.children.map(o=>this._write(t,o)).join(", "),s=this._createVarName(t,e);return A(t,`${i.padEnd(Xt)} ${s} = ${e.token}(${n});`,e.uid),s}_writePrimitveNode(t,e,i=!1){var u;const n=t.getInput(e);if(n)return n.isUsed=!0,n.variableName;const s=e.children.length===1&&((u=e.children[0])==null?void 0:u.type)===e.type;if(e.isImplicit||s)return this._write(t,e.children[0]);const o=this._createVarName(t,e);if(i)return A(t,`${e.type.padEnd(Xt)} ${o};`,e.uid),o;const a=!e.debugInfo.name&&!e.isMutable;if(a&&e.type==="float"&&typeof e.children[0]=="number")return Number.isInteger(e.children[0])?e.children[0].toFixed(1):e.children[0].toString();if(a&&e.type==="int"&&typeof e.children[0]=="number"&&Number.isInteger(e.children[0]))return e.children[0].toString();const c=e.children.map(l=>this._write(t,l)).join(", ");return e.type==="array"?(A(t,`${e.type.padEnd(Xt)} ${o} = [${c}];`,e.uid),o):a?`${e.type}(${c})`:(A(t,`${e.type.padEnd(Xt)} ${o} = ${e.type}(${c});`,e.uid),o)}},zt=class En{constructor(t,e,i){this.variableName=t,this.variableInputType=e,this.node=i,this.type="shader-input",this.isUsed=!1}clone(){return new En(this.variableName,this.variableInputType,x(this.node))}},qt=class zn{constructor(t,e,i){this.outVariableName=t,this.outVariableType=e,this.node=i,this.type="shader-output"}clone(){const t=new zn(this.outVariableName,this.outVariableType,x(this.node));return t.variableName=this.variableName,t}},ki=class Re{static createVertex(t,e,i,n,s,o){const a=[];for(const u in t){const l=t[u],h=i.get(u);h?a.push(new zt(h,"builtin",l)):a.push(new zt("a_"+u,"attribute",l))}for(const u of n){const l=u.uniformHydrated;a.push(new zt(u.uniformName,"uniform",l))}const c=[];for(const u in e){const l=e[u];u==="glPosition"?c.push(new qt("gl_Position","builtin",l)):u==="glPointSize"?c.push(new qt("gl_PointSize","builtin",l)):c.push(new qt("v_"+u,"varying",l))}return new Re(a,c,s,o)}static createFragment(t,e,i,n,s,o){const a=[],c=Array.from(s.rootOutputNodes());for(const l in t){const h=t[l],f=i.get(l);if(f){a.push(new zt(f,"builtin",h));continue}const p=c.find(y=>y.node===h);p&&a.push(new zt(p.outVariableName,p.outVariableType,h))}for(const l of n){const h=l.uniformHydrated;a.push(new zt(l.uniformName,"uniform",h))}const u=[];for(const l in e){const h=e[l],f=i.get(l);if(l==="discard")u.push(new qt(null,"discard",h));else{if(!f)throw new Error(`Member ${l} in shader fragment output shoule be tagged as builtin`);u.push(new qt(f,"builtin",h))}}return new Re(a,u,o)}constructor(t,e,i,n){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const s of t)this._inputShaderTypesByNodeUid.set(s.node.uid,s);this._outputShaderTypes=e,this._transformFeedbackBindings=i,this._transformFeedbackNames=new Set(i.map(s=>"v_"+s.propertyKey)),this._usedInFragmentShader=n}shouldPruneOutputNode(t){return!!this._usedInFragmentShader&&t.outVariableType!=="builtin"&&!this._transformFeedbackNames.has(t.outVariableName)&&!this._usedInFragmentShader.has(t.node.uid)}setEmit(t,e){this._nodeEmitMap.set(t.uid,e)}getEmit(t){return this._nodeEmitMap.get(t.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(t){return this._inputShaderTypesByNodeUid.get(t.uid)}*rootOutputNodes(){for(const t of this._outputShaderTypes)yield t}*nodes(){const t=[];for(const e of this._outputShaderTypes.values())t.push(e.node);for(;t.length;){const e=t.pop();typeof e!="number"&&typeof e!="boolean"&&t.push(...e.children.filter(Boolean)),yield e}}*nodesOfTypeOrFunction(){for(const t of this.nodes())typeof t!="number"&&typeof t!="boolean"&&(yield t)}createSubgraphContext(){const t=this.clone();return t.body="",t.indent=this.indent+2,t._nodeEmitMap=new Map(this._nodeEmitMap),t}clone(){const t=new Re([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(t){t.vertex.code.add(""),this._insertInputs(t,"vertex"),t.vertex.code.add(""),t.vertex.code.add("// OUTPUTS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this.rootOutputNodes()){const i=e.outVariableType==="builtin";this.shouldPruneOutputNode(e)||(i?t.vertex.code.add(`// ${e.outVariableType.padEnd(7)} ${e.node.type.padEnd(9)} ${e.outVariableName};`):t.vertex.code.add(`${e.outVariableType.padEnd(10)} ${e.node.type.padEnd(9)} ${e.outVariableName};`))}t.vertex.code.add(""),t.vertex.code.add("void main() {"),t.vertex.code.add("  "+this.body.split(`
`).join(`
  `));for(const e of this.rootOutputNodes())this.shouldPruneOutputNode(e)||t.vertex.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.vertex.code.add("}")}insertFragmentShader(t){this._insertInputs(t,"fragment"),t.fragment.code.add(""),t.fragment.code.add("void main() {"),t.fragment.code.add("  "+this.body.split(`
`).join(`
  `));for(const e of this.rootOutputNodes())e.outVariableType==="discard"?(t.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),t.fragment.code.add(`  if (${e.variableName}) {`),t.fragment.code.add("    discard;"),t.fragment.code.add("  }"),t.fragment.code.add("  ")):t.fragment.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.fragment.code.add("}")}_insertInputs(t,e){t[e].code.add("// INPUTS: "),t[e].code.add("// --------------------------------------------------------- ");for(const i of this.inputs())i.isUsed&&i.variableInputType!=="builtin"&&(i.node.type==="array"?t[e].code.add(`${i.variableInputType.padEnd(10)} ${i.node.elementType.type.padEnd(9)} ${i.variableName}[${i.node.size}];`):t[e].code.add(`${i.variableInputType.padEnd(10)} ${i.node.type.padEnd(9)} ${i.variableName};`))}};const sa=()=>je.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram");function Kt(r,t,e){const i=t.length;if(i!==e){const n=new Wr("Invalid Uniform",`Invalid length, expected ${e} but got ${i}`,{uniformName:r,values:t});sa().errorOnce(n)}}let Mi=class{constructor(t,e,i,n,s,o){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=t,this.fragmentShader=e,this._locations=i,this._locationInfo=n,this._uniformBindings=s,this._transformFeedbackBindings=o}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(t){this._uniforms=t}cleanupTemporaryTextures(){for(const t of this._temporaryTextures)t.dispose();this._temporaryTextures=[]}bind(t){const e=this._uniforms;if(!this._program){const n=new Map;for(const[o,a]of this._locations)n.set(o,a);const s=[];for(const o of this._transformFeedbackBindings??[]){const{index:a,propertyKey:c}=o;s[a]=`v_${c}`}this._program=new Ss(t,this.vertexShader,this.fragmentShader,n,new Map,s)}const i=this._program;t.useProgram(i);for(const n of this._uniformBindings){const{shaderModulePath:s,uniformName:o,uniformType:a,uniformArrayLength:c}=n,u=Qn(s,e);if(u==null){if(a==="sampler2D")continue;throw new Error(`Failed to find uniform value for ${s}`)}switch(a==="array"?n.uniformArrayElementType:a){case"sampler2D":{const{unit:l,texture:h}=u;if(i.setUniform1i(o,l),"type"in h)t.bindTexture(h,l);else{const f=ws(t,h.descriptor,h.data);t.bindTexture(f,l)}break}case"int":if(!c){i.setUniform1i(o,u);break}Kt(n.uniformName,u,c),i.setUniform1iv(o,u);break;case"float":if(!c){i.setUniform1f(o,u);break}Kt(n.uniformName,u,c),i.setUniform1fv(o,u);break;case"vec2":if(!c){i.setUniform2f(o,u[0],u[1]);break}Kt(n.uniformName,u,c),i.setUniform2fv(o,u.flat());break;case"vec3":if(!c){i.setUniform3f(o,u[0],u[1],u[2]);break}Kt(n.uniformName,u,c),i.setUniform3fv(o,u.flat());break;case"vec4":if(!c){i.setUniform4f(o,u[0],u[1],u[2],u[3]);break}Kt(n.uniformName,u,c),i.setUniform4fv(o,u.flat());break;case"mat3":i.setUniformMatrix3fv(o,u.flat());break;case"mat4":i.setUniformMatrix4fv(o,u.flat());break;default:throw new Error(`Unable to set uniform for type ${a}`)}}}};function jt(r){return new r}function Ht(r,t,e){const i=r.constructor[t]??[];r.constructor.hasOwnProperty(t)||Object.defineProperty(r.constructor,t,{value:i.slice()}),r.constructor[t].push(e)}function P(r,t){return(e,i)=>{Ht(e,"locations",{typeCtor:t,propertyKey:i,parameterIndex:null,index:r})}}const oa=r=>(t,e)=>{Ht(t,"builtins",{builtin:r,propertyKey:e})},C=r=>(t,e,i)=>{Ht(t,"inputs",{inputCtor:r,propertyKey:e,parameterIndex:i})},_=r=>(t,e)=>{Ht(t,"uniforms",{typeCtor:r,propertyKey:e})},W=r=>(t,e)=>{Ht(t,"options",{typeCtor:r,propertyKey:e})},Ni=(r,t)=>{Ht(r,"defines",{propertyKey:t})},Br=(r,t)=>(e,i)=>{e.constructor.builtins.push({builtin:r,propertyKey:i,typeCtor:t})};let Or=class{};Or.builtins=[],d([Br("gl_VertexID",xt)],Or.prototype,"glVertexID",void 0);let aa=class{},ie=class{};ie.builtins=[],d([Br("gl_FragCoord",M)],ie.prototype,"glFragCoord",void 0),d([Br("gl_PointCoord",T)],ie.prototype,"glPointCoord",void 0);let Dn=class{};d([oa("gl_FragColor")],Dn.prototype,"glFragColor",void 0);let Q=class{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}},ca=class{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const t=sr(this._shaderModuleClass.inputs,e=>e.propertyKey==="vertex"&&e.parameterIndex===0);if(!t)throw new Error("Unable to find vertex input parameter");return t}get computeInput(){return sr(this._shaderModuleClass.inputs,t=>t.propertyKey==="vertex"&&t.parameterIndex===1)}get fragmentInput(){const t=sr(this._shaderModuleClass.inputs,e=>e.propertyKey==="fragment");if(!t)throw new Error("Unable to find fragment input parameter");return t}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){var t;return[...this.vertexInput.inputCtor.locations,...((t=this.computeInput)==null?void 0:t.inputCtor.locations)??[]]}get locationsMap(){const t=new Map,e=new Set;for(const i of this.locations)e.has(i.index)?je.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${i.propertyKey} to ${i.index}. Index already in use`,{locationsMap:t}):(t.set(i.propertyKey,i.index),e.add(i.index));return t}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map(([n,s])=>`${n}.${s}`).join("."),i=Jn(e);this._locationInfo={hash:i,locations:t}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const e of this.locations)t.set("a_"+e.propertyKey,e.index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set;for(const e of this._options)t.add(e.propertyKey);this._optionPropertyKeys=t}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(t,e,i,n){try{const{vertex:s,fragment:o,uniformBindings:a}=this._generateShaders(t,e,i,n);return new Mi(s,o,this.renamedLocationsMap,this.locationInfo,a,this.transformFeedbackBindings)}catch(s){return console.error("Failed to create program",{error:s}),new Mi("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(t){const e=this._options.find(n=>n.propertyKey===t);if(e)return{type:"option",className:e.typeCtor};const i=this._uniforms.find(n=>n.propertyKey===t);if(!i)throw new Error(`Unable to find uniform class type for property: ${t}`);return{type:"required",className:i.typeCtor}}getShaderKey(t,e,i,n){const s=Object.keys(i).map(c=>`${c}.${i[c]}`).join("."),o=Object.keys(n).map(c=>`${c}.${n[c]}`).join("."),a=Object.keys(e).filter(c=>this.optionPropertyKeys.has(c)&&e[c]).join(".");return`${this.constructor.name}.${t.hash}.${s}.${o}.${a}`}_generateShaders(t,e,i,n){const s=[];this._setDefines(i),this._setOptionalUniforms(s,e),this._setRequiredUniforms(s);const o=this._hydrateVertexInput(n),a=this._injectPackPrecisionFactor(o,t),c=this._hydrateComputeInput(),u=c&&this._injectPackPrecisionFactor(c,t),l=this.vertex(a,u),h=this._hydrateFragmentInput(l),f=this.fragment(h),p=new Set;for(const N in f){const I=f[N];Oo(p,I)}const y=this._getVertexInputBuiltins(),b=ki.createVertex({...o,...c},l,y,s,this.transformFeedbackBindings,p);new Ii().write(b);const v=this._getFragmentInputBuiltins(f);v.set("glPointCoord","gl_PointCoord");const w=ki.createFragment(h,f,v,s,b,this.transformFeedbackBindings);new Ii().write(w);const $=this._createShaderBuilder(b,w),k=$.generate("vertex",!1),E=$.generate("fragment",!1);return this.logShader&&(console.log(k),console.log(E)),{vertex:k,fragment:E,uniformBindings:s}}_setDefines(t){for(const e in t)this[e]=t[e]}_setOptionalUniforms(t,e){for(const i of this._options)e[i.propertyKey]?this[i.propertyKey]=this._hydrateUniformGroup(t,i):this[i.propertyKey]=null}_setRequiredUniforms(t){for(const e of this._uniforms)this[e.propertyKey]=this._hydrateUniformGroup(t,e)}_hydrateUniformGroup(t,e){const i=new e.typeCtor;for(const n of i._uniforms??[]){const s=jt(n.typeCtor),o=`u_${e.propertyKey}_${n.propertyKey}`,a=s.type,c=[e.propertyKey,n.propertyKey].join(".");if("type"in n.typeCtor&&n.typeCtor.type==="array"){const u=s;t.push({shaderModulePath:c,uniformName:o,uniformType:a,uniformArrayLength:u.size,uniformArrayElementType:u.elementType.type,uniformHydrated:s})}else t.push({shaderModulePath:c,uniformName:o,uniformType:a,uniformHydrated:s});i[n.propertyKey]=s}return i}_hydrateVertexInput(t){const e=this.vertexInput.inputCtor,i=e.locations.reduce((n,s)=>t[s.propertyKey]===!1?n:{...n,[s.propertyKey]:jt(s.typeCtor)},{});for(const{propertyKey:n,typeCtor:s}of e.builtins){const o=jt(s);i[n]=o}return i}_hydrateComputeInput(){return this.computeInput==null?null:this.computeInput.inputCtor.locations.reduce((t,e)=>({...t,[e.propertyKey]:jt(e.typeCtor)}),{})}_injectPackPrecisionFactor(t,e){const i={};for(const n in t){const s=t[n],o=e.attributes.find(a=>a.name===n);if(o!=null&&o.packPrecisionFactor){if(s.type!=="float"&&s.type!=="vec2"&&s.type!=="vec3"&&s.type!=="vec4")throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${s.type}`);i[n]=s.divide(new m(o.packPrecisionFactor))}else i[n]=s}return i}_hydrateFragmentInput(t){const e={};for(const i in t)e[i]=t[i];for(const{propertyKey:i,typeCtor:n}of ie.builtins){const s=jt(n);e[i]=s}return e}_getVertexInputBuiltins(){const t=this.vertexInput.inputCtor,e=new Map;for(const{builtin:i,propertyKey:n}of t.builtins)e.set(n,i);return e}_getFragmentInputBuiltins(t){const e=t.constructor,i=new Map;for(const n of e.builtins??[])i.set(n.propertyKey,n.builtin);return i}_createShaderBuilder(t,e){const i=new Mo;return this._insertDebugInfo(i),t.insertVertexShader(i),e.insertFragmentShader(i),i}_insertDebugInfo(t){t.vertex.code.add("// DEFINES: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._defines)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`);t.vertex.code.add(""),t.vertex.code.add("// OPTIONS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._options)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`)}};function Ei(r){const t=D(12.9898),e=D(78.233),i=D(43758.5453),n=oi(r,Dr(t,e)),s=Yt(n,D(3.14));return Mn(ai(s).multiply(i))}function It(r){return ri(r,D(vo))}function ua(r,t){return r.x.multiply(t.y).subtract(t.x.multiply(r.y))}function la(r){return r.multiply(2).subtract(1)}function it(r,t){const e=D(2**t);return Yt(ra(r.divide(e)),D(2))}function _u(r,t){return q(it(r,t),D(.5))}function hr(r,t){return it(r,t+Ui.length)}function ha(r,t){return it(r,t)}function da(r){const t=it(r.z,7),e=D(1).subtract(t),i=r.xyz.subtract(Zo(0,0,D(128)));return e.multiply(r).add(t.multiply(i))}function pa(r){const t=Xo(.99609375,.0038909912109375,1519918441772461e-20,59371814131736755e-24);return oi(r,t)}function wu(r){return Vt(Vt(Vt(r.x,r.y),r.z),r.w)}let ot=class extends Q{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=ut(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=da(t),i=this.size,n=Et(e.x),s=Et(e.y).multiply(Et(256)),o=Et(e.z).multiply(Et(256)).multiply(Et(256)),a=D(n.add(s).add(o)),c=Yt(a,i),u=a.subtract(c).divide(i);this._uv=new T(c,u).add(.5).divide(i)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return ut(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return ut(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return ut(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return ut(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return ut(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return ut(this.gpgpu,e).setDebugName("storage4")}getFilterFlags(t){return Ur("webgl-ignores-sampler-precision")?ea(this.getFilterData(t).x.multiply(D(255))):this.getFilterData(t).x.multiply(D(255))}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}};d([_(ct)],ot.prototype,"filterFlags",void 0),d([_(ct)],ot.prototype,"animation",void 0),d([_(ct)],ot.prototype,"gpgpu",void 0),d([_(ct)],ot.prototype,"visualVariableData",void 0),d([_(ct)],ot.prototype,"dataDriven0",void 0),d([_(ct)],ot.prototype,"dataDriven1",void 0),d([_(ct)],ot.prototype,"dataDriven2",void 0),d([_(m)],ot.prototype,"size",void 0);let Vr=class extends Q{};d([_(m)],Vr.prototype,"activeReasons",void 0),d([_(m)],Vr.prototype,"highlightAll",void 0);let ee=class extends Q{};d([_(T)],ee.prototype,"position",void 0),d([_(m)],ee.prototype,"distance",void 0),d([_(m)],ee.prototype,"smallSymbolDistance",void 0),d([_(m)],ee.prototype,"smallSymbolSizeThreshold",void 0);let Y=class extends Q{};d([_(H)],Y.prototype,"displayViewScreenMat3",void 0),d([_(H)],Y.prototype,"displayViewMat3",void 0),d([_(H)],Y.prototype,"displayMat3",void 0),d([_(H)],Y.prototype,"viewMat3",void 0),d([_(H)],Y.prototype,"tileMat3",void 0),d([_(m)],Y.prototype,"displayZoomFactor",void 0),d([_(m)],Y.prototype,"requiredZoomFactor",void 0),d([_(T)],Y.prototype,"tileOffset",void 0),d([_(m)],Y.prototype,"currentScale",void 0),d([_(m)],Y.prototype,"currentZoom",void 0),d([_(m)],Y.prototype,"metersPerSRUnit",void 0),d([_(m)],Y.prototype,"rotation",void 0),d([_(m)],Y.prototype,"pixelRatio",void 0);let Tt=class extends Or{};d([P(0,V)],Tt.prototype,"id",void 0),d([P(1,m)],Tt.prototype,"bitset",void 0),d([P(2,T)],Tt.prototype,"pos",void 0);let pt=class extends aa{};d([P(14,T)],pt.prototype,"nextPos1",void 0),d([P(15,T)],pt.prototype,"nextPos2",void 0);let ir=class extends ie{},ht=class extends ca{clip(t,e){let i=new m(0);const n=this.storage.getFilterFlags(t);if(i=i.add(D(2).multiply(D(1).subtract(hr(n,0)))),this.inside?i=i.add(D(2).multiply(D(1).subtract(hr(n,1)))):this.outside?i=i.add(D(2).multiply(hr(n,1))):this.highlight&&(i=i.add(D(2).multiply(D(1).subtract(this._checkHighlight(n))))),e!=null){const s=new m(1).subtract(gt(e.x,this.view.currentZoom)),o=gt(e.y,this.view.currentZoom);i=i.add(new m(2).multiply(s.add(o)))}return i}getFragmentOutput(t,e,i=new m(1/255)){const n=new Dn;return n.glFragColor=this._maybeWriteHittest(e)??this._maybeHighlight(t,i)??t,n}_maybeHighlight(t,e){return this.highlight?new M(t.rgb,gt(e,t.a)):null}_checkHighlight(t){let e=this._checkHighlightBit(t,0);for(let i=1;i<Ui.length;i++)e=e.add(this._checkHighlightBit(t,i));return gt(new m(.1),e.add(this.highlight.highlightAll))}_checkHighlightBit(t,e){return ha(t,e).multiply(it(this.highlight.activeReasons,e))}maybeRunHittest(t,e,i){if(this.hittestRequest==null)return null;const n=this.hittest(t,e,i);let s=R(q(n,this.hittestRequest.distance),new m(2),new m(0));const o=this.storage.getAttributeDataCoords(t.id),a=la(o);s=s.add(this.clip(t.id,t.zoomRange));const c=new M(new m(1/255),0,0,0);return{glPointSize:new m(1),glPosition:new M(a,s,1),color:c}}_maybeWriteHittest(t){return this.hittestRequest!=null?t.color:null}};d([Ni],ht.prototype,"inside",void 0),d([Ni],ht.prototype,"outside",void 0),d([W(Vr)],ht.prototype,"highlight",void 0),d([_(ot)],ht.prototype,"storage",void 0),d([_(Y)],ht.prototype,"view",void 0),d([W(ee)],ht.prototype,"hittestRequest",void 0);function fa(r,t){return oi(r,ia(t))}function ne(r,t,e){const i=e.subtract(t),n=fa(r.subtract(t),i),s=si(n.divide(Nn(i)),new m(0),new m(1));return kn(r,t.add(s.multiply(e.subtract(t))))}function ma(r){const t=ta(r);return gt(t.x.add(t.y).add(t.z),new m(1.05))}function ya(r,t,e,i){const n=new H(e.x.multiply(i.y).subtract(i.x.multiply(e.y)),i.x.multiply(t.y).subtract(t.x.multiply(i.y)),t.x.multiply(e.y).subtract(e.x.multiply(t.y)),e.y.subtract(i.y),i.y.subtract(t.y),t.y.subtract(e.y),i.x.subtract(e.x),t.x.subtract(i.x),e.x.subtract(t.x)),s=t.x.multiply(e.y.subtract(i.y)),o=e.x.multiply(i.y.subtract(t.y)),a=i.x.multiply(t.y.subtract(e.y)),c=s.add(o).add(a);return new m(1).divide(c).multiply(n.multiply(new V(1,r)))}function ga(r,t,e,i){return ri(ma(ya(r,t,e,i)),new m(1))}function xa(r,t,e,i){const n=e.subtract(t),s=i.subtract(t),o=ua(n,s),a=Fr(jo(o,new m($i)),q(o,new m(-$i)));return pe([Fr(na(a),ga(r.xy,t,e,i)),new m(-1)],[!0,()=>{const c=ne(r,t,e),u=ne(r,e,i),l=ne(r,i,t);return Cr(Cr(c,u),l)}])}function Fn(r){return r.distance.add(1)}function ci(r,t,e){const{viewMat3:i,tileMat3:n}=r.view,s=i.multiply(n),o=s.multiply(new V(t.pos,1)),a=s.multiply(new V(e.nextPos1,1)),c=s.multiply(new V(e.nextPos2,1));return xa(r.hittestRequest.position,o.xy,a.xy,c.xy)}function Eu(r,t,e){return kn(r,e).subtract(t)}let ue=class extends Q{getColor(t,e,i){return pe([Tn(It(t),i),e],[er(t,this.values.first()),this.colors.first()],[rr(t,this.values.last()),this.colors.last()],[!0,()=>{const n=this.values.findIndex(u=>q(u,t)),s=this.values.get(n),o=n.subtract(1),a=this.values.get(o),c=t.subtract(a).divide(s.subtract(a));return Nt(this.colors.get(o),this.colors.get(n),c)}])}};d([_(rt.ofType(M,8))],ue.prototype,"colors",void 0),d([_(rt.ofType(m,8))],ue.prototype,"values",void 0);let le=class extends Q{getOpacity(t){return pe([It(t),new m(1)],[er(t,this.opacityValues.first()),this.opacities.first()],[rr(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex(a=>q(a,t)),i=this.opacityValues.get(e),n=e.subtract(1),s=this.opacityValues.get(n),o=t.subtract(s).divide(i.subtract(s));return Nt(this.opacities.get(n),this.opacities.get(e),o)}])}};d([_(rt.ofType(m,8))],le.prototype,"opacities",void 0),d([_(rt.ofType(m,8))],le.prototype,"opacityValues",void 0);function Cn(r){return r.visualVariableSizeMinMaxValue!=null||r.visualVariableSizeScaleStops!=null||r.visualVariableSizeStops!=null||r.visualVariableSizeUnitValue!=null}function ba(r,t,e){var i,n,s,o;if(Cn(r)){const a=r.storage.getSizeValue(t);return((i=r.visualVariableSizeMinMaxValue)==null?void 0:i.getSize(a,e))??((n=r.visualVariableSizeScaleStops)==null?void 0:n.getSizeForViewScale(r.view.currentScale))??((s=r.visualVariableSizeStops)==null?void 0:s.getSize(a,e))??((o=r.visualVariableSizeUnitValue)==null?void 0:o.getSize(a,e))}return e}function ui(r,t,e,i=new Z(!1)){if(r.visualVariableColor==null)return e;const n=r.storage.getColorValue(t);return r.visualVariableColor.getColor(n,e,i)}function li(r,t){if(r.visualVariableOpacity==null)return new m(1);const e=r.storage.getOpacityValue(t);return r.visualVariableOpacity.getOpacity(e)}function Fu(r,t){if(r.visualVariableRotation==null)return H.identity();const e=r.storage.getRotationValue(t);return r.visualVariableRotation.getVVRotationMat3(e)}let he=class extends Tt{};d([P(3,M)],he.prototype,"color",void 0),d([P(4,T)],he.prototype,"zoomRange",void 0);let Ot=class extends ht{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const i=li(this,t.id),n=ui(this,t.id,t.color).multiply(i),s=this.view.displayViewScreenMat3.multiply(new V(t.pos.xy,1)),o=this.clip(t.id,t.zoomRange);return{glPosition:new M(s.xy,o,1),color:n,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new m(0))}hittest(t,e){return ci(this,t,e)}};d([W(ue)],Ot.prototype,"visualVariableColor",void 0),d([W(le)],Ot.prototype,"visualVariableOpacity",void 0),d([F(0,C(he)),F(1,C(pt))],Ot.prototype,"vertex",null),d([F(0,C(ir))],Ot.prototype,"fragment",null);let Lt=class extends Q{getPatternOffsetAtTileOrigin(t,e=new m(0),i=new m(1)){const n=new T(Po).divide(t);let s=t.multiply(Mn(this.maxIntsToLocalOrigin.multiply(n))).add(this.tileOffsetFromLocalOrigin).subtract(new m(.5).multiply(t));return s=new T(s.x.multiply(i).subtract(s.y.multiply(e)),s.x.multiply(e).add(s.y.multiply(i))),Yt(s,t)}};d([_(T)],Lt.prototype,"tileOffsetFromLocalOrigin",void 0),d([_(T)],Lt.prototype,"maxIntsToLocalOrigin",void 0);let At=class extends Q{};d([_(T)],At.prototype,"size",void 0),d([_(ct)],At.prototype,"texture",void 0);let wt=class extends he{};d([P(5,M)],wt.prototype,"tlbr",void 0),d([P(6,m)],wt.prototype,"width",void 0),d([P(7,m)],wt.prototype,"height",void 0),d([P(8,T)],wt.prototype,"offset",void 0),d([P(9,T)],wt.prototype,"scale",void 0),d([P(10,m)],wt.prototype,"angle",void 0);class va extends ir{}function _a(r,t,e,i,n){const s=ri(it(n,on),D(1)),o=pa(new M(r,0));return R(s,Ti(i.divide(t.x),e.divide(t.y),0,We(e.divide(t.x)),i.divide(t.y),0,Ei(Dr(o,0)),Ei(Dr(0,o)),1),Ti(i.divide(t.x),e.divide(t.y),0,We(e.divide(t.x)),i.divide(t.y),0,0,0,1))}function Bn(r,t){const e=Nt(new T(1),new T(1/Yr),new T(it(t.bitset,cn),it(t.bitset,an))),i=r.view.requiredZoomFactor,n=new T(t.width,t.height).multiply(e),s=n.multiply(t.scale).multiply(i),o=t.angle.multiply(yo),a=ai(o),c=In(o),u=_a(t.id,s,a,c,t.bitset),l=r.localTileOffset.getPatternOffsetAtTileOrigin(n,a,c),h=i.multiply(t.scale).multiply(t.offset.subtract(l)).divide(s),f=new V(t.pos,1),p=u.multiply(f).xy.subtract(h),y=t.tlbr.divide(r.mosaicInfo.size.xyxy);let b=it(t.bitset,Xr);return r.visualVariableColor!=null&&(b=R(It(r.storage.getColorValue(t.id)),new m(0),b)),{tileTextureCoord:p,tlbr:y,sampleAlphaOnly:b}}function On(r,t){const e=Yt(t.tileTextureCoord,new m(1)),i=Nt(t.tlbr.xy,t.tlbr.zw,e);let n=ut(r.mosaicInfo.texture,i);return n=R(q(t.sampleAlphaOnly,new m(.5)),n.aaaa,n),t.color.multiply(n)}let _e=class extends Ot{vertex(t,e){return{...super.vertex(t,e),...Bn(this,t)}}fragment(t){const e=On(this,t);return this.getFragmentOutput(e,t,new m(0))}};d([_(At)],_e.prototype,"mosaicInfo",void 0),d([_(Lt)],_e.prototype,"localTileOffset",void 0),d([F(0,C(wt)),F(1,C(pt))],_e.prototype,"vertex",null),d([F(0,C(va))],_e.prototype,"fragment",null);let hi=class extends Q{getSize(t,e){const i=this.minMaxValueAndSize.xy,n=this.minMaxValueAndSize.zw;return R(It(t),e,()=>{const s=t.subtract(i.x).divide(i.y.subtract(i.x)),o=si(s,new m(0),new m(1));return n.x.add(o.multiply(n.y.subtract(n.x)))})}};d([_(M)],hi.prototype,"minMaxValueAndSize",void 0);let Ye=class extends Q{getSizeForViewScale(t){return pe([er(t,this.values.first()),this.sizes.first()],[rr(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex(a=>q(a,t)),i=this.values.get(e),n=e.subtract(1),s=this.values.get(n),o=t.subtract(s).divide(i.subtract(s));return Nt(this.sizes.get(n),this.sizes.get(e),o)}])}};d([_(rt.ofType(m,8))],Ye.prototype,"sizes",void 0),d([_(rt.ofType(m,8))],Ye.prototype,"values",void 0);let He=class extends Q{getSize(t,e){const i=pe([It(t),e],[er(t,this.values.first()),this.sizes.first()],[rr(t,this.values.last()),this.sizes.last()],[!0,()=>{const n=this.values.findIndex(u=>q(u,t)),s=this.values.get(n),o=n.subtract(1),a=this.values.get(o),c=t.subtract(a).divide(s.subtract(a));return Nt(this.sizes.get(o),this.sizes.get(n),c)}]);return R(It(i),e,i)}};d([_(rt.ofType(m,8))],He.prototype,"sizes",void 0),d([_(rt.ofType(m,8))],He.prototype,"values",void 0);let di=class extends Q{getSize(t,e){return R(It(t),e,t.multiply(this.unitValueToPixelsRatio))}};d([_(m)],di.prototype,"unitValueToPixelsRatio",void 0);class $t extends Tt{}d([P(3,M)],$t.prototype,"color",void 0),d([P(4,T)],$t.prototype,"offset",void 0),d([P(5,T)],$t.prototype,"normal",void 0),d([P(6,m)],$t.prototype,"halfWidth",void 0),d([P(7,m)],$t.prototype,"referenceHalfWidth",void 0),d([P(8,T)],$t.prototype,"zoomRange",void 0);let Vn=class extends ir{},Ze=class extends Q{};function Rn(r){return Vt(new m(go).multiply(gt(r,new m(xo))),new m(1))}function wa(r,t){const{halfWidth:e,normal:i}=r,n=Rn(e),s=Nn(i).multiply(e);return si(n.multiply(e.subtract(s)).divide(t.add(n).subtract(new m(1))),new m(0),new m(1))}function $a(r,t){const{id:e,halfWidth:i,referenceHalfWidth:n}=t;if(Cn(r)){const s=new m(2).multiply(n),o=ba(r,e,s);return new m(.5).multiply(i.divide(Vt(n,new m(bo)))).multiply(o)}return i}function Ln(r,t){const{id:e,offset:i,pos:n,normal:s,zoomRange:o}=t,{displayViewScreenMat3:a,displayViewMat3:c}=r.view,u=ui(r,e,t.color),l=li(r,e),h=$a(r,t),f=new m(.5).multiply(r.antialiasingControls.antialiasing),p=Vt(h.add(f),new m(.45)).add(new m(.1).multiply(f)),y=Rn(p).multiply(p).multiply(i),b=c.multiply(new V(y,new m(0))),v=a.multiply(new V(n,new m(1))).add(b),w=new m(2).multiply(gt(h,new m(0))).add(r.clip(e,o)),$=new M(v.xy,w,1);return{color:u,opacity:l,halfWidth:p,normal:s,scaledOffset:y,scaledHalfWidth:h,glPosition:new M($.xy,w,1)}}function nr(r,t){const{opacity:e,color:i}=r,n=wa(r,t);return e.multiply(i).multiply(n)}d([_(m)],Ze.prototype,"antialiasing",void 0),d([_(m)],Ze.prototype,"blur",void 0);let st=class extends ht{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const i=Ln(this,t);return{...i,...this.maybeRunHittest(t,e,i.halfWidth)}}fragment(t){const e=nr(t,this.antialiasingControls.blur);return this.getFragmentOutput(e,t)}hittest(t,e,i){const{viewMat3:n,tileMat3:s}=this.view,o=n.multiply(s),a=o.multiply(new V(t.pos,1)),c=o.multiply(new V(e.nextPos1,1)),u=o.multiply(new V(e.nextPos2,1)),{distance:l,smallSymbolDistance:h,smallSymbolSizeThreshold:f}=this.hittestRequest,p=gt(i,f.multiply(.5)).multiply(l.subtract(h)),y=this.hittestRequest.position;return Cr(ne(y,a.xy,c.xy),ne(y,a.xy,u.xy)).subtract(i).add(p)}};d([_(Ze)],st.prototype,"antialiasingControls",void 0),d([W(ue)],st.prototype,"visualVariableColor",void 0),d([W(le)],st.prototype,"visualVariableOpacity",void 0),d([W(hi)],st.prototype,"visualVariableSizeMinMaxValue",void 0),d([W(Ye)],st.prototype,"visualVariableSizeScaleStops",void 0),d([W(He)],st.prototype,"visualVariableSizeStops",void 0),d([W(di)],st.prototype,"visualVariableSizeUnitValue",void 0),d([F(0,C($t)),F(1,C(pt))],st.prototype,"vertex",null),d([F(0,C(Vn))],st.prototype,"fragment",null);class mt extends Tt{}d([P(3,T)],mt.prototype,"offset",void 0),d([P(4,M)],mt.prototype,"color",void 0),d([P(5,T)],mt.prototype,"normal",void 0),d([P(6,m)],mt.prototype,"halfWidth",void 0),d([P(7,m)],mt.prototype,"referenceHalfWidth",void 0),d([P(8,T)],mt.prototype,"zoomRange",void 0);let An=class extends Vn{};function pi(r,t,e){const{id:i,bitset:n}=t,s=it(n,qr),o=q(s,new m(.5)),a=Ln(r,t),c=R(o,a.halfWidth,new m(0)),u=li(r,i),l=ui(r,i,t.color),h=R(o,t.color,l.multiply(u)),f=r.view.displayViewScreenMat3.multiply(new V(t.pos.xy,1)),p=r.clip(t.id),y=new M(f.xy,p,1),b=R(o,a.glPosition,y),v=e&&r.maybeRunHittest(t,e,o);return{isOutline:s,color:h,opacity:new m(1),halfWidth:c,normal:a.normal,glPosition:b,...v}}let lt=class extends ht{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}};d([_(Ze)],lt.prototype,"antialiasingControls",void 0),d([W(ue)],lt.prototype,"visualVariableColor",void 0),d([W(le)],lt.prototype,"visualVariableOpacity",void 0),d([W(hi)],lt.prototype,"visualVariableSizeMinMaxValue",void 0),d([W(Ye)],lt.prototype,"visualVariableSizeScaleStops",void 0),d([W(He)],lt.prototype,"visualVariableSizeStops",void 0),d([W(di)],lt.prototype,"visualVariableSizeUnitValue",void 0);class Rr extends lt{vertex(t,e){return pi(this,t,e)}fragment(t){const{color:e,isOutline:i}=t,n=q(i,new m(.5)),s=nr(t,this.antialiasingControls.blur),o=R(n,s,e),a=R(n,new m(1/255),new m(0));return this.getFragmentOutput(o,t,a)}hittest(t,e,i){return R(i,Fn(this.hittestRequest),ci(this,t,e))}}d([F(0,C(mt)),F(1,C(pt))],Rr.prototype,"vertex",null),d([F(0,C(An))],Rr.prototype,"fragment",null);let Lr=class extends he{};d([P(5,M)],Lr.prototype,"tlbr",void 0),d([P(6,m)],Lr.prototype,"inverseRasterizationScale",void 0);let Sa=class extends ir{};function Pa(r){const t=new m(1),e=new m(0);return new H(t.divide(r.x),e.divide(r.y),0,We(e.divide(r.x)),t.divide(r.y),0,0,0,1)}function Gn(r,t){const e=t.tlbr.xy,i=t.tlbr.zw,n=i.x.subtract(e.x),s=e.y.subtract(i.y),o=new T(n,s).multiply(t.inverseRasterizationScale),a=o.multiply(r.view.requiredZoomFactor),c=Pa(a),u=r.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(a),l=new V(t.pos,1);return{tileTextureCoord:c.multiply(l).xy.subtract(u),tlbr:t.tlbr.divide(r.mosaicInfo.size.xyxy)}}function Un(r,t){const e=Yt(r.tileTextureCoord,new m(1)),i=Nt(r.tlbr.xy,r.tlbr.zw,e),n=ut(t.texture,i);return r.color.multiply(n)}let we=class extends Ot{vertex(t,e){return{...super.vertex(t,e),...Gn(this,t)}}fragment(t){const e=Un(t,this.mosaicInfo);return this.getFragmentOutput(e,t,new m(0))}};d([_(At)],we.prototype,"mosaicInfo",void 0),d([_(Lt)],we.prototype,"localTileOffset",void 0),d([F(0,C(Lr)),F(1,C(pt))],we.prototype,"vertex",null),d([F(0,C(Sa))],we.prototype,"fragment",null);let Ar=class extends mt{};d([P(9,M)],Ar.prototype,"tlbr",void 0),d([P(10,m)],Ar.prototype,"inverseRasterizationScale",void 0);let Wn=class extends An{},$e=class extends Rr{vertex(t,e){return{...pi(this,t,e),...Gn(this,t)}}fragment(t){const{isOutline:e}=t,i=q(e,new m(.5)),n=nr(t,this.antialiasingControls.blur),s=Un(t,this.mosaicInfo),o=R(i,n,s),a=R(i,new m(1/255),new m(0));return this.getFragmentOutput(o,t,a)}};d([_(At)],$e.prototype,"mosaicInfo",void 0),d([_(Lt)],$e.prototype,"localTileOffset",void 0),d([F(0,C(Ar)),F(1,C(pt))],$e.prototype,"vertex",null),d([F(0,C(Wn))],$e.prototype,"fragment",null);const dt=16,Qt=1/dt,Gr=128;class at extends Tt{}d([P(3,M)],at.prototype,"color",void 0),d([P(4,M)],at.prototype,"tlbr",void 0),d([P(5,m)],at.prototype,"angle",void 0),d([P(6,m)],at.prototype,"aux1",void 0),d([P(7,m)],at.prototype,"aux2",void 0),d([P(8,T)],at.prototype,"aux3",void 0),d([P(9,T)],at.prototype,"aux4",void 0),d([P(10,T)],at.prototype,"zoomRange",void 0);let Ta=class extends Wn{};class Se extends lt{vertex(t,e){const{aux1:i,aux2:n,aux3:s,aux4:o}=t,a={...t,width:i,height:n,offset:s,scale:o.multiply(Qt)},c={...t,halfWidth:i.multiply(Qt),referenceHalfWidth:n.multiply(Qt),offset:s.multiply(Qt),normal:o.subtract(Gr).multiply(Qt)},u=pi(this,c),l=Bn(this,a),h=q(u.isOutline,new m(.5));return{...u,...l,...this.maybeRunHittest(t,e,h)}}fragment(t){const{isOutline:e}=t,i=q(e,new m(.5)),n=nr(t,this.antialiasingControls.blur),s=On(this,t),o=R(i,n,s),a=R(i,new m(1/255),new m(0));return this.getFragmentOutput(o,t,a)}hittest(t,e,i){return R(i,Fn(this.hittestRequest),ci(this,t,e))}}d([_(At)],Se.prototype,"mosaicInfo",void 0),d([_(Lt)],Se.prototype,"localTileOffset",void 0),d([F(0,C(at)),F(1,C(pt))],Se.prototype,"vertex",null),d([F(0,C(Ta))],Se.prototype,"fragment",null);const et=dn.attributes,Ia=Qr.attributes,ka={createComputedParams:r=>r,attributes:{id:et.id,pos:et.pos,zoomRange:et.zoomRange,tlbr:et.tlbr,angle:et.angle,color:et.color,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>un(r)},aux1:{count:1,type:g.UNSIGNED_SHORT,pack:r=>ln(r)},aux2:{count:1,type:g.UNSIGNED_SHORT,pack:r=>hn(r)},aux3:{count:2,type:g.SHORT,pack:({offsetX:r,offsetY:t})=>[S(r),S(t)]},aux4:{count:2,type:g.UNSIGNED_BYTE,pack:({scaleX:r,scaleY:t})=>[r*dt,t*dt]}}},Ma={createComputedParams:r=>r,attributes:{id:et.id,pos:et.pos,zoomRange:et.zoomRange,tlbr:et.tlbr,angle:et.angle,color:Ia.color,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>de([[qr,!0]])},aux1:{count:1,type:g.UNSIGNED_SHORT,pack:r=>S(.5*r.width)*dt},aux2:{count:1,type:g.UNSIGNED_SHORT,pack:r=>S(.5*r.referenceWidth)*dt},aux3:{count:2,type:g.SHORT,packTessellation:({extrusionOffsetX:r,extrusionOffsetY:t})=>[r*dt,t*dt]},aux4:{count:2,type:g.UNSIGNED_BYTE,packTessellation:({normalX:r,normalY:t})=>[r*dt+Gr,t*dt+Gr]}}};let Na=class extends Jr{constructor(){super(...arguments),this.vertexSpec=Ma}};class Ea extends ti{constructor(){super(...arguments),this.vertexSpec=ka}_createOutlineWriter(t,e,i,n){return new Na(t,e,i,n)}_write(t,e,i){var a;const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);if(!s)return;const o=(a=this.evaluatedMeshParams.sprite)==null?void 0:a.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,o),this._writeGeometry(t,e,s),this._lineMeshWriter.writeLineVertices(t,ft.fromOptimizedCIM(s,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const za={createComputedParams:r=>r,attributes:{...Je.attributes,...pn.attributes}},Da={createComputedParams:r=>r,attributes:{...Je.attributes,...Qr.attributes}};let Fa=class extends Jr{constructor(){super(...arguments),this.vertexSpec=Da}},Ca=class extends ti{constructor(){super(...arguments),this.vertexSpec=za}_createOutlineWriter(t,e,i,n){return new Fa(t,e,i,n)}_write(t,e,i){var a;const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);if(!s)return;const o=(a=this.evaluatedMeshParams.sprite)==null?void 0:a.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,o),this._writeGeometry(t,e,s),this._lineMeshWriter.writeLineVertices(t,ft.fromOptimizedCIM(s,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}};const Ba={createComputedParams:r=>r,attributes:{pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1},offset:{type:g.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}};let Oa=class extends Gt{constructor(){super(...arguments),this.vertexSpec=Ba}_write(t,e){t.recordStart(this.instanceId,this.attributeLayout);const i=e.getDisplayId();if(e.geometryType==="esriGeometryPoint"){const n=e.readXForDisplay(),s=e.readYForDisplay();this._writeQuad(t,i,n,s)}else if(e.geometryType==="esriGeometryMultipoint"){const n=e.readGeometryForDisplay();n==null||n.forEachVertex((s,o)=>{s>=0&&s<=512&&o>=0&&o<=512&&this._writeQuad(t,i,s,o)})}t.recordEnd()}_writeQuad(t,e,i,n){const s=t.vertexCount();this._writeVertex(t,e,i,n),t.indexWrite(s+0),t.indexWrite(s+1),t.indexWrite(s+2),t.indexWrite(s+1),t.indexWrite(s+3),t.indexWrite(s+2)}};const Va=8388607,Ra=8388608,Pe=r=>r&Va;function al(r,t){return((t?Ra:0)|r)>>>0}function zi(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r}function Yn(r,t){return Math.sqrt(r*r+t*t)}function Di(r){const t=Yn(r[0],r[1]);r[0]/=t,r[1]/=t}function La(r,t){return Yn(r[0]-t[0],r[1]-t[1])}function Aa(r,t){return r[t+1]}function Hn(r){return r.length-1}function Ga(r){let t=0;for(let e=0;e<Hn(r);e++)t+=Ua(r,e);return t}function Ua(r,t,e=1){let[i,n]=Aa(r,t);return[i,n]=[Math.round(i),Math.round(n)],Math.sqrt(i*i+n*n)*e}class Xe{constructor(t,e,i,n,s){this._segments=t,this._index=e,this._distance=i,this._xStart=n,this._yStart=s,this._done=!1}static create(t){return new Xe(t,0,0,t[0][0],t[0][1])}clone(){return new Xe(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Hn(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let n=this.backwardLength;for(;this.prev();){if(n+this.length>t)return this._seekBackwards(t-n);n+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}}function Wa(r,t,e,i=!0){const n=Ga(r),s=Xe.create(r),o=n/2;if(!i)return s.seek(o),void(Math.abs(s.x)<yt&&Math.abs(s.y)<yt&&e(s.clone(),0,o+0*t,n));const a=Math.max((n-t)/2,0),c=Math.floor(a/t),u=o-c*t;s.seek(u);for(let l=-c;l<=c;l++)Math.abs(s.x)<yt&&Math.abs(s.y)<yt&&e(s.clone(),l,o+l*t,n),s.seek(t)}function Ya(r,t){const e=t;for(let i=0;i<r.length;i++){let n=r[i];Ha(n,e);const s=[];s.push(n[0]);for(let o=1;o<n.length;o++){const[a,c]=n[o-1],[u,l]=n[o],h=u-a,f=l-c;s.push([h,f])}r[i]=s,n=s}return r}function Ha(r,t){if(t<=0)return;const i=r.length;if(i<3)return;const n=[];let s=0;n.push(0);for(let h=1;h<i;h++)s+=La(r[h],r[h-1]),n.push(s);t=Math.min(t,.2*s);const o=[];o.push(r[0][0]),o.push(r[0][1]);const a=r[i-1][0],c=r[i-1][1],u=zi([0,0],r[0],r[1]);Di(u),r[0][0]+=t*u[0],r[0][1]+=t*u[1],zi(u,r[i-1],r[i-2]),Di(u),r[i-1][0]+=t*u[0],r[i-1][1]+=t*u[1];for(let h=1;h<i;h++)n[h]+=t;n[i-1]+=t;const l=.5*t;for(let h=1;h<i-1;h++){let f=0,p=0,y=0;for(let b=h-1;b>=0&&!(n[b+1]<n[h]-l);b--){const v=l+n[b+1]-n[h],w=n[b+1]-n[b],$=n[h]-n[b]<l?1:v/w;if(Math.abs($)<1e-6)break;const k=$*$,E=$*v-.5*k*w,N=$*w/t,I=r[b+1],U=r[b][0]-I[0],nt=r[b][1]-I[1];f+=N/E*(I[0]*$*v+.5*k*(v*U-w*I[0])-k*$*w*U/3),p+=N/E*(I[1]*$*v+.5*k*(v*nt-w*I[1])-k*$*w*nt/3),y+=N}for(let b=h+1;b<i&&!(n[b-1]>n[h]+l);b++){const v=l-n[b-1]+n[h],w=n[b]-n[b-1],$=n[b]-n[h]<l?1:v/w;if(Math.abs($)<1e-6)break;const k=$*$,E=$*v-.5*k*w,N=$*w/t,I=r[b-1],U=r[b][0]-I[0],nt=r[b][1]-I[1];f+=N/E*(I[0]*$*v+.5*k*(v*U-w*I[0])-k*$*w*U/3),p+=N/E*(I[1]*$*v+.5*k*(v*nt-w*I[1])-k*$*w*nt/3),y+=N}o.push(f/y),o.push(p/y)}o.push(a),o.push(c);for(let h=0,f=0;h<i;h++)r[h][0]=o[f++],r[h][1]=o[f++]}class Zn{static getPlacement(t,e,i,n,s,o){const a=ps(i);return a?(e===-1&&t.invertY(),a.execute(t,i,n,s,o)):null}}const Fi=96;let Za=class{constructor(t){const{offsetX:e,offsetY:i,postAngle:n,fontSize:s,scaleFactor:o,transforms:a}=t;if(this.offsetX=e,this.offsetY=i,this.postAngle=n,this.fontSize=Math.min(s,Fi),this.transforms=a,a&&a.infos.length>1){const c=Vi(s,n,!1,e,i,a);this.fontSize=Math.min(c.size,Fi),this.postAngle=c.rotation,this.offsetX=c.offsetX,this.offsetY=c.offsetY}o&&(this.fontSize*=o,this.offsetX*=o,this.offsetY*=o)}};const Le=28,bt=[4,4],Te=[16,4],Xa={topLeft:Te,topRight:Te,bottomLeft:Te,bottomRight:Te},qe=[4,2],tt=[4,6],Ci={topLeft:qe,topRight:qe,bottomLeft:tt,bottomRight:tt},Bi={topLeft:qe,topRight:tt,bottomLeft:qe,bottomRight:tt},qa={topLeft:tt,topRight:tt,bottomLeft:bt,bottomRight:bt},Ka={topLeft:bt,topRight:bt,bottomLeft:tt,bottomRight:tt},ja={topLeft:tt,topRight:bt,bottomLeft:tt,bottomRight:bt},Qa={topLeft:bt,topRight:tt,bottomLeft:bt,bottomRight:tt},Ja={createComputedParams:r=>r,attributes:{pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1,packTessellation:({isBackground:r,mapAligned:t})=>de([[$o,r],[So,!!t]])},zoomRange:{type:g.UNSIGNED_SHORT,count:2,packPrecisionFactor:Qe,packTessellation:({minZoom:r,maxZoom:t})=>[r||0,t||Le]},offset:{type:g.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:({offsets:r})=>{const{bottomLeft:t,bottomRight:e,topLeft:i,topRight:n}=r;return[i,n,t,e]}}},textureUV:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:({texcoords:r})=>{const{bottomLeft:t,bottomRight:e,topLeft:i,topRight:n}=r;return[i,n,t,e]}}},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:({color:r})=>r},fontSize:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:({fontSize:r})=>S(r)},referenceSize:{type:g.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:({fontSize:r},{referenceSize:t})=>S(t??r)},haloColor:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({haloColor:r})=>L(r)},haloFontSize:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,pack:({haloFontSize:r})=>S(r)},clipAngle:{type:g.UNSIGNED_BYTE,count:1,packTessellation:({clipAngle:r})=>tc(r||0)},referenceSymbol:{type:g.BYTE,count:4,packPrecisionFactor:1,packTessellation:(r,t)=>{if(!r.referenceBounds)return[0,0,0,0];const e=fs(t.horizontalAlignment),i=ms(t.verticalAlignment),{offsetX:n,offsetY:s,size:o}=r.referenceBounds;return[S(n),-S(s),S(o),e+1<<2|i+1]}}}};let Xn=class extends Gt{constructor(){super(...arguments),this.vertexSpec=Ja,this._textMeshParamsPropsInitialized=!1}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new Za(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(t,e,i){const n=this._getShaping();if(!n)return;const s=e.getDisplayId();if(this.evaluatedMeshParams.placement!=null)return this._writePlacedTextMarkers(t,e,n,i);if(i&&i.nextPath())return i.nextPoint(),this._writeGlyphs(t,s,i.x,i.y,n,0);if(e.geometryType==="esriGeometryPolygon"){const c=e.readCentroidForDisplay();if(!c)return;const[u,l]=c.coords;return this._writeGlyphs(t,s,u,l,n,0)}if(e.geometryType==="esriGeometryMultipoint"){const c=e.readGeometryForDisplay();return void(c==null?void 0:c.forEachVertex((u,l)=>this._writeGlyphs(t,s,u,l,n,0)))}const o=e.readXForDisplay(),a=e.readYForDisplay();return this._writeGlyphs(t,s,o,a,n,0)}_writePlacedTextMarkers(t,e,i,n){const s=n??ft.fromFeatureSetReaderCIM(e);if(!s)return;const o=-1,a=Zn.getPlacement(s,o,this.evaluatedMeshParams.placement,S(1),t.id,Hr());if(!a)return;const c=e.getDisplayId();let u=a.next();for(;u!=null;){const l=u.tx,h=-u.ty,f=-u.getAngle();this._writeGlyphs(t,c,l,h,i,f),u=a.next()}}_getShaping(){var c;const t=this._textMeshTransformProps,e=this.evaluatedMeshParams;if(!((c=e.glyphs)!=null&&c.glyphs.length))return null;const i=Math.round(S(t.fontSize)),n=S(t.offsetX),s=S(t.offsetY),o=fi(S(e.lineWidth),32,512),a=ls*fi(e.lineHeightRatio,.25,4);return ys(e.glyphs,{scale:i/hs,angle:t.postAngle,xOffset:n,yOffset:s,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,maxLineWidth:o,lineHeight:a,decoration:e.decoration,borderLineSizePx:S(e.boxBorderLineSize),hasBackground:!!e.boxBackgroundColor,useCIMAngleBehavior:e.useCIMAngleBehavior})}_writeGlyphs(t,e,i,n,s,o,a,c){const u=this.evaluatedMeshParams,l=this._textMeshTransformProps,h=l.fontSize,f=S(l.offsetX),p=S(l.offsetY),[y,b]=Ut(u.scaleInfo,this.getTileInfo());o!==0&&s.setRotation(o);const v=s.bounds,w=i+v.x+f,$=n+v.y-p,k=2*(u.minPixelBuffer?u.minPixelBuffer/h:1),E=Math.max(v.width,v.height)*k;s.textBox&&(t.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),t.recordBounds(w,$,E,E),this._writeTextBox(t,e,i,n,s.textBox,a,c),t.recordEnd());for(const N of s.glyphs){t.recordStart(this.instanceId,this.attributeLayout,N.textureBinding),t.recordBounds(w,$,E,E);const{texcoords:I,offsets:U}=N;this._writeQuad(t,e,i,n,{texcoords:I,offsets:U,fontSize:h,color:L(u.color),isBackground:!1,referenceBounds:a,minZoom:y,maxZoom:b,...c}),t.recordEnd()}o!==0&&s.setRotation(-o)}_writeTextBox(t,e,i,n,s,o,a){const c=this.evaluatedMeshParams,{fontSize:u}=this._textMeshTransformProps,{boxBackgroundColor:l,boxBorderLineColor:h}=c,f={isBackground:!0,fontSize:u,referenceBounds:o,...a};l&&(this._writeQuad(t,e,i,n,{texcoords:Xa,offsets:s.main,color:L(l),...f}),h||(this._writeQuad(t,e,i,n,{texcoords:qa,offsets:s.top,color:L(l),...f}),this._writeQuad(t,e,i,n,{texcoords:Ka,offsets:s.bot,color:L(l),...f}),this._writeQuad(t,e,i,n,{texcoords:ja,offsets:s.left,color:L(l),...f}),this._writeQuad(t,e,i,n,{texcoords:Qa,offsets:s.right,color:L(l),...f}))),h&&(this._writeQuad(t,e,i,n,{texcoords:Ci,offsets:s.top,color:L(h),...f}),this._writeQuad(t,e,i,n,{texcoords:Ci,offsets:s.bot,color:L(h),...f}),this._writeQuad(t,e,i,n,{texcoords:Bi,offsets:s.left,color:L(h),...f}),this._writeQuad(t,e,i,n,{texcoords:Bi,offsets:s.right,color:L(h),...f}))}_writeQuad(t,e,i,n,s){const o=t.vertexCount();this._writeVertex(t,e,i,n,s),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}};const tc=r=>Math.round(r*(254/360)),Ie=1,Dt=0,ec=128,rc=ts(r=>{let t=0;if(r===0)return 1/0;for(;!(r%2);)t++,r/=2;return t});class ic extends Xn{constructor(){super(...arguments),this._zoomLevel=0}_write(t,e,i,n){if(this._zoomLevel=n||0,i!=null)throw new Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(e.geometryType){case"esriGeometryPoint":{const s=e.readXForDisplay(),o=e.readYForDisplay();return this._writePoint(t,s,o,e)}case"esriGeometryEnvelope":case"esriGeometryPolygon":case"esriGeometryMultipoint":{const s=e.readCentroidForDisplay();if(!s)return;const[o,a]=s.coords;return this._writePoint(t,o,a,e)}case"esriGeometryPolyline":{const s=e.readLegacyGeometryForDisplay();this._writeLines(t,e,s)}}}_writePoint(t,e,i,n){var p,y;const s=this._getShaping();if(!s)return;let o=this._getPointReferenceBounds();o||(o={offsetX:0,offsetY:0,size:0});const a=s.boundsT,c=gs(this.evaluatedMeshParams.horizontalAlignment),u=xs(this.evaluatedMeshParams.verticalAlignment),l=((p=this.evaluatedMeshParams.scaleInfo)==null?void 0:p.maxScale)??0,h=((y=this.evaluatedMeshParams.scaleInfo)==null?void 0:y.minScale)??0,f=Pe(n.getDisplayId());t.metricStart(new ge(f,e,i,c,u,l,h,o)),t.metricBoxWrite(a),this._writeGlyphs(t,n.getDisplayId(),e,i,s,0,o),t.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(const t of this._references){const e=t.getBoundsInfo();if(e)return e}return null}_writeLines(t,e,i){const{repeatLabel:n,scaleInfo:s}=this.evaluatedMeshParams,o=this.evaluatedMeshParams.repeatLabelDistance||128,a=this._getShaping();if(!a)return;this._current={out:t,id:e.getDisplayId(),shaping:a,zoomRange:Ut(s,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0}};const c=Ya(i.paths,a.bounds.width),u=this._placeSubdivGlyphs.bind(this),l=(a.bounds.width+o)/(1<<Ie);for(const h of c)Wa(h,l,u,!!n)}_placeSubdivGlyphs(t,e,i,n){const{allowOverrun:s,labelPosition:o,repeatLabelDistance:a}=this.evaluatedMeshParams,c=this._current.zoomRange[0],u=rc(e),l=this._current.shaping.bounds.width/(1<<Ie),h=Math.sqrt(a||ec)/(1<<Ie),f=Math.min(i,n-i),p=this._current.shaping.isMultiline?Le:Math.log2(f/(h+l/2)),y=e===0?p:Math.min(u,p),b=Math.max(c,this._zoomLevel+Ie-y),v=this._zoomLevel-b,w=this._current.shaping.bounds.width/2*2**v;this._current.shaping.isMultiline?e===0&&this._placeStraight(t,b):s&&v<0?this._placeStraightAlong(t,c):o==="parallel"?this._placeStraightAlong(t,b):o==="curved"&&this._placeCurved(t,b,w)}_placeStraight(t,e){var y,b;const{out:i,id:n,shaping:s,referenceBounds:o}=this._current,{x:a,y:c}=t,u=Pe(n),l=((y=this.evaluatedMeshParams.scaleInfo)==null?void 0:y.maxScale)??0,h=((b=this.evaluatedMeshParams.scaleInfo)==null?void 0:b.minScale)??0;i.metricStart(new ge(u,t.x,t.y,0,0,l,h,null)),i.metricBoxWrite(s.boundsT);const f=t.angle*(180/Math.PI)%360,p=(t.angle*(180/Math.PI)+180)%360;this._writeGlyphs(i,n,a,c,s,0,o,{clipAngle:f,mapAligned:!0,isLineLabel:!0,minZoom:e}),this._writeGlyphs(i,n,a,c,s,0,o,{clipAngle:p,mapAligned:!0,isLineLabel:!0,minZoom:e}),i.metricEnd()}_placeCurved(t,e,i){var f,p;const{out:n,id:s}=this._current,o=t.clone(),a=t.angle*(180/Math.PI)%360,c=(t.angle*(180/Math.PI)+180)%360,u=Pe(s),l=((f=this.evaluatedMeshParams.scaleInfo)==null?void 0:f.maxScale)??0,h=((p=this.evaluatedMeshParams.scaleInfo)==null?void 0:p.minScale)??0;n.metricStart(new ge(u,t.x,t.y,0,0,l,h,null)),this._placeFirst(o,e,1,a),this._placeBack(t,o,e,i,1,a),this._placeForward(t,o,e,i,1,a),this._placeFirst(o,e,0,c),this._placeBack(t,o,e,i,0,c),this._placeForward(t,o,e,i,0,c),n.metricEnd()}_placeStraightAlong(t,e){var v,w;const{out:i,id:n,shaping:s,zoomRange:o,referenceBounds:a}=this._current,{boxBorderLineColor:c,boxBackgroundColor:u}=this.evaluatedMeshParams,l=t.clone(),h=t.angle*(180/Math.PI)%360,f=(t.angle*(180/Math.PI)+180)%360;if(s.glyphs.length>0&&(c||u)){const $=Math.max(e,o[0],0),k=Math.min(Le,o[1]),E=Wi(Yi(),-t.angle),[N,I]=s.shapeBackground(E),U={minZoom:$,maxZoom:k,clipAngle:h,mapAligned:!0,isLineLabel:!0};i.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),this._writeTextBox(i,n,t.x,t.y,I,a,U),i.recordEnd(),U.clipAngle=f,i.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),this._writeTextBox(i,n,t.x,t.y,I,a,U),i.recordEnd()}const p=Pe(n),y=((v=this.evaluatedMeshParams.scaleInfo)==null?void 0:v.maxScale)??0,b=((w=this.evaluatedMeshParams.scaleInfo)==null?void 0:w.minScale)??0;i.metricStart(new ge(p,t.x,t.y,0,0,y,b,null)),this._placeFirst(l,e,1,h,!0),this._placeFirst(l,e,0,f,!0),i.metricEnd()}_placeBack(t,e,i,n,s,o){const a=t.clone();let c=t.backwardLength+Dt;for(;a.prev()&&!(c>=n);)this._placeOnSegment(a,e,c,i,-1,s,o),c+=a.length+Dt}_placeForward(t,e,i,n,s,o){const a=t.clone();let c=t.remainingLength+Dt;for(;a.next()&&!(c>=n);)this._placeOnSegment(a,e,c,i,1,s,o),c+=a.length+Dt}_placeFirst(t,e,i,n,s=!1){const o=t,{out:a,id:c,shaping:u,zoomRange:l,referenceBounds:h}=this._current,f=u.glyphs;for(const p of f){const y=p.x>u.bounds.x?i:1-i,b=y*t.remainingLength+(1-y)*t.backwardLength,v=Math.abs(p.x+p.width/2-u.bounds.x),w=Math.max(0,this._zoomLevel+Math.log2(v/(b+Dt))),$=Math.max(e,s?0:w);p.maxZoom=Math.min(l[1],Le),p.angle=t.angle+(1-i)*Math.PI,p.minZoom=Math.max(l[0],$),this._writeLineGlyph(a,c,o.x,o.y,u.bounds,p,n,h,!0),i&&this._isVisible(p.minZoom,p.maxZoom)&&a.metricBoxWrite(p.bounds)}}_placeOnSegment(t,e,i,n,s,o,a){const{out:c,id:u,shaping:l,referenceBounds:h}=this._current,f=l.glyphs,p=t.dx/t.length,y=t.dy/t.length,b={x:t.x+i*-s*p,y:t.y+i*-s*y};for(const v of f){const w=v.x>l.bounds.x?o:1-o;if(!(w&&s===1||!w&&s===-1))continue;const $=Math.abs(v.x+v.width/2-l.bounds.x),k=Math.max(0,this._zoomLevel+Math.log2($/i)-.1),E=Math.max(n,this._zoomLevel+Math.log2($/(i+t.length+Dt)));if(k!==0&&(v.angle=t.angle+(1-o)*Math.PI,v.minZoom=E,v.maxZoom=k,this._writeLineGlyph(c,u,b.x,b.y,l.bounds,v,a,h,!0),o&&this._isVisible(v.minZoom,v.maxZoom))){const N=v.bounds,I=t.x-e.x,U=t.y-e.y,nt=new ks(N.center[0]+I,N.center[1]+U,N.width,N.height);c.metricBoxWrite(nt)}}}_writeLineGlyph(t,e,i,n,s,o,a,c,u){const l=i+s.x,h=n+s.y,f=2*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1),p=Math.max(s.width,s.height)*f;t.recordStart(this.instanceId,this.attributeLayout,o.textureBinding),t.recordBounds(l,h,p,p);const{texcoords:y,offsets:b}=o,v=this._textMeshTransformProps.fontSize;this._writeQuad(t,e,i,n,{texcoords:y,offsets:b,fontSize:v,color:L(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:c,minZoom:Math.max(this._current.zoomRange[0],o.minZoom),maxZoom:Math.min(this._current.zoomRange[1],o.maxZoom),clipAngle:a,mapAligned:u,isLineLabel:!0}),t.recordEnd()}_isVisible(t,e){const i=this._zoomLevel;return t<=i&&i<=e}}const nc={createComputedParams:r=>r,attributes:{...tr.attributes,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:({shouldSampleAlphaOnly:r,shouldScaleDash:t,isSDF:e})=>de([[Xr,r],[_o,t],[wo,e]])},tlbr:{type:g.UNSIGNED_SHORT,count:4,pack:({sprite:r})=>{const{rect:t,width:e,height:i}=r,n=t.x+Rt,s=t.y+Rt;return[n,s,n+e,s+i]}},accumulatedDistance:{type:g.UNSIGNED_SHORT,count:1,packTessellation:({distance:r})=>r},segmentDirection:{type:g.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:r,directionY:t})=>[r,t]}}};class sc extends jr{constructor(t,e,i,n){super(t,e,i,n),this.vertexSpec=nc,this._tessellationOptions.textured=!0}_write(t,e,i){const n=i??ft.fromFeatureSetReaderCIM(e);if(!n)return;const{sprite:s}=this.evaluatedMeshParams;this._writeGeometry(t,e,n,s==null?void 0:s.textureBinding)}}class Ke{static from(t){return"width"in t?this.fromSimpleMeshParams(t):this.fromComplexMeshParams(t)}static fromSimpleMeshParams(t){const e=new Ke(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects),{type:i,width:n,height:s,angle:o,alignment:a,outlineSize:c,referenceSize:u,sprite:l,overrideOutlineColor:h}=t;e.rawWidth=S(n),e.rawHeight=S(s),e.angle=o,e.alignment=a,e.outlineSize=S(c),e.referenceSize=S(u),e.overrideOutlineColor=h,e.offsetX=S(t.offsetX),e.offsetY=S(t.offsetY),i!=="simple"||l.sdf||(e.rawWidth=l.width,e.rawHeight=l.height);const f=2;return e.sizeRatio=l.sdf?f:1,e._computeSize(t,!1),e}static fromComplexMeshParams(t){const e=new Ke(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects);let{alignment:i,transforms:n,size:s,scaleX:o,anchorX:a,anchorY:c,angle:u,colorLocked:l,frameHeight:h,widthRatio:f,offsetX:p,offsetY:y,outlineSize:b,referenceSize:v,scaleFactor:w,sizeRatio:$,isAbsoluteAnchorPoint:k,rotateClockwise:E,scaleSymbolsProportionally:N,sprite:I}=t;if(n&&n.infos.length>0){const ye=Vi(s,u,E,p,y,n);s=ye.size,u=ye.rotation,p=ye.offsetX,y=ye.offsetY,E=!1}w&&(s*=w,p*=w,y*=w);const U=o*(I.width/I.height);e.alignment=i,e.rawHeight=S(s),e.rawWidth=e.rawHeight*U,e.referenceSize=S(v),e.sizeRatio=$,e.angle=u,e.rotateClockwise=E,e.anchorX=a,e.anchorY=c,e.offsetX=S(p),e.offsetY=S(y),k&&s&&(I.sdf?e.anchorX=a/(s*f):e.anchorX=a/(s*U),e.anchorY=c/s);const nt=N&&h?s/h:1;return e.outlineSize=b===0||isNaN(b)?0:S(b)*nt,e.scaleSymbolsProportionally=N,e.colorLocked=l,e._computeSize(t,!0),e}constructor(t,e,i,n,s,o,a){this.sprite=t,this.color=e,this.outlineColor=i,this.minPixelBuffer=n,this.placement=s,this.scaleInfo=o,this.effects=a,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.alignment=Gi.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(t,e){const{sprite:i,hasSizeVV:n}=t,s=!!i.sdf,{rawWidth:o,rawHeight:a,sizeRatio:c,outlineSize:u}=this,l=o*c,h=a*c;if(s&&!n){const k=e&&o>a?l:o,E=a,N=u+2*1;this.computedWidth=Math.min(k+N,l),this.computedHeight=Math.min(E+N,h)}else this.computedWidth=l,this.computedHeight=h;const f=s?ds/Math.max(l,h):1,p=.5*(l-this.computedWidth)*f,y=.5*(h-this.computedHeight)*f,b=i.rect.x+Rt+p,v=i.rect.y+Rt+y,w=b+i.width-2*p,$=v+i.height-2*y;this.texXmin=Math.floor(b),this.texYmin=Math.floor(v),this.texXmax=Math.ceil(w),this.texYmax=Math.ceil($),this.computedWidth*=(this.texXmax-this.texXmin)/(w-b),this.computedHeight*=(this.texYmax-this.texYmin)/($-v),this.anchorX*=l/this.computedWidth,this.anchorY*=h/this.computedHeight}}const Jt={bitset:{isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4}},Oi=3.14159265359/180,oc=128/Math.PI;function ac(r,t){return r%=t,Math.abs(r>=0?r:r+t)}function cc(r){return ac(r*oc,256)}function uc(r,t,e,i,n=!1){const s=Yi(),o=n?1:-1;return r?Wi(s,o*Oi*r):Ps(s),(t||e)&&Ts(s,s,[t,-e]),i&&Is(s,s,o*Oi*-i),s}const lc={createComputedParams:r=>Ke.from(r),attributes:{pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1,pack:({sprite:r,alignment:t,scaleSymbolsProportionally:e,overrideOutlineColor:i,colorLocked:n})=>{let s=0;return r.sdf&&(s|=Zt(Jt.bitset.isSDF)),t===Gi.MAP&&(s|=Zt(Jt.bitset.isMapAligned)),e&&(s|=Zt(Jt.bitset.scaleSymbolsProportionally)),i&&(s|=Zt(Jt.bitset.overrideOutlineColor)),n&&(s|=Zt(Jt.bitset.colorLocked)),s}},zoomRange:{type:g.SHORT,count:2,packPrecisionFactor:Qe,pack:({scaleInfo:r},{tileInfo:t})=>Ut(r,t)},offset:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({angle:r,computedWidth:t,computedHeight:e,anchorX:i,anchorY:n,offsetX:s,offsetY:o,rotateClockwise:a})=>{const c=uc(0,s,o,-r,a),u=-(.5+i)*t,l=-(.5-n)*e,h=[u,l],f=[u+t,l],p=[u,l+e],y=[u+t,l+e];return be(h,h,c),be(f,f,c),be(p,p,c),be(y,y,c),[h,f,p,y]}}},textureUV:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({texXmax:r,texXmin:t,texYmax:e,texYmin:i})=>[[t,i],[r,i],[t,e],[r,e]]}},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)},outlineColor:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:r})=>L(r)},sizing:{type:g.UNSIGNED_BYTE,count:4,pack:({rawWidth:r,rawHeight:t,outlineSize:e,referenceSize:i})=>{const n=Math.max(r,t);return[lr(n,128),lr(e,128),lr(i,128),0]}},placementAngle:{type:g.UNSIGNED_BYTE,count:1,packTessellation:({placementAngle:r})=>cc(r)},sizeRatio:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:({sizeRatio:r})=>r}}};class hc extends Gt{constructor(){super(...arguments),this.vertexSpec=lc}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(t,e,i){var h;const n=(h=this.evaluatedMeshParams.sprite)==null?void 0:h.textureBinding,s=e.getDisplayId();t.recordStart(this.instanceId,this.attributeLayout,n);const o=this.evaluatedMeshParams.minPixelBuffer,a=Math.max(this.evaluatedMeshParams.computedWidth,o),c=Math.max(this.evaluatedMeshParams.computedHeight,o),u=this.evaluatedMeshParams.offsetX,l=-this.evaluatedMeshParams.offsetY;if(this.evaluatedMeshParams.placement!=null)this._writePlacedMarkers(t,e,i,a,c);else if(i&&i.nextPath()){i.nextPoint();const f=i.x,p=i.y;t.recordBounds(f+u,p+l,a,c),this._writeQuad(t,s,f,p)}else if(e.geometryType==="esriGeometryPolygon"){const f=e.readCentroidForDisplay();if(!f)return;const[p,y]=f.coords;t.recordBounds(p+u,y+l,a,c),this._writeQuad(t,s,p,y)}else if(e.geometryType==="esriGeometryPoint"){const f=e.readXForDisplay(),p=e.readYForDisplay();t.recordBounds(f+u,p+l,a,c),this._writeQuad(t,s,f,p)}else{const f=e.readGeometryForDisplay();f==null||f.forEachVertex((p,y)=>{t.recordBounds(p+u,y+l,a,c),Math.abs(p)>yt||Math.abs(y)>yt||this._writeQuad(t,s,p,y)})}t.recordEnd()}_writePlacedMarkers(t,e,i,n,s){var p;const o=i??((p=ft.fromFeatureSetReaderCIM(e))==null?void 0:p.clone());if(!o)return;const a=-1,c=Zn.getPlacement(o,a,this.evaluatedMeshParams.placement,S(1),t.id,Hr());if(!c)return;const u=e.getDisplayId();let l=c.next();const h=this.evaluatedMeshParams.offsetX,f=-this.evaluatedMeshParams.offsetY;for(;l!=null;){const y=l.tx,b=-l.ty;if(Math.abs(y)>yt||Math.abs(b)>yt){l=c.next();continue}const v=-l.getAngle();t.recordBounds(y+h,b+f,n,s),this._writeQuad(t,u,y,b,v),l=c.next()}}_writeQuad(t,e,i,n,s){const o=t.vertexCount(),a=s==null?null:{placementAngle:s};this._writeVertex(t,e,i,n,a),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}}const dc={createComputedParams:r=>r,attributes:{pos:{type:g.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>0},offset:{type:g.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:({size:r})=>{const t=S(r),e=-t/2,i=-t/2;return[[e,i],[e+t,i],[e,i+t],[e+t,i+t]]}}},texCoords:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:g.UNSIGNED_BYTE,count:2,pack:({size:r})=>[r,r]},referenceSize:{type:g.UNSIGNED_BYTE,count:1,pack:({size:r})=>S(r)},zoomRange:{type:g.UNSIGNED_BYTE,count:2,pack:({scaleInfo:r},{tileInfo:t})=>Ut(r,t)}}};class pc extends Gt{constructor(){super(...arguments),this.vertexSpec=dc}_write(t,e){const i=e.getDisplayId(),n=this.evaluatedMeshParams.minPixelBuffer,s=Math.max(S(this.evaluatedMeshParams.size),n);let o,a;if(e.geometryType==="esriGeometryPoint")o=e.readXForDisplay(),a=e.readYForDisplay();else{const u=e.readCentroidForDisplay();if(!u)return;o=u==null?void 0:u.coords[0],a=u==null?void 0:u.coords[1]}t.recordStart(this.instanceId,this.attributeLayout),t.recordBounds(o,a,s,s);const c=t.vertexCount();this._writeVertex(t,i,o,a),t.indexWrite(c+0),t.indexWrite(c+1),t.indexWrite(c+2),t.indexWrite(c+1),t.indexWrite(c+3),t.indexWrite(c+2),t.recordEnd()}}const ll=fc({FillMeshWriter:Zr,DotDensityMeshWriter:uo,ComplexFillMeshWriter:To,PatternFillMeshWriter:sn,OutlineFillMeshWriter:ti,PatternOutlineFillMeshWriter:Ca,ComplexOutlineFillMeshWriter:Ea,MarkerMeshWriter:hc,PieChartMeshWriter:pc,TextMeshWriter:Xn,LineMeshWriter:jr,TexturedLineMeshWriter:sc,HeatmapMeshWriter:Oa,LabelMeshWriter:ic});function fc(r){const t={};for(const e in r){const i={name:e,constructor:r[e]};t[e]=i}return t}let ke=class extends rs{constructor(r){super(r),this.debugName="",this._updatingHandles=new Ns,this._idToUpdatingState=new Ms}get updating(){const r=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some(t=>t);if(Ur("esri-2d-log-updating")){const t=Array.from(this._idToUpdatingState.entries()).map(([e,i])=>`-> ${e}: ${i}`).join(`
`);console.log(`${this.debugName}: Updating: ${r}
-> Handles: ${this._updatingHandles.updating}
${t}`)}return r}addUpdateTracking(r,t){const e=is(()=>t.updating,i=>this._idToUpdatingState.set(r,i),{sync:!0});this.addHandles(e)}addPromise(r){return this._updatingHandles.addPromise(r)}};d([mi({constructOnly:!0})],ke.prototype,"debugName",void 0),d([mi({readOnly:!0})],ke.prototype,"updating",null),ke=d([es("esri.view.2d.layers.support.UpdateTracking2D")],ke);export{ue as $,wu as A,Vt as B,T as C,Fn as D,Ot as E,ir as F,V as G,M as H,_e as I,Se as J,Rr as K,we as L,$e as M,ie as N,R as O,Q as P,Yc as Q,Eu as R,ct as S,In as T,rt as U,It as V,ai as W,ri as X,wi as Y,W as Z,_,ll as a,le as a0,hi as a1,Ye as a2,He as a3,di as a4,At as a5,aa as a6,ta as a7,Cr as a8,ra as a9,_u as aA,li as aB,ui as aC,yo as aD,jo as aE,Hc as aF,kn as aG,ya as aH,We as aI,ma as aJ,Mi as aK,it as aa,$o as ab,Zc as ac,ba as ad,Fu as ae,So as af,Xc as ag,xa as ah,xt as ai,lu as aj,hu as ak,Z as al,st as am,pt as an,$t as ao,_o as ap,Mn as aq,Nt as ar,pa as as,si as at,q as au,Ln as av,wo as aw,Xr as ax,wa as ay,Jt as az,Va as b,P as c,ke as d,Y as e,Pe as f,C as g,Or as h,ca as i,m as j,vo as k,to as l,ut as m,Oc as n,gt as o,Nn as p,du as q,Vc as r,al as s,H as t,Dn as u,Tt as v,ht as w,Ni as x,re as y,oi as z};
