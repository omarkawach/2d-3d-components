import{o as N,r as F}from"./mat4f64-Dk4dwAN8.js";import{bT as H,bS as R,d7 as Y,bI as q,ci as D,dA as W,dl as U,bW as M,dC as k,dg as x,di as p,dj as v,lC as G,cT as J,fc as K}from"./index-8ERthB3p.js";import{t as Q,l as V}from"./Indices-DP3oX5Sg.js";import{t as X}from"./basicInterfaces-DngWxyLO.js";import{s as E}from"./Util-B8vYs4k8.js";import{r as Z,e as C}from"./ContentObject-BTgEhnct.js";import{d as tt}from"./triangle-CTblFuF6.js";import{e as L}from"./VertexAttribute-BnAa5VW0.js";import{t as it}from"./doublePrecisionUtils-B0owpBza.js";function et(r){if(r.length<H)return Array.from(r);if(R(r))return Float64Array.from(r);if(!("BYTES_PER_ELEMENT"in r))return Array.from(r);switch(r.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(r);case 2:return Y(r)?Uint16Array.from(r):Int16Array.from(r);case 4:return Float32Array.from(r);default:return Float64Array.from(r)}}let nt=class j{constructor(t,i,n){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.position=n,this._children=void 0,E(t.length>=1),E(n.size===3||n.size===4);const{data:s,size:o,indices:h}=n;E(h.length%this._numIndexPerPrimitive==0),E(h.length>=t.length*this._numIndexPerPrimitive);const u=t.length;let a=o*h[this._numIndexPerPrimitive*t[0]];A.clear(),A.push(a);const l=D(s[a],s[a+1],s[a+2]),e=W(l);for(let m=0;m<u;++m){const f=this._numIndexPerPrimitive*t[m];for(let _=0;_<this._numIndexPerPrimitive;++_){a=o*h[f+_],A.push(a);let g=s[a];l[0]=Math.min(g,l[0]),e[0]=Math.max(g,e[0]),g=s[a+1],l[1]=Math.min(g,l[1]),e[1]=Math.max(g,e[1]),g=s[a+2],l[2]=Math.min(g,l[2]),e[2]=Math.max(g,e[2])}}this.bbMin=l,this.bbMax=e;const c=U(M(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(e[0]-l[0],e[1]-l[1]),e[2]-l[2]);let I=this.radius*this.radius;for(let m=0;m<A.length;++m){a=A.at(m);const f=s[a]-c[0],_=s[a+1]-c[1],g=s[a+2]-c[2],y=f*f+_*_+g*g;if(y<=I)continue;const w=Math.sqrt(y),T=.5*(w-this.radius);this.radius=this.radius+T,I=this.radius*this.radius;const O=T/w;c[0]+=f*O,c[1]+=_*O,c[2]+=g*O}this.center=c,A.clear()}getChildren(){if(this._children||k(this.bbMin,this.bbMax)<=1)return this._children;const t=U(M(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,n=new Uint8Array(i),s=new Array(8);for(let e=0;e<8;++e)s[e]=0;const{data:o,size:h,indices:u}=this.position;for(let e=0;e<i;++e){let c=0;const I=this._numIndexPerPrimitive*this.primitiveIndices[e];let m=h*u[I],f=o[m],_=o[m+1],g=o[m+2];for(let y=1;y<this._numIndexPerPrimitive;++y){m=h*u[I+y];const w=o[m],T=o[m+1],O=o[m+2];w<f&&(f=w),T<_&&(_=T),O<g&&(g=O)}f<t[0]&&(c|=1),_<t[1]&&(c|=2),g<t[2]&&(c|=4),n[e]=c,++s[c]}let a=0;for(let e=0;e<8;++e)s[e]>0&&++a;if(a<2)return;const l=new Array(8);for(let e=0;e<8;++e)l[e]=s[e]>0?new Uint32Array(s[e]):void 0;for(let e=0;e<8;++e)s[e]=0;for(let e=0;e<i;++e){const c=n[e];l[c][s[c]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)l[e]!==void 0&&this._children.push(new j(l[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){A.prune()}};const A=new q({deallocator:null});function st(r,t){if(!r)return!1;const{size:i,data:n,indices:s}=r;x(t,0,0,0),x(b,0,0,0);let o=0,h=0;for(let u=0;u<s.length-2;u+=3){const a=s[u]*i,l=s[u+1]*i,e=s[u+2]*i;x(d,n[a],n[a+1],n[a+2]),x(P,n[l],n[l+1],n[l+2]),x(z,n[e],n[e+1],n[e+2]);const c=tt(d,P,z);c?(p(d,d,P),p(d,d,z),v(d,d,1/3*c),p(t,t,d),o+=c):(p(b,b,d),p(b,b,P),p(b,b,z),h+=3)}return(h!==0||o!==0)&&(o!==0?(v(t,t,1/o),!0):h!==0&&(v(t,b,1/h),!0))}function rt(r,t){if(!r)return!1;const{size:i,data:n,indices:s}=r;x(t,0,0,0);let o=-1,h=0;for(let u=0;u<s.length;u++){const a=s[u]*i;o!==a&&(t[0]+=n[a],t[1]+=n[a+1],t[2]+=n[a+2],h++),o=a}return h>1&&v(t,t,1/h),h>0}function at(r,t,i){if(!r)return!1;x(i,0,0,0),x(b,0,0,0);let n=0,s=0;const{size:o,data:h,indices:u}=r,a=u.length-1,l=a+(t?2:0);for(let e=0;e<l;e+=2){const c=e<a?e+1:0,I=u[e<a?e:a]*o,m=u[c]*o;d[0]=h[I],d[1]=h[I+1],d[2]=h[I+2],P[0]=h[m],P[1]=h[m+1],P[2]=h[m+2],v(d,p(d,d,P),.5);const f=G(d,P);f>0?(p(i,i,v(d,d,f)),n+=f):n===0&&(p(b,b,d),s++)}return n!==0?(v(i,i,1/n),!0):s!==0&&(v(i,b,1/s),!0)}const d=M(),P=M(),z=M(),b=M();let ht=class{constructor(t){this.channel=t,this.id=J()}};function ot(r,t){return r==null&&(r=[]),r.push(t),r}function ut(r,t){if(r==null)return null;const i=r.filter(n=>n!==t);return i.length===0?null:i}function xt(r,t,i,n,s){S[0]=r.get(t,0),S[1]=r.get(t,1),S[2]=r.get(t,2),it(S,$,3),i.set(s,0,$[0]),n.set(s,0,$[1]),i.set(s,1,$[2]),n.set(s,1,$[3]),i.set(s,2,$[4]),n.set(s,2,$[5])}const S=M(),$=new Float32Array(6);class B extends Z{constructor(t,i,n=null,s=C.Mesh,o=null,h=-1){super(),this.material=t,this.mapPositions=n,this.type=s,this.objectAndLayerIdColor=o,this.edgeIndicesLength=h,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[u,a]of i)this._attributes.set(u,{...a,indices:Q(a.indices)}),u===L.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(u).indices.length:this.edgeIndicesLength)}instantiate(t={}){const i=new B(t.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach((n,s)=>{n.exclusive=!1,i._attributes.set(s,n)}),i._boundingInfo=this._boundingInfo,i.transformation=t.transformation||this.transformation,i}get attributes(){return this._attributes}getMutableAttribute(t){let i=this._attributes.get(t);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:et(i.data)},this._attributes.set(t,i)),i}setAttributeData(t,i){const n=this._attributes.get(t);n&&this._attributes.set(t,{...n,exclusive:!0,data:i})}get indexCount(){const t=this._attributes.values().next().value.indices;return(t==null?void 0:t.length)??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo==null&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===C.Mesh?this._computeAttachmentOriginTriangles(t):this.type===C.Line?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(this._transformation!=null&&K(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const i=this.attributes.get(L.POSITION);return st(i,t)}_computeAttachmentOriginLines(t){const i=this.attributes.get(L.POSITION);return at(i,lt(this.material.parameters,i),t)}_computeAttachmentOriginPoints(t){const i=this.attributes.get(L.POSITION);return rt(i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.attributes.get(L.POSITION);if(!t||t.indices.length===0)return null;const i=this.type===C.Mesh?3:1;E(t.indices.length%i==0,"Indexing error: "+t.indices.length+" not divisible by "+i);const n=V(t.indices.length/i);return new nt(n,i,t)}get transformation(){return this._transformation??N}set transformation(t){this._transformation=t&&t!==N?F(t):null}addHighlight(){const t=new ht(X.Highlight);return this.highlights=ot(this.highlights,t),t}removeHighlight(t){this.highlights=ut(this.highlights,t)}}function lt(r,t){return!(!("isClosed"in r)||!r.isClosed)&&t.indices.length>2}export{B as I,ut as a,xt as l,ot as n,nt as o,ht as r};
