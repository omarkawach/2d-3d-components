import{kE as B,kF as M,bW as N,g2 as W,kG as F,fC as X,T as R,Z as O,a7 as z,kH as q}from"./index-8ERthB3p.js";import{n as C}from"./projectVectorToVector-C3SBBDgz.js";import{o as Z}from"./LayerConstants-B33OP6sh.js";import{t as J}from"./Material-DwPnlQDw.js";import{a as m,i as U,o as T,e as K,s as I,d as w,T as j,t as L,c as Q}from"./ElevationProvider-Bd4qfXCi.js";import{V as Y}from"./sphere-Bf4ezJdT.js";import{n as tt,o as v}from"./Intersector-8rpRuT_8.js";import{i as S}from"./Intersector-CTjLkyei.js";import{w as b}from"./verticalOffsetUtils-BYv4Nk2v.js";class mt extends T{constructor(e,n,r,i){super(n,r),this.point=e,this.createGraphic=i}}function A(t){return m(t)&&t.intersector===U.PCL&&!!t.target}let Ut=class extends K{constructor(e,n,r,i,c){super(e),this.layerUid=e,this.sublayerUid=n,this.nodeIndex=r,this.componentIndex=i,this.triangleNr=c}};class It extends T{constructor(e,n,r){super(n,null),this.point=e,this.createVoxelGraphic=r}}class wt extends T{constructor(e,n){super(e,null),this.createTiles3DGraphic=n}}function x(t){return m(t)&&t.intersector===U.I3S&&!!t.target}function H(t){return m(t)&&t.intersector===U.VOXEL&&!!t.target}function et(t){return m(t)&&t.intersector===U.TILES3D&&!!t.target}function P(t,e){var n,r;return I(t)||w(t)?h((n=t.target)==null?void 0:n.object,e):tt(t)?(r=e.map)==null?void 0:r.ground:A(t)||x(t)||v(t)||H(t)?h(t.target,e):null}function xt(t,e){const n=V(t,e);return n!=null&&n.type==="graphic"?n.graphic:null}function V(t,e){var n;if(t==null)return null;if(I(t)||w(t))return G((n=t.target)==null?void 0:n.object,e);if(A(t)){const r=t.target.createGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(H(t)){const r=t.target.createVoxelGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(et(t)){const r=t.target.createTiles3DGraphic();return{type:"graphic",graphic:r,layer:r.layer}}return v(t)||S(t)?G(t.target,e):x(t)?nt(t.target,e):null}function G(t,e){if((t==null?void 0:t.graphicUid)==null)return null;const n=h(t,e);if(n==null)return null;if(n===e.graphics)return e.graphicsView==null||typeof t.graphicUid!="number"?null:e.graphicsView.getHit(t.graphicUid);const r=e.allLayerViews.find(i=>i.layer===n);return!r||r.suspended||t.graphicUid==null?null:"getHit"in r?r.getHit(t.graphicUid):null}function nt(t,e){const n=h(t,e);if(n==null)return null;const r=e.allLayerViews.find(i=>i.layer===n);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?it(r.getGraphicFromIntersectorTarget(t)):null}function rt(t,e){const n=h(t,e);if(n==null)return null;const r=e.allLayerViews.find(i=>i.layer===n);return r&&!r.suspended&&"getAABBFromIntersectorTarget"in r?r.getAABBFromIntersectorTarget(t):null}function it(t){return t!=null?{type:"graphic",graphic:t,layer:t.layer}:null}function h(t,e){return(t==null?void 0:t.layerUid)==null?null:e.graphicsView!=null&&t.layerUid===e.graphicsView.processor.layer.id?e.graphics:e.map.allLayers.find(n=>n.uid===t.layerUid)}function Lt(t,e){if(I(t)||w(t))return Y(t.target.object.boundingVolumeWorldSpace.bounds);if(S(t)){B($,t.transformation);const n=Math.max($[0],$[1],$[2]);return t.target.baseBoundingSphere.radius*n}if(x(t)){const n=rt(t.target,e);return n?.5*M(n):null}return null}function bt(t){return!I(t)&&!w(t)&&(S(t)?t.target.numLodLevels>1:!!x(t))}const $=N();async function Et(t,e,n,r){const i=n?k(t,n):r,c=W(e.x,e.y);i.requiresGroundFeedback=!0,i.enableDraped=!0;const a=j(t.state.viewingMode);a.options.selectionMode=!0,a.options.store=L.ALL,t.sceneIntersectionHelper.intersectIntersectorScreen(c,a,i);const o=st(t,a.results.all,i.graphics),s=a.results.ground,l=P(s,t),u=l!=null&&"type"in l&&F(l.type)?l:null,p={screenPoint:e,results:o,ground:{mapPoint:f(t,s),distance:m(s)?s.distanceInRenderSpace:0,layer:u}};return J.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(p.intersector=a),p}function Tt(t,e,n,r){const i=n?k(t,n):r,c=i.graphics!=null&&(i.graphics.include!=null||i.graphics.exclude!=null),a=X(e);i.enableDraped=i.include&&!i.include.has(b)||i.exclude&&i.exclude.has(b);const o=t.sceneIntersectionHelper,s=j(t.state.viewingMode);if(s.options.selectionMode=!0,s.options.store=c?L.ALL:L.MIN,s.options.hud=!(n!=null&&n.excludeHud),o.intersectIntersectorScreen(a,s,i),c){for(const l of s.results.all){const u=V(l,t);if(u==null||u.type!=="graphic"||_(i.graphics,u.graphic))return f(t,l)}return null}return f(t,s.results.min)}function st(t,e,n){const r=new Array;let i=null;for(let c=0;c<e.length;c++){const a=e[c],o=P(a,t);if(o!=null&&(o===t.map.ground||"type"in o&&F(o.type)))break;const s=V(a,t);if(s==null)continue;if(s.type==="graphic"){if(i==null&&c!==e.length-1&&(i=new Set),i!=null){const p=D(s.graphic);if(i.has(p))continue;i.add(p)}if(!_(n,s.graphic))continue}const l=f(t,a),u=a.distanceInRenderSpace;if(s.type==="media"){const p=s.element.toSource(l);r.push({...s,mapPoint:l,distance:u,sourcePoint:p})}else r.push({...s,mapPoint:l,distance:u})}return r}function f(t,e,n){return e.getIntersectionPoint(d)?(n=at(t,d,n),e.intersector===U.TERRAIN&&t.basemapTerrain&&(n.z=Q(t.basemapTerrain,n)??0),n):null}function D(t){var i;const e=t.sourceLayer,n=t.layer,r=e&&"objectIdField"in e?e:n&&"objectIdField"in n?n:e;if(r){const c=r.objectIdField??Z,a=(i=t.attributes)==null?void 0:i[c];if(a)return`o-${r.id}-${a}`}return`u-${t.uid}`}function _(t,e){const n=D(e);return t==null||(t.include==null||t.include.has(n))&&(t.exclude==null||!t.exclude.has(n))}function at(t,e,n){let r=t.spatialReference||R.WGS84;return C(e,t.renderSpatialReference,d,r)?e=d:(r=R.WGS84,C(e,t.renderSpatialReference,d,r)&&(e=d)),n?(n.x=e[0],n.y=e[1],n.z=e[2],n.spatialReference=r):n=new O(e,r),n}function k(t,e){const n=E(t,e.include,y.INCLUDE),r=E(t,e.exclude,y.EXCLUDE);return{include:n.layerUids,exclude:r.layerUids,graphics:{include:n.graphicUids,exclude:r.graphicUids}}}function E(t,e,n,r={layerUids:void 0,graphicUids:void 0}){if(!e)return r;if(e instanceof z)ct(r,D(e)),n===y.INCLUDE&&(t.graphicsView!=null&&e.layer===t?g(r,t.graphicsView.processor.layer.id):e.layer&&g(r,e.layer.uid));else if(q(e))for(const i of e)i===t.graphics&&t.graphicsView!=null?g(r,t.graphicsView.processor.layer.id):i===t.map.ground?g(r,b):E(t,i,n,r);else"uid"in e&&g(r,e.uid);return r}function g(t,e){t.layerUids||(t.layerUids=new Set),t.layerUids.add(e)}function ct(t,e){t.graphicUids||(t.graphicUids=new Set),t.graphicUids.add(e)}const d=N();var y;(function(t){t[t.INCLUDE=0]="INCLUDE",t[t.EXCLUDE=1]="EXCLUDE"})(y||(y={}));class St{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,n){this._store.put(e,n,n.values.byteLength+256)}}export{k as L,Lt as V,x as a,Et as b,It as c,Tt as j,wt as l,xt as m,Ut as o,et as p,mt as s,St as t,bt as w,at as x};
