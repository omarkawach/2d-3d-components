import{K as Pi}from"./CIMSymbolHelper-C-U_lWVp.js";import{o as c,pN as I,kO as Ti,fG as wt,P as Ut,jz as Fi,jD as St,s as Ii,br as ge,ds as Ci,p2 as Ai,pe as Ri,q as Oi}from"./index-8ERthB3p.js";import{a as U,K as Vt,L as Di,h as zt,u as Ei,i as Li}from"./definitions-B54owTRu.js";import{E as xe,S as de,f as Je,m as T,b as D,y as C,M as L,c as Bi,d as W,w as He,L as Ae}from"./Container-lXzdRU2v.js";import{c as x,C as y,_ as S,j as n,S as N,e as ki,g as A,h as Nt,F as Pe,P as pe,i as Ht,t as j,G as _,m as Q,B as we,o as H,H as V,p as Wt,q as Gt,u as ht,U as Z,x as Se,v as We,w as Ge,y as ke,z as et,A as _t,D as qt,E as jt,a as B,I as Ui,J as Ni,K as Hi,L as Wi,M as Gi,R as qi,N as ji,O as ce,Q as $t,W as Mt,T as Pt,V as Tt,X as Kt,Y as tt,Z as E,$ as Zt,a0 as Xt,a1 as Yt,a2 as Qt,a3 as Jt,a4 as ei,a5 as ft,a6 as ti,a7 as ii,a8 as it,a9 as Ki,aa as le,ab as Zi,ac as Ft,ad as st,ae as si,af as Xi,ag as Yi,ah as Qi,ai as je,aj as Ji,ak as es,al as ts,am as ri,an as is,ao as ss,ap as rs,aq as It,ar as rt,as as ai,at,au as Ke,av as as,aw as os,ax as ns,ay as ls,az as ze,aA as us,aB as cs,aC as ps,aD as ds,aE as hs,aF as fs,aG as ms,aH as re,aI as he,aJ as ae,aK as ys,d as vs}from"./UpdateTracking2D-BUPNqTRV.js";import{C as X,F as Ct,L as ot,D as nt,B as oi,E as bs,U as ni,_ as lt,O as gs,I as Ze}from"./enums-DSseSvdG.js";import{h as At}from"./BufferObject-CaEbWulZ.js";import{o as xs}from"./VertexArrayObject-Cv4RwmVi.js";import{t as ws}from"./VertexElementDescriptor-BOD-G50G.js";import{t as li}from"./LabelMetric-B0IKUycz.js";import{s as Ss,i as ui,x as ci}from"./Program-BB52p2Mx.js";import{e as Ue,m as pi}from"./Texture-O7Pyotwx.js";import{n as Vs}from"./heatmapTextureUtils-Ccf4XLi5.js";import{o as zs}from"./constants-D5zmR9t2.js";import{n as Rt}from"./WGLContainer-DrWw77ek.js";import{a as mt}from"./capabilities-C84AMSCg.js";import{_ as _s}from"./QueueProcessor-DFkcFyJt.js";let k=class{constructor(e){this.registryName=e,this.postProcessingEnabled=!1,this.overrideStencilRef=null,this.drawPhase=xe.MAP|xe.HITTEST|xe.HIGHLIGHT|xe.DEBUG,this.symbologyPlane=de.FILL}startup(){}shutdown(e){}postProcess(e,t){}},di=class extends Nt{};c([x(0,y)],di.prototype,"pos",void 0);let $s=class extends Pe{},hi=class extends pe{};c([S(n)],hi.prototype,"dotSize",void 0);let Oe=class extends pe{};c([S(N)],Oe.prototype,"locations",void 0),c([S(n)],Oe.prototype,"pixelRatio",void 0),c([S(n)],Oe.prototype,"tileZoomFactor",void 0);const Ms=1e-6;class me extends Ht{vertex(e){const t=new j(1,0,0,0,-1,0,0,1,1).multiply(new _(e.pos.xy.divide(U),1)),i=Q(this.draw.locations,t.xy),r=we(this.instance.dotSize.divide(2),new n(1));let a=new n(0);a=a.add(H(i.a,new n(Ms)).multiply(2));let o=r.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new _(e.pos.add(.5),1)),u=new V(l.xy,a,1),p=this.instance.dotSize.divide(o),d=new n(-1).divide(r.divide(o));return o=o.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:o,color:i,ratio:p,invEdgeRatio:d}}fragment(e){const t=Wt(e.glPointCoord.subtract(.5)).multiply(2),i=Gt(new n(0),new n(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),r=new ht;return r.glFragColor=e.color.multiply(i),r}}c([S(hi)],me.prototype,"instance",void 0),c([S(Oe)],me.prototype,"draw",void 0),c([S(ki)],me.prototype,"view",void 0),c([I(0,A(di))],me.prototype,"vertex",null),c([I(0,A($s))],me.prototype,"fragment",null);class fi extends We{}c([x(3,n)],fi.prototype,"inverseArea",void 0);let De=class extends pe{};c([S(Z.ofType(V,2))],De.prototype,"isActive",void 0),c([S(Z.ofType(V,8))],De.prototype,"colors",void 0),c([S(n)],De.prototype,"dotValue",void 0);let ye=class extends pe{};c([S(N)],ye.prototype,"dotTexture0",void 0),c([S(N)],ye.prototype,"dotTexture1",void 0),c([S(n)],ye.prototype,"tileZoomFactor",void 0),c([S(n)],ye.prototype,"pixelRatio",void 0),c([S(n)],ye.prototype,"tileDotsOverArea",void 0);let ve=class extends Ge{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new j(2/U,0,0,0,-2/U,0,-1,1,1).multiply(new _(e.pos,1)),i=this.clip(e.id),r=new V(t.xy,i,1),a=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),o=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(U).divide(this.draw.pixelRatio),u=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),p=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),d=e.pos.add(.5).divide(l);return{glPosition:r,color:new V(0,0,0,0),textureCoords:d,thresholds0:u,thresholds1:p}}fragment(e){const t=new ht,i=Q(this.draw.dotTexture0,e.textureCoords),r=Q(this.draw.dotTexture1,e.textureCoords),a=e.thresholds0.subtract(i),o=e.thresholds1.subtract(r);let l;const u=ke.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),p=ke.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const d=H(new n(0),a),h=H(new n(0),o),f=et(d,a).add(et(h,o)),m=H(f,new n(0)),b=new n(1).subtract(m),v=f.add(m),g=a.multiply(d).divide(v),w=o.multiply(h).divide(v),z=u.multiply(g).add(p.multiply(w));l=b.multiply(z)}else{const d=we(_t(a),_t(o)),h=H(d,new n(0)),f=new n(1).subtract(h),m=H(d,a),b=H(d,o),v=u.multiply(m).add(p.multiply(b));l=f.multiply(v)}return t.glFragColor=l,t}hittest(e){return qt(this.hittestRequest)}};c([Se],ve.prototype,"blending",void 0),c([S(De)],ve.prototype,"instance",void 0),c([S(ye)],ve.prototype,"draw",void 0),c([I(0,A(fi))],ve.prototype,"vertex",null),c([I(0,A(Pe))],ve.prototype,"fragment",null);const ut={[X.BYTE]:1,[X.UNSIGNED_BYTE]:1,[X.SHORT]:2,[X.UNSIGNED_SHORT]:2,[X.INT]:4,[X.UNSIGNED_INT]:4,[X.FLOAT]:4};let Ps=class{constructor(e,t){this._boundPart=null;const i=[];for(const a of t.vertex){const o=At.createVertex(e,Ct.STATIC_DRAW,a);i.push(o)}const r=[];for(const a of t.index||[]){const o=At.createIndex(e,Ct.STATIC_DRAW,a);r.push(o)}this.groups=[];for(const a of t.groups){let o;if(a.index!=null){if(!t.index)throw new Error("No index data.");const{BYTES_PER_ELEMENT:f}=t.index[a.index];f===2?o=X.UNSIGNED_SHORT:f===4&&(o=X.UNSIGNED_INT)}const l=a.index!=null?r[a.index]:null,u=new Map,p={},d={};for(const f of a.attributes){const{name:m,count:b,type:v,offset:g,normalized:w,divisor:z,stride:P,vertex:F,location:R}=f,$=`vertex-buffer-${F}`;let K=p[$];K||(K=p[$]=[]);const ue=new ws(m,b,v,g,P,w,z);K.push(ue),u.set(m,R),d[$]=i[F]}const h=new xs(e,u,p,d,l);this.groups.push({...a,vertexArray:h,locations:u,layout:p,indexing:o})}this.parts=t.parts}bind(e,t){this._boundPart=t;const{group:i}=this.parts[this._boundPart],{vertexArray:r}=this.groups[i];e.bindVAO(r)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:r}=this.parts[this._boundPart],{indexing:a,primitive:o}=this.groups[r];a?e.drawElements(o,i,a,t*ut[a]):e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArray:e}of this.groups)e.dispose()}},Ts=class mi extends Ps{static create(e,t){const i=[];let{stride:r,hash:a}=t.layout;if(r==null){r=0;for(const{count:f,type:m,offset:b}of t.layout.attributes){if(b!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=f*ut[m]}}let o=0,l=0;for(const{count:f,name:m,offset:b,type:v,normalized:g}of t.layout.attributes){b!=null&&(l=b);const w={name:m,location:o,vertex:0,count:f,type:v,offset:l,stride:r,divisor:0,normalized:g!=null&&g};i.push(w),o++,l+=f*ut[v]}const u={attributes:i,primitive:t.primitive};t.index!=null&&(u.index=0);let{count:p}=t;if(p==null&&(p=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(p)!==p))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);const d={start:0,count:p,group:0,primitive:t.primitive},h={vertex:[t.vertex],parts:[d],groups:[u]};return t.index!=null&&(h.index=[t.index]),a==null&&(a=li(i)),new mi(e,h,{hash:a,attributes:i,stride:r})}constructor(e,t,i){super(e,t),this.layout=i}bind(e,t=0){super.bind(e,t)}},Fs=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){const t=U,i=U,r=new Ue(t,i);r.samplingMode=ot.NEAREST,r.wrapMode=nt.CLAMP_TO_EDGE;const a=new Ss(e,new ui(oi.DEPTH_STENCIL,t,i));this._dotFBO=new ci(e,r,a)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){const t=U,i=t*t,r=2,a=new Int16Array(i*r);for(let u=0;u<t;u++)for(let p=0;p<t;p++)a[r*(p+u*t)]=p,a[r*(p+u*t)+1]=u;const o=[{count:2,type:X.UNSIGNED_SHORT,name:"a_position",offset:0}],l={hash:li(o),attributes:o,stride:4};this._dotMesh=Ts.create(e,{primitive:bs.POINTS,vertex:a,count:i,layout:l})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){const r=new Ti(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const r=new Float32Array(t*t*4);for(let o=0;o<r.length;o++)r[o]=i.getFloat();const a=new Ue;return a.dataType=ni.FLOAT,a.samplingMode=ot.NEAREST,a.width=t,a.height=t,new pi(e,a,r)}},Is=class extends k{constructor(){super(...arguments),this.shaders={polygon:new ve,point:new me,fill:new jt},this.meshWriter=B.DotDensityMeshWriter,this._resources=new Map}render(e,t){Je(e)||T(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.fill,uniforms:{...D(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...C(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}_renderDotDensity(e,t){const{context:i,painter:r,requiredLevel:a}=e,o=t.instance.getInput(),l=this._getOrCreateResourcesRecord(i),u=l.getDotDensityTextures(i,U,o.seed),p=1/2**(a-t.target.key.level),d=U,h=d*window.devicePixelRatio*d*window.devicePixelRatio,f=1/p*(1/p),m=o.dotScale?e.state.scale/o.dotScale:1,b=o.dotValue*m*f;r.setShader({shader:this.shaders.polygon,uniforms:{...D(e,t.target),instance:{isActive:o.isActive,colors:o.colors,dotValue:Math.max(1,b)},draw:{dotTexture0:{unit:Vt,texture:u[0]},dotTexture1:{unit:Di,texture:u[1]},tileZoomFactor:p,pixelRatio:window.devicePixelRatio,tileDotsOverArea:h/(U*window.devicePixelRatio*U*window.devicePixelRatio)}},defines:{...C(e),blending:o.blending},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState(L(e));const v=i.getViewport();i.setViewport(0,0,U,U);const g=i.getBoundFramebufferObject(),w=l.getFBO(i);i.bindFramebuffer(w),i.setClearColor(0,0,0,0),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(i),i.clear(lt.COLOR_BUFFER_BIT),r.submitDraw(i,t),i.bindFramebuffer(g),i.setViewport(v.x,v.y,v.width,v.height);const z=l.getFBO(i).colorTexture;r.setShader({shader:this.shaders.point,uniforms:{view:Bi(e,t.target),instance:{dotSize:o.dotSize},draw:{locations:{unit:Vt,texture:z},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...C(e)},optionalAttributes:{},useComputeBuffer:!1}),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.submitDrawMesh(i,l.getDotDensityMesh(i))}shutdown(e){var t;super.shutdown(e),(t=this._resources.get(e))==null||t.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Fs,this._resources.set(e,t)),t}},Cs=class extends k{constructor(){super(...arguments),this.meshWriter=B.ComplexFillMeshWriter,this.shaders={geometry:new Ui}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};function Te(s){const e=1/s;return{antialiasing:e,blur:0+e}}let As=class extends k{constructor(){super(...arguments),this.meshWriter=B.ComplexOutlineFillMeshWriter,this.shaders={geometry:new Ni}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Te(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Rs=class extends k{constructor(){super(...arguments),this.meshWriter=B.FillMeshWriter,this.shaders={geometry:new jt}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target)},defines:C(e),optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Os=class extends k{constructor(){super(...arguments),this.meshWriter=B.OutlineFillMeshWriter,this.shaders={geometry:new Hi}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Te(a)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Ds=class extends k{constructor(){super(...arguments),this.meshWriter=B.PatternFillMeshWriter,this.shaders={geometry:new Wi}}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},Es=class extends k{constructor(){super(...arguments),this.meshWriter=B.PatternOutlineFillMeshWriter,this.shaders={geometry:new Gi}}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Te(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:He(t.target)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};const Ls=()=>Ut.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");let Bs=class{destroy(){this._accumulateFramebuffer=wt(this._accumulateFramebuffer),this._resolveGradientTexture=wt(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){const t=Vs(e,Ls());this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==ni.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){const{dataType:r,samplingMode:a,pixelFormat:o,internalFormat:l}=this.loadQualityProfile(e),u=new Ue(t,i);u.pixelFormat=o,u.internalFormat=l,u.dataType=r,u.samplingMode=a,u.wrapMode=nt.CLAMP_TO_EDGE;const p=new ui(oi.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new ci(e,u,p)}else{const{width:r,height:a}=this._accumulateFramebuffer;r===t&&a===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){const r=new Ue;r.wrapMode=nt.CLAMP_TO_EDGE,this._resolveGradientTexture=new pi(e,r)}else this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t);return this._resolveGradientTexture}};function yi(s){return s?.25:1}let vi=class extends We{};c([x(5,y)],vi.prototype,"offset",void 0);let ks=class extends Pe{},ct=class extends pe{};c([S(n)],ct.prototype,"radius",void 0),c([S(n)],ct.prototype,"isFieldActive",void 0);let $e=class extends Ge{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,r=e.offset,a=i.multiply(this.storage.getVVData(e.id).x).add(new n(1).subtract(i)),o=this.view.displayViewScreenMat3.multiply(new _(e.pos,1)).add(this.view.displayViewMat3.multiply(new _(r,0)).multiply(t)),l=this.clip(e.id);return{glPosition:new V(o.xy,l,1),offset:r,fieldValue:a,color:new V(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,r=Wt(t),a=H(r,new n(1)),o=new n(1).subtract(r.multiply(r)),l=o.multiply(o),u=a.multiply(l).multiply(i).multiply(new n(yi(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new V(u),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,r=t.multiply(i).multiply(new _(e.pos,1));return qi(r.xy,this.kernelControls.radius,this.hittestRequest.position)}};c([Se],$e.prototype,"usesHalfFloatPrecision",void 0),c([S(ct)],$e.prototype,"kernelControls",void 0),c([I(0,A(vi))],$e.prototype,"vertex",null),c([I(0,A(ks))],$e.prototype,"fragment",null);let bi=class extends Nt{};c([x(0,y)],bi.prototype,"pos",void 0);let Us=class extends ji{},Ee=class extends pe{};c([S(N)],Ee.prototype,"texture",void 0),c([S(y)],Ee.prototype,"minAndInvRange",void 0),c([S(n)],Ee.prototype,"normalization",void 0);let gi=class extends pe{};c([S(N)],gi.prototype,"texture",void 0);let be=class extends Ht{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new V(e.pos.multiply(2).subtract(1),1,1),uv:e.pos}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let r=Q(t.texture,e.uv).r.multiply(new n(yi(this.usesHalfFloatPrecision)));r=r.multiply(t.normalization),r=r.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const a=Q(i.texture,new y(r,.5)),o=new ht;return o.glFragColor=new V(a.rgb.multiply(a.a),a.a),o}};c([Se],be.prototype,"usesHalfFloatPrecision",void 0),c([S(Ee)],be.prototype,"accumulatedDensity",void 0),c([S(gi)],be.prototype,"gradient",void 0),c([I(0,A(bi))],be.prototype,"vertex",null),c([I(0,A(Us))],be.prototype,"fragment",null);let Ns=class extends k{constructor(){super(...arguments),this.meshWriter=B.HeatmapMeshWriter,this.shaders={accumulate:new $e,resolve:new be},this.postProcessingEnabled=!0,this._isBound=!1,this._resources=new Map,this.overrideStencilRef=xi}shutdown(e){var t;super.shutdown(e),(t=this._resources.get(e))==null||t.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:r,state:a}=e,o=t.instance.getInput(),{isFieldActive:l}=o,u=this._getOrCreateResourcesRecord(i),p=u.loadQualityProfile(i);if(Je(e))return;T(e)||this._bind(e,u,o),r.setShader({shader:this.shaders.accumulate,uniforms:{...D(e,t.target),kernelControls:{radius:Ot(o,a),isFieldActive:l?1:0}},defines:{...C(e),...p.defines},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)});const d=T(e)?Ws:wi;r.setPipelineState(d),r.submitDraw(i,t)}postProcess(e,t){if(T(e)||Je(e))return;const{context:i,painter:r}=e,a=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!(a!=null&&a.initialized))return;const{defines:o}=a.loadQualityProfile(i),{minDensity:l,maxDensity:u,radius:p}=t.getInput(),d=8,h=9,f=a.accumulateFramebuffer,m=a.resolveGradientTexture;r.setShader({shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:d,texture:f.colorTexture},minAndInvRange:[l,1/(u-l)],normalization:3/(p*p*Math.PI)},gradient:{texture:{unit:h,texture:m}}},defines:o,optionalAttributes:{},useComputeBuffer:!1}),i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(f.colorTexture,d),i.bindTexture(m,h),r.setPipelineState(Gs),r.submitDrawQuad(i),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Bs,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:r,state:a,pixelRatio:o}=e,l=r.getBoundFramebufferObject(),u=r.getViewport();this._prevFBO=l,this._prevViewport=u;const{gradient:p,gradientHash:d}=i;t.ensureResolveGradientTexture(r,d,p);const{width:h,height:f}=u,m=Hs(Ot(i,a),o),b=h*m,v=f*m,g=t.ensureAccumulateFBO(r,b,v);r.blitFramebuffer(l,g,0,0,l.width,l.height,0,0,g.width,g.height,lt.STENCIL_BUFFER_BIT,ot.NEAREST),r.bindFramebuffer(g),r.setViewport(0,0,g.width,g.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(lt.COLOR_BUFFER_BIT),this._isBound=!0}};function Hs(s,e){const t=e>1.5?.25:.5;return s<1/(2*t)?1:t}function xi(s){return s.key.level+1}const wi={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:xi,compare:gs.GEQUAL,mask:255,op:{fail:Ze.KEEP,zFail:Ze.KEEP,zPass:Ze.REPLACE}}}},Ws={...wi,stencil:!1},Gs={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function Ot(s,e){const{referenceScale:t,radius:i}=s;return i*(t!==0?t/e.scale:1)}let yt=class extends pe{getVVRotationMat4(e){return ce(Tt(e),ke.identity(),()=>{const t=this._getNormalizedAngle(e).multiply($t),i=Mt(t),r=Pt(t);return new ke(r,i,0,0,i.multiply(new n(-1)),r,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return ce(Tt(e),j.identity(),()=>{const t=this._getNormalizedAngle(e).multiply($t),i=Mt(t),r=Pt(t);return new j(r,i,0,i.multiply(new n(-1)),r,0,0,0,1)})}_getNormalizedAngle(e){const t=Kt(this.rotationType,new n(tt.Arithmatic));return ce(t,new n(90).subtract(e),e)}};c([S(n)],yt.prototype,"rotationType",void 0);const qs=360/254;class G extends We{}c([x(3,V)],G.prototype,"color",void 0),c([x(4,y)],G.prototype,"offset",void 0),c([x(5,y)],G.prototype,"textureUV",void 0),c([x(6,n)],G.prototype,"fontSize",void 0),c([x(7,n)],G.prototype,"referenceSize",void 0),c([x(8,n)],G.prototype,"haloFontSize",void 0),c([x(9,V)],G.prototype,"haloColor",void 0),c([x(10,y)],G.prototype,"zoomRange",void 0),c([x(11,n)],G.prototype,"clipAngle",void 0),c([x(12,V)],G.prototype,"referenceSymbol",void 0);let pt=class extends ti{};c([x(13,y)],pt.prototype,"offsetNextVertex1",void 0),c([x(14,y)],pt.prototype,"offsetNextVertex2",void 0);class js extends Pe{}class O extends Ge{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.isHaloPass=!1,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){const r=t.multiply(qs),a=ii(this.view.rotation.subtract(r)),o=it(new n(360).subtract(a),a);let l=new n(0);const u=Ki(this.view.currentZoom.multiply(zt)).divide(zt),p=e.x,d=e.y,h=new n(1).subtract(H(p,u)).multiply(2),f=H(new n(90),o).multiply(2),m=new n(2).multiply(new n(1).subtract(H(u,d)));return l=l.add(i.multiply(h)),l=l.add(i.multiply(f)),l=l.add(m),l}vertex(e,t){const i=le(e.bitset,Zi),r=new n(1).subtract(i);let a=e.fontSize,o=a.divide(Ft);const l=this.isHaloPass?e.haloColor:this._getVertexColor(e),u=this.isLabel?l.multiply(this.storage.getAnimationValue(e.id)):l,p=this.view.displayViewScreenMat3.multiply(new _(e.pos,1));let d=e.offset,h=new n(1),f=j.identity();if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const P=e.referenceSymbol,F=P.xy,R=P.z,$=this._unpackDirection(P.w),K=st(this,e.id,R).divide(2),ue=$.multiply(K.add(Ei));d=d.add(F).add(ue)}else h=st(this,e.id,e.referenceSize).divide(e.referenceSize),a=a.multiply(h),o=o.multiply(h),d=d.multiply(h),f=si(this,e.id),d=f.multiply(new _(d,0)).xy;const m=le(e.bitset,Xi),b=this._getViewRotationMatrix(m).multiply(new _(d,0));let v=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,m):this.clip(e.id,e.zoomRange);v=this.isBackgroundPass?v.add(r.multiply(2)):v.add(i.multiply(2));const g=new V(p.xy.add(b.xy),v,1),w=e.textureUV.divide(this.mosaicInfo.size);let z=new n(0);return this.isHaloPass&&(z=e.haloFontSize.divide(o).divide(Yi)),{glPosition:g,color:u,size:o,textureUV:w,antialiasingWidth:new n(.105*Ft).divide(a).divide(this.view.pixelRatio),haloDistanceOffset:z,...this.maybeRunHittest(e,t,{vvSizeAdjustment:h,vvRotation:f})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}fragment(e){const t=new n(.25),i=new n(1).subtract(t),r=Q(this.mosaicInfo.texture,e.textureUV).a;let a=i.subtract(e.haloDistanceOffset);this.highlight&&(a=a.divide(2));const o=e.antialiasingWidth,l=Gt(a.subtract(o),a.add(o),r);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:r}){const a=r.multiply(new _(e.offset.multiply(i),0)),o=r.multiply(new _(t.offsetNextVertex1.multiply(i),0)),l=r.multiply(new _(t.offsetNextVertex2.multiply(i),0)),{viewMat3:u,tileMat3:p}=this.view,d=u.multiply(p).multiply(new _(e.pos,1)),h=d.add(p.multiply(a)).xy,f=d.add(p.multiply(o)).xy,m=d.add(p.multiply(l)).xy;return Qi(this.hittestRequest.position,h.xy,f.xy,m.xy)}_unpackDirection(e){const t=new je(e),i=Ji(t,new je(2)),r=es(t,new je(3));return new y(new n(i).subtract(1),new n(r).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new ts(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),r=this.visualVariableOpacity.getOpacity(i);t=t.multiply(r)}return t}}c([E(Zt)],O.prototype,"visualVariableColor",void 0),c([E(Xt)],O.prototype,"visualVariableOpacity",void 0),c([E(yt)],O.prototype,"visualVariableRotation",void 0),c([E(Yt)],O.prototype,"visualVariableSizeMinMaxValue",void 0),c([E(Qt)],O.prototype,"visualVariableSizeScaleStops",void 0),c([E(Jt)],O.prototype,"visualVariableSizeStops",void 0),c([E(ei)],O.prototype,"visualVariableSizeUnitValue",void 0),c([S(ft)],O.prototype,"mosaicInfo",void 0),c([Se],O.prototype,"isHaloPass",void 0),c([Se],O.prototype,"isBackgroundPass",void 0),c([Se],O.prototype,"isLabel",void 0),c([I(0,A(G)),I(1,A(pt))],O.prototype,"vertex",null),c([I(0,A(js))],O.prototype,"fragment",null);let Ks=class extends k{constructor(){super(...arguments),this.meshWriter=B.LabelMeshWriter,this.shaders={geometry:new O},this.drawPhase=xe.LABEL|xe.LABEL_ALPHA,this.symbologyPlane=de.TEXT}render(e,t){const{context:i,painter:r}=e,a=C(e),o={...L(e)},l={shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!0},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:!1};r.setShader(l),r.setPipelineState(o),r.submitDraw(i,t),r.setShader({...l,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!0}}),r.setPipelineState(o),r.submitDraw(i,t),r.setShader({...l,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!0}}),r.setPipelineState(o),r.submitDraw(i,t)}},Zs=class extends k{constructor(){super(...arguments),this.meshWriter=B.LineMeshWriter,this.shaders={geometry:new ri},this.symbologyPlane=de.LINE}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Te(a)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class Le extends ss{}c([x(9,n)],Le.prototype,"accumulatedDistance",void 0),c([x(10,y)],Le.prototype,"segmentDirection",void 0),c([x(11,V)],Le.prototype,"tlbr",void 0);class dt extends ri{_getLineWidthRatio(e,t){const i=new n(zs),r=le(e.bitset,rs);return r.multiply(we(t,new n(.25))).add(new n(1).subtract(r)).divide(i)}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:r,patternSize:a,accumulatedDistance:o,lineWidthRatio:l}=e,u=a.x.multiply(new n(2)).multiply(l),p=It(o.divide(u)),d=new n(.25).multiply(i.y).add(new n(.5)),h=rt(r.xy,r.zw,new y(p,d)),f=ai(Q(this.mosaicInfo.texture,h)).subtract(new n(.5)).multiply(t),m=at(new n(.5).subtract(f),new n(0),new n(1));return new V(m)}_getPatternColor(e){const{halfWidth:t,normal:i,color:r,accumulatedDistance:a,patternSize:o,sampleAlphaOnly:l,tlbr:u}=e,p=o.y.multiply(new n(2).multiply(t).divide(o.x)),d=It(a.divide(p)),h=new n(.5).multiply(i.y).add(new n(.5)),f=rt(u.xy,u.zw,new y(h,d));let m=Q(this.mosaicInfo.texture,f);return this.visualVariableColor!=null&&(m=ce(Ke(l,new n(.5)),new V(r.a),r)),m}vertex(e,t){const{segmentDirection:i,tlbr:r,bitset:a}=e,o=as(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(et(i,o.scaledOffset)),u=new y(r.z.subtract(r.x),r.w.subtract(r.y)),p=r.divide(this.mosaicInfo.size.xyxy),d=le(a,os),h=le(a,ns),f=ce(Ke(d,new n(.5)),this._getLineWidthRatio(e,o.scaledHalfWidth),new n(1));return{...o,tlbr:p,patternSize:u,accumulatedDistance:l,isSDF:d,sampleAlphaOnly:h,lineWidthRatio:f,...this.maybeRunHittest(e,t,o.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:r}=e,a=ls(e,this.antialiasingControls.blur),o=ce(Ke(r,new n(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),l=t.multiply(i).multiply(a).multiply(o);return this.getFragmentOutput(l,e)}}c([S(ft)],dt.prototype,"mosaicInfo",void 0),c([I(0,A(Le)),I(1,A(is))],dt.prototype,"vertex",null);let Xs=class extends k{constructor(){super(...arguments),this.meshWriter=B.TexturedLineMeshWriter,this.shaders={geometry:new dt},this.symbologyPlane=de.LINE}render(e,t){const{context:i,painter:r,pixelRatio:a}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),antialiasingControls:Te(a),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class ne extends We{}c([x(3,V)],ne.prototype,"color",void 0),c([x(4,V)],ne.prototype,"outlineColor",void 0),c([x(5,y)],ne.prototype,"offset",void 0),c([x(6,y)],ne.prototype,"textureUV",void 0),c([x(7,V)],ne.prototype,"sizing",void 0),c([x(8,n)],ne.prototype,"placementAngle",void 0),c([x(9,n)],ne.prototype,"sizeRatio",void 0),c([x(10,y)],ne.prototype,"zoomRange",void 0);class Me extends ti{}c([x(12,y)],Me.prototype,"offsetNextVertex1",void 0),c([x(13,y)],Me.prototype,"offsetNextVertex2",void 0),c([x(14,y)],Me.prototype,"textureUVNextVertex1",void 0),c([x(15,y)],Me.prototype,"textureUVNextVertex2",void 0);class Ys extends Pe{}function oe(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}function Xe(s){return s.multiply(s).divide(128)}class q extends Ge{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=Xe(e.sizing.x),r=Xe(e.sizing.y),a=Xe(e.sizing.z),o=e.placementAngle,l=le(e.bitset,ze.bitset.isSDF),u=le(e.bitset,ze.bitset.isMapAligned),p=le(e.bitset,ze.bitset.scaleSymbolsProportionally),d=us(e.bitset,ze.bitset.colorLocked),h=cs(this,e.id),f=ps(this,e.id,e.color,d).multiply(h),m=this.view.displayViewScreenMat3.multiply(new _(e.pos.xy,1)),b=st(this,e.id,a).divide(a),v=i.multiply(b),g=e.offset.xy.multiply(b);let w=r.multiply(p.multiply(b.subtract(1)).add(1));w=it(w,we(v.subtract(.99),new n(0)));const z=we(w,new n(1)),P=it(w,new n(1)),F=j.fromRotation(o.multiply(ds)),R=si(this,e.id),$=this._getViewRotationMatrix(u).multiply(R).multiply(F).multiply(new _(g.xy,0)),K=this.clip(e.id,e.zoomRange),ue=new V(m.xy.add($.xy),K,1),Fe=e.textureUV.divide(this.mosaicInfo.size),Ie=e.outlineColor.multiply(P),Ce=le(e.bitset,ze.bitset.overrideOutlineColor),Ve=e.sizeRatio.multiply(v).multiply(.5);return{glPosition:ue,color:f,textureUV:Fe,outlineColor:Ie,outlineSize:z,distanceToPx:Ve,isSDF:l,overrideOutlineColor:Ce,...this.maybeRunHittest(e,t,{pos:e.pos,size:v,sizeCorrection:b,isMapAligned:u,outlineSize:z,distanceToPx:Ve,isSDF:l})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return ce(hs(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,r=new n(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getColor(e,t){return ce(Kt(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return Q(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=Q(this.mosaicInfo.texture,e),r=new n(.5).subtract(ai(i)).multiply(t.distanceToPx).multiply(fs),a=at(new n(.5).subtract(r),new n(0),new n(1)),o=t.color.multiply(a);let l=t.outlineSize;this.highlight&&(l=we(l,t.overrideOutlineColor.multiply(4)));const u=l.multiply(.5),p=ii(r).subtract(u),d=at(new n(.5).subtract(p),new n(0),new n(1)),h=rt(t.outlineColor,t.color,t.overrideOutlineColor).multiply(d);return new n(1).subtract(h.a).multiply(o).add(h)}_hittestSmallMarker(e,t,i){const{position:r,distance:a,smallSymbolDistance:o}=this.hittestRequest,l=a.subtract(o),{viewMat3:u,tileMat3:p}=this.view,d=u.multiply(p).multiply(new _(i.pos,1)).xy,h=i.size.multiply(.5);return ms(d,r).subtract(h).add(l)}_hittestMarker(e,t,i){const{pos:r,size:a,sizeCorrection:o,isMapAligned:l,outlineSize:u,isSDF:p,distanceToPx:d}=i,h=new _(e.offset.multiply(o),0),f=new _(t.offsetNextVertex1.multiply(o),0),m=new _(t.offsetNextVertex2.multiply(o),0),{viewMat3:b,tileMat3:v}=this.view,g=b.multiply(v).multiply(new _(r,1)),w=this._getViewScreenMatrix(l),z=g.add(w.multiply(h)).xy,P=g.add(w.multiply(f)).xy,F=g.add(w.multiply(m)).xy,R=this.hittestRequest.position,$=this.hittestRequest.distance,K=re(R.add(new y(he($),he($))),z,P,F),ue=re(R.add(new y(0,he($))),z,P,F),Fe=re(R.add(new y($,he($))),z,P,F),Ie=re(R.add(new y(he($),0)),z,P,F),Ce=re(R,z,P,F),Ve=re(R.add(new y($,0)),z,P,F),bt=re(R.add(new y(he($),$)),z,P,F),gt=re(R.add(new y(0,$)),z,P,F),xt=re(R.add(new y($,$)),z,P,F),ee=e.textureUV.divide(this.mosaicInfo.size),te=t.textureUVNextVertex1.divide(this.mosaicInfo.size),ie=t.textureUVNextVertex2.divide(this.mosaicInfo.size),se={color:new V(1),outlineColor:new V(1),overrideOutlineColor:new n(1),outlineSize:u,distanceToPx:d,isSDF:p};let M=new n(0);return M=M.add(ae(K).multiply(this._getColor(oe(K,ee,te,ie),se).a)),M=M.add(ae(ue).multiply(this._getColor(oe(ue,ee,te,ie),se).a)),M=M.add(ae(Fe).multiply(this._getColor(oe(Fe,ee,te,ie),se).a)),M=M.add(ae(Ie).multiply(this._getColor(oe(Ie,ee,te,ie),se).a)),M=M.add(ae(Ce).multiply(this._getColor(oe(Ce,ee,te,ie),se).a)),M=M.add(ae(Ve).multiply(this._getColor(oe(Ve,ee,te,ie),se).a)),M=M.add(ae(bt).multiply(this._getColor(oe(bt,ee,te,ie),se).a)),M=M.add(ae(gt).multiply(this._getColor(oe(gt,ee,te,ie),se).a)),M=M.add(ae(xt).multiply(this._getColor(oe(xt,ee,te,ie),se).a)),H(M,new n(.05)).multiply(qt(this.hittestRequest))}}c([E(Zt)],q.prototype,"visualVariableColor",void 0),c([E(Xt)],q.prototype,"visualVariableOpacity",void 0),c([E(yt)],q.prototype,"visualVariableRotation",void 0),c([E(Yt)],q.prototype,"visualVariableSizeMinMaxValue",void 0),c([E(Qt)],q.prototype,"visualVariableSizeScaleStops",void 0),c([E(Jt)],q.prototype,"visualVariableSizeStops",void 0),c([E(ei)],q.prototype,"visualVariableSizeUnitValue",void 0),c([S(ft)],q.prototype,"mosaicInfo",void 0),c([I(0,A(ne)),I(1,A(Me))],q.prototype,"vertex",null),c([I(0,A(Ys))],q.prototype,"fragment",null);let Qs=class extends k{constructor(){super(...arguments),this.meshWriter=B.MarkerMeshWriter,this.shaders={geometry:new q},this.symbologyPlane=de.MARKER}render(e,t){const{context:i,painter:r}=e;r.setShader({shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...C(e)},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)}),r.setPipelineState(L(e)),r.submitDraw(i,t)}};class Js{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map(([r,a])=>`${r}.${a}`).join("."),i=Fi(t);this._locationInfo={hash:i,locations:e}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){const r=Object.keys(i).filter(o=>i[o]).map(o=>`${o}_${i[o].toString()}`).join("."),a=Object.keys(t).filter(o=>this.optionPropertyKeys.has(o)).join(".");return`${e.hash}.${r}.${a}`}getProgram(e,t,i,r){let a="",o="";for(const l in i)if(i[l]){const u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;a+=u,o+=u}return a+=this.vertexShader,o+=this.fragmentShader,new ys(a,o,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const i in this.required){const r=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:r.type,uniformArrayElementType:Dt(r),uniformArrayLength:Et(r)})}for(const i in e){const r=this.options[i];if(e[i])for(const a in r){const o=r[a];t.push({uniformHydrated:null,shaderModulePath:`${i}.${a}`,uniformName:a,uniformType:o.type,uniformArrayElementType:Dt(o),uniformArrayLength:Et(o)})}}return t}}const Dt=s=>{var e;return s.type==="array"?(e=s.elementType)==null?void 0:e.type:void 0},Et=s=>s.type==="array"?s.size:void 0,er={hittestDist:n,hittestPos:y},tr={filterFlags:N,animation:N,visualVariableData:N,dataDriven0:N,dataDriven1:N,dataDriven2:N,gpgpu:N,size:n},ir={displayViewScreenMat3:j,displayViewMat3:j,displayMat3:j,viewMat3:j,tileMat3:j,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:y,currentScale:n,currentZoom:n,metersPerSRUnit:n};let sr=class extends Js{constructor(){super(...arguments),this.vertexShader=Rt("materials/pie/pie.vert"),this.fragmentShader=Rt("materials/pie/pie.frag"),this.required={...tr,...ir,outlineWidth:n,colors:Z,defaultColor:V,othersColor:V,outlineColor:V,donutRatio:n,sectorThreshold:n},this.options={hittestUniforms:er,visualVariableSizeMinMaxValue:{minMaxValueAndSize:V},visualVariableSizeScaleStops:{sizes:{...Z.ofType(n,8),type:"array",elementType:n,size:8},values:{...Z.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeStops:{sizes:{...Z.ofType(n,8),type:"array",elementType:n,size:8},values:{...Z.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:{...Z.ofType(n,8),type:"array",elementType:n,size:8},opacityValues:{...Z.ofType(n,8),type:"array",elementType:n,size:8}}},this.locations={pos:{index:0,type:y},id:{index:1,type:_},bitset:{index:2,type:n},offset:{index:3,type:y},texCoords:{index:4,type:y},size:{index:5,type:y},referenceSize:{index:6,type:n},zoomRange:{index:7,type:y}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...Z.ofType(V,e),type:"array",elementType:V,size:e}}},rr=class extends k{constructor(){super(...arguments),this.meshWriter=B.PieChartMeshWriter,this.shaders={geometry:new sr},this.symbologyPlane=de.MARKER}render(e,t){var m,b;const{context:i,painter:r}=e,{instance:a,target:o}=t,l=this.shaders.geometry,u=a.getInput(),p=u.numberOfFields,d=T(e),h=D(e,o),f=C(e);l.setNumberOfFields(p),r.setShader({shader:l,uniforms:{...W(e,t.target,u.geometry),...h.storage,...h.view,hittestUniforms:h.hittestRequest?{hittestDist:(m=h.hittestRequest)==null?void 0:m.distance,hittestPos:(b=h.hittestRequest)==null?void 0:b.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!u.geometry.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!u.geometry.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!u.geometry.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!u.geometry.visualVariableSizeUnitValue,VV_OPACITY:!!u.geometry.visualVariableOpacity,HITTEST:d,highlight:h.highlight?1:0,...f,numberOfFields:p},optionalAttributes:{},useComputeBuffer:d}),r.setPipelineState(L(e)),r.submitDraw(i,t)}},ar=class extends k{constructor(){super(...arguments),this.meshWriter=B.TextMeshWriter,this.shaders={geometry:new O},this.symbologyPlane=de.TEXT}render(e,t){const{context:i,painter:r}=e,a=C(e),o={shader:this.shaders.geometry,uniforms:{...W(e,t.target,t.instance.getInput().geometry),...D(e,t.target),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...a,isHaloPass:!1,isBackgroundPass:!0,isLabel:!1},optionalAttributes:t.instance.optionalAttributes,useComputeBuffer:T(e)};r.setShader(o),r.setPipelineState(L(e)),r.submitDraw(i,t),r.setShader({...o,defines:{...a,isHaloPass:!0,isBackgroundPass:!1,isLabel:!1}}),r.submitDraw(i,t),r.setShader({...o,defines:{...a,isHaloPass:!1,isBackgroundPass:!1,isLabel:!1}}),r.submitDraw(i,t)}};const J={fill:new Rs("fill"),patternFill:new Ds("patternFill"),complexFill:new Cs("complexFill"),outlineFill:new Os("outlineFill"),patternOutlineFill:new Es("patternOutlineFill"),complexOutlineFill:new As("complexOutlineFill"),marker:new Qs("marker"),pieChart:new rr("pieChart"),line:new Zs("line"),texturedLine:new Xs("texturedLine"),text:new ar("text"),label:new Ks("label"),heatmap:new Ns("heatmap"),dotDensity:new Is("dotDensity")};function Ha(){for(const s in J)J[s].startup()}function Wa(s){for(const e in J)J[e].shutdown(s)}function Ne(s,e){const t=s.slice(0,e),i=e-t.length;for(let r=0;r<i;r++){const a=t[t.length-1];t.push(a)}return t}function or(s){if(!s)return[0,0,0,0];const{r:e,g:t,b:i,a:r}=s;return[e*(r/255),t*(r/255),i*(r/255),r]}const Be=8,Si=Be-2,Vi=()=>Ut.getLogger("esri.views.2d.layers.features.support.rendererUtils");function zi(s){return s.map(e=>nr(e)?lr(e.clone()):e)}function nr(s){return(s.type==="size"||s.type==="color"||s.type==="opacity")&&s.stops!=null}function lr(s){return s.stops=pr(s.type,s.stops??[]),s}function fe(s,e,t){return(1-t)*s+t*e}function ur(s,e){const[t,...i]=e,r=i.pop(),a=i[0].value,o=i[i.length-1].value,l=(o-a)/Si,u=[];for(let p=a;p<o;p+=l){let d=0;for(;p>=i[d].value;)d++;const h=i[d],f=e[d-1],m=p-f.value,b=h.value===f.value?1:m/(h.value-f.value);if(s==="color"){const v=i[d],g=e[d-1],w=v.color.clone();w.r=fe(g.color.r,w.r,b),w.g=fe(g.color.g,w.g,b),w.b=fe(g.color.b,w.b,b),w.a=fe(g.color.a,w.a,b),u.push({value:p,color:w,label:v.label})}else if(s==="size"){const v=i[d],g=e[d-1],w=St(v.size),z=fe(St(g.size),w,b);u.push({value:p,size:z,label:v.label})}else{const v=i[d],g=fe(e[d-1].opacity,v.opacity,b);u.push({value:p,opacity:g,label:v.label})}}return[t,...u,r]}function cr(s){const[e,...t]=s,i=t.pop();for(;t.length>Si;){let r=0,a=0;for(let o=1;o<t.length;o++){const l=t[o-1],u=t[o],p=Math.abs(u.value-l.value);p>a&&(a=p,r=o)}t.splice(r,1)}return[e,...t,i]}function pr(s,e){return e.length<=Be?e:(Vi().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${Be}. Displayed stops will be simplified.`),e.length>2*Be?ur(s,e):cr(e))}function dr(){const{supportsColorBufferFloat:s,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=mt();return s&&e||t}function Ga(s){if(!s)return!0;switch(s.type){case"dot-density":break;case"heatmap":if(!dr()){const e=mt(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return Vi().errorOnce(new Ii("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}const hr=1.25,Re=128,fr=128;function mr(s){var a;if(!((a=s.stops)!=null&&a.length))return null;const e=s.stops.sort((o,l)=>o.value-l.value),t=Ne(e,8),i=t.map(({value:o})=>o),r=t.map(({color:o})=>or(o));return{values:i,colors:r}}function yr(s){var i;if(!((i=s.stops)!=null&&i.length))return null;const e=s.stops.sort((r,a)=>r.value-a.value),t=Ne(e,8);return{opacityValues:t.map(({value:r})=>r),opacities:t.map(({opacity:r})=>r)}}function vr(s){return{rotationType:s.rotationType==="geographic"?tt.Geographic:tt.Arithmatic}}function Ye(s){var i;if(!((i=s.stops)!=null&&i.length))return null;if(s.stops.some(r=>r.useMaxValue||r.useMinValue))return(r,a)=>{const o=r.statisticsByLevel.get(a.key.level),l=s.stops.map(p=>{var d,h;return{value:p.useMaxValue?((d=o==null?void 0:o.get(s.field))==null?void 0:d.maxValue)??0:p.useMinValue?((h=o==null?void 0:o.get(s.field))==null?void 0:h.minValue)??0:p.value,size:p.size?ge(p.size):Li}}).sort((p,d)=>p.value-d.value),u=Ne(l,8);return{values:u.map(({value:p})=>p),sizes:u.map(({size:p})=>p)}};const e=s.stops.sort((r,a)=>r.value-a.value),t=Ne(e,8);return{values:t.map(({value:r})=>r),sizes:t.map(({size:r})=>ge(r))}}function br(s){return e=>{const{state:t}=e;return{unitValueToPixelsRatio:Ci(t.spatialReference)/Ai[s.valueUnit]/t.resolution}}}function Lt(s,e){const t=e.length;if(s<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(s<e[i].value){const r=(s-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+r*(e[i].size-e[i-1].size)}return e[t-1].size}function gr(s){const{minDataValue:e,maxDataValue:t,minSize:i,maxSize:r}=s;if(typeof i=="object"&&typeof r=="object")return(a,o)=>{const l=a.state.scale,u=ge(Lt(l,i.stops)),p=ge(Lt(l,r.stops));return{minMaxValueAndSize:[e,t,u,p]}};if(typeof i=="object"||typeof r=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,ge(i),ge(r)]}}const vt={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function _i(s,e=fr,t=hr){if(s.visualVariableSizeMinMaxValue)return s.visualVariableSizeMinMaxValue instanceof Function?Re:Math.max(s.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(s.visualVariableSizeScaleStops){if(s.visualVariableSizeScaleStops instanceof Function)return Re;const i=s.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(s.visualVariableSizeStops){if(s.visualVariableSizeStops instanceof Function)return Re;const i=s.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return s.visualVariableSizeUnitValue?2*Re:0}function qa(s){const e={...vt};if(!s||!("visualVariables"in s)||!s.visualVariables)return e;for(const t of zi(s.visualVariables))switch(t.type){case"color":e.visualVariableColor=mr(t);break;case"opacity":e.visualVariableOpacity=yr(t);break;case"rotation":e.visualVariableRotation=vr(t);break;case"size":switch(xr(t)){case"field-stops":e.visualVariableSizeStops=Ye(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=Ye(t):e.visualVariableSizeScaleStops=Ye(t);break;case"min-max":e.visualVariableSizeMinMaxValue=gr(t);break;case"unit-value":e.visualVariableSizeUnitValue=br(t)}break;default:console.error("Unable to handle VV type")}return e}function xr(s){if(typeof s.minDataValue=="number"&&typeof s.maxDataValue=="number"&&s.minSize!=null&&s.maxSize!=null)return"min-max";if((s.expression&&s.expression==="view.scale"||s.valueExpression&&s.valueExpression==="$view.scale")&&Array.isArray(s.stops))return"scale-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&(Array.isArray(s.stops)||"levels"in s&&s.levels))return"field-stops";if((s.field!=null||s.expression&&s.expression!=="view.scale"||s.valueExpression&&s.valueExpression!=="$view.scale")&&s.valueUnit!=null)return"unit-value";throw new Error("InternalError: Found unknown sizeVV type")}function wr(s){return!!(s.visualVariableSizeMinMaxValue||s.visualVariableSizeScaleStops||s.visualVariableSizeStops||s.visualVariableSizeUnitValue||s.visualVariableSizeOutlineScaleStops)}function ja(s){return!!s.visualVariableRotation}function Sr(s){return s.minScale||s.maxScale?{minScale:s.minScale??0,maxScale:s.maxScale??0}:null}function Y(s){if(s==null)return null;if(Array.isArray(s)){const[e,t,i,r]=s;return[e,t,i,255*r]}return typeof s=="string"?s:{...s,defaultValue:Y(s==null?void 0:s.defaultValue)}}async function Ka(s,e){const{cimResourceManager:t,cimAnalyzer:i,scaleExpression:r}=e.schemaOptions;await Promise.all(Pi.fetchResources(s.symbol,t,[]));const a=i.analyzeSymbolReference(s,!1),o={scaleInfo:Sr(s),scaleExpression:r},l=[];for(const u of a)switch(u.type){case"marker":l.push(...Vr(u,e,o));break;case"fill":l.push(...Mr(u,e,o));break;case"line":l.push(...Tr(u,e,o));break;case"text":l.push(...Cr(u,e,o))}return l}function Vr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?{...vt,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return zr(a.ensureInstance(J.marker,{geometry:o},{zoomRange:!!t.scaleInfo}),s,i,t)}function zr(s,e,t,{scaleInfo:i,scaleExpression:r}){const a=wr(t);return[s.createMeshInfo({params:{size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:Y(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:Y(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||Ri.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:r??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:a,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:_i(t)}})]}function _r(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return $r(a.ensureInstance(J.fill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,t)}function $r(s,e,{scaleInfo:t}){return[s.createMeshInfo({params:{color:Y(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Mr(s,e,t){if(!s.spriteRasterizationParam)return _r(s,e,t);const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Pr(a.ensureInstance(J.complexFill,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity}},{zoomRange:!!t.scaleInfo}),s,i.visualVariableColor!=null,t)}function Pr(s,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const r=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),a=e.sampleAlphaOnly&&!r,o=e.spriteRasterizationParam;return[s.createMeshInfo({params:{color:Y(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:o.resource.type==="CIMHatchFill",sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}})]}function Tr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r,o=s.isOutline?{...vt,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={geometry:o},u=!!(o.visualVariableSizeMinMaxValue||o.visualVariableSizeScaleStops||o.visualVariableSizeStops||o.visualVariableSizeUnitValue);return s.spriteRasterizationParam?Ir(a.ensureInstance(J.texturedLine,l,{zoomRange:!!t.scaleInfo}),s,u,t):Fr(a.ensureInstance(J.line,l,{zoomRange:!!t.scaleInfo}),s,u,t)}function $i(s,e,{scaleInfo:t}){return{params:{color:Y(s.color)??[0,0,0,0],width:s.width,referenceWidth:s.referenceWidth,capType:s.cap,joinType:s.join,miterLimit:s.miterLimit,scaleInfo:t,hasSizeVV:e,effects:s.effects?{type:"cim-effect-infos",effectInfos:s.effects}:null}}}function Fr(s,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");return[s.createMeshInfo({params:$i(e,t,i).params})]}function Ir(s,e,t,i){const{spriteRasterizationParam:r,scaleDash:a,sampleAlphaOnly:o}=e;if(!r)throw new Error("InternalError: Sprite should be defined");return[s.createMeshInfo({params:{...$i(e,t,i).params,shouldScaleDash:a??!1,shouldSampleAlphaOnly:o,isSDF:r.resource.type!=="CIMPictureStroke",sprite:r}})]}function Cr(s,e,t){const{uniforms:i,schemaOptions:r}=e,{store:a}=r;return Ar(a.ensureInstance(J.text,{geometry:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue}},{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}),s,i,t)}function Ar(s,e,t,{scaleInfo:i,scaleExpression:r}){return[s.createMeshInfo({params:{boxBackgroundColor:Y(e.backgroundColor),boxBorderLineColor:Y(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:Y(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:Y(e.outlineColor)??[0,0,0,0],haloFontSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:r??1,minPixelBuffer:_i(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}function Za(s,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:mt().maxTextureSize},bindings:Rr(s)}}function qe(s){switch(s){case"opacity":return Ae.OPACITY;case"color":return Ae.COLOR;case"rotation":return Ae.ROTATION;case"size":return Ae.SIZE;default:return null}}function Rr(s){if(!s)return[];switch(s.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Mi(s);case"dot-density":return Or(s);case"pie-chart":return Dr(s);case"heatmap":return Er(s)}}function Or(s){const e=[];for(const t of s.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function Dr(s){const e=Mi(s);let t=4;for(const i of s.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function Er({valueExpression:s,field:e}){return s||e?[{binding:0,expression:s,field:e}]:[]}function Mi(s){var e;return!("visualVariables"in s)||!((e=s.visualVariables)!=null&&e.length)?[]:zi(s.visualVariables).map(t=>Nr(t)).filter(Oi)}function Lr(s){return s.valueExpression==="$view.scale"?null:{binding:qe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression,valueRepresentation:s.valueRepresentation}}function Br(s){return{binding:qe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function kr(s){return{binding:qe(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Ur(s){return{binding:qe(s.type),expression:s.valueExpression,field:s.field}}function Nr(s){switch(s.type){case"size":return Lr(s);case"color":return Br(s);case"opacity":return kr(s);case"rotation":return Ur(s)}}function Qe(s){return s.some(e=>e.globalId)}function _e(s){return s.filter(e=>!e.error).map(e=>e.objectId??e.globalId).filter(e=>e!=null)}function Bt(s,e){const t=new Set(s);for(const i of e.values())t.add(i);return t}function kt(s,e){const t=new Set(s);for(const i of e.values())t.delete(i);return t}class Xa{constructor(e){this.updateTracking=new vs({debugName:"FeatureCommandQueue"}),this._hasGlobalIds=!1,this._queueProcessor=new _s({concurrency:1,process:e.process})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return this.updateTracking.addPromise(this._doPush(e))}async _doPush(e){const t=this._queueProcessor,i=t.last(),r=[];switch(e.type){case"update":if((i==null?void 0:i.type)===e.type)return;r.push(t.push(e));break;case"edit":{const a=(i==null?void 0:i.type)==="processed-edit"?i:null;a&&t.popLast();const o=this._mergeEdits(a,e);for(const l of o)l&&r.push(t.push(l));break}}await Promise.all(r)}_mergeEdits(e,t){const{addedFeatures:i,deletedFeatures:r,updatedFeatures:a}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||Qe(i)||Qe(a)||Qe(r),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...i,...a],removed:r}}];const o=new Set(_e((e==null?void 0:e.edits.addOrModified)??[])),l=new Set(_e((e==null?void 0:e.edits.removed)??[])),u=new Set([..._e(i),..._e(a)]),p=new Set(_e(r));return[{type:"processed-edit",edits:{addOrModified:Array.from(Bt(kt(o,p),u)).map(d=>({objectId:d})),removed:Array.from(Bt(kt(l,u),p)).map(d=>({objectId:d}))}}]}}export{Ha as F,Pr as S,Wa as T,Fr as a,Xa as b,qa as c,or as d,_i as e,wr as f,Mi as g,J as h,ja as i,Ga as m,Ka as n,$r as p,Sr as s,Za as t,zr as u,vt as x,Ar as y,Ir as z};
